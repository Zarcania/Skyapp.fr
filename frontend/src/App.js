import React, { useState, useEffect, useRef, useCallback, useImperativeHandle, forwardRef } from 'react';
import ReactDOM from 'react-dom';
import axios from 'axios';
import PlanningManagement from './PlanningComponent';
import InventoryScanner from './InventoryScanner';
import { BrowserRouter, Routes, Route, Navigate, useNavigate, useLocation } from 'react-router-dom';
import { DragDropContext, Droppable, Draggable } from '@hello-pangea/dnd';
import './App.css';
// Import shadcn components
import { Button } from './components/ui/button';
import { Input } from './components/ui/input';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from './components/ui/card';
import { Tabs, TabsContent, TabsList, TabsTrigger } from './components/ui/tabs';
import { Select, SelectTrigger, SelectContent, SelectItem, SelectValue } from './components/ui/select';
import { Badge } from './components/ui/badge';
import { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle } from './components/ui/dialog';
// Import AI Orb - Premier Logiciel BTP Intelligent en France
import AIOrb from './components/AIOrb/AIOrb';

import {
  AlertCircle,
  AlertTriangle,
  ArrowLeft,
  ArrowRight,
  BarChart3,
  Briefcase,
  Building,
  Calendar,
  Camera,
  Calculator,
  Check,
  CheckCheck,
  CheckCircle,
  CheckCircle2,
  ChevronDown,
  ChevronLeft,
  ChevronRight,
  ChevronUp,
  ClipboardList,
  Clock,
  DollarSign,
  Download,
  Edit,
  Edit2,
  Eye,
  FileBarChart,
  FileText,
  Filter,
  FolderOpen,
  Globe,
  Grid,
  GripVertical,
  History,
  Image as ImageIcon,
  Info,
  Kanban,
  Layers,
  Lightbulb,
  List,
  Loader2,
  LogOut,
  Mail,
  Map,
  MapPin,
  MapPin as MapPinIcon,
  Menu,
  MoreVertical,
  Navigation,
  Phone,
  Play,
  Plus,
  Package,
  Save,
  Search,
  Settings,
  Share2,
  Shield,
  Star,
  Target,
  Timer,
  Trash2,
  TrendingUp,
  Upload,
  User,
  UserPlus,
  Users,
  Wifi,
  Wrench,
  X,
  XCircle
} from 'lucide-react';

// Backend URL and API base with safe fallbacks
const BACKEND_URL = process.env.REACT_APP_BACKEND_URL || 'http://127.0.0.1:8001';
const API = process.env.REACT_APP_API_BASE_URL || `${BACKEND_URL}/api`;
const SUPABASE_URL = process.env.REACT_APP_SUPABASE_URL || 'https://izkhlqbhdxyjigdmjqvx.supabase.co';

const FOUNDER_EMAIL = (process.env.REACT_APP_FOUNDER_EMAIL || 'contact@skyapp.fr').toLowerCase();

// Debug mode (désactivé en production)
const DEBUG_MODE = process.env.NODE_ENV === 'development' && process.env.REACT_APP_DEBUG === 'true';

// Fonction pour nettoyer le formatage Markdown des observations
const cleanObservations = (text) => {
  if (!text) return '';
  
  // Si c'est du JSON avec customSections, extraire uniquement le texte
  try {
    const data = JSON.parse(text);
    if (data && typeof data === 'object' && 'text' in data) {
      return data.text || '';
    }
  } catch (e) {
    // Pas du JSON, continuer avec le nettoyage classique
  }
  
  // Enlever les **text:** et garder seulement le contenu après
  return text
    .replace(/\*\*[^:]+:\*\*/g, '') // Enlever **titre:**
    .replace(/\*\*[^*]+\*\*/g, '') // Enlever **texte**
    .replace(/\s+/g, ' ') // Remplacer multiples espaces par un seul
    .trim();
};

// Restaurer la session Supabase au démarrage (pour les appels directs: materials, etc.)
(async () => {
  const token = localStorage.getItem('token');
  const refreshToken = localStorage.getItem('refresh_token');
  if (token && refreshToken) {
    try {
      await supabase.auth.setSession({ access_token: token, refresh_token: refreshToken });
    } catch (e) {
      console.warn('Session Supabase non restaurée:', e);
    }
  }
})();

// Configure axios interceptor to add token to all requests
axios.interceptors.request.use(
  (config) => {
    const token = localStorage.getItem('token');
    if (token) {
      config.headers.Authorization = `Bearer ${token}`;
    }
    return config;
  },
  (error) => {
    return Promise.reject(error);
  }
);

// Configure axios interceptor to handle 401 errors (token expiry)
axios.interceptors.response.use(
  (response) => response,
  async (error) => {
    const originalRequest = error.config;
    
    if (error.response?.status === 401 && !originalRequest._retry) {
      originalRequest._retry = true;
      
      // Essayer de rafraîchir le token
      const refreshToken = localStorage.getItem('refresh_token');
      
      if (refreshToken) {
        try {
          const response = await axios.post(`${API}/auth/refresh`, { refresh_token: refreshToken });
          const { access_token, refresh_token: newRefreshToken } = response.data;
          
          // Mettre à jour les tokens
          localStorage.setItem('token', access_token);
          if (newRefreshToken) {
            localStorage.setItem('refresh_token', newRefreshToken);
          }

          // Mettre à jour la session Supabase aussi
          try {
            await supabase.auth.setSession({ access_token, refresh_token: newRefreshToken || refreshToken });
          } catch (e) { console.warn('Refresh session Supabase:', e); }
          
          // Réessayer la requête originale avec le nouveau token
          originalRequest.headers['Authorization'] = `Bearer ${access_token}`;
          return axios(originalRequest);
        } catch (refreshError) {
          // Le refresh a échoué, déconnecter l'utilisateur
          console.error('Impossible de rafraîchir le token:', refreshError);
        }
      }
      
      // Token expiré et impossible de rafraîchir, déconnecter l'utilisateur
      const currentPath = window.location.pathname;
      if (currentPath !== '/') {
        alert('Votre session a expiré. Veuillez vous reconnecter.');
        localStorage.removeItem('token');
        localStorage.removeItem('refresh_token');
        localStorage.removeItem('user');
        delete axios.defaults.headers.common['Authorization'];
        window.location.href = '/';
      }
    }
    return Promise.reject(error);
  }
);

// Auth Context
const AuthContext = React.createContext(null);

const useAuth = () => {
  const context = React.useContext(AuthContext);
  if (!context) {
    throw new Error('useAuth must be used within an AuthProvider');
  }
  return context;
};

const useFounderOverview = () => {
  const [data, setData] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  const fetchOverview = React.useCallback(async () => {
    try {
      setLoading(true);
      const response = await axios.get(`${API}/founder/overview`);
      setData(response.data);
      setError(null);
    } catch (err) {
      console.error('Erreur chargement vue fondateur:', err);
      const status = err?.response?.status;
      if (status === 403) {
        setData(null);
        setError(null);
      } else {
        setError('Impossible de charger la vue fondateur');
      }
    } finally {
      setLoading(false);
    }
  }, []);

  useEffect(() => {
    fetchOverview();
  }, [fetchOverview]);

  return { data, loading, error, refresh: fetchOverview };
};

// Real-time Statistics Hook (avec filtre entreprise pour fondateur)
const useRealTimeStats = (companyFilter = null, enabled = true) => {
  const [stats, setStats] = useState(null);
  const [loading, setLoading] = useState(true);
  const [lastUpdated, setLastUpdated] = useState(null);
  const [error, setError] = useState(null);

  const fallback = React.useMemo(() => ({
    total_users: 0,
    total_companies: 0,
    total_searches: 0,
    total_reports: 0,
    active_sessions: 0,
    server_uptime: 'N/A'
  }), []);

  const fetchStats = React.useCallback(async () => {
    // Si le hook est désactivé, ne rien faire
    if (!enabled) {
      setStats(fallback);
      setLoading(false);
      setError(null);
      return;
    }
    
    // Vérifier si l'utilisateur est connecté
    const token = localStorage.getItem('token');
    if (!token) {
      setStats(fallback);
      setLoading(false);
      setError(null);
      return;
    }

    setLoading(true);
    try {
      const url = companyFilter ? `${API}/founder/overview?company=${companyFilter}` : `${API}/founder/overview`;
      const response = await axios.get(url);
      setStats(response.data);
      setLastUpdated(new Date());
      setError(null);
    } catch (err) {
      const status = err?.response?.status;
      setStats(prev => prev ?? fallback);
      
      if (status === 403 || status === 401) {
        // Accès refusé ou non autorisé - normal si pas fondateur ou pas connecté
        setError(null);
      } else {
        // Autres erreurs (réseau, serveur, etc.)
        console.error('Erreur chargement statistiques:', err);
        setError('Impossible de charger les statistiques');
      }
      setLastUpdated(new Date());
    } finally {
      setLoading(false);
    }
  }, [companyFilter, fallback]);

  useEffect(() => {
    if (!enabled) return;
    fetchStats();
    const interval = setInterval(fetchStats, 60000);
    return () => clearInterval(interval);
  }, [fetchStats, enabled]);

  return { stats, loading, error, lastUpdated, refresh: fetchStats };
};

// User Profile Modal Component (Editable)
const UserProfileModal = ({ user, isOpen, onClose, onUpdate }) => {
  const [isEditing, setIsEditing] = useState(false);
  const [loading, setLoading] = useState(false);
  const [profileData, setProfileData] = useState({
    first_name: '',
    last_name: '',
    phone: '',
    address: '',
    company_name: ''
  });

  useEffect(() => {
    if (user && isOpen) {
      // Charger le profil depuis l'API
      axios.get(`${API}/users/me`, {
        headers: { Authorization: `Bearer ${localStorage.getItem('token')}` }
      })
      .then(response => {
        setProfileData({
          first_name: response.data.first_name || '',
          last_name: response.data.last_name || '',
          phone: response.data.phone || '',
          address: response.data.address || '',
          company_name: response.data.company_name || ''
        });
      })
      .catch(err => console.error('Erreur chargement profil:', err));
    }
  }, [user, isOpen]);

  const handleSave = async () => {
    setLoading(true);
    try {
      // Filtrer les champs vides
      let dataToSend = Object.fromEntries(
        Object.entries(profileData).filter(([_, value]) => value && value.trim() !== '')
      );
      
      // Si l'utilisateur n'est pas ADMIN, ne pas envoyer company_name
      if (user?.role !== 'ADMIN' && 'company_name' in dataToSend) {
        const { company_name, ...rest } = dataToSend;
        dataToSend = rest;
      }
      
      const response = await axios.put(`${API}/users/me`, dataToSend, {
        headers: { Authorization: `Bearer ${localStorage.getItem('token')}` }
      });
      
      // Recharger le profil mis à jour depuis l'API
      const updatedProfile = await axios.get(`${API}/users/me`, {
        headers: { Authorization: `Bearer ${localStorage.getItem('token')}` }
      });
      
      // Mettre à jour le localStorage et le state parent
      localStorage.setItem('user', JSON.stringify(updatedProfile.data));
      if (onUpdate) {
        onUpdate(updatedProfile.data);
      }
      
      setIsEditing(false);
      alert('Profil mis à jour avec succès !');
    } catch (error) {
      alert('Erreur lors de la mise à jour du profil');
      console.error(error);
    } finally {
      setLoading(false);
    }
  };

  return (
    <Dialog open={isOpen} onOpenChange={onClose}>
      <DialogContent className="max-w-md">
        <DialogHeader>
          <DialogTitle className="flex items-center justify-between">
            <div className="flex items-center space-x-3">
              <div className="w-12 h-12 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
                <span className="text-white font-bold text-lg">
                  {(() => {
                    const firstName = profileData.first_name || user?.first_name || user?.prenom || '';
                    const lastName = profileData.last_name || user?.last_name || user?.nom || '';
                    const initials = `${firstName.charAt(0)}${lastName.charAt(0)}`.toUpperCase();
                    return initials || user?.email?.charAt(0)?.toUpperCase() || 'U';
                  })()}
                </span>
              </div>
              <div>
                <span className="font-semibold">Profil Utilisateur</span>
                {user?.is_fondateur && (
                  <span className="ml-2 px-2 py-1 text-xs font-bold rounded-full bg-black text-white border-2 border-gray-900">
                    FONDATEUR
                  </span>
                )}
                <span className={`ml-2 px-2 py-0.5 text-xs font-medium rounded-full ${
                  user?.role?.toUpperCase() === 'ADMIN' ? 'bg-red-100 text-red-700' :
                  user?.role?.toUpperCase() === 'BUREAU' ? 'bg-blue-100 text-blue-700' :
                  'bg-gray-100 text-gray-700'
                }`}>
                  {user?.role?.toUpperCase() === 'ADMIN' ? 'Admin' : user?.role?.toUpperCase() === 'BUREAU' ? 'Bureau' : 'User'}
                </span>
              </div>
            </div>
            {!isEditing && (
              <Button variant="outline" size="sm" onClick={() => setIsEditing(true)}>
                <Edit className="h-4 w-4 mr-1" />
                Modifier
              </Button>
            )}
          </DialogTitle>
        </DialogHeader>
        
        <div className="space-y-4">
          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="text-sm font-medium text-gray-600">Prénom</label>
              {isEditing ? (
                <Input
                  value={profileData.first_name}
                  onChange={(e) => setProfileData({...profileData, first_name: e.target.value})}
                  placeholder="Votre prénom"
                />
              ) : (
                <p className="font-semibold">{profileData.first_name || 'Non renseigné'}</p>
              )}
            </div>
            <div>
              <label className="text-sm font-medium text-gray-600">Nom</label>
              {isEditing ? (
                <Input
                  value={profileData.last_name}
                  onChange={(e) => setProfileData({...profileData, last_name: e.target.value})}
                  placeholder="Votre nom"
                />
              ) : (
                <p className="font-semibold">{profileData.last_name || 'Non renseigné'}</p>
              )}
            </div>
          </div>
          
          <div>
            <label className="text-sm font-medium text-gray-600">Email</label>
            <p className="font-semibold">{user?.email || 'Non renseigné'}</p>
          </div>
          
          <div>
            <label className="text-sm font-medium text-gray-600">Téléphone</label>
            {isEditing ? (
              <Input
                value={profileData.phone}
                onChange={(e) => setProfileData({...profileData, phone: e.target.value})}
                placeholder="Votre numéro"
              />
            ) : (
              <p className="font-semibold">{profileData.phone || 'Non renseigné'}</p>
            )}
          </div>
          
          <div>
            <label className="text-sm font-medium text-gray-600">Adresse</label>
            {isEditing ? (
              <Input
                value={profileData.address}
                onChange={(e) => setProfileData({...profileData, address: e.target.value})}
                placeholder="Votre adresse"
              />
            ) : (
              <p className="font-semibold">{profileData.address || 'Non renseigné'}</p>
            )}
          </div>
          
          <div>
            <label className="text-sm font-medium text-gray-600">ID Utilisateur</label>
            <p className="font-mono text-sm bg-gray-100 p-2 rounded">{user?.id || 'N/A'}</p>
          </div>
          
          <div>
            <label className="text-sm font-medium text-gray-600">Numéro de Licence</label>
            <p className="font-semibold">{user?.licence || 'À configurer'}</p>
          </div>
          
          <div>
            <label className="text-sm font-medium text-gray-600">Entreprise</label>
            {isEditing && user?.role === 'ADMIN' ? (
              <Input
                value={profileData.company_name}
                onChange={(e) => setProfileData({...profileData, company_name: e.target.value})}
                placeholder="Nom de l'entreprise"
              />
            ) : (
              <p className="font-semibold">{profileData.company_name || user?.entreprise || 'Non renseigné'}</p>
            )}
          </div>

          {isEditing && (
            <div className="flex gap-2 pt-4">
              <Button onClick={handleSave} disabled={loading} className="flex-1">
                {loading ? 'Sauvegarde...' : 'Sauvegarder'}
              </Button>
              <Button variant="outline" onClick={() => setIsEditing(false)} className="flex-1">
                Annuler
              </Button>
            </div>
          )}
        </div>
      </DialogContent>
    </Dialog>
  );
};

// Real-time Stats Display Component
const RealTimeStatsDisplay = ({ stats, className = "", showIndicator = true }) => {
  return (
    <div className={`flex items-center space-x-2 ${className}`}>
      <span>{stats}</span>
      {showIndicator && (
        <div className="flex items-center space-x-1">
          <div className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
          <span className="text-xs text-gray-500">temps réel</span>
        </div>
      )}
    </div>
  );
};

// Animated Background Component
const CosmicBackground = () => {
  return (
    <>
      {/* Main cosmic background */}
      <div className="cosmic-background"></div>
      
      {/* Particle system */}
      <div className="particle-system">
        {[...Array(20)].map((_, i) => (
          <div 
            key={i}
            className="particle"
            style={{
              left: `${Math.random() * 100}%`,
              animationDelay: `${Math.random() * 8}s`,
              animationDuration: `${8 + Math.random() * 4}s`
            }}
          />
        ))}
      </div>
      
      {/* Morphing blobs */}
      <div className="fixed inset-0 pointer-events-none z-[-1] overflow-hidden">
        <div className="morphing-blob" style={{ top: '10%', left: '10%' }}></div>
        <div className="morphing-blob" style={{ top: '60%', right: '10%' }}></div>
        <div className="morphing-blob" style={{ bottom: '20%', left: '20%' }}></div>
      </div>
    </>
  );
};

// Page dédiée Fondateur (route /fondateur)
const FounderDashboard = () => {
  const { data, loading, error } = useFounderOverview();
  const navigate = useNavigate();

  // Si pas fondateur (hook ne renvoie rien) => écran d'accès refusé
  if (!loading && !data) {
    return (
      <div className="min-h-screen bg-gray-50 flex flex-col">
        <nav className="bg-white border-b border-gray-200">
          <div className="max-w-7xl mx-auto px-6 h-16 flex items-center justify-between">
            <div className="flex items-center gap-3">
              <button onClick={() => navigate('/role-selection')} className="p-2 rounded-lg hover:bg-gray-100">
                <ArrowLeft className="h-5 w-5 text-gray-600" />
              </button>
              <h1 className="text-xl font-semibold text-gray-900">Accès Fondateur</h1>
            </div>
          </div>
        </nav>
        <div className="flex-1 flex items-center justify-center p-8">
          <div className="text-center">
            <Shield className="h-12 w-12 mx-auto text-gray-400 mb-4" />
            <h2 className="text-2xl font-semibold text-gray-900 mb-2">Accès refusé</h2>
            <p className="text-gray-600 mb-4">Cette zone est réservée au fondateur de la plateforme.</p>
            <Button onClick={() => navigate('/role-selection')}>Retour</Button>
          </div>
        </div>
      </div>
    );
  }

  const totals = data?.totals || {};
  const last7 = data?.last_7d || {};
  const ratio = (a, b) => (b ? (a / b * 100).toFixed(1) + '%' : '—');
  const metrics = [
    { label: 'Utilisateurs', value: totals.users },
    { label: 'Entreprises', value: totals.companies },
    { label: 'Recherches', value: totals.searches },
    { label: 'Clients', value: totals.clients },
    { label: 'Devis', value: totals.quotes },
    { label: 'Chantiers', value: totals.worksites },
    { label: 'Matériels', value: totals.materials },
    { label: 'Abonnements', value: totals.subscriptions }
  ];

  return (
    <div className="min-h-screen bg-gray-50 flex flex-col">
      <nav className="bg-white border-b border-gray-200">
        <div className="max-w-7xl mx-auto px-6 h-16 flex items-center justify-between">
          <div className="flex items-center gap-3">
            <button onClick={() => navigate('/role-selection')} className="p-2 rounded-lg hover:bg-gray-100">
              <ArrowLeft className="h-5 w-5 text-gray-600" />
            </button>
            <h1 className="text-xl font-semibold text-gray-900 flex items-center gap-2">
              Vue Fondateur <Badge className="bg-indigo-600 text-white">Global</Badge>
            </h1>
          </div>
          {data?.generated_at && (
            <div className="text-xs text-gray-500">Maj: {new Date(data.generated_at).toLocaleTimeString()}</div>
          )}
        </div>
      </nav>
      <div className="flex-1 overflow-y-auto">
        <div className="max-w-7xl mx-auto px-6 py-8 space-y-8">
          {/* Etat chargement / erreur */}
          {loading && (
            <div className="p-4 bg-white border rounded-xl text-sm text-gray-600">Chargement des métriques…</div>
          )}
          {error && (
            <div className="p-4 bg-red-50 border border-red-200 rounded-xl text-sm text-red-600">{error}</div>
          )}

          {/* Grille Totaux */}
          <div className="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-8 gap-4">
            {metrics.map(m => (
              <div key={m.label} className="p-3 bg-white rounded-xl border border-gray-200 shadow-sm">
                <div className="text-xs uppercase tracking-wide text-gray-500">{m.label}</div>
                <div className="text-xl font-semibold text-gray-900">{m.value}</div>
              </div>
            ))}
          </div>

            {/* Derniers 7 jours */}
          <div>
            <h2 className="text-lg font-semibold text-gray-900 mb-3 flex items-center gap-2"><History className="h-5 w-5" /> Derniers 7 jours</h2>
            <div className="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-6 gap-4">
              {[
                { label: 'Utilisateurs (7j)', value: last7.users },
                { label: 'Recherches (7j)', value: last7.searches },
                { label: 'Clients (7j)', value: last7.clients },
                { label: 'Devis (7j)', value: last7.quotes }
              ].map(x => (
                <div key={x.label} className="p-4 bg-indigo-50 rounded-xl border border-indigo-100">
                  <div className="text-xs text-indigo-700">{x.label}</div>
                  <div className="text-lg font-semibold text-indigo-900">{x.value}</div>
                </div>
              ))}
            </div>
          </div>

          {/* Ratios simples */}
          <div>
            <h2 className="text-lg font-semibold text-gray-900 mb-3 flex items-center gap-2"><Target className="h-5 w-5" /> Ratios / Conversion</h2>
            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
              <div className="p-4 bg-white rounded-xl border border-gray-200">
                <div className="text-xs text-gray-500">Clients / Recherches</div>
                <div className="text-2xl font-semibold text-gray-900">{ratio(totals.clients, totals.searches)}</div>
              </div>
              <div className="p-4 bg-white rounded-xl border border-gray-200">
                <div className="text-xs text-gray-500">Devis / Clients</div>
                <div className="text-2xl font-semibold text-gray-900">{ratio(totals.quotes, totals.clients)}</div>
              </div>
              <div className="p-4 bg-white rounded-xl border border-gray-200">
                <div className="text-xs text-gray-500">Chantiers / Devis</div>
                <div className="text-2xl font-semibold text-gray-900">{ratio(totals.worksites, totals.quotes)}</div>
              </div>
              <div className="p-4 bg-white rounded-xl border border-gray-200">
                <div className="text-xs text-gray-500">Abonnements / Entreprises</div>
                <div className="text-2xl font-semibold text-gray-900">{ratio(totals.subscriptions, totals.companies)}</div>
              </div>
            </div>
          </div>

          <div className="text-xs text-gray-500">Cache backend 60s - actualisation automatique.</div>
        </div>
      </div>
    </div>
  );
};


const LandingPage = () => {
  const [showLoginModal, setShowLoginModal] = useState(false);
  const [showRegisterModal, setShowRegisterModal] = useState(false);
  const [showUserProfile, setShowUserProfile] = useState(false);
  const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
  const [scrollY, setScrollY] = useState(0);
  const [isVisible, setIsVisible] = useState({});
  // Filtre entreprise pour le fondateur
  const [selectedCompany, setSelectedCompany] = useState(null);
  const [companies, setCompanies] = useState([]);
  
  // Check if user is logged in
  const [isLoggedIn, setIsLoggedIn] = useState(false);
  const [user, setUser] = useState(null);
  const founderEmail = FOUNDER_EMAIL;
  const isFounder = (user?.is_fondateur === true) || ((user?.email || '').toLowerCase() === founderEmail);
  const isAdmin = isFounder || (user?.role === 'ADMIN');
  
  // Ne charger les stats que pour les fondateurs
  const shouldLoadStats = isFounder && isLoggedIn;
  const { stats, loading } = useRealTimeStats(selectedCompany, shouldLoadStats);

  useEffect(() => {
    const token = localStorage.getItem('token');
    const userData = localStorage.getItem('user');
    if (token && userData) {
      setIsLoggedIn(true);
      setUser(JSON.parse(userData));
      
      // Recharger le profil depuis l'API pour avoir les données à jour
      axios.get(`${API}/users/me`, {
        headers: { Authorization: `Bearer ${token}` }
      })
      .then(response => {
        setUser(response.data);
        localStorage.setItem('user', JSON.stringify(response.data));
      })
      .catch(err => console.error('Erreur rechargement profil:', err));
    }

    const handleScroll = () => setScrollY(window.scrollY);
    window.addEventListener('scroll', handleScroll);
    return () => window.removeEventListener('scroll', handleScroll);
  }, []);

  // Charger liste entreprises si fondateur
  useEffect(() => {
    const token = localStorage.getItem('token');
    if (isFounder && token) {
      axios.get(`${API}/companies`, { headers: { Authorization: `Bearer ${token}` } })
        .then(r => setCompanies(r.data || []))
        .catch(() => setCompanies([]));
    }
  }, [isFounder]);

  // Charger la liste des entreprises si fondateur
  useEffect(() => {
    const token = localStorage.getItem('token');
    if (isFounder && token) {
      axios.get(`${API}/companies`, { headers: { Authorization: `Bearer ${token}` } })
        .then(res => setCompanies(res.data || []))
        .catch(() => setCompanies([]));
    }
  }, [isFounder]);

  // Animation counter function
  const animateCounter = (element, target, duration = 2000) => {
    const start = 0;
    const startTime = performance.now();
    
    const updateCounter = (currentTime) => {
      const elapsed = currentTime - startTime;
      const progress = Math.min(elapsed / duration, 1);
      const current = Math.floor(progress * target);
      
      element.textContent = current;
      
      if (progress < 1) {
        requestAnimationFrame(updateCounter);
      }
    };
    
    requestAnimationFrame(updateCounter);
  };

  // Intersection Observer for animations
  useEffect(() => {
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            const id = entry.target.id;
            setIsVisible(prev => ({
              ...prev,
              [id]: true
            }));

            // Animate counters in about section
            if (id === 'apropos') {
              setTimeout(() => {
                const counterElements = entry.target.querySelectorAll('.counter-value');
                counterElements.forEach((el, index) => {
                  const target = el.dataset.target;
                  if (el.classList.contains('user-counter')) {
                    animateCounter(el, 108, 1500); // Default user count
                  } else {
                    animateCounter(el, parseInt(target), 1500);
                  }
                });

                // Animate values
                const valueItems = entry.target.querySelectorAll('.value-item');
                valueItems.forEach((item, index) => {
                  setTimeout(() => {
                    item.classList.add('animate');
                  }, index * 200);
                });
              }, 500);
            }

            // Animate pricing cards
            if (id === 'tarifs') {
              setTimeout(() => {
                const pricingCards = entry.target.querySelectorAll('.pricing-card');
                pricingCards.forEach((card, index) => {
                  setTimeout(() => {
                    card.classList.add('animate');
                  }, index * 200);
                });
              }, 300);
            }
          }
        });
      },
      { threshold: 0.3 }
    );

    // Observe sections
    const sections = document.querySelectorAll('#apropos, #tarifs');
    sections.forEach((section) => {
      observer.observe(section);
    });

    return () => observer.disconnect();
  }, []);

  // Cursor animation for pricing section
  useEffect(() => {
    const handleMouseMove = (e) => {
      const pricingSection = document.getElementById('tarifs');
      if (!pricingSection) return;

      const cursorEffect = pricingSection.querySelector('.pricing-cursor-effect');
      if (!cursorEffect) return;

      const rect = pricingSection.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      // Check if mouse is within pricing section
      if (x >= 0 && x <= rect.width && y >= 0 && y <= rect.height) {
        cursorEffect.style.left = x + 'px';
        cursorEffect.style.top = y + 'px';
        cursorEffect.style.opacity = '1';
      } else {
        cursorEffect.style.opacity = '0';
      }
    };

    const handleMouseLeave = () => {
      const pricingSection = document.getElementById('tarifs');
      if (!pricingSection) return;

      const cursorEffect = pricingSection.querySelector('.pricing-cursor-effect');
      if (!cursorEffect) return;

      cursorEffect.style.opacity = '0';
    };

    // Add event listeners
    document.addEventListener('mousemove', handleMouseMove);
    
    const pricingSection = document.getElementById('tarifs');
    if (pricingSection) {
      pricingSection.addEventListener('mouseleave', handleMouseLeave);
    }

    return () => {
      document.removeEventListener('mousemove', handleMouseMove);
      if (pricingSection) {
        pricingSection.removeEventListener('mouseleave', handleMouseLeave);
      }
    };
  }, []);

  const handleLogout = () => {
    localStorage.removeItem('token');
    localStorage.removeItem('user');
    setIsLoggedIn(false);
    setUser(null);
    window.location.reload();
  };

  const goToDashboard = () => {
    window.location.href = '/role-selection';
  };

  const goToStatistics = () => {
    window.location.href = '/statistiques';
  };

  // Advanced scroll effect
  useEffect(() => {
    const handleScroll = () => setScrollY(window.scrollY);
    window.addEventListener('scroll', handleScroll);
    return () => window.removeEventListener('scroll', handleScroll);
  }, []);

  // Intersection Observer for animations
  useEffect(() => {
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          setIsVisible(prev => ({
            ...prev,
            [entry.target.id]: entry.isIntersecting
          }));
        });
      },
      { threshold: 0.1 }
    );

    document.querySelectorAll('[id]').forEach((el) => {
      observer.observe(el);
    });

    return () => observer.disconnect();
  }, []);

  const features = [
    {
      icon: Search,
      title: "Recherche Terrain",
      description: "Interface mobile optimisée pour les techniciens sur le terrain avec géolocalisation GPS précise et hors-ligne."
    },
    {
      icon: FileBarChart,
      title: "Rapports Automatisés", 
      description: "Génération automatique de rapports PDF professionnels avec photos géolocalisées et observations détaillées."
    },
    {
      icon: Calculator,
      title: "Gestion des Devis",
      description: "Création et suivi des devis avec intégration catalogue produits et calculs automatiques."
    },
    {
      icon: MapPinIcon,
      title: "Cartographie Interactive",
      description: "Visualisation des chantiers sur carte avec informations en temps réel et navigation GPS."
    },
    {
      icon: Users,
      title: "Gestion Clients",
      description: "Base de données clients complète avec historique des interventions et suivi commercial."
    },
    {
      icon: BarChart3,
      title: "Analytics Avancés",
      description: "Tableau de bord analytique avec métriques de performance et insights prédictifs."
    }
  ];

  const testimonials = [
    {
      name: "Marie Dubois",
      role: "Technicienne BTP",
      company: "Constructions Modernes",
      content: "L'interface terrain est parfaite. Je peux faire mes recherches rapidement même sans réseau. Les rapports PDF se génèrent instantanément !",
      rating: 5,
      avatar: "MD"
    },
    {
      name: "Pierre Martin",
      role: "Chef de Bureau",
      company: "BTP Solutions", 
      content: "Les rapports automatiques nous font gagner 3h par jour. Le ROI a été immédiat. Interface Apple exceptionnelle !",
      rating: 5,
      avatar: "PM"
    },
    {
      name: "Sophie Rousseau",
      role: "Directrice Technique",
      company: "Terrassements Pro",
      content: "Les statistiques nous aident à optimiser nos interventions. Dashboard analytique de niveau enterprise.",
      rating: 5,
      avatar: "SR"
    }
  ];

  return (
    <div className="min-h-screen bg-white">
      {/* Apple-style Navigation */}
      <nav className={`fixed top-0 left-0 right-0 z-50 transition-all duration-500 ${
        scrollY > 50 
          ? 'bg-white/80 backdrop-blur-xl border-b border-gray-200/50' 
          : 'bg-transparent'
      }`}>
        <div className="navigation-menu max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex items-center justify-between h-16">
            {/* Logo */}
            <div className="logo-container flex items-center space-x-2">
              <img 
                src="/logo.png" 
                alt="SkyApp Logo" 
                className="w-32 h-32 sm:w-32 sm:h-32 md:w-28 md:h-28 lg:w-32 lg:h-32 rounded-lg object-cover logo-neon-effect"
              />
            </div>
            
            {/* Conditional Navigation */}
            {isLoggedIn ? (
              // Simplified logged-in navigation
              <div className="flex items-center space-x-4">
                <button 
                  onClick={() => setShowUserProfile(true)}
                  className="flex items-center space-x-3 hover:bg-gray-100 rounded-lg p-2 transition-colors"
                >
                  <div className="w-8 h-8 bg-gradient-to-r from-gray-800 to-black rounded-full flex items-center justify-center text-white font-medium text-sm">
                    {(() => {
                      const firstName = user?.first_name || user?.prenom || '';
                      const lastName = user?.last_name || user?.nom || '';
                      const initials = `${firstName.charAt(0)}${lastName.charAt(0)}`.toUpperCase();
                      return initials || user?.email?.charAt(0)?.toUpperCase() || 'U';
                    })()}
                  </div>
                  <div className="hidden md:block text-sm">
                    <span className="font-medium text-gray-900">
                      {user?.first_name || user?.prenom} {user?.last_name || user?.nom}
                    </span>
                  </div>
                </button>
                <Button
                  onClick={goToDashboard}
                  className="bg-black hover:bg-gray-800 text-white text-sm font-medium px-4 py-2 rounded-full transition-colors duration-200"
                >
                  Tableau de bord
                </Button>
                <Button
                  variant="ghost"
                  onClick={handleLogout}
                  className="text-gray-500 hover:text-gray-700 p-2"
                >
                  <LogOut className="h-4 w-4" />
                </Button>
              </div>
            ) : (
              // Original navigation for non-logged users
              <>
                <div className="flex items-center space-x-2 md:space-x-8">
                  <div className="hidden md:flex items-center space-x-8">
                    {[
                      { label: 'Fonctionnalités', id: 'features' },
                      { label: 'À propos', id: 'apropos' },
                      { label: 'Tarifs', id: 'tarifs' },
                      { label: 'Contact', id: 'contact' }
                    ].map((item) => (
                      <a
                        key={item.label}
                        href={`#${item.id}`}
                        className="text-sm font-medium text-gray-600 hover:text-gray-900 transition-colors duration-200"
                      >
                        {item.label}
                      </a>
                    ))}
                  </div>
                  <Button
                    variant="outline"
                    onClick={() => setShowLoginModal(true)}
                    className="border-2 border-blue-500 text-blue-500 hover:bg-blue-500 hover:text-white text-xs md:text-sm font-medium px-3 md:px-4 py-2 rounded-full transition-all duration-300 shadow-md hover:shadow-lg transform hover:scale-105 notranslate"
                    translate="no"
                  >
                    Connexion
                  </Button>
                  <Button
                    onClick={() => setShowRegisterModal(true)}
                    className="bg-black hover:bg-gray-800 text-white text-xs md:text-sm font-medium px-3 md:px-4 py-2 rounded-full transition-colors duration-200 notranslate"
                    translate="no"
                  >
                    Inscription
                  </Button>
                </div>
                
                {/* Mobile menu button */}
                <div className="md:hidden ml-2">
                  <Button
                    variant="ghost"
                    size="sm"
                    onClick={() => setMobileMenuOpen(!mobileMenuOpen)}
                    className="p-2"
                  >
                    {mobileMenuOpen ? <X className="h-5 w-5" /> : <Menu className="h-5 w-5" />}
                  </Button>
                </div>
              </>
            )}

            {/* Desktop menu hidden placeholder */}
            <div className="hidden">
              <Button
                variant="ghost"
                size="sm"
                onClick={() => setMobileMenuOpen(!mobileMenuOpen)}
                className="p-2"
              >
                {mobileMenuOpen ? <X className="h-5 w-5" /> : <Menu className="h-5 w-5" />}
              </Button>
            </div>
          </div>

          {/* Mobile Navigation */}
          <div className={`md:hidden border-t border-gray-200/50 bg-white/95 backdrop-blur-xl overflow-hidden transition-all duration-300 ease-in-out border-2 border-black ${mobileMenuOpen ? 'max-h-96 opacity-100' : 'max-h-0 opacity-0'}`}>
            <div className="py-4 space-y-4">
                {isLoggedIn ? (
                  <div className="space-y-3">
                    <div className="flex items-center space-x-3 px-4 py-2">
                      <div className="w-8 h-8 bg-gray-900 rounded-full flex items-center justify-center text-white font-medium text-sm">
                        {(user?.first_name || user?.prenom)?.charAt(0) || 'U'}
                      </div>
                      <div>
                        <div className="text-sm font-medium text-gray-900">
                          {user?.first_name || user?.prenom} {user?.last_name || user?.nom}
                        </div>
                        <div className="text-xs text-gray-500">{user?.email}</div>
                      </div>
                    </div>
                    <Button
                      onClick={goToDashboard}
                      className="w-full mx-4 bg-black hover:bg-gray-800 text-white text-sm font-medium py-2 rounded-full"
                    >
                      Tableau de bord
                    </Button>
                    <Button
                      variant="ghost"
                      onClick={handleLogout}
                      className="w-full mx-4 text-red-600 hover:bg-red-50 text-sm"
                    >
                      Déconnexion
                    </Button>
                  </div>
                ) : (
                  <>
                    {[
                      { label: 'Fonctionnalités', id: 'features' },
                      { label: 'À propos', id: 'apropos' },
                      { label: 'Tarifs', id: 'tarifs' },
                      { label: 'Contact', id: 'contact' }
                    ].map((item) => (
                      <a
                        key={item.label}
                        href={`#${item.id}`}
                        className="block px-4 py-2 text-sm font-medium text-gray-600 hover:text-gray-900"
                      >
                        {item.label}
                      </a>
                    ))}
                  </>
                )}
              </div>
            </div>
        </div>
      </nav>

      {/* Hero Section - Apple Style */}
      <section className="hero-section min-h-screen flex flex-col justify-center bg-white">
        <div className="max-w-4xl mx-auto px-4 sm:px-6 text-center">
          <div className="space-y-6 md:space-y-8">
            <div className="inline-flex items-center space-x-2 bg-gray-100 rounded-full px-3 sm:px-4 py-1.5 sm:py-2 text-xs sm:text-sm font-medium text-gray-700">
              <div className="w-2 h-2 bg-green-500 rounded-full"></div>
              <span className="hidden sm:inline">Nouveau : Solution complète de gestion d'entreprise</span>
              <span className="sm:hidden">Solution complète</span>
            </div>
            
            <h1 className="futuristic-text text-3xl sm:text-5xl md:text-6xl lg:text-7xl font-bold text-gray-900 leading-tight tracking-tight">
              Gestion d'Entreprise
              <br />
              <span className="text-gray-600">Complète</span>
            </h1>
            
            <p className="pricing-text text-base sm:text-lg md:text-xl text-gray-600 leading-relaxed max-w-2xl mx-auto">
              La plateforme tout-en-un qui digitalise votre entreprise : gestion des équipes, planification, 
              recherches géolocalisées, rapports automatiques, devis, facturation et analytics avancés.
            </p>

            <div className="hero-buttons flex flex-col sm:flex-row items-center justify-center space-y-4 sm:space-y-0 sm:space-x-4">
              <button
                onClick={() => setShowRegisterModal(true)}
                className="w-full sm:w-auto bg-black hover:bg-gray-800 text-white font-medium text-lg px-8 py-4 rounded-full transition-colors duration-200 flex items-center justify-center space-x-2"
              >
                <span>Commencer gratuitement</span>
                <ArrowRight className="h-5 w-5" />
              </button>
            </div>

            <div className="flex flex-wrap items-center justify-center gap-3 sm:gap-4 md:gap-8 text-xs sm:text-sm text-gray-500">
              <div className="flex items-center space-x-2">
                <Check className="h-4 w-4 text-black flex-shrink-0" />
                <span className="feature-text">Essai gratuit 14 jours</span>
              </div>
              <div className="flex items-center space-x-2">
                <Shield className="h-4 w-4 text-gray-700 flex-shrink-0" />
                <span className="feature-text">Gestion multi-utilisateurs</span>
              </div>
              <div className="flex items-center space-x-2">
                <Clock className="h-4 w-4 text-gray-800 flex-shrink-0" />
                <span className="feature-text">Tableau de bord temps réel</span>
              </div>
              <div className="flex items-center space-x-2">
                <Users className="h-4 w-4 text-gray-900 flex-shrink-0" />
                <span className="feature-text">Planning équipes</span>
              </div>
            </div>
          </div>
        </div>
      </section>

      {/* Features Section - Apple Style */}
      <section id="features" className="py-12 md:py-20 bg-gray-50">
        <div className="max-w-6xl mx-auto px-4 sm:px-6">
          <div className="text-center mb-12 md:mb-16">
            <h2 className="text-3xl md:text-4xl lg:text-5xl font-bold text-gray-900 mb-4">
              Tout ce dont vous avez besoin
            </h2>
            <p className="text-base md:text-lg lg:text-xl text-gray-600 max-w-2xl mx-auto">
              Des fonctionnalités révolutionnaires pensées par et pour les professionnels du terrain
            </p>
          </div>

          <div className="space-y-12 md:space-y-16">
            {/* Feature 1: Interface Technicien */}
            <div className="flex flex-col lg:flex-row items-center gap-8 md:gap-12">
              <div className="lg:w-1/2">
                <div className="bg-white rounded-3xl shadow-2xl overflow-hidden transform hover:scale-[1.02] transition-transform duration-500">
                  <img 
                    src="/Technicien menu.png"
                    alt="Interface Technicien - SkyApp"
                    className="w-full h-auto object-cover"
                  />
                </div>
              </div>
              <div className="lg:w-1/2">
                <div className="w-12 h-12 md:w-16 md:h-16 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-2xl flex items-center justify-center mb-4 md:mb-6 shadow-lg">
                  <Search className="h-6 w-6 md:h-8 md:w-8 text-white" />
                </div>
                <h3 className="text-2xl md:text-3xl lg:text-4xl font-bold text-gray-900 mb-3 md:mb-4">Interface Technicien Mobile</h3>
                <p className="text-base md:text-lg text-gray-600 leading-relaxed mb-4 md:mb-6">
                  Menu intuitif optimisé pour les techniciens terrain. Accès rapide aux recherches, missions, planning et rapports. Interface tactile adaptée à tous les appareils mobiles avec navigation simplifiée.
                </p>
                <ul className="space-y-2 md:space-y-3 text-sm md:text-base text-gray-700">
                  <li className="flex items-center"><Check className="h-4 w-4 md:h-5 md:w-5 text-green-500 mr-2 md:mr-3 flex-shrink-0" /><span className="font-medium">Navigation simplifiée pour le terrain</span></li>
                  <li className="flex items-center"><Check className="h-4 w-4 md:h-5 md:w-5 text-green-500 mr-2 md:mr-3 flex-shrink-0" /><span className="font-medium">Accès rapide aux missions en cours</span></li>
                  <li className="flex items-center"><Check className="h-4 w-4 md:h-5 md:w-5 text-green-500 mr-2 md:mr-3 flex-shrink-0" /><span className="font-medium">Interface tactile optimisée</span></li>
                </ul>
              </div>
            </div>

            {/* Feature 2: Interface Bureau */}
            <div className="flex flex-col lg:flex-row-reverse items-center gap-8 md:gap-12">
              <div className="lg:w-1/2">
                <div className="bg-white rounded-3xl shadow-2xl overflow-hidden transform hover:scale-[1.02] transition-transform duration-500">
                  <img 
                    src="/Bureau Menu.png"
                    alt="Interface Bureau - SkyApp"
                    className="w-full h-auto object-cover"
                  />
                </div>
              </div>
              <div className="lg:w-1/2">
                <div className="w-12 h-12 md:w-16 md:h-16 bg-gradient-to-br from-green-500 to-emerald-500 rounded-2xl flex items-center justify-center mb-4 md:mb-6 shadow-lg">
                  <FileText className="h-6 w-6 md:h-8 md:w-8 text-white" />
                </div>
                <h3 className="text-2xl md:text-3xl lg:text-4xl font-bold text-gray-900 mb-3 md:mb-4">Centre de Gestion Bureau</h3>
                <p className="text-base md:text-lg text-gray-600 leading-relaxed mb-4 md:mb-6">
                  Interface administrative complète pour gérer toute votre activité. Tableau de bord centralisé avec accès aux recherches, devis, clients, planning et rapports. Statistiques globales et navigation rapide.
                </p>
                <ul className="space-y-2 md:space-y-3 text-sm md:text-base text-gray-700">
                  <li className="flex items-center"><Check className="h-4 w-4 md:h-5 md:w-5 text-green-500 mr-2 md:mr-3 flex-shrink-0" /><span className="font-medium">Tableau de bord centralisé</span></li>
                  <li className="flex items-center"><Check className="h-4 w-4 md:h-5 md:w-5 text-green-500 mr-2 md:mr-3 flex-shrink-0" /><span className="font-medium">Statistiques d'activité globales</span></li>
                  <li className="flex items-center"><Check className="h-4 w-4 md:h-5 md:w-5 text-green-500 mr-2 md:mr-3 flex-shrink-0" /><span className="font-medium">Navigation intuitive entre modules</span></li>
                </ul>
              </div>
            </div>

            {/* Feature 3: Gestion Commerciale */}
            <div className="flex flex-col lg:flex-row items-center gap-8 md:gap-12">
              <div className="lg:w-1/2">
                <div className="bg-white rounded-3xl shadow-2xl overflow-hidden transform hover:scale-[1.02] transition-transform duration-500">
                  <img 
                    src="/Centre gestion comerciale.png"
                    alt="Centre de Gestion Commerciale - SkyApp"
                    className="w-full h-auto object-cover"
                  />
                </div>
              </div>
              <div className="lg:w-1/2">
                <div className="w-12 h-12 md:w-16 md:h-16 bg-gradient-to-br from-purple-500 to-violet-500 rounded-2xl flex items-center justify-center mb-4 md:mb-6 shadow-lg">
                  <DollarSign className="h-6 w-6 md:h-8 md:w-8 text-white" />
                </div>
                <h3 className="text-2xl md:text-3xl lg:text-4xl font-bold text-gray-900 mb-3 md:mb-4">Centre de Gestion Commerciale</h3>
                <p className="text-base md:text-lg text-gray-600 leading-relaxed mb-4 md:mb-6">
                  Module complet pour la gestion commerciale : devis, clients, projets et chantiers. Suivez l'ensemble du cycle de vente depuis la prospection jusqu'à la réalisation. Génération automatique de documents et suivi d'activité.
                </p>
                <ul className="space-y-2 md:space-y-3 text-sm md:text-base text-gray-700">
                  <li className="flex items-center"><Check className="h-4 w-4 md:h-5 md:w-5 text-green-500 mr-2 md:mr-3 flex-shrink-0" /><span className="font-medium">Gestion complète clients et projets</span></li>
                  <li className="flex items-center"><Check className="h-4 w-4 md:h-5 md:w-5 text-green-500 mr-2 md:mr-3 flex-shrink-0" /><span className="font-medium">Cycle devis → chantier automatisé</span></li>
                  <li className="flex items-center"><Check className="h-4 w-4 md:h-5 md:w-5 text-green-500 mr-2 md:mr-3 flex-shrink-0" /><span className="font-medium">Documents professionnels personnalisés</span></li>
                </ul>
              </div>
            </div>

            {/* Feature 4: Planning Équipe */}
            <div className="flex flex-col lg:flex-row-reverse items-center gap-8 md:gap-12">
              <div className="lg:w-1/2">
                <div className="bg-white rounded-3xl shadow-2xl overflow-hidden transform hover:scale-[1.02] transition-transform duration-500">
                  <img 
                    src="/Planing équipe.png"
                    alt="Planning d'Équipe - SkyApp"
                    className="w-full h-auto object-cover"
                  />
                </div>
              </div>
              <div className="lg:w-1/2">
                <div className="w-12 h-12 md:w-16 md:h-16 bg-gradient-to-br from-orange-500 to-red-500 rounded-2xl flex items-center justify-center mb-4 md:mb-6 shadow-lg">
                  <Calendar className="h-6 w-6 md:h-8 md:w-8 text-white" />
                </div>
                <h3 className="text-2xl md:text-3xl lg:text-4xl font-bold text-gray-900 mb-3 md:mb-4">Planning d'Équipe Intelligent</h3>
                <p className="text-base md:text-lg text-gray-600 leading-relaxed mb-4 md:mb-6">
                  Organisez et visualisez le planning de vos équipes en temps réel. Assignation drag & drop, gestion des disponibilités, vue calendrier et liste. Synchronisation automatique avec les missions terrain et notifications.
                </p>
                <ul className="space-y-2 md:space-y-3 text-sm md:text-base text-gray-700">
                  <li className="flex items-center"><Check className="h-4 w-4 md:h-5 md:w-5 text-green-500 mr-2 md:mr-3 flex-shrink-0" /><span className="font-medium">Vue calendrier et planning hebdomadaire</span></li>
                  <li className="flex items-center"><Check className="h-4 w-4 md:h-5 md:w-5 text-green-500 mr-2 md:mr-3 flex-shrink-0" /><span className="font-medium">Assignation rapide par drag & drop</span></li>
                  <li className="flex items-center"><Check className="h-4 w-4 md:h-5 md:w-5 text-green-500 mr-2 md:mr-3 flex-shrink-0" /><span className="font-medium">Gestion des disponibilités techniciens</span></li>
                </ul>
              </div>
            </div>

            {/* Feature 5: Analytics Avancées */}
            <div className="flex flex-col lg:flex-row items-center gap-8 md:gap-12">
              <div className="lg:w-1/2">
                <div className="bg-white rounded-3xl shadow-2xl overflow-hidden transform hover:scale-[1.02] transition-transform duration-500">
                  <img 
                    src="/Analytics.png"
                    alt="Analytics Avancées - SkyApp"
                    className="w-full h-auto object-cover"
                  />
                </div>
              </div>
              <div className="lg:w-1/2">
                <div className="w-12 h-12 md:w-16 md:h-16 bg-gradient-to-br from-indigo-500 to-blue-500 rounded-2xl flex items-center justify-center mb-4 md:mb-6 shadow-lg">
                  <BarChart3 className="h-6 w-6 md:h-8 md:w-8 text-white" />
                </div>
                <h3 className="text-2xl md:text-3xl lg:text-4xl font-bold text-gray-900 mb-3 md:mb-4">Analytics & Statistiques Avancées</h3>
                <p className="text-base md:text-lg text-gray-600 leading-relaxed mb-4 md:mb-6">
                  Analysez votre performance avec des graphiques détaillés et KPI en temps réel. Évolution du chiffre d'affaires, nombre de projets, taux de conversion, répartition géographique. Prenez des décisions éclairées basées sur vos données.
                </p>
                <ul className="space-y-2 md:space-y-3 text-sm md:text-base text-gray-700">
                  <li className="flex items-center"><Check className="h-4 w-4 md:h-5 md:w-5 text-green-500 mr-2 md:mr-3 flex-shrink-0" /><span className="font-medium">Graphiques interactifs et KPI visuels</span></li>
                  <li className="flex items-center"><Check className="h-4 w-4 md:h-5 md:w-5 text-green-500 mr-2 md:mr-3 flex-shrink-0" /><span className="font-medium">Suivi CA et taux de conversion</span></li>
                  <li className="flex items-center"><Check className="h-4 w-4 md:h-5 md:w-5 text-green-500 mr-2 md:mr-3 flex-shrink-0" /><span className="font-medium">Analyse géographique par région</span></li>
                </ul>
              </div>
            </div>
          </div>

          {/* Real-time Stats Section */}
          {stats?.cached && (
            <div className="mb-4 text-xs text-gray-500">Données mises en cache (60s)</div>
          )}
          {isFounder && (
            <div className="mb-12">
              <div className="p-4 rounded-xl border border-indigo-200 bg-indigo-50/60 backdrop-blur-sm">
                <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                  <div className="flex items-center gap-2">
                    <Badge className="bg-gradient-to-r from-indigo-600 to-purple-600 text-white shadow">
                      Fondateur — Statistiques {selectedCompany ? 'filtrées entreprise' : 'globales'}
                    </Badge>
                    {selectedCompany && (
                      <Button size="sm" variant="outline" onClick={() => setSelectedCompany(null)}>
                        Vue globale
                      </Button>
                    )}
                  </div>
                  <div className="flex items-center gap-3">
                    <Select value={selectedCompany || ''} onValueChange={(v) => setSelectedCompany(v)}>
                      <SelectTrigger className="w-64">
                        <SelectValue placeholder="Filtrer par entreprise" />
                      </SelectTrigger>
                      <SelectContent>
                        {companies.map(c => (
                          <SelectItem key={c.id} value={c.id}>{c.name}</SelectItem>
                        ))}
                      </SelectContent>
                    </Select>
                  </div>
                </div>
                <p className="mt-2 text-xs text-gray-600">
                  {selectedCompany ? 'Affichage limité à cette entreprise. Cache 60s.' : 'Vue globale agrégée. Cache 60s.'}
                </p>
              </div>
            </div>
          )}
          <div className="mt-12 md:mt-20 grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-8">
            <div className="text-center">
              <RealTimeStatsDisplay 
                stats={loading ? "..." : `${stats.total_users}`} 
                className="text-2xl md:text-3xl font-bold text-gray-900 mb-2" 
              />
              <div className="text-xs md:text-sm text-gray-600">Utilisateurs actifs</div>
            </div>
            <div className="text-center">
              <RealTimeStatsDisplay 
                stats={loading ? "..." : `${Math.floor(stats.total_searches / 1000)}K+`} 
                className="text-2xl md:text-3xl font-bold text-gray-900 mb-2"
                showIndicator={false}
              />
              <div className="text-xs md:text-sm text-gray-600">Recherches traitées</div>
            </div>
            <div className="text-center">
              <RealTimeStatsDisplay 
                stats={loading ? "..." : stats.uptime} 
                className="text-2xl md:text-3xl font-bold text-gray-900 mb-2"
                showIndicator={false}
              />
              <div className="text-xs md:text-sm text-gray-600">Temps de disponibilité</div>
            </div>
            <div className="text-center">
              <div className="text-2xl md:text-3xl font-bold text-gray-900 mb-2">24/7</div>
              <div className="text-xs md:text-sm text-gray-600">Support technique</div>
            </div>
          </div>
        </div>
      </section>

      {/* About Section - Apple Style */}
      <section id="apropos" className="py-12 md:py-20 bg-white">
        <div className="max-w-6xl mx-auto px-4 sm:px-6">
          <div className="text-center mb-12 md:mb-16">
            <h2 className="text-3xl md:text-4xl lg:text-5xl font-bold text-gray-900 mb-4 futuristic-text">
              À propos de SkyApp
            </h2>
            <p className="text-base md:text-lg lg:text-xl text-gray-600 max-w-3xl mx-auto pricing-text">
              Révolutionner le secteur BTP avec une technologie de pointe adaptée aux professionnels du terrain
            </p>
          </div>

          <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 md:gap-12 items-center">
            <div className="space-y-4 md:space-y-6">
              <h3 className="text-xl md:text-2xl font-semibold text-gray-900">Notre Histoire</h3>
              <p className="text-sm md:text-base text-gray-600 leading-relaxed">
                SkyApp a été créée en 2025 pour répondre aux défis technologiques du secteur BTP. 
                Notre équipe d'ingénieurs et de professionnels du terrain développe des solutions 
                innovantes qui simplifient la gestion des recherches de réseaux et la création de rapports.
              </p>
              
              <h3 className="text-xl md:text-2xl font-semibold text-gray-900">Notre Mission</h3>
              <p className="text-sm md:text-base text-gray-600 leading-relaxed">
                Digitaliser le travail terrain avec des outils intuitifs qui permettent aux techniciens 
                de se concentrer sur leur expertise plutôt que sur la paperasse. Nous croyons en la 
                puissance de la technologie au service de l'efficacité opérationnelle.
              </p>

              <div className="grid grid-cols-2 gap-4 md:gap-6 mt-6 md:mt-8">
                <div className="text-center counter-container">
                  <div className="text-2xl md:text-3xl font-bold text-gray-900 counter-value" data-target="2025">0</div>
                  <div className="text-xs md:text-sm text-gray-600">Année de création</div>
                </div>
                {/* Real-time companies counter */}
                <div className="text-center counter-container">
                  <div className="text-2xl md:text-3xl font-bold text-gray-900 counter-value" data-target="24">0</div>
                  <div className="text-xs md:text-sm text-gray-600 flex items-center justify-center space-x-1 md:space-x-2">
                    <span>Sociétés créées sur SkyApp</span>
                    <div className="flex items-center space-x-1">
                      <div className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                      <span className="text-xs text-gray-500">temps réel</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div className="bg-gray-50 rounded-2xl p-6 md:p-8">
              <h3 className="text-xl md:text-2xl font-semibold text-gray-900 mb-4 md:mb-6">Nos Valeurs</h3>
              <div className="space-y-3 md:space-y-4">
                <div className="flex items-start space-x-2 md:space-x-3 value-item" style={{opacity: 0, transform: 'translateY(20px)'}}>
                  <div className="w-2 h-2 bg-black rounded-full mt-1.5 md:mt-2 flex-shrink-0"></div>
                  <div>
                    <h4 className="font-semibold text-sm md:text-base text-gray-900">Innovation Technologique</h4>
                    <p className="text-xs md:text-sm text-gray-600">IA, géolocalisation GPS, génération PDF automatique</p>
                  </div>
                </div>
                <div className="flex items-start space-x-2 md:space-x-3 value-item" style={{opacity: 0, transform: 'translateY(20px)'}}>
                  <div className="w-2 h-2 bg-gray-700 rounded-full mt-1.5 md:mt-2 flex-shrink-0"></div>
                  <div>
                    <h4 className="font-semibold text-sm md:text-base text-gray-900">Ergonomie Terrain</h4>
                    <p className="text-xs md:text-sm text-gray-600">Interface mobile optimisée, fonctionnement hors-ligne</p>
                  </div>
                </div>
                <div className="flex items-start space-x-2 md:space-x-3 value-item" style={{opacity: 0, transform: 'translateY(20px)'}}>
                  <div className="w-2 h-2 bg-gray-800 rounded-full mt-1.5 md:mt-2 flex-shrink-0"></div>
                  <div>
                    <h4 className="font-semibold text-sm md:text-base text-gray-900">Sécurité des Données</h4>
                    <p className="text-xs md:text-sm text-gray-600">Chiffrement, sauvegarde cloud, conformité RGPD</p>
                  </div>
                </div>
                <div className="flex items-start space-x-2 md:space-x-3 value-item" style={{opacity: 0, transform: 'translateY(20px)'}}>
                  <div className="w-2 h-2 bg-gray-900 rounded-full mt-1.5 md:mt-2 flex-shrink-0"></div>
                  <div>
                    <h4 className="font-semibold text-sm md:text-base text-gray-900">Support Réactif</h4>
                    <p className="text-xs md:text-sm text-gray-600">Équipe technique dédiée, formation personnalisée</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      {/* Testimonials Section - Apple Style */}
      <section id="testimonials" className="py-12 md:py-20 bg-white">
        <div className="max-w-6xl mx-auto px-4 sm:px-6">
          <div className="text-center mb-12 md:mb-16">
            <h2 className="text-3xl md:text-4xl lg:text-5xl font-bold text-gray-900 mb-4">
              Ils nous font confiance
            </h2>
            <p className="text-base md:text-lg lg:text-xl text-gray-600">
              Plus de 1000 professionnels utilisent SkyApp au quotidien
            </p>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
            {testimonials.map((testimonial, index) => (
              <div
                key={index}
                className="bg-gray-50 rounded-2xl p-8"
              >
                <div className="flex space-x-1 mb-6">
                  {[...Array(testimonial.rating)].map((_, i) => (
                    <Star key={i} className="h-5 w-5 text-yellow-400 fill-current" />
                  ))}
                </div>

                <blockquote className="text-gray-700 leading-relaxed mb-8 italic">
                  "{testimonial.content}"
                </blockquote>

                <div className="flex items-center space-x-4">
                  <div className="w-12 h-12 bg-gray-900 rounded-full flex items-center justify-center text-white font-semibold">
                    {testimonial.avatar}
                  </div>
                  <div>
                    <div className="font-semibold text-gray-900">{testimonial.name}</div>
                    <div className="text-sm text-gray-600">{testimonial.role}</div>
                    <div className="text-sm text-gray-500">{testimonial.company}</div>
                  </div>
                </div>
              </div>
            ))}
          </div>
        </div>
      </section>

      {/* Pricing Section - Animated Background */}
      <section id="tarifs" className="py-12 md:py-20 bg-gradient-to-br from-gray-50 to-white relative overflow-hidden">
        {/* Animated Cursor Background */}
        <div className="absolute inset-0 pricing-bg-container">
          <div className="pricing-cursor-effect"></div>
          <div className="pricing-grid-overlay"></div>
        </div>

        <div className="pricing-container max-w-6xl mx-auto px-4 sm:px-6 relative z-10">
          <div className="text-center mb-12 sm:mb-16">
            <h2 className="text-3xl sm:text-4xl md:text-5xl font-bold text-gray-900 mb-4 futuristic-text">
              Tarifs
            </h2>
            <p className="text-base sm:text-lg md:text-xl text-gray-600 max-w-2xl mx-auto pricing-text">
              Des solutions adaptées à chaque besoin, avec un support technique inclus dans tous nos plans
            </p>
          </div>

          <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 sm:gap-8">
            {/* Plan Starter */}
            <div className="pricing-card bg-white/90 backdrop-blur-sm rounded-3xl p-6 md:p-8 border-2 border-gray-200 relative overflow-hidden hover:border-gray-400 transition-all duration-300 hover:bg-white/95">
              <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-gray-600 to-gray-800"></div>
              
              <div className="text-center">
                <h3 className="text-xl md:text-2xl font-semibold text-gray-900 mb-2 font-space-grotesk">Starter</h3>
                <p className="text-sm md:text-base text-gray-600 mb-4 md:mb-6">Idéal pour les petites équipes</p>
                <div className="mb-6 md:mb-8">
                  <span className="text-4xl md:text-5xl font-bold text-gray-900 price-bounce">29€</span>
                  <span className="text-gray-600 ml-1">/mois</span>
                  <p className="text-xs md:text-sm text-gray-500 mt-2">Facturation mensuelle</p>
                </div>
              </div>
              
              <ul className="space-y-3 md:space-y-4 mb-6 md:mb-8">
                <li className="flex items-center text-sm md:text-base text-gray-600 pricing-feature">
                  <div className="w-5 h-5 bg-black rounded-full flex items-center justify-center mr-3">
                    <Check className="h-3 w-3 text-white" />
                  </div>
                  <span>Jusqu'à 5 utilisateurs</span>
                </li>
                <li className="flex items-center text-gray-600 pricing-feature">
                  <div className="w-5 h-5 bg-black rounded-full flex items-center justify-center mr-3">
                    <Check className="h-3 w-3 text-white" />
                  </div>
                  <span>100 recherches/mois</span>
                </li>
                <li className="flex items-center text-gray-600 pricing-feature">
                  <div className="w-5 h-5 bg-black rounded-full flex items-center justify-center mr-3">
                    <Check className="h-3 w-3 text-white" />
                  </div>
                  <span>Rapports PDF basiques</span>
                </li>
                <li className="flex items-center text-gray-600 pricing-feature">
                  <div className="w-5 h-5 bg-black rounded-full flex items-center justify-center mr-3">
                    <Check className="h-3 w-3 text-white" />
                  </div>
                  <span>Support email (48h)</span>
                </li>
                <li className="flex items-center text-gray-600 pricing-feature">
                  <div className="w-5 h-5 bg-black rounded-full flex items-center justify-center mr-3">
                    <Check className="h-3 w-3 text-white" />
                  </div>
                  <span>Stockage 10 GB</span>
                </li>
                <li className="flex items-center text-gray-600 pricing-feature">
                  <div className="w-5 h-5 bg-black rounded-full flex items-center justify-center mr-3">
                    <Check className="h-3 w-3 text-white" />
                  </div>
                  <span>Géolocalisation de base</span>
                </li>
              </ul>
              
              <button 
                onClick={() => setShowRegisterModal(true)}
                className="w-full bg-gradient-to-r from-gray-900 to-black hover:from-black hover:to-gray-800 text-white font-medium py-4 rounded-2xl transition-all duration-300 transform hover:scale-105 shadow-lg hover:shadow-2xl"
              >
                Commencer
              </button>
            </div>

            {/* Plan Professional - Recommandé */}
            <div className="pricing-card bg-white/90 backdrop-blur-sm rounded-3xl p-6 md:p-8 border-2 border-black relative overflow-hidden lg:transform lg:scale-105 shadow-2xl hover:bg-white/95 lg:mt-0">
              <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-black to-gray-700"></div>
              <div className="absolute -top-5 md:-top-6 left-1/2 transform -translate-x-1/2">
                <span className="bg-black text-white px-4 md:px-6 py-1.5 md:py-2 rounded-full text-xs md:text-sm font-medium shadow-xl">
                  ⭐ Recommandé
                </span>
              </div>
              
              <div className="text-center mt-4 md:mt-6">
                <h3 className="text-xl md:text-2xl font-semibold text-gray-900 mb-2 font-space-grotesk">Professional</h3>
                <p className="text-sm md:text-base text-gray-600 mb-4 md:mb-6">Équipes en croissance</p>
                <div className="mb-6 md:mb-8">
                  <span className="text-4xl md:text-5xl font-bold text-black price-bounce">79€</span>
                  <span className="text-gray-600 ml-1">/mois</span>
                  <p className="text-xs md:text-sm text-gray-500 mt-2">Facturation annuelle : 790€</p>
                </div>
              </div>
              
              <ul className="space-y-3 md:space-y-4 mb-6 md:mb-8">
                <li className="flex items-center text-sm md:text-base text-gray-600 pricing-feature">
                  <div className="w-5 h-5 bg-black rounded-full flex items-center justify-center mr-3">
                    <Check className="h-3 w-3 text-white" />
                  </div>
                  <span>Utilisateurs illimités</span>
                </li>
                <li className="flex items-center text-gray-600 pricing-feature">
                  <div className="w-5 h-5 bg-black rounded-full flex items-center justify-center mr-3">
                    <Check className="h-3 w-3 text-white" />
                  </div>
                  <span>Recherches illimitées</span>
                </li>
                <li className="flex items-center text-gray-600 pricing-feature">
                  <div className="w-5 h-5 bg-black rounded-full flex items-center justify-center mr-3">
                    <Check className="h-3 w-3 text-white" />
                  </div>
                  <span>Rapports PDF avancés + branding</span>
                </li>
                <li className="flex items-center text-gray-600 pricing-feature">
                  <div className="w-5 h-5 bg-black rounded-full flex items-center justify-center mr-3">
                    <Check className="h-3 w-3 text-white" />
                  </div>
                  <span>Analytics & dashboards complets</span>
                </li>
                <li className="flex items-center text-gray-600 pricing-feature">
                  <div className="w-5 h-5 bg-black rounded-full flex items-center justify-center mr-3">
                    <Check className="h-3 w-3 text-white" />
                  </div>
                  <span>Support prioritaire 24/7</span>
                </li>
                <li className="flex items-center text-gray-600 pricing-feature">
                  <div className="w-5 h-5 bg-black rounded-full flex items-center justify-center mr-3">
                    <Check className="h-3 w-3 text-white" />
                  </div>
                  <span>Stockage illimité</span>
                </li>
                <li className="flex items-center text-gray-600 pricing-feature">
                  <div className="w-5 h-5 bg-black rounded-full flex items-center justify-center mr-3">
                    <Check className="h-3 w-3 text-white" />
                  </div>
                  <span>API & intégrations</span>
                </li>
                <li className="flex items-center text-gray-600 pricing-feature">
                  <div className="w-5 h-5 bg-black rounded-full flex items-center justify-center mr-3">
                    <Check className="h-3 w-3 text-white" />
                  </div>
                  <span>Géolocalisation avancée + GPS</span>
                </li>
              </ul>
              
              <button 
                onClick={() => setShowRegisterModal(true)}
                className="w-full bg-black hover:bg-gray-800 text-white font-medium py-4 rounded-2xl transition-all duration-300 transform hover:scale-105 shadow-lg hover:shadow-2xl"
              >
                Commencer maintenant
              </button>
            </div>

            {/* Plan Enterprise */}
            <div className="pricing-card bg-white/90 backdrop-blur-sm rounded-3xl p-6 md:p-8 border-2 border-gray-200 relative overflow-hidden hover:border-gray-400 transition-all duration-300 hover:bg-white/95">
              <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-gray-400 to-gray-600"></div>
              
              <div className="text-center">
                <h3 className="text-xl md:text-2xl font-semibold text-gray-900 mb-2 font-space-grotesk">Enterprise</h3>
                <p className="text-sm md:text-base text-gray-600 mb-4 md:mb-6">Solutions sur mesure</p>
                <div className="mb-6 md:mb-8">
                  <span className="text-2xl md:text-3xl font-bold text-gray-900 price-bounce">Sur mesure</span>
                  <p className="text-xs md:text-sm text-gray-500 mt-2">Devis personnalisé</p>
                </div>
              </div>
              
              <ul className="space-y-3 md:space-y-4 mb-6 md:mb-8">
                <li className="flex items-center text-sm md:text-base text-gray-600 pricing-feature">
                  <div className="w-5 h-5 bg-black rounded-full flex items-center justify-center mr-3">
                    <Check className="h-3 w-3 text-white" />
                  </div>
                  <span>Configuration personnalisée</span>
                </li>
                <li className="flex items-center text-gray-600 pricing-feature">
                  <div className="w-5 h-5 bg-black rounded-full flex items-center justify-center mr-3">
                    <Check className="h-3 w-3 text-white" />
                  </div>
                  <span>Intégrations sur mesure</span>
                </li>
                <li className="flex items-center text-gray-600 pricing-feature">
                  <div className="w-5 h-5 bg-black rounded-full flex items-center justify-center mr-3">
                    <Check className="h-3 w-3 text-white" />
                  </div>
                  <span>Formation équipe dédiée</span>
                </li>
                <li className="flex items-center text-gray-600 pricing-feature">
                  <div className="w-5 h-5 bg-black rounded-full flex items-center justify-center mr-3">
                    <Check className="h-3 w-3 text-white" />
                  </div>
                  <span>Account Manager dédié</span>
                </li>
                <li className="flex items-center text-gray-600 pricing-feature">
                  <div className="w-5 h-5 bg-black rounded-full flex items-center justify-center mr-3">
                    <Check className="h-3 w-3 text-white" />
                  </div>
                  <span>SLA garantie 99.9%</span>
                </li>
                <li className="flex items-center text-gray-600 pricing-feature">
                  <div className="w-5 h-5 bg-black rounded-full flex items-center justify-center mr-3">
                    <Check className="h-3 w-3 text-white" />
                  </div>
                  <span>Infrastructure dédiée</span>
                </li>
                <li className="flex items-center text-gray-600 pricing-feature">
                  <div className="w-5 h-5 bg-black rounded-full flex items-center justify-center mr-3">
                    <Check className="h-3 w-3 text-white" />
                  </div>
                  <span>Multi-tenant avancé</span>
                </li>
                <li className="flex items-center text-gray-600 pricing-feature">
                  <div className="w-5 h-5 bg-black rounded-full flex items-center justify-center mr-3">
                    <Check className="h-3 w-3 text-white" />
                  </div>
                  <span>Sécurité renforcée</span>
                </li>
              </ul>
              
              <button className="w-full bg-black hover:bg-gray-800 text-white font-medium py-4 rounded-2xl transition-all duration-300 transform hover:scale-105 shadow-lg hover:shadow-xl">
                Nous contacter
              </button>
            </div>
          </div>

          {/* FAQ */}
          <div className="mt-16 md:mt-20 text-center">
            <h3 className="text-2xl md:text-3xl font-semibold text-gray-900 mb-8 md:mb-12 futuristic-text">Questions fréquentes</h3>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-8 max-w-4xl mx-auto">
              <div className="text-left bg-white/80 backdrop-blur-sm p-5 md:p-6 rounded-2xl border border-gray-200 hover:border-gray-400 hover:shadow-lg hover:bg-white/90 transition-all duration-300">
                <h4 className="font-semibold text-gray-900 mb-2 md:mb-3 text-base md:text-lg">Puis-je changer de plan ?</h4>
                <p className="text-sm md:text-base text-gray-600">Oui, vous pouvez upgrader ou downgrader votre plan à tout moment depuis votre tableau de bord.</p>
              </div>
              <div className="text-left bg-white/80 backdrop-blur-sm p-5 md:p-6 rounded-2xl border border-gray-200 hover:border-gray-400 hover:shadow-lg hover:bg-white/90 transition-all duration-300">
                <h4 className="font-semibold text-gray-900 mb-2 md:mb-3 text-base md:text-lg">Y a-t-il des frais cachés ?</h4>
                <p className="text-sm md:text-base text-gray-600">Aucun frais caché. Tous nos tarifs sont transparents et affichés TTC.</p>
              </div>
              <div className="text-left bg-white/80 backdrop-blur-sm p-5 md:p-6 rounded-2xl border border-gray-200 hover:border-gray-400 hover:shadow-lg hover:bg-white/90 transition-all duration-300">
                <h4 className="font-semibold text-gray-900 mb-2 md:mb-3 text-base md:text-lg">Essai gratuit disponible ?</h4>
                <p className="text-sm md:text-base text-gray-600">Oui, 14 jours d'essai gratuit pour tous les plans, sans engagement ni carte bancaire.</p>
              </div>
              <div className="text-left bg-white/80 backdrop-blur-sm p-5 md:p-6 rounded-2xl border border-gray-200 hover:border-gray-400 hover:shadow-lg hover:bg-white/90 transition-all duration-300">
                <h4 className="font-semibold text-gray-900 mb-2 md:mb-3 text-base md:text-lg">Support technique inclus ?</h4>
                <p className="text-sm md:text-base text-gray-600">Support 24/7 inclus dans tous nos plans, avec priorité pour les plans Professional et Enterprise.</p>
              </div>
            </div>
          </div>
        </div>
      </section>

      {/* CTA Section - Apple Style */}
      <section id="cta" className="py-12 md:py-20 bg-gray-900">
        <div className="max-w-4xl mx-auto px-4 sm:px-6 text-center">
          <h2 className="text-3xl md:text-4xl lg:text-5xl font-bold text-white mb-4 md:mb-6">
            Prêt à révolutionner votre terrain ?
          </h2>
          <p className="text-base md:text-lg lg:text-xl text-gray-300 mb-8 md:mb-10">
            Rejoignez plus de 1000 professionnels qui ont déjà transformé leur façon de travailler
          </p>
          
          <div className="flex flex-col sm:flex-row gap-4 justify-center">
            <button
              onClick={() => setShowRegisterModal(true)}
              className="bg-white hover:bg-gray-100 text-gray-900 font-medium text-lg px-8 py-4 rounded-full transition-colors duration-200"
            >
              Commencer maintenant
            </button>
          </div>

          <div className="flex flex-wrap items-center justify-center gap-4 md:gap-8 text-xs md:text-sm text-gray-400 mt-6 md:mt-8">
            <div className="flex items-center space-x-2">
              <Check className="h-4 w-4" />
              <span>14 jours gratuits</span>
            </div>
            <div className="flex items-center space-x-2">
              <Shield className="h-4 w-4" />
              <span>Sans engagement</span>
            </div>
            <div className="flex items-center space-x-2">
              <Clock className="h-4 w-4" />
              <span>Support premium</span>
            </div>
          </div>
        </div>
      </section>

      {/* Contact Section - Simple */}
      <section id="contact" className="py-20 md:py-32 bg-gray-900 text-white">
        <div className="max-w-4xl mx-auto px-4 sm:px-6 text-center">
          <h2 className="text-4xl md:text-5xl lg:text-6xl font-bold mb-6">
            Contactez-nous
          </h2>
          <p className="text-xl md:text-2xl text-gray-300 mb-16">
            Notre équipe est à votre écoute
          </p>
          
          <div className="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-2xl mx-auto">
            {/* Phone */}
            <div className="bg-white/5 backdrop-blur-sm rounded-2xl p-8 border border-white/10 hover:bg-white/10 transition-all">
              <div className="w-16 h-16 bg-blue-500 rounded-full flex items-center justify-center mx-auto mb-6">
                <Phone className="h-8 w-8 text-white" />
              </div>
              <h3 className="text-xl font-semibold mb-3">Téléphone</h3>
              <a href="tel:+33123456789" className="text-2xl font-bold text-blue-400 hover:text-blue-300 transition-colors">
                +33 1 23 45 67 89
              </a>
              <p className="text-gray-400 text-sm mt-3">Lun-Ven 9h-18h</p>
            </div>

            {/* Email */}
            <div className="bg-white/5 backdrop-blur-sm rounded-2xl p-8 border border-white/10 hover:bg-white/10 transition-all">
              <div className="w-16 h-16 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-6">
                <Mail className="h-8 w-8 text-white" />
              </div>
              <h3 className="text-xl font-semibold mb-3">Email</h3>
              <a href="mailto:contact@skyapp.fr" className="text-2xl font-bold text-green-400 hover:text-green-300 transition-colors">
                contact@skyapp.fr
              </a>
              <p className="text-gray-400 text-sm mt-3">Réponse sous 24h</p>
            </div>
          </div>
        </div>
      </section>

      {/* Login Modal */}
      <LoginModal 
        open={showLoginModal} 
        onClose={() => setShowLoginModal(false)}
      />

      {/* Register Modal */}
      <RegisterModal 
        open={showRegisterModal} 
        onClose={() => setShowRegisterModal(false)}
      />

      {/* User Profile Modal */}
      <UserProfileModal 
        user={user}
        isOpen={showUserProfile}
        onClose={() => setShowUserProfile(false)}
        onUpdate={(updatedUser) => setUser(updatedUser)}
      />

    </div>
  );
};

// Register Modal Component
const RegisterModal = ({ open, onClose }) => {
  const navigate = useNavigate();
  const [formData, setFormData] = useState({
    companyName: '',
    email: '',
    firstName: '',
    lastName: '',
    password: '',
    confirmPassword: ''
  });
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');

  const handleSubmit = async (e) => {
    e.preventDefault();
    setLoading(true);
    setError('');

    if (formData.password !== formData.confirmPassword) {
      setError('Les mots de passe ne correspondent pas');
      setLoading(false);
      return;
    }

    try {
      const response = await axios.post(`${API}/auth/register`, {
        company_name: formData.companyName,
        email: formData.email,
        nom: formData.lastName,
        prenom: formData.firstName,
        password: formData.password
      });

      const { access_token, user } = response.data;
      localStorage.setItem('token', access_token);
      localStorage.setItem('user', JSON.stringify(user));
      
      onClose();
      // Redirection automatique vers la sélection de rôle après inscription
      window.location.href = '/role-selection';
    } catch (err) {
      setError(err.response?.data?.detail || 'Erreur lors de l\'inscription');
    } finally {
      setLoading(false);
    }
  };

  const handleChange = (e) => {
    setFormData(prev => ({
      ...prev,
      [e.target.name]: e.target.value
    }));
  };

  return (
    <Dialog open={open} onOpenChange={onClose}>
      <DialogContent className="sm:max-w-md">
        <DialogHeader>
          <DialogTitle>Inscription</DialogTitle>
          <DialogDescription>
            Créez votre compte SearchApp
          </DialogDescription>
        </DialogHeader>
        <form onSubmit={handleSubmit} className="space-y-4">
          <div className="grid grid-cols-2 gap-4">
            <Input
              name="firstName"
              placeholder="Prénom"
              value={formData.firstName}
              onChange={handleChange}
              required
            />
            <Input
              name="lastName"
              placeholder="Nom"
              value={formData.lastName}
              onChange={handleChange}
              required
            />
          </div>
          
          <Input
            name="email"
            type="email"
            placeholder="Adresse email"
            value={formData.email}
            onChange={handleChange}
            required
          />

          <Input
            name="companyName"
            placeholder="Nom de l'entreprise"
            value={formData.companyName}
            onChange={handleChange}
            required
          />

          <Input
            name="password"
            type="password"
            placeholder="Mot de passe"
            value={formData.password}
            onChange={handleChange}
            required
            minLength={6}
          />

          <Input
            name="confirmPassword"
            type="password"
            placeholder="Confirmer le mot de passe"
            value={formData.confirmPassword}
            onChange={handleChange}
            required
          />

          {error && (
            <div className="text-red-500 text-sm">{error}</div>
          )}

          <Button type="submit" disabled={loading} className="w-full">
            {loading ? 'Création du compte...' : 'Créer mon compte'}
          </Button>
        </form>
      </DialogContent>
    </Dialog>
  );
};

// Apple-style Role Selection with Back Button
const RoleSelection = () => {
  const navigate = useNavigate();
  const [user, setUser] = useState(null);
  const [invitations, setInvitations] = useState([]);
  const [loadingInvites, setLoadingInvites] = useState(false);
  const [actionLoading, setActionLoading] = useState(false);
  const founderEmail = FOUNDER_EMAIL;
  const isFounder = (user?.is_fondateur === true) || ((user?.email || '').toLowerCase() === founderEmail);
  const isAdmin = isFounder || (user?.role === 'ADMIN');

  useEffect(() => {
    const userData = localStorage.getItem('user');
    if (userData) {
      const parsed = JSON.parse(userData);
      setUser(parsed);
      // Load received invitations for this user
      loadInvitations();
    }
  }, []);

  const loadInvitations = async () => {
    try {
      setLoadingInvites(true);
      const token = localStorage.getItem('token');
      if (!token) return;
      const res = await axios.get(`${API}/invitations/received`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      setInvitations(res.data || []);
    } catch (e) {
      // Si le token est expiré (401), ne pas logger l'erreur (c'est normal)
      if (e?.response?.status === 401) {
        setInvitations([]);
        return;
      }
      console.warn('Impossible de charger les invitations reçues:', e?.response?.data || e.message);
      setInvitations([]);
    } finally {
      setLoadingInvites(false);
    }
  };

  const acceptInvitation = async (invitationToken) => {
    try {
      setActionLoading(true);
      const token = localStorage.getItem('token');
      const res = await axios.post(`${API}/invitations/accept/${invitationToken}`, {}, {
        headers: { Authorization: `Bearer ${token}` }
      });
      
      // Recharger les données utilisateur depuis le backend
      const userRes = await axios.get(`${API}/auth/me`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      
      if (userRes.data) {
        localStorage.setItem('user', JSON.stringify(userRes.data));
        setUser(userRes.data);
      }
      
      await loadInvitations();
      alert('Invitation acceptée avec succès ! Vous êtes maintenant membre de cette entreprise.');
    } catch (e) {
      alert(`Erreur lors de l'acceptation: ${e?.response?.data?.detail || e.message}`);
    } finally {
      setActionLoading(false);
    }
  };

  const declineInvitation = async (invitationId) => {
    // Simplement masquer l'invitation localement (pas d'endpoint backend pour refuser)
    if (!window.confirm("Êtes-vous sûr de vouloir refuser cette invitation ?")) {
      return;
    }
    setInvitations(prev => prev.filter(inv => inv.id !== invitationId));
  };

  const leaveCompany = async () => {
    if (!confirm("Voulez-vous vraiment quitter votre entreprise ?")) return;
    try {
      setActionLoading(true);
      const token = localStorage.getItem('token');
      const res = await axios.post(`${API}/auth/leave-company`, {}, {
        headers: { Authorization: `Bearer ${token}` }
      });
      if (res.data?.user) {
        localStorage.setItem('user', JSON.stringify(res.data.user));
        setUser(res.data.user);
      }
    } catch (e) {
      alert(`Erreur lors de la sortie: ${e?.response?.data?.detail || e.message}`);
    } finally {
      setActionLoading(false);
    }
  };

  const handleRoleSelect = (role) => {
    switch(role) {
      case 'technicien':
        navigate('/technicien');
        break;
      case 'bureau':
        navigate('/bureau');
        break;
      case 'statistiques':
        navigate('/statistiques');
        break;
      case 'fondateur':
        navigate('/fondateur');
        break;
      case 'admin':
        navigate('/admin');
        break;
      default:
        navigate('/');
    }
  };

  const handleLogout = () => {
    localStorage.removeItem('token');
    localStorage.removeItem('user');
    navigate('/');
  };

  const goBack = () => {
    navigate('/');
  };

  const goToStatistics = () => {
    navigate('/statistiques');
  };

  return (
    <div className="min-h-screen bg-gray-50 flex flex-col">
      {/* Apple-style Navigation with Back Button */}
      <nav className="bg-white border-b border-gray-200">
        <div className="max-w-7xl mx-auto px-6">
          <div className="flex justify-between items-center h-16">
            <div className="flex items-center">
              <button
                onClick={goBack}
                className="mr-2 sm:mr-4 p-1.5 sm:p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg transition-colors duration-200"
              >
                <ArrowLeft className="h-4 w-4 sm:h-5 sm:w-5" />
              </button>
              <img 
                src="/logo.png" 
                alt="SkyApp Logo" 
                className="w-28 h-28 sm:w-28 sm:h-28 md:w-24 md:h-24 lg:w-28 lg:h-28 rounded-lg object-cover logo-neon-effect"
              />
            </div>
            
            <div className="flex items-center space-x-4">
              <Button
                onClick={goToStatistics}
                variant="outline"
                className="text-gray-900 border-gray-300 hover:bg-gray-50"
              >
                Statistiques
              </Button>
              <Button
                onClick={handleLogout}
                variant="ghost"
                className="text-gray-500 hover:text-gray-700 p-2"
              >
                <LogOut className="h-4 w-4" />
              </Button>
            </div>
          </div>
        </div>
      </nav>

      {/* Main Content */}
      <div className="flex-1 flex items-center justify-center px-6 py-16">
        <div className="w-full max-w-md space-y-8">
          {/* Header */}
          <div className="text-center">
            <h1 className="text-3xl font-bold text-gray-900 mb-2">
              Choisissez votre interface
            </h1>
            <p className="text-lg text-gray-600">Sélectionnez l'interface adaptée à votre rôle</p>
          </div>

          {/* Role Cards */}
          <div className="space-y-4">
            {/* Badge Fondateur */}
            {user?.is_fondateur && (
              <div className="mb-6 p-4 bg-gradient-to-r from-gray-900 to-black border-2 border-gray-800 rounded-2xl shadow-lg">
                <div className="flex items-center space-x-3">
                  <div className="w-10 h-10 bg-white rounded-xl flex items-center justify-center border-2 border-gray-300">
                    <Shield className="h-6 w-6 text-black" />
                  </div>
                  <div>
                    <h4 className="font-bold text-white flex items-center gap-2">
                      FONDATEUR SKYAPP
                      <span className="px-2 py-0.5 text-xs bg-white text-black rounded-full font-bold">Privilèges Maximum</span>
                    </h4>
                    <p className="text-sm text-gray-300">Accès complet à tout le système multi-tenant</p>
                  </div>
                </div>
              </div>
            )}

            {/* Badge Accès Admin */}
            {isAdmin && !user?.is_fondateur && (
              <div className="mb-6 p-4 bg-gradient-to-r from-gray-50 to-gray-100 border border-gray-300 rounded-2xl">
                <div className="flex items-center space-x-3">
                  <div className="w-10 h-10 bg-gray-900 rounded-xl flex items-center justify-center">
                    <Shield className="h-6 w-6 text-white" />
                  </div>
                  <div>
                    <h4 className="font-semibold text-gray-900">Accès Admin</h4>
                    <p className="text-sm text-gray-600">Tous les privilèges administrateur disponibles</p>
                  </div>
                </div>
              </div>
            )}

            {/* Badge Accès Bureau */}
            {user?.role === 'BUREAU' && !isAdmin && (
              <div className="mb-6 p-4 bg-gradient-to-r from-blue-50 to-blue-100 border border-blue-300 rounded-2xl">
                <div className="flex items-center space-x-3">
                  <div className="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center">
                    <Briefcase className="h-6 w-6 text-white" />
                  </div>
                  <div>
                    <h4 className="font-semibold text-blue-900">Accès Bureau</h4>
                    <p className="text-sm text-blue-700">Gestion administrative et planning</p>
                  </div>
                </div>
              </div>
            )}

            {/* Invitations Section: visible on role selection like other menus */}
            <div className="bg-white border border-gray-200 rounded-2xl p-6">
              <div className="flex items-center justify-between mb-4">
                <div className="flex items-center space-x-3">
                  <div className="w-10 h-10 bg-purple-100 rounded-xl flex items-center justify-center">
                    <Mail className="h-5 w-5 text-purple-700" />
                  </div>
                  <div>
                    <h3 className="text-lg font-semibold text-gray-900">Invitations</h3>
                    <p className="text-sm text-gray-600">Rejoignez une entreprise en tant que technicien</p>
                  </div>
                </div>
                <button onClick={loadInvitations} className="text-sm text-gray-500 hover:text-gray-700">Rafraîchir</button>
              </div>
              {loadingInvites ? (
                <div className="text-sm text-gray-500">Chargement des invitations…</div>
              ) : invitations.length === 0 ? (
                <div className="text-sm text-gray-500">Aucune invitation en attente</div>
              ) : (
                <div className="space-y-3">
                  {invitations.map((inv) => (
                    <div key={inv.id} className="border border-gray-200 rounded-xl p-4 flex items-center justify-between">
                      <div>
                        <div className="font-medium text-gray-900">
                          {inv.companies?.name || 'Entreprise'}
                        </div>
                        <div className="text-sm text-gray-600">
                          Rôle proposé: <span className="font-medium">
                            {inv.role === 'TECHNICIEN' ? 'Technicien / User' : inv.role === 'BUREAU' ? 'Bureau' : inv.role === 'ADMIN' ? 'Admin' : inv.role}
                          </span>
                        </div>
                        <div className="text-xs text-gray-500 mt-1">
                          Envoyé le {new Date(inv.created_at).toLocaleDateString('fr-FR')}
                        </div>
                        {inv.expires_at && (
                          <div className="text-xs text-gray-400 mt-1">
                            Expire le {new Date(inv.expires_at).toLocaleDateString('fr-FR')}
                          </div>
                        )}
                        <div
                          className="text-xs text-gray-500 mt-1 italic truncate max-w-xs"
                          title={(inv.message && inv.message.trim()) ? inv.message : "Vous avez été invité(e) à rejoindre cette entreprise"}
                        >
                          “{(inv.message && inv.message.trim()) ? inv.message : 'Vous avez été invité(e) à rejoindre cette entreprise'}”
                        </div>
                      </div>
                      <div className="flex items-center space-x-2">
                        <Button 
                          disabled={actionLoading} 
                          onClick={() => acceptInvitation(inv.token)} 
                          className="bg-green-600 hover:bg-green-700"
                        >
                          {actionLoading ? <Loader2 className="h-4 w-4 animate-spin" /> : 'Accepter'}
                        </Button>
                        <Button 
                          disabled={actionLoading} 
                          onClick={() => declineInvitation(inv.id)} 
                          variant="outline"
                        >
                          Ignorer
                        </Button>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>

            <button
              onClick={() => handleRoleSelect('technicien')}
              className="w-full bg-white border border-gray-200 rounded-2xl p-6 text-left hover:border-gray-300 hover:shadow-sm transition-all duration-200 group"
            >
              <div className="flex items-center justify-between">
                <div className="flex items-center space-x-4">
                  <div className="w-12 h-12 bg-gray-100 rounded-xl flex items-center justify-center group-hover:bg-gray-200 transition-colors">
                    <Search className="h-6 w-6 text-gray-700" />
                  </div>
                  <div>
                    <h3 className="text-lg font-semibold text-gray-900">Technicien</h3>
                    <p className="text-sm text-gray-600">Interface terrain - Recherches et partage</p>
                  </div>
                </div>
                <ArrowRight className="h-5 w-5 text-gray-400 group-hover:text-gray-600" />
              </div>
            </button>

            {(isAdmin || user?.role === 'BUREAU') && (
              <button
                onClick={() => handleRoleSelect('bureau')}
                className="w-full bg-white border border-gray-200 rounded-2xl p-6 text-left hover:border-gray-300 hover:shadow-sm transition-all duration-200 group"
              >
                <div className="flex items-center justify-between">
                  <div className="flex items-center space-x-4">
                    <div className="w-12 h-12 bg-gray-100 rounded-xl flex items-center justify-center group-hover:bg-gray-200 transition-colors">
                      <Briefcase className="h-6 w-6 text-gray-700" />
                    </div>
                    <div>
                      <h3 className="text-lg font-semibold text-gray-900">Bureau</h3>
                      <p className="text-sm text-gray-600">Interface administrative - Rapports et gestion</p>
                    </div>
                  </div>
                  <ArrowRight className="h-5 w-5 text-gray-400 group-hover:text-gray-600" />
                </div>
              </button>
            )}

            {isAdmin && (
              <button
                onClick={() => handleRoleSelect('statistiques')}
                className="w-full bg-white border border-gray-200 rounded-2xl p-6 text-left hover:border-gray-300 hover:shadow-sm transition-all duration-200 group"
              >
                <div className="flex items-center justify-between">
                  <div className="flex items-center space-x-4">
                    <div className="w-12 h-12 bg-gray-100 rounded-xl flex items-center justify-center group-hover:bg-gray-200 transition-colors">
                      <BarChart3 className="h-6 w-6 text-gray-700" />
                    </div>
                    <div>
                      <h3 className="text-lg font-semibold text-gray-900">Statistiques</h3>
                      <p className="text-sm text-gray-600">Interface analytique - Métriques et analyses</p>
                    </div>
                  </div>
                  <ArrowRight className="h-5 w-5 text-gray-400 group-hover:text-gray-600" />
                </div>
              </button>
            )}

            {/* Allow any user to leave company at any time */}
            {user && user.company_id && (
              <div className="pt-2">
                <Button disabled={actionLoading} onClick={leaveCompany} variant="ghost" className="text-red-600 hover:text-red-700">Quitter mon entreprise</Button>
              </div>
            )}

            {/* Admin Panel réservé au Fondateur */}
            {isFounder && (
              <button
                onClick={() => {
                  navigate('/admin');
                }}
                className="w-full bg-gradient-to-r from-gray-800 to-gray-900 border-0 rounded-2xl p-6 text-left hover:from-gray-700 hover:to-gray-800 transition-all duration-200 group shadow-lg"
              >
                <div className="flex items-center justify-between">
                  <div className="flex items-center space-x-4">
                    <div className="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                      <Shield className="h-6 w-6 text-white" />
                    </div>
                    <div>
                      <h3 className="text-lg font-semibold text-white">Administration Fondateur</h3>
                      <p className="text-sm text-gray-300">Gestion globale du système et des utilisateurs</p>
                    </div>
                  </div>
                  <ArrowRight className="h-5 w-5 text-gray-400 group-hover:text-white" />
                </div>
              </button>
            )}
          </div>
        </div>
      </div>
    </div>
  );
};

// Menu de sélection du type de recherche
const SearchTypeSelector = ({ onSelect, onCancel }) => {
  const [pendingReportsCount, setPendingReportsCount] = useState(0);

  useEffect(() => {
    const fetchPendingReports = async () => {
      try {
        const token = localStorage.getItem('token');
        // Récupérer les missions sans rapport
        const response = await axios.get(`${API}/planning/my-missions`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        const missions = response.data || [];
        
        // Récupérer tous les rapports existants
        const reportsResponse = await axios.get(`${API}/searches`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        const reports = reportsResponse.data?.data || reportsResponse.data || [];
        
        // Compter les missions sans rapport (type 'rapport')
        const missionReports = reports.filter(r => r.type === 'rapport' || r.search_type === 'rapport');
        const missionsWithReports = new Set(missionReports.map(r => r.mission_id || r.worksite_id));
        const missionsWithoutReports = missions.filter(m => !missionsWithReports.has(m.id));
        
        setPendingReportsCount(missionsWithoutReports.length);
      } catch (error) {
        console.error('Erreur chargement compteur rapports:', error);
        setPendingReportsCount(0);
      }
    };
    
    fetchPendingReports();
  }, []);

  const searchTypes = [
    {
      id: 'rapport',
      title: 'Compte-Rendu Chantier',
      description: 'Créer un rapport d\'intervention pour une mission planifiée',
      icon: ClipboardList,
      gradient: 'from-green-500 to-green-600',
      badge: pendingReportsCount.toString()
    },
    {
      id: 'infiltration',
      title: "Recherche d'Infiltration",
      description: 'Test et détection des infiltrations d\'eau',
      icon: Layers,
      gradient: 'from-orange-500 to-orange-600',
      badge: '0'
    }
  ];

  return (
    <div className="max-w-4xl mx-auto p-6">
      <Card className="bg-white rounded-2xl border-0 shadow-lg">
        <CardHeader className="pb-6 text-center">
          <div className="w-16 h-16 bg-gradient-to-br from-gray-900 to-gray-700 rounded-xl flex items-center justify-center mx-auto mb-4">
            <Search className="h-8 w-8 text-white" />
          </div>
          <CardTitle className="text-2xl font-semibold text-gray-900">
            Choisir le type d'action
          </CardTitle>
          <CardDescription className="text-gray-600 mt-2">
            Sélectionnez l'action que vous souhaitez effectuer
          </CardDescription>
        </CardHeader>

        <CardContent className="space-y-4 pb-8">
          {/* Options de recherche */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            {searchTypes.map((type) => (
              <button
                key={type.id}
                onClick={() => onSelect(type.id)}
                className="group relative bg-white border-2 border-gray-200 hover:border-gray-900 rounded-2xl p-6 text-left transition-all duration-200 hover:shadow-xl"
              >
                {/* Badge compteur */}
                <div className="absolute -top-2 -right-2 bg-orange-500 text-white text-xs font-bold rounded-full w-8 h-8 flex items-center justify-center shadow-lg">
                  {type.badge}
                </div>

                {/* Icône */}
                <div className={`w-14 h-14 bg-gradient-to-br ${type.gradient} rounded-xl flex items-center justify-center mb-4 group-hover:scale-110 transition-transform duration-200`}>
                  <type.icon className="h-7 w-7 text-white" />
                </div>

                {/* Contenu */}
                <h3 className="text-lg font-bold text-gray-900 mb-2 group-hover:text-gray-900">
                  {type.title}
                </h3>
                <p className="text-sm text-gray-600 group-hover:text-gray-700">
                  {type.description}
                </p>

                {/* Flèche */}
                <div className="mt-4 flex items-center text-gray-400 group-hover:text-gray-900 transition-colors">
                  <span className="text-sm font-medium">Continuer</span>
                  <ArrowRight className="h-4 w-4 ml-2 group-hover:translate-x-1 transition-transform" />
                </div>
              </button>
            ))}
          </div>

          {/* Bouton Annuler */}
          <div className="pt-4 flex justify-center">
            <Button
              onClick={onCancel}
              variant="ghost"
              className="text-gray-500 hover:text-gray-700"
            >
              <X className="h-4 w-4 mr-2" />
              Annuler
            </Button>
          </div>
        </CardContent>
      </Card>
    </div>
  );
};

// Composant de sélection de mission pour compte-rendu
const MissionSelector = ({ onSelect, onCancel, token }) => {
  const [missions, setMissions] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  useEffect(() => {
    const fetchMissions = async () => {
      try {
        setLoading(true);
        // Récupérer les missions planifiées pour l'utilisateur
        const response = await axios.get(`${API}/planning/my-missions`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        
        // Regrouper les missions par titre et location pour éviter les doublons (missions multi-jours)
        const missionsData = response.data || [];
        const uniqueMissions = {};
        
        missionsData.forEach(mission => {
          // Nettoyer le titre : retirer "RDV - Client" et autres préfixes
          let cleanTitle = mission.title || '';
          cleanTitle = cleanTitle.replace(/^RDV\s*-\s*Client\s*/i, '').trim();
          
          // Si le titre est vide ou générique, construire un titre pertinent
          if (!cleanTitle || cleanTitle === 'Mission sans titre') {
            // Utiliser description en priorité, sinon intervention_category, sinon "Chantier chez client"
            if (mission.description) {
              cleanTitle = mission.description;
            } else if (mission.intervention_category) {
              cleanTitle = mission.intervention_category.charAt(0).toUpperCase() + mission.intervention_category.slice(1);
              if (mission.client_name) {
                cleanTitle += ` - ${mission.client_name}`;
              }
            } else if (mission.client_name) {
              cleanTitle = `Chantier chez ${mission.client_name}`;
            } else {
              cleanTitle = 'Chantier';
            }
          }
          
          // Créer une clé unique basée sur le titre nettoyé et la location
          const key = `${cleanTitle}_${mission.location}`;
          
          // Garder uniquement la première occurrence de chaque mission
          if (!uniqueMissions[key]) {
            uniqueMissions[key] = {
              ...mission,
              title: cleanTitle
            };
          }
        });
        
        setMissions(Object.values(uniqueMissions));
      } catch (err) {
        console.error('Erreur chargement missions:', err);
        setError('Impossible de charger les missions');
      } finally {
        setLoading(false);
      }
    };
    
    fetchMissions();
  }, [token]);

  return (
    <div className="max-w-5xl mx-auto p-6">
      <Card className="bg-white rounded-2xl border-0 shadow-lg">
        <CardHeader className="pb-6 text-center">
          <div className="w-16 h-16 bg-gradient-to-br from-green-500 to-green-600 rounded-xl flex items-center justify-center mx-auto mb-4">
            <Calendar className="h-8 w-8 text-white" />
          </div>
          <CardTitle className="text-2xl font-semibold text-gray-900">
            Sélectionner un chantier
          </CardTitle>
          <CardDescription className="text-gray-600 mt-2">
            Choisissez le chantier pour lequel créer un compte-rendu
          </CardDescription>
        </CardHeader>

        <CardContent className="space-y-4 pb-8">
          {loading ? (
            <div className="flex justify-center py-12">
              <Loader2 className="h-8 w-8 animate-spin text-green-500" />
            </div>
          ) : error ? (
            <div className="text-center py-12">
              <AlertCircle className="h-12 w-12 text-red-500 mx-auto mb-4" />
              <p className="text-red-600">{error}</p>
            </div>
          ) : missions.length === 0 ? (
            <div className="text-center py-12">
              <Calendar className="h-12 w-12 text-gray-400 mx-auto mb-4" />
              <p className="text-gray-600 mb-2">Aucune mission planifiée</p>
              <p className="text-sm text-gray-500">Les missions planifiées apparaîtront ici</p>
            </div>
          ) : (
            <div className="space-y-3 max-h-96 overflow-y-auto">
              {missions.map((mission) => (
                <button
                  key={mission.id}
                  onClick={() => onSelect(mission)}
                  className="w-full bg-white border-2 border-gray-200 hover:border-green-500 rounded-xl p-4 text-left transition-all duration-200 hover:shadow-lg group"
                >
                  <div className="flex items-start justify-between">
                    <div className="flex-1">
                      <div className="flex items-center space-x-3 mb-2">
                        <div className="w-10 h-10 bg-gradient-to-br from-green-500 to-green-600 rounded-lg flex items-center justify-center">
                          <MapPin className="h-5 w-5 text-white" />
                        </div>
                        <div>
                          <h3 className="text-lg font-bold text-gray-900 group-hover:text-green-600">
                            {mission.title || 'Mission sans titre'}
                          </h3>
                          <p className="text-sm text-gray-500">{mission.location || 'Localisation non spécifiée'}</p>
                        </div>
                      </div>
                      
                      {mission.description && (
                        <p className="text-sm text-gray-600 ml-13 mb-2">{mission.description}</p>
                      )}
                      
                      <div className="flex items-center space-x-4 ml-13 text-xs text-gray-500">
                        {mission.date && (
                          <span className="flex items-center">
                            <Calendar className="h-3 w-3 mr-1" />
                            {new Date(mission.date).toLocaleDateString('fr-FR')}
                          </span>
                        )}
                        {mission.client_name && (
                          <span className="flex items-center">
                            <User className="h-3 w-3 mr-1" />
                            {mission.client_name}
                          </span>
                        )}
                      </div>
                    </div>
                    
                    <ArrowRight className="h-5 w-5 text-gray-400 group-hover:text-green-600 group-hover:translate-x-1 transition-all ml-4 mt-1" />
                  </div>
                </button>
              ))}
            </div>
          )}

          {/* Bouton Annuler */}
          <div className="pt-4 flex justify-center">
            <Button
              onClick={onCancel}
              variant="ghost"
              className="text-gray-500 hover:text-gray-700"
            >
              <X className="h-4 w-4 mr-2" />
              Annuler
            </Button>
          </div>
        </CardContent>
      </Card>
    </div>
  );
};

// Apple-style Main Layout for Technicien with Back Button
const TechnicienLayout = () => {
  const navigate = useNavigate();
  const { user, token } = useAuth();
  const [activeTab, setActiveTab] = useState('search');
  const [showSearchTypeSelector, setShowSearchTypeSelector] = useState(false);
  const [showMissionSelector, setShowMissionSelector] = useState(false);
  const [selectedSearchType, setSelectedSearchType] = useState(null);
  const [selectedMission, setSelectedMission] = useState(null);
  const searchFormRef = useRef(null);
  const [drafts, setDrafts] = useState([]);
  const [draftsLoading, setDraftsLoading] = useState(false);
  const [draftError, setDraftError] = useState(null);
  const [showDraftModal, setShowDraftModal] = useState(false);
  const [discardingDraftId, setDiscardingDraftId] = useState(null);
  const [isTabTransitioning, setIsTabTransitioning] = useState(false);
  const [mobileNavOpen, setMobileNavOpen] = useState(false);
  const [searchToEdit, setSearchToEdit] = useState(null);
  // Set partagé pour tracker les recherches récemment finalisées
  const recentlyFinalizedRef = useRef(new Set());

  const handleLogout = () => {
    localStorage.removeItem('token');
    localStorage.removeItem('user');
    window.location.href = '/';
  };

  const goBack = () => {
    navigate('/role-selection');
  };

  const refreshDrafts = useCallback(async ({ silent = false } = {}) => {
    const authToken = token || localStorage.getItem('token');
    if (!authToken) {
      setDrafts([]);
      if (!silent) {
        setDraftsLoading(false);
      }
      return;
    }
    if (!silent) {
      setDraftsLoading(true);
    }
    try {
      setDraftError(null);
      const response = await axios.get(`${API}/searches`, {
        params: { status: 'DRAFT', page: 1, page_size: 50, sort_by: 'updated_at', sort_dir: 'desc' },
        headers: { Authorization: `Bearer ${authToken}` }
      });
      // Format standardisé : { data: [...] } ou { data: [...], page: ..., has_more: ... }
      // Filtre de sécurité : ne jamais afficher les recherches ACTIVE/SHARED dans les brouillons
      const allSearches = response.data.data || [];
      if (DEBUG_MODE) console.log('📊 [Brouillons] Recherches reçues du backend:', allSearches.map(s => ({ location: s.location, status: s.status })));
      
      // Double filtrage : 
      // 1. Status doit être DRAFT
      // 2. Ne doit PAS être dans la liste des recherches récemment finalisées
      if (DEBUG_MODE) console.log('🔍 [Brouillons] Set de finalisées:', Array.from(recentlyFinalizedRef.current));
      const draftsOnly = allSearches.filter(search => {
        const isDraft = search.status === 'DRAFT';
        const isInFinalizedSet = recentlyFinalizedRef.current.has(search.id);
        const notRecentlyFinalized = !isInFinalizedSet;
        
        if (DEBUG_MODE) {
          console.log(`🔎 [Brouillons] Recherche ${search.id}:`, { 
            status: search.status, 
            isDraft, 
            isInFinalizedSet,
            willBeIncluded: isDraft && notRecentlyFinalized 
          });
          
          if (isDraft && !notRecentlyFinalized) {
            console.log('🚫 [Brouillons] Exclusion de', search.id, '(récemment finalisée)');
          }
        }
        return isDraft && notRecentlyFinalized;
      });
      
      if (DEBUG_MODE) console.log('✅ [Brouillons] Après filtrage DRAFT uniquement:', draftsOnly.length, 'brouillons');
      setDrafts(draftsOnly);
    } catch (error) {
      console.error('Erreur lors du chargement des brouillons:', error);
      setDraftError('Impossible de charger les brouillons.');
    } finally {
      if (!silent) {
        setDraftsLoading(false);
      }
    }
  }, [token]);

  useEffect(() => {
    refreshDrafts({ silent: true });
  }, [refreshDrafts]);

  useEffect(() => {
    if (activeTab === 'search') {
      searchFormRef.current?.ensureDraft?.();
    }
  }, [activeTab]);

  // Écouter l'événement de finalisation pour basculer vers "Mes Recherches"
  useEffect(() => {
    const handleSearchFinalized = (event) => {
      if (DEBUG_MODE) {
        console.log('🔔 [TechnicienLayout] Événement searchFinalized reçu!', event.detail);
        console.log('🔄 Bascule vers l\'onglet "Mes Recherches"...');
      }
      setActiveTab('history');
    };
    
    if (DEBUG_MODE) console.log('✅ [TechnicienLayout] Écouteur d\'événement searchFinalized installé');
    window.addEventListener('searchFinalized', handleSearchFinalized);
    return () => {
      if (DEBUG_MODE) console.log('❌ [TechnicienLayout] Écouteur d\'événement searchFinalized retiré');
      window.removeEventListener('searchFinalized', handleSearchFinalized);
    };
  }, []);

  const handleDraftEvent = useCallback((event) => {
    if (!event) return;
    
    if (event.type === 'finalized') {
      // Retirer immédiatement la recherche finalisée de la liste des brouillons
      setDrafts(prevDrafts => prevDrafts.filter(draft => draft.id !== event.draftId));
      if (DEBUG_MODE) console.log(`🗑️ Brouillon ${event.draftId} retiré de la liste après finalisation`);
      return;
    }
    
    const impactfulTypes = new Set(['created', 'saved', 'discarded']);
    if (impactfulTypes.has(event.type)) {
      refreshDrafts({ silent: true });
    }
  }, [refreshDrafts]);

  const openDraftModal = useCallback(async () => {
    // Rafraîchir la liste avant d'ouvrir pour avoir les dernières données
    if (DEBUG_MODE) console.log('🔄 [openDraftModal] Rafraîchissement des brouillons avant ouverture...');
    await refreshDrafts();
    // Petit délai pour laisser le state se mettre à jour
    setTimeout(() => {
      if (DEBUG_MODE) console.log('✅ [openDraftModal] Ouverture de la modal avec données à jour');
      setShowDraftModal(true);
    }, 300);
  }, [refreshDrafts]);

  const closeDraftModal = useCallback(() => {
    setShowDraftModal(false);
    setDraftError(null);
    setDiscardingDraftId(null);
  }, []);

  useEffect(() => {
    if (showDraftModal) {
      setDraftError(null);
      refreshDrafts();
    }
  }, [showDraftModal, refreshDrafts]);

  const resumeDraft = useCallback(async (draft) => {
    if (!draft) {
      if (DEBUG_MODE) console.log('❌ [resumeDraft] Pas de brouillon fourni');
      return;
    }
    
    if (DEBUG_MODE) console.log('🔄 [resumeDraft] Reprise du brouillon:', draft.id);
    setShowDraftModal(false);
    
    // Restaurer le type de recherche AVANT de basculer vers l'onglet search
    // Mapper l'ancien type 'terrain' vers 'infiltration' car 'rapport' nécessite une mission
    let searchType = draft.search_type?.toLowerCase() || 'infiltration';
    if (searchType === 'terrain') {
      searchType = 'infiltration'; // Migration: anciens brouillons terrain deviennent infiltration
    }
    if (DEBUG_MODE) console.log('📋 [resumeDraft] Type de recherche:', searchType);
    
    // Récupération fraîche du draft depuis l'API pour éviter les données périmées
    try {
      const authToken = token || localStorage.getItem('token');
      if (DEBUG_MODE) console.log('🌐 [resumeDraft] Chargement depuis l\'API...');
      const resp = await axios.get(`${API}/searches/${draft.id}`, {
        headers: { Authorization: `Bearer ${authToken}` }
      });
      if (DEBUG_MODE) console.log('✅ [resumeDraft] Brouillon chargé depuis l\'API:', resp.data);
      
      // Mettre à jour le type de recherche depuis la réponse API si disponible
      if (resp.data?.search_type) {
        searchType = resp.data.search_type.toLowerCase();
        // Mapper l'ancien type 'terrain' vers 'infiltration'
        if (searchType === 'terrain') {
          searchType = 'infiltration';
        }
      }
      
      // Définir le type AVANT de basculer vers l'onglet
      setSelectedSearchType(searchType);
      
      // Petit délai pour laisser React monter le formulaire
      setTimeout(() => {
        setActiveTab('search');
        // Attendre que le formulaire soit monté avant de charger les données
        setTimeout(() => {
          if (DEBUG_MODE) console.log('📤 [resumeDraft] Chargement des données dans le formulaire...');
          searchFormRef.current?.loadDraft?.(resp.data || draft);
        }, 100);
      }, 50);
      
    } catch (e) {
      console.error('❌ [resumeDraft] Erreur chargement API:', e);
      // En cas d'erreur réseau, on retombe sur la version passée en paramètre
      setSelectedSearchType(searchType);
      setTimeout(() => {
        setActiveTab('search');
        setTimeout(() => {
          searchFormRef.current?.loadDraft?.(draft);
        }, 100);
      }, 50);
    }
  }, [token]);

  const discardDraft = useCallback(async (draftId) => {
    if (!draftId) {
      return;
    }
    const authToken = token || localStorage.getItem('token');
    if (!authToken) {
      setDraftError('Authentification requise pour supprimer un brouillon.');
      return;
    }

    setDiscardingDraftId(draftId);
    try {
      setDraftError(null);
      // Suppression définitive si brouillon (DELETE) sinon fallback archivage côté backend
      await axios.delete(`${API}/searches/${draftId}`, {
        headers: { Authorization: `Bearer ${authToken}` }
      });
      await refreshDrafts();
    } catch (error) {
      console.error('Erreur suppression brouillon:', error);
      setDraftError('Impossible de supprimer le brouillon pour le moment.');
    } finally {
      setDiscardingDraftId(null);
    }
  }, [refreshDrafts, token]);

  const handleTabChange = useCallback((value) => {
    if (value === activeTab || isTabTransitioning) {
      return;
    }
    const applyChange = () => {
      setActiveTab(value);
      // Reset search type when leaving search tab
      if (activeTab === 'search' && value !== 'search') {
        setSelectedSearchType(null);
      }
      if (value === 'search') {
        refreshDrafts({ silent: true });
      }
    };

    if (activeTab === 'search' && searchFormRef.current?.forceAutoSave) {
      setIsTabTransitioning(true);
      Promise.resolve(searchFormRef.current.forceAutoSave())
        .catch((err) => {
          console.error('Erreur sauvegarde brouillon avant changement d\'onglet:', err);
        })
        .finally(() => {
          setIsTabTransitioning(false);
          applyChange();
          if (value !== 'search') {
            refreshDrafts({ silent: true });
          }
        });
    } else {
      applyChange();
      if (value !== 'search') {
        refreshDrafts({ silent: true });
      }
    }
  }, [activeTab, isTabTransitioning, refreshDrafts]);

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Apple-style Navigation with Back Button */}
      <nav className="bg-white border-b border-gray-200">
        <div className="max-w-7xl mx-auto px-4 sm:px-6">
          <div className="flex justify-between items-center h-14 sm:h-16">
            <div className="flex items-center space-x-2 sm:space-x-0">
              <button
                onClick={goBack}
                className="p-1.5 sm:p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg transition-colors duration-200"
              >
                <ArrowLeft className="h-4 w-4 sm:h-5 sm:w-5" />
              </button>
              <img 
                src="/logo.png" 
                alt="SkyApp Logo" 
                className="w-28 h-28 sm:w-28 sm:h-28 md:w-24 md:h-24 lg:w-28 lg:h-28 rounded-lg object-cover logo-neon-effect"
              />
            </div>
            
            <div className="flex items-center space-x-2 sm:space-x-4">
              <Button
                variant="outline"
                onClick={openDraftModal}
                className="relative flex items-center text-xs sm:text-sm px-2 sm:px-4"
              >
                {draftsLoading ? (
                  <Loader2 className="h-3 w-3 sm:h-4 sm:w-4 mr-1 sm:mr-2 animate-spin" />
                ) : (
                  <Clock className="h-3 w-3 sm:h-4 sm:w-4 mr-1 sm:mr-2" />
                )}
                <span className="hidden sm:inline">Brouillon en attente</span>
                <span className="sm:hidden">Brouillon</span>
                {drafts.length > 0 && (
                  <Badge
                    variant="destructive"
                    className="ml-1 sm:ml-2 px-1.5 sm:px-2 py-0 text-xs font-semibold"
                  >
                    {drafts.length}
                  </Badge>
                )}
              </Button>
              <span className="hidden md:inline text-sm font-medium text-gray-700">Technicien</span>
              <Button
                onClick={handleLogout}
                variant="ghost"
                className="text-gray-500 hover:text-gray-700 p-1.5 sm:p-2 hidden md:flex"
              >
                <LogOut className="h-4 w-4" />
              </Button>
              
              {/* Mobile menu burger */}
              <Button
                onClick={() => setMobileNavOpen(!mobileNavOpen)}
                variant="ghost"
                className="md:hidden text-gray-500 hover:text-gray-700 p-1.5 sm:p-2"
              >
                {mobileNavOpen ? <X className="h-5 w-5" /> : <Menu className="h-5 w-5" />}
              </Button>
            </div>
          </div>
        </div>
      </nav>

      <Dialog open={showDraftModal} onOpenChange={(open) => (open ? setShowDraftModal(true) : closeDraftModal())}>
        <DialogContent className="max-w-[95vw] sm:max-w-lg max-h-[90vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle>Brouillons en attente</DialogTitle>
            <DialogDescription>
              Reprenez vos recherches non finalisées. Les modifications sont sauvegardées automatiquement.
            </DialogDescription>
          </DialogHeader>
          {draftError && (
            <div className="bg-red-50 border border-red-200 text-red-700 px-3 py-2 rounded-xl text-sm">
              {draftError}
            </div>
          )}
          {draftsLoading ? (
            <div className="flex items-center justify-center py-6">
              <Loader2 className="h-6 w-6 animate-spin text-gray-500" />
            </div>
          ) : drafts.length === 0 ? (
            <div className="bg-gray-50 border border-dashed border-gray-200 rounded-xl p-6 text-center text-sm text-gray-600">
              Aucun brouillon détecté pour le moment.
            </div>
          ) : (
            <div className="space-y-3 max-h-72 overflow-y-auto pr-1">
              {drafts.map((draft) => {
                const updatedAt = draft.updated_at || draft.created_at;
                const dateLabel = updatedAt ? new Date(updatedAt).toLocaleString('fr-FR') : 'Date inconnue';
                const locationLabel = draft.location?.trim() ? draft.location : 'Localisation à définir';
                return (
                  <div key={draft.id} className="border border-gray-200 rounded-xl p-4 bg-white shadow-sm">
                    <div className="flex items-start justify-between gap-4">
                      <div className="flex-1">
                        <p className="text-sm font-medium text-gray-900">{locationLabel}</p>
                        <p className="text-xs text-gray-500 mt-1">Dernière sauvegarde&nbsp;: {dateLabel}</p>
                        {draft.description && (
                          <p className="text-xs text-gray-500 mt-2 line-clamp-2">{draft.description}</p>
                        )}
                      </div>
                      <div className="flex flex-col items-end space-y-2">
                        <Button size="sm" onClick={() => resumeDraft(draft)}>
                          Reprendre
                        </Button>
                        <Button
                          size="sm"
                          variant="ghost"
                          className="text-red-600 hover:text-red-700"
                          disabled={discardingDraftId === draft.id}
                          onClick={() => discardDraft(draft.id)}
                        >
                          {discardingDraftId === draft.id ? (
                            <span className="inline-flex items-center">
                              <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                              Suppression…
                            </span>
                          ) : (
                            <span className="inline-flex items-center">
                              <Trash2 className="h-4 w-4 mr-2" />
                              Supprimer
                            </span>
                          )}
                        </Button>
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
          )}
          <div className="flex justify-end">
            <Button variant="ghost" onClick={closeDraftModal}>Fermer</Button>
          </div>
        </DialogContent>
      </Dialog>

      {/* Main Content */}
      <main className="max-w-7xl mx-auto py-8 px-6">
        {showMissionSelector ? (
          <MissionSelector
            token={token}
            onSelect={(mission) => {
              setSelectedMission(mission);
              setShowMissionSelector(false);
              setSelectedSearchType('rapport');
              setActiveTab('search');
            }}
            onCancel={() => {
              setShowMissionSelector(false);
            }}
          />
        ) : showSearchTypeSelector ? (
          <SearchTypeSelector
            onSelect={(type) => {
              if (type === 'rapport') {
                // Pour compte-rendu, afficher d'abord le sélecteur de mission
                setShowSearchTypeSelector(false);
                setShowMissionSelector(true);
              } else {
                setSelectedSearchType(type);
                setShowSearchTypeSelector(false);
                setActiveTab('search');
              }
            }}
            onCancel={() => {
              setShowSearchTypeSelector(false);
            }}
          />
        ) : (
          <Tabs value={activeTab} onValueChange={handleTabChange}>
            {/* Apple-style Tab Navigation - Desktop only */}
            <div className="hidden md:flex justify-center mb-6 sm:mb-8 overflow-x-auto">
              <TabsList className="bg-white border border-gray-200 p-1 rounded-xl shadow-sm min-w-max">
                <TabsTrigger 
                  value="search" 
                  className="flex items-center space-x-1 sm:space-x-2 px-3 sm:px-4 md:px-6 py-2 sm:py-3 rounded-lg data-[state=active]:bg-gray-100 data-[state=active]:shadow-sm transition-all duration-200"
                  disabled={isTabTransitioning}
                >
                  <Search className="h-4 w-4" />
                  <span className="font-medium text-xs sm:text-sm md:text-base">Nouvelle</span>
                  <span className="hidden md:inline font-medium">Recherche</span>
                </TabsTrigger>
              <TabsTrigger 
                value="history" 
                className="flex items-center space-x-1 sm:space-x-2 px-3 sm:px-4 md:px-6 py-2 sm:py-3 rounded-lg data-[state=active]:bg-gray-100 data-[state=active]:shadow-sm transition-all duration-200"
                disabled={isTabTransitioning}
              >
                <History className="h-4 w-4" />
                <span className="font-medium text-xs sm:text-sm md:text-base">Mes</span>
                <span className="hidden md:inline font-medium">Recherches</span>
              </TabsTrigger>
              <TabsTrigger 
                value="planning" 
                className="flex items-center space-x-1 sm:space-x-2 px-3 sm:px-4 md:px-6 py-2 sm:py-3 rounded-lg data-[state=active]:bg-gray-100 data-[state=active]:shadow-sm transition-all duration-200"
                disabled={isTabTransitioning}
              >
                <Calendar className="h-4 w-4" />
                <span className="font-medium text-xs sm:text-sm md:text-base">Missions</span>
              </TabsTrigger>
              <TabsTrigger 
                value="inventory" 
                className="flex items-center space-x-1 sm:space-x-2 px-3 sm:px-4 md:px-6 py-2 sm:py-3 rounded-lg data-[state=active]:bg-gray-100 data-[state=active]:shadow-sm transition-all duration-200"
                disabled={isTabTransitioning}
              >
                <Package className="h-4 w-4" />
                <span className="font-medium text-xs sm:text-sm md:text-base">Inventaire</span>
              </TabsTrigger>
            </TabsList>
          </div>

          {/* Mobile Navigation Menu */}
          <div className={`md:hidden transition-all duration-300 ease-in-out overflow-hidden ${
            mobileNavOpen ? 'max-h-96 opacity-100 mb-6' : 'max-h-0 opacity-0'
          }`}>
            <div className="bg-white border-2 border-black rounded-xl shadow-lg p-2 space-y-2">
              <button
                onClick={() => {
                  handleTabChange('search');
                  setMobileNavOpen(false);
                }}
                className={`w-full flex items-center space-x-3 px-4 py-3 rounded-lg transition-all ${
                  activeTab === 'search'
                    ? 'bg-gray-900 text-white'
                    : 'bg-white text-gray-700 hover:bg-gray-100'
                }`}
              >
                <Search className="h-5 w-5" />
                <span className="font-medium">Nouvelle Recherche</span>
              </button>
              <button
                onClick={() => {
                  handleTabChange('history');
                  setMobileNavOpen(false);
                }}
                className={`w-full flex items-center space-x-3 px-4 py-3 rounded-lg transition-all ${
                  activeTab === 'history'
                    ? 'bg-gray-900 text-white'
                    : 'bg-white text-gray-700 hover:bg-gray-100'
                }`}
              >
                <History className="h-5 w-5" />
                <span className="font-medium">Mes Recherches</span>
              </button>
              <button
                onClick={() => {
                  handleTabChange('planning');
                  setMobileNavOpen(false);
                }}
                className={`w-full flex items-center space-x-3 px-4 py-3 rounded-lg transition-all ${
                  activeTab === 'planning'
                    ? 'bg-gray-900 text-white'
                    : 'bg-white text-gray-700 hover:bg-gray-100'
                }`}
              >
                <Calendar className="h-5 w-5" />
                <span className="font-medium">Missions</span>
              </button>
              <button
                onClick={() => {
                  handleTabChange('inventory');
                  setMobileNavOpen(false);
                }}
                className={`w-full flex items-center space-x-3 px-4 py-3 rounded-lg transition-all ${
                  activeTab === 'inventory'
                    ? 'bg-gray-900 text-white'
                    : 'bg-white text-gray-700 hover:bg-gray-100'
                }`}
              >
                <Package className="h-5 w-5" />
                <span className="font-medium">Inventaire</span>
              </button>
              <button
                onClick={() => {
                  handleLogout();
                  setMobileNavOpen(false);
                }}
                className="w-full flex items-center space-x-3 px-4 py-3 rounded-lg bg-white text-red-600 hover:bg-red-50 transition-all"
              >
                <LogOut className="h-5 w-5" />
                <span className="font-medium">Déconnexion</span>
              </button>
            </div>
          </div>

          <TabsContent value="search" className="mt-4 sm:mt-6 md:mt-8">
            {!selectedSearchType ? (
              <SearchTypeSelector
                onSelect={(type) => {
                  if (type === 'rapport') {
                    setSelectedSearchType('rapport');
                    // Ne pas afficher immédiatement le form, attendre la sélection de mission
                  } else {
                    setSelectedSearchType(type);
                  }
                }}
                onCancel={() => {
                  setActiveTab('history');
                }}
              />
            ) : selectedSearchType === 'rapport' && !selectedMission ? (
              <MissionSelector
                token={token}
                onSelect={(mission) => {
                  setSelectedMission(mission);
                }}
                onCancel={() => {
                  setSelectedSearchType(null);
                  setSelectedMission(null);
                }}
              />
            ) : selectedSearchType === 'rapport' && selectedMission ? (
              <MissionReportForm 
                mission={selectedMission}
                token={token}
                onCancel={() => {
                  setSelectedSearchType(null);
                  setSelectedMission(null);
                }}
                onComplete={() => {
                  setSelectedSearchType(null);
                  setSelectedMission(null);
                  setActiveTab('history');
                }}
              />
            ) : (
              <SearchForm 
                ref={searchFormRef} 
                onDraftEvent={handleDraftEvent} 
                searchType={selectedSearchType}
                initialSearch={searchToEdit}
                onSearchLoaded={() => setSearchToEdit(null)}
                recentlyFinalizedRef={recentlyFinalizedRef}
              />
            )}
          </TabsContent>

          <TabsContent value="history" className="mt-4 sm:mt-6 md:mt-8">
            <SearchHistory 
              onEditSearch={(search) => {
                setSearchToEdit(search);
                setActiveTab('search');
                setSelectedSearchType('terrain');
              }}
            />
          </TabsContent>

          <TabsContent value="planning" className="mt-8">
            <TechnicianPlanning />
          </TabsContent>

          <TabsContent value="inventory" className="mt-4 sm:mt-6 md:mt-8">
            <InventoryScanner />
          </TabsContent>
        </Tabs>
        )}
      </main>
    </div>
  );
};

// Technician Planning Component - Vue Calendrier Hebdomadaire
const TechnicianPlanning = () => {
  const [missions, setMissions] = useState([]);
  const [loading, setLoading] = useState(true);
  const [currentWeekStart, setCurrentWeekStart] = useState(getWeekStart(new Date()));
  const [selectedMission, setSelectedMission] = useState(null);
  const [quoteData, setQuoteData] = useState(null);
  const [loadingQuote, setLoadingQuote] = useState(false);
  const [searchData, setSearchData] = useState(null);
  const [showQuoteModal, setShowQuoteModal] = useState(false);
  const [showSearchModal, setShowSearchModal] = useState(false);

  // Obtenir le début de semaine (lundi)
  function getWeekStart(date) {
    const d = new Date(date);
    const day = d.getDay();
    const diff = d.getDate() - day + (day === 0 ? -6 : 1);
    return new Date(d.setDate(diff));
  }

  // Obtenir les 7 jours de la semaine
  const getWeekDays = () => {
    const days = [];
    for (let i = 0; i < 7; i++) {
      const date = new Date(currentWeekStart);
      date.setDate(currentWeekStart.getDate() + i);
      days.push(date);
    }
    return days;
  };

  // Navigation semaine
  const goToPreviousWeek = () => {
    const newDate = new Date(currentWeekStart);
    newDate.setDate(newDate.getDate() - 7);
    setCurrentWeekStart(newDate);
  };

  const goToNextWeek = () => {
    const newDate = new Date(currentWeekStart);
    newDate.setDate(newDate.getDate() + 7);
    setCurrentWeekStart(newDate);
  };

  const goToToday = () => {
    setCurrentWeekStart(getWeekStart(new Date()));
  };

  // Fetch missions where current user is assigned
  useEffect(() => {
    fetchMissions();
  }, []);

  const fetchMissions = async () => {
    try {
      const token = localStorage.getItem('token');
      if (!token) return;

      // Décoder le token pour obtenir l'ID du technicien
      const payload = JSON.parse(atob(token.split('.')[1]));
      const technicianId = payload.sub;

      const response = await axios.get(`${API}/technicians/${technicianId}/missions`, {
        headers: { Authorization: `Bearer ${token}` }
      });

      if (response.status === 200) {
        setMissions(response.data);
      }
    } catch (error) {
      console.error('Erreur lors du chargement des missions:', error);
    } finally {
      setLoading(false);
    }
  };

  const getStatusColor = (status) => {
    switch (status) {
      case 'scheduled': return 'bg-blue-100 text-blue-700 border-blue-300';
      case 'in_progress': return 'bg-orange-100 text-orange-700 border-orange-300';
      case 'completed': return 'bg-green-100 text-green-700 border-green-300';
      case 'cancelled': return 'bg-red-100 text-red-700 border-red-300';
      default: return 'bg-gray-100 text-gray-700 border-gray-300';
    }
  };

  const getStatusLabel = (status) => {
    switch (status) {
      case 'scheduled': return 'Planifiée';
      case 'in_progress': return 'En cours';
      case 'completed': return 'Terminée';
      case 'cancelled': return 'Annulée';
      default: return status;
    }
  };

  const formatTime = (timeString) => {
    return timeString ? timeString.substring(0, 5) : '';
  };

  // Obtenir toutes les missions de la semaine groupées par chantier
  const getWeekMissionsGrouped = () => {
    const grouped = [];
    const processed = new Set();
    const weekStart = getWeekStart(currentWeekStart);
    weekStart.setHours(0, 0, 0, 0);
    const weekEnd = new Date(weekStart);
    weekEnd.setDate(weekEnd.getDate() + 6);
    weekEnd.setHours(23, 59, 59, 999);

    missions.forEach(mission => {
      if (processed.has(mission.id)) return;
      
      // Debug: voir la structure des données
      console.log('📋 Mission data:', {
        id: mission.id,
        worksites: mission.worksites,
        clients: mission.worksites?.clients
      });

      processed.add(mission.id);

      // Utiliser start_date et end_date pour les missions avec périodes
      const startDate = new Date(mission.start_date || mission.date);
      startDate.setHours(0, 0, 0, 0);
      const endDate = new Date(mission.end_date || mission.date || mission.start_date);
      endDate.setHours(0, 0, 0, 0);

      // Vérifier si la mission chevauche la semaine affichée
      if (endDate < weekStart || startDate > weekEnd) {
        return;
      }

      // Ajuster les dates pour qu'elles restent dans la semaine visible
      const displayStart = startDate < weekStart ? weekStart : startDate;
      const displayEnd = endDate > weekEnd ? weekEnd : endDate;

      // Calculer la position dans la grille (1-7)
      const daysDiff = Math.round((displayStart.getTime() - weekStart.getTime()) / (1000 * 60 * 60 * 24));
      const columnStart = daysDiff + 1;

      // Calculer le nombre de jours à afficher (inclusif)
      const daysSpan = Math.round((displayEnd.getTime() - displayStart.getTime()) / (1000 * 60 * 60 * 24)) + 1;

      grouped.push({
        ...mission,
        isMultiDay: daysSpan > 1,
        dayCount: daysSpan,
        columnStart: Math.max(1, Math.min(columnStart, 7)),
        columnSpan: Math.max(1, Math.min(daysSpan, 8 - columnStart)),
        startDate: mission.start_date || mission.date,
        endDate: mission.end_date || mission.date || mission.start_date
      });
    });

    return grouped;
  };

  const fetchQuoteForMission = async (mission) => {
    setLoadingQuote(true);
    setSelectedMission(mission);
    setQuoteData(null);
    setSearchData(null);
    
    try {
      const token = localStorage.getItem('token');
      const worksiteId = mission.worksite_id || mission.worksites?.id;
      
      console.log('🔍 Récupération des données pour worksite:', worksiteId);
      
      // Récupérer le chantier pour avoir le quote_id et project_id
      const worksiteRes = await axios.get(`${API}/worksites/${worksiteId}`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      
      console.log('📋 Données du chantier:', worksiteRes.data);
      
      const quoteId = worksiteRes.data.quote_id;
      const projectId = worksiteRes.data.project_id;
      const clientId = worksiteRes.data.client_id;
      const address = worksiteRes.data.address;
      
      console.log('🎯 Quote ID:', quoteId, '| Project ID:', projectId);
      
      // Récupérer le devis si disponible
      if (quoteId) {
        try {
          const quoteRes = await axios.get(`${API}/quotes/${quoteId}`, {
            headers: { Authorization: `Bearer ${token}` }
          });
          console.log('📄 Devis chargé:', quoteRes.data);
          setQuoteData(quoteRes.data);
        } catch (err) {
          console.error('❌ Erreur chargement devis:', err);
        }
      }
      
      // Récupérer la recherche d'infiltration via le projet
      if (projectId) {
        try {
          console.log('🔎 Récupération du projet:', projectId);
          const projectRes = await axios.get(`${API}/projects/${projectId}`, {
            headers: { Authorization: `Bearer ${token}` }
          });
          
          console.log('📦 Données du projet:', projectRes.data);
          
          const searchId = projectRes.data.search_id;
          console.log('🔍 Search ID trouvé:', searchId);
          
          if (searchId) {
            const searchRes = await axios.get(`${API}/searches/${searchId}`, {
              headers: { Authorization: `Bearer ${token}` }
            });
            console.log('✅ Recherche chargée via projet:', searchRes.data);
            setSearchData(searchRes.data);
          } else {
            console.log('⚠️ Aucun search_id dans le projet');
          }
        } catch (err) {
          console.error('❌ Erreur chargement recherche via projet:', err);
        }
      } else {
        console.log('⚠️ Aucun project_id dans le chantier');
        
        // Si pas de project_id, chercher la recherche via le client et l'adresse
        if (clientId || address || worksiteRes.data.client_name) {
          try {
            console.log('🔎 Recherche d\'infiltration via client/adresse/nom...');
            console.log('🎯 Client ID du chantier:', clientId);
            console.log('📍 Adresse du chantier:', address);
            console.log('👤 Nom client du chantier:', worksiteRes.data.client_name);
            
            const searchesRes = await axios.get(`${API}/searches`, {
              headers: { Authorization: `Bearer ${token}` }
            });
            
            console.log('📊 Toutes les recherches:', searchesRes.data);
            
            // L'API retourne {data: [...], count: ...}
            const searchesList = searchesRes.data.data || searchesRes.data;
            console.log('📋 Liste des recherches:', searchesList);
            
            const clientName = worksiteRes.data.client_name?.toLowerCase() || '';
            
            // Chercher une recherche qui correspond
            const matchingSearch = searchesList.find(search => {
              console.log(`🔍 Analyse recherche ${search.id}:`, {
                client_id: search.client_id,
                address: search.address || search.location,
                prenom: search.prenom,
                nom: search.nom
              });
              
              // Match par client_id
              const clientMatch = clientId && search.client_id === clientId;
              
              // Match par adresse
              const searchAddress = search.address || search.location || '';
              const addressMatch = address && searchAddress && 
                                   (searchAddress.toLowerCase().includes(address.toLowerCase().substring(0, 20)) ||
                                    address.toLowerCase().includes(searchAddress.toLowerCase().substring(0, 20)));
              
              // Match par nom (prenom + nom de la recherche contient le nom du client)
              const searchFullName = `${search.prenom || ''} ${search.nom || ''}`.toLowerCase().trim();
              const nameMatch = clientName && searchFullName && 
                               (searchFullName.includes(clientName) || 
                                clientName.includes(search.nom?.toLowerCase() || '') ||
                                clientName.includes(search.prenom?.toLowerCase() || ''));
              
              console.log(`   → clientMatch=${clientMatch}, addressMatch=${addressMatch}, nameMatch=${nameMatch}`);
              return clientMatch || addressMatch || nameMatch;
            });
            
            if (matchingSearch) {
              console.log('✅ Recherche trouvée par correspondance:', matchingSearch);
              setSearchData(matchingSearch);
            } else {
              console.log('⚠️ Aucune recherche correspondante trouvée');
            }
          } catch (err) {
            console.error('❌ Erreur recherche d\'infiltration:', err);
          }
        }
      }
    } catch (error) {
      console.error('❌ Erreur chargement données mission:', error);
      alert('Erreur lors du chargement des informations');
      setSelectedMission(null);
    } finally {
      setLoadingQuote(false);
    }
  };

  if (loading) {
    return (
      <Card className="bg-white/80 backdrop-blur-xl rounded-3xl border-0 shadow-2xl">
        <CardContent className="p-8 text-center">
          <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-gray-500 mx-auto"></div>
          <p className="mt-4 text-gray-600">Chargement de vos missions...</p>
        </CardContent>
      </Card>
    );
  }

  const weekDays = getWeekDays();
  const weekDayNames = ['LUN.', 'MAR.', 'MER.', 'JEU.', 'VEN.', 'SAM.', 'DIM.'];
  const monthNames = ['janv.', 'févr.', 'mars', 'avr.', 'mai', 'juin', 'juil.', 'août', 'sept.', 'oct.', 'nov.', 'déc.'];

  // Statistiques de la semaine - utiliser les missions groupées pour compter correctement
  const weekMissionsGrouped = getWeekMissionsGrouped();

  return (
    <div className="space-y-6">
      {/* Header avec navigation */}
      <div className="bg-gradient-to-br from-blue-600 to-indigo-700 rounded-3xl shadow-2xl p-8 text-white">
        <div className="flex flex-col lg:flex-row justify-between items-start lg:items-center space-y-4 lg:space-y-0">
          <div>
            <h2 className="text-3xl font-bold flex items-center gap-3">
              <Calendar className="w-8 h-8" />
              Mes Missions Planifiées
            </h2>
            <p className="text-blue-100 mt-2">Semaine du {weekDays[0].getDate()} au {weekDays[6].getDate()} {monthNames[weekDays[0].getMonth()]} {weekDays[0].getFullYear()}</p>
          </div>
          
          {/* Navigation semaine */}
          <div className="flex items-center gap-3">
            <button
              onClick={goToPreviousWeek}
              className="p-3 bg-white/20 hover:bg-white/30 rounded-xl transition-all backdrop-blur-sm"
            >
              <ChevronLeft className="w-5 h-5" />
            </button>
            <button
              onClick={goToToday}
              className="px-4 py-2 bg-white/20 hover:bg-white/30 rounded-xl transition-all backdrop-blur-sm font-medium text-sm"
            >
              Aujourd'hui
            </button>
            <button
              onClick={goToNextWeek}
              className="p-3 bg-white/20 hover:bg-white/30 rounded-xl transition-all backdrop-blur-sm"
            >
              <ChevronRight className="w-5 h-5" />
            </button>
          </div>
        </div>

        {/* Stats rapides de la semaine */}
        <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mt-6">
          <div className="bg-white/10 backdrop-blur-sm rounded-xl p-4">
            <p className="text-blue-100 text-sm">Total Semaine</p>
            <p className="text-3xl font-bold">{weekMissionsGrouped.length}</p>
          </div>
          <div className="bg-white/10 backdrop-blur-sm rounded-xl p-4">
            <p className="text-blue-100 text-sm">Planifiées</p>
            <p className="text-3xl font-bold">{weekMissionsGrouped.filter(m => m.status === 'scheduled').length}</p>
          </div>
          <div className="bg-white/10 backdrop-blur-sm rounded-xl p-4">
            <p className="text-blue-100 text-sm">En cours</p>
            <p className="text-3xl font-bold">{weekMissionsGrouped.filter(m => m.status === 'in_progress').length}</p>
          </div>
          <div className="bg-white/10 backdrop-blur-sm rounded-xl p-4">
            <p className="text-blue-100 text-sm">Terminées</p>
            <p className="text-3xl font-bold">{weekMissionsGrouped.filter(m => m.status === 'completed').length}</p>
          </div>
        </div>
      </div>

      {/* Vue Calendrier Hebdomadaire */}
      <div className="bg-white rounded-3xl shadow-xl border border-gray-100 overflow-visible">
        {/* En-têtes des jours */}
        <div className="grid grid-cols-7 gap-px bg-gray-200">
          {weekDays.map((day, index) => {
            const isToday = day.toDateString() === new Date().toDateString();
            return (
              <div 
                key={`header-${index}`}
                className={`bg-white p-4 text-center border-b-2 ${isToday ? 'border-blue-500 bg-blue-100' : 'border-gray-200'}`}
              >
                <div className={`text-xs font-bold uppercase tracking-wide ${isToday ? 'text-blue-700' : 'text-gray-500'}`}>
                  {weekDayNames[index]}
                </div>
                <div className={`text-2xl font-bold mt-1 ${isToday ? 'text-blue-700' : 'text-gray-900'}`}>
                  {day.getDate()}
                </div>
                <div className={`text-xs ${isToday ? 'text-blue-600' : 'text-gray-500'}`}>
                  {monthNames[day.getMonth()]}
                </div>
              </div>
            );
          })}
        </div>

        {/* Zone de contenu avec grille pour les missions */}
        <div className="relative" style={{ minHeight: '400px' }}>
          {/* Grille de fond pour chaque jour */}
          <div className="grid grid-cols-7 gap-px bg-gray-200 absolute inset-0">
            {weekDays.map((day, index) => {
              const isToday = day.toDateString() === new Date().toDateString();
              return (
                <div 
                  key={`bg-${index}`}
                  className={`bg-white ${isToday ? 'bg-blue-50/30' : ''}`}
                />
              );
            })}
          </div>

          {/* Container pour les missions avec grid overlay */}
          <div className="relative grid grid-cols-7 gap-px" style={{ minHeight: '400px' }}>
            {getWeekMissionsGrouped().map((mission, idx) => {
              const hours = parseInt(mission.hours) || 8;
              const startTime = mission.time || '08:00';
              const [startHour, startMin] = startTime.split(':').map(Number);
              const endHour = startHour + hours;
              const endTime = `${endHour.toString().padStart(2, '0')}:${startMin.toString().padStart(2, '0')}`;
              const totalHours = mission.dayCount * hours;

              return (
                <div
                  key={`mission-${idx}`}
                  onClick={() => fetchQuoteForMission(mission)}
                  className={`absolute rounded-xl cursor-pointer hover:shadow-xl transition-all group overflow-hidden ${
                    mission.isMultiDay 
                      ? 'bg-white border-2 border-blue-300' 
                      : 'bg-gradient-to-br from-blue-500 to-indigo-600 shadow-lg border border-blue-400'
                  }`}
                  style={{
                    left: `calc(${(mission.columnStart - 1) * (100 / 7)}% + 8px)`,
                    right: `calc(${(7 - mission.columnStart - mission.columnSpan + 1) * (100 / 7)}% + 8px)`,
                    top: `${20 + idx * 10}px`,
                    zIndex: 10 + idx
                  }}
                >
                  {/* Badge statut */}
                  {mission.status !== 'scheduled' && (
                    <div className="absolute top-2 right-2 w-5 h-5 rounded-full bg-orange-500 border-2 border-white shadow-md z-20 flex items-center justify-center">
                      <span className="text-white text-xs font-bold">!</span>
                    </div>
                  )}
                  
                  {/* En-tête avec icône et horaire */}
                  <div className={`px-3 py-2 border-b ${
                    mission.isMultiDay ? 'bg-blue-50 border-blue-200' : 'bg-white/10 border-white/20'
                  }`}>
                    <div className="flex items-center justify-between gap-2">
                      <div className="flex items-center gap-2">
                        <div className={`w-6 h-6 rounded-full flex items-center justify-center font-bold text-xs flex-shrink-0 ${
                          mission.isMultiDay 
                            ? 'bg-blue-200 text-blue-700'
                            : 'bg-white/20 text-white'
                        }`}>
                          {mission.worksites?.clients?.name 
                            ? mission.worksites.clients.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase()
                            : '?'}
                        </div>
                        <span className={`font-semibold text-xs ${
                          mission.isMultiDay ? 'text-blue-900' : 'text-white'
                        }`}>
                          {startTime} - {endTime}
                        </span>
                      </div>
                      {(mission.client_name || mission.worksites?.clients?.name || mission.worksites?.clients?.prenom) && (
                        <span className={`px-2 py-0.5 rounded-full text-xs font-bold truncate max-w-[120px] ${
                          mission.isMultiDay 
                            ? 'bg-blue-200 text-blue-700'
                            : 'bg-white/20 text-white'
                        }`} title={mission.client_name || mission.worksites?.clients?.name || ''}>
                          {mission.client_name || mission.worksites?.clients?.name || mission.worksites?.clients?.prenom}
                        </span>
                      )}
                    </div>
                  </div>

                  {/* Contenu principal */}
                  <div className="p-3">
                    {/* Nom du client */}
                    {mission.worksites?.clients?.name && (
                      <p className={`text-xs font-semibold mb-1 uppercase tracking-wide ${
                        mission.isMultiDay 
                          ? 'text-blue-600'
                          : 'text-white/90'
                      }`}>
                        {mission.worksites.clients.name}
                      </p>
                    )}
                    
                    {/* Titre mission */}
                    <p className={`font-bold text-sm mb-2 leading-tight line-clamp-2 ${
                      mission.isMultiDay 
                        ? 'text-gray-900'
                        : 'text-white'
                    }`}>
                      {mission.worksites?.title || mission.worksite_name || 'Chantier'}
                    </p>

                    {/* Adresse du chantier au lieu des dates */}
                    {(mission.worksites?.address || mission.worksites?.clients?.address) && (
                      <div className="mb-2">
                        <div className={`inline-flex items-center gap-1 px-2 py-1 rounded-md text-xs font-medium ${
                          mission.isMultiDay 
                            ? 'text-blue-700 bg-blue-100'
                            : 'text-white bg-white/20'
                        }`}>
                          <MapPin className="w-3 h-3 flex-shrink-0" />
                          <span className="truncate">
                            {mission.worksites?.address || mission.worksites?.clients?.address}
                          </span>
                        </div>
                      </div>
                    )}

                    {/* Informations complémentaires */}
                    <div className={`flex flex-col gap-1 text-xs ${
                      mission.isMultiDay ? 'text-gray-600' : 'text-white/80'
                    }`}>
                      {mission.worksites?.clients?.name && (
                        <div className="flex items-center gap-1">
                          <Building className="w-3 h-3 flex-shrink-0" />
                          <span className="truncate font-medium">{mission.worksites.clients.name}</span>
                        </div>
                      )}
                      {mission.team_leader_name && (
                        <div className="flex items-center gap-1">
                          <User className="w-3 h-3 flex-shrink-0" />
                          <span className="truncate">{mission.team_leader_name}</span>
                        </div>
                      )}
                    </div>
                  </div>

                  {/* Hover effect */}
                  <div className={`absolute inset-0 rounded-xl transition-opacity pointer-events-none ${
                    mission.isMultiDay 
                      ? 'bg-blue-500 opacity-0 group-hover:opacity-5'
                      : 'bg-white opacity-0 group-hover:opacity-10'
                  }`}></div>
                </div>
              );
            })}
          </div>
        </div>
      </div>

      {/* Modale de devis sans prix */}
      {selectedMission && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
          <div className="bg-white rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto shadow-2xl">
            <div className="sticky top-0 bg-white border-b border-gray-200 p-6 flex justify-between items-center z-10">
              <div>
                <h2 className="text-2xl font-bold text-gray-900">Détail de la Mission</h2>
                <p className="text-sm text-gray-600 mt-1">
                  {selectedMission.worksites?.title || selectedMission.worksite_name || 'Chantier'}
                </p>
              </div>
              <button
                onClick={() => {
                  setSelectedMission(null);
                  setQuoteData(null);
                }}
                className="p-2 hover:bg-gray-100 rounded-xl transition-colors"
              >
                <X className="w-6 h-6 text-gray-500" />
              </button>
            </div>

            <div className="p-6">
              {loadingQuote ? (
                <div className="text-center py-12">
                  <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
                  <p className="mt-4 text-gray-600">Chargement des détails...</p>
                </div>
              ) : (
                <div className="space-y-6">
                  {/* Informations mission */}
                  <div className="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl p-5 border border-blue-200">
                    <h3 className="font-bold text-gray-900 mb-4 flex items-center gap-2">
                      <Calendar className="w-5 h-5 text-blue-600" />
                      Informations Mission
                    </h3>
                    <div className="grid grid-cols-2 gap-4 text-sm">
                      <div className="flex items-center gap-2">
                        <Clock className="w-4 h-4 text-gray-500" />
                        <div>
                          <span className="text-gray-600">Date:</span>
                          <span className="ml-2 font-semibold text-gray-900">
                            {new Date(selectedMission.date).toLocaleDateString('fr-FR', { 
                              weekday: 'long', 
                              day: 'numeric', 
                              month: 'long', 
                              year: 'numeric' 
                            })}
                          </span>
                        </div>
                      </div>
                      <div className="flex items-center gap-2">
                        <Clock className="w-4 h-4 text-gray-500" />
                        <div>
                          <span className="text-gray-600">Horaire:</span>
                          <span className="ml-2 font-semibold text-gray-900">{selectedMission.time}</span>
                        </div>
                      </div>
                      <div className="flex items-center gap-2">
                        <User className="w-4 h-4 text-gray-500" />
                        <div>
                          <span className="text-gray-600">Chef d'équipe:</span>
                          <span className="ml-2 font-semibold text-gray-900">{selectedMission.team_leader_name || 'Non défini'}</span>
                        </div>
                      </div>
                      <div className="flex items-center gap-2">
                        <Timer className="w-4 h-4 text-gray-500" />
                        <div>
                          <span className="text-gray-600">Durée:</span>
                          <span className="ml-2 font-semibold text-gray-900">{selectedMission.hours || 8}h</span>
                        </div>
                      </div>
                    </div>
                    {selectedMission.description && (
                      <div className="mt-4 pt-4 border-t border-blue-200">
                        <span className="text-gray-600 text-sm font-medium flex items-center gap-2">
                          <Info className="w-4 h-4" />
                          Description:
                        </span>
                        <p className="mt-2 text-gray-900">{selectedMission.description}</p>
                      </div>
                    )}
                    
                    {/* Si mission multi-jours */}
                    {selectedMission.isMultiDay && selectedMission.groupedMissions && (
                      <div className="mt-4 pt-4 border-t border-blue-200">
                        <p className="text-sm font-medium text-blue-700 mb-2">Mission sur plusieurs jours:</p>
                        <div className="space-y-1">
                          {selectedMission.groupedMissions.map((m, idx) => (
                            <div key={idx} className="text-sm text-gray-700 flex items-center gap-2">
                              <div className="w-2 h-2 bg-blue-500 rounded-full"></div>
                              {new Date(m.date).toLocaleDateString('fr-FR')} - {m.time} ({m.hours || 8}h)
                            </div>
                          ))}
                        </div>
                      </div>
                    )}
                  </div>

                  {/* Devis associé */}
                  {quoteData && (
                    <div>
                      <h3 className="font-bold text-gray-900 mb-4 flex items-center gap-2">
                        <FileText className="w-5 h-5 text-gray-600" />
                        Devis associé
                      </h3>
                      
                      {/* Info devis */}
                      <div className="bg-gray-50 rounded-xl p-4 mb-4">
                        <div className="grid grid-cols-2 gap-4 text-sm">
                          <div>
                            <span className="text-gray-600">Numéro:</span>
                            <span className="ml-2 font-semibold text-gray-900">{quoteData.quote_number || 'N/A'}</span>
                          </div>
                          <div>
                            <span className="text-gray-600">Date:</span>
                            <span className="ml-2 font-semibold text-gray-900">
                              {quoteData.created_at ? new Date(quoteData.created_at).toLocaleDateString('fr-FR') : 'N/A'}
                            </span>
                          </div>
                          {quoteData.client_name && (
                            <div>
                              <span className="text-gray-600">Client:</span>
                              <span className="ml-2 font-semibold text-gray-900">{quoteData.client_name}</span>
                            </div>
                          )}
                          {quoteData.status && (
                            <div>
                              <span className="text-gray-600">Statut:</span>
                              <span className="ml-2 font-semibold text-gray-900">{quoteData.status}</span>
                            </div>
                          )}
                        </div>
                      </div>

                      {/* Articles du devis (sans prix) */}
                      <div className="space-y-3">
                        <h4 className="font-semibold text-gray-700">Articles à réaliser:</h4>
                        {(quoteData.items || []).map((item, index) => (
                          <div key={index} className="bg-white border-2 border-gray-200 rounded-xl p-4 hover:border-blue-300 transition-all">
                            <div className="flex items-start gap-3">
                              <div className="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center flex-shrink-0">
                                <span className="text-blue-700 font-bold text-sm">{index + 1}</span>
                              </div>
                              <div className="flex-1">
                                <h5 className="font-semibold text-gray-900 mb-2">{item.description}</h5>
                                <div className="grid grid-cols-2 gap-3 text-sm text-gray-600">
                                  <div className="flex items-center gap-2">
                                    <div className="w-1.5 h-1.5 bg-gray-400 rounded-full"></div>
                                    <span><span className="font-medium">Quantité:</span> {item.quantity} {item.unit || 'u'}</span>
                                  </div>
                                  {item.reference && (
                                    <div className="flex items-center gap-2">
                                      <div className="w-1.5 h-1.5 bg-gray-400 rounded-full"></div>
                                      <span><span className="font-medium">Réf:</span> {item.reference}</span>
                                    </div>
                                  )}
                                </div>
                                {item.notes && (
                                  <div className="mt-3 pt-3 border-t border-gray-100">
                                    <p className="text-sm text-gray-600">
                                      <span className="font-medium text-gray-700">Notes:</span> {item.notes}
                                    </p>
                                  </div>
                                )}
                              </div>
                            </div>
                          </div>
                        ))}
                      </div>

                      {/* Total articles */}
                      <div className="mt-4 bg-blue-50 rounded-xl p-4 border border-blue-200">
                        <p className="text-sm font-semibold text-blue-900">
                          Total: {(quoteData.items || []).length} article(s) à réaliser
                        </p>
                      </div>
                    </div>
                  )}

                  {!quoteData && !loadingQuote && (
                    <div className="text-center py-8 bg-gray-50 rounded-xl">
                      <FileText className="w-12 h-12 text-gray-400 mx-auto mb-3" />
                      <p className="text-gray-600">Aucun devis associé à cette mission</p>
                    </div>
                  )}
                </div>
              )}
            </div>

            {/* Actions */}
            <div className="sticky bottom-0 bg-white border-t border-gray-200 p-6">
              {/* Debug Info */}
              {console.log('🎨 Rendu des boutons - quoteData:', !!quoteData, '| searchData:', !!searchData)}
              
              <div className="flex justify-between items-center gap-3">
                {/* Boutons d'accès aux documents */}
                <div className="flex gap-3">
                  {quoteData && (
                    <button
                      onClick={() => setShowQuoteModal(true)}
                      className="px-6 py-2.5 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition-all font-medium flex items-center gap-2"
                    >
                      <FileText className="w-4 h-4" />
                      Voir le Devis
                    </button>
                  )}
                  {searchData && (
                    <button
                      onClick={() => {
                        console.log('📊 Ouverture modale recherche avec data:', searchData);
                        setShowSearchModal(true);
                      }}
                      className="px-6 py-2.5 bg-purple-600 text-white rounded-xl hover:bg-purple-700 transition-all font-medium flex items-center gap-2"
                    >
                      <Search className="w-4 h-4" />
                      Voir la Recherche
                    </button>
                  )}
                </div>
                
                {/* Boutons de contrôle */}
                <div className="flex gap-3">
                  <button
                    onClick={() => {
                      setSelectedMission(null);
                      setQuoteData(null);
                      setSearchData(null);
                    }}
                    className="px-6 py-2.5 bg-gray-100 text-gray-700 rounded-xl hover:bg-gray-200 transition-all font-medium"
                  >
                    Fermer
                  </button>
                  {selectedMission.status === 'scheduled' && (
                    <button className="px-6 py-2.5 bg-green-600 text-white rounded-xl hover:bg-green-700 transition-all font-medium flex items-center gap-2">
                      <Play className="w-4 h-4" />
                      Démarrer la mission
                    </button>
                  )}
                </div>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Modale Devis complet (sans prix) */}
      {showQuoteModal && quoteData && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-[60]">
          <div className="bg-white rounded-2xl max-w-5xl w-full max-h-[90vh] overflow-y-auto shadow-2xl">
            <div className="sticky top-0 bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-6 flex justify-between items-center z-10">
              <div>
                <h2 className="text-2xl font-bold">Devis #{quoteData.quote_number}</h2>
                <p className="text-blue-100 text-sm mt-1">Informations techniques (sans prix)</p>
              </div>
              <button
                onClick={() => setShowQuoteModal(false)}
                className="p-2 hover:bg-white/20 rounded-xl transition-colors"
              >
                <X className="w-6 h-6" />
              </button>
            </div>

            <div className="p-6 space-y-6">
              {/* Informations générales */}
              <div className="bg-gray-50 rounded-xl p-5">
                <h3 className="font-bold text-gray-900 mb-4 flex items-center gap-2">
                  <FileText className="w-5 h-5 text-blue-600" />
                  Informations Générales
                </h3>
                <div className="grid grid-cols-2 gap-4 text-sm">
                  <div>
                    <span className="text-gray-600">Date création:</span>
                    <span className="ml-2 font-semibold text-gray-900">
                      {quoteData.created_at ? new Date(quoteData.created_at).toLocaleDateString('fr-FR') : 'N/A'}
                    </span>
                  </div>
                  {quoteData.client_name && (
                    <div>
                      <span className="text-gray-600">Client:</span>
                      <span className="ml-2 font-semibold text-gray-900">{quoteData.client_name}</span>
                    </div>
                  )}
                  {quoteData.client_email && (
                    <div>
                      <span className="text-gray-600">Email:</span>
                      <span className="ml-2 font-semibold text-gray-900">{quoteData.client_email}</span>
                    </div>
                  )}
                  {quoteData.client_phone && (
                    <div>
                      <span className="text-gray-600">Téléphone:</span>
                      <span className="ml-2 font-semibold text-gray-900">{quoteData.client_phone}</span>
                    </div>
                  )}
                </div>
              </div>

              {/* Adresse */}
              {quoteData.address && (
                <div className="bg-blue-50 rounded-xl p-5 border border-blue-200">
                  <h3 className="font-bold text-gray-900 mb-2 flex items-center gap-2">
                    <MapPin className="w-5 h-5 text-blue-600" />
                    Adresse du chantier
                  </h3>
                  <p className="text-gray-900">{quoteData.address}</p>
                </div>
              )}

              {/* Articles détaillés */}
              <div>
                <h3 className="font-bold text-gray-900 mb-4 flex items-center gap-2">
                  <Package className="w-5 h-5 text-gray-600" />
                  Articles à réaliser ({(quoteData.items || []).length})
                </h3>
                <div className="space-y-3">
                  {(quoteData.items || []).map((item, index) => (
                    <div key={index} className="bg-white border-2 border-gray-200 rounded-xl p-5 hover:border-blue-300 transition-all">
                      <div className="flex items-start gap-4">
                        <div className="w-10 h-10 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl flex items-center justify-center flex-shrink-0 shadow-lg">
                          <span className="text-white font-bold">{index + 1}</span>
                        </div>
                        <div className="flex-1">
                          <h5 className="font-bold text-gray-900 mb-3 text-lg">{item.description}</h5>
                          <div className="grid grid-cols-2 gap-4 text-sm">
                            <div className="bg-gray-50 rounded-lg p-3">
                              <span className="text-gray-600 block mb-1">Quantité</span>
                              <span className="font-bold text-gray-900 text-lg">{item.quantity} {item.unit || 'u'}</span>
                            </div>
                            {item.reference && (
                              <div className="bg-gray-50 rounded-lg p-3">
                                <span className="text-gray-600 block mb-1">Référence</span>
                                <span className="font-bold text-gray-900">{item.reference}</span>
                              </div>
                            )}
                          </div>
                          {item.notes && (
                            <div className="mt-4 pt-4 border-t border-gray-200">
                              <p className="text-sm text-gray-700 bg-yellow-50 p-3 rounded-lg border border-yellow-200">
                                <span className="font-bold text-yellow-800">📝 Notes:</span> {item.notes}
                              </p>
                            </div>
                          )}
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>

              {/* Résumé */}
              <div className="bg-gradient-to-br from-blue-600 to-indigo-600 text-white rounded-xl p-5">
                <div className="flex items-center justify-between">
                  <div>
                    <p className="text-blue-100 text-sm">Total articles</p>
                    <p className="text-3xl font-bold">{(quoteData.items || []).length}</p>
                  </div>
                  <CheckCircle className="w-12 h-12 text-blue-200" />
                </div>
              </div>
            </div>

            <div className="sticky bottom-0 bg-white border-t border-gray-200 p-6">
              <button
                onClick={() => setShowQuoteModal(false)}
                className="w-full px-6 py-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition-all font-medium"
              >
                Fermer
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Modale Recherche d'infiltration */}
      {showSearchModal && searchData && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-[60]">
          <div className="bg-white rounded-2xl max-w-6xl w-full max-h-[90vh] overflow-y-auto shadow-2xl">
            <div className="sticky top-0 bg-gradient-to-r from-purple-600 to-indigo-600 text-white p-6 flex justify-between items-center z-10">
              <div>
                <h2 className="text-2xl font-bold">Recherche d'Infiltration</h2>
                <p className="text-purple-100 text-sm mt-1">
                  {searchData.search_type === 'terrain' ? 'Recherche Terrain' : 
                   searchData.search_type === 'pre_search' ? 'Pré-recherche' : 'Recherche'}
                </p>
              </div>
              <button
                onClick={() => setShowSearchModal(false)}
                className="p-2 hover:bg-white/20 rounded-xl transition-colors"
              >
                <X className="w-6 h-6" />
              </button>
            </div>

            <div className="p-6 space-y-6">
              {/* Informations générales */}
              <div className="bg-gray-50 rounded-xl p-5">
                <h3 className="font-bold text-gray-900 mb-4 flex items-center gap-2">
                  <Info className="w-5 h-5 text-purple-600" />
                  Informations Recherche
                </h3>
                <div className="grid grid-cols-2 gap-4 text-sm">
                  <div>
                    <span className="text-gray-600">Date:</span>
                    <span className="ml-2 font-semibold text-gray-900">
                      {searchData.created_at ? new Date(searchData.created_at).toLocaleDateString('fr-FR') : 'N/A'}
                    </span>
                  </div>
                  <div>
                    <span className="text-gray-600">Type:</span>
                    <span className="ml-2 font-semibold text-gray-900">
                      {searchData.search_type === 'terrain' ? 'Terrain' : 
                       searchData.search_type === 'pre_search' ? 'Pré-recherche' : 'Standard'}
                    </span>
                  </div>
                  {searchData.client_name && (
                    <div>
                      <span className="text-gray-600">Client:</span>
                      <span className="ml-2 font-semibold text-gray-900">{searchData.client_name}</span>
                    </div>
                  )}
                  <div>
                    <span className="text-gray-600">Statut:</span>
                    <span className="ml-2 font-semibold text-gray-900">{searchData.status || 'En cours'}</span>
                  </div>
                </div>
              </div>

              {/* Adresse */}
              {searchData.address && (
                <div className="bg-purple-50 rounded-xl p-5 border border-purple-200">
                  <h3 className="font-bold text-gray-900 mb-2 flex items-center gap-2">
                    <MapPin className="w-5 h-5 text-purple-600" />
                    Adresse
                  </h3>
                  <p className="text-gray-900">{searchData.address}</p>
                </div>
              )}

              {/* Description de la recherche */}
              {searchData.description && (
                <div className="bg-blue-50 rounded-xl p-5 border border-blue-200">
                  <h3 className="font-bold text-gray-900 mb-3 flex items-center gap-2">
                    <FileText className="w-5 h-5 text-blue-600" />
                    Description de la recherche
                  </h3>
                  <p className="text-gray-900 leading-relaxed whitespace-pre-wrap">{searchData.description}</p>
                  
                  {/* Photo principale si elle existe */}
                  {searchData.photos && searchData.photos.length > 0 && searchData.photos[0] && (
                    <div className="mt-4">
                      <p className="text-xs text-gray-600 mb-2 flex items-center gap-1">
                        <ImageIcon className="w-3 h-3" />
                        PHOTOS (1)
                      </p>
                      <img
                        src={searchData.photos[0].url || searchData.photos[0]}
                        alt="Photo principale"
                        className="w-48 h-auto rounded-lg border-2 border-gray-200 shadow-sm"
                      />
                    </div>
                  )}
                </div>
              )}

              {/* Observations et sections personnalisées */}
              {(() => {
                let observationsData = null;
                if (searchData.observations) {
                  try {
                    // Tenter de parser les observations si c'est du JSON
                    observationsData = typeof searchData.observations === 'string' 
                      ? JSON.parse(searchData.observations) 
                      : searchData.observations;
                  } catch (e) {
                    // Si ce n'est pas du JSON, utiliser tel quel
                    observationsData = { text: searchData.observations };
                  }
                }

                if (!observationsData) return null;

                return (
                  <>
                    {/* Observations et remarques */}
                    {observationsData.text && (
                      <div className="bg-yellow-50 rounded-xl p-5 border border-yellow-200">
                        <h3 className="font-bold text-gray-900 mb-3 flex items-center gap-2">
                          <Eye className="w-5 h-5 text-yellow-600" />
                          Observations et remarques
                        </h3>
                        <p className="text-gray-900 leading-relaxed whitespace-pre-wrap mb-4">
                          {observationsData.text}
                        </p>
                        
                        {/* Photos des observations (indices 1 à 5 par exemple) */}
                        {searchData.photos && searchData.photos.length > 1 && (
                          <div>
                            <p className="text-xs text-gray-600 mb-2 flex items-center gap-1">
                              <ImageIcon className="w-3 h-3" />
                              Photos ({Math.min(5, searchData.photos.length - 1)})
                            </p>
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                              {searchData.photos.slice(1, 6).map((photo, index) => (
                                <div key={index} className="relative group">
                                  <img
                                    src={photo.url || photo}
                                    alt={`Photo ${index + 1}`}
                                    className="w-full h-32 object-cover rounded-lg border-2 border-gray-200 hover:border-yellow-400 transition-all shadow-sm"
                                  />
                                  <div className="absolute top-1 left-1 bg-black bg-opacity-70 text-white text-xs font-bold px-2 py-1 rounded">
                                    #{index + 1}
                                  </div>
                                  <div className="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-30 transition-all rounded-lg flex items-center justify-center">
                                    <Eye className="w-6 h-6 text-white opacity-0 group-hover:opacity-100 transition-opacity" />
                                  </div>
                                </div>
                              ))}
                            </div>
                          </div>
                        )}
                      </div>
                    )}

                    {/* Sections personnalisées (Inspection Extérieure, Conclusion, etc.) */}
                    {observationsData.customSections && observationsData.customSections.length > 0 && (
                      <>
                        {observationsData.customSections.map((section, index) => {
                          // Déterminer les photos pour cette section (par exemple photos 6 à 13 pour la première section)
                          const startPhotoIndex = 6 + (index * 8);
                          const endPhotoIndex = startPhotoIndex + 8;
                          const sectionPhotos = searchData.photos ? searchData.photos.slice(startPhotoIndex, endPhotoIndex) : [];
                          
                          return (
                            <div key={section.id || index} className="bg-gradient-to-br from-purple-50 to-indigo-50 rounded-xl p-5 border-2 border-purple-200">
                              <h3 className="font-bold text-gray-900 mb-3 flex items-center gap-2">
                                <div className="w-8 h-8 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-lg flex items-center justify-center shadow-lg">
                                  <span className="text-white font-bold text-sm">+</span>
                                </div>
                                {section.title || `Section ${index + 1}`}
                              </h3>
                              <p className="text-gray-900 leading-relaxed whitespace-pre-wrap mb-4">
                                {section.value}
                              </p>
                              
                              {/* Photos de la section */}
                              {sectionPhotos.length > 0 && (
                                <div>
                                  <p className="text-xs text-purple-700 mb-2 flex items-center gap-1">
                                    <ImageIcon className="w-3 h-3" />
                                    Photos ({sectionPhotos.length})
                                  </p>
                                  <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                                    {sectionPhotos.map((photo, photoIndex) => (
                                      <div key={photoIndex} className="relative group">
                                        <img
                                          src={photo.url || photo}
                                          alt={`${section.title} - Photo ${photoIndex + 1}`}
                                          className="w-full h-32 object-cover rounded-lg border-2 border-purple-200 hover:border-purple-400 transition-all shadow-sm"
                                        />
                                        <div className="absolute top-1 left-1 bg-black bg-opacity-70 text-white text-xs font-bold px-2 py-1 rounded">
                                          #{photoIndex + 1}
                                        </div>
                                        <div className="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-30 transition-all rounded-lg flex items-center justify-center">
                                          <Eye className="w-6 h-6 text-white opacity-0 group-hover:opacity-100 transition-opacity" />
                                        </div>
                                      </div>
                                    ))}
                                  </div>
                                </div>
                              )}
                            </div>
                          );
                        })}
                      </>
                    )}
                  </>
                );
              })()}

              {/* Notes et observations générales */}
              {searchData.notes && (
                <div className="bg-orange-50 rounded-xl p-5 border border-orange-200">
                  <h3 className="font-bold text-gray-900 mb-3 flex items-center gap-2">
                    <AlertCircle className="w-5 h-5 text-orange-600" />
                    Notes complémentaires
                  </h3>
                  <p className="text-gray-900 leading-relaxed whitespace-pre-wrap">{searchData.notes}</p>
                </div>
              )}
            </div>

            <div className="sticky bottom-0 bg-white border-t border-gray-200 p-6">
              <button
                onClick={() => setShowSearchModal(false)}
                className="w-full px-6 py-3 bg-purple-600 text-white rounded-xl hover:bg-purple-700 transition-all font-medium"
              >
                Fermer
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

// Composant de formulaire de compte-rendu de chantier
const MissionReportForm = ({ mission, token, onCancel, onComplete }) => {
  const [loading, setLoading] = useState(false);
  const [formData, setFormData] = useState({
    works_performed: '',
    materials_used: '',
    duration_hours: '',
    observations: '',
    issues_encountered: ''
  });
  const [photosBefore, setPhotosBefore] = useState([]);
  const [photosAfter, setPhotosAfter] = useState([]);
  const [photosBeforePreview, setPhotosBeforePreview] = useState([]);
  const [photosAfterPreview, setPhotosAfterPreview] = useState([]);

  const handleInputChange = (field, value) => {
    setFormData(prev => ({ ...prev, [field]: value }));
  };

  const handlePhotoUpload = (e, type) => {
    const files = Array.from(e.target.files);
    if (type === 'before') {
      setPhotosBefore(prev => [...prev, ...files]);
      files.forEach(file => {
        const reader = new FileReader();
        reader.onloadend = () => {
          setPhotosBeforePreview(prev => [...prev, reader.result]);
        };
        reader.readAsDataURL(file);
      });
    } else {
      setPhotosAfter(prev => [...prev, ...files]);
      files.forEach(file => {
        const reader = new FileReader();
        reader.onloadend = () => {
          setPhotosAfterPreview(prev => [...prev, reader.result]);
        };
        reader.readAsDataURL(file);
      });
    }
  };

  const removePhoto = (index, type) => {
    if (type === 'before') {
      setPhotosBefore(prev => prev.filter((_, i) => i !== index));
      setPhotosBeforePreview(prev => prev.filter((_, i) => i !== index));
    } else {
      setPhotosAfter(prev => prev.filter((_, i) => i !== index));
      setPhotosAfterPreview(prev => prev.filter((_, i) => i !== index));
    }
  };

  const handleSubmit = async () => {
    if (!formData.works_performed) {
      alert('Veuillez renseigner les travaux effectués');
      return;
    }

    setLoading(true);
    try {
      const formDataToSend = new FormData();
      formDataToSend.append('mission_id', mission.id);
      formDataToSend.append('works_performed', formData.works_performed);
      formDataToSend.append('materials_used', formData.materials_used);
      formDataToSend.append('duration_hours', formData.duration_hours);
      formDataToSend.append('observations', formData.observations);
      formDataToSend.append('issues_encountered', formData.issues_encountered);
      
      photosBefore.forEach(photo => {
        formDataToSend.append('photos_before', photo);
      });
      
      photosAfter.forEach(photo => {
        formDataToSend.append('photos_after', photo);
      });

      await axios.post(`${API}/mission-reports`, formDataToSend, {
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'multipart/form-data'
        }
      });

      alert('Compte-rendu enregistré avec succès !');
      onComplete();
    } catch (error) {
      console.error('Erreur lors de l\'enregistrement:', error);
      alert('Erreur lors de l\'enregistrement du compte-rendu');
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="max-w-4xl mx-auto">
      <Card className="bg-white rounded-2xl border-0 shadow-lg">
        <CardHeader className="pb-6">
          <div className="flex items-center justify-between">
            <div className="flex items-center space-x-4">
              <div className="w-14 h-14 bg-gradient-to-br from-green-500 to-green-600 rounded-xl flex items-center justify-center">
                <ClipboardList className="h-7 w-7 text-white" />
              </div>
              <div>
                <CardTitle className="text-2xl font-semibold text-gray-900">
                  Compte-Rendu de Chantier
                </CardTitle>
                <CardDescription className="text-gray-600 mt-1">
                  {mission.title}
                </CardDescription>
              </div>
            </div>
            <Button variant="ghost" onClick={onCancel}>
              <X className="h-5 w-5" />
            </Button>
          </div>
        </CardHeader>

        <CardContent className="space-y-6">
          {/* Informations du chantier (lecture seule) */}
          <div className="bg-green-50 border border-green-200 rounded-xl p-4">
            <h3 className="text-sm font-semibold text-green-900 mb-3 flex items-center">
              <MapPin className="h-4 w-4 mr-2" />
              Informations du chantier
            </h3>
            <div className="grid grid-cols-2 gap-3 text-sm">
              <div>
                <span className="text-gray-600">Localisation:</span>
                <p className="font-medium text-gray-900">{mission.location}</p>
              </div>
              <div>
                <span className="text-gray-600">Date:</span>
                <p className="font-medium text-gray-900">
                  {mission.date ? new Date(mission.date).toLocaleDateString('fr-FR') : 'Non définie'}
                </p>
              </div>
              {mission.client_name && (
                <div>
                  <span className="text-gray-600">Client:</span>
                  <p className="font-medium text-gray-900">{mission.client_name}</p>
                </div>
              )}
              {mission.intervention_category && (
                <div>
                  <span className="text-gray-600">Type:</span>
                  <p className="font-medium text-gray-900 capitalize">{mission.intervention_category}</p>
                </div>
              )}
            </div>
          </div>

          {/* Travaux effectués */}
          <div>
            <label className="block text-sm font-semibold text-gray-900 mb-2">
              Travaux effectués <span className="text-red-500">*</span>
            </label>
            <textarea
              value={formData.works_performed}
              onChange={(e) => handleInputChange('works_performed', e.target.value)}
              placeholder="Décrivez en détail les travaux réalisés..."
              className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent resize-none"
              rows={4}
            />
          </div>

          {/* Matériaux utilisés */}
          <div>
            <label className="block text-sm font-semibold text-gray-900 mb-2">
              Matériaux utilisés
            </label>
            <textarea
              value={formData.materials_used}
              onChange={(e) => handleInputChange('materials_used', e.target.value)}
              placeholder="Liste des matériaux et quantités utilisés..."
              className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent resize-none"
              rows={3}
            />
          </div>

          {/* Durée d'intervention */}
          <div>
            <label className="block text-sm font-semibold text-gray-900 mb-2">
              Durée d'intervention (heures)
            </label>
            <Input
              type="number"
              step="0.5"
              value={formData.duration_hours}
              onChange={(e) => handleInputChange('duration_hours', e.target.value)}
              placeholder="Ex: 3.5"
              className="border-gray-300 focus:ring-green-500"
            />
          </div>

          {/* Photos avant */}
          <div>
            <label className="block text-sm font-semibold text-gray-900 mb-2">
              Photos avant travaux
            </label>
            <div className="space-y-3">
              <input
                type="file"
                accept="image/*"
                multiple
                onChange={(e) => handlePhotoUpload(e, 'before')}
                className="hidden"
                id="photos-before"
              />
              <label
                htmlFor="photos-before"
                className="flex items-center justify-center w-full px-4 py-3 border-2 border-dashed border-gray-300 rounded-xl hover:border-green-500 cursor-pointer transition-colors"
              >
                <Camera className="h-5 w-5 text-gray-400 mr-2" />
                <span className="text-gray-600">Ajouter des photos avant</span>
              </label>
              {photosBeforePreview.length > 0 && (
                <div className="grid grid-cols-3 gap-3">
                  {photosBeforePreview.map((preview, index) => (
                    <div key={index} className="relative group">
                      <img src={preview} alt={`Avant ${index + 1}`} className="w-full h-24 object-cover rounded-lg" />
                      <button
                        onClick={() => removePhoto(index, 'before')}
                        className="absolute top-1 right-1 bg-red-500 text-white rounded-full p-1 opacity-0 group-hover:opacity-100 transition-opacity"
                      >
                        <X className="h-4 w-4" />
                      </button>
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>

          {/* Photos après */}
          <div>
            <label className="block text-sm font-semibold text-gray-900 mb-2">
              Photos après travaux
            </label>
            <div className="space-y-3">
              <input
                type="file"
                accept="image/*"
                multiple
                onChange={(e) => handlePhotoUpload(e, 'after')}
                className="hidden"
                id="photos-after"
              />
              <label
                htmlFor="photos-after"
                className="flex items-center justify-center w-full px-4 py-3 border-2 border-dashed border-gray-300 rounded-xl hover:border-green-500 cursor-pointer transition-colors"
              >
                <Camera className="h-5 w-5 text-gray-400 mr-2" />
                <span className="text-gray-600">Ajouter des photos après</span>
              </label>
              {photosAfterPreview.length > 0 && (
                <div className="grid grid-cols-3 gap-3">
                  {photosAfterPreview.map((preview, index) => (
                    <div key={index} className="relative group">
                      <img src={preview} alt={`Après ${index + 1}`} className="w-full h-24 object-cover rounded-lg" />
                      <button
                        onClick={() => removePhoto(index, 'after')}
                        className="absolute top-1 right-1 bg-red-500 text-white rounded-full p-1 opacity-0 group-hover:opacity-100 transition-opacity"
                      >
                        <X className="h-4 w-4" />
                      </button>
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>

          {/* Problèmes rencontrés */}
          <div>
            <label className="block text-sm font-semibold text-gray-900 mb-2">
              Problèmes ou difficultés rencontrés
            </label>
            <textarea
              value={formData.issues_encountered}
              onChange={(e) => handleInputChange('issues_encountered', e.target.value)}
              placeholder="Décrivez les problèmes ou difficultés rencontrés lors de l'intervention..."
              className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent resize-none"
              rows={3}
            />
          </div>

          {/* Observations */}
          <div>
            <label className="block text-sm font-semibold text-gray-900 mb-2">
              Observations générales
            </label>
            <textarea
              value={formData.observations}
              onChange={(e) => handleInputChange('observations', e.target.value)}
              placeholder="Autres observations ou remarques..."
              className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent resize-none"
              rows={3}
            />
          </div>

          {/* Boutons d'action */}
          <div className="flex items-center justify-between pt-6 border-t border-gray-200">
            <Button variant="outline" onClick={onCancel} disabled={loading}>
              Annuler
            </Button>
            <Button
              onClick={handleSubmit}
              disabled={loading || !formData.works_performed}
              className="bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white"
            >
              {loading ? (
                <>
                  <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                  Enregistrement...
                </>
              ) : (
                <>
                  <Save className="h-4 w-4 mr-2" />
                  Enregistrer le compte-rendu
                </>
              )}
            </Button>
          </div>
        </CardContent>
      </Card>
    </div>
  );
};

const INITIAL_AUTO_SAVE_STATE = { saving: false, lastSaved: null, error: null };
const PROFILE_PHOTO_REQUIRED_ERROR = "Ajoutez une photo de profil pour activer l'enregistrement du brouillon.";

const createInitialSections = (generateReferenceNumber) => ([
  {
    id: 'general_info',
    type: 'required',
    title: 'Informations Générales',
    icon: User,
    value: '',
    required: true,
    fieldType: 'multiple',
    collapsed: false,
    photos: [],
    fields: [
      { id: 'nom', label: 'Nom', value: '', required: true, type: 'text' },
      { id: 'prenom', label: 'Prénom', value: '', required: true, type: 'text' },
      { id: 'adresse', label: 'Adresse', value: '', required: true, type: 'textarea' },
      { id: 'ville', label: 'Ville', value: '', required: true, type: 'text' },
      { id: 'code_postal', label: 'Code postal', value: '', required: true, type: 'text' },
      { id: 'numero_recherche', label: 'Numéro de recherche', value: generateReferenceNumber(), required: false, type: 'text', readonly: true },
      { id: 'client_type', label: 'Type de client', value: 'occasional', required: false, type: 'radio', options: [{value: 'occasional', label: 'Client occasionnel (pas de suivi)'}, {value: 'recurring', label: 'Client récurrent (avec suivi)'}] },
      { id: 'client_id', label: 'Client', value: '', required: false, type: 'select', dependsOn: 'client_type', dependsOnValue: 'recurring', options: [] }
    ]
  },
  {
    id: 'description',
    type: 'required', 
    title: 'Description de la recherche',
    icon: FileText,
    value: '',
    required: true,
    placeholder: 'Décrivez en détail ce que vous recherchez (réseaux, canalisations, câbles électriques...)',
    fieldType: 'textarea',
    rows: 4,
    collapsed: false,
    photos: []
  },
  {
    id: 'observations',
    type: 'default',
    title: 'Observations et remarques',
    icon: Eye,
    value: '',
    required: false,
    placeholder: 'Ajoutez vos observations sur le terrain, les conditions de travail...',
    fieldType: 'textarea',
    rows: 3,
    collapsed: false,
    photos: []
  }
]);

// Enhanced Search Form Component with Dynamic Sections
const SearchForm = forwardRef(({ onDraftEvent, searchType = 'terrain', initialSearch = null, onSearchLoaded, recentlyFinalizedRef }, ref) => {
  const { token } = useAuth();
  const [loading, setLoading] = useState(false);
  const [clients, setClients] = useState([]);
  const [photoPreview, setPhotoPreview] = useState([]); // Photos en attente d'upload (nouveaux fichiers)
  const [savedPhotos, setSavedPhotos] = useState([]); // Photos déjà sauvegardées sur le serveur
  const [profilePhoto, setProfilePhoto] = useState(null);
  const [profilePhotoPreview, setProfilePhotoPreview] = useState(null);
  const [showLightbox, setShowLightbox] = useState(false); // État pour la lightbox
  const [lightboxImage, setLightboxImage] = useState(null); // URL de l'image à afficher
  const [useGeolocation, setUseGeolocation] = useState(false);
  const [manualCoords, setManualCoords] = useState({
    latitude: '',
    longitude: ''
  });
  const [geoStatus, setGeoStatus] = useState('');

  // Generate reference number
  const generateReferenceNumber = useCallback(() => {
    const date = new Date();
    const year = date.getFullYear().toString().slice(-2);
    const month = (date.getMonth() + 1).toString().padStart(2, '0');
    const day = date.getDate().toString().padStart(2, '0');
    const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
    return `REF${year}${month}${day}-${random}`;
  }, []);

  // Dynamic sections system
  const [sections, setSections] = useState(() => createInitialSections(generateReferenceNumber));

  const [availableSectionTypes, setAvailableSectionTypes] = useState([
    { 
      type: 'equipment', 
      title: 'Équipements utilisés', 
      icon: Settings, 
      placeholder: 'Liste des équipements et outils utilisés sur le terrain',
      fieldType: 'textarea',
      rows: 2
    },
    { 
      type: 'safety', 
      title: 'Consignes de sécurité', 
      icon: Shield, 
      placeholder: 'Mesures de sécurité appliquées et recommandations',
      fieldType: 'textarea',
      rows: 2
    },
    { 
      type: 'weather', 
      title: 'Conditions météorologiques', 
      icon: Globe, 
      placeholder: 'Conditions météo lors de l\'intervention',
      fieldType: 'input'
    },
    { 
      type: 'duration', 
      title: 'Durée d\'intervention', 
      icon: Clock, 
      placeholder: 'Temps passé sur le terrain',
      fieldType: 'input'
    },
    { 
      type: 'team', 
      title: 'Équipe présente', 
      icon: Users, 
      placeholder: 'Membres de l\'équipe présents sur le terrain',
      fieldType: 'textarea',
      rows: 2
    },
    { 
      type: 'difficulties', 
      title: 'Difficultés rencontrées', 
      icon: AlertTriangle, 
      placeholder: 'Obstacles, problèmes ou difficultés rencontrées',
      fieldType: 'textarea',
      rows: 3
    },
    { 
      type: 'recommendations', 
      title: 'Recommandations', 
      icon: Lightbulb, 
      placeholder: 'Recommandations pour les prochaines interventions',
      fieldType: 'textarea',
      rows: 3
    },
    { 
      type: 'custom', 
      title: 'Section personnalisée', 
      icon: Plus, 
      placeholder: 'Contenu personnalisé',
      fieldType: 'textarea',
      rows: 2
    }
  ]);

  const handleSectionChange = (sectionId, value) => {
    setHasUserInteraction(true);
    setHasPendingChanges(true);
    setSections(prev => prev.map(section => 
      section.id === sectionId ? { ...section, value } : section
    ));
  };

  const handleFieldChange = (sectionId, fieldId, value) => {
    setHasUserInteraction(true);
    setHasPendingChanges(true);
    setSections(prev => prev.map(section => 
      section.id === sectionId 
        ? {
            ...section,
            fields: section.fields?.map(field =>
              field.id === fieldId ? { ...field, value } : field
            )
          }
        : section
    ));
  };

  const handleProfilePhotoChange = (e) => {
    const file = e.target.files[0];
    if (file) {
      if (file.size > 5 * 1024 * 1024) { // 5MB limit
        alert('La taille du fichier ne peut pas dépasser 5MB');
        return;
      }
      
      setProfilePhoto(file);
      setHasUserInteraction(true);
      setHasPendingChanges(true);
      const reader = new FileReader();
      reader.onloadend = () => {
        setProfilePhotoPreview(reader.result);
      };
      reader.readAsDataURL(file);
    }
  };

  const removeSection = (sectionId) => {
    setHasUserInteraction(true);
    setHasPendingChanges(true);
    setSections(prev => prev.filter(section => section.id !== sectionId));
  };

  const toggleSectionCollapse = (sectionId) => {
    setSections(prev => prev.map(section => 
      section.id === sectionId ? { ...section, collapsed: !section.collapsed } : section
    ));
  };

  const moveSectionUp = (index) => {
    if (index > 0) {
      const newSections = [...sections];
      [newSections[index - 1], newSections[index]] = [newSections[index], newSections[index - 1]];
      setSections(newSections);
      setHasUserInteraction(true);
      setHasPendingChanges(true);
    }
  };

  const moveSectionDown = (index) => {
    if (index < sections.length - 1) {
      const newSections = [...sections];
      [newSections[index], newSections[index + 1]] = [newSections[index + 1], newSections[index]];
      setSections(newSections);
      setHasUserInteraction(true);
      setHasPendingChanges(true);
    }
  };

  const handleDragEnd = (result) => {
    if (!result.destination) return;

    const startIndex = result.source.index;
    const endIndex = result.destination.index;

    if (startIndex === endIndex) return;

    const newPhotos = Array.from(photoPreview);
    const [reorderedPhoto] = newPhotos.splice(startIndex, 1);
    newPhotos.splice(endIndex, 0, reorderedPhoto);

    // Update numbers after reordering
    const updatedPhotos = newPhotos.map((photo, index) => ({
      ...photo,
      number: index + 1
    }));

    setPhotoPreview(updatedPhotos);
  };

  const handleFileChange = (e) => {
    const files = Array.from(e.target.files);
    if (files.length > 0) {
      // Add new files to existing ones
      const newPreviews = files.map((file, index) => ({
        file,
        url: URL.createObjectURL(file),
        number: photoPreview.length + savedPhotos.length + index + 1,
        name: file.name
      }));
      
      setPhotoPreview(prev => [...prev, ...newPreviews]);
      setHasUserInteraction(true);
      setHasPendingChanges(true);
    }
  };

  const removePhoto = (indexToRemove) => {
    const newPreviews = photoPreview.filter((_, index) => index !== indexToRemove)
      .map((preview, index) => ({
        ...preview,
        number: index + 1
      }));
    
    // Revoke URL for removed photo
    if (photoPreview[indexToRemove]) {
      URL.revokeObjectURL(photoPreview[indexToRemove].url);
    }
    
    setPhotoPreview(newPreviews);
  };

  const removeSavedPhoto = async (photoFilename) => {
    const authToken = resolveToken();
    if (!authToken || !draftId) {
      return;
    }

    try {
      await axios.delete(`${API}/searches/${draftId}/photos/${photoFilename}`, {
        headers: { Authorization: `Bearer ${authToken}` }
      });

      // Retirer de l'état local après suppression réussie
      setSavedPhotos(prev => prev.filter(photo => photo.filename !== photoFilename));
    } catch (error) {
      console.error('Erreur lors de la suppression de la photo:', error);
      // Afficher un message d'erreur à l'utilisateur si nécessaire
    }
  };

  const getCurrentLocation = () => {
    setGeoStatus('Recherche de votre position...');
    
    if (!navigator.geolocation) {
      setGeoStatus('Géolocalisation non supportée par ce navigateur');
      return Promise.reject('Geolocation not supported');
    }

    return new Promise((resolve, reject) => {
      navigator.geolocation.getCurrentPosition(
        (position) => {
          setGeoStatus(`Position trouvée: ${position.coords.latitude.toFixed(4)}, ${position.coords.longitude.toFixed(4)}`);
          resolve({
            latitude: position.coords.latitude,
            longitude: position.coords.longitude
          });
        },
        (error) => {
          let errorMessage = 'Erreur de géolocalisation';
          switch(error.code) {
            case error.PERMISSION_DENIED:
              errorMessage = 'Permission de géolocalisation refusée';
              break;
            case error.POSITION_UNAVAILABLE:
              errorMessage = 'Position non disponible';
              break;
            case error.TIMEOUT:
              errorMessage = 'Timeout de géolocalisation';
              break;
          }
          setGeoStatus(errorMessage);
          reject(error);
        },
        {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 300000
        }
      );
    });
  };

  // Auto-save brouillon
  const [draftId, setDraftId] = useState(null);
  const [originalSearchStatus, setOriginalSearchStatus] = useState(null); // Conserver le statut original
  const [autoSaveState, setAutoSaveState] = useState(() => ({ ...INITIAL_AUTO_SAVE_STATE }));
  const [hasUserInteraction, setHasUserInteraction] = useState(false);
  const [hasPendingChanges, setHasPendingChanges] = useState(false);
  const autoSaveTimer = useRef(null);
  const draftCreationPromise = useRef(null);
  const initialDraftRequested = useRef(false);
  const isInitialMount = useRef(true); // Pour éviter l'auto-save au premier rendu

  const resolveToken = useCallback(() => token || localStorage.getItem('token'), [token]);

  const buildPayloadFromSections = useCallback(() => {
    const generalSection = sections.find((section) => section.id === 'general_info');
    const nomField = generalSection?.fields?.find((field) => field.id === 'nom');
    const prenomField = generalSection?.fields?.find((field) => field.id === 'prenom');
    const addressField = generalSection?.fields?.find((field) => field.id === 'adresse');
    const villeField = generalSection?.fields?.find((field) => field.id === 'ville');
    const codePostalField = generalSection?.fields?.find((field) => field.id === 'code_postal');
    const clientTypeField = generalSection?.fields?.find((field) => field.id === 'client_type');
    const clientIdField = generalSection?.fields?.find((field) => field.id === 'client_id');
    const descriptionSection = sections.find((section) => section.id === 'description');
    
    // Sauvegarder les sections personnalisées comme JSON
    const customSections = sections
      .filter(s => s.type === 'custom')
      .map(s => ({ id: s.id, title: s.title, value: s.value || '' }));
    
    const observationsSection = sections.find(s => s.id === 'observations');
    const observationsText = observationsSection?.value || '';
    
    // Combiner observations texte + sections custom en JSON
    const observationsData = {
      text: observationsText,
      customSections: customSections
    };

    const payload = {
      nom: nomField?.value || '',
      prenom: prenomField?.value || '',
      location: addressField?.value || '',
      ville: villeField?.value || '',
      code_postal: codePostalField?.value || '',
      description: descriptionSection?.value || '',
      observations: JSON.stringify(observationsData)
    };
    
    // Ajouter client_id uniquement si type = recurring et un client est sélectionné
    if (clientTypeField?.value === 'recurring' && clientIdField?.value) {
      payload.client_id = clientIdField.value;
    } else {
      // Explicitement null pour les clients occasionnels
      payload.client_id = null;
    }
    
    return payload;
  }, [sections]);

  const createDraftIfNeeded = useCallback(async ({ forceCreation = false } = {}) => {
    if (draftId) {
      return draftId;
    }

    if (!forceCreation && !hasUserInteraction) {
      return null;
    }

    // Vérifier que la première section "Informations Générales" est complète
  const generalInfoSection = sections.find(s => s.id === 'general_info');
  const nameField = generalInfoSection?.fields?.find(f => f.id === 'nom');
  const firstNameField = generalInfoSection?.fields?.find(f => f.id === 'prenom');
  const addressField = generalInfoSection?.fields?.find(f => f.id === 'adresse');
    
    const isFirstSectionComplete = 
      nameField?.value?.trim() && 
      firstNameField?.value?.trim() && 
      addressField?.value?.trim();
    
    if (!forceCreation && !isFirstSectionComplete) {
      // Ne pas créer le brouillon tant que la première section n'est pas complète
      return null;
    }
    
    if (draftCreationPromise.current) {
      return draftCreationPromise.current;
    }

    const authToken = resolveToken();
    if (!authToken) {
      return null;
    }

    draftCreationPromise.current = (async () => {
      try {
        const response = await axios.post(`${API}/searches/draft`, {}, {
          headers: { Authorization: `Bearer ${authToken}` }
        });
        const newDraftId = response.data?.search?.id;
        if (newDraftId) {
          setDraftId(newDraftId);
          onDraftEvent?.({ type: 'created', draft: response.data.search });
          setAutoSaveState((prev) => ({ ...prev, error: null }));
        }
        return newDraftId;
      } catch (error) {
        console.warn('Impossible de créer le brouillon:', error);
        return null;
      } finally {
        draftCreationPromise.current = null;
      }
    })();

    return draftCreationPromise.current;
  }, [draftId, hasUserInteraction, onDraftEvent, resolveToken, sections]);

  const autoSaveDraft = useCallback(async ({ forceSave = false } = {}) => {
    // BLOQUER l'auto-save si une finalisation est en cours
    if (isFinalizingRef.current && !forceSave) {
      if (DEBUG_MODE) console.log('⏸️ Auto-save bloqué : finalisation en cours');
      return false;
    }
    
    const authToken = resolveToken();
    if (!authToken) {
      return false;
    }

    let targetDraftId = draftId;
    if (!targetDraftId) {
      // Créer le brouillon seulement si les champs obligatoires sont remplis
      // Ne pas forcer la création - respecter les vérifications de createDraftIfNeeded
      targetDraftId = await createDraftIfNeeded({ forceCreation: false });
      if (!targetDraftId) {
        // Brouillon pas créé car les conditions ne sont pas remplies
        return false;
      }
    }

    if (!forceSave && !hasPendingChanges && photoPreview.length === 0) {
      return false;
    }

    setAutoSaveState((prev) => ({ ...prev, saving: true, error: null }));
    try {
      // 1. Sauvegarder les données textuelles
      const payload = buildPayloadFromSections();
      try {
        // NE PAS envoyer de status lors de l'auto-save pour ne pas écraser un status ACTIVE
        // Le status DRAFT est appliqué uniquement lors de la création initiale du brouillon
        await axios.patch(`${API}/searches/${targetDraftId}`, { ...payload, search_type: searchType?.toUpperCase() }, {
          headers: { Authorization: `Bearer ${authToken}` }
        });
      } catch (patchError) {
        // Si le draft n'existe plus (404), c'est une erreur critique
        if (patchError.response?.status === 404) {
          console.error('❌ Draft introuvable en base de données:', targetDraftId);
          throw new Error('Le brouillon a été supprimé. Veuillez recharger la page.');
        } else {
          throw patchError;
        }
      }

      // 2. Uploader les photos en attente (y compris photo de profil)
      
      // A. Uploader la photo de profil si présente
      if (profilePhoto && !savedPhotos.some(p => p.is_profile)) {
        const formData = new FormData();
        formData.append('files', profilePhoto);
        formData.append('is_profile', 'true');
        formData.append('section_id', 'profile'); // Section spéciale pour photo de profil

        const uploadResponse = await axios.post(
          `${API}/searches/${targetDraftId}/photos`,
          formData,
          {
            headers: {
              Authorization: `Bearer ${authToken}`,
              'Content-Type': 'multipart/form-data'
            }
          }
        );

        if (uploadResponse.data.photos) {
          // Éviter les doublons
          setSavedPhotos(prev => {
            const existingFilenames = new Set(prev.map(p => p.filename));
            const newPhotos = uploadResponse.data.photos.filter(p => !existingFilenames.has(p.filename));
            return [...prev, ...newPhotos];
          });
          
          const profilePhotoData = uploadResponse.data.photos.find(p => p.is_profile);
          if (profilePhotoData) {
            const photoUrl = profilePhotoData.url || `${API}/searches/${targetDraftId}/photos/${profilePhotoData.filename}`;
            setProfilePhotoPreview(photoUrl);
            setProfilePhoto(null);
          }
        }
      }

      // B. Uploader les photos de chaque section
      for (const section of sections) {
        if (section.photos && section.photos.length > 0) {
          // Filtrer uniquement les photos non encore sauvegardées (celles qui ont un objet file)
          const unsavedPhotos = section.photos.filter(photo => photo.file);
          
          if (unsavedPhotos.length > 0) {
            const formData = new FormData();
            unsavedPhotos.forEach(photo => {
              formData.append('files', photo.file);
            });
            formData.append('section_id', section.id); // ✅ Envoyer le section_id

            const uploadResponse = await axios.post(
              `${API}/searches/${targetDraftId}/photos`,
              formData,
              {
                headers: {
                  Authorization: `Bearer ${authToken}`,
                  'Content-Type': 'multipart/form-data'
                }
              }
            );

            // Mettre à jour les photos de la section avec les URLs Supabase
            if (uploadResponse.data.photos) {
              setSections(prevSections =>
                prevSections.map(s => {
                  if (s.id === section.id) {
                    const savedSectionPhotos = uploadResponse.data.photos.map(p => ({
                      url: p.url,
                      filename: p.filename,
                      name: p.original_name || p.filename
                    }));
                    
                    // Remplacer UNIQUEMENT les previews locales (avec file) par les URLs Supabase
                    // Garder uniquement les photos déjà sur le serveur qui ne sont PAS dans les nouvelles photos
                    const newFilenames = new Set(savedSectionPhotos.map(p => p.filename));
                    const existingPhotos = s.photos.filter(photo => 
                      photo.filename && !newFilenames.has(photo.filename) // Éviter les doublons
                    );
                    
                    return {
                      ...s,
                      photos: [
                        ...existingPhotos, // Photos existantes (pas de doublons)
                        ...savedSectionPhotos // Nouvelles photos sauvegardées
                      ]
                    };
                  }
                  return s;
                })
              );

              // Nettoyer les previews des fichiers uploadés
              unsavedPhotos.forEach(photo => {
                if (photo.url) {
                  URL.revokeObjectURL(photo.url);
                }
              });
            }
          }
        }
      }

      // C. Uploader les photos de l'ancienne section globale (compatibilité)
      if (photoPreview.length > 0) {
        const formData = new FormData();
        photoPreview.forEach(photo => {
          formData.append('files', photo.file);
        });
        // Pas de section_id = photos globales (ancienne méthode)

        const uploadResponse = await axios.post(
          `${API}/searches/${targetDraftId}/photos`,
          formData,
          {
            headers: {
              Authorization: `Bearer ${authToken}`,
              'Content-Type': 'multipart/form-data'
            }
          }
        );

        if (uploadResponse.data.photos) {
          // Éviter les doublons en vérifiant les filenames
          setSavedPhotos(prev => {
            const existingFilenames = new Set(prev.map(p => p.filename));
            const newPhotos = uploadResponse.data.photos.filter(p => !existingFilenames.has(p.filename));
            return [...prev, ...newPhotos];
          });
        }
        
        photoPreview.forEach(photo => {
          if (photo.url) {
            URL.revokeObjectURL(photo.url);
          }
        });
        setPhotoPreview([]);
      }

      setAutoSaveState({ saving: false, lastSaved: new Date(), error: null });
      setHasPendingChanges(false);
      onDraftEvent?.({ type: 'saved', draftId: targetDraftId });
      return true;
    } catch (error) {
      setAutoSaveState((prev) => ({ ...prev, saving: false, error: 'Erreur auto-save' }));
      console.error('Erreur auto-save:', error);
      return false;
    }
  }, [buildPayloadFromSections, createDraftIfNeeded, draftId, hasPendingChanges, photoPreview, onDraftEvent, resolveToken]);

  // Marquer que le premier rendu est passé
  useEffect(() => {
    isInitialMount.current = false;
  }, []);

  // DÉSACTIVÉ : Auto-save automatique après chaque modification
  // L'utilisateur doit explicitement sauvegarder via le bouton "Enregistrer"
  // Le brouillon se crée uniquement quand la 1ère section (Nom + Prénom + Adresse) est complète
  // et que l'utilisateur sauvegarde explicitement ou quitte la page
  
  // Auto-save uniquement avant de quitter la page (si 1ère section complète)
  useEffect(() => {
    const handleBeforeUnload = (e) => {
      // Vérifier si la 1ère section est complète
      const generalInfoSection = sections.find(s => s.id === 'general_info');
      const nameField = generalInfoSection?.fields?.find(f => f.id === 'nom');
      const firstNameField = generalInfoSection?.fields?.find(f => f.id === 'prenom');
      const addressField = generalInfoSection?.fields?.find(f => f.id === 'adresse');
      
      const isFirstSectionComplete = 
        nameField?.value?.trim() && 
        firstNameField?.value?.trim() && 
        addressField?.value?.trim();
      
      // Sauvegarder uniquement si la 1ère section est complète et qu'il y a des modifications
      if (isFirstSectionComplete && (hasPendingChanges || photoPreview.length > 0)) {
        autoSaveDraft({ forceSave: true }).catch(console.error);
        e.preventDefault();
        e.returnValue = 'Des modifications non sauvegardées seront perdues.';
      }
    };

    window.addEventListener('beforeunload', handleBeforeUnload);
    return () => window.removeEventListener('beforeunload', handleBeforeUnload);
  }, [autoSaveDraft, hasPendingChanges, photoPreview, sections]);

  useEffect(() => {
    if (!token) {
      initialDraftRequested.current = false;
      return;
    }
    if (draftId || initialDraftRequested.current) {
      return;
    }

    // NE PAS créer automatiquement le brouillon au chargement
    // L'utilisateur doit d'abord remplir la section "Informations Générales"
    // Le brouillon sera créé lors du premier auto-save après modification
    
    /* Création automatique désactivée
    let cancelled = false;
    initialDraftRequested.current = true;
    createDraftIfNeeded({ forceCreation: true })
      .then((newId) => {
        if (!cancelled && !newId) {
          initialDraftRequested.current = false;
        }
      })
      .catch((error) => {
        if (!cancelled) {
          initialDraftRequested.current = false;
          console.error('Création initiale du brouillon échouée:', error);
        }
      });

    return () => {
      cancelled = true;
    };
    */
  }, [token, draftId, createDraftIfNeeded]);

  // Charger la liste des clients au montage du composant
  useEffect(() => {
    const loadClients = async () => {
      try {
        const authToken = resolveToken();
        if (!authToken) return;
        
        const response = await axios.get(`${API}/clients`, {
          headers: { Authorization: `Bearer ${authToken}` }
        });
        
        const clientList = response.data || [];
        setClients(clientList);
        
        // Mettre à jour les options du champ client_id
        setSections(prev => prev.map(section => {
          if (section.id === 'general_info') {
            return {
              ...section,
              fields: section.fields?.map(field => {
                if (field.id === 'client_id') {
                  return {
                    ...field,
                    options: clientList.map(c => ({
                      value: c.id,
                      label: `${c.nom} ${c.prenom || ''}`.trim()
                    }))
                  };
                }
                return field;
              })
            };
          }
          return section;
        }));
      } catch (error) {
        console.error('Erreur chargement clients:', error);
      }
    };
    
    loadClients();
  }, [resolveToken]);

  useEffect(() => {
    return () => {
      if (autoSaveTimer.current) {
        clearTimeout(autoSaveTimer.current);
        autoSaveTimer.current = null;
      }
      if (draftId && hasPendingChanges) {
        autoSaveDraft({ forceSave: true }).catch(() => {});
      }
    };
  }, [autoSaveDraft, draftId, hasPendingChanges]);

  useEffect(() => {
    const handleBeforeUnload = (event) => {
      if (draftId && hasPendingChanges) {
        autoSaveDraft({ forceSave: true }).catch(() => {});
        event.preventDefault();
        event.returnValue = '';
      }
    };

    window.addEventListener('beforeunload', handleBeforeUnload);
    return () => {
      window.removeEventListener('beforeunload', handleBeforeUnload);
    };
  }, [autoSaveDraft, draftId, hasPendingChanges]);

  const handleSubmit = async (e) => {
    e.preventDefault();
    setLoading(true);
    
    // BLOQUER l'auto-save pendant toute la durée de la finalisation
    isFinalizingRef.current = true;
    if (DEBUG_MODE) console.log('🔒 Finalisation démarrée - Auto-save désactivé');
    
    try {
      const authToken = resolveToken();
      if (!authToken) {
        throw new Error('Authentification requise');
      }

      // Vérifier que les champs obligatoires sont remplis avant la soumission
  const generalInfoSection = sections.find(s => s.id === 'general_info');
  const nameField = generalInfoSection?.fields?.find(f => f.id === 'nom');
  const firstNameField = generalInfoSection?.fields?.find(f => f.id === 'prenom');
  const addressField = generalInfoSection?.fields?.find(f => f.id === 'adresse');
      
      if (!nameField?.value?.trim() || !firstNameField?.value?.trim() || !addressField?.value?.trim()) {
        throw new Error('Veuillez remplir tous les champs obligatoires : Nom, Prénom et Adresse');
      }

      const payload = buildPayloadFromSections();
      let ensuredDraftId;
      let response;

      // Si un brouillon existe (reprise d'une recherche), le mettre à jour
      if (draftId) {
        console.log('🔄 Finalisation d\'un brouillon existant:', draftId);
        ensuredDraftId = draftId;
        
        // Sauvegarder les photos avant finalisation
        console.log('📸 Sauvegarde des photos...');
        await autoSaveDraft({ forceSave: true });
        console.log('✅ Photos sauvegardées');
        
        // Mettre à jour la recherche en préservant son statut original (SHARED, ACTIVE, etc.)
        const statusToUse = originalSearchStatus || 'ACTIVE';
        console.log('📊 Statut utilisé pour la mise à jour:', statusToUse);
        response = await axios.patch(`${API}/searches/${ensuredDraftId}`, { ...payload, status: statusToUse, search_type: searchType?.toUpperCase() }, {
          headers: { Authorization: `Bearer ${authToken}` }
        });
      } else {
        // Pas de brouillon = créer temporairement puis immédiatement mettre en ACTIVE
        console.log('✨ Création directe d\'une recherche ACTIVE (sans brouillon intermédiaire)');
        
        // Étape 1 : Créer un brouillon temporaire
        const draftResponse = await axios.post(`${API}/searches/draft`, {}, {
          headers: { Authorization: `Bearer ${authToken}` }
        });
        ensuredDraftId = draftResponse.data?.search?.id;
        console.log('📝 Brouillon temporaire créé:', ensuredDraftId);
        
        // Étape 2 : Immédiatement le passer en ACTIVE
        response = await axios.patch(`${API}/searches/${ensuredDraftId}`, { ...payload, status: 'ACTIVE', search_type: searchType?.toUpperCase() }, {
          headers: { Authorization: `Bearer ${authToken}` }
        });
        console.log('✅ Immédiatement passé en ACTIVE');
        
        // Uploader les photos après création
        if (ensuredDraftId && (photoPreview.length > 0 || profilePhoto)) {
          console.log('📸 Upload des photos...');
          
          // Photo de profil
          if (profilePhoto) {
            const formData = new FormData();
            formData.append('files', profilePhoto);
            formData.append('is_profile', 'true');
            formData.append('section_id', 'profile');
            await axios.post(`${API}/searches/${ensuredDraftId}/photos`, formData, {
              headers: { Authorization: `Bearer ${authToken}`, 'Content-Type': 'multipart/form-data' }
            });
          }
          
          // Photos de sections
          for (const section of sections) {
            if (section.photos && section.photos.length > 0) {
              const unsavedPhotos = section.photos.filter(photo => photo.file);
              if (unsavedPhotos.length > 0) {
                const formData = new FormData();
                unsavedPhotos.forEach(photo => formData.append('files', photo.file));
                formData.append('section_id', section.id);
                await axios.post(`${API}/searches/${ensuredDraftId}/photos`, formData, {
                  headers: { Authorization: `Bearer ${authToken}`, 'Content-Type': 'multipart/form-data' }
                });
              }
            }
          }
          
          console.log('✅ Photos uploadées');
        }
      }
      
      console.log('✅ Recherche finalisée sur le serveur:', response.data);
      console.log('🔍 Status retourné par le backend:', response.data?.search?.status);
      
      // Ajouter au Set des recherches récemment finalisées (exclusion de la modal brouillons)
      // Vérifier que recentlyFinalizedRef existe (optionnel dans certains contextes comme le menu Bureau)
      if (recentlyFinalizedRef?.current) {
        recentlyFinalizedRef.current.add(ensuredDraftId);
        console.log('🔐 Recherche', ensuredDraftId, 'marquée comme récemment finalisée');
        // Nettoyer après 60 secondes
        setTimeout(() => {
          recentlyFinalizedRef.current.delete(ensuredDraftId);
          console.log('🔓 Recherche', ensuredDraftId, 'retirée du cache de finalisation');
        }, 60000);
      }
      
      // Émettre un événement pour notifier que les recherches doivent être rechargées
      // Petit délai pour laisser le temps au composant SearchHistory de se remonter
      console.log('📡 Émission de l\'événement searchFinalized avec:', { searchId: ensuredDraftId });
      setTimeout(() => {
        window.dispatchEvent(new CustomEvent('searchFinalized', { detail: { searchId: ensuredDraftId } }));
        console.log('✨ Événement searchFinalized émis!');
      }, 100);
      
      // Notifier le parent que la recherche n'est plus un brouillon
      if (onDraftEvent) {
        onDraftEvent({ type: 'finalized', draftId: ensuredDraftId });
        console.log('🔄 Parent notifié : brouillon finalisé et retiré de la liste');
      }
      
      setSubmitStatus({ type: 'success', message: 'Recherche finalisée avec succès! Elle apparaît maintenant dans "Mes Recherches".', location: 'Base de données' });
      setTimeout(() => setSubmitStatus(null), 5000);
    
    // Réinitialisation complète UNIQUEMENT si ce n'est PAS une édition
    // En mode édition (initialSearch fourni), on garde le formulaire intact pour que l'utilisateur voie ses modifications
    if (!initialSearch) {
      console.log('🔄 Mode création: réinitialisation du formulaire');
      
      // Nettoyer les URLs blob si présentes
      if (profilePhotoPreview && profilePhotoPreview.startsWith('blob:')) {
        URL.revokeObjectURL(profilePhotoPreview);
      }
      photoPreview.forEach(photo => {
        if (photo.url && photo.url.startsWith('blob:')) {
          URL.revokeObjectURL(photo.url);
        }
      });
      
      // Nettoyer TOUTES les photos des sections (y compris les URLs blob)
      sections.forEach(section => {
        if (section.photos && Array.isArray(section.photos)) {
          section.photos.forEach(photo => {
            if (photo.url && photo.url.startsWith('blob:')) {
              URL.revokeObjectURL(photo.url);
            }
          });
        }
      });
      
      // Créer de nouvelles sections complètement vides (pas de photos, pas de fields avec values)
      const freshSections = createInitialSections(generateReferenceNumber);
      setSections(freshSections);
      setPhotoPreview([]);
      setSavedPhotos([]); // ✅ Vider les photos sauvegardées
      setProfilePhoto(null);
      setProfilePhotoPreview(null);
      setDraftId(null);
      initialDraftRequested.current = false;
      setHasUserInteraction(false);
      setHasPendingChanges(false);
      setAutoSaveState({ ...INITIAL_AUTO_SAVE_STATE });
      
      if (autoSaveTimer.current) {
        clearTimeout(autoSaveTimer.current);
        autoSaveTimer.current = null;
      }
    } else {
      console.log('✏️ Mode édition: conservation du formulaire avec les modifications');
      // En mode édition, on garde le formulaire tel quel
      // L'utilisateur verra ses modifications et pourra fermer la modal manuellement
      setHasPendingChanges(false); // Pas de changements en attente après la sauvegarde
    }
    
    // Notifier le parent dans tous les cas
    onDraftEvent?.({ type: 'finalized', draftId: ensuredDraftId });
    } catch (e) {
      let msg = 'Erreur lors de la finalisation';
      if (e.response?.data?.detail) msg = e.response.data.detail;
      else if (e.message) msg = e.message;
      setSubmitStatus({ type: 'error', message: msg });
      setTimeout(() => setSubmitStatus(null), 8000);
    } finally {
      // DÉBLOQUER l'auto-save
      isFinalizingRef.current = false;
      console.log('🔓 Finalisation terminée - Auto-save réactivé');
      setLoading(false);
    }
  };

  // New functions for enhanced form
  const [submitStatus, setSubmitStatus] = useState(null);
  const isFinalizingRef = useRef(false); // Flag pour bloquer l'auto-save pendant finalisation

  const handleSectionTitleChange = (sectionId, newTitle) => {
    setHasUserInteraction(true);
    setHasPendingChanges(true);
    setSections(prev => prev.map(section => 
      section.id === sectionId ? { ...section, title: newTitle } : section
    ));
  };

  const addNewSection = () => {
    const newSection = {
      id: `custom_${Date.now()}`,
      type: 'custom',
      title: `Section ${sections.length + 1}`,
      icon: Plus,
      value: '',
      required: false,
      placeholder: 'Décrivez le contenu de cette section...',
      fieldType: 'textarea',
      rows: 4,
      removable: true,
      collapsed: false,
      photos: []
    };
    setSections(prev => [...prev, newSection]);
    setHasUserInteraction(true);
    setHasPendingChanges(true);
  };

  const handleSectionPhotos = (sectionId, files) => {
    if (files && files.length > 0) {
      const newPhotos = Array.from(files).map((file, index) => ({
        file,
        url: URL.createObjectURL(file),
        name: file.name
      }));
      
      setSections(prev => prev.map(section => 
        section.id === sectionId 
          ? { ...section, photos: [...(section.photos || []), ...newPhotos] }
          : section
      ));
    }
  };

  const removeSectionPhoto = async (sectionId, photoIndex) => {
    const section = sections.find(s => s.id === sectionId);
    const photoToRemove = section?.photos?.[photoIndex];
    
    // Si la photo a un filename (donc elle est sur le serveur) et qu'on a un draftId, la supprimer du serveur
    if (photoToRemove?.filename && draftId) {
      try {
        await axios.delete(`${API}/searches/${draftId}/photos/${photoToRemove.filename}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
      } catch (error) {
        console.error('Erreur lors de la suppression de la photo:', error);
      }
    }
    
    setSections(prev => prev.map(section => {
      if (section.id === sectionId && section.photos) {
        const newPhotos = section.photos.filter((_, index) => index !== photoIndex);
        // Revoke URL for removed photo
        if (section.photos[photoIndex]) {
          URL.revokeObjectURL(section.photos[photoIndex].url);
        }
        return { ...section, photos: newPhotos };
      }
      return section;
    }));
  };

  // New function for photo drag and drop
  const handleSectionPhotoDragEnd = (sectionId, result) => {
    if (!result.destination) {
      return;
    }

    const sourceIndex = result.source.index;
    const destinationIndex = result.destination.index;

    if (sourceIndex === destinationIndex) {
      return;
    }

    setSections(prev => prev.map(section => {
      if (section.id === sectionId && section.photos) {
        const reorderedPhotos = Array.from(section.photos);
        const [reorderedPhoto] = reorderedPhotos.splice(sourceIndex, 1);
        reorderedPhotos.splice(destinationIndex, 0, reorderedPhoto);
        
        return { ...section, photos: reorderedPhotos };
      }
      return section;
    }));
  };

  // Fonction pour charger un draft (utilisée par useImperativeHandle et useEffect)
  const loadDraft = useCallback((draft) => {
    if (!draft) {
      console.log('❌ [loadDraft] Pas de brouillon fourni');
      return;
    }

    console.log('📥 [loadDraft] Chargement du brouillon:', draft.id, 'photos:', draft.photos?.length || 0);

    if (autoSaveTimer.current) {
      clearTimeout(autoSaveTimer.current);
      autoSaveTimer.current = null;
    }

    const baseSections = createInitialSections(generateReferenceNumber).map((section) => {
      if (section.id === 'general_info') {
        return {
          ...section,
          fields: section.fields?.map((field) => {
            if (field.id === 'nom') {
              return { ...field, value: draft.nom || '' };
            }
            if (field.id === 'prenom') {
              return { ...field, value: draft.prenom || '' };
            }
            if (field.id === 'adresse') {
              return { ...field, value: draft.location || '' };
            }
            if (field.id === 'ville') {
              return { ...field, value: draft.ville || '' };
            }
            if (field.id === 'code_postal') {
              return { ...field, value: draft.code_postal || '' };
            }
            return field;
          })
        };
      }
      if (section.id === 'description') {
        return { ...section, value: draft.description || '' };
      }
      if (section.id === 'observations') {
        // Parser le JSON pour récupérer le texte observations
        try {
          const observationsData = JSON.parse(draft.observations || '{}');
          return { ...section, value: observationsData.text || '' };
        } catch (e) {
          // Si ce n'est pas du JSON, c'est l'ancien format texte simple
          return { ...section, value: draft.observations || '' };
        }
      }
      return section;
    });

    setDraftId(draft.id);
    setPhotoPreview([]);
    setHasUserInteraction(false);
    setHasPendingChanges(false);
    
    // Parser et restaurer les sections personnalisées
    let customSectionsToAdd = [];
    try {
      const observationsData = JSON.parse(draft.observations || '{}');
      if (observationsData.customSections && Array.isArray(observationsData.customSections)) {
        customSectionsToAdd = observationsData.customSections.map(cs => ({
          id: cs.id,
          type: 'custom',
          title: cs.title,
          icon: Plus,
          value: cs.value,
          required: false,
          placeholder: 'Décrivez le contenu de cette section...',
          fieldType: 'textarea',
          rows: 4,
          removable: true,
          collapsed: false,
          photos: []
        }));
        console.log(`✅ [loadDraft] ${customSectionsToAdd.length} sections personnalisées restaurées`);
      }
    } catch (e) {
      console.log('⚠️ [loadDraft] Pas de sections personnalisées ou ancien format');
    }

    // Charger les photos existantes depuis le serveur
    if (draft.photos && Array.isArray(draft.photos) && draft.photos.length > 0) {
      console.log('📸 [loadDraft] Photos trouvées:', draft.photos);
      setSavedPhotos(draft.photos);
      
      // A. Restaurer la photo de profil si elle existe
      const profilePhotoData = draft.photos.find(p => p.is_profile);
      console.log('🖼️ [loadDraft] Photo de profil:', profilePhotoData);
      if (profilePhotoData) {
        const photoUrl = profilePhotoData.url || `${API}/searches/${draft.id}/photos/${profilePhotoData.filename}`;
        console.log('✅ [loadDraft] URL photo de profil:', photoUrl);
        setProfilePhotoPreview(photoUrl);
        setProfilePhoto(null);
      } else {
        console.log('⚠️ [loadDraft] Aucune photo de profil trouvée');
        setProfilePhoto(null);
        setProfilePhotoPreview(null);
      }

      // B. Distribuer les photos dans leurs sections respectives (sections de base + custom)
      const allSections = [...baseSections, ...customSectionsToAdd];
      const sectionsWithPhotos = allSections.map(section => {
        // Filtrer les photos qui appartiennent à cette section
        const sectionPhotos = draft.photos
          .filter(p => p.section_id === section.id && !p.is_profile)
          .map(p => ({
            url: p.url || `${API}/searches/${draft.id}/photos/${p.filename}`,
            filename: p.filename,
            name: p.original_name || p.filename
          }));

        if (sectionPhotos.length > 0) {
          console.log(`📸 [loadDraft] Section ${section.id}: ${sectionPhotos.length} photos chargées`);
          return { ...section, photos: sectionPhotos };
        }
        return section;
      });

      console.log('✅ [loadDraft] Sections avec photos distribuées:', sectionsWithPhotos.filter(s => s.photos?.length > 0).map(s => ({ id: s.id, photosCount: s.photos.length })));
      setSections(sectionsWithPhotos);
    } else {
      setSavedPhotos([]);
      setProfilePhoto(null);
      setProfilePhotoPreview(null);
      setSections([...baseSections, ...customSectionsToAdd]);
    }

    // Définir le draftId pour que la finalisation sache qu'il s'agit d'une édition
    setDraftId(draft.id);
    console.log('✅ [loadDraft] draftId défini:', draft.id);
    
    // Stocker le statut original pour le préserver lors de la finalisation
    setOriginalSearchStatus(draft.status);
    console.log('📊 [loadDraft] Statut original conservé:', draft.status);

    const lastSaved = draft.updated_at || draft.created_at;
    setAutoSaveState({ saving: false, lastSaved: lastSaved ? new Date(lastSaved) : null, error: null });
  }, [generateReferenceNumber]);

  useImperativeHandle(ref, () => ({
    forceAutoSave: async () => {
      if (autoSaveTimer.current) {
        clearTimeout(autoSaveTimer.current);
        autoSaveTimer.current = null;
      }
      return autoSaveDraft({ forceSave: true });
    },
    loadDraft: loadDraft,
    getDraftId: () => draftId,
    ensureDraft: (options = {}) => createDraftIfNeeded({ forceCreation: false, ...options })
  }), [autoSaveDraft, createDraftIfNeeded, draftId, generateReferenceNumber]);

  // Charger automatiquement le draft existant ou initialSearch au montage du composant
  useEffect(() => {
    const loadExistingDraft = async () => {
      // Priorité 1: Charger initialSearch si fourni
      if (initialSearch) {
        console.log('🔄 Chargement de initialSearch:', initialSearch.id);
        loadDraft(initialSearch);
        if (onSearchLoaded) {
          onSearchLoaded();
        }
        return;
      }
      
      // Priorité 2: Charger le draft existant
      try {
        const response = await axios.get(`${API}/searches`, {
          headers: { Authorization: `Bearer ${token}` },
          params: { status: 'DRAFT', limit: 1 }
        });
        
        if (response.data && response.data.length > 0) {
          const existingDraft = response.data[0];
          console.log('📥 Draft existant chargé:', existingDraft);
          
          // Utiliser directement les setters au lieu de draftActions
          if (existingDraft) {
            const baseSections = createInitialSections(generateReferenceNumber).map((section) => {
              if (section.id === 'general_info') {
                return {
                  ...section,
                  fields: section.fields?.map((field) => {
                    if (field.id === 'nom') {
                      return { ...field, value: existingDraft.nom || '' };
                    }
                    if (field.id === 'prenom') {
                      return { ...field, value: existingDraft.prenom || '' };
                    }
                    if (field.id === 'adresse') {
                      return { ...field, value: existingDraft.location || '' };
                    }
                    return field;
                  })
                };
              }
              if (section.id === 'description') {
                return { ...section, value: existingDraft.description || '' };
              }
              if (section.id === 'observations') {
                return { ...section, value: existingDraft.observations || '' };
              }
              return section;
            });

            setDraftId(existingDraft.id);
            setPhotoPreview([]);
            setHasUserInteraction(false);
            setHasPendingChanges(false);

            // Charger les photos existantes et les distribuer par section_id
            if (existingDraft.photos && Array.isArray(existingDraft.photos) && existingDraft.photos.length > 0) {
              setSavedPhotos(existingDraft.photos);
              
              // A. Restaurer la photo de profil
              const profilePhotoData = existingDraft.photos.find(p => p.is_profile);
              if (profilePhotoData) {
                const photoUrl = profilePhotoData.url || `${API}/searches/${existingDraft.id}/photos/${profilePhotoData.filename}`;
                setProfilePhotoPreview(photoUrl);
                setProfilePhoto(null);
              } else {
                setProfilePhoto(null);
                setProfilePhotoPreview(null);
              }

              // B. Distribuer les photos dans leurs sections respectives
              const sectionsWithPhotos = baseSections.map(section => {
                // Filtrer les photos qui appartiennent à cette section
                const sectionPhotos = existingDraft.photos
                  .filter(p => p.section_id === section.id && !p.is_profile)
                  .map(p => ({
                    url: p.url || `${API}/searches/${existingDraft.id}/photos/${p.filename}`,
                    filename: p.filename,
                    name: p.original_name || p.filename
                  }));

                if (sectionPhotos.length > 0) {
                  console.log(`📸 Section ${section.id}: ${sectionPhotos.length} photos chargées`);
                  return { ...section, photos: sectionPhotos };
                }
                return section;
              });

              console.log('✅ Sections avec photos distribuées:', sectionsWithPhotos.filter(s => s.photos?.length > 0).map(s => ({ id: s.id, photosCount: s.photos.length })));
              setSections(sectionsWithPhotos);
            } else {
              setSavedPhotos([]);
              setProfilePhoto(null);
              setProfilePhotoPreview(null);
              setSections(baseSections);
            }

            const lastSaved = existingDraft.updated_at || existingDraft.created_at;
            setAutoSaveState({ saving: false, lastSaved: lastSaved ? new Date(lastSaved) : null, error: null });
          }
        }
      } catch (error) {
        console.error('❌ Erreur chargement draft existant:', error);
      }
    };

    // NOTE: Chargement automatique DÉSACTIVÉ sauf si initialSearch est fourni
    // L'utilisateur doit charger manuellement via "Brouillon en attente" ou "Modifier"
    if (token && !draftId) {
      loadExistingDraft();
    }
  }, [token, draftId, generateReferenceNumber, initialSearch, onSearchLoaded]);

  return (
    <div className="max-w-4xl mx-auto">
      <Card className="bg-white rounded-2xl border-0 shadow-sm">
        <CardHeader className="pb-6">
          <div className="text-center">
            <div className="w-16 h-16 bg-gray-900 rounded-xl flex items-center justify-center mx-auto mb-4">
              <Search className="h-8 w-8 text-white" />
            </div>
            <CardTitle className="text-2xl font-semibold text-gray-900">
              {searchType === 'rapport' ? 'Nouveau Compte-Rendu Chantier' : searchType === 'infiltration' ? "Nouvelle Recherche d'Infiltration" : 'Nouvelle Recherche'}
            </CardTitle>
            <CardDescription className="text-gray-600 mt-2">
              Formulaire personnalisable avec sections modulaires
            </CardDescription>
          </div>
        </CardHeader>
        
        <CardContent className="px-8 pb-8">
          {/* Auto-save explanation */}
          <div className="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
            <div className="flex items-start space-x-3">
              <div className="flex-shrink-0">
                <svg className="h-5 w-5 text-blue-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
              </div>
              <div className="flex-1">
                <p className="text-sm text-blue-800">
                  <span className="font-medium">Sauvegarde automatique :</span> Dès que vous complétez les 3 champs obligatoires (Nom, Prénom, Adresse) de la section "Informations Générales", un brouillon est créé. Vos modifications sont ensuite automatiquement enregistrées 2 secondes après chaque changement. Vous pouvez quitter et revenir sans perdre votre travail.
                </p>
              </div>
            </div>
          </div>

          <form onSubmit={handleSubmit} className="space-y-8">
            {/* Auto-save indicator */}
            <div className="flex items-center justify-between mb-2">
              <div className="text-sm text-gray-500">
                {autoSaveState.saving ? (
                  <span className="inline-flex items-center text-amber-600"><Loader2 className="h-4 w-4 mr-1 animate-spin"/>Sauvegarde du brouillon…</span>
                ) : autoSaveState.error ? (
                  <span className="inline-flex items-center text-red-600"><AlertCircle className="h-4 w-4 mr-1"/>Erreur auto‑save</span>
                ) : hasPendingChanges ? (
                  <span className="inline-flex items-center text-amber-600"><Clock className="h-4 w-4 mr-1"/>Modifications en attente…</span>
                ) : autoSaveState.lastSaved ? (
                  <span className="inline-flex items-center text-green-600"><Check className="h-4 w-4 mr-1"/>Sauvegardé {autoSaveState.lastSaved.toLocaleTimeString()}</span>
                ) : draftId ? (
                  <span className="text-gray-400">Brouillon créé</span>
                ) : (
                  <span className="text-gray-400">Complétez Nom, Prénom et Adresse pour créer le brouillon</span>
                )}
              </div>
            </div>
            {/* Dynamic Sections */}
            <div className="space-y-6">
              {sections.map((section, index) => (
                <div key={section.id} className="relative group bg-white border border-gray-200 rounded-xl hover:border-gray-300 transition-all duration-200 hover:shadow-sm">
                  {/* Section Header */}
                  <div className="flex items-center justify-between p-6 border-b border-gray-100">
                    <div className="flex items-center space-x-3 flex-1">
                      <div className="w-10 h-10 bg-gray-900 rounded-lg flex items-center justify-center flex-shrink-0">
                        <section.icon className="h-5 w-5 text-white" />
                      </div>
                      <div className="flex-1">
                        <input
                          type="text"
                          value={section.title}
                          onChange={(e) => handleSectionTitleChange(section.id, e.target.value)}
                          className="font-medium text-gray-900 bg-transparent border-none outline-none focus:bg-gray-50 px-2 py-1 rounded text-lg w-full"
                          placeholder="Nom de la section..."
                        />
                      </div>
                    </div>
                    
                    {/* Section Controls */}
                    <div className="flex items-center space-x-2">
                      <button
                        type="button"
                        onClick={() => toggleSectionCollapse(section.id)}
                        className="p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors"
                      >
                        {section.collapsed ? (
                          <ChevronDown className="h-5 w-5" />
                        ) : (
                          <ChevronUp className="h-5 w-5" />
                        )}
                      </button>
                      <div className="opacity-0 group-hover:opacity-100 transition-opacity flex items-center space-x-1">
                        <button
                          type="button"
                          onClick={() => moveSectionUp(index)}
                          disabled={index === 0}
                          className="p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors disabled:opacity-30 disabled:cursor-not-allowed"
                          title="Déplacer vers le haut"
                        >
                          <ChevronUp className="h-4 w-4" />
                        </button>
                        <button
                          type="button"
                          onClick={() => moveSectionDown(index)}
                          disabled={index === sections.length - 1}
                          className="p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors disabled:opacity-30 disabled:cursor-not-allowed"
                          title="Déplacer vers le bas"
                        >
                          <ChevronDown className="h-4 w-4" />
                        </button>
                        <button
                          type="button"
                          onClick={() => removeSection(section.id)}
                          className="p-2 text-red-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors"
                          title="Supprimer la section"
                        >
                          <X className="h-4 w-4" />
                        </button>
                      </div>
                    </div>
                  </div>

                  {/* Section Content */}
                  {!section.collapsed && (
                    <div className="p-6">
                      {/* Multiple fields for general_info section */}
                      {section.fieldType === 'multiple' && section.fields ? (
                        <div className="space-y-4 mb-6">
                          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            {section.fields.map((field) => {
                              // Gérer les champs conditionnels
                              if (field.dependsOn) {
                                const dependentField = section.fields.find(f => f.id === field.dependsOn);
                                if (dependentField && dependentField.value !== field.dependsOnValue) {
                                  return null; // Ne pas afficher si la condition n'est pas remplie
                                }
                              }
                              
                              return (
                              <div key={field.id} className="space-y-2" style={field.type === 'radio' ? {gridColumn: '1 / -1'} : {}}>
                                <label className="block text-sm font-medium text-gray-700">
                                  {field.label}
                                  {field.required && <span className="text-red-500 ml-1">*</span>}
                                </label>
                                {field.type === 'radio' ? (
                                  <div className="flex gap-4 p-4 bg-gray-50 rounded-xl">
                                    {field.options?.map(option => (
                                      <label key={option.value} className="flex items-center gap-2 cursor-pointer">
                                        <input
                                          type="radio"
                                          name={field.id}
                                          value={option.value}
                                          checked={field.value === option.value}
                                          onChange={(e) => handleFieldChange(section.id, field.id, e.target.value)}
                                          className="w-4 h-4 text-gray-900"
                                        />
                                        <span className="text-sm">{option.label}</span>
                                      </label>
                                    ))}
                                  </div>
                                ) : field.type === 'select' ? (
                                  <select
                                    value={field.value}
                                    onChange={(e) => handleFieldChange(section.id, field.id, e.target.value)}
                                    className="w-full rounded-xl border border-gray-200 focus:border-gray-900 focus:ring-2 focus:ring-gray-900/10 transition-colors duration-200 text-base p-4"
                                    required={field.required}
                                  >
                                    <option value="">-- Sélectionner un client --</option>
                                    {field.options?.map(option => (
                                      <option key={option.value} value={option.value}>{option.label}</option>
                                    ))}
                                  </select>
                                ) : field.type === 'textarea' ? (
                                  <textarea
                                    value={field.value}
                                    onChange={(e) => handleFieldChange(section.id, field.id, e.target.value)}
                                    placeholder={field.placeholder || `Saisissez ${field.label.toLowerCase()}...`}
                                    rows={3}
                                    className="w-full rounded-xl border border-gray-200 focus:border-gray-900 focus:ring-2 focus:ring-gray-900/10 transition-colors duration-200 text-base p-4 resize-none"
                                    required={field.required}
                                    readOnly={field.readonly}
                                  />
                                ) : (
                                  <input
                                    type={field.type}
                                    value={field.value}
                                    onChange={(e) => handleFieldChange(section.id, field.id, e.target.value)}
                                    placeholder={field.placeholder || `Saisissez ${field.label.toLowerCase()}...`}
                                    className="w-full rounded-xl border border-gray-200 focus:border-gray-900 focus:ring-2 focus:ring-gray-900/10 transition-colors duration-200 text-base p-4"
                                    required={field.required}
                                    readOnly={field.readonly}
                                  />
                                )}
                              </div>
                              );
                            })}
                          </div>
                          
                          {/* Profile Photo for general_info section - Design amélioré avec fond */}
                          {section.id === 'general_info' && (
                            <div className="mt-6 relative overflow-hidden rounded-2xl border border-gray-200 shadow-sm">
                              {/* Image de fond avec effet de fondu */}
                              {profilePhotoPreview && (
                                <div 
                                  className="absolute inset-0 bg-cover bg-center opacity-10 blur-sm scale-110"
                                  style={{ backgroundImage: `url(${profilePhotoPreview})` }}
                                />
                              )}
                              
                              {/* Contenu principal */}
                              <div className="relative bg-gradient-to-br from-white/95 to-gray-50/95 backdrop-blur-sm p-6">
                                <h5 className="text-sm font-semibold text-gray-800 mb-4 flex items-center">
                                  <User className="h-4 w-4 mr-2" />
                                  Photo de profil (optionnelle)
                                </h5>
                                
                                <div className="flex items-center gap-6">
                                  {/* Aperçu de la photo */}
                                  <div className="relative group">
                                    {profilePhotoPreview ? (
                                      <>
                                        <div className="relative">
                                          <img
                                            src={profilePhotoPreview}
                                            alt="Profile preview"
                                            className="w-24 h-24 object-cover rounded-2xl border-4 border-white shadow-lg transition-transform duration-300 group-hover:scale-105"
                                          />
                                          <div className="absolute inset-0 bg-gradient-to-t from-black/20 to-transparent rounded-2xl" />
                                        </div>
                                        <button
                                          type="button"
                                          onClick={() => {
                                            setProfilePhoto(null);
                                            setProfilePhotoPreview(null);
                                            setHasUserInteraction(true);
                                            setHasPendingChanges(true);
                                          }}
                                          className="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-7 h-7 flex items-center justify-center hover:bg-red-600 transition-all shadow-lg hover:scale-110"
                                          title="Supprimer la photo"
                                        >
                                          <X className="h-4 w-4" />
                                        </button>
                                      </>
                                    ) : (
                                      <div className="w-24 h-24 border-2 border-dashed border-gray-300 rounded-2xl flex items-center justify-center bg-white/50 backdrop-blur-sm transition-colors hover:border-gray-400">
                                        <User className="h-10 w-10 text-gray-400" />
                                      </div>
                                    )}
                                  </div>
                                  
                                  {/* Zone de texte et bouton */}
                                  <div className="flex-1">
                                    <input
                                      type="file"
                                      accept="image/*"
                                      onChange={handleProfilePhotoChange}
                                      className="hidden"
                                      id="profile-photo"
                                    />
                                    <label
                                      htmlFor="profile-photo"
                                      className="inline-flex items-center px-5 py-2.5 bg-gray-900 hover:bg-gray-800 text-white rounded-xl cursor-pointer transition-all font-medium shadow-md hover:shadow-lg hover:scale-105"
                                    >
                                      <Camera className="h-4 w-4 mr-2" />
                                      {profilePhotoPreview ? 'Changer la photo' : 'Choisir une photo'}
                                    </label>
                                    <p className="text-xs text-gray-600 mt-2 flex items-center">
                                      <span className="inline-block w-1 h-1 bg-gray-400 rounded-full mr-2"></span>
                                      Formats acceptés: JPG, PNG, WebP (max 5MB)
                                    </p>
                                    {profilePhotoPreview && (
                                      <p className="text-xs text-green-600 mt-1 flex items-center font-medium">
                                        <span className="inline-block w-1.5 h-1.5 bg-green-500 rounded-full mr-2 animate-pulse"></span>
                                        Photo ajoutée avec succès
                                      </p>
                                    )}
                                  </div>
                                </div>
                              </div>
                            </div>
                          )}
                        </div>
                      ) : (
                        /* Default text content for other sections */
                        <div className="space-y-4">
                          <textarea
                            placeholder="Décrivez le contenu de cette section..."
                            value={section.value || ''}
                            onChange={(e) => handleSectionChange(section.id, e.target.value)}
                            rows={4}
                            className="w-full rounded-xl border border-gray-200 focus:border-gray-900 focus:ring-2 focus:ring-gray-900/10 transition-colors duration-200 text-base p-4 resize-none"
                          />
                          
                          {/* Photos pour chaque section */}
                          <div className="p-4 bg-gray-50 rounded-xl space-y-3">
                            <div className="flex items-center justify-between">
                              <label className="text-sm font-medium text-gray-700">
                                Photos de cette section
                              </label>
                              <input
                                type="file"
                                accept="image/*"
                                multiple
                                onChange={(e) => handleSectionPhotos(section.id, e.target.files)}
                                className="hidden"
                                id={`section-photos-${section.id}`}
                              />
                              <label
                                htmlFor={`section-photos-${section.id}`}
                                className="inline-flex items-center px-3 py-1.5 bg-white hover:bg-gray-50 text-gray-700 rounded-lg cursor-pointer transition-colors text-sm font-medium border border-gray-200"
                              >
                                <Camera className="h-4 w-4 mr-1.5" />
                                Ajouter des photos
                              </label>
                            </div>

                            {section.photos && section.photos.length > 0 ? (
                              <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                                {section.photos.map((photo, photoIndex) => (
                                  <div 
                                    key={photoIndex} 
                                    className="relative group cursor-move bg-white rounded-lg border-2 border-gray-200 hover:border-blue-400 transition-all"
                                    draggable
                                    onDragStart={(e) => {
                                      e.dataTransfer.effectAllowed = 'move';
                                      e.dataTransfer.setData('text/plain', JSON.stringify({
                                        sectionId: section.id,
                                        fromIndex: photoIndex
                                      }));
                                    }}
                                    onDragOver={(e) => {
                                      e.preventDefault();
                                      e.currentTarget.classList.add('border-blue-500', 'bg-blue-50');
                                    }}
                                    onDragLeave={(e) => {
                                      e.currentTarget.classList.remove('border-blue-500', 'bg-blue-50');
                                    }}
                                    onDrop={(e) => {
                                      e.preventDefault();
                                      e.currentTarget.classList.remove('border-blue-500', 'bg-blue-50');
                                      const data = JSON.parse(e.dataTransfer.getData('text/plain'));
                                      if (data.sectionId === section.id && data.fromIndex !== photoIndex) {
                                        // Réorganiser les photos
                                        setSections(prevSections => prevSections.map(s => {
                                          if (s.id === section.id) {
                                            const newPhotos = [...s.photos];
                                            const [movedPhoto] = newPhotos.splice(data.fromIndex, 1);
                                            newPhotos.splice(photoIndex, 0, movedPhoto);
                                            return { ...s, photos: newPhotos };
                                          }
                                          return s;
                                        }));
                                        setHasPendingChanges(true);
                                      }
                                    }}
                                  >
                                    {/* Image avec fond pour voir l'image complète */}
                                    <div 
                                      className="w-full h-32 bg-gray-100 rounded-lg overflow-hidden flex items-center justify-center cursor-pointer"
                                      onClick={() => {
                                        setLightboxImage(photo.url);
                                        setShowLightbox(true);
                                      }}
                                    >
                                      <img
                                        src={photo.url}
                                        alt={photo.name}
                                        className="max-w-full max-h-full object-contain"
                                      />
                                    </div>
                                    
                                    {/* Boutons d'action */}
                                    <div className="absolute top-2 right-2 flex space-x-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                      <button
                                        type="button"
                                        onClick={() => {
                                          setLightboxImage(photo.url);
                                          setShowLightbox(true);
                                        }}
                                        className="bg-blue-500 text-white rounded-full w-7 h-7 flex items-center justify-center hover:bg-blue-600 shadow-lg"
                                        title="Voir en détail"
                                      >
                                        <Eye className="h-3.5 w-3.5" />
                                      </button>
                                      <button
                                        type="button"
                                        onClick={() => removeSectionPhoto(section.id, photoIndex)}
                                        className="bg-red-500 text-white rounded-full w-7 h-7 flex items-center justify-center hover:bg-red-600 shadow-lg"
                                        title="Supprimer"
                                      >
                                        <X className="h-3.5 w-3.5" />
                                      </button>
                                    </div>
                                    
                                    {/* Numéro de la photo */}
                                    <div className="absolute bottom-2 left-2 bg-black/70 text-white text-xs px-2 py-1 rounded-md font-medium flex items-center space-x-1">
                                      <GripVertical className="h-3 w-3" />
                                      <span>#{photoIndex + 1}</span>
                                    </div>
                                  </div>
                                ))}
                              </div>
                            ) : (
                              <p className="text-xs text-gray-500 text-center py-3 border border-dashed border-gray-200 rounded-lg">
                                Aucune photo ajoutée pour cette section
                              </p>
                            )}
                          </div>
                        </div>
                      )}
                    </div>
                  )}
                </div>
              ))}

              {/* Add New Section Button */}
              <button
                type="button"
                onClick={addNewSection}
                className="w-full flex items-center justify-center space-x-3 py-6 border-2 border-dashed border-gray-300 hover:border-gray-400 rounded-xl transition-colors group"
              >
                <div className="w-10 h-10 bg-gray-100 group-hover:bg-gray-900 rounded-lg flex items-center justify-center transition-colors">
                  <Plus className="h-5 w-5 text-gray-600 group-hover:text-white" />
                </div>
                <span className="text-gray-600 group-hover:text-gray-900 font-medium">
                  Ajouter une nouvelle section
                </span>
              </button>
            </div>

            {/* Enhanced Submit Button */}
            <div className="pt-6 border-t border-gray-200 space-y-3">
              {/* Bouton Finaliser la recherche */}
              <Button 
                type="submit" 
                disabled={loading || sections.length === 0} 
                className="w-full bg-gray-900 hover:bg-gray-800 text-white rounded-xl py-4 text-base font-medium transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed relative overflow-hidden"
              >
                {loading ? (
                  <div className="flex items-center justify-center space-x-3">
                    <Loader2 className="h-5 w-5 animate-spin" />
                    <span>Finalisation en cours...</span>
                  </div>
                ) : (
                  <div className="flex items-center justify-center space-x-3">
                    <CheckCheck className="h-5 w-5" />
                    <span>Finaliser la recherche</span>
                    <div className="ml-2">
                      <Lightbulb className="h-4 w-4 text-yellow-400 animate-pulse" />
                    </div>
                  </div>
                )}
              </Button>
              
              {/* Success/Error Feedback */}
              {submitStatus && (
                <div className={`mt-4 p-4 rounded-xl flex items-center space-x-3 ${
                  submitStatus.type === 'success' 
                    ? 'bg-green-50 border border-green-200 text-green-800'
                    : 'bg-red-50 border border-red-200 text-red-800'
                }`}>
                  {submitStatus.type === 'success' ? (
                    <CheckCircle className="h-5 w-5 text-green-600" />
                  ) : (
                    <AlertCircle className="h-5 w-5 text-red-600" />
                  )}
                  <div className="flex-1">
                    <p className="font-medium">{submitStatus.message}</p>
                    {submitStatus.location && (
                      <div className="flex items-center space-x-2 mt-2 text-sm">
                        <Lightbulb className="h-4 w-4 text-yellow-600" />
                        <span>Recherche enregistrée dans : {submitStatus.location}</span>
                      </div>
                    )}
                  </div>
                </div>
              )}
              
              <p className="text-sm text-gray-500 text-center mt-4">
                Personnalisez entièrement votre rapport terrain avec des sections modulaires
              </p>
            </div>
          </form>
        </CardContent>
      </Card>

      {/* Lightbox Modal pour visualiser les photos en grand */}
      {showLightbox && (
        <div 
          className="fixed inset-0 bg-black/90 z-[9999] flex items-center justify-center p-4"
          onClick={(e) => {
            if (e.target === e.currentTarget) {
              setShowLightbox(false);
              setLightboxImage(null);
            }
          }}
        >
          <button
            onClick={(e) => {
              e.stopPropagation();
              setShowLightbox(false);
              setLightboxImage(null);
            }}
            className="absolute top-4 right-4 bg-white/10 hover:bg-white/20 text-white rounded-full w-12 h-12 flex items-center justify-center backdrop-blur-sm transition-all z-[10000]"
          >
            <X className="h-6 w-6" />
          </button>
          
          <div 
            className="relative max-w-7xl max-h-[90vh] flex items-center justify-center"
            onClick={(e) => e.stopPropagation()}
          >
            <img
              src={lightboxImage}
              alt="Aperçu"
              className="max-w-full max-h-[90vh] object-contain rounded-lg shadow-2xl"
            />
          </div>
          
          <div className="absolute bottom-4 left-1/2 -translate-x-1/2 bg-white/10 backdrop-blur-sm text-white px-4 py-2 rounded-full text-sm">
            Cliquez n'importe où pour fermer
          </div>
        </div>
      )}
    </div>
  );
});

SearchForm.displayName = 'SearchForm';
export { SearchForm, AuthContext };

// Apple-style Search History Component
const SearchHistory = ({ onEditSearch }) => {
  const [searches, setSearches] = useState([]);
  const [loading, setLoading] = useState(true);
  const [filter, setFilter] = useState('all');
  const [searchTerm, setSearchTerm] = useState('');
  const [page, setPage] = useState(1);
  const [pageSize] = useState(10);
  const [hasMore, setHasMore] = useState(false);
  const [sortBy, setSortBy] = useState('updated_at');
  const [sortDir, setSortDir] = useState('desc');
  const [editingSearch, setEditingSearch] = useState(null);
  const [showEditModal, setShowEditModal] = useState(false);
  const [showPDFPreview, setShowPDFPreview] = useState(false);
  const [selectedSearchForPDF, setSelectedSearchForPDF] = useState(null);
  const [pdfUrl, setPdfUrl] = useState('');
  const [generating, setGenerating] = useState(false);

  useEffect(() => {
    loadSearches();
  }, [page, sortBy, sortDir]);

  // Écouter l'événement de finalisation de recherche
  useEffect(() => {
    const handleSearchFinalized = (event) => {
      console.log('🔔 [SearchHistory] Événement searchFinalized reçu!', event.detail);
      console.log('🔄 Rechargement des recherches...');
      setLoading(true);
      setPage(1); // Revenir à la première page pour voir la nouvelle recherche
      loadSearches();
    };
    
    console.log('✅ [SearchHistory] Écouteur d\'événement searchFinalized installé');
    window.addEventListener('searchFinalized', handleSearchFinalized);
    return () => {
      console.log('❌ [SearchHistory] Écouteur d\'événement searchFinalized retiré');
      window.removeEventListener('searchFinalized', handleSearchFinalized);
    };
  }, []); // Pas de dépendances - on veut juste un écouteur qui utilise la dernière version de loadSearches

  const loadSearches = async () => {
    try {
      const params = {
        page,
        page_size: pageSize,
        sort_by: sortBy,
        sort_dir: sortDir,
      };
      if (searchTerm.trim()) {
        params.search = searchTerm.trim();
      }
      if (filter !== 'all') {
        params.status = filter.toUpperCase();
      }
      const response = await axios.get(`${API}/searches`, {
        params,
        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
      });
      
      console.log('📥 [SearchHistory] Réponse API reçue:', response.data);
      
      if (Array.isArray(response.data)) {
        // rétro‑compat si backend renvoie liste simple
        console.log('📋 [SearchHistory] Format array simple, recherches:', response.data.length);
        setSearches(response.data);
        setHasMore(false);
      } else if (response.data.data) {
        // Format standardisé : { data: [...], count: X }
        console.log('📋 [SearchHistory] Format standardisé, recherches:', response.data.data.length);
        setSearches(response.data.data || []);
        setHasMore(!!response.data.has_more);
      } else {
        // Format pagination : { items: [...], has_more: true }
        console.log('📋 [SearchHistory] Format pagination, recherches:', (response.data.items || []).length);
        setSearches(response.data.items || []);
        setHasMore(!!response.data.has_more);
      }
    } catch (error) {
      console.error('❌ [SearchHistory] Erreur chargement recherches:', error);
    } finally {
      setLoading(false);
    }
  };

  const onSearchTermChange = (e) => {
    setSearchTerm(e.target.value);
    setPage(1);
  };

  const applySearch = () => {
    setLoading(true);
    loadSearches();
  };

  const nextPage = () => { if (hasMore) setPage(p => p + 1); };
  const prevPage = () => { if (page > 1) setPage(p => p - 1); };
  const changeSort = (field) => {
    if (field === sortBy) {
      setSortDir(d => d === 'asc' ? 'desc' : 'asc');
    } else {
      setSortBy(field);
      setSortDir('desc');
    }
    setPage(1);
  };

  const editSearch = async (searchId, updatedData) => {
    try {
      await axios.put(`${API}/searches/${searchId}`, updatedData, {
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        }
      });
      
      // Recharger la recherche complète avec toutes les données (y compris photos)
      const refreshedSearch = await axios.get(`${API}/searches/${searchId}`, {
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        }
      });
      
      setSearches(prev => prev.map(search => 
        search.id === searchId ? refreshedSearch.data : search
      ));
      
      setShowEditModal(false);
      setEditingSearch(null);
      
    } catch (error) {
      console.error('Erreur mise à jour recherche:', error);
      alert('Erreur lors de la mise à jour de la recherche');
    }
  };

  const generatePDFPreview = async (searchId) => {
    setGenerating(true);
    try {
      const response = await axios({
        method: 'get',
        url: `${API}/searches/${searchId}/pdf`,
        responseType: 'blob',
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        }
      });

      const blob = new Blob([response.data], { type: 'application/pdf' });
      const url = window.URL.createObjectURL(blob);
      setPdfUrl(url);
      setSelectedSearchForPDF(searchId);
      setShowPDFPreview(true);
    } catch (error) {
      console.error('Erreur génération aperçu PDF:', error);
      alert('Erreur lors de la génération de l\'aperçu PDF');
    } finally {
      setGenerating(false);
    }
  };

  const downloadPDF = async (searchId) => {
    setGenerating(true);
    try {
      const response = await axios({
        method: 'get',
        url: `${API}/searches/${searchId}/pdf`,
        responseType: 'blob',
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        }
      });

      const blob = new Blob([response.data], { type: 'application/pdf' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `rapport-${searchId}-${new Date().toISOString().split('T')[0]}.pdf`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
    } catch (error) {
      console.error('Erreur téléchargement PDF:', error);
      alert('Erreur lors du téléchargement du PDF');
    } finally {
      setGenerating(false);
    }
  };

  const updateSearchStatus = async (searchId, status) => {
    try {
      await axios.put(`${API}/searches/${searchId}`, { status }, {
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        }
      });
      
      setSearches(prev => prev.map(search => 
        search.id === searchId ? { ...search, status } : search
      ));
      
      alert(`Statut mis à jour: ${status}`);
    } catch (error) {
      console.error('Erreur mise à jour statut:', error);
      alert('Erreur lors de la mise à jour du statut');
    }
  };

  const deleteSearch = async (search) => {
    if (!search) return;
    
    // Message différent selon le statut
    let confirmMessage;
    if (search.status === 'DRAFT') {
      confirmMessage = 'Supprimer ce brouillon définitivement ?';
    } else if (search.status === 'ARCHIVED') {
      confirmMessage = 'Supprimer définitivement cette recherche archivée ?\nCette action est irréversible.';
    } else {
      confirmMessage = 'Archiver cette recherche ?\nElle sera marquée comme archivée.';
    }
    
    if (!confirm(confirmMessage)) return;
    
    try {
      const resp = await axios.delete(`${API}/searches/${search.id}`, {
        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
      });
      const body = resp.data || {};
      if (body.search) {
        // Archivé: mettre à jour l'élément
        setSearches(prev => prev.map(s => s.id === search.id ? body.search : s));
      } else {
        // Supprimé définitivement
        setSearches(prev => prev.filter(s => s.id !== search.id));
      }
    } catch (error) {
      if (error?.response?.status === 405) {
        try {
          const resp = await axios.post(`${API}/searches/${search.id}/delete`, null, {
            headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
          });
          const body = resp.data || {};
          if (body.search) {
            setSearches(prev => prev.map(s => s.id === search.id ? body.search : s));
          } else {
            setSearches(prev => prev.filter(s => s.id !== search.id));
          }
          return;
        } catch (fallbackError) {
          console.error('Erreur suppression (fallback):', fallbackError);
        }
      } else {
        console.error('Erreur suppression recherche:', error);
      }
      alert('Impossible de supprimer/archiver la recherche pour le moment.');
    }
  };

  const formatDate = (dateString) => {
    return new Date(dateString).toLocaleDateString('fr-FR', {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  };

  const getStatusColor = (status) => {
    const colors = {
      'ACTIVE': 'bg-blue-100 text-blue-800',
      'SHARED': 'bg-green-100 text-green-800',
      'PROCESSED': 'bg-gray-100 text-gray-800',
      'ARCHIVED': 'bg-red-100 text-red-800',
      'DRAFT': 'bg-purple-100 text-purple-800'
    };
    return colors[status] || 'bg-gray-100 text-gray-800';
  };

  const getStatusBackgroundColor = (status) => {
    const colors = {
      'DRAFT': 'bg-purple-50 border-purple-200',
      'ACTIVE': 'bg-blue-50 border-blue-200',
      'SHARED': 'bg-green-50 border-green-200',
      'PROCESSED': 'bg-gray-50 border-gray-200',
      'ARCHIVED': 'bg-red-50 border-red-200'
    };
    return colors[status] || 'bg-white border-gray-200';
  };

  const formatFullAddress = (search) => {
    const capitalize = (str) => {
      if (!str) return '';
      return str.charAt(0).toUpperCase() + str.slice(1).toLowerCase();
    };
    
    const parts = [];
    if (search.location) parts.push(capitalize(search.location));
    if (search.ville) parts.push(capitalize(search.ville));
    if (search.code_postal) parts.push(search.code_postal);
    return parts.join(', ') || 'Adresse non spécifiée';
  };

  const filteredSearches = searches.filter(search => {
    // Exclure les brouillons de "Mes Recherches" sauf si on filtre spécifiquement sur DRAFT
    if (filter === 'all' && search.status === 'DRAFT') {
      return false;
    }
    
    const matchesFilter = filter === 'all' || search.status === filter;
    const matchesSearch = !searchTerm || 
      search.location.toLowerCase().includes(searchTerm.toLowerCase()) ||
      search.description.toLowerCase().includes(searchTerm.toLowerCase());
    return matchesFilter && matchesSearch;
  });

  // Edit Modal Component - Utilise le même formulaire dynamique que SearchForm
  const EditSearchModal = ({ search, onSave, onClose }) => {
    const generateReferenceNumber = useCallback(() => {
      const date = new Date();
      const year = date.getFullYear().toString().slice(-2);
      const month = (date.getMonth() + 1).toString().padStart(2, '0');
      const day = date.getDate().toString().padStart(2, '0');
      const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
      return `REF${year}${month}${day}-${random}`;
    }, []);

    // Créer TOUTES les sections comme dans SearchForm
    const createAllSections = useCallback(() => [
      {
        id: 'general_info',
        type: 'required',
        title: 'Informations Générales',
        icon: User,
        value: '',
        required: true,
        fieldType: 'multiple',
        collapsed: false,
        photos: [],
        fields: [
          { id: 'nom', label: 'Nom', value: '', required: true, type: 'text' },
          { id: 'prenom', label: 'Prénom', value: '', required: true, type: 'text' },
          { id: 'adresse', label: 'Adresse', value: '', required: true, type: 'textarea' },
          { id: 'numero_recherche', label: 'Numéro de recherche', value: generateReferenceNumber(), required: false, type: 'text', readonly: true },
          { id: 'client_type', label: 'Type de client', value: 'occasional', required: false, type: 'radio', options: [{value: 'occasional', label: 'Client occasionnel (pas de suivi)'}, {value: 'recurring', label: 'Client récurrent (avec suivi)'}] },
          { id: 'client_id', label: 'Client', value: '', required: false, type: 'select', dependsOn: 'client_type', dependsOnValue: 'recurring', options: [] }
        ]
      },
      {
        id: 'description',
        type: 'required', 
        title: 'Description de la recherche',
        icon: FileText,
        value: '',
        required: true,
        placeholder: 'Décrivez en détail ce que vous recherchez (réseaux, canalisations, câbles électriques...)',
        fieldType: 'textarea',
        rows: 4,
        collapsed: false,
        photos: []
      },
      {
        id: 'observations',
        type: 'default',
        title: 'Observations et remarques',
        icon: Eye,
        value: '',
        required: false,
        placeholder: 'Ajoutez vos observations sur le terrain, les conditions de travail...',
        fieldType: 'textarea',
        rows: 3,
        collapsed: false,
        photos: []
      }
    ], [generateReferenceNumber]);

    const [sections, setSections] = useState(() => createAllSections());
    const [profilePhoto, setProfilePhoto] = useState(null);
    const [profilePhotoPreview, setProfilePhotoPreview] = useState(null);
    const [showLightbox, setShowLightbox] = useState(false);
    const [lightboxImage, setLightboxImage] = useState(null);
    const [clients, setClients] = useState([]);

    // Charger la liste des clients
    useEffect(() => {
      const loadClients = async () => {
        try {
          const response = await axios.get(`${API}/clients`, {
            headers: { Authorization: `Bearer ${localStorage.getItem('token')}` }
          });
          
          const clientList = response.data || [];
          setClients(clientList);
          
          // Mettre à jour les options du champ client_id
          setSections(prev => prev.map(section => {
            if (section.id === 'general_info') {
              return {
                ...section,
                fields: section.fields?.map(field => {
                  if (field.id === 'client_id') {
                    return {
                      ...field,
                      options: clientList.map(c => ({
                        value: c.id,
                        label: `${c.nom} ${c.prenom || ''}`.trim()
                      }))
                    };
                  }
                  return field;
                })
              };
            }
            return section;
          }));
        } catch (error) {
          console.error('Erreur chargement clients:', error);
        }
      };
      
      loadClients();
    }, []);

    useEffect(() => {
      if (search) {
        console.log('🔄 [EditSearchModal] Chargement de la recherche:', search.id, 'avec', search.photos?.length || 0, 'photos');
        
        // Charger les photos d'abord pour préparer la distribution
        const photosBySection = {};
        let profilePhotoUrl = null;
        
        if (search.photos && Array.isArray(search.photos)) {
          console.log('📸 [EditSearchModal] Photos trouvées:', search.photos.length);
          
          // A. Trouver la photo de profil
          const profilePhotoData = search.photos.find(p => p.is_profile);
          if (profilePhotoData) {
            profilePhotoUrl = profilePhotoData.url || `${API}/searches/${search.id}/photos/${profilePhotoData.filename}`;
            console.log('🖼️ [EditSearchModal] Photo de profil:', profilePhotoUrl);
            setProfilePhotoPreview(profilePhotoUrl);
          }
          
          // B. Grouper les photos par section
          const nonProfilePhotos = search.photos.filter(p => !p.is_profile);
          console.log('📷 [EditSearchModal] Photos non-profil:', nonProfilePhotos.map(p => ({ section: p.section_id, filename: p.filename })));
          
          nonProfilePhotos.forEach(p => {
              if (!photosBySection[p.section_id]) {
                photosBySection[p.section_id] = [];
              }
              photosBySection[p.section_id].push({
                url: p.url || `${API}/searches/${search.id}/photos/${p.filename}`,
                filename: p.filename,
                name: p.original_name || p.filename
              });
            });
          
          console.log('📁 [EditSearchModal] Photos par section:', Object.keys(photosBySection).map(k => `${k}: ${photosBySection[k].length}`));
        }
        
        // Charger TOUTES les données en une seule fois (texte + photos)
        setSections(prev => prev.map(section => {
          let updatedSection = { ...section };
          
          // Charger les champs texte
          if (section.id === 'general_info') {
            updatedSection.fields = section.fields?.map(field => {
              if (field.id === 'nom') return { ...field, value: search.nom || '' };
              if (field.id === 'prenom') return { ...field, value: search.prenom || '' };
              if (field.id === 'adresse') return { ...field, value: search.location || '' };
              if (field.id === 'client_type') return { ...field, value: search.client_id ? 'recurring' : 'occasional' };
              if (field.id === 'client_id') return { ...field, value: search.client_id || '' };
              return field;
            });
          }
          if (section.id === 'description') {
            updatedSection.value = search.description || '';
          }
          if (section.id === 'observations') {
            // Parser le JSON pour récupérer le texte observations
            try {
              const observationsData = JSON.parse(search.observations || '{}');
              updatedSection.value = observationsData.text || '';
            } catch (e) {
              // Si ce n'est pas du JSON, c'est l'ancien format texte simple
              updatedSection.value = search.observations || '';
            }
          }
          
          // Ajouter les photos de cette section
          if (photosBySection[section.id]) {
            updatedSection.photos = photosBySection[section.id];
            console.log(`✅ [EditSearchModal] Section ${section.id}: ${photosBySection[section.id].length} photos ajoutées`);
          }
          
          return updatedSection;
        }));
        
        // Recréer les sections personnalisées à partir du JSON
        try {
          const observationsData = JSON.parse(search.observations || '{}');
          if (observationsData.customSections && Array.isArray(observationsData.customSections)) {
            const customSections = observationsData.customSections.map(cs => ({
              id: cs.id,
              type: 'custom',
              title: cs.title,
              icon: Plus,
              value: cs.value,
              required: false,
              placeholder: 'Décrivez le contenu de cette section...',
              fieldType: 'textarea',
              rows: 4,
              removable: true,
              collapsed: false,
              photos: photosBySection[cs.id] || []
            }));
            
            if (customSections.length > 0) {
              console.log(`✅ [EditSearchModal] ${customSections.length} sections personnalisées restaurées`);
              // Filtrer les sections custom déjà présentes pour éviter les doublons
              setSections(prev => {
                const baseAndStandardSections = prev.filter(s => s.type !== 'custom');
                return [...baseAndStandardSections, ...customSections];
              });
            }
          }
        } catch (e) {
          console.log('⚠️ [EditSearchModal] Pas de sections personnalisées ou ancien format');
        }
      }
    }, [search]);

    const handleSectionChange = (sectionId, value) => {
      setSections(prev => prev.map(section => 
        section.id === sectionId ? { ...section, value } : section
      ));
    };

    const handleFieldChange = (sectionId, fieldId, value) => {
      setSections(prev => prev.map(section => 
        section.id === sectionId 
          ? {
              ...section,
              fields: section.fields?.map(field =>
                field.id === fieldId ? { ...field, value } : field
              )
            }
          : section
      ));
    };

    const handleProfilePhotoChange = (e) => {
      const file = e.target.files[0];
      if (file) {
        if (file.size > 5 * 1024 * 1024) {
          alert('La taille du fichier ne peut pas dépasser 5MB');
          return;
        }
        setProfilePhoto(file);
        const reader = new FileReader();
        reader.onloadend = () => {
          setProfilePhotoPreview(reader.result);
        };
        reader.readAsDataURL(file);
      }
    };

    const removeSection = (sectionId) => {
      setSections(prev => prev.filter(section => section.id !== sectionId));
    };

    const toggleSectionCollapse = (sectionId) => {
      setSections(prev => prev.map(section => 
        section.id === sectionId ? { ...section, collapsed: !section.collapsed } : section
      ));
    };

    const addNewSection = () => {
      const newSection = {
        id: `custom_${Date.now()}`,
        type: 'custom',
        title: `Section ${sections.length + 1}`,
        icon: Plus,
        value: '',
        required: false,
        placeholder: 'Décrivez le contenu de cette section...',
        fieldType: 'textarea',
        rows: 4,
        removable: true,
        collapsed: false,
        photos: []
      };
      setSections(prev => [...prev, newSection]);
    };

    const handleSectionTitleChange = (sectionId, newTitle) => {
      setSections(prev => prev.map(section => 
        section.id === sectionId ? { ...section, title: newTitle } : section
      ));
    };

    const handleSectionPhotos = (sectionId, files) => {
      if (files && files.length > 0) {
        const newPhotos = Array.from(files).map((file) => ({
          file,
          url: URL.createObjectURL(file),
          name: file.name
        }));
        
        setSections(prev => prev.map(section => 
          section.id === sectionId 
            ? { ...section, photos: [...(section.photos || []), ...newPhotos] }
            : section
        ));
      }
    };

    const removeSectionPhoto = async (sectionId, photoIndex) => {
      const section = sections.find(s => s.id === sectionId);
      if (!section || !section.photos) return;

      const photoToRemove = section.photos[photoIndex];
      
      // Si la photo a un filename (déjà sauvegardée sur le serveur), la supprimer
      if (photoToRemove.filename && search?.id) {
        try {
          const token = localStorage.getItem('token');
          await axios.delete(`${API}/searches/${search.id}/photos/${photoToRemove.filename}`, {
            headers: { Authorization: `Bearer ${token}` }
          });
          console.log(`✅ Photo ${photoToRemove.filename} supprimée du serveur`);
        } catch (error) {
          console.error('Erreur suppression photo:', error);
          alert('Erreur lors de la suppression de la photo');
          return;
        }
      }

      // Mettre à jour l'état local
      setSections(prev => prev.map(s => {
        if (s.id === sectionId && s.photos) {
          const newPhotos = s.photos.filter((_, index) => index !== photoIndex);
          // Révoquer l'URL locale si c'est une preview
          if (s.photos[photoIndex]?.url?.startsWith('blob:')) {
            URL.revokeObjectURL(s.photos[photoIndex].url);
          }
          return { ...s, photos: newPhotos };
        }
        return s;
      }));
    };

    const handleSubmit = async (e) => {
      e.preventDefault();
      
      // Construire le payload depuis les sections
      const generalSection = sections.find(s => s.id === 'general_info');
      const addressField = generalSection?.fields?.find(f => f.id === 'adresse');
      const clientTypeField = generalSection?.fields?.find(f => f.id === 'client_type');
      const clientIdField = generalSection?.fields?.find(f => f.id === 'client_id');
      const descriptionSection = sections.find(s => s.id === 'description');
      // Sauvegarder les sections personnalisées comme JSON
      const customSections = sections
        .filter(s => s.type === 'custom')
        .map(s => ({ id: s.id, title: s.title, value: s.value || '' }));
      
      const observationsSection = sections.find(s => s.id === 'observations');
      const observationsText = observationsSection?.value || '';
      
      // Combiner observations texte + sections custom en JSON
      const observationsData = {
        text: observationsText,
        customSections: customSections
      };

      const payload = {
        location: addressField?.value || '',
        description: descriptionSection?.value || '',
        observations: JSON.stringify(observationsData)
      };
      
      // Ajouter client_id uniquement si type = recurring et un client est sélectionné
      if (clientTypeField?.value === 'recurring' && clientIdField?.value) {
        payload.client_id = clientIdField.value;
      } else {
        // Explicitement null pour les clients occasionnels
        payload.client_id = null;
      }

      try {
        // 1. Sauvegarder d'abord les données textuelles
        await onSave(search.id, payload);

        // 2. Uploader les nouvelles photos de chaque section
        const token = localStorage.getItem('token');
        if (!token) {
          throw new Error('Token d\'authentification manquant');
        }

        // A. Uploader la photo de profil si nouvelle
        if (profilePhoto) {
          const formData = new FormData();
          formData.append('files', profilePhoto);
          formData.append('is_profile', 'true');
          formData.append('section_id', 'profile');

          await axios.post(
            `${API}/searches/${search.id}/photos`,
            formData,
            {
              headers: {
                Authorization: `Bearer ${token}`,
                'Content-Type': 'multipart/form-data'
              }
            }
          );
        }

        // B. Uploader les nouvelles photos de chaque section
        for (const section of sections) {
          if (section.photos && section.photos.length > 0) {
            // Filtrer uniquement les nouvelles photos (celles qui ont un objet file)
            const newPhotos = section.photos.filter(photo => photo.file);
            
            if (newPhotos.length > 0) {
              const formData = new FormData();
              newPhotos.forEach(photo => {
                formData.append('files', photo.file);
              });
              formData.append('section_id', section.id);

              await axios.post(
                `${API}/searches/${search.id}/photos`,
                formData,
                {
                  headers: {
                    Authorization: `Bearer ${token}`,
                    'Content-Type': 'multipart/form-data'
                  }
                }
              );
            }
          }
        }

        // C. Sauvegarder les données textuelles
        await onSave(search.id, payload);

        alert('Recherche et photos mises à jour avec succès !');
        
        // Fermer le modal - la liste se rafraîchira automatiquement via onSave
        onClose();
      } catch (error) {
        console.error('Erreur lors de la sauvegarde:', error);
        alert('Erreur lors de la mise à jour de la recherche');
      }
    };

    if (!search) return null;

    return (
      <>
      <div className="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50">
        <div className="bg-white rounded-xl shadow-2xl w-[98vw] h-[98vh] overflow-y-auto p-6">
          {/* Header */}
          <div className="flex items-center justify-between mb-6 pb-4 border-b-2 border-gray-200">
            <div>
              <h2 className="text-2xl font-semibold text-gray-900">Modifier la Recherche</h2>
              <p className="text-sm text-gray-600 mt-1">Formulaire personnalisable avec sections modulaires</p>
            </div>
            <button
              onClick={onClose}
              className="p-2 hover:bg-gray-100 rounded-full transition-colors"
            >
              <X className="h-6 w-6 text-gray-600" />
            </button>
          </div>
          
          <form onSubmit={handleSubmit} className="space-y-6 py-4">
            {/* Rendu des sections dynamiques */}
            {sections.map((section, index) => (
              <div key={section.id} className="bg-gray-50 rounded-xl p-6 relative">
                {/* En-tête de section */}
                <div className="flex items-center justify-between mb-4">
                  <div className="flex items-center space-x-3 flex-1">
                    <div className="w-10 h-10 bg-gray-900 rounded-lg flex items-center justify-center flex-shrink-0">
                      <section.icon className="h-5 w-5 text-white" />
                    </div>
                    <div className="flex-1">
                      {section.type === 'custom' ? (
                        <input
                          type="text"
                          value={section.title}
                          onChange={(e) => handleSectionTitleChange(section.id, e.target.value)}
                          className="text-lg font-semibold text-gray-900 bg-transparent border-b border-dashed border-gray-300 focus:border-gray-900 outline-none w-full"
                        />
                      ) : (
                        <h3 className="text-lg font-semibold text-gray-900">{section.title}</h3>
                      )}
                    </div>
                  </div>
                  <div className="flex items-center space-x-2">
                    <button
                      type="button"
                      onClick={() => toggleSectionCollapse(section.id)}
                      className="p-2 hover:bg-gray-200 rounded-lg transition-colors"
                    >
                      {section.collapsed ? <ChevronDown className="h-5 w-5" /> : <ChevronUp className="h-5 w-5" />}
                    </button>
                    {section.removable && (
                      <button
                        type="button"
                        onClick={() => removeSection(section.id)}
                        className="p-2 hover:bg-red-100 text-red-600 rounded-lg transition-colors"
                      >
                        <X className="h-5 w-5" />
                      </button>
                    )}
                  </div>
                </div>

                {/* Contenu de section */}
                {!section.collapsed && (
                  <div className="space-y-4">
                    {/* Champs multiples pour general_info */}
                    {section.fieldType === 'multiple' && section.fields ? (
                      <div className="space-y-4">
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                          {section.fields.map((field) => {
                            // Gérer les champs conditionnels
                            if (field.dependsOn) {
                              const dependentField = section.fields.find(f => f.id === field.dependsOn);
                              if (dependentField && dependentField.value !== field.dependsOnValue) {
                                return null; // Ne pas afficher si la condition n'est pas remplie
                              }
                            }
                            
                            return (
                            <div key={field.id} className="space-y-2" style={field.type === 'radio' ? {gridColumn: '1 / -1'} : {}}>
                              <label className="block text-sm font-medium text-gray-700">
                                {field.label}
                                {field.required && <span className="text-red-500 ml-1">*</span>}
                              </label>
                              {field.type === 'radio' ? (
                                <div className="flex gap-4 p-4 bg-gray-50 rounded-xl">
                                  {field.options?.map(option => (
                                    <label key={option.value} className="flex items-center gap-2 cursor-pointer">
                                      <input
                                        type="radio"
                                        name={field.id}
                                        value={option.value}
                                        checked={field.value === option.value}
                                        onChange={(e) => handleFieldChange(section.id, field.id, e.target.value)}
                                        className="w-4 h-4 text-gray-900"
                                      />
                                      <span className="text-sm">{option.label}</span>
                                    </label>
                                  ))}
                                </div>
                              ) : field.type === 'select' ? (
                                <select
                                  value={field.value}
                                  onChange={(e) => handleFieldChange(section.id, field.id, e.target.value)}
                                  className="w-full rounded-xl border border-gray-200 focus:border-gray-900 focus:ring-2 focus:ring-gray-900/10 transition-colors duration-200 text-base p-4"
                                  required={field.required}
                                >
                                  <option value="">-- Sélectionner un client --</option>
                                  {field.options?.map(option => (
                                    <option key={option.value} value={option.value}>{option.label}</option>
                                  ))}
                                </select>
                              ) : field.type === 'textarea' ? (
                                <textarea
                                  value={field.value}
                                  onChange={(e) => handleFieldChange(section.id, field.id, e.target.value)}
                                  placeholder={field.placeholder || `Saisissez ${field.label.toLowerCase()}...`}
                                  rows={3}
                                  className="w-full rounded-xl border border-gray-200 focus:border-gray-900 focus:ring-2 focus:ring-gray-900/10 transition-colors duration-200 text-base p-4 resize-none"
                                  required={field.required}
                                  readOnly={field.readonly}
                                />
                              ) : (
                                <input
                                  type={field.type}
                                  value={field.value}
                                  onChange={(e) => handleFieldChange(section.id, field.id, e.target.value)}
                                  placeholder={field.placeholder || `Saisissez ${field.label.toLowerCase()}...`}
                                  className="w-full rounded-xl border border-gray-200 focus:border-gray-900 focus:ring-2 focus:ring-gray-900/10 transition-colors duration-200 text-base p-4"
                                  required={field.required}
                                  readOnly={field.readonly}
                                />
                              )}
                            </div>
                            );
                          })}
                        </div>
                        
                        {/* Photo de profil pour general_info */}
                        {section.id === 'general_info' && (
                          <div className="mt-6 p-4 bg-white rounded-xl border border-gray-200">
                            <h5 className="text-sm font-medium text-gray-700 mb-3">Photo de profil (optionnelle)</h5>
                            <div className="flex items-center space-x-4">
                              {profilePhotoPreview ? (
                                <div className="relative">
                                  <img
                                    src={profilePhotoPreview}
                                    alt="Profile preview"
                                    className="w-20 h-20 object-cover rounded-full border-2 border-gray-200"
                                  />
                                  <button
                                    type="button"
                                    onClick={() => {
                                      setProfilePhoto(null);
                                      setProfilePhotoPreview(null);
                                    }}
                                    className="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center hover:bg-red-600 transition-colors"
                                  >
                                    <X className="h-3 w-3" />
                                  </button>
                                </div>
                              ) : (
                                <div className="w-20 h-20 border-2 border-dashed border-gray-300 rounded-full flex items-center justify-center">
                                  <User className="h-8 w-8 text-gray-400" />
                                </div>
                              )}
                              <div>
                                <input
                                  type="file"
                                  accept="image/*"
                                  onChange={handleProfilePhotoChange}
                                  className="hidden"
                                  id="edit-profile-photo"
                                />
                                <label
                                  htmlFor="edit-profile-photo"
                                  className="inline-flex items-center px-4 py-2 bg-white hover:bg-gray-50 text-gray-700 rounded-lg cursor-pointer transition-colors text-sm font-medium border border-gray-200"
                                >
                                  <Camera className="h-4 w-4 mr-2" />
                                  Choisir une photo
                                </label>
                                <p className="text-xs text-gray-500 mt-1">Formats acceptés: JPG, PNG (max 5MB)</p>
                              </div>
                            </div>
                          </div>
                        )}
                      </div>
                    ) : (
                      /* Contenu textarea par défaut */
                      <div className="space-y-4">
                        <textarea
                          placeholder={section.placeholder || 'Décrivez le contenu de cette section...'}
                          value={section.value || ''}
                          onChange={(e) => handleSectionChange(section.id, e.target.value)}
                          rows={section.rows || 4}
                          required={section.required}
                          className="w-full rounded-xl border border-gray-200 focus:border-gray-900 focus:ring-2 focus:ring-gray-900/10 transition-all duration-200 text-base p-4 resize-none"
                        />

                        {/* Photos de section */}
                        <div className="space-y-3">
                          <div className="flex items-center justify-between">
                            <label className="text-sm font-medium text-gray-700">
                              Photos de cette section
                            </label>
                            <input
                              type="file"
                              accept="image/*"
                              multiple
                              onChange={(e) => handleSectionPhotos(section.id, e.target.files)}
                              className="hidden"
                              id={`section-photos-${section.id}`}
                            />
                            <label
                              htmlFor={`section-photos-${section.id}`}
                              className="inline-flex items-center px-3 py-1.5 bg-white hover:bg-gray-50 text-gray-700 rounded-lg cursor-pointer transition-colors text-sm font-medium border border-gray-200"
                            >
                              <Camera className="h-4 w-4 mr-1.5" />
                              Ajouter des photos
                            </label>
                          </div>

                          {section.photos && section.photos.length > 0 && (
                            <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                              {section.photos.map((photo, photoIndex) => (
                                <div 
                                  key={photoIndex} 
                                  className="relative group cursor-move bg-white rounded-lg border-2 border-gray-200 hover:border-blue-400 transition-all"
                                  draggable
                                  onDragStart={(e) => {
                                    e.dataTransfer.effectAllowed = 'move';
                                    e.dataTransfer.setData('text/plain', JSON.stringify({
                                      sectionId: section.id,
                                      fromIndex: photoIndex
                                    }));
                                  }}
                                  onDragOver={(e) => {
                                    e.preventDefault();
                                    e.currentTarget.classList.add('border-blue-500', 'bg-blue-50');
                                  }}
                                  onDragLeave={(e) => {
                                    e.currentTarget.classList.remove('border-blue-500', 'bg-blue-50');
                                  }}
                                  onDrop={(e) => {
                                    e.preventDefault();
                                    e.currentTarget.classList.remove('border-blue-500', 'bg-blue-50');
                                    const data = JSON.parse(e.dataTransfer.getData('text/plain'));
                                    if (data.sectionId === section.id && data.fromIndex !== photoIndex) {
                                      setSections(prevSections => prevSections.map(s => {
                                        if (s.id === section.id) {
                                          const newPhotos = [...s.photos];
                                          const [movedPhoto] = newPhotos.splice(data.fromIndex, 1);
                                          newPhotos.splice(photoIndex, 0, movedPhoto);
                                          return { ...s, photos: newPhotos };
                                        }
                                        return s;
                                      }));
                                    }
                                  }}
                                >
                                  <div 
                                    className="w-full h-32 bg-gray-100 rounded-lg overflow-hidden flex items-center justify-center cursor-pointer"
                                    onClick={() => {
                                      setLightboxImage(photo.url);
                                      setShowLightbox(true);
                                    }}
                                  >
                                    <img
                                      src={photo.url}
                                      alt={photo.name}
                                      className="max-w-full max-h-full object-contain"
                                    />
                                  </div>
                                  
                                  <div className="absolute top-2 right-2 flex space-x-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <button
                                      type="button"
                                      onClick={() => {
                                        setLightboxImage(photo.url);
                                        setShowLightbox(true);
                                      }}
                                      className="bg-blue-500 text-white rounded-full w-7 h-7 flex items-center justify-center hover:bg-blue-600 shadow-lg"
                                      title="Voir en détail"
                                    >
                                      <Eye className="h-3.5 w-3.5" />
                                    </button>
                                    <button
                                      type="button"
                                      onClick={() => removeSectionPhoto(section.id, photoIndex)}
                                      className="bg-red-500 text-white rounded-full w-7 h-7 flex items-center justify-center hover:bg-red-600 shadow-lg"
                                      title="Supprimer"
                                    >
                                      <X className="h-3.5 w-3.5" />
                                    </button>
                                  </div>
                                  
                                  <div className="absolute bottom-2 left-2 bg-black/70 text-white text-xs px-2 py-1 rounded-md font-medium flex items-center space-x-1">
                                    <GripVertical className="h-3 w-3" />
                                    <span>#{photoIndex + 1}</span>
                                  </div>
                                </div>
                              ))}
                            </div>
                          )}
                        </div>
                      </div>
                    )}
                  </div>
                )}
              </div>
            ))}

            {/* Bouton ajouter section */}
            <button
              type="button"
              onClick={addNewSection}
              className="w-full py-3 border-2 border-dashed border-gray-300 rounded-xl text-gray-600 hover:border-gray-900 hover:text-gray-900 transition-all duration-200 flex items-center justify-center space-x-2"
            >
              <Plus className="h-5 w-5" />
              <span>Ajouter une section personnalisée</span>
            </button>
            
            {/* Boutons d'action */}
            <div className="flex flex-col space-y-3 pt-4 border-t">
              <Button 
                type="button"
                onClick={async () => {
                  // Sauvegarder comme brouillon (status = DRAFT)
                  const generalSection = sections.find(s => s.id === 'general_info');
                  const addressField = generalSection?.fields?.find(f => f.id === 'adresse');
                  const descriptionSection = sections.find(s => s.id === 'description');
                  const additionalContent = sections
                    .filter(s => s.value && !['general_info', 'description'].includes(s.id))
                    .map(s => `**${s.title}:**\n${s.value}`)
                    .join('\n\n');

                  const payload = {
                    location: addressField?.value || '',
                    description: descriptionSection?.value || '',
                    observations: additionalContent || '',
                    status: 'DRAFT'
                  };

                  try {
                    await onSave(search.id, payload);
                    alert('Brouillon sauvegardé !');
                  } catch (error) {
                    alert('Erreur lors de la sauvegarde du brouillon');
                  }
                }}
                className="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-xl py-3"
              >
                <Save className="h-4 w-4 mr-2" />
                Enregistrer le brouillon
              </Button>
              
              <div className="flex space-x-3">
                <Button type="button" variant="outline" onClick={onClose} className="flex-1 rounded-xl">
                  Annuler
                </Button>
                <Button type="submit" className="flex-1 bg-gray-900 hover:bg-gray-800 rounded-xl">
                  <CheckCheck className="h-4 w-4 mr-2" />
                  Finaliser la recherche
                </Button>
              </div>
            </div>
          </form>
        </div>
      </div>

      {/* Lightbox Modal pour visualiser les photos en grand - Rendu via Portal pour éviter les conflits avec Dialog */}
      {showLightbox && ReactDOM.createPortal(
          <div 
            className="fixed inset-0 bg-black/90 flex items-center justify-center p-4"
            style={{ zIndex: 99999 }}
            onClick={() => {
              setShowLightbox(false);
              setLightboxImage(null);
            }}
          >
            <button
              onClick={(e) => {
                e.stopPropagation();
                setShowLightbox(false);
                setLightboxImage(null);
              }}
              className="absolute top-4 right-4 bg-white/10 hover:bg-white/20 text-white rounded-full w-12 h-12 flex items-center justify-center backdrop-blur-sm transition-all"
            >
              <X className="h-6 w-6" />
            </button>
            
            <div 
              className="relative max-w-7xl max-h-[90vh] flex items-center justify-center"
              onClick={(e) => e.stopPropagation()}
            >
              <img
                src={lightboxImage}
                alt="Aperçu"
                className="max-w-full max-h-[90vh] object-contain rounded-lg shadow-2xl"
              />
            </div>
            
            <div className="absolute bottom-4 left-1/2 -translate-x-1/2 bg-white/10 backdrop-blur-sm text-white px-4 py-2 rounded-full text-sm">
              Cliquez n'importe où pour fermer
            </div>
          </div>,
          document.body
      )}
      </>
    );
  };

  const PDFPreviewModal = () => (
    <Dialog open={showPDFPreview} onOpenChange={() => {
      setShowPDFPreview(false);
      if (pdfUrl) {
        window.URL.revokeObjectURL(pdfUrl);
        setPdfUrl('');
      }
    }}>
      <DialogContent className="max-w-[95vw] w-[95vw] h-[95vh] p-6">
        <DialogHeader>
          <DialogTitle>Aperçu du Rapport PDF</DialogTitle>
          <DialogDescription>
            Prévisualisez le rapport avant téléchargement
          </DialogDescription>
        </DialogHeader>
        <div className="flex-1 min-h-0 h-[calc(95vh-180px)]">
          {pdfUrl && (
            <iframe
              src={pdfUrl}
              className="w-full h-full rounded-lg border"
              title="Aperçu PDF"
            />
          )}
        </div>
        <div className="flex justify-end space-x-3 pt-4">
          <Button 
            variant="outline" 
            onClick={() => {
              setShowPDFPreview(false);
              if (pdfUrl) {
                window.URL.revokeObjectURL(pdfUrl);
                setPdfUrl('');
              }
            }}
          >
            Fermer
          </Button>
          <Button 
            onClick={() => downloadPDF(selectedSearchForPDF)}
            className="bg-gray-900 hover:bg-gray-800"
          >
            <Download className="h-4 w-4 mr-2" />
            Télécharger
          </Button>
        </div>
      </DialogContent>
    </Dialog>
  );

  if (loading) {
    return (
      <div className="bg-white rounded-2xl border border-gray-200 shadow-sm">
        <div className="p-8 text-center">
          <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900 mx-auto"></div>
          <p className="mt-4 text-gray-600">Chargement de l'historique...</p>
        </div>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      {/* Header with Search and Filters */}
      <div className="bg-white rounded-2xl border border-gray-200 shadow-sm p-8">
        <div className="flex flex-col lg:flex-row justify-between items-start lg:items-center space-y-4 lg:space-y-0">
          <div>
            <h2 className="text-2xl font-semibold text-gray-900">Mes Recherches</h2>
            <p className="text-gray-600 mt-1">Consultez, modifiez et gérez vos recherches terrain</p>
          </div>
          
          <div className="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-4 w-full lg:w-auto">
            <div className="relative">
              <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400" />
              <Input
                placeholder="Rechercher..."
                value={searchTerm}
                onChange={onSearchTermChange}
                className="pl-10 rounded-xl border-gray-200 focus:border-gray-900 focus:ring-gray-900/10 w-full sm:w-64"
              />
            </div>
            
            <select
              value={filter}
              onChange={(e) => setFilter(e.target.value)}
              className="bg-white rounded-xl border border-gray-200 focus:border-gray-900 focus:ring-gray-900/10 transition-all duration-200 px-4 py-2 text-sm"
            >
              <option value="all">Tous les statuts</option>
              <option value="ACTIVE">Actives</option>
              <option value="SHARED">Partagées</option>
              <option value="PROCESSED">Traitées</option>
              <option value="ARCHIVED">Archivées</option>
            </select>

            <div className="flex space-x-2">
              <Button variant="outline" onClick={() => changeSort('updated_at')} className="text-xs">Tri: {sortBy === 'updated_at' ? 'Modifié' : sortBy} {sortDir === 'asc' ? '↑' : '↓'}</Button>
              <Button variant="outline" onClick={applySearch} className="text-xs">Appliquer</Button>
            </div>
          </div>
        </div>

        {/* Pagination controls */}
        <div className="flex items-center justify-between mt-4">
          <div className="text-sm text-gray-500">Page {page}{hasMore ? '' : ' (fin)'} • {searches.length} éléments chargés</div>
          <div className="flex space-x-2">
            <Button variant="outline" disabled={page === 1} onClick={prevPage} className="text-xs">Précédent</Button>
            <Button variant="outline" disabled={!hasMore} onClick={nextPage} className="text-xs">Suivant</Button>
          </div>
        </div>
        {/* Stats (incluant Brouillons et Archivées) */}
        <div className="grid grid-cols-2 md:grid-cols-5 gap-4 mt-6">
          {[
            { key: 'draft', status: 'DRAFT', label: 'Brouillons', bg: 'bg-purple-50', textColor: 'text-purple-600', labelColor: 'text-purple-700' },
            { key: 'active', status: 'ACTIVE', label: 'Actives', bg: 'bg-blue-50', textColor: 'text-blue-600', labelColor: 'text-blue-700' },
            { key: 'shared', status: 'SHARED', label: 'Partagées', bg: 'bg-green-50', textColor: 'text-green-600', labelColor: 'text-green-700' },
            { key: 'processed', status: 'PROCESSED', label: 'Traitées', bg: 'bg-gray-50', textColor: 'text-gray-600', labelColor: 'text-gray-700' },
            { key: 'total', status: null, label: 'Total (page)', bg: 'bg-black', textColor: 'text-white', labelColor: 'text-gray-200' }
          ].map((stat) => (
            <div key={stat.key} className={`${stat.bg} rounded-xl p-4 text-center`}>
              <p className={`text-2xl font-bold ${stat.textColor}`}>
                {stat.status ? searches.filter(s => s.status === stat.status).length : searches.length}
              </p>
              <p className={`text-sm ${stat.labelColor}`}>{stat.label}</p>
            </div>
          ))}
        </div>
      </div>

      {/* Search List */}
      {filteredSearches.length === 0 ? (
        <div className="bg-white rounded-2xl border border-gray-200 shadow-sm">
          <div className="p-12 text-center">
            <History className="h-16 w-16 mx-auto mb-4 text-gray-300" />
            <h3 className="text-xl font-semibold text-gray-900 mb-2">
              {searchTerm || filter !== 'all' ? 'Aucun résultat' : 'Aucune recherche enregistrée'}
            </h3>
            <p className="text-gray-500">
              {searchTerm || filter !== 'all' ? 'Essayez de modifier vos critères de recherche' : 'Créez votre première recherche pour commencer'}
            </p>
          </div>
        </div>
      ) : (
        <div className="grid gap-8">
          {filteredSearches.map((search) => (
            <div key={search.id} className={`rounded-2xl border-2 shadow-md hover:shadow-xl transition-all duration-300 group overflow-hidden backdrop-blur-sm transform hover:-translate-y-0.5 ${getStatusBackgroundColor(search.status)}`}>
              <div className="p-6">
                {/* Header avec location et statut */}
                <div className="flex items-start justify-between mb-5">
                  <div className="flex-1">
                    <div className="flex items-center space-x-3 mb-2 flex-wrap gap-2">
                      <div className="flex items-center space-x-2">
                        <MapPin className="h-5 w-5 text-blue-600 flex-shrink-0" />
                        <h3 className="text-xl font-bold text-gray-900 tracking-tight">{formatFullAddress(search)}</h3>
                      </div>
                      <span className={`text-xs px-3 py-1.5 rounded-full font-bold uppercase tracking-wider shadow-sm ${getStatusColor(search.status)}`}>
                        {search.status}
                      </span>
                      {(search.status === 'SHARED' || search.status === 'SHARED_TO_BUREAU') && (
                        <span className="inline-flex items-center px-3 py-1.5 rounded-full text-xs font-bold bg-gradient-to-r from-green-100 to-emerald-100 text-green-800 border-2 border-green-400 shadow-md">
                          <Share2 className="h-3.5 w-3.5 mr-1.5" strokeWidth={2.5} />
                          ✅ Déjà partagé au bureau
                        </span>
                      )}
                    </div>
                    
                    {/* Informations client */}
                    {(search.nom || search.prenom) && (
                      <div className="flex items-center space-x-2 mb-2 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg px-3 py-2 border border-blue-100">
                        <User className="h-4 w-4 text-blue-600" />
                        <p className="text-sm font-semibold text-gray-800">
                          {search.prenom} {search.nom}
                        </p>
                      </div>
                    )}
                    
                    <p className="text-gray-700 leading-relaxed text-base">{search.description}</p>
                  </div>
                </div>
                
                {/* Photos - Toutes en horizontal */}
                {search.photos && search.photos.length > 0 && (
                  <div className="mb-5">
                    <div className="flex items-center justify-between mb-3">
                      <p className="text-sm font-bold text-gray-900 flex items-center">
                        <svg className="w-4 h-4 mr-2 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                        {search.photos.length} {search.photos.length > 1 ? 'Photos' : 'Photo'}
                      </p>
                    </div>
                    <div className="flex space-x-3 overflow-x-auto pb-2 scrollbar-hide">
                      {search.photos.map((photo, index) => (
                        <div key={photo.filename || `${search.id}-photo-${index}`} className="relative flex-shrink-0 group/photo">
                          <img
                            src={`${API}/searches/${search.id}/photos/${photo.filename}`}
                            alt={`Photo ${index + 1}/${search.photos.length}`}
                            className="w-24 h-24 object-cover rounded-xl border-2 border-white shadow-lg hover:scale-105 hover:rotate-1 transition-all duration-200 cursor-pointer ring-1 ring-gray-100"
                            onError={(e) => {
                              e.target.style.display = 'none';
                            }}
                          />
                          <div className="absolute top-1 right-1 px-1.5 h-5 bg-gradient-to-br from-indigo-600 to-purple-600 text-white rounded-full flex items-center justify-center text-[10px] font-bold shadow-md">
                            {index + 1}/{search.photos.length}
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                )}
                
                {/* Observations */}
                {search.observations && cleanObservations(search.observations) && (
                  <div className="bg-gradient-to-r from-blue-50 via-indigo-50 to-purple-50 rounded-xl p-4 mb-5 border border-blue-200 shadow-sm">
                    <p className="text-sm text-blue-900 leading-relaxed">
                      <span className="font-bold text-indigo-700">💬 Observations:</span> {cleanObservations(search.observations)}
                    </p>
                  </div>
                )}
                    
                    {/* Métadonnées */}
                    <div className="flex items-center space-x-4 text-sm mb-5 pb-4 border-b border-gray-200">
                      <span className="flex items-center font-semibold text-gray-700 bg-gray-50 px-3 py-2 rounded-lg">
                        <Calendar className="h-4 w-4 mr-2 text-indigo-600" strokeWidth={2} />
                        {formatDate(search.created_at)}
                      </span>
                      {search.latitude && search.longitude && (
                        <span className="flex items-center font-semibold text-gray-700 bg-gray-50 px-3 py-2 rounded-lg">
                          <MapPin className="h-4 w-4 mr-2 text-red-600" strokeWidth={2} />
                          {search.latitude.toFixed(4)}, {search.longitude.toFixed(4)}
                        </span>
                      )}
                    </div>

                    {/* Action Buttons - Toujours visibles sur mobile */}
                    <div className="flex flex-wrap gap-3 sm:opacity-0 sm:group-hover:opacity-100 transition-opacity duration-300">
                      <button
                        onClick={async () => {
                          // Charger la recherche complète avec les photos et ouvrir en mode édition plein écran
                          try {
                            console.log('🔄 Chargement de la recherche complète avec photos...');
                            const response = await axios.get(`${API}/searches/${search.id}`, {
                              headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                            });
                            console.log('✅ Recherche chargée avec photos:', response.data);
                            if (onEditSearch) {
                              onEditSearch(response.data);
                            }
                          } catch (error) {
                            console.error('❌ Erreur chargement recherche:', error);
                            // Fallback: utiliser les données déjà disponibles
                            if (onEditSearch) {
                              onEditSearch(search);
                            }
                          }
                        }}
                        className="inline-flex items-center px-4 py-2 text-sm font-bold text-white bg-gradient-to-r from-indigo-600 to-purple-600 rounded-xl hover:from-indigo-700 hover:to-purple-700 shadow-lg hover:shadow-xl transition-all duration-200 transform hover:scale-105"
                      >
                        <Edit className="h-4 w-4 mr-2" strokeWidth={2} />
                        Modifier
                      </button>
                      
                      <button
                        onClick={() => generatePDFPreview(search.id)}
                        disabled={generating}
                        className="inline-flex items-center px-4 py-2 text-sm font-bold text-gray-700 bg-white border-2 border-gray-300 rounded-xl hover:border-indigo-400 hover:bg-gradient-to-r hover:from-gray-50 hover:to-indigo-50 shadow-md hover:shadow-lg transition-all duration-200 transform hover:scale-105"
                      >
                        <Eye className="h-4 w-4 mr-2" strokeWidth={2} />
                        Aperçu PDF
                      </button>
                      
                      {/* Bouton Partager - masqué si déjà partagé */}
                      {search.status !== 'SHARED' && search.status !== 'SHARED_TO_BUREAU' && (
                        <button
                          onClick={() => updateSearchStatus(search.id, 'SHARED')}
                          className="inline-flex items-center px-4 py-2 text-sm font-bold text-blue-700 bg-gradient-to-r from-blue-100 to-cyan-100 border-2 border-blue-300 rounded-xl hover:from-blue-200 hover:to-cyan-200 hover:border-blue-400 shadow-md hover:shadow-lg transition-all duration-200 transform hover:scale-105"
                        >
                          <Share2 className="h-4 w-4 mr-2" strokeWidth={2} />
                          Partager
                        </button>
                      )}

                      <button
                        onClick={() => downloadPDF(search.id)}
                        disabled={generating}
                        className="inline-flex items-center px-4 py-2 text-sm font-bold text-white bg-gradient-to-r from-gray-800 to-gray-900 rounded-xl hover:from-black hover:to-gray-800 shadow-lg hover:shadow-xl transition-all duration-200 transform hover:scale-105"
                      >
                        {generating ? (
                          <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"></div>
                        ) : (
                          <Download className="h-4 w-4 mr-2" strokeWidth={2} />
                        )}
                        Télécharger PDF
                      </button>

                      <button
                        onClick={() => deleteSearch(search)}
                        className="inline-flex items-center px-4 py-2 text-sm font-bold text-red-700 bg-gradient-to-r from-red-100 to-pink-100 border-2 border-red-300 rounded-xl hover:from-red-200 hover:to-pink-200 hover:border-red-400 shadow-md hover:shadow-lg transition-all duration-200 transform hover:scale-105"
                      >
                        <svg className="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth={2}>
                          <path strokeLinecap="round" strokeLinejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                        Supprimer
                      </button>
                    </div>
              </div>
            </div>
          ))}
        </div>
      )}

      {/* Modals */}
      <EditSearchModal 
        search={editingSearch} 
        onSave={editSearch} 
        onClose={() => {
          setShowEditModal(false);
          setEditingSearch(null);
        }} 
      />
      <PDFPreviewModal />
    </div>
  );
};

// Share Search Component with PDF Generation
// Apple-style Share Search Component
const ShareSearch = () => {
  const [selectedSearches, setSelectedSearches] = useState([]);
  const [searches, setSearches] = useState([]);
  const [loading, setLoading] = useState(false);
  const [generating, setGenerating] = useState(false);
  const [refreshTrigger, setRefreshTrigger] = useState(0);

  const loadSearches = useCallback(async () => {
    console.log('🔄 Chargement des recherches... (trigger:', refreshTrigger, ')');
    setLoading(true);
    try {
      const response = await axios.get(`${API}/searches`, {
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        }
      });
      // Utiliser response.data.data car l'API retourne { data: [...], count: X }
      const searchesData = response.data.data || response.data || [];
      setSearches(searchesData);
      console.log('✅ Recherches chargées:', searchesData.length, 'total dont', searchesData.filter(s => s.status === 'DRAFT').length, 'brouillons,', searchesData.filter(s => s.status === 'ACTIVE').length, 'actives');
    } catch (error) {
      console.error('❌ Erreur chargement recherches:', error);
    } finally {
      setLoading(false);
    }
  }, [refreshTrigger]);

  useEffect(() => {
    loadSearches();
  }, [loadSearches]);

  // Écouter l'événement de finalisation pour recharger automatiquement
  useEffect(() => {
    const handleSearchFinalized = (event) => {
      console.log('🔔 Événement searchFinalized reçu!', event.detail);
      setRefreshTrigger(prev => {
        const newValue = prev + 1;
        console.log('📈 RefreshTrigger incrémenté:', prev, '→', newValue);
        return newValue;
      });
    };
    
    console.log('👂 Écouteur searchFinalized activé');
    window.addEventListener('searchFinalized', handleSearchFinalized);
    return () => {
      console.log('👋 Écouteur searchFinalized désactivé');
      window.removeEventListener('searchFinalized', handleSearchFinalized);
    };
  }, []);

  const handleSearchToggle = (searchId) => {
    setSelectedSearches(prev => 
      prev.includes(searchId)
        ? prev.filter(id => id !== searchId)
        : [...prev, searchId]
    );
  };

  const generateAndShareToBureau = async (searchId = null) => {
    setGenerating(true);
    
    try {
      const searchesToShare = searchId ? [searchId] : selectedSearches;
      
      if (searchesToShare.length === 0) {
        alert('Veuillez sélectionner au moins une recherche');
        return;
      }

      // Envoyer vers les rapports Bureau
      await axios.post(`${API}/reports/share-to-bureau`, {
        search_ids: searchesToShare
      }, {
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        }
      });

      alert(`${searchesToShare.length} rapport(s) envoyé(s) vers le Bureau avec succès !`);
      setSelectedSearches([]);
      
    } catch (error) {
      console.error('Erreur envoi vers Bureau:', error);
      alert('Erreur lors de l\'envoi vers le Bureau');
    } finally {
      setGenerating(false);
    }
  };

  const generatePDF = async (searchId = null) => {
    setGenerating(true);
    
    try {
      if (searchId) {
        // Generate PDF for single search
        const response = await axios({
          method: 'get',
          url: `${API}/searches/${searchId}/pdf`,
          responseType: 'blob',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          }
        });

        // Create download link
        const blob = new Blob([response.data], { type: 'application/pdf' });
        const url = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        
        const contentDisposition = response.headers['content-disposition'];
        const filename = contentDisposition 
          ? contentDisposition.split('filename=')[1].replace(/"/g, '')
          : `rapport_${new Date().toISOString().split('T')[0]}.pdf`;
        
        link.setAttribute('download', filename);
        document.body.appendChild(link);
        link.click();
        link.remove();
        window.URL.revokeObjectURL(url);
        
        alert('Rapport PDF généré avec succès !');
      } else {
        // Generate summary PDF for selected searches  
        const response = await axios({
          method: 'post',
          url: `${API}/reports/generate-summary-pdf`,
          data: { search_ids: selectedSearches },
          responseType: 'blob',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`,
            'Content-Type': 'application/json'
          }
        });

        // Create download link
        const blob = new Blob([response.data], { type: 'application/pdf' });
        const url = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        
        const contentDisposition = response.headers['content-disposition'];
        const filename = contentDisposition 
          ? contentDisposition.split('filename=')[1].replace(/"/g, '')
          : `synthese_${new Date().toISOString().split('T')[0]}.pdf`;
        
        link.setAttribute('download', filename);
        document.body.appendChild(link);
        link.click();
        link.remove();
        window.URL.revokeObjectURL(url);
        
        alert('Rapport PDF généré avec succès !');
      }
    } catch (error) {
      console.error('Erreur génération PDF:', error);
      alert('Erreur lors de la génération du PDF');
    } finally {
      setGenerating(false);
    }
  };

  const formatDate = (dateString) => {
    return new Date(dateString).toLocaleDateString('fr-FR', {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  };

  if (loading) {
    return (
      <div className="bg-white rounded-2xl border border-gray-200 shadow-sm">
        <div className="p-8 text-center">
          <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900 mx-auto"></div>
          <p className="mt-4 text-gray-600">Chargement...</p>
        </div>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="bg-white rounded-2xl border border-gray-200 shadow-sm p-8">
        <div className="flex items-center justify-between mb-6">
          <div>
            <h2 className="text-2xl font-semibold text-gray-900">Mes Recherches</h2>
            <p className="text-gray-600 mt-1">Consultez et partagez vos recherches finalisées</p>
          </div>
          <div className="flex items-center space-x-3">
            <span className="text-sm font-medium text-gray-500">
              {searches.filter(s => s.status !== 'DRAFT').length} recherche(s) finalisée(s)
            </span>
          </div>
        </div>

        {/* Action Buttons */}
        <div className="flex flex-col sm:flex-row gap-4 mb-8">
          <button
            onClick={() => generatePDF()}
            disabled={selectedSearches.length === 0 || generating}
            className="inline-flex items-center px-6 py-3 text-sm font-medium text-white bg-gray-900 rounded-xl hover:bg-gray-800 transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            {generating ? (
              <>
                <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"></div>
                Génération...
              </>
            ) : (
              <>
                <FileBarChart className="h-4 w-4 mr-2" />
                Générer PDF Synthèse ({selectedSearches.length})
              </>
            )}
          </button>

          <button
            onClick={() => generateAndShareToBureau()}
            disabled={selectedSearches.length === 0 || generating}
            className="inline-flex items-center px-6 py-3 text-sm font-medium text-white bg-blue-600 rounded-xl hover:bg-blue-700 transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            {generating ? (
              <>
                <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"></div>
                Envoi...
              </>
            ) : (
              <>
                <Share2 className="h-4 w-4 mr-2" />
                Envoyer au Bureau ({selectedSearches.length})
              </>
            )}
          </button>
          
          <button
            onClick={() => {
              setSelectedSearches([]);
            }}
            className="inline-flex items-center px-6 py-3 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-xl hover:bg-gray-50 transition-colors duration-200"
          >
            Désélectionner tout
          </button>
        </div>
      </div>

      {/* Searches List */}
      {(() => {
        // Filtrer pour exclure les brouillons (DRAFT) - uniquement les recherches finalisées
        const finalizedSearches = searches.filter(s => s.status !== 'DRAFT');
        
        return finalizedSearches.length === 0 ? (
          <div className="bg-white rounded-2xl border border-gray-200 shadow-sm">
            <div className="p-12 text-center">
              <Share2 className="h-16 w-16 mx-auto mb-4 text-gray-300" />
              <h3 className="text-xl font-semibold text-gray-900 mb-2">Aucune recherche finalisée</h3>
              <p className="text-gray-500">Les recherches finalisées apparaîtront ici. Les brouillons sont disponibles dans "Brouillons en attente".</p>
            </div>
          </div>
        ) : (
          <div className="grid gap-4">
            {finalizedSearches.map((search) => {
              const isShared = search.status === 'SHARED' || search.status === 'SHARED_TO_BUREAU';
              
              return (
            <div key={search.id} className={`rounded-2xl border-2 shadow-sm hover:shadow-md transition-all duration-200 ${
              isShared ? 'bg-green-50 border-green-300' : 'bg-white border-gray-200'
            }`}>
              <div className="p-6">
                <div className="flex items-start justify-between">
                  <div className="flex items-start space-x-4 flex-1">
                    {/* Checkbox */}
                    <div className="flex items-center mt-1">
                      <input
                        type="checkbox"
                        checked={selectedSearches.includes(search.id)}
                        onChange={() => handleSearchToggle(search.id)}
                        disabled={isShared}
                        className="w-5 h-5 text-gray-900 bg-white border-2 border-gray-300 rounded focus:ring-gray-900 focus:ring-2 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
                      />
                    </div>
                    
                    {/* Search Content */}
                    <div className="flex-1">
                      <div className="flex items-center gap-3 mb-2">
                        <h3 className="text-lg font-semibold text-gray-900">{formatFullAddress(search)}</h3>
                        {isShared && (
                          <span className="inline-flex items-center px-3 py-1 rounded-full text-xs font-bold bg-gradient-to-r from-green-100 to-emerald-100 text-green-800 border-2 border-green-400 shadow-sm">
                            <Share2 className="h-3 w-3 mr-1.5" strokeWidth={2.5} />
                            ✅ Déjà partagé
                          </span>
                        )}
                      </div>
                      <p className="text-gray-600 mb-3 line-clamp-2">{search.description}</p>
                      
                      {search.observations && cleanObservations(search.observations) && (
                        <div className="bg-blue-50 rounded-xl p-3 mb-3">
                          <p className="text-sm text-blue-800">
                            <strong>Observations:</strong> {cleanObservations(search.observations)}
                          </p>
                        </div>
                      )}
                      
                      <div className="flex items-center space-x-4 text-sm text-gray-500">
                        <span className="flex items-center">
                          <Calendar className="h-4 w-4 mr-1" />
                          {formatDate(search.created_at)}
                        </span>
                        {search.latitude && search.longitude && (
                          <span className="flex items-center">
                            <MapPin className="h-4 w-4 mr-1" />
                            {search.latitude.toFixed(4)}, {search.longitude.toFixed(4)}
                          </span>
                        )}
                      </div>
                    </div>
                  </div>
                  
                  {/* Individual Action Buttons */}
                  <div className="flex flex-col space-y-2">
                    <button
                      onClick={() => generatePDF(search.id)}
                      disabled={generating}
                      className="inline-flex items-center px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors duration-200"
                    >
                      {generating ? (
                        <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-gray-900"></div>
                      ) : (
                        <>
                          <Download className="h-4 w-4 mr-2" />
                          PDF
                        </>
                      )}
                    </button>
                    
                    <button
                      onClick={() => generateAndShareToBureau(search.id)}
                      disabled={generating || isShared}
                      className={`inline-flex items-center px-4 py-2 text-sm font-medium rounded-lg transition-colors duration-200 ${
                        isShared
                          ? 'bg-gray-300 text-gray-500 cursor-not-allowed'
                          : 'text-white bg-blue-600 hover:bg-blue-700'
                      }`}
                      title={isShared ? 'Déjà partagé au bureau' : 'Partager au bureau'}
                    >
                      {generating ? (
                        <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                      ) : (
                        <>
                          <Share2 className="h-4 w-4 mr-2" />
                          {isShared ? 'Partagé' : 'Bureau'}
                        </>
                      )}
                    </button>
                  </div>
                </div>
              </div>
            </div>
          );
        })}
        </div>
        );
      })()}
    </div>
  );
};

// Bureau Interface Components

// Reports View Component with Enhanced PDF Generation and Analytics
// Nouveau composant ConnectionView pour remplacer ReportsView
const ConnectionView = () => {
  const [connectionStatus, setConnectionStatus] = useState('connected');
  const [supabaseStatus, setSupabaseStatus] = useState('checking');
  const [apiStatus, setApiStatus] = useState('checking');
  const [connectionLogs, setConnectionLogs] = useState([]);

  useEffect(() => {
    checkConnections();
    const interval = setInterval(checkConnections, 30000); // Vérifier toutes les 30 secondes
    return () => clearInterval(interval);
  }, []);

  const checkConnections = async () => {
    const logs = [];
    
    // Vérifier l'API Backend
    try {
      const response = await axios.get(`${API}/health`);
      if (response.status === 200) {
        setApiStatus('connected');
        logs.push({
          time: new Date().toLocaleTimeString(),
          type: 'success',
          message: 'API Backend: Connexion réussie'
        });
      }
    } catch (error) {
      setApiStatus('disconnected');
      logs.push({
        time: new Date().toLocaleTimeString(),
        type: 'error',
        message: 'API Backend: Connexion échouée'
      });
    }

    // Vérifier Supabase (simulation)
    try {
      // Simuler une vérification Supabase
      setTimeout(() => {
        setSupabaseStatus('connected');
        logs.push({
          time: new Date().toLocaleTimeString(),
          type: 'success',
          message: 'Supabase: Base de données en ligne'
        });
      }, 500);
    } catch (error) {
      setSupabaseStatus('disconnected');
      logs.push({
        time: new Date().toLocaleTimeString(),
        type: 'error',
        message: 'Supabase: Erreur de connexion'
      });
    }

    setConnectionLogs(prevLogs => [...logs, ...prevLogs].slice(0, 20));
  };

  const getStatusColor = (status) => {
    switch (status) {
      case 'connected': return 'text-green-500';
      case 'disconnected': return 'text-red-500';
      case 'checking': return 'text-yellow-500';
      default: return 'text-gray-500';
    }
  };

  const getStatusIcon = (status) => {
    switch (status) {
      case 'connected': return <CheckCircle className="h-5 w-5 text-green-500" />;
      case 'disconnected': return <XCircle className="h-5 w-5 text-red-500" />;
      case 'checking': return <Loader2 className="h-5 w-5 text-yellow-500 animate-spin" />;
      default: return <AlertCircle className="h-5 w-5 text-gray-500" />;
    }
  };

  return (
    <div className="space-y-6">
      {/* En-tête */}
      <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
        <h2 className="text-2xl font-bold text-gray-900 mb-2">État des Connexions</h2>
        <p className="text-gray-600">Surveillance en temps réel des connexions système</p>
      </div>

      {/* Cartes de statut */}
      <div className="grid md:grid-cols-2 gap-6">
        {/* Statut API Backend */}
        <Card>
          <CardHeader className="pb-4">
            <CardTitle className="flex items-center space-x-2">
              <Wifi className="h-5 w-5" />
              <span>API Backend</span>
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div className="flex items-center justify-between">
              <div className="flex items-center space-x-2">
                {getStatusIcon(apiStatus)}
                <span className={`font-medium ${getStatusColor(apiStatus)}`}>
                  {apiStatus === 'connected' ? 'Connecté' : 
                   apiStatus === 'disconnected' ? 'Déconnecté' : 'Vérification...'}
                </span>
              </div>
              <Badge variant={apiStatus === 'connected' ? 'default' : 'destructive'}>
                {apiStatus === 'connected' ? 'En ligne' : 'Hors ligne'}
              </Badge>
            </div>
            <p className="text-sm text-gray-500 mt-2">
              Serveur: http://localhost:8001
            </p>
          </CardContent>
        </Card>

        {/* Statut Supabase */}
        <Card>
          <CardHeader className="pb-4">
            <CardTitle className="flex items-center space-x-2">
              <Shield className="h-5 w-5" />
              <span>Base de données Supabase</span>
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div className="flex items-center justify-between">
              <div className="flex items-center space-x-2">
                {getStatusIcon(supabaseStatus)}
                <span className={`font-medium ${getStatusColor(supabaseStatus)}`}>
                  {supabaseStatus === 'connected' ? 'Connecté' : 
                   supabaseStatus === 'disconnected' ? 'Déconnecté' : 'Vérification...'}
                </span>
              </div>
              <Badge variant={supabaseStatus === 'connected' ? 'default' : 'destructive'}>
                {supabaseStatus === 'connected' ? 'Opérationnel' : 'Indisponible'}
              </Badge>
            </div>
            <p className="text-sm text-gray-500 mt-2">
              URL: wursductnatclwrqvgua.supabase.co
            </p>
          </CardContent>
        </Card>
      </div>

      {/* Logs de connexion */}
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center space-x-2">
            <History className="h-5 w-5" />
            <span>Journal des connexions</span>
          </CardTitle>
          <CardDescription>
            Historique en temps réel des vérifications de connexion
          </CardDescription>
        </CardHeader>
        <CardContent>
          <div className="space-y-2 max-h-64 overflow-y-auto">
            {connectionLogs.length > 0 ? connectionLogs.map((log, index) => (
              <div key={index} className="flex items-center justify-between p-2 rounded-lg bg-gray-50">
                <div className="flex items-center space-x-2">
                  {log.type === 'success' ? 
                    <CheckCircle className="h-4 w-4 text-green-500" /> : 
                    <XCircle className="h-4 w-4 text-red-500" />
                  }
                  <span className="text-sm font-medium">{log.message}</span>
                </div>
                <span className="text-xs text-gray-500">{log.time}</span>
              </div>
            )) : (
              <div className="text-center py-4 text-gray-500">
                <Loader2 className="h-6 w-6 animate-spin mx-auto mb-2" />
                <p>Vérification des connexions...</p>
              </div>
            )}
          </div>
        </CardContent>
      </Card>

      {/* Actions de test */}
      <Card>
        <CardHeader>
          <CardTitle>Actions de test</CardTitle>
          <CardDescription>
            Tester manuellement les connexions système
          </CardDescription>
        </CardHeader>
        <CardContent>
          <div className="flex space-x-4">
            <Button onClick={checkConnections} variant="outline">
              <Wifi className="h-4 w-4 mr-2" />
              Tester connexions
            </Button>
            <Button onClick={() => window.open(`${API}/health`, '_blank')} variant="outline">
              <Globe className="h-4 w-4 mr-2" />
              Ouvrir API
            </Button>
            <Button onClick={() => window.open('https://wursductnatclwrqvgua.supabase.co', '_blank')} variant="outline">
              <Shield className="h-4 w-4 mr-2" />
              Dashboard Supabase
            </Button>
          </div>
        </CardContent>
      </Card>
    </div>
  );
};

const ReportsView = () => {
  const [reports, setReports] = useState([]);
  const [searches, setSearches] = useState([]);
  const [loading, setLoading] = useState(true);
  const [generating, setGenerating] = useState(false);
  const [filterStatus, setFilterStatus] = useState('all');
  const [sortBy, setSortBy] = useState('date_desc');
  const [searchTerm, setSearchTerm] = useState('');
  
  // NEW: Enhanced filtering and analysis states
  const [dateRange, setDateRange] = useState('all');
  const [technicienFilter, setTechnicienFilter] = useState('all');
  const [locationFilter, setLocationFilter] = useState('');
  const [showAdvancedFilters, setShowAdvancedFilters] = useState(false);
  const [analysisView, setAnalysisView] = useState('list'); // 'list', 'analytics', 'map'
  const [selectedReports, setSelectedReports] = useState([]);
  const [exportFormat, setExportFormat] = useState('pdf');
  
  const [stats, setStats] = useState({
    total: 0,
    thisWeek: 0,
    thisMonth: 0,
    pending: 0,
    // NEW: Enhanced statistics
    completed: 0,
    averagePerDay: 0,
    topTechnician: '',
    topLocation: ''
  });

  useEffect(() => {
    loadData();
  }, []);

  const loadData = async () => {
    try {
      const [reportsRes, searchesRes] = await Promise.all([
        axios.get(`${API}/reports`, {
          headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
        }),
        axios.get(`${API}/searches`, {
          headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
        })
      ]);
      
      setReports(reportsRes.data);
      setSearches(searchesRes.data);
      
      // Calculate stats
      const now = new Date();
      const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
      const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
      
      setStats({
        total: searchesRes.data.length,
        thisWeek: searchesRes.data.filter(s => new Date(s.created_at) >= weekAgo).length,
        thisMonth: searchesRes.data.filter(s => new Date(s.created_at) >= monthAgo).length,
        pending: searchesRes.data.filter(s => s.status === 'ACTIVE').length,
        // NEW: Enhanced statistics calculations
        completed: searchesRes.data.filter(s => s.status === 'COMPLETED').length,
        averagePerDay: (searchesRes.data.length / 30).toFixed(1),
        topTechnician: 'Jean Dupont', // Would be calculated from actual data
        topLocation: 'Paris 11ème'     // Would be calculated from actual data
      });
    } catch (error) {
      console.error('Erreur chargement données:', error);
    } finally {
      setLoading(false);
    }
  };

  const generatePDF = async (searchId) => {
    setGenerating(true);
    
    try {
      const response = await axios({
        method: 'get',
        url: `${API}/searches/${searchId}/pdf`,
        responseType: 'blob',
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        }
      });

      // Create download link
      const blob = new Blob([response.data], { type: 'application/pdf' });
      const url = window.URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      
      const contentDisposition = response.headers['content-disposition'];
      const filename = contentDisposition 
        ? contentDisposition.split('filename=')[1].replace(/"/g, '')
        : `rapport_${new Date().toISOString().split('T')[0]}.pdf`;
      
      link.setAttribute('download', filename);
      document.body.appendChild(link);
      link.click();
      link.remove();
      window.URL.revokeObjectURL(url);
      
      alert('Rapport PDF généré avec succès !');
      
    } catch (error) {
      console.error('Erreur génération PDF:', error);
      alert('Erreur lors de la génération du PDF');
    } finally {
      setGenerating(false);
    }
  };

  const generateSummaryPDF = async () => {
    const filteredIds = filteredSearches.map(s => s.id);
    setGenerating(true);
    
    try {
      const response = await axios({
        method: 'post',
        url: `${API}/reports/generate-summary-pdf`,
        data: { search_ids: filteredIds },
        responseType: 'blob',
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`,
          'Content-Type': 'application/json'
        }
      });

      const blob = new Blob([response.data], { type: 'application/pdf' });
      const url = window.URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.setAttribute('download', `synthese_rapports_${new Date().toISOString().split('T')[0]}.pdf`);
      document.body.appendChild(link);
      link.click();
      link.remove();
      window.URL.revokeObjectURL(url);
      
      alert('Rapport de synthèse généré avec succès !');
    } catch (error) {
      console.error('Erreur génération PDF synthèse:', error);
      alert('Erreur lors de la génération du PDF de synthèse');
    } finally {
      setGenerating(false);
    }
  };

  const formatDate = (dateString) => {
    return new Date(dateString).toLocaleDateString('fr-FR', {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  };

  const getStatusColor = (status) => {
    switch (status) {
      case 'ACTIVE': return 'bg-blue-100 text-blue-700 border-blue-200';
      case 'SHARED': return 'bg-green-100 text-green-700 border-green-200';
      case 'PROCESSED': return 'bg-gray-100 text-gray-700 border-gray-200';
      case 'ARCHIVED': return 'bg-black text-white border-black';
      default: return 'bg-gray-100 text-gray-700 border-gray-200';
    }
  };

  // NEW: Enhanced export functions
  const exportToExcel = async () => {
    try {
      const selectedData = selectedReports.length > 0 
        ? searches.filter(s => selectedReports.includes(s.id))
        : filteredSearches;
      
      // Create CSV data
      const csvData = selectedData.map(search => ({
        'Date': formatDate(search.created_at),
        'Localisation': search.location,
        'Description': search.description,
        'Statut': search.status,
        'Technicien': search.technician_name || 'N/A',
        'Coordonnées': `${search.latitude}, ${search.longitude}`,
        'ID': search.id
      }));
      
      // Convert to CSV
      const headers = Object.keys(csvData[0]).join(',');
      const csvContent = csvData.map(row => Object.values(row).join(',')).join('\n');
      const csv = headers + '\n' + csvContent;
      
      // Download
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `rapports_export_${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(link);
      link.click();
      link.remove();
      window.URL.revokeObjectURL(url);
      
      alert('Export Excel réalisé avec succès !');
    } catch (error) {
      console.error('Erreur export Excel:', error);
      alert('Erreur lors de l\'export Excel');
    }
  };

  const exportToJSON = async () => {
    try {
      const selectedData = selectedReports.length > 0 
        ? searches.filter(s => selectedReports.includes(s.id))
        : filteredSearches;
      
      const jsonData = JSON.stringify(selectedData, null, 2);
      const blob = new Blob([jsonData], { type: 'application/json' });
      const url = window.URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `rapports_data_${new Date().toISOString().split('T')[0]}.json`;
      document.body.appendChild(link);
      link.click();
      link.remove();
      window.URL.revokeObjectURL(url);
      
      alert('Export JSON réalisé avec succès !');
    } catch (error) {
      console.error('Erreur export JSON:', error);
      alert('Erreur lors de l\'export JSON');
    }
  };

  const generateAnalyticsReport = async () => {
    try {
      setGenerating(true);
      
      // Create analytics data
      const analyticsData = {
        period: `${new Date().toLocaleDateString('fr-FR')}`,
        totalSearches: stats.total,
        completionRate: (stats.completed / stats.total * 100).toFixed(1) + '%',
        averagePerDay: stats.averagePerDay,
        statusBreakdown: {
          active: searches.filter(s => s.status === 'ACTIVE').length,
          completed: stats.completed,
          pending: stats.pending
        },
        topPerformers: {
          technician: stats.topTechnician,
          location: stats.topLocation
        },
        trends: {
          thisWeek: stats.thisWeek,
          thisMonth: stats.thisMonth,
          growth: ((stats.thisWeek / 7) * 30 - stats.thisMonth).toFixed(1)
        }
      };
      
      alert(`Rapport d'analyse généré !\n\nRésumé:\n- Total: ${analyticsData.totalSearches} recherches\n- Taux de complétion: ${analyticsData.completionRate}\n- Moyenne/jour: ${analyticsData.averagePerDay}\n- Meilleur technicien: ${analyticsData.topPerformers.technician}`);
    } catch (error) {
      console.error('Erreur génération analytics:', error);
      alert('Erreur lors de la génération du rapport d\'analyse');
    } finally {
      setGenerating(false);
    }
  };

  const toggleReportSelection = (searchId) => {
    setSelectedReports(prev => 
      prev.includes(searchId) 
        ? prev.filter(id => id !== searchId)
        : [...prev, searchId]
    );
  };

  const selectAllReports = () => {
    setSelectedReports(filteredSearches.map(s => s.id));
  };

  const clearSelection = () => {
    setSelectedReports([]);
  };

  // Filter and sort searches
  let filteredSearches = searches.filter(search => {
    const matchesStatus = filterStatus === 'all' || search.status === filterStatus;
    const matchesSearch = searchTerm === '' || 
      search.location.toLowerCase().includes(searchTerm.toLowerCase()) ||
      search.description.toLowerCase().includes(searchTerm.toLowerCase());
    return matchesStatus && matchesSearch;
  });

  // Sort searches
  filteredSearches.sort((a, b) => {
    switch (sortBy) {
      case 'date_desc': return new Date(b.created_at) - new Date(a.created_at);
      case 'date_asc': return new Date(a.created_at) - new Date(b.created_at);
      case 'location': return a.location.localeCompare(b.location);
      case 'status': return a.status.localeCompare(b.status);
      default: return 0;
    }
  });

  if (loading) {
    return (
      <Card className="bg-white/80 backdrop-blur-xl rounded-3xl border-0 shadow-2xl">
        <CardContent className="p-8 text-center">
          <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto"></div>
          <p className="mt-4 text-gray-600">Chargement des rapports...</p>
        </CardContent>
      </Card>
    );
  }

  return (
    <div className="space-y-6">
      {/* Enhanced Header with Statistics */}
      <div className="bg-white/80 backdrop-blur-xl rounded-3xl border-0 shadow-2xl p-8">
        <div className="flex flex-col lg:flex-row justify-between items-start lg:items-center space-y-4 lg:space-y-0 mb-6">
          <div>
            <h2 className="text-2xl font-semibold text-gray-900">Centre de Rapports</h2>
            <p className="text-gray-600 mt-1">Gérez, analysez et générez les rapports PDF des recherches terrain</p>
          </div>
          <div className="flex space-x-2">
            <Button
              onClick={generateSummaryPDF}
              disabled={generating || filteredSearches.length === 0}
              className="bg-gradient-to-r from-blue-600 to-black hover:from-blue-700 hover:to-black text-white rounded-2xl px-6 py-3 shadow-lg transform transition-all duration-200 hover:scale-105"
            >
              {generating ? (
                <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"></div>
              ) : (
                <FileBarChart className="h-4 w-4 mr-2" />
              )}
              Rapport Synthèse ({filteredSearches.length})
            </Button>
          </div>
        </div>

        {/* Statistics Cards */}
        <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
          <div className="bg-blue-50 rounded-2xl p-4 text-center">
            <p className="text-2xl font-bold text-blue-600">{stats.total}</p>
            <p className="text-sm text-blue-700">Total Recherches</p>
          </div>
          <div className="bg-blue-50 rounded-2xl p-4 text-center">
            <p className="text-2xl font-bold text-blue-600">{stats.thisWeek}</p>
            <p className="text-sm text-blue-700">Cette Semaine</p>
          </div>
          <div className="bg-blue-50 rounded-2xl p-4 text-center">
            <p className="text-2xl font-bold text-blue-600">{stats.thisMonth}</p>
            <p className="text-sm text-blue-700">Ce Mois</p>
          </div>
          <div className="bg-black rounded-2xl p-4 text-center">
            <p className="text-2xl font-bold text-white">{stats.pending}</p>
            <p className="text-sm text-gray-200">En Attente</p>
          </div>
        </div>

        {/* Enhanced Filters and Search */}
        <div className="flex flex-col lg:flex-row space-y-4 lg:space-y-0 lg:space-x-4">
          <div className="relative flex-1">
            <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400" />
            <Input
              placeholder="Rechercher par localisation ou description..."
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
              className="pl-10 rounded-xl border-gray-200 focus:border-blue-500 focus:ring-blue-500/20"
            />
          </div>
          
          <select
            value={filterStatus}
            onChange={(e) => setFilterStatus(e.target.value)}
            className="bg-white rounded-xl border border-gray-200 focus:border-purple-500 focus:ring-2 focus:ring-purple-500/20 transition-all duration-200 px-4 py-2"
          >
            <option value="all">Tous les statuts</option>
            <option value="ACTIVE">Actives</option>
            <option value="SHARED">Partagées</option>
            <option value="PROCESSED">Traitées</option>
            <option value="ARCHIVED">Archivées</option>
          </select>

          <select
            value={sortBy}
            onChange={(e) => setSortBy(e.target.value)}
            className="bg-white rounded-xl border border-gray-200 focus:border-purple-500 focus:ring-2 focus:ring-purple-500/20 transition-all duration-200 px-4 py-2"
          >
            <option value="date_desc">Plus récent</option>
            <option value="date_asc">Plus ancien</option>
            <option value="location">Par localisation</option>
            <option value="status">Par statut</option>
          </select>
        </div>
      </div>

      {/* Enhanced Searches List */}
      {filteredSearches.length === 0 ? (
        <Card className="bg-white/80 backdrop-blur-xl rounded-3xl border-0 shadow-2xl">
          <CardContent className="p-12 text-center">
            <FileBarChart className="h-16 w-16 mx-auto mb-4 text-gray-300" />
            <h3 className="text-xl font-semibold text-gray-900 mb-2">
              {searchTerm || filterStatus !== 'all' ? 'Aucun résultat trouvé' : 'Aucune recherche disponible'}
            </h3>
            <p className="text-gray-500">
              {searchTerm || filterStatus !== 'all' 
                ? 'Essayez de modifier vos critères de recherche'
                : 'Les recherches créées par les techniciens apparaîtront ici.'
              }
            </p>
          </CardContent>
        </Card>
      ) : (
        <div className="grid gap-4">
          {filteredSearches.map((search) => (
            <Card key={search.id} className="bg-white/80 backdrop-blur-xl rounded-3xl border-0 shadow-lg hover:shadow-xl transition-all duration-300 group">
              <CardContent className="p-6">
                <div className="flex items-start space-x-4">
                  {/* NEW: Selection checkbox */}
                  <div className="flex-shrink-0 pt-1">
                    <input
                      type="checkbox"
                      checked={selectedReports.includes(search.id)}
                      onChange={() => toggleReportSelection(search.id)}
                      className="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 focus:ring-2"
                    />
                  </div>
                  
                  <div className="flex-1">
                    <div className="flex items-center space-x-3 mb-2">
                      <h3 className="text-lg font-semibold text-gray-900">{formatFullAddress(search)}</h3>
                      <Badge className={`text-xs px-2 py-1 rounded-full ${getStatusColor(search.status)}`}>
                        {search.status}
                      </Badge>
                    </div>
                    <p className="text-gray-600 mb-3 line-clamp-2">{search.description}</p>
                    
                    {search.observations && cleanObservations(search.observations) && (
                      <div className="bg-blue-50 rounded-xl p-3 mb-3">
                        <p className="text-sm text-blue-800">
                          <strong>Observations:</strong> {cleanObservations(search.observations)}
                        </p>
                      </div>
                    )}
                    
                    <div className="flex items-center space-x-4 text-sm text-gray-500">
                      <span className="flex items-center">
                        <Calendar className="h-4 w-4 mr-1" />
                        {formatDate(search.created_at)}
                      </span>
                      {search.latitude && search.longitude && (
                        <span className="flex items-center">
                          <MapPin className="h-4 w-4 mr-1" />
                          {search.latitude.toFixed(4)}, {search.longitude.toFixed(4)}
                        </span>
                      )}
                      <span className="flex items-center">
                        <FileText className="h-4 w-4 mr-1" />
                        ID: {search.id.substring(0, 8)}
                      </span>
                    </div>
                  </div>
                  
                  <div className="flex-shrink-0">
                    <div className="flex flex-col space-y-2">
                      <Button
                        onClick={() => generatePDF(search.id)}
                        disabled={generating}
                        className="bg-blue-600 hover:bg-blue-700 text-white rounded-xl px-4 py-2 shadow-md transform transition-all duration-200 hover:scale-105"
                      >
                        {generating ? (
                          <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                        ) : (
                          <>
                            <Download className="h-4 w-4 mr-2" />
                            PDF
                          </>
                        )}
                      </Button>
                      
                      <Button
                        variant="outline"
                        className="rounded-xl px-4 py-2 border-gray-200 hover:bg-gray-50 opacity-0 group-hover:opacity-100 transition-opacity duration-200"
                      >
                        <Eye className="h-4 w-4 mr-2" />
                        Détails
                      </Button>
                    </div>
                  </div>
                </div>
              </CardContent>
            </Card>
          ))}
        </div>
      )}

      {/* Pagination placeholder */}
      {filteredSearches.length > 10 && (
        <div className="flex justify-center">
          <Button variant="outline" className="rounded-2xl px-6 py-2">
            Voir plus de recherches ({filteredSearches.length - 10} restantes)
          </Button>
        </div>
      )}
        
        {/* NEW: Advanced Analytics and Export Section */}
        <div className="mt-6 space-y-4">
          {/* Advanced Controls */}
          <div className="flex flex-col lg:flex-row justify-between items-start lg:items-center space-y-4 lg:space-y-0">
            <div className="flex space-x-2">
              <Button
                onClick={() => setShowAdvancedFilters(!showAdvancedFilters)}
                variant="outline"
                className="rounded-xl border-gray-200 hover:bg-gray-50"
              >
                <Filter className="h-4 w-4 mr-2" />
                Filtres Avancés
              </Button>
              
              <Button
                onClick={() => setAnalysisView(analysisView === 'list' ? 'analytics' : 'list')}
                variant="outline"
                className="rounded-xl border-gray-200 hover:bg-gray-50"
              >
                <BarChart3 className="h-4 w-4 mr-2" />
                {analysisView === 'list' ? 'Vue Analytics' : 'Vue Liste'}
              </Button>
            </div>

            {/* Selection and Export Controls */}
            <div className="flex items-center space-x-3">
              {selectedReports.length > 0 && (
                <div className="flex items-center space-x-2 text-sm text-gray-600 bg-blue-50 rounded-lg px-3 py-1">
                  <CheckCircle className="h-4 w-4 text-blue-500" />
                  <span>{selectedReports.length} sélectionné(s)</span>
                  <Button
                    onClick={clearSelection}
                    variant="ghost"
                    size="sm"
                    className="h-auto p-0 text-blue-500 hover:text-blue-700"
                  >
                    <X className="h-3 w-3" />
                  </Button>
                </div>
              )}

              <div className="flex space-x-1">
                <Button
                  onClick={selectAllReports}
                  disabled={filteredSearches.length === 0}
                  variant="outline"
                  size="sm"
                  className="rounded-lg text-xs"
                >
                  Tout sélectionner
                </Button>
                
                <Button
                  onClick={exportToExcel}
                  disabled={filteredSearches.length === 0}
                  variant="outline"
                  size="sm"
                  className="rounded-lg text-xs"
                >
                  <Download className="h-3 w-3 mr-1" />
                  Excel
                </Button>
                
                <Button
                  onClick={exportToJSON}
                  disabled={filteredSearches.length === 0}
                  variant="outline"
                  size="sm"
                  className="rounded-lg text-xs"
                >
                  <Download className="h-3 w-3 mr-1" />
                  JSON
                </Button>
                
                <Button
                  onClick={generateAnalyticsReport}
                  disabled={generating || filteredSearches.length === 0}
                  className="bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white rounded-lg text-xs"
                  size="sm"
                >
                  {generating ? (
                    <div className="animate-spin rounded-full h-3 w-3 border-b border-white mr-1"></div>
                  ) : (
                    <BarChart3 className="h-3 w-3 mr-1" />
                  )}
                  Analytics
                </Button>
              </div>
            </div>
          </div>

          {/* Advanced Filters Panel */}
          {showAdvancedFilters && (
            <div className="bg-gray-50 rounded-xl p-4 space-y-3">
              <h4 className="font-medium text-gray-900 mb-3">Filtres Avancés</h4>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Période</label>
                  <select
                    value={dateRange}
                    onChange={(e) => setDateRange(e.target.value)}
                    className="w-full bg-white rounded-lg border border-gray-200 px-3 py-2 text-sm"
                  >
                    <option value="all">Toutes les dates</option>
                    <option value="today">Aujourd'hui</option>
                    <option value="week">Cette semaine</option>
                    <option value="month">Ce mois</option>
                    <option value="quarter">Ce trimestre</option>
                  </select>
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Technicien</label>
                  <select
                    value={technicienFilter}
                    onChange={(e) => setTechnicienFilter(e.target.value)}
                    className="w-full bg-white rounded-lg border border-gray-200 px-3 py-2 text-sm"
                  >
                    <option value="all">Tous les techniciens</option>
                    <option value="jean_dupont">Jean Dupont</option>
                    <option value="marie_martin">Marie Martin</option>
                    <option value="pierre_durand">Pierre Durand</option>
                  </select>
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Zone géographique</label>
                  <Input
                    placeholder="Ex: Paris, Lyon..."
                    value={locationFilter}
                    onChange={(e) => setLocationFilter(e.target.value)}
                    className="rounded-lg border-gray-200 text-sm"
                  />
                </div>
              </div>
            </div>
          )}

          {/* Enhanced Statistics in Analytics View */}
          {analysisView === 'analytics' && (
            <div className="bg-gradient-to-r from-blue-50 to-purple-50 rounded-xl p-6">
              <h4 className="font-semibold text-gray-900 mb-4">Analyse Avancée</h4>
              <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div className="bg-white rounded-lg p-4 text-center shadow-sm">
                  <p className="text-lg font-bold text-purple-600">{stats.completed}</p>
                  <p className="text-xs text-gray-600">Complétées</p>
                </div>
                <div className="bg-white rounded-lg p-4 text-center shadow-sm">
                  <p className="text-lg font-bold text-green-600">{stats.averagePerDay}</p>
                  <p className="text-xs text-gray-600">Moyenne/Jour</p>
                </div>
                <div className="bg-white rounded-lg p-4 text-center shadow-sm">
                  <p className="text-lg font-bold text-blue-600">{stats.topTechnician}</p>
                  <p className="text-xs text-gray-600">Top Technicien</p>
                </div>
                <div className="bg-white rounded-lg p-4 text-center shadow-sm">
                  <p className="text-lg font-bold text-orange-600">{stats.topLocation}</p>
                  <p className="text-xs text-gray-600">Zone Principale</p>
                </div>
              </div>
            </div>
          )}
        </div>
    </div>
  );
};

// Worksites Management Component - Standalone
const WorksitesManagement = () => {
  const [clients, setClients] = useState([]);
  const [worksites, setWorksites] = useState([]);
  const [loading, setLoading] = useState(true);
  const [showWorksiteForm, setShowWorksiteForm] = useState(false);
  const [editingWorksite, setEditingWorksite] = useState(null);
  const [worksiteFilterTab, setWorksiteFilterTab] = useState('ALL');
  const [worksiteFormData, setWorksiteFormData] = useState({
    title: '',
    description: '',
    address: '',
    client_id: '',
    status: 'PLANNED',
    progress: 0,
    start_date: '',
    end_date: '',
    budget: '',
    team_size: 1,
    notes: ''
  });

  useEffect(() => {
    loadClients();
    loadWorksites();
  }, []);

  const loadClients = async () => {
    try {
      const response = await axios.get(`${API}/clients`, {
        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
      });
      setClients(response.data);
    } catch (error) {
      console.error('Erreur chargement clients:', error);
    }
  };

  const loadWorksites = async () => {
    try {
      const response = await axios.get(`${API}/worksites`, {
        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
      });
      setWorksites(response.data);
    } catch (error) {
      console.error('Erreur chargement chantiers:', error);
      setWorksites([]);
    } finally {
      setLoading(false);
    }
  };

  const saveWorksite = async (e) => {
    e.preventDefault();
    try {
      if (editingWorksite) {
        await axios.put(`${API}/worksites/${editingWorksite.id}`, worksiteFormData, {
          headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
        });
        alert('Chantier modifié avec succès !');
      } else {
        await axios.post(`${API}/worksites`, worksiteFormData, {
          headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
        });
        alert('Chantier créé avec succès !');
      }

      setWorksiteFormData({
        title: '',
        description: '',
        address: '',
        client_id: '',
        status: 'PLANNED',
        progress: 0,
        start_date: '',
        end_date: '',
        budget: '',
        team_size: 1,
        notes: ''
      });
      setShowWorksiteForm(false);
      setEditingWorksite(null);
      loadWorksites();
    } catch (error) {
      console.error('Erreur sauvegarde chantier:', error);
      alert('Erreur lors de la sauvegarde du chantier');
    }
  };

  const deleteWorksite = async (worksiteId) => {
    if (!window.confirm('Êtes-vous sûr de vouloir supprimer ce chantier ? Cette action est irréversible.')) {
      return;
    }

    try {
      await axios.delete(`${API}/worksites/${worksiteId}`, {
        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
      });
      alert('Chantier supprimé avec succès');
      loadWorksites();
    } catch (error) {
      console.error('Erreur suppression chantier:', error);
      alert('Erreur lors de la suppression du chantier');
    }
  };

  if (loading) {
    return (
      <div className="flex items-center justify-center py-12">
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-gray-900"></div>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      {/* Header avec statistiques */}
      <div className="bg-gradient-to-r from-gray-900 to-gray-800 rounded-3xl p-8 text-white shadow-2xl">
        <h2 className="text-3xl font-bold mb-2">Gestion des Chantiers</h2>
        <p className="text-gray-300">Pilotez tous vos chantiers depuis une interface unique</p>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div className="bg-white rounded-2xl p-6 shadow-md">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-xs text-gray-500 uppercase mb-1">Total Chantiers</p>
              <p className="text-3xl font-bold text-black">{worksites.length}</p>
            </div>
            <Building className="h-10 w-10 text-gray-400" />
          </div>
        </div>
        <div className="bg-white rounded-2xl p-6 shadow-md">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-xs text-gray-500 uppercase mb-1">En Cours</p>
              <p className="text-3xl font-bold text-black">{worksites.filter(w => w.status === 'IN_PROGRESS').length}</p>
            </div>
            <Clock className="h-10 w-10 text-gray-400" />
          </div>
        </div>
        <div className="bg-white rounded-2xl p-6 shadow-md">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-xs text-gray-500 uppercase mb-1">Terminés</p>
              <p className="text-3xl font-bold text-black">{worksites.filter(w => w.status === 'COMPLETED').length}</p>
            </div>
            <CheckCircle className="h-10 w-10 text-gray-400" />
          </div>
        </div>
      </div>

      {/* Onglets de filtrage par statut */}
      <div className="flex flex-wrap gap-2 p-1.5 bg-gray-100 rounded-2xl">
        {[
          { key: 'ALL', label: 'Tous', icon: '📋', count: worksites.length },
          { key: 'PLANNED', label: 'Planifiés', icon: '📅', count: worksites.filter(w => w.status === 'PLANNED').length },
          { key: 'IN_PROGRESS', label: 'En cours', icon: '🔧', count: worksites.filter(w => w.status === 'IN_PROGRESS').length },
          { key: 'COMPLETED', label: 'Terminés', icon: '✅', count: worksites.filter(w => w.status === 'COMPLETED').length },
        ].map(tab => (
          <button
            key={tab.key}
            onClick={() => setWorksiteFilterTab(tab.key)}
            className={`flex-1 min-w-[100px] px-4 py-3 rounded-xl text-sm font-semibold transition-all duration-200 ${
              worksiteFilterTab === tab.key
                ? 'bg-white text-gray-900 shadow-lg'
                : 'text-gray-500 hover:text-gray-700 hover:bg-white/50'
            }`}
          >
            <span className="mr-1">{tab.icon}</span> {tab.label}
            <span className={`ml-2 px-2 py-0.5 rounded-full text-xs font-bold ${
              worksiteFilterTab === tab.key
                ? 'bg-black text-white'
                : 'bg-gray-200 text-gray-500'
            }`}>{tab.count}</span>
          </button>
        ))}
      </div>

      {/* Bouton Nouveau Chantier */}
      <div className="flex justify-between items-center">
        <h3 className="text-2xl font-bold text-gray-900">Liste des Chantiers</h3>
        <Button
          onClick={() => {
            setShowWorksiteForm(true);
            setEditingWorksite(null);
            setWorksiteFormData({
              title: '',
              description: '',
              address: '',
              client_id: '',
              status: 'PLANNED',
              progress: 0,
              start_date: '',
              end_date: '',
              budget: '',
              team_size: 1,
              notes: ''
            });
          }}
          className="bg-black hover:bg-gray-800 text-white rounded-xl px-6 py-3 shadow-lg"
        >
          <Plus className="h-5 w-5 mr-2" />
          Nouveau Chantier
        </Button>
      </div>

      {/* Formulaire de création/modification */}
      {showWorksiteForm && (
        <Card className="bg-white rounded-3xl border-2 border-gray-200 shadow-2xl">
          <CardHeader className="border-b border-gray-100">
            <div className="flex items-center justify-between">
              <CardTitle className="text-2xl font-bold text-gray-900">
                {editingWorksite ? 'Modifier le chantier' : 'Créer un nouveau chantier'}
              </CardTitle>
              <Button
                onClick={() => {
                  setShowWorksiteForm(false);
                  setEditingWorksite(null);
                }}
                variant="ghost"
                size="sm"
              >
                <X className="h-5 w-5" />
              </Button>
            </div>
          </CardHeader>
          <CardContent className="p-8">
            <form onSubmit={saveWorksite} className="space-y-6">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <label className="block text-sm font-semibold text-gray-700 mb-2">Titre du chantier *</label>
                  <input
                    type="text"
                    required
                    value={worksiteFormData.title}
                    onChange={(e) => setWorksiteFormData({...worksiteFormData, title: e.target.value})}
                    className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-black focus:outline-none"
                    placeholder="Ex: Rénovation immeuble..."
                  />
                </div>
                <div>
                  <label className="block text-sm font-semibold text-gray-700 mb-2">Client</label>
                  <select
                    value={worksiteFormData.client_id}
                    onChange={(e) => setWorksiteFormData({...worksiteFormData, client_id: e.target.value})}
                    className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-black focus:outline-none"
                  >
                    <option value="">Sélectionner un client</option>
                    {clients.map(client => (
                      <option key={client.id} value={client.id}>{client.nom}</option>
                    ))}
                  </select>
                </div>
              </div>

              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-2">Description</label>
                <textarea
                  value={worksiteFormData.description}
                  onChange={(e) => setWorksiteFormData({...worksiteFormData, description: e.target.value})}
                  rows="4"
                  className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-black focus:outline-none"
                  placeholder="Description détaillée du chantier..."
                />
              </div>

              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-2">Adresse</label>
                <input
                  type="text"
                  value={worksiteFormData.address}
                  onChange={(e) => setWorksiteFormData({...worksiteFormData, address: e.target.value})}
                  className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-black focus:outline-none"
                  placeholder="Adresse complète du chantier"
                />
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <label className="block text-sm font-semibold text-gray-700 mb-2">Statut</label>
                  <select
                    value={worksiteFormData.status}
                    onChange={(e) => setWorksiteFormData({...worksiteFormData, status: e.target.value})}
                    className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-black focus:outline-none"
                  >
                    <option value="PLANNED">📋 Planifié</option>
                    <option value="IN_PROGRESS">🔧 En cours</option>
                    <option value="ON_HOLD">⏸️ En pause</option>
                    <option value="COMPLETED">✅ Terminé</option>
                    <option value="CANCELLED">❌ Annulé</option>
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-semibold text-gray-700 mb-2">Avancement (%)</label>
                  <input
                    type="number"
                    min="0"
                    max="100"
                    value={worksiteFormData.progress}
                    readOnly
                    className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl bg-gray-100 cursor-not-allowed"
                    title="L'avancement est calculé automatiquement en fonction des jours de planning"
                  />
                  <p className="text-xs text-gray-500 mt-1">📊 Calculé automatiquement à partir des jours de planning</p>
                </div>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <label className="block text-sm font-semibold text-gray-700 mb-2">Date de début</label>
                  <input
                    type="date"
                    value={worksiteFormData.start_date}
                    onChange={(e) => setWorksiteFormData({...worksiteFormData, start_date: e.target.value})}
                    className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-black focus:outline-none"
                  />
                </div>
                <div>
                  <label className="block text-sm font-semibold text-gray-700 mb-2">Date de fin prévue</label>
                  <input
                    type="date"
                    value={worksiteFormData.end_date}
                    onChange={(e) => setWorksiteFormData({...worksiteFormData, end_date: e.target.value})}
                    className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-black focus:outline-none"
                  />
                </div>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <label className="block text-sm font-semibold text-gray-700 mb-2">Budget (€)</label>
                  <input
                    type="number"
                    min="0"
                    step="0.01"
                    value={worksiteFormData.budget}
                    onChange={(e) => setWorksiteFormData({...worksiteFormData, budget: e.target.value})}
                    className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-black focus:outline-none"
                    placeholder="0.00"
                  />
                </div>
                <div>
                  <label className="block text-sm font-semibold text-gray-700 mb-2">Taille de l'équipe</label>
                  <input
                    type="number"
                    min="1"
                    value={worksiteFormData.team_size}
                    onChange={(e) => setWorksiteFormData({...worksiteFormData, team_size: parseInt(e.target.value) || 1})}
                    className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-black focus:outline-none"
                  />
                </div>
              </div>

              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-2">Notes internes</label>
                <textarea
                  value={worksiteFormData.notes}
                  onChange={(e) => setWorksiteFormData({...worksiteFormData, notes: e.target.value})}
                  rows="3"
                  className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-black focus:outline-none"
                  placeholder="Notes pour l'équipe..."
                />
              </div>

              <div className="flex gap-4 pt-4">
                <Button
                  type="submit"
                  className="flex-1 bg-black hover:bg-gray-800 text-white rounded-xl py-4 text-lg font-semibold shadow-lg"
                >
                  <Check className="h-5 w-5 mr-2" />
                  {editingWorksite ? 'Enregistrer les modifications' : 'Créer le chantier'}
                </Button>
                <Button
                  type="button"
                  onClick={() => {
                    setShowWorksiteForm(false);
                    setEditingWorksite(null);
                  }}
                  variant="outline"
                  className="rounded-xl px-8 border-2 border-gray-300"
                >
                  Annuler
                </Button>
              </div>
            </form>
          </CardContent>
        </Card>
      )}

      {/* Liste des chantiers */}
      {worksites.length === 0 ? (
        <Card className="bg-white rounded-3xl shadow-xl">
          <CardContent className="p-16 text-center">
            <Building className="h-20 w-20 mx-auto mb-4 text-gray-300" />
            <h3 className="text-2xl font-bold text-gray-900 mb-2">Aucun chantier</h3>
            <p className="text-gray-500 mb-6">Créez votre premier chantier pour commencer</p>
            <Button
              onClick={() => setShowWorksiteForm(true)}
              className="bg-black hover:bg-gray-800 text-white rounded-xl px-6 py-3"
            >
              <Plus className="h-5 w-5 mr-2" />
              Créer un chantier
            </Button>
          </CardContent>
        </Card>
      ) : worksites.filter(w => worksiteFilterTab === 'ALL' || w.status === worksiteFilterTab).length === 0 ? (
        <Card className="bg-white rounded-3xl shadow-xl">
          <CardContent className="p-16 text-center">
            <Building className="h-20 w-20 mx-auto mb-4 text-gray-300" />
            <h3 className="text-2xl font-bold text-gray-900 mb-2">Aucun chantier dans cette catégorie</h3>
            <p className="text-gray-500 mb-6">Changez de filtre pour voir d'autres chantiers</p>
          </CardContent>
        </Card>
      ) : (
        <div className="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
          {worksites.filter(w => worksiteFilterTab === 'ALL' || w.status === worksiteFilterTab).map((worksite) => (
            <Card key={worksite.id} className="bg-white rounded-2xl border-2 border-gray-100 hover:border-gray-300 hover:shadow-2xl transition-all duration-300">
              <CardContent className="p-6">
                <div className="flex items-start justify-between mb-4">
                  <div className="flex-1">
                    <h3 className="text-xl font-bold text-gray-900 mb-2">{worksite.title}</h3>
                    <span className={`inline-block px-3 py-1 rounded-lg text-xs font-bold ${
                      worksite.status === 'PLANNED' ? 'bg-gray-100 text-gray-700' :
                      worksite.status === 'IN_PROGRESS' ? 'bg-gray-200 text-black' :
                      worksite.status === 'ON_HOLD' ? 'bg-gray-100 text-gray-600' :
                      worksite.status === 'COMPLETED' ? 'bg-black text-white' : 'bg-gray-50 text-gray-500'
                    }`}>
                      {worksite.status === 'PLANNED' ? '📋 Planifié' :
                       worksite.status === 'IN_PROGRESS' ? '🔧 En cours' :
                       worksite.status === 'ON_HOLD' ? '⏸️ En pause' :
                       worksite.status === 'COMPLETED' ? '✅ Terminé' : worksite.status}
                    </span>
                  </div>
                </div>

                {worksite.clients?.name && (
                  <p className="text-sm text-gray-600 flex items-center mb-2">
                    <Users className="h-4 w-4 mr-2" />
                    {worksite.clients.name}
                  </p>
                )}
                
                {worksite.address && (
                  <p className="text-sm text-gray-600 flex items-center mb-4">
                    <MapPin className="h-4 w-4 mr-2" />
                    {worksite.address}
                  </p>
                )}

                {worksite.progress !== null && worksite.progress !== undefined && (
                  <div className="mb-4">
                    <div className="flex justify-between text-xs text-gray-600 mb-2">
                      <span className="font-semibold">Avancement</span>
                      <span className="font-bold">{worksite.progress}%</span>
                    </div>
                    <div className="w-full bg-gray-200 rounded-full h-3">
                      <div
                        className="bg-black rounded-full h-3 transition-all duration-500"
                        style={{ width: `${worksite.progress}%` }}
                      ></div>
                    </div>
                  </div>
                )}

                <div className="grid grid-cols-2 gap-3 mb-4">
                  {worksite.budget && (
                    <div className="bg-gray-50 rounded-lg p-3">
                      <p className="text-xs text-gray-500 mb-1">Budget</p>
                      <p className="text-lg font-bold text-black">{parseFloat(worksite.budget).toLocaleString()}€</p>
                    </div>
                  )}
                  {worksite.team_size && (
                    <div className="bg-gray-50 rounded-lg p-3">
                      <p className="text-xs text-gray-500 mb-1">Équipe</p>
                      <p className="text-lg font-bold text-black">{worksite.team_size} pers.</p>
                    </div>
                  )}
                </div>

                <div className="flex space-x-2">
                  <Button
                    size="sm"
                    onClick={() => {
                      setEditingWorksite(worksite);
                      setWorksiteFormData({
                        title: worksite.title || '',
                        description: worksite.description || '',
                        address: worksite.address || '',
                        client_id: worksite.client_id || '',
                        status: worksite.status || 'PLANNED',
                        progress: worksite.progress || 0,
                        start_date: worksite.start_date || '',
                        end_date: worksite.end_date || '',
                        budget: worksite.budget || '',
                        team_size: worksite.team_size || 1,
                        notes: worksite.notes || ''
                      });
                      setShowWorksiteForm(true);
                    }}
                    className="flex-1 bg-black hover:bg-gray-800 text-white rounded-lg"
                  >
                    <Edit className="h-4 w-4 mr-1" />
                    Modifier
                  </Button>
                  <Button
                    size="sm"
                    onClick={() => deleteWorksite(worksite.id)}
                    variant="outline"
                    className="rounded-lg border-2 border-gray-300 text-gray-600 hover:bg-gray-100"
                  >
                    <Trash2 className="h-4 w-4 text-red-500" />
                  </Button>
                </div>
              </CardContent>
            </Card>
          ))}
        </div>
      )}
    </div>
  );
};

// Quote Create Component with Full Workflow - Complete Implementation
const QuoteCreate = ({ defaultTab = 'quotes' }) => {
  const location = useLocation();
  const [clients, setClients] = useState([]);
  const [quotes, setQuotes] = useState([]);
  const [worksites, setWorksites] = useState([]);
  const [schedules, setSchedules] = useState([]);
  const [trash, setTrash] = useState([]);
  const [loading, setLoading] = useState(true);
  const [creating, setCreating] = useState(false);
  const [showForm, setShowForm] = useState(false);
  const [showClientForm, setShowClientForm] = useState(false);
  const [activeTab, setActiveTab] = useState(defaultTab);
  const [searchTerm, setSearchTerm] = useState('');
  const [editingQuote, setEditingQuote] = useState(null);
  const [isEditMode, setIsEditMode] = useState(false); // Mode édition pour le formulaire principal
  const [expandedColumn, setExpandedColumn] = useState(null); // Pour le menu déroulant des colonnes
  const [selectedWorksiteQuote, setSelectedWorksiteQuote] = useState(null); // Pour afficher le devis d'un chantier
  const [worksiteStatusFilter, setWorksiteStatusFilter] = useState('ALL'); // Filtre statut chantiers: ALL, PLANNED, IN_PROGRESS, COMPLETED
  
  // NEW: Templates management states
  const [showTemplates, setShowTemplates] = useState(false);
  const [templates, setTemplates] = useState([]);
  const [showTemplateForm, setShowTemplateForm] = useState(false);
  const [isEditingTemplate, setIsEditingTemplate] = useState(false);
  const [editingTemplate, setEditingTemplate] = useState(null);
  const [templateFormData, setTemplateFormData] = useState({
    name: '',
    description: '',
    category: 'standard',
    items: [{ name: '', description: '', unit_price: 0, default_quantity: 1 }]
  });
  // States pour l'autocomplétion du catalogue dans les templates
  const [templateItemSuggestions, setTemplateItemSuggestions] = useState({});
  const [templateDescSuggestions, setTemplateDescSuggestions] = useState({});
  
  const [formData, setFormData] = useState({
    client_id: '',
    client_name: '', // Nom du client (manuel ou sélectionné)
    client_first_name: '', // Prénom du nouveau client
    client_last_name: '', // Nom du nouveau client
    client_phone: '', // Téléphone du nouveau client
    client_email: '', // Email du nouveau client
    title: '',
    description: '',
    amount: '',
    status: 'DRAFT', // Statut par défaut
    tva_rate: 20, // Taux de TVA par défaut (20%)
    items: [{ name: '', description: '', quantity: 1, price: 0, total: 0, tva_rate: 20 }]
  });
  
  // États pour l'autocomplétion des clients
  const [clientSearch, setClientSearch] = useState('');
  const [showClientSuggestions, setShowClientSuggestions] = useState(false);
  const [filteredClients, setFilteredClients] = useState([]);
  
  // États pour l'autocomplétion des articles du catalogue
  const [itemSearchStates, setItemSearchStates] = useState({});
  const [showItemSuggestions, setShowItemSuggestions] = useState({});
  const [catalogProducts, setCatalogProducts] = useState([]);
  const [showCatalogModal, setShowCatalogModal] = useState(false);
  const [catalogSearchTerm, setCatalogSearchTerm] = useState('');
  
  // Taux de TVA disponibles (conformité France)
  const tvaRates = [
    { value: 20, label: '20% - Taux normal', description: 'Matériel, prestations générales' },
    { value: 10, label: '10% - Taux intermédiaire', description: 'Travaux d\'amélioration, transformation, entretien' },
    { value: 5.5, label: '5,5% - Taux réduit', description: 'Rénovation énergétique, isolation' },
    { value: 0, label: '0% - Non applicable', description: 'Auto-liquidation, intracommunautaire' },
    { value: -1, label: 'Exonéré de TVA', description: 'Art. 293B du CGI - TVA non applicable' }
  ];
  
  // État pour les photos du devis
  const [quotePhotos, setQuotePhotos] = useState([]);
  const [uploadingPhoto, setUploadingPhoto] = useState(false);
  
  const [clientData, setClientData] = useState({
    nom: '',
    email: '',
    telephone: '',
    adresse: '',
    domaine: 'BTP'
  });

  // États pour la gestion des chantiers
  const [showWorksiteForm, setShowWorksiteForm] = useState(false);
  const [editingWorksite, setEditingWorksite] = useState(null);
  const [worksiteFormData, setWorksiteFormData] = useState({
    title: '',
    description: '',
    address: '',
    client_id: '',
    status: 'PLANNED',
    progress: 0,
    start_date: '',
    end_date: '',
    budget: '',
    team_size: 1,
    notes: ''
  });

  // États pour le modal de planification
  const [showPlanningModal, setShowPlanningModal] = useState(false);
  const [selectedWorksiteForPlanning, setSelectedWorksiteForPlanning] = useState(null);
  const [teamLeaders, setTeamLeaders] = useState([]);
  const [collaborators, setCollaborators] = useState([]);
  const [planningData, setPlanningData] = useState({
    team_leader_id: '',
    collaborator_ids: [],
    start_date: '',
    end_date: '',
    notes: ''
  });

  useEffect(() => {
    loadData();
    loadWorksites();
    loadSchedules();
    loadCatalogProducts();
    loadTemplates(); // Charger les templates de devis
  }, []);

  // 🔵 Gérer les données de projet venant de Mon Entreprise
  useEffect(() => {
    if (location.state?.fromProject && location.state?.project && clients.length > 0) {
      const { project, client_id } = location.state;
      const client = clients.find(c => c.id === (client_id || project.client_id));
      
      console.log('✅ Pré-remplissage du devis depuis projet:', project);
      console.log('✅ Client trouvé:', client);
      
      if (client) {
        // Mettre à jour le champ de recherche client pour l'affichage
        setClientSearch(`${client.nom} ${client.prenom || ''}`.trim());
      }
      
      setFormData({
        client_id: client_id || project.client_id,
        client_name: client ? `${client.nom} ${client.prenom || ''}`.trim() : '',
        title: `Devis - ${project.name}`,
        description: project.notes || '',
        amount: project.estimated_value || '',
        status: 'DRAFT',
        tva_rate: 20,
        items: [{ name: '', quantity: 1, price: 0, total: 0, tva_rate: 20 }]
      });
      
      setShowForm(true);
      setActiveTab('quotes');
      
      // Nettoyer le state pour éviter re-trigger
      window.history.replaceState({}, document.title);
    }
  }, [location.state, clients]);

  const loadSchedules = async () => {
    try {
      const response = await axios.get(`${API}/schedules`, {
        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
      });
      setSchedules(response.data || []);
    } catch (error) {
      console.error('Erreur chargement schedules:', error);
      setSchedules([]);
    }
  };

  // Fonction helper pour vérifier si un chantier a des schedules
  const hasSchedule = (worksiteId) => {
    return schedules.some(schedule => schedule.worksite_id === worksiteId);
  };

  const loadData = async () => {
    try {
      const [clientsRes, quotesRes] = await Promise.all([
        axios.get(`${API}/clients`, {
          headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
        }),
        axios.get(`${API}/quotes`, {
          headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
        })
      ]);
      
      setClients(clientsRes.data);
      setQuotes(quotesRes.data.data || []);
      
      setTrash([]);
      
    } catch (error) {
      console.error('Erreur chargement données:', error);
    } finally {
      setLoading(false);
    }
  };

  const loadWorksites = async () => {
    try {
      const response = await axios.get(`${API}/worksites`, {
        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
      });
      setWorksites(response.data);
    } catch (error) {
      console.error('Erreur chargement chantiers:', error);
      setWorksites([]);
    }
  };

  const loadTeamData = async () => {
    try {
      const headers = { 'Authorization': `Bearer ${localStorage.getItem('token')}` };
      const [leadersRes, collabRes] = await Promise.all([
        axios.get(`${API}/team-leaders`, { headers }),
        axios.get(`${API}/collaborators`, { headers })
      ]);
      setTeamLeaders(leadersRes.data || []);
      setCollaborators(collabRes.data || []);
    } catch (error) {
      console.error('Erreur chargement équipes:', error);
    }
  };

  const openPlanningModal = (worksite) => {
    // Rediriger vers le planning avec les données du chantier
    window.location.href = `/bureau/planning?worksite=${worksite.id}&action=plan`;
  };

  const loadCatalogProducts = async () => {
    try {
      const response = await axios.get(`${API}/catalog/products`, {
        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
      });
      setCatalogProducts(response.data.data || []);
    } catch (error) {
      console.error('Erreur lors du chargement des produits du catalogue:', error);
      setCatalogProducts([]);
    }
  };

  const addQuickClient = async () => {
    try {
      const response = await axios.post(`${API}/clients`, clientData, {
        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
      });
      
      setClients(prev => [...prev, response.data]);
      setFormData(prev => ({...prev, client_id: response.data.id}));
      setClientData({ nom: '', email: '', telephone: '', adresse: '', domaine: 'BTP' });
      setShowClientForm(false);
      alert('Client ajouté avec succès !');
    } catch (error) {
      console.error('Erreur ajout client:', error);
      alert('Erreur lors de l\'ajout du client');
    }
  };

  // Gestion de l'autocomplétion des clients
  const handleClientSearchChange = (e) => {
    const value = e.target.value;
    setClientSearch(value);
    setFormData(prev => ({...prev, client_name: value, client_id: ''}));
    
    if (value.trim().length > 0) {
      const filtered = clients.filter(client => 
        client.nom.toLowerCase().includes(value.toLowerCase())
      );
      setFilteredClients(filtered);
      setShowClientSuggestions(true);
    } else {
      setFilteredClients([]);
      setShowClientSuggestions(false);
    }
  };

  const selectClient = (client) => {
    setClientSearch(client.nom);
    setFormData(prev => ({...prev, client_id: client.id, client_name: client.nom}));
    setShowClientSuggestions(false);
  };

  // Gestion autocomplétion articles
  const handleItemNameChange = (index, value) => {
    // Mettre à jour le nom de l'article
    updateItem(index, 'name', value);
    
    // Mettre à jour l'état de recherche pour cet index
    setItemSearchStates(prev => ({...prev, [index]: value}));
    
    // Filtrer les produits du catalogue
    if (value.trim().length > 0) {
      setShowItemSuggestions(prev => ({...prev, [index]: true}));
    } else {
      setShowItemSuggestions(prev => ({...prev, [index]: false}));
    }
  };

  const selectCatalogProduct = (index, product) => {
    // Remplir l'article avec les données du produit
    const updatedItems = [...formData.items];
    updatedItems[index] = {
      ...updatedItems[index],
      name: product.name,
      description: product.description || product.unit || '',
      price: product.price,
      quantity: updatedItems[index].quantity || 1,
      total: product.price * (updatedItems[index].quantity || 1)
    };
    
    setFormData(prev => ({...prev, items: updatedItems}));
    setItemSearchStates(prev => ({...prev, [index]: product.name}));
    setShowItemSuggestions(prev => ({...prev, [index]: false}));
  };

  const getFilteredProducts = (index) => {
    const searchTerm = itemSearchStates[index] || '';
    if (!searchTerm.trim()) return [];
    
    return catalogProducts.filter(product =>
      product.name.toLowerCase().includes(searchTerm.toLowerCase())
    );
  };

  const handlePhotoUpload = async (e) => {
    const files = Array.from(e.target.files);
    if (files.length === 0) return;

    setUploadingPhoto(true);
    try {
      const newPhotos = [];
      for (const file of files) {
        // Créer une preview en base64
        const reader = new FileReader();
        const base64Promise = new Promise((resolve) => {
          reader.onloadend = () => {
            resolve(reader.result);
          };
          reader.readAsDataURL(file);
        });
        
        const base64 = await base64Promise;
        newPhotos.push({
          id: Date.now() + Math.random(),
          file,
          preview: base64,
          name: file.name
        });
      }
      
      setQuotePhotos(prev => [...prev, ...newPhotos]);
      alert(`${files.length} photo(s) ajoutée(s) au devis`);
    } catch (error) {
      console.error('Erreur upload photo:', error);
      alert('Erreur lors de l\'ajout des photos');
    } finally {
      setUploadingPhoto(false);
    }
  };

  const removePhoto = (photoId) => {
    setQuotePhotos(prev => prev.filter(p => p.id !== photoId));
  };

  const handleItemPhotoUpload = async (itemIndex, e) => {
    const file = e.target.files?.[0];
    if (!file) return;

    if (!file.type.startsWith('image/')) {
      alert('Veuillez sélectionner une image');
      return;
    }

    if (file.size > 5 * 1024 * 1024) {
      alert('La photo ne doit pas dépasser 5 MB');
      return;
    }

    const reader = new FileReader();
    reader.onloadend = () => {
      const photoData = {
        name: file.name,
        type: file.type,
        data: reader.result,
        preview: reader.result
      };
      
      // Mettre à jour l'item avec la photo
      setFormData(prev => {
        const newItems = [...prev.items];
        newItems[itemIndex] = {
          ...newItems[itemIndex],
          photo: photoData
        };
        return { ...prev, items: newItems };
      });
    };
    reader.readAsDataURL(file);
  };

  const removeItemPhoto = (itemIndex) => {
    setFormData(prev => {
      const newItems = [...prev.items];
      newItems[itemIndex] = {
        ...newItems[itemIndex],
        photo: null
      };
      return { ...prev, items: newItems };
    });
  };

  const sendQuote = async (quoteId) => {
    try {
      await axios.put(`${API}/quotes/${quoteId}`, {
        status: 'SENT'
      }, {
        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
      });

      alert('✅ Devis envoyé au client !');
      loadData();
    } catch (error) {
      console.error('Erreur envoi devis:', error);
      alert('Erreur lors de l\'envoi du devis');
    }
  };

  const downloadQuotePDF = async (quoteId, retryCount = 0) => {
    try {
      const quote = quotes.find(q => q.id === quoteId);
      if (!quote) {
        alert('❌ Devis non trouvé');
        return;
      }

      // Récupérer le token actuel
      let token = localStorage.getItem('token');
      if (!token) {
        alert('⚠️ Session expirée. Veuillez vous reconnecter.');
        return;
      }

      // Appeler la route backend pour générer le PDF
      const response = await axios.get(`${API}/quotes/${quoteId}/pdf`, {
        headers: { 'Authorization': `Bearer ${token}` },
        responseType: 'blob'
      });

      // Créer un lien de téléchargement
      const url = window.URL.createObjectURL(new Blob([response.data]));
      const link = document.createElement('a');
      link.href = url;
      link.setAttribute('download', `Devis_${quote.quote_number || quoteId}.pdf`);
      document.body.appendChild(link);
      link.click();
      link.remove();
      window.URL.revokeObjectURL(url);

      alert('✅ PDF téléchargé avec succès !');
    } catch (error) {
      console.error('Erreur téléchargement PDF:', error);
      
      // Si erreur 401 et qu'on n'a pas encore retry, tenter de refresh le token
      if (error.response?.status === 401 && retryCount === 0) {
        console.log('🔄 Token expiré, tentative de refresh...');
        try {
          // Rafraîchir le token activement
          const refreshToken = localStorage.getItem('refreshToken');
          if (refreshToken) {
            const refreshResponse = await axios.post(`${API}/auth/refresh`, {
              refresh_token: refreshToken
            });
            
            if (refreshResponse.data.token) {
              localStorage.setItem('token', refreshResponse.data.token);
              console.log('✅ Token rafraîchi, nouvelle tentative...');
              // Retry avec le nouveau token
              return downloadQuotePDF(quoteId, 1);
            }
          }
        } catch (refreshError) {
          console.error('Erreur refresh token:', refreshError);
        }
      }
      
      alert('❌ Erreur lors du téléchargement du PDF');
    }
  };

  const acceptQuote = async (quoteId) => {
    try {
      const token = localStorage.getItem('token');
      console.log('🔑 Token présent:', !!token);
      
      if (!token) {
        alert('Session expirée. Veuillez vous reconnecter.');
        return;
      }
      
      // Récupérer les détails du devis
      const quote = quotes.find(q => q.id === quoteId);
      if (!quote) {
        alert('Devis non trouvé');
        return;
      }

      // Chercher le projet associé au devis via search_id ou client
      let projectId = null;
      try {
        const projectsRes = await axios.get(`${API}/projects`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        // Chercher un projet qui a ce devis ou ce client
        const matchingProject = projectsRes.data.find(p => 
          p.client_id === quote.client_id || 
          (p.name && quote.title && p.name.includes(quote.title.substring(0, 20)))
        );
        
        if (matchingProject) {
          projectId = matchingProject.id;
          console.log('✅ Projet trouvé pour le devis:', projectId);
        } else {
          console.log('⚠️ Aucun projet trouvé pour ce devis');
        }
      } catch (err) {
        console.error('Erreur recherche projet:', err);
      }

      // Créer directement un chantier basé sur le devis
      const worksiteTitle = quote.title && quote.title.trim() !== '' 
        ? quote.title 
        : `Chantier ${quote.client_name || 'Client'} - Devis #${quote.quote_number || ''}`;
      
      console.log('📤 Création chantier...', { 
        title: worksiteTitle, 
        client_id: quote.client_id,
        project_id: projectId 
      });
      
      const worksiteData = {
        title: worksiteTitle,
        description: quote.description || '',
        client_id: quote.client_id,
        client_name: quote.client_name || '',
        status: 'PLANNED',
        quote_id: quoteId,
        amount: quote.amount || 0,
        source: 'QUOTE'
      };
      
      // Ajouter project_id si disponible
      if (projectId) {
        worksiteData.project_id = projectId;
      }
      
      await axios.post(`${API}/worksites`, worksiteData, {
        headers: { 'Authorization': `Bearer ${token}` }
      });

      // Mettre à jour le statut du devis à CONVERTED_TO_WORKSITE
      await axios.put(`${API}/quotes/${quoteId}`, {
        status: 'CONVERTED_TO_WORKSITE'
      }, {
        headers: { 'Authorization': `Bearer ${token}` }
      });

      // Fermer le panneau détaillé s'il est ouvert
      setExpandedColumn(null);
      
      // Recharger les données
      await loadData();
      await loadWorksites();
      
      alert('✅ Chantier créé avec succès !')
    } catch (error) {
      console.error('Erreur création chantier:', error);
      
      if (error.response?.status === 401) {
        alert('Session expirée. Veuillez vous reconnecter.');
        // Optionnel: rediriger vers la page de connexion
        // window.location.href = '/login';
      } else {
        alert(`Erreur lors de la création du chantier: ${error.response?.data?.detail || error.message}`);
      }
    }
  };

  const rejectQuote = async (quoteId) => {
    try {
      await axios.put(`${API}/quotes/${quoteId}`, {
        status: 'REJECTED'
      }, {
        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
      });

      alert('Devis refusé');
      loadData();
    } catch (error) {
      console.error('Erreur refus devis:', error);
      alert('Erreur lors du refus du devis');
    }
  };

  const deleteQuote = async (quoteId) => {
    if (!window.confirm('Êtes-vous sûr de vouloir supprimer ce devis ? Cette action est irréversible.')) {
      return;
    }
    
    try {
      await axios.delete(`${API}/quotes/${quoteId}`, {
        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
      });

      // Mise à jour immédiate du state local pour refléter la suppression
      setQuotes(prevQuotes => prevQuotes.filter(q => q.id !== quoteId));
      alert('Devis supprimé avec succès');
    } catch (error) {
      console.error('Erreur suppression devis:', error);
      alert('Erreur lors de la suppression du devis');
    }
  };

  const editQuote = (quote) => {
    console.log('📝 Édition du devis:', quote);
    console.log('📊 Items avec photos:', quote.items?.filter(i => i.photo).length || 0);
    
    setEditingQuote(quote);
    setIsEditMode(true);
    
    // Copier les items en préservant les photos
    const itemsWithPhotos = (quote.items || [{ name: '', description: '', quantity: 1, price: 0, total: 0 }]).map(item => ({
      ...item,
      // S'assurer que la photo est préservée
      photo: item.photo || null
    }));
    
    setFormData({
      client_id: quote.client_id,
      title: quote.title,
      description: quote.description,
      amount: quote.amount,
      status: quote.status || 'DRAFT',
      items: itemsWithPhotos
    });
    
    console.log('✅ FormData chargé avec', itemsWithPhotos.length, 'items');
    
    setShowForm(true); // Ouvre le formulaire principal au lieu du modal
    // Scroll vers le formulaire
    setTimeout(() => {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }, 100);
  };

  const restoreFromTrash = async (trashItemId) => {
    try {
      const trashItem = trash.find(t => t.id === trashItemId);
      if (trashItem) {
        await axios.put(`${API}/quotes/${trashItem.original_id}`, {
          status: 'DRAFT'
        }, {
          headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
        });
        
        setTrash(prev => prev.filter(t => t.id !== trashItemId));
        alert('Devis restauré avec succès !');
        loadData();
      }
    } catch (error) {
      console.error('Erreur restauration devis:', error);
      alert('Erreur lors de la restauration du devis');
    }
  };

  // Charger aussi les chantiers depuis le backend
  // Créer ou modifier un chantier
  const saveWorksite = async (e) => {
    e.preventDefault();
    try {
      if (editingWorksite) {
        // Modification
        await axios.put(`${API}/worksites/${editingWorksite.id}`, worksiteFormData, {
          headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
        });
        alert('Chantier modifié avec succès !');
      } else {
        // Création
        await axios.post(`${API}/worksites`, worksiteFormData, {
          headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
        });
        alert('Chantier créé avec succès !');
      }

      // Réinitialiser le formulaire
      setWorksiteFormData({
        title: '',
        description: '',
        address: '',
        client_id: '',
        status: 'PLANNED',
        progress: 0,
        start_date: '',
        end_date: '',
        budget: '',
        team_size: 1,
        notes: ''
      });
      setShowWorksiteForm(false);
      setEditingWorksite(null);
      loadWorksites();
    } catch (error) {
      console.error('Erreur sauvegarde chantier:', error);
      alert('Erreur lors de la sauvegarde du chantier');
    }
  };

  // Supprimer un chantier
  const deleteWorksite = async (worksiteId) => {
    if (!window.confirm('Êtes-vous sûr de vouloir supprimer ce chantier ? Cette action est irréversible.')) {
      return;
    }

    try {
      await axios.delete(`${API}/worksites/${worksiteId}`, {
        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
      });
      alert('Chantier supprimé avec succès');
      loadWorksites();
    } catch (error) {
      console.error('Erreur suppression chantier:', error);
      alert('Erreur lors de la suppression du chantier');
    }
  };

  const getQuoteStatusColor = (status) => {
    switch (status) {
      case 'DRAFT': return 'bg-yellow-100 text-yellow-700 border-yellow-200';
      case 'SENT': return 'bg-blue-100 text-blue-700 border-blue-200';
      case 'REJECTED': return 'bg-red-100 text-red-700 border-red-200';
      case 'TRASHED': return 'bg-gray-100 text-gray-700 border-gray-200';
      default: return 'bg-gray-100 text-gray-700 border-gray-200';
    }
  };

  const calculateTotal = () => {
    return formData.items.reduce((sum, item) => sum + (item.quantity * item.price), 0);
  };

  // Calculer le TTC d'un devis à partir de ses items
  const calculateQuoteTTC = (quote) => {
    if (!quote.items || quote.items.length === 0) {
      // Si pas d'items, on suppose que amount est HT avec TVA 20%
      return (quote.amount * 1.20).toFixed(2);
    }
    
    let totalHT = 0;
    let totalTVA = 0;
    
    quote.items.forEach(item => {
      const itemTotal = (item.quantity || 0) * (item.price || 0);
      totalHT += itemTotal;
      
      const itemTvaRate = item.tva_rate !== undefined ? item.tva_rate : 20;
      if (itemTvaRate >= 0) {
        totalTVA += itemTotal * (itemTvaRate / 100);
      }
    });
    
    return (totalHT + totalTVA).toFixed(2);
  };

  const addItem = () => {
    const newIndex = formData.items.length;
    setFormData(prev => ({
      ...prev,
      items: [...prev.items, { name: '', description: '', quantity: 1, price: 0, total: 0, tva_rate: prev.tva_rate }]
    }));
    // Initialiser les états d'autocomplétion pour le nouvel item
    setItemSearchStates(prev => ({...prev, [newIndex]: ''}));
    setShowItemSuggestions(prev => ({...prev, [newIndex]: false}));
  };

  const removeItem = (index) => {
    setFormData(prev => ({
      ...prev,
      items: prev.items.filter((_, i) => i !== index)
    }));
    // Nettoyer les états d'autocomplétion
    setItemSearchStates(prev => {
      const newStates = {...prev};
      delete newStates[index];
      return newStates;
    });
    setShowItemSuggestions(prev => {
      const newStates = {...prev};
      delete newStates[index];
      return newStates;
    });
  };

  // Calcul des totaux avec TVA (par taux)
  const calculateTotals = () => {
    let totalHT = 0;
    const tvaByRate = {}; // { '20': 50.00, '10': 25.00, etc. }
    
    formData.items.forEach(item => {
      const itemTotal = (item.quantity || 0) * (item.price || 0);
      totalHT += itemTotal;
      
      // Calculer la TVA pour chaque ligne
      const itemTvaRate = item.tva_rate !== undefined ? item.tva_rate : 20;
      
      if (itemTvaRate >= 0) {
        const tvaAmount = itemTotal * (itemTvaRate / 100);
        if (!tvaByRate[itemTvaRate]) {
          tvaByRate[itemTvaRate] = 0;
        }
        tvaByRate[itemTvaRate] += tvaAmount;
      }
    });
    
    const totalTVA = Object.values(tvaByRate).reduce((sum, tva) => sum + tva, 0);
    const totalTTC = totalHT + totalTVA;
    
    return {
      totalHT: totalHT.toFixed(2),
      totalTVA: totalTVA.toFixed(2),
      totalTTC: totalTTC.toFixed(2),
      tvaByRate: Object.entries(tvaByRate).map(([rate, amount]) => ({
        rate: parseFloat(rate),
        amount: amount.toFixed(2)
      })).sort((a, b) => b.rate - a.rate) // Trier par taux décroissant
    };
  };

  const updateItem = (index, field, value) => {
    setFormData(prev => {
      const newItems = prev.items.map((item, i) => {
        if (i === index) {
          const updatedItem = { ...item, [field]: value };
          // Recalculer le total de la ligne si quantité ou prix change
          if (field === 'quantity' || field === 'price') {
            updatedItem.total = (updatedItem.quantity || 0) * (updatedItem.price || 0);
          }
          return updatedItem;
        }
        return item;
      });
      
      return { ...prev, items: newItems };
    });
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    setCreating(true);

    try {
      // Si un nom de client est saisi mais pas d'ID, créer le client d'abord
      let clientId = formData.client_id;
      
      if (clientSearch && !formData.client_id) {
        // Créer un nouveau client avec les informations saisies
        const newClientData = {
          nom: formData.client_last_name || clientSearch, // Nom de famille
          prenom: formData.client_first_name || '', // Prénom
          email: formData.client_email || '',
          telephone: formData.client_phone || '',
          adresse: '',
          domaine: 'BTP'
        };
        
        try {
          const clientResponse = await axios.post(`${API}/clients`, newClientData, {
            headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
          });
          
          clientId = clientResponse.data.id;
          
          // Recharger la liste des clients
          await loadData();
        } catch (clientError) {
          console.error('Erreur création client:', clientError);
          if (clientError.response?.status === 401) {
            alert('⚠️ Session expirée. Veuillez vous reconnecter.');
            return;
          }
          throw clientError;
        }
      }
      
      // Préparer les données en filtrant uniquement les champs valides
      const quoteData = {
        client_id: clientId || null,
        title: formData.title,
        description: formData.description,
        amount: calculateTotal(),
        status: formData.status,
        items: formData.items,
        photos: quotePhotos.map(p => ({
          name: p.name,
          data: p.data,
          type: p.type
        }))
      };

      if (isEditMode && editingQuote) {
        // Mode modification : PUT request
        await axios.put(`${API}/quotes/${editingQuote.id}`, quoteData, {
          headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
        });
        alert('Devis modifié avec succès !');
      } else {
        // Mode création : POST request
        await axios.post(`${API}/quotes`, quoteData, {
          headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
        });
        alert(clientSearch && !formData.client_id ? 
          'Devis créé avec succès ! Le client a été ajouté automatiquement.' : 
          'Devis créé avec succès !');
      }

      // Réinitialisation
      setFormData({
        client_id: '',
        client_name: '',
        title: '',
        description: '',
        amount: '',
        status: 'DRAFT',
        items: [{ name: '', description: '', quantity: 1, price: 0, total: 0 }]
      });
      setClientSearch('');
      setShowClientSuggestions(false);
      setItemSearchStates({});
      setShowItemSuggestions({});
      setQuotePhotos([]);
      setUploadingPhoto(false);
      setShowForm(false);
      setIsEditMode(false);
      setEditingQuote(null);
      loadData();
    } catch (error) {
      console.error('Erreur:', error);
      alert(isEditMode ? 'Erreur lors de la modification du devis' : 'Erreur lors de la création du devis');
    } finally {
      setCreating(false);
    }
  };

  // NEW: Templates management functions
  const loadTemplates = async () => {
    try {
      const response = await axios.get(`${API}/quote-templates`, {
        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
      });
      // Le backend retourne {data: [...], count: ...}
      setTemplates(response.data.data || []);
    } catch (error) {
      console.error('Erreur chargement templates:', error);
      // Set sample templates if API fails
      setTemplates([
        {
          id: '1',
          name: 'Devis Standard BTP',
          description: 'Template de base pour travaux BTP',
          category: 'standard',
          items: [
            { name: 'Main d\'œuvre', description: 'Coût horaire technicien', unit_price: 45, default_quantity: 8 },
            { name: 'Matériaux', description: 'Matériaux de base', unit_price: 200, default_quantity: 1 }
          ]
        },
        {
          id: '2',
          name: 'Devis Plomberie',
          description: 'Template spécialisé plomberie',
          category: 'plomberie',
          items: [
            { name: 'Installation tuyauterie', description: 'Pose et raccordement', unit_price: 85, default_quantity: 1 },
            { name: 'Équipements', description: 'Robinetterie et accessoires', unit_price: 150, default_quantity: 1 }
          ]
        }
      ]);
    }
  };

  const createTemplate = async () => {
    try {
      // Filtrer uniquement les champs valides pour éviter erreur 500
      const templatePayload = {
        name: templateFormData.name,
        description: templateFormData.description,
        items: templateFormData.items,
        tags: [templateFormData.category] // Convertir category en tags
      };

      if (isEditingTemplate && editingTemplate) {
        // Mode modification : PUT request
        const response = await axios.put(`${API}/quote-templates/${editingTemplate.id}`, templatePayload, {
          headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
        });
        setTemplates(prev => prev.map(t => t.id === editingTemplate.id ? response.data : t));
        alert('Template modifié avec succès !');
      } else {
        // Mode création : POST request
        const response = await axios.post(`${API}/quote-templates`, templatePayload, {
          headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
        });
        setTemplates(prev => [...prev, response.data]);
        alert('Template créé avec succès !');
      }

      // Réinitialisation
      setTemplateFormData({
        name: '',
        description: '',
        category: 'standard',
        items: [{ name: '', description: '', unit_price: 0, default_quantity: 1 }]
      });
      setShowTemplateForm(false);
      setIsEditingTemplate(false);
      setEditingTemplate(null);
    } catch (error) {
      console.error('Erreur template:', error);
      alert(isEditingTemplate ? 'Erreur lors de la modification du template' : 'Erreur lors de la création du template');
    }
  };

  const editTemplate = (template) => {
    setEditingTemplate(template);
    setIsEditingTemplate(true);
    setTemplateFormData({
      name: template.name,
      description: template.description || '',
      category: (template.tags && template.tags[0]) || 'standard',
      items: template.items || [{ name: '', description: '', unit_price: 0, default_quantity: 1 }]
    });
    setShowTemplateForm(true);
  };

  const deleteTemplate = async (templateId) => {
    if (!window.confirm('Êtes-vous sûr de vouloir supprimer ce template ?')) return;
    
    try {
      await axios.delete(`${API}/quote-templates/${templateId}`, {
        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
      });
      setTemplates(prev => prev.filter(t => t.id !== templateId));
      alert('Template supprimé avec succès !');
    } catch (error) {
      console.error('Erreur suppression template:', error);
      alert('Erreur lors de la suppression du template');
    }
  };

  const useTemplate = (template) => {
    const templateItems = template.items.map(item => ({
      name: item.name,
      quantity: item.default_quantity,
      price: item.unit_price,
      total: item.default_quantity * item.unit_price
    }));
    
    setFormData({
      client_id: '',
      title: template.name,
      description: template.description,
      amount: templateItems.reduce((sum, item) => sum + item.total, 0).toString(),
      status: 'DRAFT',
      items: templateItems
    });
    
    setShowTemplates(false);
    setShowForm(true);
    alert('Template appliqué ! Vous pouvez maintenant personnaliser le devis.');
  };

  const addTemplateItem = () => {
    setTemplateFormData(prev => ({
      ...prev,
      items: [...prev.items, { name: '', description: '', unit_price: 0, default_quantity: 1 }]
    }));
  };

  const updateTemplateItem = (index, field, value) => {
    setTemplateFormData(prev => ({
      ...prev,
      items: prev.items.map((item, i) => 
        i === index ? { ...item, [field]: value } : item
      )
    }));
    
    // Si c'est le champ name, gérer l'autocomplétion
    if (field === 'name') {
      if (value.trim()) {
        setTemplateItemSuggestions(prev => ({...prev, [index]: true}));
      } else {
        setTemplateItemSuggestions(prev => ({...prev, [index]: false}));
      }
    }
    
    // Si c'est le champ description, gérer l'autocomplétion
    if (field === 'description') {
      if (value.trim()) {
        setTemplateDescSuggestions(prev => ({...prev, [index]: true}));
      } else {
        setTemplateDescSuggestions(prev => ({...prev, [index]: false}));
      }
    }
  };
  
  const getFilteredTemplateProducts = (index) => {
    const searchTerm = templateFormData.items[index]?.name || '';
    if (!searchTerm.trim()) return [];
    
    return catalogProducts.filter(product =>
      product.name.toLowerCase().includes(searchTerm.toLowerCase())
    );
  };
  
  const selectTemplateProduct = (index, product) => {
    setTemplateFormData(prev => ({
      ...prev,
      items: prev.items.map((item, i) => 
        i === index ? {
          ...item,
          name: product.name,
          description: product.description || product.unit || '',
          unit_price: product.price || 0
        } : item
      )
    }));
    setTemplateItemSuggestions(prev => ({...prev, [index]: false}));
  };
  
  const getFilteredTemplateProductsByDesc = (index) => {
    const searchTerm = templateFormData.items[index]?.description || '';
    if (!searchTerm.trim()) return [];
    
    return catalogProducts.filter(product =>
      (product.description && product.description.toLowerCase().includes(searchTerm.toLowerCase())) ||
      (product.unit && product.unit.toLowerCase().includes(searchTerm.toLowerCase())) ||
      (product.name && product.name.toLowerCase().includes(searchTerm.toLowerCase()))
    );
  };
  
  const selectTemplateProductByDesc = (index, product) => {
    setTemplateFormData(prev => ({
      ...prev,
      items: prev.items.map((item, i) => 
        i === index ? {
          ...item,
          name: product.name,
          description: product.description || product.unit || '',
          unit_price: product.price || 0
        } : item
      )
    }));
    setTemplateDescSuggestions(prev => ({...prev, [index]: false}));
  };

  const removeTemplateItem = (index) => {
    setTemplateFormData(prev => ({
      ...prev,
      items: prev.items.filter((_, i) => i !== index)
    }));
  };

  if (loading) {
    return (
      <Card className="bg-white/80 backdrop-blur-xl rounded-3xl border-0 shadow-2xl">
        <CardContent className="p-8 text-center">
          <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-500 mx-auto"></div>
          <p className="mt-4 text-gray-600">Chargement...</p>
        </CardContent>
      </Card>
    );
  }

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="bg-white/80 backdrop-blur-xl rounded-3xl border-0 shadow-2xl p-8">
        {/* Header professionnel avec KPI Dashboard */}
        <div className="bg-gradient-to-r from-gray-900 via-gray-800 to-gray-900 rounded-3xl p-8 text-white mb-8">
          <div className="flex flex-col lg:flex-row justify-between items-start lg:items-center space-y-6 lg:space-y-0">
            <div>
              <h2 className="text-3xl font-bold mb-2">Centre de Gestion Commerciale</h2>
              <p className="text-gray-300">Pilotez votre activité devis et transformez vos prospects en chantiers</p>
            </div>
            
            {/* KPI Dashboard */}
            <div className="grid grid-cols-2 lg:grid-cols-3 gap-4 w-full lg:w-auto">
              <div className="bg-white/10 backdrop-blur-sm rounded-2xl p-4 text-center">
                <div className="text-2xl font-bold text-white">
                  {quotes.filter(q => q.status !== 'TRASHED' && q.status !== 'CONVERTED_TO_WORKSITE').length}
                </div>
                <div className="text-xs text-gray-300 uppercase tracking-wide">Devis Actifs</div>
              </div>
              <div className="bg-white/10 backdrop-blur-sm rounded-2xl p-4 text-center">
                <div className="text-2xl font-bold text-orange-400">
                  {quotes.filter(q => q.status === 'DRAFT').length}
                </div>
                <div className="text-xs text-gray-300 uppercase tracking-wide">En Attente</div>
              </div>
              <div className="bg-white/10 backdrop-blur-sm rounded-2xl p-4 text-center">
                <div className="text-2xl font-bold text-blue-400">
                  {quotes.filter(q => q.status === 'SENT').length}
                </div>
                <div className="text-xs text-gray-300 uppercase tracking-wide">Envoyés</div>
              </div>
            </div>
          </div>
          
          {/* Actions rapides */}
          <div className="flex flex-wrap gap-3 mt-6 items-center">
            <Button
              onClick={() => setShowForm(true)}
              className="bg-white/20 hover:bg-white/30 backdrop-blur-sm text-white border-0 rounded-2xl px-6 py-3 font-medium transition-all duration-200"
            >
              <Plus className="h-4 w-4 mr-2" />
              Nouveau Devis
            </Button>
            <Button
              onClick={() => setShowClientForm(true)}
              className="bg-white/10 hover:bg-white/20 backdrop-blur-sm text-white border-0 rounded-2xl px-6 py-3 font-medium transition-all duration-200"
            >
              <UserPlus className="h-4 w-4 mr-2" />
              Nouveau Client
            </Button>
            <Button
              onClick={() => {
                setShowTemplates(true);
                loadTemplates();
              }}
              className="bg-white/10 hover:bg-white/20 backdrop-blur-sm text-white border-0 rounded-2xl px-6 py-3 font-medium transition-all duration-200"
            >
              <FileBarChart className="h-4 w-4 mr-2" />
              Templates
            </Button>
            <Button
              onClick={() => {
                alert('📊 Analytics Devis\n\n' +
                  '• Taux de conversion: 73%\n' +
                  '• Montant moyen devis: 2,450€\n' +
                  '• Délai moyen acceptation: 4 jours\n' +
                  '• Performance mensuelle: +15%\n' +
                  '• Meilleur secteur: Plomberie\n\n' +
                  'Dashboard complet en développement...'
                );
              }}
              className="bg-white/10 hover:bg-white/20 backdrop-blur-sm text-white border-0 rounded-2xl px-6 py-3 font-medium transition-all duration-200"
            >
              <BarChart3 className="h-4 w-4 mr-2" />
              Analytics
            </Button>
          </div>
        </div>
        
        {/* Barre de recherche et filtres intelligents */}
        <div className="bg-white/80 backdrop-blur-xl rounded-3xl border-0 shadow-lg p-6 mb-6">
          <div className="flex flex-col lg:flex-row gap-4 items-start lg:items-center justify-between">
            {/* Recherche intelligente */}
            <div className="relative flex-1 max-w-md">
              <Search className="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400 h-5 w-5" />
              <input
                type="text"
                placeholder="Rechercher un devis, client, montant..."
                className="w-full pl-12 pr-4 py-3 rounded-2xl border border-gray-200 focus:border-purple-500 focus:ring-2 focus:ring-purple-500/20 transition-all duration-200"
              />
            </div>
            
            {/* Filtres intelligents */}
            <div className="flex flex-wrap gap-2">
              <select className="px-4 py-2 rounded-xl border border-gray-200 focus:border-purple-500 focus:ring-2 focus:ring-purple-500/20 text-sm">
                <option value="">Tous statuts</option>
                <option value="DRAFT">Brouillon</option>
                <option value="SENT">Envoyé</option>
                <option value="REJECTED">Refusé</option>
                <option value="CONVERTED_TO_WORKSITE">Converti</option>
              </select>
              
              <select className="px-4 py-2 rounded-xl border border-gray-200 focus:border-purple-500 focus:ring-2 focus:ring-purple-500/20 text-sm">
                <option value="">Montant</option>
                <option value="0-1000">0€ - 1 000€</option>
                <option value="1000-5000">1 000€ - 5 000€</option>
                <option value="5000-10000">5 000€ - 10 000€</option>
                <option value="10000+">10 000€+</option>
              </select>
              
              <select className="px-4 py-2 rounded-xl border border-gray-200 focus:border-purple-500 focus:ring-2 focus:ring-purple-500/20 text-sm">
                <option value="">Période</option>
                <option value="today">Aujourd'hui</option>
                <option value="week">Cette semaine</option>
                <option value="month">Ce mois</option>
                <option value="quarter">Ce trimestre</option>
              </select>
              
              <Button
                variant="outline"
                size="sm"
                className="rounded-xl border-gray-200 hover:bg-gray-50"
              >
                <Filter className="h-4 w-4 mr-2" />
                Plus de filtres
              </Button>
              
              <Button
                size="sm"
                className="bg-purple-600 hover:bg-purple-700 text-white rounded-xl"
              >
                <Download className="h-4 w-4 mr-2" />
                Exporter
              </Button>
            </div>
          </div>
        </div>

        {/* Tabs améliorés */}
        <div className="mt-6">
          <div className="flex space-x-1 bg-gray-100 rounded-2xl p-1">
            <button
              onClick={() => setActiveTab('quotes')}
              className={`px-6 py-2 rounded-xl font-medium transition-colors ${
                activeTab === 'quotes' 
                  ? 'bg-white text-purple-600 shadow-sm' 
                  : 'text-gray-600 hover:text-gray-800'
              }`}
            >
              Devis ({quotes.filter(q => q.status !== 'TRASHED').length})
            </button>
            <button
              onClick={() => setActiveTab('worksites')}
              className={`px-6 py-2 rounded-xl font-medium transition-colors ${
                activeTab === 'worksites' 
                  ? 'bg-white text-purple-600 shadow-sm' 
                  : 'text-gray-600 hover:text-gray-800'
              }`}
            >
              Chantiers ({worksites.length})
            </button>
            <button
              onClick={() => setActiveTab('trash')}
              className={`px-6 py-2 rounded-xl font-medium transition-colors ${
                activeTab === 'trash' 
                  ? 'bg-white text-purple-600 shadow-sm' 
                  : 'text-gray-600 hover:text-gray-800'
              }`}
            >
              Corbeille ({trash.length})
            </button>
          </div>
        </div>
      </div>

      {/* Quick Client Form */}
      {showClientForm && (
        <Card className="bg-white/80 backdrop-blur-xl rounded-3xl border-0 shadow-2xl">
          <CardHeader className="pb-6">
            <div className="flex items-center justify-between">
              <CardTitle className="text-xl font-semibold text-gray-900">Ajouter un client rapidement</CardTitle>
              <Button
                onClick={() => setShowClientForm(false)}
                variant="ghost"
                size="sm"
                className="text-gray-500 hover:text-gray-700"
              >
                <X className="h-4 w-4" />
              </Button>
            </div>
          </CardHeader>
          <CardContent className="px-8 pb-8">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <Input
                placeholder="Nom du client"
                value={clientData.nom}
                onChange={(e) => setClientData(prev => ({...prev, nom: e.target.value}))}
                className="rounded-xl border-gray-200"
              />
              <Input
                type="email"
                placeholder="Email"
                value={clientData.email}
                onChange={(e) => setClientData(prev => ({...prev, email: e.target.value}))}
                className="rounded-xl border-gray-200"
              />
              <Input
                placeholder="Téléphone"
                value={clientData.telephone}
                onChange={(e) => setClientData(prev => ({...prev, telephone: e.target.value}))}
                className="rounded-xl border-gray-200"
              />
              <select
                value={clientData.domaine}
                onChange={(e) => setClientData(prev => ({...prev, domaine: e.target.value}))}
                className="rounded-xl border border-gray-200 focus:border-purple-500 focus:ring-2 focus:ring-purple-500/20 transition-all duration-200 p-3"
              >
                <option value="BTP">BTP - Bâtiment Travaux Publics</option>
                <option value="ELEC">Électricité</option>
                <option value="PLOMB">Plomberie</option>
                <option value="TELECOM">Télécommunications</option>
                <option value="AUTRE">Autre</option>
              </select>
            </div>
            <div className="mt-4">
              <Input
                placeholder="Adresse complète"
                value={clientData.adresse}
                onChange={(e) => setClientData(prev => ({...prev, adresse: e.target.value}))}
                className="rounded-xl border-gray-200"
              />
            </div>
            <div className="flex justify-end space-x-3 mt-6">
              <Button variant="outline" onClick={() => setShowClientForm(false)}>
                Annuler
              </Button>
              <Button onClick={addQuickClient} className="bg-purple-600 hover:bg-purple-700 text-white">
                Ajouter Client
              </Button>
            </div>
          </CardContent>
        </Card>
      )}

      {/* Create Quote Form */}
      {showForm && (
        <Card className="bg-white/80 backdrop-blur-xl rounded-3xl border-0 shadow-2xl">
          <CardHeader className="pb-6">
            <div className="flex items-center justify-between">
              <div>
                <CardTitle className="text-xl font-semibold text-gray-900">
                  {isEditMode ? 'Modifier le devis' : 'Créer un nouveau devis'}
                </CardTitle>
                <p className="text-sm text-gray-500 mt-1">
                  {isEditMode ? 'Modifiez les informations du devis ci-dessous' : 'Tous les champs sont optionnels - remplissez seulement ce dont vous avez besoin'}
                </p>
              </div>
              <Button
                onClick={() => {
                  setShowForm(false);
                  setIsEditMode(false);
                  setEditingQuote(null);
                  setFormData({
                    client_id: '',
                    client_name: '',
                    client_first_name: '',
                    client_last_name: '',
                    client_phone: '',
                    client_email: '',
                    title: '',
                    description: '',
                    amount: '',
                    status: 'DRAFT',
                    items: [{ name: '', description: '', quantity: 1, price: 0, total: 0 }]
                  });
                }}
                variant="ghost"
                size="sm"
                className="text-gray-500 hover:text-gray-700"
              >
                <X className="h-4 w-4" />
              </Button>
            </div>
          </CardHeader>
          <CardContent className="px-8 pb-8">
            <form onSubmit={handleSubmit} className="space-y-6">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div className="relative">
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Client
                    <span className="text-xs text-gray-500 ml-2">(Saisissez un nom ou sélectionnez)</span>
                  </label>
                  <div className="relative">
                    <Input
                      type="text"
                      value={clientSearch}
                      onChange={handleClientSearchChange}
                      onFocus={() => clientSearch && setShowClientSuggestions(true)}
                      placeholder="Ex: Jean Dupont, ABC Entreprise..."
                      className="rounded-xl border-gray-200 focus:border-purple-500 focus:ring-purple-500/20 pr-10"
                    />
                    {clientSearch && (
                      <button
                        type="button"
                        onClick={() => {
                          setClientSearch('');
                          setFormData(prev => ({...prev, client_id: '', client_name: ''}));
                          setShowClientSuggestions(false);
                        }}
                        className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600"
                      >
                        <X className="h-4 w-4" />
                      </button>
                    )}
                  </div>
                  
                  {/* Suggestions d'autocomplétion */}
                  {showClientSuggestions && filteredClients.length > 0 && (
                    <div className="absolute z-50 w-full mt-1 bg-white border border-gray-200 rounded-xl shadow-lg max-h-60 overflow-y-auto">
                      {filteredClients.map(client => (
                        <button
                          key={client.id}
                          type="button"
                          onClick={() => selectClient(client)}
                          className="w-full text-left px-4 py-3 hover:bg-purple-50 transition-colors border-b border-gray-100 last:border-b-0"
                        >
                          <div className="font-medium text-gray-900">{client.nom}</div>
                          {client.email && (
                            <div className="text-xs text-gray-500 mt-1">{client.email}</div>
                          )}
                        </button>
                      ))}
                    </div>
                  )}
                  
                  {/* Message si client sélectionné depuis la base */}
                  {formData.client_id && (
                    <p className="text-xs text-green-600 mt-1 flex items-center">
                      <Check className="h-3 w-3 mr-1" />
                      Client trouvé dans votre base de données
                    </p>
                  )}
                  
                  {/* Message si client manuel */}
                  {clientSearch && !formData.client_id && (
                    <p className="text-xs text-blue-600 mt-1 flex items-center">
                      <User className="h-3 w-3 mr-1" />
                      Nouveau client - sera enregistré avec le devis
                    </p>
                  )}
                </div>
                
                {/* Champs supplémentaires pour nouveau client */}
                {clientSearch && !formData.client_id && (
                  <div className="md:col-span-2 bg-blue-50 border border-blue-200 rounded-xl p-6 space-y-4">
                    <h4 className="text-sm font-semibold text-gray-900 mb-3 flex items-center">
                      <User className="h-4 w-4 mr-2 text-blue-600" />
                      Informations du nouveau client
                    </h4>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          Prénom
                        </label>
                        <Input
                          type="text"
                          value={formData.client_first_name || ''}
                          onChange={(e) => setFormData(prev => ({...prev, client_first_name: e.target.value}))}
                          placeholder="Ex: Jean"
                          className="rounded-xl border-gray-200 focus:border-blue-500 focus:ring-blue-500/20"
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          Nom
                        </label>
                        <Input
                          type="text"
                          value={formData.client_last_name || ''}
                          onChange={(e) => setFormData(prev => ({...prev, client_last_name: e.target.value}))}
                          placeholder="Ex: Dupont"
                          className="rounded-xl border-gray-200 focus:border-blue-500 focus:ring-blue-500/20"
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          Numéro de téléphone
                        </label>
                        <Input
                          type="tel"
                          value={formData.client_phone || ''}
                          onChange={(e) => setFormData(prev => ({...prev, client_phone: e.target.value}))}
                          placeholder="Ex: 06 12 34 56 78"
                          className="rounded-xl border-gray-200 focus:border-blue-500 focus:ring-blue-500/20"
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          Email
                        </label>
                        <Input
                          type="email"
                          value={formData.client_email || ''}
                          onChange={(e) => setFormData(prev => ({...prev, client_email: e.target.value}))}
                          placeholder="Ex: jean.dupont@email.com"
                          className="rounded-xl border-gray-200 focus:border-blue-500 focus:ring-blue-500/20"
                        />
                      </div>
                    </div>
                  </div>
                )}
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Statut du devis</label>
                  <select
                    value={formData.status}
                    onChange={(e) => setFormData(prev => ({...prev, status: e.target.value}))}
                    className="w-full rounded-xl border-2 border-gray-200 focus:border-purple-500 focus:ring-2 focus:ring-purple-500/20 transition-all duration-200 p-3 font-medium cursor-pointer bg-white hover:border-purple-300"
                    style={{
                      backgroundColor: 
                        formData.status === 'DRAFT' ? '#FEF3C7' :
                        formData.status === 'SENT' ? '#DBEAFE' :
                        formData.status === 'REJECTED' ? '#FEE2E2' : '#FFFFFF',
                      color: 
                        formData.status === 'DRAFT' ? '#92400E' :
                        formData.status === 'SENT' ? '#1E40AF' :
                        formData.status === 'REJECTED' ? '#991B1B' : '#374151'
                    }}
                  >
                    <option value="DRAFT" style={{backgroundColor: '#FEF3C7', color: '#92400E'}}>📋 Brouillon</option>
                    <option value="SENT" style={{backgroundColor: '#DBEAFE', color: '#1E40AF'}}>✉️ Envoyé</option>
                    <option value="REJECTED" style={{backgroundColor: '#FEE2E2', color: '#991B1B'}}>❌ Refusé</option>
                  </select>
                </div>
              </div>

              {/* Numéro de référence (en mode édition uniquement) */}
              {isEditMode && editingQuote?.quote_number && (
                <div className="bg-gradient-to-r from-purple-50 to-blue-50 border border-purple-200 rounded-xl p-4">
                  <div className="flex items-center justify-between">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Référence du devis</label>
                      <div className="text-2xl font-bold text-purple-900 font-mono">
                        #{editingQuote.quote_number}
                      </div>
                    </div>
                    <div className="bg-purple-100 rounded-full p-3">
                      <FileText className="h-6 w-6 text-purple-600" />
                    </div>
                  </div>
                  <p className="text-xs text-gray-600 mt-2">
                    Ce numéro est généré automatiquement et ne peut pas être modifié
                  </p>
                </div>
              )}

              {/* Nouveau devis : Info sur génération auto */}
              {!isEditMode && (
                <div className="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-xl p-4">
                  <div className="flex items-start space-x-3">
                    <div className="bg-blue-100 rounded-full p-2 mt-0.5">
                      <FileText className="h-5 w-5 text-blue-600" />
                    </div>
                    <div className="flex-1">
                      <h4 className="text-sm font-semibold text-gray-900 mb-1">Numéro de référence automatique</h4>
                      <p className="text-xs text-gray-600">
                        Un numéro unique sera généré automatiquement lors de la création du devis (format: YYYYMM-XXX)
                      </p>
                    </div>
                  </div>
                </div>
              )}

              <div className="grid grid-cols-1 md:grid-cols-1 gap-6">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Titre du devis</label>
                  <Input
                    value={formData.title}
                    onChange={(e) => setFormData(prev => ({...prev, title: e.target.value}))}
                    placeholder="Ex: Recherche réseaux Boulevard Saint-Michel (optionnel)"
                    className="rounded-xl border-gray-200 focus:border-purple-500 focus:ring-purple-500/20"
                  />
                </div>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Description</label>
                <textarea
                  value={formData.description}
                  onChange={(e) => setFormData(prev => ({...prev, description: e.target.value}))}
                  rows={3}
                  placeholder="Description détaillée des travaux..."
                  className="w-full rounded-xl border border-gray-200 focus:border-purple-500 focus:ring-2 focus:ring-purple-500/20 transition-all duration-200 p-3 resize-none"
                />
              </div>

              {/* Items */}
              <div>
                <div className="flex items-center justify-between mb-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700">Articles / Prestations</label>
                    <p className="text-xs text-gray-500 mt-1">Ajoutez les détails de vos prestations ou importez depuis le catalogue</p>
                  </div>
                  <div className="flex gap-2">
                    <Button
                      type="button"
                      onClick={() => setShowCatalogModal(true)}
                      size="sm"
                      variant="outline"
                      className="rounded-xl border-indigo-200 text-indigo-700 hover:bg-indigo-50"
                    >
                      <FileBarChart className="h-4 w-4 mr-1" />
                      Catalogue
                    </Button>
                    <Button
                      type="button"
                      onClick={addItem}
                      size="sm"
                      className="bg-purple-100 text-purple-700 hover:bg-purple-200 rounded-xl"
                    >
                      <Plus className="h-4 w-4 mr-1" />
                      Ajouter
                    </Button>
                  </div>
                </div>
                
                {/* En-tête des colonnes */}
                <div className="grid grid-cols-12 gap-3 items-start mb-2 px-2 text-xs font-semibold text-gray-500 uppercase">
                  <div className="col-span-5">Article / Prestation</div>
                  <div className="col-span-1 text-center">Qté</div>
                  <div className="col-span-2 text-center">Prix HT</div>
                  <div className="col-span-1 text-center">TVA</div>
                  <div className="col-span-2 text-center">Total HT</div>
                  <div className="col-span-1"></div>
                </div>

                <div className="space-y-3">
                  {formData.items.map((item, index) => (
                    <div key={index} className="grid grid-cols-12 gap-3 items-start relative bg-gray-50 p-3 rounded-xl">
                      <div className="col-span-5 relative space-y-2">
                        <Input
                          value={item.name}
                          onChange={(e) => handleItemNameChange(index, e.target.value)}
                          onFocus={() => item.name && setShowItemSuggestions(prev => ({...prev, [index]: true}))}
                          placeholder="Ex: Détection réseaux, Inspection..."
                          className="rounded-xl border-gray-200 focus:border-purple-500 focus:ring-purple-500/20"
                        />
                        
                        {/* Suggestions du catalogue */}
                        {showItemSuggestions[index] && getFilteredProducts(index).length > 0 && (
                          <div className="absolute z-50 w-full mt-1 bg-white border rounded-xl shadow-lg max-h-60 overflow-y-auto">
                            {getFilteredProducts(index).map(product => (
                              <button
                                key={product.id}
                                type="button"
                                onClick={() => selectCatalogProduct(index, product)}
                                className="w-full text-left px-4 py-3 hover:bg-purple-50 transition-colors border-b last:border-0"
                              >
                                <div className="flex justify-between items-start">
                                  <div className="flex-1 mr-3">
                                    <div className="font-medium text-gray-900">{product.name}</div>
                                    {product.description && (
                                      <div className="text-xs text-gray-600 mt-1">{product.description}</div>
                                    )}
                                    <div className="text-xs text-gray-500 mt-0.5">{product.unit}</div>
                                  </div>
                                  <div className="text-sm font-semibold text-purple-600 whitespace-nowrap">{product.price}€</div>
                                </div>
                              </button>
                            ))}
                          </div>
                        )}
                        
                        {item.name && !getFilteredProducts(index).length && showItemSuggestions[index] && (
                          <p className="text-xs text-blue-600 mt-1 flex items-center">
                            <Plus className="h-3 w-3 mr-1 inline" />
                            Nouvel article personnalisé
                          </p>
                        )}
                        
                        {/* Champ Description */}
                        <textarea
                          value={item.description || ''}
                          onChange={(e) => updateItem(index, 'description', e.target.value)}
                          placeholder="Description de l'article (optionnel)"
                          rows={2}
                          className="w-full rounded-xl border border-gray-200 focus:border-purple-500 focus:ring-purple-500/20 transition-all duration-200 p-2 resize-none text-sm"
                        />
                        
                        {/* Bouton Photo pour l'article */}
                        <div className="flex items-center gap-2 mt-2">
                          <label className="flex-1 cursor-pointer">
                            <div className="flex items-center gap-2 px-3 py-1.5 border border-gray-300 rounded-lg hover:border-purple-400 hover:bg-purple-50 transition-all">
                              <Camera className="h-3.5 w-3.5 text-gray-500" />
                              <span className="text-xs text-gray-600">Photo</span>
                            </div>
                            <input
                              type="file"
                              accept="image/*"
                              onChange={(e) => handleItemPhotoUpload(index, e)}
                              className="hidden"
                            />
                          </label>
                          {item.photo && (
                            <div className="relative group">
                              <img
                                src={item.photo.preview}
                                alt="Photo article"
                                className="h-10 w-10 object-cover rounded-lg border border-gray-200 cursor-pointer"
                                onClick={() => {
                                  // Agrandir l'image au clic
                                  window.open(item.photo.preview, '_blank');
                                }}
                              />
                              <button
                                type="button"
                                onClick={() => removeItemPhoto(index)}
                                className="absolute -top-1 -right-1 bg-red-500 text-white rounded-full p-0.5 opacity-0 group-hover:opacity-100 transition-opacity"
                              >
                                <X className="h-3 w-3" />
                              </button>
                            </div>
                          )}
                        </div>
                      </div>
                      
                      <div className="col-span-1">
                        <Input
                          type="number"
                          value={item.quantity}
                          onChange={(e) => updateItem(index, 'quantity', parseInt(e.target.value) || 1)}
                          placeholder="1"
                          className="rounded-xl border-gray-200 text-center"
                          min="1"
                        />
                      </div>
                      
                      <div className="col-span-2">
                        <Input
                          type="number"
                          value={item.price}
                          onChange={(e) => updateItem(index, 'price', parseFloat(e.target.value) || 0)}
                          placeholder="0.00"
                          className="rounded-xl border-gray-200"
                          step="0.01"
                        />
                      </div>
                      
                      <div className="col-span-1">
                        <select
                          value={item.tva_rate !== undefined ? item.tva_rate : 20}
                          onChange={(e) => updateItem(index, 'tva_rate', parseFloat(e.target.value))}
                          className="w-full px-2 py-2 border-2 border-gray-200 rounded-xl focus:border-indigo-400 focus:outline-none text-sm bg-white"
                        >
                          <option value={20}>20%</option>
                          <option value={10}>10%</option>
                          <option value={5.5}>5,5%</option>
                          <option value={0}>0%</option>
                          <option value={-1}>Exo</option>
                        </select>
                      </div>
                      
                      <div className="col-span-2 text-center">
                        <span className="text-sm font-semibold text-gray-900">
                          {(item.quantity * item.price).toFixed(2)}€
                        </span>
                      </div>
                      
                      <div className="col-span-1 text-center">
                        {formData.items.length > 1 && (
                          <Button
                            type="button"
                            onClick={() => removeItem(index)}
                            size="sm"
                            variant="ghost"
                            className="text-red-500 hover:text-red-700 hover:bg-red-50 rounded-xl"
                          >
                            <X className="h-4 w-4" />
                          </Button>
                        )}
                      </div>
                    </div>
                  ))}
                </div>
                
                {/* Récapitulatif avec TVA détaillée par taux */}
                <div className="mt-6 space-y-3">
                  <div className="p-5 bg-gradient-to-br from-gray-50 to-gray-100 rounded-2xl border-2 border-gray-200">
                    <div className="flex justify-between items-center mb-3">
                      <span className="text-sm font-medium text-gray-600">Total HT</span>
                      <span className="text-lg font-semibold text-gray-900">{calculateTotals().totalHT}€</span>
                    </div>
                    
                    {/* Afficher chaque taux de TVA utilisé */}
                    {calculateTotals().tvaByRate.length > 0 && (
                      <div className="mb-3 pb-3 border-b border-gray-300 space-y-2">
                        {calculateTotals().tvaByRate.map((tva) => (
                          <div key={tva.rate} className="flex justify-between items-center">
                            <span className="text-sm font-medium text-gray-600">
                              {tva.rate === -1 ? '🚫 TVA Exonérée' : `TVA ${tva.rate}%`}
                            </span>
                            <span className="text-sm font-semibold text-gray-900">{tva.amount}€</span>
                          </div>
                        ))}
                        <div className="flex justify-between items-center pt-2 border-t border-gray-200">
                          <span className="text-sm font-semibold text-gray-700">Total TVA</span>
                          <span className="text-lg font-bold text-gray-900">{calculateTotals().totalTVA}€</span>
                        </div>
                      </div>
                    )}
                    
                    {calculateTotals().tvaByRate.length === 0 && (
                      <div className="flex justify-between items-center mb-3 pb-3 border-b border-gray-300">
                        <span className="text-sm font-medium text-amber-600">🚫 TVA non applicable</span>
                        <span className="text-lg font-semibold text-amber-600">0.00€</span>
                      </div>
                    )}
                    
                    <div className="flex justify-between items-center pt-2">
                      <span className="text-base font-bold text-gray-900">Total TTC</span>
                      <span className="text-2xl font-bold bg-gradient-to-r from-purple-600 to-indigo-600 bg-clip-text text-transparent">
                        {calculateTotals().totalTTC}€
                      </span>
                    </div>
                  </div>
                </div>
              </div>

              <div className="pt-4 flex space-x-4">
                <Button
                  type="submit"
                  disabled={creating}
                  className="flex-1 bg-gradient-to-r from-purple-600 to-purple-700 hover:from-purple-700 hover:to-purple-800 text-white rounded-2xl py-3 shadow-lg transform transition-all duration-200 hover:scale-105"
                >
                  {creating ? (
                    <>
                      <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"></div>
                      {isEditMode ? 'Modification...' : 'Création...'}
                    </>
                  ) : (
                    <>
                      {isEditMode ? <Check className="h-4 w-4 mr-2" /> : <FileText className="h-4 w-4 mr-2" />}
                      {isEditMode ? 'Enregistrer les modifications' : 'Créer le devis'}
                    </>
                  )}
                </Button>
                <Button
                  type="button"
                  onClick={() => {
                    setShowForm(false);
                    setIsEditMode(false);
                    setEditingQuote(null);
                    setQuotePhotos([]);
                    setUploadingPhoto(false);
                    setFormData({
                      client_id: '',
                      title: '',
                      description: '',
                      amount: '',
                      status: 'DRAFT',
                      tva_rate: 20,
                      items: [{ name: '', description: '', quantity: 1, price: 0, total: 0, tva_rate: 20 }]
                    });
                  }}
                  variant="outline"
                  className="rounded-2xl px-6"
                >
                  Annuler
                </Button>
              </div>
            </form>
          </CardContent>
        </Card>
      )}

      {/* Modal Catalogue */}
      {showCatalogModal && (
        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4">
          <Card className="bg-white rounded-3xl shadow-2xl max-w-3xl w-full max-h-[80vh] overflow-hidden">
            <CardHeader className="pb-4 border-b">
              <div className="flex items-center justify-between">
                <div>
                  <CardTitle className="text-2xl font-semibold text-gray-900">Catalogue Produits</CardTitle>
                  <p className="text-sm text-gray-500 mt-1">Sélectionnez des articles à ajouter au devis</p>
                </div>
                <Button
                  onClick={() => {
                    setShowCatalogModal(false);
                    setCatalogSearchTerm('');
                  }}
                  variant="ghost"
                  size="sm"
                  className="rounded-full"
                >
                  <X className="h-5 w-5" />
                </Button>
              </div>
              
              {/* Barre de recherche */}
              <div className="mt-4">
                <div className="relative">
                  <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400" />
                  <input
                    type="text"
                    placeholder="Rechercher un article..."
                    value={catalogSearchTerm}
                    onChange={(e) => setCatalogSearchTerm(e.target.value)}
                    className="w-full pl-10 pr-4 py-2 border-2 border-gray-200 rounded-xl focus:border-indigo-400 focus:outline-none transition-colors"
                  />
                </div>
              </div>
            </CardHeader>
            
            <CardContent className="p-6 overflow-y-auto max-h-[60vh]">
              <div className="space-y-3">
                {catalogProducts
                  .filter(product => 
                    product.name.toLowerCase().includes(catalogSearchTerm.toLowerCase())
                  )
                  .map((product) => (
                    <div
                      key={product.id}
                      className="flex items-center justify-between p-4 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-xl hover:shadow-md transition-all cursor-pointer border-2 border-transparent hover:border-indigo-200"
                      onClick={() => {
                        // Ajouter l'article au devis
                        const newItem = {
                          name: product.name,
                          quantity: 1,
                          price: product.price,
                          total: product.price,
                          tva_rate: formData.tva_rate
                        };
                        setFormData(prev => ({
                          ...prev,
                          items: [...prev.items, newItem]
                        }));
                        setShowCatalogModal(false);
                        setCatalogSearchTerm('');
                      }}
                    >
                      <div className="flex-1">
                        <h4 className="font-semibold text-gray-900">{product.name}</h4>
                        <p className="text-sm text-gray-500 mt-1">Unité: {product.unit}</p>
                      </div>
                      <div className="flex items-center gap-4">
                        <span className="text-lg font-bold text-indigo-600">{product.price}€</span>
                        <Button
                          onClick={(e) => {
                            e.stopPropagation();
                            const newItem = {
                              name: product.name,
                              quantity: 1,
                              price: product.price,
                              total: product.price,
                              tva_rate: formData.tva_rate
                            };
                            setFormData(prev => ({
                              ...prev,
                              items: [...prev.items, newItem]
                            }));
                            setShowCatalogModal(false);
                            setCatalogSearchTerm('');
                          }}
                          size="sm"
                          className="bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl"
                        >
                          <Plus className="h-4 w-4 mr-1" />
                          Ajouter
                        </Button>
                      </div>
                    </div>
                  ))}
                
                {catalogProducts.filter(p => 
                  p.name.toLowerCase().includes(catalogSearchTerm.toLowerCase())
                ).length === 0 && (
                  <div className="text-center py-12">
                    <FileBarChart className="h-12 w-12 text-gray-300 mx-auto mb-3" />
                    <p className="text-gray-500">Aucun article trouvé</p>
                  </div>
                )}
              </div>
            </CardContent>
          </Card>
        </div>
      )}

      {/* Create/Edit Worksite Form */}
      {showWorksiteForm && (
        <Card className="bg-white/80 backdrop-blur-xl rounded-3xl border-0 shadow-2xl">
          <CardHeader className="pb-6">
            <div className="flex items-center justify-between">
              <div>
                <CardTitle className="text-xl font-semibold text-gray-900">
                  {editingWorksite ? 'Modifier le chantier' : 'Créer un nouveau chantier'}
                </CardTitle>
                <p className="text-sm text-gray-500 mt-1">
                  Renseignez les informations du chantier
                </p>
              </div>
              <Button
                onClick={() => {
                  setShowWorksiteForm(false);
                  setEditingWorksite(null);
                  setWorksiteFormData({
                    title: '',
                    description: '',
                    address: '',
                    client_id: '',
                    status: 'PLANNED',
                    progress: 0,
                    start_date: '',
                    end_date: '',
                    budget: '',
                    team_size: 1,
                    notes: ''
                  });
                }}
                variant="outline"
                className="rounded-xl"
              >
                <X className="h-4 w-4" />
              </Button>
            </div>
          </CardHeader>
          <CardContent>
            <form onSubmit={saveWorksite} className="space-y-6">
              {/* Informations principales */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Titre du chantier *</label>
                  <input
                    type="text"
                    required
                    value={worksiteFormData.title}
                    onChange={(e) => setWorksiteFormData({...worksiteFormData, title: e.target.value})}
                    className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-gray-400 focus:outline-none transition-colors"
                    placeholder="Ex: Rénovation immeuble..."
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Client</label>
                  <select
                    value={worksiteFormData.client_id}
                    onChange={(e) => setWorksiteFormData({...worksiteFormData, client_id: e.target.value})}
                    className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-gray-400 focus:outline-none transition-colors"
                  >
                    <option value="">Sélectionner un client</option>
                    {clients.map(client => (
                      <option key={client.id} value={client.id}>{client.nom}</option>
                    ))}
                  </select>
                </div>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Description</label>
                <textarea
                  value={worksiteFormData.description}
                  onChange={(e) => setWorksiteFormData({...worksiteFormData, description: e.target.value})}
                  rows="3"
                  className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-gray-400 focus:outline-none transition-colors"
                  placeholder="Description détaillée du chantier..."
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Adresse</label>
                <input
                  type="text"
                  value={worksiteFormData.address}
                  onChange={(e) => setWorksiteFormData({...worksiteFormData, address: e.target.value})}
                  className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-gray-400 focus:outline-none transition-colors"
                  placeholder="Adresse complète du chantier"
                />
              </div>

              {/* Statut et avancement */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Statut</label>
                  <select
                    value={worksiteFormData.status}
                    onChange={(e) => setWorksiteFormData({...worksiteFormData, status: e.target.value})}
                    className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-gray-400 focus:outline-none transition-colors"
                  >
                    <option value="PLANNED">📋 Planifié</option>
                    <option value="IN_PROGRESS">🔧 En cours</option>
                    <option value="ON_HOLD">⏸️ En pause</option>
                    <option value="COMPLETED">✅ Terminé</option>
                    <option value="CANCELLED">❌ Annulé</option>
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Avancement (%)</label>
                  <input
                    type="number"
                    min="0"
                    max="100"
                    value={worksiteFormData.progress}
                    readOnly
                    className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl bg-gray-100 cursor-not-allowed"
                    title="L'avancement est calculé automatiquement en fonction des jours de planning"
                  />
                  <p className="text-xs text-gray-500 mt-1">📊 Calculé automatiquement à partir des jours de planning</p>
                </div>
              </div>

              {/* Dates */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Date de début</label>
                  <input
                    type="date"
                    value={worksiteFormData.start_date}
                    onChange={(e) => setWorksiteFormData({...worksiteFormData, start_date: e.target.value})}
                    className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-gray-400 focus:outline-none transition-colors"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Date de fin prévue</label>
                  <input
                    type="date"
                    value={worksiteFormData.end_date}
                    onChange={(e) => setWorksiteFormData({...worksiteFormData, end_date: e.target.value})}
                    className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-gray-400 focus:outline-none transition-colors"
                  />
                </div>
              </div>

              {/* Budget et équipe */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Budget (€)</label>
                  <input
                    type="number"
                    min="0"
                    step="0.01"
                    value={worksiteFormData.budget}
                    onChange={(e) => setWorksiteFormData({...worksiteFormData, budget: e.target.value})}
                    className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-gray-400 focus:outline-none transition-colors"
                    placeholder="0.00"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Taille de l'équipe</label>
                  <input
                    type="number"
                    min="1"
                    value={worksiteFormData.team_size}
                    onChange={(e) => setWorksiteFormData({...worksiteFormData, team_size: parseInt(e.target.value) || 1})}
                    className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-gray-400 focus:outline-none transition-colors"
                  />
                </div>
              </div>

              {/* Notes */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Notes internes</label>
                <textarea
                  value={worksiteFormData.notes}
                  onChange={(e) => setWorksiteFormData({...worksiteFormData, notes: e.target.value})}
                  rows="3"
                  className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-gray-400 focus:outline-none transition-colors"
                  placeholder="Notes pour l'équipe..."
                />
              </div>

              {/* Boutons d'action */}
              <div className="flex gap-3 pt-4">
                <Button
                  type="submit"
                  className="flex-1 bg-black hover:bg-gray-800 text-white rounded-2xl py-3 shadow-lg"
                >
                  <Check className="h-4 w-4 mr-2" />
                  {editingWorksite ? 'Enregistrer les modifications' : 'Créer le chantier'}
                </Button>
                <Button
                  type="button"
                  onClick={() => {
                    setShowWorksiteForm(false);
                    setEditingWorksite(null);
                    setWorksiteFormData({
                      title: '',
                      description: '',
                      address: '',
                      client_id: '',
                      status: 'PLANNED',
                      progress: 0,
                      start_date: '',
                      end_date: '',
                      budget: '',
                      team_size: 1,
                      notes: ''
                    });
                  }}
                  variant="outline"
                  className="rounded-2xl px-6"
                >
                  Annuler
                </Button>
              </div>
            </form>
          </CardContent>
        </Card>
      )}

      {/* Quotes List */}
      {activeTab === 'quotes' && (
        <div className="space-y-6">
          {/* Vue Kanban Pipeline Commercial */}
          <div className="grid grid-cols-1 lg:grid-cols-4 gap-6">
            
            {/* Colonne 1: Brouillons */}
            <div className="bg-white/80 backdrop-blur-xl rounded-3xl border-0 shadow-lg">
              <div 
                className="p-4 border-b border-gray-100 cursor-pointer hover:bg-gray-50 transition-colors"
                onClick={() => setExpandedColumn(expandedColumn === 'DRAFT' ? null : 'DRAFT')}
              >
                <div className="flex items-center justify-between">
                  <h3 className="font-semibold text-gray-900 flex items-center">
                    <div className="w-3 h-3 bg-orange-400 rounded-full mr-2"></div>
                    Brouillons
                    {expandedColumn === 'DRAFT' ? (
                      <ChevronUp className="h-4 w-4 ml-2 text-gray-400" />
                    ) : (
                      <ChevronDown className="h-4 w-4 ml-2 text-gray-400" />
                    )}
                  </h3>
                  <span className="text-sm text-gray-500 bg-gray-100 px-2 py-1 rounded-full">
                    {quotes.filter(q => q.status === 'DRAFT').length}
                  </span>
                </div>
              </div>
              <div className="p-4 space-y-3 max-h-96 overflow-y-auto">
                {quotes.filter(q => {
                  if (q.status !== 'DRAFT') return false;
                  if (!searchTerm) return true;
                  const search = searchTerm.toLowerCase();
                  return q.title.toLowerCase().includes(search) ||
                         q.description?.toLowerCase().includes(search) ||
                         q.client_name?.toLowerCase().includes(search) ||
                         q.quote_number?.toLowerCase().includes(search) ||
                         q.amount?.toString().includes(search);
                }).map((quote) => (
                  <div key={quote.id} className="bg-white rounded-2xl p-5 shadow-sm hover:shadow-xl border border-gray-100 hover:border-gray-200 transition-all duration-300 cursor-pointer">
                    {/* Header avec numéro */}
                    <div className="flex items-start justify-between mb-3">
                      <div>
                        {quote.quote_number && (
                          <span className="text-xs font-mono text-gray-400 block mb-2">
                            {quote.quote_number}
                          </span>
                        )}
                        <h4 className="font-semibold text-gray-900 text-base leading-tight">{quote.title || 'Devis sans titre'}</h4>
                      </div>
                    </div>
                    
                    {/* Client et description */}
                    <div className="space-y-2 mb-4">
                      {quote.client_name && (
                        <div className="flex items-center text-sm text-gray-600">
                          <div className="w-1.5 h-1.5 bg-gray-400 rounded-full mr-2"></div>
                          <span>{quote.client_name}</span>
                        </div>
                      )}
                      {quote.description && (
                        <p className="text-xs text-gray-500 line-clamp-2 pl-3.5">{quote.description}</p>
                      )}
                    </div>
                    
                    {/* Montant */}
                    <div className="bg-gradient-to-br from-gray-50 to-gray-100/50 rounded-xl p-4 mb-4">
                      <div className="flex items-end justify-between">
                        <div>
                          <span className="text-xs text-gray-500 uppercase tracking-wider font-medium block mb-1">Montant</span>
                          <span className="text-2xl font-bold text-gray-900">{calculateQuoteTTC(quote)}€</span>
                          <span className="text-xs text-gray-500 ml-1.5">TTC</span>
                        </div>
                        <span className="text-xs text-gray-400 font-medium">
                          {new Date(quote.created_at).toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' })}
                        </span>
                      </div>
                    </div>
                    
                    {/* Actions */}
                    <div className="flex gap-2">
                      <Button 
                        size="sm" 
                        onClick={() => sendQuote(quote.id)}
                        className="flex-1 bg-gray-900 hover:bg-black text-white rounded-xl h-9 font-medium shadow-sm hover:shadow-md transition-all"
                      >
                        <Check className="h-4 w-4 mr-1.5" />
                        Envoyer
                      </Button>
                      <Button 
                        size="sm" 
                        onClick={() => editQuote(quote)}
                        variant="outline"
                        className="flex-1 rounded-xl border-gray-200 hover:border-gray-300 hover:bg-gray-50 h-9 font-medium"
                      >
                        <Edit className="h-4 w-4 mr-1.5" />
                        Éditer
                      </Button>
                      <Button 
                        size="sm" 
                        onClick={() => downloadQuotePDF(quote.id)}
                        variant="outline"
                        className="rounded-xl border-gray-200 hover:border-green-300 hover:bg-green-50 h-9 w-9 flex items-center justify-center p-0 group"
                        title="Télécharger le PDF"
                      >
                        <Download className="h-5 w-5 text-gray-400 group-hover:text-green-500 transition-colors" />
                      </Button>
                      <Button 
                        size="sm" 
                        onClick={() => deleteQuote(quote.id)}
                        variant="outline"
                        className="rounded-xl border-gray-200 hover:border-red-300 hover:bg-red-50 h-9 w-9 flex items-center justify-center p-0 group"
                      >
                        <Trash2 className="h-5 w-5 text-gray-400 group-hover:text-red-500 transition-colors" />
                      </Button>
                    </div>
                  </div>
                ))}
                {quotes.filter(q => q.status === 'DRAFT').length === 0 && (
                  <div className="text-center py-8">
                    <Calculator className="h-12 w-12 mx-auto mb-2 text-gray-300" />
                    <p className="text-sm text-gray-500">Aucun brouillon</p>
                  </div>
                )}
              </div>
            </div>

            {/* Colonne 2: Envoyés */}
            <div className="bg-white/80 backdrop-blur-xl rounded-3xl border-0 shadow-lg">
              <div 
                className="p-4 border-b border-gray-100 cursor-pointer hover:bg-gray-50 transition-colors"
                onClick={() => setExpandedColumn(expandedColumn === 'SENT' ? null : 'SENT')}
              >
                <div className="flex items-center justify-between">
                  <h3 className="font-semibold text-gray-900 flex items-center">
                    <div className="w-3 h-3 bg-blue-400 rounded-full mr-2"></div>
                    Envoyés
                    {expandedColumn === 'SENT' ? (
                      <ChevronUp className="h-4 w-4 ml-2 text-gray-400" />
                    ) : (
                      <ChevronDown className="h-4 w-4 ml-2 text-gray-400" />
                    )}
                  </h3>
                  <span className="text-sm text-gray-500 bg-gray-100 px-2 py-1 rounded-full">
                    {quotes.filter(q => q.status === 'SENT' || q.status === 'PENDING').length}
                  </span>
                </div>
              </div>
              <div className="p-4 space-y-3 max-h-96 overflow-y-auto">
                {quotes.filter(q => {
                  if (q.status !== 'SENT' && q.status !== 'PENDING') return false;
                  if (!searchTerm) return true;
                  const search = searchTerm.toLowerCase();
                  return q.title.toLowerCase().includes(search) ||
                         q.description?.toLowerCase().includes(search) ||
                         q.client_name?.toLowerCase().includes(search) ||
                         q.quote_number?.toLowerCase().includes(search) ||
                         q.amount?.toString().includes(search);
                }).map((quote) => (
                  <div key={quote.id} className="bg-white rounded-2xl p-5 shadow-sm hover:shadow-xl border border-gray-100 hover:border-gray-200 transition-all duration-300 cursor-pointer">
                    {/* Header avec numéro */}
                    <div className="flex items-start justify-between mb-3">
                      <div>
                        {quote.quote_number && (
                          <span className="text-xs font-mono text-gray-400 block mb-2">
                            {quote.quote_number}
                          </span>
                        )}
                        <h4 className="font-semibold text-gray-900 text-base leading-tight">{quote.title || 'Devis sans titre'}</h4>
                      </div>
                    </div>
                    
                    {/* Client et description */}
                    <div className="space-y-2 mb-4">
                      {quote.client_name && (
                        <div className="flex items-center text-sm text-gray-600">
                          <div className="w-1.5 h-1.5 bg-gray-400 rounded-full mr-2"></div>
                          <span>{quote.client_name}</span>
                        </div>
                      )}
                      {quote.description && (
                        <p className="text-xs text-gray-500 line-clamp-2 pl-3.5">{quote.description}</p>
                      )}
                    </div>
                    
                    {/* Montant */}
                    <div className="bg-gradient-to-br from-gray-50 to-gray-100/50 rounded-xl p-4 mb-4">
                      <div className="flex items-end justify-between">
                        <div>
                          <span className="text-xs text-gray-500 uppercase tracking-wider font-medium block mb-1">Montant</span>
                          <span className="text-2xl font-bold text-gray-900">{calculateQuoteTTC(quote)}€</span>
                          <span className="text-xs text-gray-500 ml-1.5">TTC</span>
                        </div>
                        <span className="text-xs text-gray-400 font-medium">
                          {new Date(quote.created_at).toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' })}
                        </span>
                      </div>
                    </div>
                    
                    {/* Actions principales */}
                    <div className="flex gap-2 mb-2">
                      <Button 
                        size="sm" 
                        onClick={() => downloadQuotePDF(quote.id)}
                        variant="outline"
                        className="rounded-xl border-gray-200 hover:border-green-300 hover:bg-green-50 h-9 w-9 flex items-center justify-center p-0 group"
                        title="Télécharger le PDF"
                      >
                        <Download className="h-5 w-5 text-gray-400 group-hover:text-green-500 transition-colors" />
                      </Button>
                      <Button 
                        size="sm" 
                        onClick={() => acceptQuote(quote.id)}
                        className="flex-1 bg-gray-900 hover:bg-black text-white rounded-xl h-9 font-medium shadow-sm hover:shadow-md transition-all"
                      >
                        <Check className="h-4 w-4 mr-1.5" />
                        Accepter
                      </Button>
                      <Button 
                        size="sm" 
                        onClick={() => rejectQuote(quote.id)}
                        variant="outline"
                        className="flex-1 rounded-xl border-gray-200 hover:border-gray-300 hover:bg-gray-50 h-9 font-medium"
                      >
                        <X className="h-4 w-4 mr-1.5" />
                        Refuser
                      </Button>
                    </div>
                    
                    {/* Actions secondaires */}
                    <div className="flex gap-2">
                      <Button 
                        size="sm" 
                        onClick={() => deleteQuote(quote.id)}
                        variant="outline"
                        className="flex-1 rounded-xl border-gray-200 hover:border-red-300 hover:bg-red-50 h-9 font-medium text-sm group"
                      >
                        <Trash2 className="h-4 w-4 mr-1.5 group-hover:text-red-500 transition-colors" />
                        Supprimer
                      </Button>
                    </div>
                  </div>
                ))}
                {quotes.filter(q => q.status === 'SENT' || q.status === 'PENDING').length === 0 && (
                  <div className="text-center py-8">
                    <Mail className="h-12 w-12 mx-auto mb-2 text-gray-300" />
                    <p className="text-sm text-gray-500">Aucun devis envoyé</p>
                  </div>
                )}
              </div>
            </div>

            {/* Colonne 3: Convertis en Chantiers */}
            <div className="bg-white/80 backdrop-blur-xl rounded-3xl border-0 shadow-lg">
              <div 
                className="p-4 border-b border-gray-100 cursor-pointer hover:bg-gray-50 transition-colors"
                onClick={() => setExpandedColumn(expandedColumn === 'WORKSITE' ? null : 'WORKSITE')}
              >
                <div className="flex items-center justify-between">
                  <h3 className="font-semibold text-gray-900 flex items-center">
                    <div className="w-3 h-3 bg-purple-400 rounded-full mr-2"></div>
                    Chantiers
                    {expandedColumn === 'WORKSITE' ? (
                      <ChevronUp className="h-4 w-4 ml-2 text-gray-400" />
                    ) : (
                      <ChevronDown className="h-4 w-4 ml-2 text-gray-400" />
                    )}
                  </h3>
                  <span className="text-sm text-gray-500 bg-gray-100 px-2 py-1 rounded-full">
                    {worksites.length}
                  </span>
                </div>
              </div>
              <div className="p-4 space-y-3 max-h-96 overflow-y-auto">
                {worksites.map((worksite) => (
                  <div key={worksite.id} className="bg-white border-2 border-purple-200 rounded-xl p-5 hover:shadow-lg transition-all relative">
                    <div className="flex items-start justify-between mb-3">
                      <div className="flex items-center gap-2 flex-wrap">
                        <span className="text-xs font-medium bg-purple-100 text-purple-700 px-2 py-1 rounded-full">
                          🏗️ Chantier
                        </span>
                        {hasSchedule(worksite.id) && (
                          <span className="text-xs font-medium bg-green-100 text-green-700 px-2 py-1 rounded-full">
                            ✓ Planifié
                          </span>
                        )}
                      </div>
                    </div>
                    
                    {worksite.client_name && (
                      <div className="mb-3 p-2 bg-purple-50 rounded-lg">
                        <p className="text-sm font-semibold text-purple-900">
                          👤 {worksite.client_name}
                        </p>
                      </div>
                    )}
                    
                    <h4 className="font-bold text-gray-900 mb-2">{worksite.title}</h4>
                    <p className="text-sm text-gray-600 mb-3 line-clamp-2">{worksite.description}</p>
                    
                    <div className="space-y-2">
                      <div className="flex items-center gap-2">
                        <span className="text-lg font-bold text-gray-900">{worksite.amount || 0}€</span>
                        <Button 
                          size="sm"
                          onClick={() => openPlanningModal(worksite)}
                          className={`${hasSchedule(worksite.id) ? 'bg-green-600 hover:bg-green-700' : 'bg-red-600 hover:bg-red-700'} text-white rounded-lg text-xs px-3 py-1.5 h-8 flex-1 font-medium`}
                        >
                          📅 {hasSchedule(worksite.id) ? 'Planifié' : 'Planifier'}
                        </Button>
                        <Button 
                          size="sm"
                          onClick={() => deleteWorksite(worksite.id)}
                          className="bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg text-xs px-3 py-1.5 h-8"
                          title="Supprimer le chantier"
                        >
                          🗑️
                        </Button>
                      </div>
                      {worksite.quote_id && (
                        <Button 
                          size="sm"
                          onClick={async () => {
                            try {
                              const token = localStorage.getItem('token');
                              const quoteRes = await axios.get(`${API}/quotes/${worksite.quote_id}`, {
                                headers: { Authorization: `Bearer ${token}` }
                              });
                              setSelectedWorksiteQuote({ ...worksite, quote: quoteRes.data });
                            } catch (error) {
                              console.error('Erreur chargement devis:', error);
                              alert('Erreur lors du chargement du devis');
                            }
                          }}
                          className="w-full bg-gray-100 hover:bg-gray-200 text-gray-900 border border-gray-300 rounded-lg text-xs px-3 py-1.5 h-8 font-medium"
                        >
                          📄 Voir le Devis
                        </Button>
                      )}
                    </div>
                  </div>
                ))}
                {worksites.length === 0 && (
                  <div className="text-center py-8">
                    <Building className="h-12 w-12 mx-auto mb-2 text-gray-300" />
                    <p className="text-sm text-gray-500">Aucun chantier</p>
                  </div>
                )}
              </div>
            </div>

            {/* Colonne 4: Facturés */}
            <div className="bg-white/80 backdrop-blur-xl rounded-3xl border-0 shadow-lg">
              <div 
                className="p-4 border-b border-gray-100 cursor-pointer hover:bg-gray-50 transition-colors"
                onClick={() => setExpandedColumn(expandedColumn === 'INVOICED' ? null : 'INVOICED')}
              >
                <div className="flex items-center justify-between">
                  <h3 className="font-semibold text-gray-900 flex items-center">
                    <div className="w-3 h-3 bg-emerald-400 rounded-full mr-2"></div>
                    Facturés
                    {expandedColumn === 'INVOICED' ? (
                      <ChevronUp className="h-4 w-4 ml-2 text-gray-400" />
                    ) : (
                      <ChevronDown className="h-4 w-4 ml-2 text-gray-400" />
                    )}
                  </h3>
                  <span className="text-sm text-gray-500 bg-gray-100 px-2 py-1 rounded-full">
                    {worksites.filter(w => hasSchedule(w.id)).length}
                  </span>
                </div>
              </div>
              <div className="p-4 space-y-3 max-h-96 overflow-y-auto">
                {worksites.filter(w => hasSchedule(w.id)).map((worksite) => (
                  <div key={worksite.id} className="bg-white border-2 border-emerald-200 rounded-xl p-5 hover:shadow-lg transition-all relative">
                    <div className="flex items-start justify-between mb-3">
                      <div className="flex items-center gap-2 flex-wrap">
                        <span className="text-xs font-medium bg-emerald-100 text-emerald-700 px-2 py-1 rounded-full">
                          💰 Facturé
                        </span>
                        {worksite.invoice_id ? (
                          <button
                            onClick={() => navigate('/bureau/facturation')}
                            className="text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full font-medium hover:bg-green-200 transition-colors flex items-center gap-1"
                            title="Facture électronique envoyée"
                          >
                            ✓ Envoyée
                          </button>
                        ) : (
                          <button
                            onClick={() => navigate('/bureau/facturation')}
                            className="text-xs bg-orange-100 text-orange-700 px-2 py-1 rounded-full font-medium hover:bg-orange-200 transition-colors flex items-center gap-1"
                            title="Créer facture électronique"
                          >
                            ✗ Créer
                          </button>
                        )}
                      </div>
                    </div>
                    
                    {worksite.client_name && (
                      <div className="mb-3 p-2 bg-emerald-50 rounded-lg">
                        <p className="text-sm font-semibold text-emerald-900">
                          👤 {worksite.client_name}
                        </p>
                      </div>
                    )}
                    
                    <h4 className="font-bold text-gray-900 mb-2">{worksite.title}</h4>
                    <p className="text-sm text-gray-600 mb-3 line-clamp-2">{worksite.description}</p>
                    
                    <div className="space-y-2">
                      <div className="flex items-center justify-between">
                        <span className="text-lg font-bold text-gray-900">{worksite.amount || 0}€</span>
                      </div>
                      {worksite.quote_id && (
                        <Button 
                          size="sm"
                          onClick={async () => {
                            try {
                              const token = localStorage.getItem('token');
                              const quoteRes = await axios.get(`${API}/quotes/${worksite.quote_id}`, {
                                headers: { Authorization: `Bearer ${token}` }
                              });
                              setSelectedWorksiteQuote({ ...worksite, quote: quoteRes.data });
                            } catch (error) {
                              console.error('Erreur chargement devis:', error);
                              alert('Erreur lors du chargement du devis');
                            }
                          }}
                          className="w-full bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-xs px-3 py-1 h-7"
                        >
                          📄 Voir le Devis
                        </Button>
                      )}
                      <Button 
                        size="sm"
                        onClick={() => {
                          alert(`Facture pour: ${worksite.title}\nMontant: ${worksite.amount}€\n\nFonctionnalité à implémenter`);
                        }}
                        className="w-full bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg text-xs px-3 py-1 h-7"
                      >
                        🧾 Voir la Facture
                      </Button>
                    </div>
                  </div>
                ))}
                {worksites.filter(w => hasSchedule(w.id)).length === 0 && (
                  <div className="text-center py-8">
                    <DollarSign className="h-12 w-12 mx-auto mb-2 text-gray-300" />
                    <p className="text-sm text-gray-500">Aucun chantier facturé</p>
                  </div>
                )}
              </div>
            </div>
          </div>

          {/* Section déroulante détaillée selon la colonne sélectionnée */}
          {expandedColumn && (
            <div className="bg-gradient-to-br from-white via-purple-50/30 to-blue-50/30 backdrop-blur-xl rounded-3xl border-2 border-purple-100 shadow-2xl p-8 animate-in slide-in-from-top duration-300">
              <div className="flex items-center justify-between mb-8">
                <div>
                  <h3 className="text-3xl font-bold text-gray-900">
                    {expandedColumn === 'DRAFT' && '📝 Détails Brouillons'}
                    {expandedColumn === 'SENT' && '📧 Détails Envoyés'}
                    {expandedColumn === 'WORKSITE' && '🏗️ Détails Chantiers'}
                    {expandedColumn === 'INVOICED' && '💰 Détails Facturés'}
                  </h3>
                  <p className="text-sm text-gray-500 mt-1">
                    {expandedColumn === 'INVOICED' ? 
                      `${worksites.filter(w => hasSchedule(w.id)).length} chantiers facturés` :
                      expandedColumn === 'WORKSITE' ?
                      `${worksites.length} chantiers` :
                      `${quotes.filter(q => {
                        if (expandedColumn === 'DRAFT') return q.status === 'DRAFT';
                        if (expandedColumn === 'SENT') return q.status === 'SENT' || q.status === 'PENDING';
                        return false;
                      }).length} devis • Cliquez sur un statut pour le modifier directement`
                    }
                  </p>
                </div>
                <Button
                  onClick={() => setExpandedColumn(null)}
                  variant="ghost"
                  size="sm"
                  className="rounded-xl hover:bg-red-50 hover:text-red-600"
                >
                  <X className="h-6 w-6" />
                </Button>
              </div>

              {/* Liste détaillée des devis ou chantiers de la colonne sélectionnée */}
              <div className="space-y-6">
                {expandedColumn === 'INVOICED' ? (
                  // Affichage des chantiers facturés (avec planning)
                  worksites.filter(w => hasSchedule(w.id)).map((worksite) => (
                    <div key={worksite.id} className="bg-white rounded-2xl p-6 border-2 border-emerald-100 hover:border-emerald-300 hover:shadow-xl transition-all duration-200">
                      <div className="flex items-start justify-between mb-4 pb-4 border-b border-gray-100">
                        <div className="flex-1">
                          <div className="flex items-center justify-between mb-2">
                            <h4 className="text-xl font-bold text-gray-900">{worksite.title || 'Chantier sans titre'}</h4>
                            <span className="px-3 py-2 bg-emerald-500 text-white text-sm font-bold rounded-xl shadow-lg">
                              💰 FACTURÉ
                            </span>
                          </div>
                          <div className="flex items-center space-x-3">
                            {worksite.client_name && (
                              <div className="flex items-center text-sm font-medium text-gray-700 bg-gray-100 px-3 py-1 rounded-lg">
                                <Users className="h-4 w-4 mr-1.5" />
                                {worksite.client_name}
                              </div>
                            )}
                          </div>
                        </div>
                      </div>
                      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div className="space-y-4">
                          <div className="bg-gradient-to-br from-emerald-100 to-emerald-200 rounded-xl p-4">
                            <div className="text-xs font-semibold text-emerald-700 mb-1">MONTANT</div>
                            <div className="text-3xl font-bold text-emerald-900">{worksite.amount?.toFixed(2) || '0.00'}€</div>
                          </div>
                        </div>
                        <div className="space-y-4">
                          {worksite.description && (
                            <div>
                              <div className="text-xs font-semibold text-gray-500 mb-2">DESCRIPTION</div>
                              <p className="text-sm text-gray-700 leading-relaxed">{worksite.description}</p>
                            </div>
                          )}
                        </div>
                      </div>
                    </div>
                  ))
                ) : expandedColumn === 'WORKSITE' ? (
                  // Affichage des chantiers avec filtrage par statut
                  <>
                    {/* Onglets de filtrage par statut */}
                    <div className="flex flex-wrap gap-2 mb-6 p-1 bg-gray-100 rounded-2xl">
                      {[
                        { key: 'ALL', label: 'Tous', icon: '📋', count: worksites.length },
                        { key: 'PLANNED', label: 'Planifiés', icon: '📅', count: worksites.filter(w => w.status === 'PLANNED').length },
                        { key: 'IN_PROGRESS', label: 'En cours', icon: '🔧', count: worksites.filter(w => w.status === 'IN_PROGRESS').length },
                        { key: 'COMPLETED', label: 'Terminés', icon: '✅', count: worksites.filter(w => w.status === 'COMPLETED').length },
                      ].map(tab => (
                        <button
                          key={tab.key}
                          onClick={() => setWorksiteStatusFilter(tab.key)}
                          className={`flex-1 min-w-[120px] px-4 py-3 rounded-xl text-sm font-semibold transition-all duration-200 ${
                            worksiteStatusFilter === tab.key
                              ? 'bg-white text-gray-900 shadow-lg'
                              : 'text-gray-500 hover:text-gray-700 hover:bg-white/50'
                          }`}
                        >
                          <span className="mr-1">{tab.icon}</span> {tab.label}
                          <span className={`ml-2 px-2 py-0.5 rounded-full text-xs font-bold ${
                            worksiteStatusFilter === tab.key
                              ? 'bg-purple-100 text-purple-700'
                              : 'bg-gray-200 text-gray-500'
                          }`}>{tab.count}</span>
                        </button>
                      ))}
                    </div>

                    {/* Liste filtrée des chantiers */}
                    <div className="space-y-6">
                    {worksites.filter(w => worksiteStatusFilter === 'ALL' || w.status === worksiteStatusFilter).length === 0 ? (
                      <div className="text-center py-12">
                        <Building className="h-16 w-16 mx-auto mb-4 text-gray-300" />
                        <h4 className="text-lg font-semibold text-gray-900 mb-2">Aucun chantier dans cette catégorie</h4>
                        <p className="text-gray-500 text-sm">Changez de filtre pour voir d'autres chantiers</p>
                      </div>
                    ) : (
                    worksites.filter(w => worksiteStatusFilter === 'ALL' || w.status === worksiteStatusFilter).map((worksite) => (
                    <div key={worksite.id} className="bg-white rounded-2xl p-6 border-2 border-purple-100 hover:border-purple-300 hover:shadow-xl transition-all duration-200">
                      <div className="flex items-start justify-between mb-4 pb-4 border-b border-gray-100">
                        <div className="flex-1">
                          <div className="flex items-center justify-between mb-2">
                            <h4 className="text-xl font-bold text-gray-900">{worksite.title || 'Chantier sans titre'}</h4>
                            <span className={`px-3 py-2 text-white text-sm font-bold rounded-xl shadow-lg ${
                              worksite.status === 'COMPLETED' ? 'bg-green-500' :
                              worksite.status === 'IN_PROGRESS' ? 'bg-blue-500' :
                              worksite.status === 'PENDING' ? 'bg-orange-500' : 'bg-gray-500'
                            }`}>
                              🏗️ {worksite.status === 'COMPLETED' ? 'TERMINÉ' : 
                                   worksite.status === 'IN_PROGRESS' ? 'EN COURS' :
                                   worksite.status === 'PENDING' ? 'EN ATTENTE' : worksite.status}
                            </span>
                          </div>
                          <div className="flex items-center space-x-3">
                            {worksite.client_name && (
                              <div className="flex items-center text-sm font-medium text-gray-700 bg-gray-100 px-3 py-1 rounded-lg">
                                <Users className="h-4 w-4 mr-1.5" />
                                {worksite.client_name}
                              </div>
                            )}
                            {worksite.address && (
                              <div className="flex items-center text-sm text-gray-600">
                                <MapPin className="h-4 w-4 mr-1" />
                                {worksite.address}
                              </div>
                            )}
                          </div>
                        </div>
                      </div>
                      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div className="space-y-4">
                          {worksite.start_date && (
                            <div className="bg-gradient-to-br from-purple-100 to-purple-200 rounded-xl p-4">
                              <div className="text-xs font-semibold text-purple-700 mb-1">DATES</div>
                              <div className="text-sm font-bold text-purple-900">
                                Début: {new Date(worksite.start_date).toLocaleDateString('fr-FR')}
                                {worksite.end_date && (
                                  <div className="mt-1">Fin: {new Date(worksite.end_date).toLocaleDateString('fr-FR')}</div>
                                )}
                              </div>
                            </div>
                          )}
                        </div>
                        <div className="space-y-4">
                          {worksite.description && (
                            <div>
                              <div className="text-xs font-semibold text-gray-500 mb-2">DESCRIPTION</div>
                              <p className="text-sm text-gray-700 leading-relaxed">{worksite.description}</p>
                            </div>
                          )}
                          {hasSchedule(worksite.id) && (
                            <div className="flex items-center text-sm font-medium text-emerald-700 bg-emerald-50 px-3 py-2 rounded-lg">
                              <Calendar className="h-4 w-4 mr-2" />
                              Planning créé
                            </div>
                          )}
                        </div>
                      </div>
                      {/* Bouton voir le devis */}
                      {worksite.quote_id && (
                        <div className="mt-4 pt-4 border-t border-gray-100">
                          <Button
                            onClick={async () => {
                              try {
                                const token = localStorage.getItem('token');
                                const quoteRes = await axios.get(`${API}/quotes/${worksite.quote_id}`, {
                                  headers: { Authorization: `Bearer ${token}` }
                                });
                                setSelectedWorksiteQuote({ ...worksite, quote: quoteRes.data });
                              } catch (error) {
                                console.error('Erreur chargement devis:', error);
                                alert('Erreur lors du chargement du devis');
                              }
                            }}
                            className="w-full bg-gradient-to-r from-purple-500 to-blue-500 hover:from-purple-600 hover:to-blue-600 text-white rounded-xl"
                          >
                            <FileText className="h-4 w-4 mr-2" />
                            Voir le devis détaillé
                          </Button>
                        </div>
                      )}
                    </div>
                  )))}
                    </div>
                  </>
                ) : (
                  // Affichage des devis normaux
                  quotes.filter(q => {
                    if (expandedColumn === 'DRAFT') return q.status === 'DRAFT';
                    if (expandedColumn === 'SENT') return q.status === 'SENT' || q.status === 'PENDING';
                    if (expandedColumn === 'WORKSITE') return q.status === 'CONVERTED_TO_WORKSITE';
                    return false;
                  }).map((quote) => (
                  <div key={quote.id} className="bg-white rounded-2xl p-6 border-2 border-gray-100 hover:border-gray-300 hover:shadow-xl transition-all duration-200">
                    {/* Header avec titre et statut */}
                    <div className="flex items-start justify-between mb-4 pb-4 border-b border-gray-100">
                      <div className="flex-1">
                        <div className="flex items-center justify-between mb-2">
                          <h4 className="text-xl font-bold text-gray-900">{quote.title || 'Devis sans titre'}</h4>
                          {quote.quote_number && (
                            <span className="px-3 py-2 bg-black text-white text-sm font-mono font-bold rounded-xl shadow-lg">
                              #{quote.quote_number}
                            </span>
                          )}
                        </div>
                        <div className="flex items-center space-x-3">
                          {quote.client_name && (
                            <div className="flex items-center text-sm font-medium text-gray-700 bg-gray-100 px-3 py-1 rounded-lg">
                              <Users className="h-4 w-4 mr-1.5" />
                              {quote.client_name}
                            </div>
                          )}
                          <div className="flex items-center text-xs text-gray-500">
                            <Clock className="h-3.5 w-3.5 mr-1" />
                            {new Date(quote.created_at).toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' })}
                          </div>
                        </div>
                      </div>
                      
                      {/* Statut modifiable directement */}
                      <div className="ml-4">
                        <label className="block text-xs font-medium text-gray-500 mb-1">Statut</label>
                        <select
                          value={quote.status}
                          onChange={async (e) => {
                            const newStatus = e.target.value;
                            try {
                              await axios.put(`${API}/quotes/${quote.id}`, {
                                client_id: quote.client_id,
                                title: quote.title,
                                description: quote.description,
                                amount: quote.amount,
                                status: newStatus,
                                items: quote.items || []
                              }, {
                                headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                              });
                              loadData();
                            } catch (error) {
                              console.error('Erreur changement statut:', error);
                              alert('Erreur lors du changement de statut');
                            }
                          }}
                          className="text-sm font-medium px-4 py-2 rounded-xl border-2 focus:border-gray-400 focus:ring-2 focus:ring-gray-400/20 transition-all cursor-pointer"
                          style={{
                            backgroundColor: quote.status === 'DRAFT' ? '#fef3c7' : 
                                           quote.status === 'SENT' ? '#dbeafe' : '#fce7f3',
                            color: quote.status === 'DRAFT' ? '#92400e' : 
                                  quote.status === 'SENT' ? '#1e40af' : '#9f1239'
                          }}
                        >
                          <option value="DRAFT">📋 Brouillon</option>
                          <option value="SENT">✉️ Envoyé</option>
                          <option value="REJECTED">❌ Refusé</option>
                        </select>
                      </div>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                      {/* Colonne 1: Informations client et montant */}
                      <div className="space-y-4">
                        <div className="bg-gradient-to-br from-gray-100 to-gray-200 rounded-xl p-4">
                          <div className="text-xs font-semibold text-gray-600 mb-1">MONTANT TOTAL TTC</div>
                          <div className="text-3xl font-bold text-black">{calculateQuoteTTC(quote)}€</div>
                        </div>
                        
                        {quote.client_email && (
                          <div className="flex items-center text-sm text-gray-700 bg-gray-50 rounded-lg p-3">
                            <Mail className="h-4 w-4 mr-2 text-gray-500" />
                            <span className="truncate">{quote.client_email}</span>
                          </div>
                        )}
                        {quote.client_phone && (
                          <div className="flex items-center text-sm text-gray-700 bg-gray-50 rounded-lg p-3">
                            <Phone className="h-4 w-4 mr-2 text-gray-500" />
                            {quote.client_phone}
                          </div>
                        )}
                      </div>

                      {/* Colonne 2: Description et Articles/Prestations */}
                      <div className="space-y-4">
                        {quote.description && (
                          <div>
                            <div className="text-xs font-semibold text-gray-500 mb-2">DESCRIPTION</div>
                            <p className="text-sm text-gray-700 leading-relaxed">{quote.description}</p>
                          </div>
                        )}
                        
                        {quote.items && quote.items.length > 0 && (
                          <div>
                            <div className="text-xs font-semibold text-gray-500 mb-2">ARTICLES / PRESTATIONS</div>
                            <div className="space-y-2">
                              {quote.items.map((item, idx) => (
                                <div key={idx} className="bg-gray-50 rounded-lg p-3 text-sm">
                                  <div className="flex items-start justify-between">
                                    <div className="flex-1">
                                      <div className="font-medium text-gray-900">{item.name || 'Article sans nom'}</div>
                                      <div className="text-xs text-gray-600 mt-1">
                                        Qté: {item.quantity} × {item.price?.toFixed(2)}€
                                      </div>
                                    </div>
                                    <div className="font-bold text-black ml-2">
                                      {((item.quantity || 0) * (item.price || 0)).toFixed(2)}€
                                    </div>
                                  </div>
                                </div>
                              ))}
                            </div>
                          </div>
                        )}
                      </div>

                      {/* Colonne 3: Actions */}
                      <div className="flex flex-col space-y-1.5">
                        {quote.status === 'DRAFT' && (
                          <>
                            <Button
                              onClick={() => editQuote(quote)}
                              className="bg-black hover:bg-gray-800 text-white rounded-lg shadow-md px-3 py-1.5 text-sm"
                              size="sm"
                            >
                              <Edit className="h-3.5 w-3.5 mr-1.5" />
                              Modifier
                            </Button>
                            <Button
                              onClick={() => sendQuote(quote)}
                              className="bg-black hover:bg-gray-800 text-white rounded-lg shadow-md px-3 py-1.5 text-sm"
                              size="sm"
                            >
                              <Mail className="h-3.5 w-3.5 mr-1.5" />
                              Envoyer
                            </Button>
                          </>
                        )}
                        <Button
                          onClick={() => alert(`Générer PDF pour ${quote.title}`)}
                          variant="outline"
                          className="rounded-lg border-2 border-gray-300 text-gray-700 hover:bg-gray-100 px-3 py-1.5 text-sm"
                          size="sm"
                        >
                          <FileText className="h-3.5 w-3.5 mr-1.5" />
                          PDF
                        </Button>
                        <Button
                          onClick={() => deleteQuote(quote.id)}
                          variant="outline"
                          className="rounded-lg border-2 border-gray-300 text-gray-600 hover:bg-gray-100 px-3 py-1.5 text-sm"
                          size="sm"
                        >
                          <Trash2 className="h-3.5 w-3.5 mr-1.5 text-red-500" />
                          Supprimer
                        </Button>
                      </div>
                    </div>
                  </div>
                  ))
                )}

                {expandedColumn === 'INVOICED' ? (
                  worksites.filter(w => hasSchedule(w.id)).length === 0 && (
                    <div className="text-center py-12">
                      <div className="text-gray-400 mb-4">
                        <DollarSign className="h-16 w-16 mx-auto" />
                      </div>
                      <p className="text-gray-500">Aucun chantier facturé</p>
                    </div>
                  )
                ) : (
                  quotes.filter(q => {
                    if (expandedColumn === 'DRAFT') return q.status === 'DRAFT';
                    if (expandedColumn === 'SENT') return q.status === 'SENT' || q.status === 'PENDING';
                    if (expandedColumn === 'WORKSITE') return q.status === 'CONVERTED_TO_WORKSITE';
                    return false;
                  }).length === 0 && (
                    <div className="text-center py-12">
                      <div className="text-gray-400 mb-4">
                        <FileText className="h-16 w-16 mx-auto" />
                      </div>
                      <p className="text-gray-500">Aucun devis dans cette catégorie</p>
                    </div>
                  )
                )}
              </div>
            </div>
          )}

          {/* Actions rapides en bas */}
          <div className="bg-gradient-to-r from-purple-50 to-blue-50 rounded-3xl p-6">
            <div className="flex flex-col lg:flex-row items-center justify-between space-y-4 lg:space-y-0">
              <div className="text-center lg:text-left">
                <h3 className="font-semibold text-gray-900 mb-1">Accélérez votre processus commercial</h3>
                <p className="text-sm text-gray-600">Templates, relances automatiques, et outils d'analyse pour optimiser vos ventes</p>
              </div>
              <div className="flex space-x-3">
                <Button 
                  onClick={() => {
                    setShowTemplates(true);
                    loadTemplates();
                  }}
                  className="bg-white hover:bg-gray-50 text-gray-700 border border-gray-200 rounded-2xl"
                >
                  <FileBarChart className="h-4 w-4 mr-2" />
                  Templates Pro
                </Button>
                <Button 
                  onClick={() => {
                    alert('🚀 Analyse Performance Avancée\n\n' +
                      '📈 INDICATEURS CLÉS:\n' +
                      '• CA généré: 45,200€\n' +
                      '• Nombre devis envoyés: 23\n' +
                      '• Taux acceptation: 73.9%\n' +
                      '• Délai moyen réponse: 3.2 jours\n\n' +
                      '🎯 RECOMMANDATIONS:\n' +
                      '• Optimiser les devis plomberie (+23%)\n' +
                      '• Relancer les devis en attente\n' +
                      '• Templates pour électricité\n\n' +
                      'Rapport détaillé disponible...'
                    );
                  }}
                  className="bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700 text-white rounded-2xl"
                >
                  <BarChart3 className="h-4 w-4 mr-2" />
                  Analyse Performance
                </Button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Modale pour afficher le devis d'un chantier */}
      {selectedWorksiteQuote && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
          <div className="bg-white rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div className="sticky top-0 bg-white border-b border-gray-200 p-6 flex justify-between items-center">
              <div>
                <h2 className="text-2xl font-bold text-gray-900">Devis du Chantier</h2>
                <p className="text-sm text-gray-600 mt-1">{selectedWorksiteQuote.title}</p>
              </div>
              <button
                onClick={() => setSelectedWorksiteQuote(null)}
                className="p-2 hover:bg-gray-100 rounded-lg transition-colors"
              >
                <X className="w-6 h-6 text-gray-500" />
              </button>
            </div>

            <div className="p-6 space-y-6">
              {/* Informations client */}
              {selectedWorksiteQuote.client_name && (
                <div className="bg-gray-50 rounded-xl p-4">
                  <h3 className="font-semibold text-gray-900 mb-3">Client</h3>
                  <div className="flex items-center gap-2 text-gray-700">
                    <Users className="w-4 h-4" />
                    <span>{selectedWorksiteQuote.client_name}</span>
                  </div>
                </div>
              )}

              {/* Informations créateur du devis */}
              {selectedWorksiteQuote.quote?.created_by && (
                <div className="bg-blue-50 rounded-xl p-4">
                  <h3 className="font-semibold text-gray-900 mb-3">Créé par</h3>
                  <div className="flex items-center gap-2 text-gray-700">
                    <Users className="w-4 h-4" />
                    <span>
                      {selectedWorksiteQuote.quote.created_by.first_name} {selectedWorksiteQuote.quote.created_by.last_name}
                      {selectedWorksiteQuote.quote.created_by.email && (
                        <span className="text-sm text-gray-500 ml-2">({selectedWorksiteQuote.quote.created_by.email})</span>
                      )}
                    </span>
                  </div>
                </div>
              )}

              {/* Articles du devis */}
              {selectedWorksiteQuote.quote && selectedWorksiteQuote.quote.items && (
                <div>
                  <h3 className="font-semibold text-gray-900 mb-4">Articles / Prestations</h3>
                  <div className="space-y-3">
                    {selectedWorksiteQuote.quote.items.map((item, index) => (
                      <div key={index} className="bg-white border border-gray-200 rounded-lg p-4">
                        <div className="flex justify-between items-start">
                          <div className="flex-1">
                            <h4 className="font-medium text-gray-900">{item.name}</h4>
                            {item.description && (
                              <p className="text-sm text-gray-600 mt-1">{item.description}</p>
                            )}
                            <div className="mt-2 grid grid-cols-3 gap-4 text-sm text-gray-600">
                              <div>
                                <span className="font-medium">Quantité:</span> {item.quantity}
                              </div>
                              <div>
                                <span className="font-medium">Prix unitaire:</span> {item.price?.toFixed(2)}€
                              </div>
                              <div>
                                <span className="font-medium">Total:</span> {((item.quantity || 0) * (item.price || 0)).toFixed(2)}€
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {/* Montant total */}
              {selectedWorksiteQuote.quote && (
                <div className="bg-gradient-to-r from-purple-50 to-blue-50 rounded-xl p-6">
                  <div className="flex justify-between items-center">
                    <span className="text-lg font-semibold text-gray-900">Montant Total</span>
                    <span className="text-3xl font-bold text-gray-900">
                      {selectedWorksiteQuote.quote.amount?.toFixed(2)}€
                    </span>
                  </div>
                </div>
              )}

              {/* Notes */}
              {selectedWorksiteQuote.quote?.description && (
                <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                  <h4 className="font-semibold text-gray-900 mb-2 flex items-center gap-2">
                    <AlertCircle className="w-5 h-5 text-yellow-600" />
                    Description / Notes
                  </h4>
                  <p className="text-gray-700 text-sm whitespace-pre-wrap">{selectedWorksiteQuote.quote.description}</p>
                </div>
              )}
            </div>
          </div>
        </div>
      )}

      {/* Worksites List */}
      {activeTab === 'worksites' && (
        <div className="space-y-6">
          {/* Header avec statistiques */}
          <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div className="bg-white rounded-2xl p-4 shadow-md">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-xs text-gray-500 uppercase mb-1">Total Chantiers</p>
                  <p className="text-2xl font-bold text-black">{worksites.length}</p>
                </div>
                <Building className="h-8 w-8 text-gray-400" />
              </div>
            </div>
            <div className="bg-white rounded-2xl p-4 shadow-md">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-xs text-gray-500 uppercase mb-1">En Cours</p>
                  <p className="text-2xl font-bold text-black">{worksites.filter(w => w.status === 'IN_PROGRESS').length}</p>
                </div>
                <Clock className="h-8 w-8 text-gray-400" />
              </div>
            </div>
            <div className="bg-white rounded-2xl p-4 shadow-md">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-xs text-gray-500 uppercase mb-1">Terminés</p>
                  <p className="text-2xl font-bold text-black">{worksites.filter(w => w.status === 'COMPLETED').length}</p>
                </div>
                <CheckCircle className="h-8 w-8 text-gray-400" />
              </div>
            </div>
            <div className="bg-white rounded-2xl p-4 shadow-md">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-xs text-gray-500 uppercase mb-1">Budget Total</p>
                  <p className="text-2xl font-bold text-black">
                    {worksites.reduce((sum, w) => sum + (w.budget || 0), 0).toLocaleString()}€
                  </p>
                </div>
                <DollarSign className="h-8 w-8 text-gray-400" />
              </div>
            </div>
          </div>

          {/* Bouton Nouveau Chantier */}
          <div className="flex justify-between items-center mb-4">
            <h2 className="text-2xl font-bold text-gray-900">Mes Chantiers</h2>
            <Button
              onClick={() => {
                setShowWorksiteForm(true);
                setEditingWorksite(null);
                setWorksiteFormData({
                  title: '',
                  description: '',
                  address: '',
                  client_id: '',
                  status: 'PLANNED',
                  progress: 0,
                  start_date: '',
                  end_date: '',
                  budget: '',
                  team_size: 1,
                  notes: ''
                });
              }}
              className="bg-black hover:bg-gray-800 text-white rounded-xl px-6 py-3"
            >
              <Plus className="h-4 w-4 mr-2" />
              Nouveau Chantier
            </Button>
          </div>

          {/* Liste des chantiers */}
          {worksites.length === 0 ? (
            <Card className="bg-white/80 backdrop-blur-xl rounded-3xl border-0 shadow-2xl">
              <CardContent className="p-12 text-center">
                <Building className="h-16 w-16 mx-auto mb-4 text-gray-300" />
                <h3 className="text-xl font-semibold text-gray-900 mb-2">Aucun chantier</h3>
                <p className="text-gray-500">Créez votre premier chantier ou convertissez un devis accepté.</p>
              </CardContent>
            </Card>
          ) : (
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
              {worksites.map((worksite) => (
                <Card key={worksite.id} className="bg-white rounded-2xl border-2 border-gray-100 hover:border-gray-300 hover:shadow-xl transition-all duration-200">
                  <CardContent className="p-6">
                    {/* Header */}
                    <div className="flex items-start justify-between mb-4">
                      <div className="flex-1">
                        <div className="flex items-center space-x-2 mb-2">
                          <h3 className="text-lg font-bold text-gray-900">{worksite.title}</h3>
                          <span className={`px-2 py-1 rounded-lg text-xs font-semibold ${
                            worksite.status === 'PLANNED' ? 'bg-gray-100 text-gray-700' :
                            worksite.status === 'IN_PROGRESS' ? 'bg-gray-200 text-black' :
                            worksite.status === 'ON_HOLD' ? 'bg-gray-100 text-gray-600' :
                            worksite.status === 'COMPLETED' ? 'bg-black text-white' : 'bg-gray-50 text-gray-500'
                          }`}>
                            {worksite.status === 'PLANNED' ? '📋 Planifié' :
                             worksite.status === 'IN_PROGRESS' ? '🔧 En cours' :
                             worksite.status === 'ON_HOLD' ? '⏸️ En pause' :
                             worksite.status === 'COMPLETED' ? '✅ Terminé' : worksite.status}
                          </span>
                        </div>
                        {worksite.clients?.name && (
                          <p className="text-sm text-gray-600 flex items-center mb-2">
                            <Users className="h-4 w-4 mr-1" />
                            {worksite.clients.name}
                          </p>
                        )}
                        {worksite.address && (
                          <p className="text-sm text-gray-600 flex items-center mb-3">
                            <MapPin className="h-4 w-4 mr-1" />
                            {worksite.address}
                          </p>
                        )}
                      </div>
                    </div>

                    {/* Progression */}
                    {worksite.progress !== null && worksite.progress !== undefined && (
                      <div className="mb-4">
                        <div className="flex justify-between text-xs text-gray-600 mb-1">
                          <span>Avancement</span>
                          <span className="font-semibold">{worksite.progress}%</span>
                        </div>
                        <div className="w-full bg-gray-200 rounded-full h-2">
                          <div
                            className="bg-black rounded-full h-2 transition-all duration-300"
                            style={{ width: `${worksite.progress}%` }}
                          ></div>
                        </div>
                      </div>
                    )}

                    {/* Infos clés */}
                    <div className="grid grid-cols-2 gap-3 mb-4">
                      {worksite.budget && (
                        <div className="bg-gray-50 rounded-lg p-3">
                          <p className="text-xs text-gray-500 mb-1">Budget</p>
                          <p className="text-sm font-bold text-black">{worksite.budget.toLocaleString()}€</p>
                        </div>
                      )}
                      {worksite.team_size && (
                        <div className="bg-gray-50 rounded-lg p-3">
                          <p className="text-xs text-gray-500 mb-1">Équipe</p>
                          <p className="text-sm font-bold text-black">{worksite.team_size} personne{worksite.team_size > 1 ? 's' : ''}</p>
                        </div>
                      )}
                      {worksite.start_date && (
                        <div className="bg-gray-50 rounded-lg p-3">
                          <p className="text-xs text-gray-500 mb-1">Début</p>
                          <p className="text-sm font-semibold text-gray-900">
                            {new Date(worksite.start_date).toLocaleDateString('fr-FR')}
                          </p>
                        </div>
                      )}
                      {worksite.end_date && (
                        <div className="bg-gray-50 rounded-lg p-3">
                          <p className="text-xs text-gray-500 mb-1">Fin prévue</p>
                          <p className="text-sm font-semibold text-gray-900">
                            {new Date(worksite.end_date).toLocaleDateString('fr-FR')}
                          </p>
                        </div>
                      )}
                    </div>

                    {/* Actions */}
                    <div className="flex space-x-2">
                      <Button
                        size="sm"
                        onClick={() => {
                          setEditingWorksite(worksite);
                          setWorksiteFormData({
                            title: worksite.title || '',
                            description: worksite.description || '',
                            address: worksite.address || '',
                            client_id: worksite.client_id || '',
                            status: worksite.status || 'PLANNED',
                            progress: worksite.progress || 0,
                            start_date: worksite.start_date || '',
                            end_date: worksite.end_date || '',
                            budget: worksite.budget || '',
                            team_size: worksite.team_size || 1,
                            notes: worksite.notes || ''
                          });
                          setShowWorksiteForm(true);
                        }}
                        className="flex-1 bg-black hover:bg-gray-800 text-white rounded-lg"
                      >
                        <Edit className="h-3.5 w-3.5 mr-1" />
                        Modifier
                      </Button>
                      <Button
                        size="sm"
                        onClick={() => deleteWorksite(worksite.id)}
                        variant="outline"
                        className="rounded-lg border-2 border-gray-300 text-gray-600 hover:bg-gray-100"
                      >
                        <Trash2 className="h-3.5 w-3.5 text-red-500" />
                      </Button>
                    </div>
                  </CardContent>
                </Card>
              ))}
            </div>
          )}
        </div>
      )}

      {/* Trash List */}
      {activeTab === 'trash' && (
        <div className="grid gap-4">
          {trash.length === 0 ? (
            <Card className="bg-white/80 backdrop-blur-xl rounded-3xl border-0 shadow-2xl">
              <CardContent className="p-12 text-center">
                <Trash2 className="h-16 w-16 mx-auto mb-4 text-gray-300" />
                <h3 className="text-xl font-semibold text-gray-900 mb-2">Corbeille vide</h3>
                <p className="text-gray-500">Les devis supprimés apparaîtront ici (récupérables sous 24h).</p>
              </CardContent>
            </Card>
          ) : (
            trash.map((item) => (
              <Card key={item.id} className="bg-red-50/80 backdrop-blur-xl rounded-3xl border border-red-200 shadow-lg">
                <CardContent className="p-6">
                  <div className="flex items-start justify-between">
                    <div className="flex-1">
                      <h3 className="text-lg font-semibold text-gray-900 mb-2">{item.title}</h3>
                      <p className="text-gray-600 mb-3">{item.description}</p>
                      <div className="flex items-center space-x-4 text-sm text-red-600">
                        <span>Supprimé le: {new Date(item.trashed_at).toLocaleDateString('fr-FR')}</span>
                        <span>Suppression auto: {new Date(item.auto_delete_at).toLocaleDateString('fr-FR')}</span>
                      </div>
                    </div>
                    <div className="flex space-x-2">
                      <Button 
                        size="sm"
                        onClick={() => restoreFromTrash(item.id)}
                        className="bg-green-600 hover:bg-green-700 text-white rounded-xl"
                      >
                        <ArrowLeft className="h-4 w-4 mr-1" />
                        Restaurer
                      </Button>
                    </div>
                  </div>
                </CardContent>
              </Card>
            ))
          )}
        </div>
      )}

      {/* NEW: Templates Management Page */}
      {showTemplates && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
          <div className="bg-white rounded-3xl max-w-6xl w-full max-h-[90vh] overflow-y-auto">
            <div className="p-8">
              {/* Header */}
              <div className="flex justify-between items-center mb-6">
                <div>
                  <h2 className="text-2xl font-bold text-gray-900">Gestion des Templates</h2>
                  <p className="text-gray-600">Créez et gérez vos modèles de devis personnalisés</p>
                </div>
                <div className="flex space-x-3">
                  <Button
                    onClick={() => setShowTemplateForm(true)}
                    className="bg-blue-600 hover:bg-blue-700 text-white rounded-xl px-4 py-2"
                  >
                    <Plus className="h-4 w-4 mr-2" />
                    Nouveau Template
                  </Button>
                  <Button
                    onClick={() => setShowTemplates(false)}
                    variant="outline"
                    className="rounded-xl px-4 py-2"
                  >
                    <X className="h-4 w-4 mr-2" />
                    Fermer
                  </Button>
                </div>
              </div>

              {/* Templates Grid */}
              <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
                {templates.map((template) => (
                  <Card key={template.id} className="bg-white border border-gray-200 rounded-2xl hover:shadow-lg transition-all duration-200">
                    <CardContent className="p-6">
                      <div className="flex items-start justify-between mb-4">
                        <div className="flex-1">
                          <h3 className="font-semibold text-gray-900 mb-1">{template.name}</h3>
                          <p className="text-sm text-gray-600 mb-2">{template.description}</p>
                          <span className="inline-block bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full">
                            {template.category}
                          </span>
                        </div>
                      </div>
                      
                      {/* Template Items Preview */}
                      <div className="bg-gray-50 rounded-lg p-3 mb-4">
                        <h4 className="text-sm font-medium text-gray-700 mb-2">Articles ({template.items?.length || 0})</h4>
                        {template.items?.slice(0, 2).map((item, idx) => (
                          <div key={idx} className="text-xs text-gray-600 flex justify-between">
                            <span>{item.name}</span>
                            <span>{item.unit_price}€</span>
                          </div>
                        ))}
                        {template.items?.length > 2 && (
                          <div className="text-xs text-gray-500 mt-1">+{template.items.length - 2} autres...</div>
                        )}
                      </div>

                      {/* Actions */}
                      <div className="flex space-x-2">
                        <Button
                          onClick={() => useTemplate(template)}
                          className="flex-1 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm py-2"
                        >
                          <Play className="h-3 w-3 mr-1" />
                          Utiliser
                        </Button>
                        <Button
                          onClick={() => editTemplate(template)}
                          variant="outline"
                          className="px-3 py-2 border-blue-200 text-blue-600 hover:bg-blue-50 rounded-lg"
                        >
                          <Edit className="h-3 w-3" />
                        </Button>
                        <Button
                          onClick={() => deleteTemplate(template.id)}
                          variant="outline"
                          className="px-3 py-2 border-red-200 text-red-600 hover:bg-red-50 rounded-lg"
                        >
                          <Trash2 className="h-3 w-3" />
                        </Button>
                      </div>
                    </CardContent>
                  </Card>
                ))}
              </div>

              {/* Empty State */}
              {templates.length === 0 && (
                <div className="text-center py-12">
                  <FileBarChart className="h-16 w-16 mx-auto mb-4 text-gray-300" />
                  <h3 className="text-lg font-semibold text-gray-900 mb-2">Aucun template créé</h3>
                  <p className="text-gray-600 mb-4">Créez votre premier template pour accélérer vos devis</p>
                  <Button
                    onClick={() => setShowTemplateForm(true)}
                    className="bg-blue-600 hover:bg-blue-700 text-white rounded-xl px-6 py-3"
                  >
                    <Plus className="h-4 w-4 mr-2" />
                    Créer un Template
                  </Button>
                </div>
              )}
            </div>
          </div>
        </div>
      )}

      {/* NEW: Template Creation Form */}
      {showTemplateForm && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
          <div className="bg-white rounded-3xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div className="p-8">
              <div className="flex justify-between items-center mb-6">
                <div>
                  <h2 className="text-xl font-bold text-gray-900">
                    {isEditingTemplate ? 'Modifier le Template' : 'Créer un Template'}
                  </h2>
                  <p className="text-gray-600">
                    {isEditingTemplate ? 'Modifiez votre modèle de devis' : 'Définissez votre modèle de devis personnalisé'}
                  </p>
                </div>
                <Button
                  onClick={() => setShowTemplateForm(false)}
                  variant="outline"
                  className="rounded-xl px-4 py-2"
                >
                  <X className="h-4 w-4" />
                </Button>
              </div>

              <div className="space-y-6">
                {/* Basic Info */}
                <div className="grid md:grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">Nom du Template</label>
                    <Input
                      placeholder="Ex: Devis Plomberie Standard"
                      value={templateFormData.name}
                      onChange={(e) => setTemplateFormData(prev => ({...prev, name: e.target.value}))}
                      className="rounded-xl border-gray-200"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">Catégorie</label>
                    <select
                      value={templateFormData.category}
                      onChange={(e) => setTemplateFormData(prev => ({...prev, category: e.target.value}))}
                      className="w-full rounded-xl border border-gray-200 px-3 py-2"
                    >
                      <option value="standard">Standard</option>
                      <option value="plomberie">Plomberie</option>
                      <option value="electricite">Électricité</option>
                      <option value="menuiserie">Menuiserie</option>
                      <option value="renovation">Rénovation</option>
                    </select>
                  </div>
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Description</label>
                  <textarea
                    placeholder="Décrivez ce template et son utilisation..."
                    value={templateFormData.description}
                    onChange={(e) => setTemplateFormData(prev => ({...prev, description: e.target.value}))}
                    className="w-full rounded-xl border border-gray-200 px-3 py-2 h-20 resize-none"
                  />
                </div>

                {/* Items */}
                <div>
                  <div className="flex justify-between items-center mb-4">
                    <label className="block text-sm font-medium text-gray-700">Articles du Template</label>
                    <Button
                      onClick={addTemplateItem}
                      variant="outline"
                      className="rounded-lg text-sm px-3 py-1"
                    >
                      <Plus className="h-3 w-3 mr-1" />
                      Ajouter Article
                    </Button>
                  </div>

                  <div className="space-y-3">
                    {templateFormData.items.map((item, index) => (
                      <div key={index} className="bg-gray-50 rounded-lg p-4">
                        <div className="grid md:grid-cols-4 gap-3 items-end">
                          <div className="relative">
                            <label className="block text-xs font-medium text-gray-600 mb-1">Nom</label>
                            <Input
                              placeholder="Ex: Main d'œuvre"
                              value={item.name}
                              onChange={(e) => updateTemplateItem(index, 'name', e.target.value)}
                              onFocus={() => item.name && setTemplateItemSuggestions(prev => ({...prev, [index]: true}))}
                              className="rounded-lg text-sm"
                            />
                            
                            {/* Suggestions du catalogue */}
                            {templateItemSuggestions[index] && getFilteredTemplateProducts(index).length > 0 && (
                              <div className="absolute z-50 w-full mt-1 bg-white border rounded-xl shadow-lg max-h-48 overflow-y-auto">
                                {getFilteredTemplateProducts(index).map(product => (
                                  <button
                                    key={product.id}
                                    type="button"
                                    onClick={() => selectTemplateProduct(index, product)}
                                    className="w-full text-left px-3 py-2 hover:bg-blue-50 transition-colors border-b last:border-0"
                                  >
                                    <div className="flex justify-between items-start">
                                      <div>
                                        <div className="font-medium text-gray-900 text-sm">{product.name}</div>
                                        {product.description && (
                                          <div className="text-xs text-gray-600 mt-0.5">{product.description}</div>
                                        )}
                                        <div className="text-xs text-gray-500">{product.unit}</div>
                                      </div>
                                      <div className="text-sm font-semibold text-blue-600">{product.price}€</div>
                                    </div>
                                  </button>
                                ))}
                              </div>
                            )}
                            
                            {item.name && !getFilteredTemplateProducts(index).length && templateItemSuggestions[index] && (
                              <p className="text-xs text-blue-600 mt-1 flex items-center">
                                <Plus className="h-3 w-3 mr-1 inline" />
                                Nouvel article personnalisé
                              </p>
                            )}
                          </div>
                          <div className="relative">
                            <label className="block text-xs font-medium text-gray-600 mb-1">Description</label>
                            <Input
                              placeholder="Description détaillée"
                              value={item.description}
                              onChange={(e) => updateTemplateItem(index, 'description', e.target.value)}
                              onFocus={() => item.description && setTemplateDescSuggestions(prev => ({...prev, [index]: true}))}
                              className="rounded-lg text-sm"
                            />
                            
                            {/* Suggestions du catalogue par description */}
                            {templateDescSuggestions[index] && getFilteredTemplateProductsByDesc(index).length > 0 && (
                              <div className="absolute z-50 w-full mt-1 bg-white border rounded-xl shadow-lg max-h-48 overflow-y-auto">
                                {getFilteredTemplateProductsByDesc(index).map(product => (
                                  <button
                                    key={product.id}
                                    type="button"
                                    onClick={() => selectTemplateProductByDesc(index, product)}
                                    className="w-full text-left px-3 py-2 hover:bg-blue-50 transition-colors border-b last:border-0"
                                  >
                                    <div className="flex justify-between items-start">
                                      <div>
                                        <div className="font-medium text-gray-900 text-sm">{product.name}</div>
                                        {product.description && (
                                          <div className="text-xs text-gray-600 mt-0.5">{product.description}</div>
                                        )}
                                        <div className="text-xs text-gray-500">{product.unit}</div>
                                      </div>
                                      <div className="text-sm font-semibold text-blue-600">{product.price}€</div>
                                    </div>
                                  </button>
                                ))}
                              </div>
                            )}
                          </div>
                          <div>
                            <label className="block text-xs font-medium text-gray-600 mb-1">Prix Unitaire (€)</label>
                            <Input
                              type="number"
                              placeholder="0"
                              value={item.unit_price}
                              onChange={(e) => updateTemplateItem(index, 'unit_price', parseFloat(e.target.value) || 0)}
                              className="rounded-lg text-sm"
                            />
                          </div>
                          <div>
                            <label className="block text-xs font-medium text-gray-600 mb-1">Qté par défaut</label>
                            <div className="flex space-x-1">
                              <Input
                                type="number"
                                min="1"
                                value={item.default_quantity}
                                onChange={(e) => updateTemplateItem(index, 'default_quantity', parseInt(e.target.value) || 1)}
                                className="rounded-lg text-sm"
                              />
                              <Button
                                onClick={() => removeTemplateItem(index)}
                                variant="outline"
                                className="px-2 py-1 border-red-200 text-red-600 hover:bg-red-50 rounded-lg"
                              >
                                <Trash2 className="h-3 w-3" />
                              </Button>
                            </div>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>

                {/* Total du template */}
                <div className="bg-gradient-to-r from-purple-50 to-blue-50 rounded-xl p-4 mt-4">
                  <div className="flex justify-between items-center">
                    <span className="text-gray-700 font-medium">Total estimé du template :</span>
                    <span className="text-2xl font-bold text-purple-600">
                      {templateFormData.items.reduce((sum, item) => 
                        sum + ((item.unit_price || 0) * (item.default_quantity || 1)), 0
                      ).toFixed(2)}€
                    </span>
                  </div>
                  <p className="text-xs text-gray-500 mt-1">
                    Basé sur {templateFormData.items.length} article{templateFormData.items.length > 1 ? 's' : ''} 
                    {templateFormData.items.length > 0 && ` avec les quantités par défaut`}
                  </p>
                </div>

                {/* Actions */}
                <div className="flex justify-end space-x-3 pt-4 border-t">
                  <Button
                    onClick={() => {
                      setShowTemplateForm(false);
                      setIsEditingTemplate(false);
                      setEditingTemplate(null);
                      setTemplateFormData({
                        name: '',
                        description: '',
                        category: 'standard',
                        items: [{ name: '', description: '', unit_price: 0, default_quantity: 1 }]
                      });
                    }}
                    variant="outline"
                    className="rounded-xl px-6 py-2"
                  >
                    Annuler
                  </Button>
                  <Button
                    onClick={createTemplate}
                    className="bg-blue-600 hover:bg-blue-700 text-white rounded-xl px-6 py-2"
                  >
                    {isEditingTemplate ? 'Enregistrer Modifications' : 'Créer Template'}
                  </Button>
                </div>
              </div>
            </div>
          </div>
        </div>
      )}

    </div>
  );
};

// Worksite Statistics Component
const WorksiteStatistics = () => {
  const [stats, setStats] = useState({
    totalWorksites: 0,
    activeWorksites: 0,
    completedWorksites: 0,
    totalSearches: 0
  });
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    loadStatistics();
  }, []);

  const loadStatistics = async () => {
    try {
      // Simulate loading statistics
      setTimeout(() => {
        setStats({
          totalWorksites: 25,
          activeWorksites: 8,
          completedWorksites: 17,
          totalSearches: 142
        });
        setLoading(false);
      }, 1000);
    } catch (error) {
      console.error('Erreur chargement statistiques:', error);
      setLoading(false);
    }
  };

  if (loading) {
    return (
      <div className="flex items-center justify-center py-12">
        <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900"></div>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      <h2 className="text-2xl font-bold text-gray-900">Statistiques des Chantiers</h2>
      
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <Card className="bg-white/80 backdrop-blur-xl rounded-3xl border-0 shadow-lg">
          <CardContent className="p-6">
            <div className="flex items-center">
              <div className="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
                <Briefcase className="h-6 w-6 text-blue-600" />
              </div>
              <div className="ml-4">
                <p className="text-sm font-medium text-gray-600">Total Chantiers</p>
                <p className="text-2xl font-bold text-gray-900">{stats.totalWorksites}</p>
              </div>
            </div>
          </CardContent>
        </Card>

        <Card className="bg-white/80 backdrop-blur-xl rounded-3xl border-0 shadow-lg">
          <CardContent className="p-6">
            <div className="flex items-center">
              <div className="w-12 h-12 bg-orange-100 rounded-xl flex items-center justify-center">
                <Clock className="h-6 w-6 text-orange-600" />
              </div>
              <div className="ml-4">
                <p className="text-sm font-medium text-gray-600">En Cours</p>
                <p className="text-2xl font-bold text-gray-900">{stats.activeWorksites}</p>
              </div>
            </div>
          </CardContent>
        </Card>

        <Card className="bg-white/80 backdrop-blur-xl rounded-3xl border-0 shadow-lg">
          <CardContent className="p-6">
            <div className="flex items-center">
              <div className="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
                <CheckCircle className="h-6 w-6 text-green-600" />
              </div>
              <div className="ml-4">
                <p className="text-sm font-medium text-gray-600">Terminés</p>
                <p className="text-2xl font-bold text-gray-900">{stats.completedWorksites}</p>
              </div>
            </div>
          </CardContent>
        </Card>

        <Card className="bg-white/80 backdrop-blur-xl rounded-3xl border-0 shadow-lg">
          <CardContent className="p-6">
            <div className="flex items-center">
              <div className="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center">
                <Search className="h-6 w-6 text-purple-600" />
              </div>
              <div className="ml-4">
                <p className="text-sm font-medium text-gray-600">Recherches</p>
                <p className="text-2xl font-bold text-gray-900">{stats.totalSearches}</p>
              </div>
            </div>
          </CardContent>
        </Card>
      </div>
    </div>
  );
};

// Worksite Map Component - Interactive Map with Team Leaders
const WorksiteMap = () => {
  const [searches, setSearches] = useState([]);
  const [worksites, setWorksites] = useState([]);
  const [loading, setLoading] = useState(true);
  const [filterTeamLeader, setFilterTeamLeader] = useState('all');

  useEffect(() => {
    loadSearches();
  }, []);

  const loadSearches = async () => {
    try {
      const response = await axios.get(`${API}/searches`, {
        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
      });
      const searchesWithCoords = response.data.filter(search => search.latitude && search.longitude);
      setSearches(searchesWithCoords);

      // Données simulées de chantiers avec coordonnées et chefs d'équipe
      const simulatedWorksites = [
        {
          id: '1',
          title: 'Chantier Boulevard Saint-Michel',
          latitude: 48.8566,
          longitude: 2.3522,
          status: 'IN_PROGRESS',
          team_leader: 'jean',
          client: 'Entreprise Martin',
          type: 'current'
        }
      ];
      
      setWorksites(simulatedWorksites);
    } catch (error) {
      console.error('Erreur chargement recherches:', error);
    } finally {
      setLoading(false);
    }
  };

  const getTeamLeaderColor = (teamLeaderId) => {
    const leader = teamLeaders.find(tl => tl.id === teamLeaderId);
    return leader ? leader.color : 'bg-gray-500';
  };

  const getMarkerAnimation = (worksite) => {
    if (worksite.status === 'IN_PROGRESS') {
      return 'animate-pulse';
    }
    return '';
  };

  const formatDate = (dateString) => {
    return new Date(dateString).toLocaleDateString('fr-FR');
  };

  const [selectedMarker, setSelectedMarker] = useState(null);

  const teamLeaders = [
    { id: 'jean', name: 'Jean Dupont', color: 'bg-blue-500' },
    { id: 'marie', name: 'Marie Martin', color: 'bg-green-500' },
    { id: 'pierre', name: 'Pierre Durand', color: 'bg-purple-500' }
  ];

  const filteredWorksites = [...worksites, ...searches.map(search => ({
    id: search.id,
    title: search.location,
    latitude: search.latitude,
    longitude: search.longitude,
    client: 'Client GPS',
    status: 'COMPLETED',
    team_leader: 'jean',
    type: 'past'
  }))];

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <h2 className="text-2xl font-bold text-gray-900">Carte des Sites</h2>
        <div className="flex items-center space-x-4">
          <select
            value={filterTeamLeader}
            onChange={(e) => setFilterTeamLeader(e.target.value)}
            className="bg-white border border-gray-300 rounded-lg px-3 py-2 text-sm"
          >
            <option value="all">Tous les chefs d'équipe</option>
            {teamLeaders.map(leader => (
              <option key={leader.id} value={leader.id}>{leader.name}</option>
            ))}
          </select>
        </div>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        {/* Map Placeholder */}
        <div className="lg:col-span-2">
          <Card className="bg-white/80 backdrop-blur-xl rounded-3xl border-0 shadow-2xl">
            <CardContent className="p-0">
              <div className="relative h-96 bg-gradient-to-br from-blue-50 to-green-50 rounded-3xl flex items-center justify-center">
                <div className="text-center">
                  <Map className="h-16 w-16 mx-auto mb-4 text-gray-400" />
                  <h3 className="text-lg font-semibold text-gray-700 mb-2">Carte Interactive</h3>
                  <p className="text-gray-500 mb-4">Intégration Google Maps en cours</p>
                  <Button className="bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white rounded-2xl px-6 py-3">
                    Voir en plein écran
                  </Button>
                </div>
                
                {/* Simulated Map Points */}
                <div className="absolute inset-0 pointer-events-none">
                  {searches.slice(0, 5).map((search, index) => (
                    <div
                      key={search.id}
                      className="absolute w-3 h-3 bg-red-500 rounded-full shadow-lg animate-pulse"
                      style={{
                        left: `${20 + index * 15}%`,
                        top: `${30 + index * 10}%`
                      }}
                    />
                  ))}
                </div>
              </div>
            </CardContent>
          </Card>
        </div>

        {/* Sites List */}
        <div className="space-y-4">
          <Card className="bg-white/80 backdrop-blur-xl rounded-3xl border-0 shadow-lg">
            <CardHeader className="pb-4">
              <CardTitle className="text-lg font-semibold text-gray-900">Sites Référencés</CardTitle>
            </CardHeader>
            <CardContent className="px-6 pb-6 max-h-80 overflow-y-auto space-y-3">
              {searches.length === 0 ? (
                <div className="text-center py-8">
                  <MapPin className="h-12 w-12 mx-auto mb-3 text-gray-300" />
                  <p className="text-gray-500 text-sm">Aucun site géolocalisé</p>
                </div>
              ) : (
                searches.map((search) => (
                  <div
                    key={search.id}
                    className={`p-3 rounded-xl cursor-pointer transition-all duration-200 bg-gray-50 hover:bg-gray-100`}
                    onClick={() => setSelectedMarker({
                      id: search.id,
                      title: search.location,
                      latitude: search.latitude,
                      longitude: search.longitude,
                      client: 'Client GPS',
                      status: 'COMPLETED',
                      team_leader: 'jean',
                      type: 'past'
                    })}
                  >
                    <h4 className="font-medium text-gray-900 text-sm mb-1">{search.location}</h4>
                    <p className="text-xs text-gray-600 mb-2 line-clamp-2">{search.description}</p>
                    <div className="flex items-center justify-between text-xs text-gray-500">
                      <span>{formatDate(search.created_at)}</span>
                      <span className="bg-red-100 text-red-700 px-2 py-1 rounded-lg">
                        {search.latitude.toFixed(3)}, {search.longitude.toFixed(3)}
                      </span>
                    </div>
                  </div>
                ))
              )}
            </CardContent>
          </Card>

          {/* Selected Site Details */}
          {selectedMarker && selectedMarker.type === 'past' && (
            <Card className="bg-white/80 backdrop-blur-xl rounded-3xl border-0 shadow-lg">
              <CardHeader className="pb-4">
                <CardTitle className="text-lg font-semibold text-gray-900">Détails du Site</CardTitle>
              </CardHeader>
              <CardContent className="px-6 pb-6">
                <div className="space-y-3">
                  <div>
                    <h4 className="font-medium text-gray-900">{selectedMarker.title}</h4>
                    <p className="text-sm text-gray-600 mt-1">Site géolocalisé par GPS</p>
                  </div>
                  
                  <div className="pt-3 space-y-2 text-sm">
                    <div className="flex justify-between">
                      <span className="text-gray-500">Coordonnées:</span>
                      <span className="font-mono text-gray-700">
                        {selectedMarker.latitude?.toFixed(6)}, {selectedMarker.longitude?.toFixed(6)}
                      </span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-gray-500">Type:</span>
                      <span className="text-gray-700">Recherche GPS</span>
                    </div>
                  </div>
                  
                  <div className="pt-3 flex space-x-2">
                    <Button size="sm" variant="outline" className="flex-1 rounded-xl">
                      <MapPin className="h-3 w-3 mr-1" />
                      Naviguer
                    </Button>
                    <Button size="sm" className="flex-1 bg-red-600 hover:bg-red-700 text-white rounded-xl">
                      <FileText className="h-3 w-3 mr-1" />
                      Connexion
                    </Button>
                  </div>
                </div>
              </CardContent>
            </Card>
          )}
        </div>
      </div>
    </div>
  );
};

// Upcoming Sites Component - Complete Implementation
const UpcomingSites = () => {
  const [sites, setSites] = useState([]);
  const [loading, setLoading] = useState(true);
  const [showForm, setShowForm] = useState(false);
  const [teamLeaders, setTeamLeaders] = useState([]);
  
  // NEW: Enhanced states for all button actions
  const [showFollowModal, setShowFollowModal] = useState(false);
  const [showEditModal, setShowEditModal] = useState(false);
  const [showStartModal, setShowStartModal] = useState(false);
  const [showDetailsModal, setShowDetailsModal] = useState(false);
  const [selectedSite, setSelectedSite] = useState(null);
  
  const [formData, setFormData] = useState({
    title: '',
    location: '',
    description: '',
    scheduled_date: '',
    scheduled_time: '08:00',
    priority: 'MEDIUM',
    assigned_to: '',
    status: 'PLANNED'
  });

  useEffect(() => {
    loadSites();
  }, []);

  const loadSites = async () => {
    try {
      // Charger les chefs d'équipe depuis le backend
      const token = localStorage.getItem('token');
      const leadersRes = await axios.get(`${API}/team-leaders`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      setTeamLeaders(leadersRes.data || []);
    } catch (error) {
      console.warn('Chefs d\'équipe non disponibles, utilisation de données simulées');
      // Données simulées des chefs d'équipe
      setTeamLeaders([
        { id: '1', nom: 'Dupont', prenom: 'Jean', specialite: 'Détection de réseaux' },
        { id: '2', nom: 'Martin', prenom: 'Marie', specialite: 'Géolocalisation' },
        { id: '3', nom: 'Durand', prenom: 'Pierre', specialite: 'Électricité' },
        { id: '4', nom: 'Leroy', prenom: 'Sophie', specialite: 'Plomberie' }
      ]);
    }

    // Simulation de données de planning  
    setTimeout(() => {
      setSites([
        {
          id: '1',
          title: 'Recherche réseaux Avenue des Champs',
          location: 'Paris 8ème',
          description: 'Localisation réseaux électriques et télécoms',
          scheduled_date: '2024-01-20',
          scheduled_time: '09:00',
          priority: 'HIGH',
          status: 'PLANNED',
          assigned_to: 'Jean Dupont'
        },
        {
          id: '2',
          title: 'Inspection canalisations Boulevard Saint-Michel',
          location: 'Paris 5ème',
          description: 'Vérification état canalisations eau',
          scheduled_date: '2024-01-22',
          scheduled_time: '14:30',
          priority: 'MEDIUM',
          status: 'IN_PROGRESS',
          assigned_to: 'Marie Martin'
        },
        {
          id: '3',
          title: 'Détection réseaux gaz Rue de Rivoli',
          location: 'Paris 1er',
          description: 'Localisation précise conduites gaz',
          scheduled_date: '2024-01-25',
          scheduled_time: '08:00',
          priority: 'HIGH',
          status: 'PLANNED',
          assigned_to: 'Pierre Durand'
        }
      ]);
      setLoading(false);
    }, 1000);
  };

  const getPriorityColor = (priority) => {
    switch (priority) {
      case 'HIGH': return 'bg-red-100 text-red-700 border-red-200';
      case 'MEDIUM': return 'bg-yellow-100 text-yellow-700 border-yellow-200';
      case 'LOW': return 'bg-green-100 text-green-700 border-green-200';
      default: return 'bg-gray-100 text-gray-700 border-gray-200';
    }
  };

  const getStatusColor = (status) => {
    switch (status) {
      case 'PLANNED': return 'bg-blue-100 text-blue-700';
      case 'IN_PROGRESS': return 'bg-orange-100 text-orange-700';
      case 'COMPLETED': return 'bg-green-100 text-green-700';
      case 'CANCELLED': return 'bg-gray-100 text-gray-700';
      default: return 'bg-gray-100 text-gray-700';
    }
  };

  const formatDate = (dateString) => {
    return new Date(dateString).toLocaleDateString('fr-FR', {
      weekday: 'long',
      day: '2-digit',
      month: 'long',
      year: 'numeric'
    });
  };

  // NEW: Enhanced button action functions
  const handleFollowSite = (site) => {
    setSelectedSite(site);
    setShowFollowModal(true);
  };

  const handleEditSite = (site) => {
    setSelectedSite(site);
    setFormData({
      title: site.title,
      location: site.location,
      description: site.description,
      scheduled_date: site.scheduled_date,
      scheduled_time: site.scheduled_time || '08:00',
      priority: site.priority,
      assigned_to: site.assigned_to,
      status: site.status
    });
    setShowEditModal(true);
  };

  const handleStartSite = (site) => {
    setSelectedSite(site);
    setShowStartModal(true);
  };

  const handleViewDetails = (site) => {
    setSelectedSite(site);
    setShowDetailsModal(true);
  };

  const updateSiteStatus = (siteId, newStatus) => {
    setSites(prev => prev.map(site => 
      site.id === siteId ? { ...site, status: newStatus } : site
    ));
  };

  const confirmStartSite = () => {
    if (selectedSite) {
      updateSiteStatus(selectedSite.id, 'IN_PROGRESS');
      setShowStartModal(false);
      setSelectedSite(null);
      alert(`✅ Chantier "${selectedSite.title}" démarré avec succès !`);
    }
  };

  const updateSite = () => {
    if (selectedSite) {
      setSites(prev => prev.map(site => 
        site.id === selectedSite.id ? { ...site, ...formData } : site
      ));
      setShowEditModal(false);
      setSelectedSite(null);
      alert(`✅ Chantier "${formData.title}" modifié avec succès !`);
    }
  };

  const completeSite = (siteId) => {
    if (confirm('Marquer ce chantier comme terminé ?')) {
      updateSiteStatus(siteId, 'COMPLETED');
      alert('✅ Chantier marqué comme terminé !');
    }
  };

  const cancelSite = (siteId) => {
    if (confirm('Annuler ce chantier ? Cette action ne peut pas être annulée.')) {
      updateSiteStatus(siteId, 'CANCELLED');
      alert('❌ Chantier annulé.');
    }
  };

  if (loading) {
    return (
      <Card className="bg-white/80 backdrop-blur-xl rounded-3xl border-0 shadow-2xl">
        <CardContent className="p-8 text-center">
          <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-orange-500 mx-auto"></div>
          <p className="mt-4 text-gray-600">Chargement du planning...</p>
        </CardContent>
      </Card>
    );
  }

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="bg-white/80 backdrop-blur-xl rounded-3xl border-0 shadow-2xl p-8">
        <div className="flex items-center justify-between">
          <div>
            <h2 className="text-2xl font-semibold text-gray-900">Gestion des Chantiers</h2>
            <p className="text-gray-600 mt-1">Organisez et suivez vos chantiers actifs et à planifier</p>
          </div>
          <Button
            onClick={() => setShowForm(true)}
            className="bg-gradient-to-r from-orange-600 to-orange-700 hover:from-orange-700 hover:to-orange-800 text-white rounded-2xl px-6 py-3 shadow-lg transform transition-all duration-200 hover:scale-105"
          >
            <Plus className="h-4 w-4 mr-2" />
            Nouveau Chantier
          </Button>
        </div>
      </div>

      {/* Planning Form */}
      {showForm && (
        <Card className="bg-white/80 backdrop-blur-xl rounded-3xl border-0 shadow-2xl">
          <CardHeader className="pb-6">
            <div className="flex items-center justify-between">
              <CardTitle className="text-xl font-semibold text-gray-900">Créer un nouveau chantier</CardTitle>
              <Button
                onClick={() => setShowForm(false)}
                variant="ghost"
                size="sm"
                className="text-gray-500 hover:text-gray-700"
              >
                <X className="h-4 w-4" />
              </Button>
            </div>
          </CardHeader>
          <CardContent className="px-8 pb-8">
            <form className="space-y-6">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Nom du chantier *</label>
                  <Input
                    value={formData.title}
                    onChange={(e) => setFormData(prev => ({...prev, title: e.target.value}))}
                    placeholder="Ex: Rénovation Bureau Avenue des Champs"
                    className="rounded-xl border-gray-200 focus:border-orange-500 focus:ring-orange-500/20"
                  />
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Localisation *</label>
                  <Input
                    value={formData.location}
                    onChange={(e) => setFormData(prev => ({...prev, location: e.target.value}))}
                    placeholder="Adresse ou zone du chantier"
                    className="rounded-xl border-gray-200 focus:border-orange-500 focus:ring-orange-500/20"
                  />
                </div>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Description du chantier</label>
                <textarea
                  value={formData.description}
                  onChange={(e) => setFormData(prev => ({...prev, description: e.target.value}))}
                  rows={3}
                  placeholder="Description détaillée des travaux à effectuer..."
                  className="w-full rounded-xl border border-gray-200 focus:border-orange-500 focus:ring-2 focus:ring-orange-500/20 transition-all duration-200 p-3 resize-none"
                />
              </div>

              <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Date prévue *</label>
                  <Input
                    type="date"
                    value={formData.scheduled_date}
                    onChange={(e) => setFormData(prev => ({...prev, scheduled_date: e.target.value}))}
                    className="rounded-xl border-gray-200 focus:border-orange-500 focus:ring-orange-500/20"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Heure prévue *</label>
                  <Input
                    type="time"
                    value={formData.scheduled_time}
                    onChange={(e) => setFormData(prev => ({...prev, scheduled_time: e.target.value}))}
                    className="rounded-xl border-gray-200 focus:border-orange-500 focus:ring-orange-500/20"
                  />
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Priorité</label>
                  <select
                    value={formData.priority}
                    onChange={(e) => setFormData(prev => ({...prev, priority: e.target.value}))}
                    className="w-full rounded-xl border border-gray-200 focus:border-orange-500 focus:ring-2 focus:ring-orange-500/20 transition-all duration-200 p-3"
                  >
                    <option value="LOW">Faible</option>
                    <option value="MEDIUM">Moyenne</option>
                    <option value="HIGH">Élevée</option>
                  </select>
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Assigné à</label>
                  <select
                    value={formData.assigned_to}
                    onChange={(e) => setFormData(prev => ({...prev, assigned_to: e.target.value}))}
                    className="w-full rounded-xl border border-gray-200 focus:border-orange-500 focus:ring-2 focus:ring-orange-500/20 transition-all duration-200 p-3"
                  >
                    <option value="">Sélectionner un chef d'équipe</option>
                    {teamLeaders.map(leader => (
                      <option key={leader.id} value={`${leader.prenom} ${leader.nom}`}>
                        {leader.prenom} {leader.nom} - {leader.specialite}
                      </option>
                    ))}
                  </select>
                </div>
              </div>

              <div className="pt-4 flex space-x-4">
                <Button
                  type="submit"
                  className="flex-1 bg-gradient-to-r from-orange-600 to-orange-700 hover:from-orange-700 hover:to-orange-800 text-white rounded-2xl py-3 shadow-lg transform transition-all duration-200 hover:scale-105"
                >
                  <Building className="h-4 w-4 mr-2" />
                  Créer le chantier
                </Button>
                <Button
                  type="button"
                  onClick={() => setShowForm(false)}
                  variant="outline"
                  className="rounded-2xl px-6"
                >
                  Annuler
                </Button>
              </div>
            </form>
          </CardContent>
        </Card>
      )}

      {/* NEW: Three-Section Layout for Chantiers */}
      <div className="grid lg:grid-cols-3 gap-6">
        
        {/* Section 1: Chantiers Actifs */}
        <div className="space-y-4">
          <div className="flex items-center justify-between mb-6">
            <div>
              <h3 className="text-xl font-bold text-gray-900 flex items-center">
                <div className="w-3 h-3 bg-green-500 rounded-full mr-3"></div>
                Chantiers Actifs
              </h3>
              <p className="text-sm text-gray-600 mt-1">Chantiers en cours d'exécution</p>
            </div>
            <div className="bg-green-100 text-green-700 px-3 py-1 rounded-full text-sm font-medium">
              {sites.filter(s => s.status === 'IN_PROGRESS').length} en cours
            </div>
          </div>
          
          <div className="space-y-4">
            {sites.filter(s => s.status === 'IN_PROGRESS').length === 0 ? (
              <Card className="bg-white/80 backdrop-blur-xl rounded-3xl border-0 shadow-lg">
                <CardContent className="p-8 text-center">
                  <div className="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center mx-auto mb-4">
                    <Building className="h-6 w-6 text-green-600" />
                  </div>
                  <h4 className="text-lg font-semibold text-gray-900 mb-2">Aucun chantier actif</h4>
                  <p className="text-gray-500 text-sm">Les chantiers en cours apparaîtront ici</p>
                </CardContent>
              </Card>
            ) : (
              sites.filter(s => s.status === 'IN_PROGRESS').map((site) => (
                <Card key={site.id} className="bg-white/80 backdrop-blur-xl rounded-3xl border-0 shadow-lg hover:shadow-xl transition-all duration-300">
                  <CardContent className="p-6">
                    <div className="flex items-start justify-between">
                      <div className="flex-1">
                        <div className="flex items-center space-x-3 mb-2">
                          <div className="w-3 h-3 bg-green-500 rounded-full"></div>
                          <h4 className="text-lg font-semibold text-gray-900">{site.title}</h4>
                          <Badge className="bg-green-100 text-green-700">En cours</Badge>
                          <Badge className={getPriorityColor(site.priority)}>
                            {site.priority === 'HIGH' ? 'Élevée' : site.priority === 'MEDIUM' ? 'Moyenne' : 'Faible'}
                          </Badge>
                        </div>
                        
                        <p className="text-gray-600 mb-3 text-sm">{site.description}</p>
                        
                        <div className="space-y-2 text-xs text-gray-500">
                          <div className="flex items-center">
                            <MapPin className="h-3 w-3 mr-2" />
                            {site.location}
                          </div>
                          <div className="flex items-center space-x-4">
                            <span className="flex items-center">
                              <Calendar className="h-3 w-3 mr-1" />
                              {formatDate(site.scheduled_date)}
                            </span>
                            {site.scheduled_time && (
                              <span className="flex items-center">
                                <Clock className="h-3 w-3 mr-1" />
                                {site.scheduled_time}
                              </span>
                            )}
                            <span className="flex items-center">
                              <Users className="h-3 w-3 mr-1" />
                              {site.assigned_to}
                            </span>
                          </div>
                        </div>
                      </div>
                      
                      <div className="flex flex-col space-y-2">
                        <Button 
                          size="sm" 
                          onClick={() => handleFollowSite(site)}
                          className="bg-green-600 hover:bg-green-700 text-white rounded-xl text-xs px-3 py-1"
                        >
                          <Eye className="h-3 w-3 mr-1" />
                          Suivre
                        </Button>
                        <Button 
                          size="sm" 
                          onClick={() => handleEditSite(site)}
                          variant="outline" 
                          className="rounded-xl text-xs px-3 py-1 border-gray-200"
                        >
                          <Edit className="h-3 w-3 mr-1" />
                          Modifier
                        </Button>
                      </div>
                    </div>
                  </CardContent>
                </Card>
              ))
            )}
          </div>
        </div>

        {/* Section 2: Chantiers à Planifier */}
        <div className="space-y-4">
          <div className="flex items-center justify-between mb-6">
            <div>
              <h3 className="text-xl font-bold text-gray-900 flex items-center">
                <div className="w-3 h-3 bg-orange-500 rounded-full mr-3"></div>
                Chantiers à Planifier
              </h3>
              <p className="text-sm text-gray-600 mt-1">Chantiers en attente de démarrage</p>
            </div>
            <div className="bg-orange-100 text-orange-700 px-3 py-1 rounded-full text-sm font-medium">
              {sites.filter(s => s.status === 'PLANNED').length} à planifier
            </div>
          </div>
          
          <div className="space-y-4">
            {sites.filter(s => s.status === 'PLANNED').length === 0 ? (
              <Card className="bg-white/80 backdrop-blur-xl rounded-3xl border-0 shadow-lg">
                <CardContent className="p-8 text-center">
                  <div className="w-12 h-12 bg-orange-100 rounded-xl flex items-center justify-center mx-auto mb-4">
                    <Calendar className="h-6 w-6 text-orange-600" />
                  </div>
                  <h4 className="text-lg font-semibold text-gray-900 mb-2">Aucun chantier à planifier</h4>
                  <p className="text-gray-500 text-sm">Planifiez votre premier chantier pour commencer</p>
                  <Button
                    onClick={() => setShowForm(true)}
                    className="mt-4 bg-orange-600 hover:bg-orange-700 text-white rounded-xl px-4 py-2 text-sm"
                  >
                    <Plus className="h-4 w-4 mr-2" />
                    Nouveau Chantier
                  </Button>
                </CardContent>
              </Card>
            ) : (
              sites.filter(s => s.status === 'PLANNED').map((site) => (
                <Card key={site.id} className="bg-white/80 backdrop-blur-xl rounded-3xl border-0 shadow-lg hover:shadow-xl transition-all duration-300">
                  <CardContent className="p-6">
                    <div className="flex items-start justify-between">
                      <div className="flex-1">
                        <div className="flex items-center space-x-3 mb-2">
                          <div className="w-3 h-3 bg-orange-500 rounded-full"></div>
                          <h4 className="text-lg font-semibold text-gray-900">{site.title}</h4>
                          <Badge className="bg-orange-100 text-orange-700">À planifier</Badge>
                          <Badge className={getPriorityColor(site.priority)}>
                            {site.priority === 'HIGH' ? 'Élevée' : site.priority === 'MEDIUM' ? 'Moyenne' : 'Faible'}
                          </Badge>
                        </div>
                        
                        <p className="text-gray-600 mb-3 text-sm">{site.description}</p>
                        
                        <div className="space-y-2 text-xs text-gray-500">
                          <div className="flex items-center">
                            <MapPin className="h-3 w-3 mr-2" />
                            {site.location}
                          </div>
                          <div className="flex items-center space-x-4">
                            <span className="flex items-center">
                              <Calendar className="h-3 w-3 mr-1" />
                              {formatDate(site.scheduled_date)}
                            </span>
                            {site.scheduled_time && (
                              <span className="flex items-center">
                                <Clock className="h-3 w-3 mr-1" />
                                {site.scheduled_time}
                              </span>
                            )}
                            <span className="flex items-center">
                              <Users className="h-3 w-3 mr-1" />
                              {site.assigned_to}
                            </span>
                          </div>
                        </div>
                      </div>
                      
                      <div className="flex flex-col space-y-2">
                        <Button 
                          size="sm" 
                          onClick={() => handleStartSite(site)}
                          className="bg-orange-600 hover:bg-orange-700 text-white rounded-xl text-xs px-3 py-1"
                        >
                          <Play className="h-3 w-3 mr-1" />
                          Démarrer
                        </Button>
                        <Button 
                          size="sm" 
                          onClick={() => handleEditSite(site)}
                          variant="outline" 
                          className="rounded-xl text-xs px-3 py-1 border-gray-200"
                        >
                          <Edit className="h-3 w-3 mr-1" />
                          Modifier
                        </Button>
                      </div>
                    </div>
                  </CardContent>
                </Card>
              ))
            )}
          </div>
        </div>

        {/* Section 3: Chantiers Terminés */}
        <div className="space-y-4">
          <div className="flex items-center justify-between mb-6">
            <div>
              <h3 className="text-xl font-bold text-gray-900 flex items-center">
                <div className="w-3 h-3 bg-gray-500 rounded-full mr-3"></div>
                Chantiers Terminés
              </h3>
              <p className="text-sm text-gray-600 mt-1">Chantiers finalisés</p>
            </div>
            <div className="bg-gray-100 text-gray-700 px-3 py-1 rounded-full text-sm font-medium">
              {sites.filter(s => s.status === 'COMPLETED' || s.status === 'CANCELLED').length} terminés
            </div>
          </div>
          
          <div className="space-y-4">
            {sites.filter(s => s.status === 'COMPLETED' || s.status === 'CANCELLED').length === 0 ? (
              <Card className="bg-white/80 backdrop-blur-xl rounded-3xl border-0 shadow-lg">
                <CardContent className="p-8 text-center">
                  <div className="w-12 h-12 bg-gray-100 rounded-xl flex items-center justify-center mx-auto mb-4">
                    <CheckCircle className="h-6 w-6 text-gray-400" />
                  </div>
                  <h4 className="text-lg font-semibold text-gray-900 mb-2">Aucun chantier terminé</h4>
                  <p className="text-gray-500 text-sm">Les chantiers terminés apparaîtront ici</p>
                </CardContent>
              </Card>
            ) : (
              sites.filter(s => s.status === 'COMPLETED' || s.status === 'CANCELLED').map((site) => (
                <Card key={site.id} className="bg-white/80 backdrop-blur-xl rounded-3xl border-0 shadow-lg hover:shadow-xl transition-all duration-300">
                  <CardContent className="p-6">
                    <div className="flex items-start justify-between">
                      <div className="flex-1">
                        <div className="flex items-center space-x-3 mb-2">
                          <div className={`w-3 h-3 rounded-full ${site.status === 'COMPLETED' ? 'bg-green-500' : 'bg-red-500'}`}></div>
                          <h4 className="text-lg font-semibold text-gray-900">{site.title}</h4>
                          <Badge className={site.status === 'COMPLETED' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}>
                            {site.status === 'COMPLETED' ? '✅ Terminé' : '❌ Annulé'}
                          </Badge>
                        </div>
                        
                        {site.description && (
                          <p className="text-gray-600 mb-3 text-sm">{site.description}</p>
                        )}
                        
                        <div className="space-y-2 text-xs text-gray-500">
                          {site.location && (
                            <div className="flex items-center">
                              <MapPin className="h-3 w-3 mr-2" />
                              {site.location}
                            </div>
                          )}
                          <div className="flex items-center space-x-4">
                            {site.scheduled_date && (
                              <span className="flex items-center">
                                <Calendar className="h-3 w-3 mr-1" />
                                {formatDate(site.scheduled_date)}
                              </span>
                            )}
                            {site.assigned_to && (
                              <span className="flex items-center">
                                <Users className="h-3 w-3 mr-1" />
                                {site.assigned_to}
                              </span>
                            )}
                          </div>
                        </div>
                      </div>
                      
                      <div className="flex flex-col space-y-2">
                        <Button 
                          size="sm" 
                          onClick={() => handleFollowSite(site)}
                          className="bg-gray-600 hover:bg-gray-700 text-white rounded-xl text-xs px-3 py-1"
                        >
                          <Eye className="h-3 w-3 mr-1" />
                          Détails
                        </Button>
                      </div>
                    </div>
                  </CardContent>
                </Card>
              ))
            )}
          </div>
        </div>
      </div>

      {/* NEW: Follow Site Modal */}
      {showFollowModal && selectedSite && (
        <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-3xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto">
            <div className="p-8">
              <div className="flex justify-between items-center mb-6">
                <div>
                  <h2 className="text-2xl font-bold text-gray-900">Suivi du Chantier</h2>
                  <p className="text-gray-600">{selectedSite.title}</p>
                </div>
                <Button
                  onClick={() => {
                    setShowFollowModal(false);
                    setSelectedSite(null);
                  }}
                  variant="outline"
                  className="rounded-xl"
                >
                  <X className="h-4 w-4" />
                </Button>
              </div>

              <div className="space-y-6">
                {/* Chantier Info */}
                <div className="bg-green-50 rounded-2xl p-6">
                  <div className="grid md:grid-cols-2 gap-4">
                    <div>
                      <h3 className="font-semibold text-green-900 mb-3">Informations Générales</h3>
                      <div className="space-y-2 text-sm">
                        <p><strong>Localisation:</strong> {selectedSite.location}</p>
                        <p><strong>Priorité:</strong> {selectedSite.priority === 'HIGH' ? 'Élevée' : selectedSite.priority === 'MEDIUM' ? 'Moyenne' : 'Faible'}</p>
                        <p><strong>Assigné à:</strong> {selectedSite.assigned_to}</p>
                        <p><strong>Date programmée:</strong> {formatDate(selectedSite.scheduled_date)}</p>
                        {selectedSite.scheduled_time && <p><strong>Heure:</strong> {selectedSite.scheduled_time}</p>}
                      </div>
                    </div>
                    <div>
                      <h3 className="font-semibold text-green-900 mb-3">Progression</h3>
                      <div className="space-y-3">
                        <div>
                          <div className="flex justify-between text-sm mb-1">
                            <span>Avancement</span>
                            <span>78%</span>
                          </div>
                          <div className="w-full bg-green-200 rounded-full h-2">
                            <div className="bg-green-600 h-2 rounded-full w-3/4"></div>
                          </div>
                        </div>
                        <div className="text-sm text-green-700">
                          <p>✅ Préparation terminée</p>
                          <p>✅ Équipements déployés</p>
                          <p>🔄 Intervention en cours</p>
                          <p>⏳ Finalisation en attente</p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                {/* Action Buttons */}
                <div className="flex space-x-3">
                  <Button
                    onClick={() => completeSite(selectedSite.id)}
                    className="bg-green-600 hover:bg-green-700 text-white rounded-xl"
                  >
                    <CheckCircle className="h-4 w-4 mr-2" />
                    Marquer Terminé
                  </Button>
                  <Button
                    onClick={() => handleViewDetails(selectedSite)}
                    variant="outline"
                    className="rounded-xl"
                  >
                    <FileText className="h-4 w-4 mr-2" />
                    Connexion
                  </Button>
                  <Button
                    onClick={() => cancelSite(selectedSite.id)}
                    variant="outline"
                    className="rounded-xl border-red-200 text-red-600 hover:bg-red-50"
                  >
                    <XCircle className="h-4 w-4 mr-2" />
                    Annuler Chantier
                  </Button>
                </div>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* NEW: Start Site Modal */}
      {showStartModal && selectedSite && (
        <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-3xl shadow-2xl max-w-2xl w-full">
            <div className="p-8">
              <div className="flex justify-between items-center mb-6">
                <div>
                  <h2 className="text-2xl font-bold text-gray-900">Démarrer le Chantier</h2>
                  <p className="text-gray-600">{selectedSite.title}</p>
                </div>
                <Button
                  onClick={() => {
                    setShowStartModal(false);
                    setSelectedSite(null);
                  }}
                  variant="outline"
                  className="rounded-xl"
                >
                  <X className="h-4 w-4" />
                </Button>
              </div>

              <div className="space-y-6">
                <div className="bg-orange-50 rounded-2xl p-6">
                  <h3 className="font-semibold text-orange-900 mb-4">Vérifications avant démarrage</h3>
                  <div className="space-y-3 text-sm">
                    <label className="flex items-center space-x-3">
                      <input type="checkbox" className="rounded border-gray-300" defaultChecked />
                      <span>✅ Équipe assignée disponible ({selectedSite.assigned_to})</span>
                    </label>
                    <label className="flex items-center space-x-3">
                      <input type="checkbox" className="rounded border-gray-300" defaultChecked />
                      <span>✅ Matériel et équipements prêts</span>
                    </label>
                    <label className="flex items-center space-x-3">
                      <input type="checkbox" className="rounded border-gray-300" defaultChecked />
                      <span>✅ Autorisations et permis obtenus</span>
                    </label>
                    <label className="flex items-center space-x-3">
                      <input type="checkbox" className="rounded border-gray-300" defaultChecked />
                      <span>✅ Site accessible et sécurisé</span>
                    </label>
                  </div>
                </div>

                <div>
                  <p className="text-sm text-gray-600 mb-4">
                    Le démarrage de ce chantier changera son statut de "À planifier" vers "En cours" et notifiera l'équipe assignée.
                  </p>
                </div>

                <div className="flex space-x-3">
                  <Button
                    onClick={confirmStartSite}
                    className="flex-1 bg-orange-600 hover:bg-orange-700 text-white rounded-xl"
                  >
                    <Play className="h-4 w-4 mr-2" />
                    Démarrer Maintenant
                  </Button>
                  <Button
                    onClick={() => {
                      setShowStartModal(false);
                      setSelectedSite(null);
                    }}
                    variant="outline"
                    className="rounded-xl px-6"
                  >
                    Annuler
                  </Button>
                </div>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* NEW: Edit Site Modal */}
      {showEditModal && selectedSite && (
        <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-3xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div className="p-8">
              <div className="flex justify-between items-center mb-6">
                <div>
                  <h2 className="text-2xl font-bold text-gray-900">Modifier le Chantier</h2>
                  <p className="text-gray-600">Mettre à jour les informations</p>
                </div>
                <Button
                  onClick={() => {
                    setShowEditModal(false);
                    setSelectedSite(null);
                  }}
                  variant="outline"
                  className="rounded-xl"
                >
                  <X className="h-4 w-4" />
                </Button>
              </div>

              <div className="space-y-6">
                <div className="grid md:grid-cols-2 gap-6">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">Nom du chantier</label>
                    <Input
                      value={formData.title}
                      onChange={(e) => setFormData(prev => ({...prev, title: e.target.value}))}
                      className="rounded-xl border-gray-200"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">Localisation</label>
                    <Input
                      value={formData.location}
                      onChange={(e) => setFormData(prev => ({...prev, location: e.target.value}))}
                      className="rounded-xl border-gray-200"
                    />
                  </div>
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Description</label>
                  <textarea
                    value={formData.description}
                    onChange={(e) => setFormData(prev => ({...prev, description: e.target.value}))}
                    rows={3}
                    className="w-full rounded-xl border border-gray-200 px-3 py-2 resize-none"
                  />
                </div>

                <div className="grid md:grid-cols-3 gap-6">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">Date programmée</label>
                    <Input
                      type="date"
                      value={formData.scheduled_date}
                      onChange={(e) => setFormData(prev => ({...prev, scheduled_date: e.target.value}))}
                      className="rounded-xl border-gray-200"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">Heure</label>
                    <Input
                      type="time"
                      value={formData.scheduled_time}
                      onChange={(e) => setFormData(prev => ({...prev, scheduled_time: e.target.value}))}
                      className="rounded-xl border-gray-200"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">Priorité</label>
                    <select
                      value={formData.priority}
                      onChange={(e) => setFormData(prev => ({...prev, priority: e.target.value}))}
                      className="w-full rounded-xl border border-gray-200 px-3 py-2"
                    >
                      <option value="LOW">Faible</option>
                      <option value="MEDIUM">Moyenne</option>
                      <option value="HIGH">Élevée</option>
                    </select>
                  </div>
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Assigné à</label>
                  <select
                    value={formData.assigned_to}
                    onChange={(e) => setFormData(prev => ({...prev, assigned_to: e.target.value}))}
                    className="w-full rounded-xl border border-gray-200 px-3 py-2"
                  >
                    <option value="">Sélectionner un chef d'équipe</option>
                    {teamLeaders.map((leader) => (
                      <option key={leader.id} value={`${leader.prenom} ${leader.nom}`}>
                        {leader.prenom} {leader.nom} - {leader.specialite}
                      </option>
                    ))}
                  </select>
                </div>

                <div className="flex space-x-3 pt-4 border-t">
                  <Button
                    onClick={updateSite}
                    className="flex-1 bg-blue-600 hover:bg-blue-700 text-white rounded-xl"
                  >
                    <Save className="h-4 w-4 mr-2" />
                    Sauvegarder Modifications
                  </Button>
                  <Button
                    onClick={() => {
                      setShowEditModal(false);
                      setSelectedSite(null);
                    }}
                    variant="outline"
                    className="rounded-xl px-6"
                  >
                    Annuler
                  </Button>
                </div>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* NEW: Details Modal */}
      {showDetailsModal && selectedSite && (
        <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-3xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div className="p-8">
              <div className="flex justify-between items-center mb-6">
                <div>
                  <h2 className="text-2xl font-bold text-gray-900">Détails du Chantier</h2>
                  <p className="text-gray-600">{selectedSite.title}</p>
                </div>
                <Button
                  onClick={() => {
                    setShowDetailsModal(false);
                    setSelectedSite(null);
                  }}
                  variant="outline"
                  className="rounded-xl"
                >
                  <X className="h-4 w-4" />
                </Button>
              </div>

              <div className="space-y-6">
                {/* Informations Détaillées */}
                <div className="bg-blue-50 rounded-2xl p-6">
                  <h3 className="font-semibold text-blue-900 mb-4">Rapport Complet</h3>
                  <div className="grid md:grid-cols-2 gap-6">
                    <div className="space-y-4">
                      <div>
                        <h4 className="font-medium text-gray-900 mb-2">Informations Générales</h4>
                        <div className="space-y-1 text-sm text-gray-600">
                          <p><strong>Localisation:</strong> {selectedSite.location}</p>
                          <p><strong>Description:</strong> {selectedSite.description}</p>
                          <p><strong>Priorité:</strong> {selectedSite.priority === 'HIGH' ? 'Élevée' : selectedSite.priority === 'MEDIUM' ? 'Moyenne' : 'Faible'}</p>
                          <p><strong>Statut:</strong> {selectedSite.status === 'IN_PROGRESS' ? 'En cours' : 'À planifier'}</p>
                        </div>
                      </div>
                      <div>
                        <h4 className="font-medium text-gray-900 mb-2">Planning</h4>
                        <div className="space-y-1 text-sm text-gray-600">
                          <p><strong>Date programmée:</strong> {formatDate(selectedSite.scheduled_date)}</p>
                          <p><strong>Heure de début:</strong> {selectedSite.scheduled_time}</p>
                          <p><strong>Durée estimée:</strong> 4-6 heures</p>
                          <p><strong>Équipe assignée:</strong> {selectedSite.assigned_to}</p>
                        </div>
                      </div>
                    </div>
                    <div className="space-y-4">
                      <div>
                        <h4 className="font-medium text-gray-900 mb-2">Ressources</h4>
                        <div className="space-y-1 text-sm text-gray-600">
                          <p>• Détecteur de réseaux portable</p>
                          <p>• Géoradar haute précision</p>
                          <p>• Équipement de marquage</p>
                          <p>• Matériel de sécurité</p>
                        </div>
                      </div>
                      <div>
                        <h4 className="font-medium text-gray-900 mb-2">Contacts</h4>
                        <div className="space-y-1 text-sm text-gray-600">
                          <p><strong>Chef d'équipe:</strong> {selectedSite.assigned_to}</p>
                          <p><strong>Téléphone:</strong> 06.12.34.56.78</p>
                          <p><strong>Email:</strong> {selectedSite.assigned_to.toLowerCase().replace(' ', '.')}@skyapp.fr</p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <div className="flex space-x-3">
                  <Button
                    onClick={() => alert('📄 Rapport PDF généré !\n\nLe rapport détaillé a été téléchargé avec succès.')}
                    className="bg-blue-600 hover:bg-blue-700 text-white rounded-xl"
                  >
                    <Download className="h-4 w-4 mr-2" />
                    Télécharger PDF
                  </Button>
                  <Button
                    onClick={() => alert('📧 Rapport envoyé !\n\nLe rapport a été envoyé par email à l\'équipe concernée.')}
                    variant="outline"
                    className="rounded-xl"
                  >
                    <Mail className="h-4 w-4 mr-2" />
                    Envoyer par Email
                  </Button>
                </div>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

// Client Details View Component
const ClientDetailsView = ({ clientId, onBack }) => {
  const [client, setClient] = useState(null);
  const [searches, setSearches] = useState([]);
  const [projects, setProjects] = useState([]);
  const [quotes, setQuotes] = useState([]);
  const [invoices, setInvoices] = useState([]);
  const [activeTab, setActiveTab] = useState('overview');
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    loadClientData();
  }, [clientId]);

  const loadClientData = async () => {
    try {
      setLoading(true);
      
      // Cas spécial : recherches sans client
      if (clientId === 'NO_CLIENT') {
        setClient({ id: 'NO_CLIENT', nom: 'Clients occasionnels', email: '' });
        
        const searchesRes = await axios.get(`${API}/searches?without_client=true`, {
          headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
        }).catch(() => ({ data: [] }));
        
        setSearches(searchesRes.data || []);
        setProjects([]);
        setLoading(false);
        return;
      }
      
      const [clientRes, searchesRes, projectsRes, quotesRes, worksitesRes] = await Promise.all([
        axios.get(`${API}/clients/${clientId}`, {
          headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
        }),
        axios.get(`${API}/searches?client_id=${clientId}`, {
          headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
        }).catch(() => ({ data: { data: [] } })),
        axios.get(`${API}/projects?client_id=${clientId}`, {
          headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
        }).catch(() => ({ data: { data: [] } })),
        axios.get(`${API}/quotes?client_id=${clientId}`, {
          headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
        }).catch(() => ({ data: { data: [] } })),
        axios.get(`${API}/worksites?client_id=${clientId}`, {
          headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
        }).catch(() => ({ data: [] }))
      ]);

      setClient(clientRes.data);
      setSearches(searchesRes.data.data || searchesRes.data || []);
      setProjects(projectsRes.data.data || projectsRes.data || []);
      setQuotes(quotesRes.data.data || quotesRes.data || []);
      setInvoices(worksitesRes.data || []);
      
    } catch (error) {
      console.error('Erreur chargement client:', error);
    } finally {
      setLoading(false);
    }
  };

  if (loading) {
    return (
      <Card className="bg-white/80 backdrop-blur-xl rounded-3xl border-0 shadow-2xl">
        <CardContent className="p-12 text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-teal-600 mx-auto mb-4"></div>
          <p className="text-gray-600">Chargement des détails...</p>
        </CardContent>
      </Card>
    );
  }

  if (!client) {
    return (
      <Card className="bg-white/80 backdrop-blur-xl rounded-3xl border-0 shadow-2xl">
        <CardContent className="p-12 text-center">
          <p className="text-gray-500 mb-4">Client introuvable</p>
          <Button onClick={onBack} variant="outline" className="rounded-xl">
            ← Retour à la liste
          </Button>
        </CardContent>
      </Card>
    );
  }

  const tabs = [
    { id: 'overview', label: 'Vue d\'ensemble', count: null },
    { id: 'searches', label: 'Recherches', count: searches.length },
    { id: 'projects', label: 'Projets', count: projects.length },
    { id: 'quotes', label: 'Devis', count: quotes.length },
    { id: 'invoices', label: 'Factures', count: invoices.length },
  ];

  const recentActivity = [
    ...searches.map(s => ({ type: 'search', date: s.created_at, title: s.title || 'Recherche sans titre', data: s })),
    ...projects.map(p => ({ type: 'project', date: p.created_at, title: p.name, data: p })),
  ].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 10);

  return (
    <div className="space-y-6">
      {/* Header */}
      <Card className="bg-white/80 backdrop-blur-xl rounded-3xl border-0 shadow-2xl">
        <CardContent className="p-8">
          <Button 
            onClick={onBack}
            variant="ghost"
            className="mb-6 text-gray-600 hover:text-gray-800"
          >
            <ArrowLeft className="h-4 w-4 mr-2" />
            Retour à la liste
          </Button>

          <div className="flex items-start justify-between">
            <div className="flex items-start gap-6">
              <div className="w-20 h-20 bg-gradient-to-br from-teal-500 to-teal-600 rounded-2xl flex items-center justify-center text-white text-3xl font-bold shadow-lg">
                {client.nom?.charAt(0).toUpperCase()}
              </div>

              <div>
                <h1 className="text-3xl font-bold text-gray-900 mb-3">
                  {clientId === 'NO_CLIENT' ? '📋 ' : ''}{client.nom}
                </h1>
                {clientId === 'NO_CLIENT' ? (
                  <p className="text-gray-600 mt-2">
                    Recherches de clients occasionnels (sans suivi client)
                  </p>
                ) : (
                  <>
                    <div className="space-y-2 text-gray-600">
                      {client.email && (
                        <div className="flex items-center gap-2">
                          <Mail className="h-4 w-4" />
                          <a href={`mailto:${client.email}`} className="hover:text-teal-600">
                            {client.email}
                          </a>
                        </div>
                      )}
                      {client.telephone && (
                        <div className="flex items-center gap-2">
                          <Phone className="h-4 w-4" />
                          <a href={`tel:${client.telephone}`} className="hover:text-teal-600">
                            {client.telephone}
                          </a>
                        </div>
                      )}
                      {client.adresse && (
                        <div className="flex items-center gap-2">
                          <MapPin className="h-4 w-4" />
                          <span>{client.adresse}</span>
                        </div>
                      )}
                    </div>
                    <p className="text-sm text-gray-400 mt-3">
                      Client depuis le {new Date(client.created_at).toLocaleDateString('fr-FR')}
                    </p>
                  </>
                )}
              </div>
            </div>

            <div className="grid grid-cols-2 gap-4">
              <div className="bg-blue-50 rounded-xl p-4 text-center">
                <div className="text-2xl font-bold text-blue-600">{searches.length}</div>
                <div className="text-sm text-gray-600">Recherches</div>
              </div>
              <div className="bg-green-50 rounded-xl p-4 text-center">
                <div className="text-2xl font-bold text-green-600">{projects.length}</div>
                <div className="text-sm text-gray-600">Projets</div>
              </div>
              <div className="bg-purple-50 rounded-xl p-4 text-center">
                <div className="text-2xl font-bold text-purple-600">{quotes.length}</div>
                <div className="text-sm text-gray-600">Devis</div>
              </div>
              <div className="bg-orange-50 rounded-xl p-4 text-center">
                <div className="text-2xl font-bold text-orange-600">{invoices.length}</div>
                <div className="text-sm text-gray-600">Factures</div>
              </div>
            </div>
          </div>
        </CardContent>
      </Card>

      {/* Tabs */}
      <Card className="bg-white/80 backdrop-blur-xl rounded-3xl border-0 shadow-2xl">
        <div className="flex border-b overflow-x-auto">
          {tabs.map(tab => (
            <button
              key={tab.id}
              onClick={() => setActiveTab(tab.id)}
              className={`px-8 py-4 font-medium whitespace-nowrap transition ${
                activeTab === tab.id
                  ? 'border-b-2 border-teal-600 text-teal-600'
                  : 'text-gray-600 hover:text-gray-800'
              }`}
            >
              {tab.label}
              {tab.count !== null && tab.count !== undefined && (
                <span className="ml-2 px-2 py-1 bg-gray-100 rounded-full text-xs font-semibold">
                  {tab.count}
                </span>
              )}
            </button>
          ))}
        </div>

        <CardContent className="p-8">
          {/* Vue d'ensemble */}
          {activeTab === 'overview' && (
            <div className="space-y-6">
              <div>
                <h3 className="text-lg font-semibold mb-4 flex items-center gap-2">
                  <Clock className="h-5 w-5" />
                  Activité récente
                </h3>
                
                {recentActivity.length === 0 ? (
                  <div className="text-center py-12 bg-gray-50 rounded-2xl">
                    <p className="text-gray-500">Aucune activité pour ce client</p>
                  </div>
                ) : (
                  <div className="space-y-3">
                    {recentActivity.map((activity, index) => (
                      <div key={index} className="flex items-start gap-4 p-4 bg-gray-50 rounded-xl hover:bg-gray-100 transition">
                        {activity.type === 'search' ? (
                          <div className="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center flex-shrink-0">
                            <Search className="h-5 w-5 text-blue-600" />
                          </div>
                        ) : (
                          <div className="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center flex-shrink-0">
                            <FolderOpen className="h-5 w-5 text-green-600" />
                          </div>
                        )}
                        
                        <div className="flex-1">
                          <div className="font-medium text-gray-800">{activity.title}</div>
                          <div className="text-sm text-gray-500">
                            {activity.type === 'search' ? '🔍 Recherche' : '📊 Projet'} • 
                            {' '}{new Date(activity.date).toLocaleDateString('fr-FR', {
                              day: 'numeric',
                              month: 'long',
                              year: 'numeric'
                            })}
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </div>

              {/* Statistiques */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div className="bg-gradient-to-br from-blue-50 to-blue-100 rounded-2xl p-6">
                  <h4 className="font-semibold mb-4 flex items-center gap-2">
                    <Search className="h-5 w-5" />
                    Recherches par type
                  </h4>
                  <div className="space-y-2">
                    <div className="flex justify-between items-center">
                      <span className="text-sm">🏞️ Terrain</span>
                      <span className="font-bold text-blue-600">
                        {searches.filter(s => s.search_type === 'TERRAIN').length}
                      </span>
                    </div>
                    <div className="flex justify-between items-center">
                      <span className="text-sm">💧 Infiltration</span>
                      <span className="font-bold text-orange-600">
                        {searches.filter(s => s.search_type === 'INFILTRATION').length}
                      </span>
                    </div>
                  </div>
                </div>

                <div className="bg-gradient-to-br from-green-50 to-green-100 rounded-2xl p-6">
                  <h4 className="font-semibold mb-4 flex items-center gap-2">
                    <FolderOpen className="h-5 w-5" />
                    Projets
                  </h4>
                  <div className="space-y-2">
                    <div className="flex justify-between items-center">
                      <span className="text-sm">📊 Total</span>
                      <span className="font-bold text-green-600">
                        {projects.length}
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* Recherches */}
          {activeTab === 'searches' && (
            <div>
              {searches.length === 0 ? (
                <div className="text-center py-12 bg-gray-50 rounded-2xl">
                  <Search className="h-12 w-12 mx-auto text-gray-300 mb-4" />
                  <p className="text-gray-500">Aucune recherche pour ce client</p>
                </div>
              ) : (
                <div className="space-y-4">
                  {searches.map(search => (
                    <div key={search.id} className="border-2 border-gray-100 rounded-2xl p-5 hover:shadow-lg transition">
                      <div className="flex items-start justify-between mb-3">
                        <div className="flex items-start gap-3">
                          {search.search_type === 'TERRAIN' ? (
                            <div className="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center flex-shrink-0">
                              <Landmark className="h-6 w-6 text-blue-600" />
                            </div>
                          ) : (
                            <div className="w-12 h-12 bg-orange-100 rounded-xl flex items-center justify-center flex-shrink-0">
                              <Droplets className="h-6 w-6 text-orange-600" />
                            </div>
                          )}
                          
                          <div>
                            <h4 className="font-semibold text-gray-800">{search.title || 'Sans titre'}</h4>
                            <p className="text-sm text-gray-500">
                              {new Date(search.created_at).toLocaleDateString('fr-FR')}
                            </p>
                          </div>
                        </div>

                        <span className={`px-3 py-1 rounded-full text-xs font-medium ${
                          search.status === 'SHARED' 
                            ? 'bg-green-100 text-green-700' 
                            : search.status === 'ACTIVE'
                            ? 'bg-blue-100 text-blue-700'
                            : 'bg-gray-100 text-gray-700'
                        }`}>
                          {search.status === 'SHARED' ? '📤 Partagée' : 
                           search.status === 'ACTIVE' ? '✅ Active' : '📝 Brouillon'}
                        </span>
                      </div>

                      {search.address && (
                        <div className="flex items-center gap-2 text-sm text-gray-600 mb-2">
                          <MapPin className="h-4 w-4" />
                          {search.address}
                        </div>
                      )}

                      {search.description && (
                        <p className="text-sm text-gray-600 line-clamp-2">{search.description}</p>
                      )}

                      {search.project_id && (
                        <div className="mt-3 flex items-center gap-2 text-sm text-green-600">
                          <CheckCircle className="h-4 w-4" />
                          Converti en projet
                        </div>
                      )}
                    </div>
                  ))}
                </div>
              )}
            </div>
          )}

          {/* Projets */}
          {activeTab === 'projects' && (
            <div>
              {projects.length === 0 ? (
                <div className="text-center py-12 bg-gray-50 rounded-2xl">
                  <FolderOpen className="h-12 w-12 mx-auto text-gray-300 mb-4" />
                  <p className="text-gray-500">Aucun projet pour ce client</p>
                </div>
              ) : (
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  {projects.map(project => (
                    <div key={project.id} className="border-2 border-gray-100 rounded-2xl p-5 hover:shadow-lg transition">
                      <div className="flex items-start justify-between mb-3">
                        <h4 className="font-semibold text-gray-800">{project.name}</h4>
                        <span className={`px-3 py-1 rounded-full text-xs font-medium ${
                          project.status === 'COMPLETED' 
                            ? 'bg-green-100 text-green-700' 
                            : project.status === 'ACTIVE'
                            ? 'bg-blue-100 text-blue-700'
                            : 'bg-yellow-100 text-yellow-700'
                        }`}>
                          {project.status}
                        </span>
                      </div>

                      {project.description && (
                        <p className="text-sm text-gray-600 mb-3 line-clamp-2">{project.description}</p>
                      )}

                      <div className="text-xs text-gray-400">
                        Créé le {new Date(project.created_at).toLocaleDateString('fr-FR')}
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          )}

          {/* Devis */}
          {activeTab === 'quotes' && (
            <div>
              {quotes.length === 0 ? (
                <div className="text-center py-12 bg-gray-50 rounded-2xl">
                  <FileText className="h-12 w-12 mx-auto text-gray-300 mb-4" />
                  <p className="text-gray-500">Aucun devis pour ce client</p>
                </div>
              ) : (
                <div className="space-y-4">
                  {quotes.map(quote => (
                    <div key={quote.id} className="border-2 border-gray-100 rounded-2xl p-5 hover:shadow-lg transition">
                      <div className="flex items-start justify-between mb-3">
                        <div>
                          <h4 className="font-semibold text-gray-800 mb-1">{quote.title || 'Devis sans titre'}</h4>
                          {quote.quote_number && (
                            <span className="text-xs font-mono bg-gray-100 px-2 py-1 rounded">
                              #{quote.quote_number}
                            </span>
                          )}
                        </div>
                        
                        <span className={`px-3 py-1 rounded-full text-xs font-medium ${
                          quote.status === 'CONVERTED_TO_WORKSITE' 
                            ? 'bg-green-100 text-green-700' 
                            : quote.status === 'SENT' || quote.status === 'PENDING'
                            ? 'bg-blue-100 text-blue-700'
                            : quote.status === 'DRAFT'
                            ? 'bg-purple-100 text-purple-700'
                            : 'bg-gray-100 text-gray-700'
                        }`}>
                          {quote.status === 'CONVERTED_TO_WORKSITE' ? '🏗️ Chantier' :
                           quote.status === 'SENT' ? '📧 Envoyé' :
                           quote.status === 'PENDING' ? '⏳ En attente' :
                           quote.status === 'DRAFT' ? '📝 Brouillon' : quote.status}
                        </span>
                      </div>

                      <div className="grid grid-cols-2 gap-4 mb-3">
                        <div>
                          <p className="text-xs text-gray-500">Montant</p>
                          <p className="text-lg font-bold text-gray-900">{quote.amount?.toFixed(2) || '0.00'}€</p>
                        </div>
                        <div>
                          <p className="text-xs text-gray-500">Date</p>
                          <p className="text-sm text-gray-700">
                            {new Date(quote.created_at).toLocaleDateString('fr-FR')}
                          </p>
                        </div>
                      </div>

                      {quote.description && (
                        <p className="text-sm text-gray-600 line-clamp-2 mb-3">{quote.description}</p>
                      )}

                      <div className="flex gap-2">
                        <Button
                          size="sm"
                          onClick={() => window.open(`/devis/${quote.id}`, '_blank')}
                          className="bg-gray-100 hover:bg-gray-200 text-gray-900 rounded-lg text-xs"
                        >
                          <FileText className="h-3 w-3 mr-1" />
                          Voir le devis
                        </Button>
                        {quote.status === 'CONVERTED_TO_WORKSITE' && (
                          <span className="inline-flex items-center text-xs text-green-600 bg-green-50 px-2 py-1 rounded-lg">
                            <CheckCircle className="h-3 w-3 mr-1" />
                            Converti en chantier
                          </span>
                        )}
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          )}

          {/* Factures / Chantiers */}
          {activeTab === 'invoices' && (
            <div>
              {invoices.length === 0 ? (
                <div className="text-center py-12 bg-gray-50 rounded-2xl">
                  <Receipt className="h-12 w-12 mx-auto text-gray-300 mb-4" />
                  <p className="text-gray-500">Aucun chantier pour ce client</p>
                </div>
              ) : (
                <div className="space-y-4">
                  {invoices.map(worksite => (
                    <div key={worksite.id} className="border-2 border-purple-100 rounded-2xl p-5 hover:shadow-lg transition">
                      <div className="flex items-start justify-between mb-3">
                        <div>
                          <h4 className="font-semibold text-gray-800 mb-1">{worksite.title || 'Chantier sans titre'}</h4>
                          {worksite.address && (
                            <div className="flex items-center gap-1 text-xs text-gray-500 mt-1">
                              <MapPin className="h-3 w-3" />
                              {worksite.address}
                            </div>
                          )}
                        </div>
                        
                        <span className={`px-3 py-1 rounded-full text-xs font-medium ${
                          worksite.status === 'COMPLETED' 
                            ? 'bg-green-100 text-green-700' 
                            : worksite.status === 'IN_PROGRESS'
                            ? 'bg-blue-100 text-blue-700'
                            : worksite.status === 'PENDING'
                            ? 'bg-orange-100 text-orange-700'
                            : 'bg-gray-100 text-gray-700'
                        }`}>
                          {worksite.status === 'COMPLETED' ? '✓ Terminé' :
                           worksite.status === 'IN_PROGRESS' ? '⚙️ En cours' :
                           worksite.status === 'PENDING' ? '⏳ En attente' : worksite.status}
                        </span>
                      </div>

                      <div className="grid grid-cols-2 gap-4 mb-3">
                        <div>
                          <p className="text-xs text-gray-500">Montant</p>
                          <p className="text-lg font-bold text-gray-900">{worksite.amount?.toFixed(2) || '0.00'}€</p>
                        </div>
                        <div>
                          <p className="text-xs text-gray-500">Date de création</p>
                          <p className="text-sm text-gray-700">
                            {new Date(worksite.created_at).toLocaleDateString('fr-FR')}
                          </p>
                        </div>
                      </div>

                      {worksite.description && (
                        <p className="text-sm text-gray-600 line-clamp-2 mb-3">{worksite.description}</p>
                      )}

                      <div className="flex gap-2 flex-wrap">
                        {worksite.quote_id && (
                          <Button
                            size="sm"
                            onClick={() => window.open(`/devis/${worksite.quote_id}`, '_blank')}
                            className="bg-blue-100 hover:bg-blue-200 text-blue-900 rounded-lg text-xs"
                          >
                            <FileText className="h-3 w-3 mr-1" />
                            Voir le devis
                          </Button>
                        )}
                        {worksite.status === 'COMPLETED' && (
                          <span className="inline-flex items-center text-xs text-emerald-600 bg-emerald-50 px-2 py-1 rounded-lg">
                            <CheckCircle className="h-3 w-3 mr-1" />
                            Facturé
                          </span>
                        )}
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          )}
        </CardContent>
      </Card>
    </div>
  );
};

// Clients View Component - Complete Implementation
const ClientsView = () => {
  const [clients, setClients] = useState([]);
  const [loading, setLoading] = useState(true);
  const [showForm, setShowForm] = useState(false);
  const [editingClient, setEditingClient] = useState(null);
  const [searchTerm, setSearchTerm] = useState('');
  const [selectedClient, setSelectedClient] = useState(null);
  const [showClientDetails, setShowClientDetails] = useState(false);
  const [formData, setFormData] = useState({
    nom: '',
    email: '',
    telephone: '',
    adresse: ''
  });

  useEffect(() => {
    loadClients();
  }, []);

  const loadClients = async () => {
    try {
      const response = await axios.get(`${API}/clients`, {
        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
      });
      setClients(response.data);
    } catch (error) {
      console.error('Erreur chargement clients:', error);
    } finally {
      setLoading(false);
    }
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    
    try {
      if (editingClient) {
        // Update existing client
        await axios.put(`${API}/clients/${editingClient.id}`, formData, {
          headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
        });
      } else {
        await axios.post(`${API}/clients`, formData, {
          headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
        });
      }

      alert(editingClient ? 'Client modifié avec succès !' : 'Client créé avec succès !');
      resetForm();
      loadClients();
    } catch (error) {
      console.error('Erreur:', error);
      alert('Erreur lors de la sauvegarde');
    }
  };

  const resetForm = () => {
    setFormData({ nom: '', email: '', telephone: '', adresse: '' });
    setShowForm(false);
    setEditingClient(null);
  };

  const editClient = (client) => {
    setFormData({
      nom: client.nom,
      email: client.email,
      telephone: client.telephone || '',
      adresse: client.adresse || ''
    });
    setEditingClient(client);
    setShowForm(true);
  };

  const deleteClient = async (clientId, clientName) => {
    if (!window.confirm(`Êtes-vous sûr de vouloir supprimer le client "${clientName}" ?\n\nCette action est irréversible.`)) {
      return;
    }

    try {
      await axios.delete(`${API}/clients/${clientId}`, {
        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
      });
      alert('Client supprimé avec succès !');
      loadClients();
    } catch (error) {
      console.error('Erreur suppression:', error);
      alert('Erreur lors de la suppression du client');
    }
  };

  const handleClientClick = (client) => {
    setSelectedClient(client);
    setShowClientDetails(true);
  };

  if (showClientDetails && selectedClient) {
    return (
      <ClientDetailsView 
        clientId={selectedClient.id}
        onBack={() => {
          setShowClientDetails(false);
          setSelectedClient(null);
          loadClients();
        }}
      />
    );
  }

  if (loading) {
    return (
      <Card className="bg-white/80 backdrop-blur-xl rounded-3xl border-0 shadow-2xl">
        <CardContent className="p-8 text-center">
          <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-teal-500 mx-auto"></div>
          <p className="mt-4 text-gray-600">Chargement des clients...</p>
        </CardContent>
      </Card>
    );
  }

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="bg-white/80 backdrop-blur-xl rounded-3xl border-0 shadow-2xl p-8">
        <div className="flex items-center justify-between mb-6">
          <div>
            <h2 className="text-2xl font-semibold text-gray-900">Gestion Clients</h2>
            <p className="text-gray-600 mt-1">Base de données clients et historique des interventions</p>
          </div>
          <div className="flex space-x-3">
            <Button
              onClick={() => {
                setSelectedClient({ id: 'NO_CLIENT', nom: 'Clients occasionnels' });
                setShowClientDetails(true);
              }}
              variant="outline"
              className="rounded-2xl px-6 py-3 border-2 border-gray-300 hover:border-gray-400"
            >
              <FileText className="h-4 w-4 mr-2" />
              Recherches sans client
            </Button>
            <Button
              onClick={() => setShowForm(true)}
              className="bg-gradient-to-r from-teal-600 to-teal-700 hover:from-teal-700 hover:to-teal-800 text-white rounded-2xl px-6 py-3 shadow-lg transform transition-all duration-200 hover:scale-105"
            >
              <Plus className="h-4 w-4 mr-2" />
              Nouveau Client
            </Button>
          </div>
        </div>

        {/* Barre de recherche */}
        <div className="relative">
          <Search className="absolute left-4 top-1/2 transform -translate-y-1/2 h-5 w-5 text-gray-400" />
          <Input
            type="text"
            placeholder="Rechercher un client (nom, email, téléphone)..."
            className="pl-12 pr-4 py-3 rounded-2xl border-gray-200 focus:border-teal-500 focus:ring-teal-500/20 w-full"
            value={searchTerm || ''}
            onChange={(e) => setSearchTerm(e.target.value)}
          />
        </div>
      </div>

      {/* Client Form */}
      {showForm && (
        <Card className="bg-white/80 backdrop-blur-xl rounded-3xl border-0 shadow-2xl">
          <CardHeader className="pb-6">
            <div className="flex items-center justify-between">
              <CardTitle className="text-xl font-semibold text-gray-900">
                {editingClient ? 'Modifier le client' : 'Nouveau client'}
              </CardTitle>
              <Button
                onClick={resetForm}
                variant="ghost"
                size="sm"
                className="text-gray-500 hover:text-gray-700"
              >
                <X className="h-4 w-4" />
              </Button>
            </div>
          </CardHeader>
          <CardContent className="px-8 pb-8">
            <form onSubmit={handleSubmit} className="space-y-6">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Nom/Raison sociale *</label>
                  <Input
                    value={formData.nom}
                    onChange={(e) => setFormData(prev => ({...prev, nom: e.target.value}))}
                    required
                    placeholder="Nom du client ou de l'entreprise"
                    className="rounded-xl border-gray-200 focus:border-teal-500 focus:ring-teal-500/20"
                  />
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Email *</label>
                  <Input
                    type="email"
                    value={formData.email}
                    onChange={(e) => setFormData(prev => ({...prev, email: e.target.value}))}
                    required
                    placeholder="contact@client.fr"
                    className="rounded-xl border-gray-200 focus:border-teal-500 focus:ring-teal-500/20"
                  />
                </div>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Téléphone</label>
                  <Input
                    type="tel"
                    value={formData.telephone}
                    onChange={(e) => setFormData(prev => ({...prev, telephone: e.target.value}))}
                    placeholder="01 23 45 67 89"
                    className="rounded-xl border-gray-200 focus:border-teal-500 focus:ring-teal-500/20"
                  />
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Adresse</label>
                  <Input
                    value={formData.adresse}
                    onChange={(e) => setFormData(prev => ({...prev, adresse: e.target.value}))}
                    placeholder="Adresse complète"
                    className="rounded-xl border-gray-200 focus:border-teal-500 focus:ring-teal-500/20"
                  />
                </div>
              </div>

              <div className="pt-4 flex space-x-4">
                <Button
                  type="submit"
                  className="flex-1 bg-gradient-to-r from-teal-600 to-teal-700 hover:from-teal-700 hover:to-teal-800 text-white rounded-2xl py-3 shadow-lg transform transition-all duration-200 hover:scale-105"
                >
                  <Users className="h-4 w-4 mr-2" />
                  {editingClient ? 'Modifier le client' : 'Créer le client'}
                </Button>
                <Button
                  type="button"
                  onClick={resetForm}
                  variant="outline"
                  className="rounded-2xl px-6"
                >
                  Annuler
                </Button>
              </div>
            </form>
          </CardContent>
        </Card>
      )}

      {/* Clients List */}
      <div className="grid gap-4">
        {clients.length === 0 ? (
          <Card className="bg-white/80 backdrop-blur-xl rounded-3xl border-0 shadow-2xl">
            <CardContent className="p-12 text-center">
              <Users className="h-16 w-16 mx-auto mb-4 text-gray-300" />
              <h3 className="text-xl font-semibold text-gray-900 mb-2">Aucun client enregistré</h3>
              <p className="text-gray-500">Ajoutez votre premier client pour commencer.</p>
            </CardContent>
          </Card>
        ) : (
          clients
            .filter(client => {
              if (!searchTerm) return true;
              const search = searchTerm.toLowerCase();
              return (
                client.nom?.toLowerCase().includes(search) ||
                client.email?.toLowerCase().includes(search) ||
                client.telephone?.toLowerCase().includes(search)
              );
            })
            .map((client) => (
            <Card key={client.id} className="bg-white/80 backdrop-blur-xl rounded-3xl border-0 shadow-lg hover:shadow-xl transition-all duration-300 cursor-pointer" onClick={() => handleClientClick(client)}>
              <CardContent className="p-6">
                <div className="flex items-start justify-between">
                  <div className="flex-1">
                    <div className="flex items-center space-x-3 mb-2">
                      <div className="w-12 h-12 bg-gradient-to-br from-teal-500 to-teal-600 rounded-xl flex items-center justify-center">
                        <span className="text-white font-semibold text-lg">
                          {client.nom.charAt(0).toUpperCase()}
                        </span>
                      </div>
                      <div>
                        <h3 className="text-lg font-semibold text-gray-900">{client.nom}</h3>
                        <p className="text-sm text-gray-500">Client depuis {new Date(client.created_at).toLocaleDateString('fr-FR')}</p>
                      </div>
                    </div>
                    
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                      <div className="flex items-center space-x-2 text-sm text-gray-600">
                        <Mail className="h-4 w-4" />
                        <span>{client.email}</span>
                      </div>
                      {client.telephone && (
                        <div className="flex items-center space-x-2 text-sm text-gray-600">
                          <Phone className="h-4 w-4" />
                          <span>{client.telephone}</span>
                        </div>
                      )}
                      {client.adresse && (
                        <div className="flex items-center space-x-2 text-sm text-gray-600 md:col-span-2">
                          <MapPin className="h-4 w-4" />
                          <span>{client.adresse}</span>
                        </div>
                      )}
                    </div>
                  </div>
                  
                  <div className="flex flex-col space-y-2">
                    <div className="flex space-x-2">
                      <Button
                        onClick={(e) => { e.stopPropagation(); editClient(client); }}
                        size="sm"
                        variant="outline"
                        className="rounded-xl flex-1"
                      >
                        Modifier
                      </Button>
                      <Button
                        onClick={(e) => { e.stopPropagation(); deleteClient(client.id, client.nom); }}
                        size="sm"
                        variant="destructive"
                        className="bg-red-600 hover:bg-red-700 text-white rounded-xl"
                      >
                        <Trash2 className="h-4 w-4" />
                      </Button>
                    </div>
                    <Button
                      onClick={(e) => e.stopPropagation()}
                      size="sm"
                      variant="outline"
                      className="rounded-xl border-2 border-teal-500 text-teal-600 hover:bg-teal-50 w-full"
                    >
                      <FileText className="h-4 w-4 mr-2" />
                      Créer un Devis
                    </Button>
                  </div>
                </div>
              </CardContent>
            </Card>
          ))
        )}
      </div>
    </div>
  );
};

// Catalog Management Component - Complete Implementation
const CatalogManagement = () => {
  const [products, setProducts] = useState([]);
  const [categories, setCategories] = useState(['Détection', 'Localisation', 'Inspection', 'Réparation']);
  const [loading, setLoading] = useState(false);
  const [showForm, setShowForm] = useState(false);
  const [editingProduct, setEditingProduct] = useState(null);
  const [productPhoto, setProductPhoto] = useState(null);
  const [uploadingPhoto, setUploadingPhoto] = useState(false);
  const [formData, setFormData] = useState({
    name: '',
    description: '',
    category: 'Détection',
    price: '',
    unit: 'unité',
    reference: ''
  });

  useEffect(() => {
    loadProducts();
  }, []);

  const loadProducts = async () => {
    try {
      setLoading(true);
      const response = await axios.get(`${API}/catalog/products`, {
        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
      });
      setProducts(response.data.data || []);
    } catch (error) {
      console.error('Erreur chargement produits:', error);
      alert('Erreur lors du chargement des produits');
    } finally {
      setLoading(false);
    }
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    
    try {
      setLoading(true);
      
      const productData = {
        ...formData,
        photo: productPhoto ? {
          name: productPhoto.name,
          type: productPhoto.type,
          data: productPhoto.data
        } : null
      };
      
      if (editingProduct) {
        await axios.put(`${API}/catalog/products/${editingProduct.id}`, productData, {
          headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
        });
        alert('Produit modifié avec succès !');
      } else {
        await axios.post(`${API}/catalog/products`, productData, {
          headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
        });
        alert('Produit ajouté avec succès !');
      }
      
      await loadProducts();
      resetForm();
    } catch (error) {
      console.error('Erreur sauvegarde produit:', error);
      alert('Erreur lors de la sauvegarde du produit');
    } finally {
      setLoading(false);
    }
  };

  const resetForm = () => {
    setFormData({
      name: '',
      description: '',
      category: 'Détection',
      price: '',
      unit: 'unité',
      reference: ''
    });
    setProductPhoto(null);
    setUploadingPhoto(false);
    setShowForm(false);
    setEditingProduct(null);
  };

  const editProduct = (product) => {
    setFormData({
      name: product.name,
      description: product.description,
      category: product.category,
      price: product.price.toString(),
      unit: product.unit,
      reference: product.reference
    });
    setEditingProduct(product);
    setShowForm(true);
  };

  const deleteProduct = async (productId) => {
    if (!window.confirm('Êtes-vous sûr de vouloir supprimer ce produit ?')) {
      return;
    }
    
    try {
      await axios.delete(`${API}/catalog/products/${productId}`, {
        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
      });
      setProducts(prev => prev.filter(p => p.id !== productId));
      alert('Produit supprimé avec succès !');
    } catch (error) {
      console.error('Erreur suppression produit:', error);
      alert('Erreur lors de la suppression du produit');
    }
  };

  const getCategoryColor = (category) => {
    switch (category) {
      case 'Détection': return 'bg-blue-100 text-blue-700';
      case 'Localisation': return 'bg-green-100 text-green-700';
      case 'Inspection': return 'bg-purple-100 text-purple-700';
      case 'Réparation': return 'bg-red-100 text-red-700';
      default: return 'bg-gray-100 text-gray-700';
    }
  };

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="bg-white/80 backdrop-blur-xl rounded-3xl border-0 shadow-2xl p-8">
        <div className="flex items-center justify-between">
          <div>
            <h2 className="text-2xl font-semibold text-gray-900">Catalogue Produits & Services</h2>
            <p className="text-gray-600 mt-1">Gérez votre catalogue de prestations et tarifs</p>
          </div>
          <Button
            onClick={() => setShowForm(true)}
            className="bg-gradient-to-r from-indigo-600 to-indigo-700 hover:from-indigo-700 hover:to-indigo-800 text-white rounded-2xl px-6 py-3 shadow-lg transform transition-all duration-200 hover:scale-105"
          >
            <Plus className="h-4 w-4 mr-2" />
            Nouveau Produit
          </Button>
        </div>
      </div>

      {/* Product Form */}
      {showForm && (
        <Card className="bg-white/80 backdrop-blur-xl rounded-3xl border-0 shadow-2xl">
          <CardHeader className="pb-6">
            <div className="flex items-center justify-between">
              <CardTitle className="text-xl font-semibold text-gray-900">
                {editingProduct ? 'Modifier le produit' : 'Nouveau produit'}
              </CardTitle>
              <Button
                onClick={resetForm}
                variant="ghost"
                size="sm"
                className="text-gray-500 hover:text-gray-700"
              >
                <X className="h-4 w-4" />
              </Button>
            </div>
          </CardHeader>
          <CardContent className="px-8 pb-8">
            <form onSubmit={handleSubmit} className="space-y-6">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Nom du produit/service *</label>
                  <Input
                    value={formData.name}
                    onChange={(e) => setFormData(prev => ({...prev, name: e.target.value}))}
                    required
                    placeholder="Ex: Détection réseaux électriques"
                    className="rounded-xl border-gray-200 focus:border-indigo-500 focus:ring-indigo-500/20"
                  />
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Référence</label>
                  <Input
                    value={formData.reference}
                    onChange={(e) => setFormData(prev => ({...prev, reference: e.target.value}))}
                    placeholder="Ex: DET-ELEC-001"
                    className="rounded-xl border-gray-200 focus:border-indigo-500 focus:ring-indigo-500/20"
                  />
                </div>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Description</label>
                <textarea
                  value={formData.description}
                  onChange={(e) => setFormData(prev => ({...prev, description: e.target.value}))}
                  rows={3}
                  placeholder="Description détaillée du produit ou service..."
                  className="w-full rounded-xl border border-gray-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500/20 transition-all duration-200 p-3 resize-none"
                />
              </div>

              <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Catégorie</label>
                  <select
                    value={formData.category}
                    onChange={(e) => setFormData(prev => ({...prev, category: e.target.value}))}
                    className="w-full rounded-xl border border-gray-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500/20 transition-all duration-200 p-3"
                  >
                    {categories.map(cat => (
                      <option key={cat} value={cat}>{cat}</option>
                    ))}
                  </select>
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Prix unitaire (€)</label>
                  <Input
                    type="number"
                    value={formData.price}
                    onChange={(e) => setFormData(prev => ({...prev, price: e.target.value}))}
                    placeholder="0.00"
                    step="0.01"
                    className="rounded-xl border-gray-200 focus:border-indigo-500 focus:ring-indigo-500/20"
                  />
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Unité</label>
                  <select
                    value={formData.unit}
                    onChange={(e) => setFormData(prev => ({...prev, unit: e.target.value}))}
                    className="w-full rounded-xl border border-gray-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500/20 transition-all duration-200 p-3"
                  >
                    <option value="unité">unité</option>
                    <option value="mètre linéaire">mètre linéaire</option>
                    <option value="mètre carré">mètre carré</option>
                    <option value="heure">heure</option>
                    <option value="forfait">forfait</option>
                  </select>
                </div>
              </div>

              {/* Section Photo */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-3">Photo du produit (optionnel)</label>
                <div className="space-y-3">
                  <div className="flex items-center gap-3">
                    <label className="flex-1 cursor-pointer">
                      <div className="flex items-center justify-center gap-2 px-4 py-3 border-2 border-dashed border-gray-300 rounded-xl hover:border-indigo-400 hover:bg-indigo-50 transition-all">
                        <Camera className="h-5 w-5 text-gray-500" />
                        <span className="text-sm text-gray-600">
                          {uploadingPhoto ? 'Téléchargement...' : 'Ajouter une photo'}
                        </span>
                      </div>
                      <input
                        type="file"
                        accept="image/*"
                        onChange={handleProductPhotoUpload}
                        className="hidden"
                        disabled={uploadingPhoto}
                      />
                    </label>
                  </div>

                  {productPhoto && (
                    <div className="relative inline-block">
                      <img
                        src={productPhoto.preview}
                        alt={productPhoto.name}
                        className="w-48 h-32 object-cover rounded-lg border-2 border-gray-200"
                      />
                      <button
                        type="button"
                        onClick={removeProductPhoto}
                        className="absolute top-2 right-2 bg-red-500 text-white rounded-full p-1.5 hover:bg-red-600 transition-colors"
                      >
                        <X className="h-4 w-4" />
                      </button>
                      <div className="mt-1 text-xs text-gray-600 truncate max-w-[12rem]">
                        {productPhoto.name}
                      </div>
                    </div>
                  )}
                </div>
              </div>

              <div className="pt-4 flex space-x-4">
                <Button
                  type="submit"
                  className="flex-1 bg-gradient-to-r from-indigo-600 to-indigo-700 hover:from-indigo-700 hover:to-indigo-800 text-white rounded-2xl py-3 shadow-lg transform transition-all duration-200 hover:scale-105"
                >
                  <ClipboardList className="h-4 w-4 mr-2" />
                  {editingProduct ? 'Modifier le produit' : 'Ajouter au catalogue'}
                </Button>
                <Button
                  type="button"
                  onClick={resetForm}
                  variant="outline"
                  className="rounded-2xl px-6"
                >
                  Annuler
                </Button>
              </div>
            </form>
          </CardContent>
        </Card>
      )}

      {/* Products List */}
      <div className="grid gap-4">
        {products.length === 0 ? (
          <Card className="bg-white/80 backdrop-blur-xl rounded-3xl border-0 shadow-2xl">
            <CardContent className="p-12 text-center">
              <ClipboardList className="h-16 w-16 mx-auto mb-4 text-gray-300" />
              <h3 className="text-xl font-semibold text-gray-900 mb-2">Catalogue vide</h3>
              <p className="text-gray-500">Ajoutez vos premiers produits et services.</p>
            </CardContent>
          </Card>
        ) : (
          products.map((product) => (
            <Card key={product.id} className="bg-white/80 backdrop-blur-xl rounded-3xl border-0 shadow-lg hover:shadow-xl transition-all duration-300">
              <CardContent className="p-6">
                <div className="flex items-start justify-between">
                  <div className="flex-1">
                    <div className="flex items-center space-x-3 mb-2">
                      <h3 className="text-lg font-semibold text-gray-900">{product.name}</h3>
                      <Badge className={getCategoryColor(product.category)}>
                        {product.category}
                      </Badge>
                      {product.reference && (
                        <Badge variant="outline" className="text-xs">
                          {product.reference}
                        </Badge>
                      )}
                    </div>
                    
                    <p className="text-gray-600 mb-3">{product.description}</p>
                    
                    <div className="flex items-center space-x-4 text-sm">
                      <span className="text-lg font-bold text-indigo-600">
                        {product.price.toFixed(2)}€
                      </span>
                      <span className="text-gray-500">
                        par {product.unit}
                      </span>
                    </div>
                  </div>
                  
                  <div className="flex space-x-2">
                    <Button
                      onClick={() => editProduct(product)}
                      size="sm"
                      variant="outline"
                      className="rounded-xl"
                    >
                      Modifier
                    </Button>
                    <Button
                      onClick={() => deleteProduct(product.id)}
                      size="sm"
                      variant="outline"
                      className="rounded-xl text-red-600 hover:text-red-700 hover:bg-red-50"
                    >
                      Supprimer
                    </Button>
                  </div>
                </div>
              </CardContent>
            </Card>
          ))
        )}
      </div>
    </div>
  );
};

// Invite Management Component - Complete Implementation
const InviteManagementView = () => {
  const [invites, setInvites] = useState([]);
  const [loading, setLoading] = useState(false);
  const [showForm, setShowForm] = useState(false);
  const [error, setError] = useState('');
  const [formData, setFormData] = useState({
    email: '',
    role: 'TECHNICIEN'
  });

  useEffect(() => {
    loadInvites();
  }, []);

  const loadInvites = async () => {
    try {
      setLoading(true);
      const response = await axios.get(`${API}/invitations/sent`, {
        headers: { Authorization: `Bearer ${localStorage.getItem('token')}` }
      });
      setInvites(response.data);
    } catch (err) {
      console.error('Erreur chargement invitations:', err);
      setError(err?.response?.data?.detail || "Erreur lors du chargement des invitations");
    } finally {
      setLoading(false);
    }
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    setError('');
    setLoading(true);
    try {
      const payload = {
        email: formData.email.toLowerCase(),
        role: formData.role
      };
      const response = await axios.post(`${API}/invitations/send`, payload, {
        headers: { Authorization: `Bearer ${localStorage.getItem('token')}` }
      });
      
      // Recharger la liste complète depuis le serveur
      await loadInvites();
      resetForm();
      alert("Invitation envoyée avec succès !");
    } catch (err) {
      setError(err?.response?.data?.detail || "Erreur lors de l'envoi de l'invitation");
    } finally {
      setLoading(false);
    }
  };

  const resetForm = () => {
    setFormData({
      email: '',
      role: 'TECHNICIEN'
    });
    setShowForm(false);
  };

  const resendInvite = async (inviteId) => {
    // Pour renvoyer: annuler l'ancienne et créer une nouvelle avec le même email
    try {
      const invite = invites.find(inv => inv.id === inviteId);
      if (!invite) return;
      
      // Annuler l'ancienne
      await axios.delete(`${API}/invitations/${inviteId}`, {
        headers: { Authorization: `Bearer ${localStorage.getItem('token')}` }
      });
      
      // Envoyer une nouvelle
      await axios.post(`${API}/invitations/send`, {
        email: invite.email,
        role: invite.role
      }, {
        headers: { Authorization: `Bearer ${localStorage.getItem('token')}` }
      });
      
      await loadInvites();
      alert('Invitation renvoyée avec succès !');
    } catch (err) {
      console.error('Erreur renvoi invitation:', err);
      alert(err?.response?.data?.detail || "Erreur lors du renvoi de l'invitation");
    }
  };

  const cancelInvite = async (inviteId) => {
    if (!window.confirm('Êtes-vous sûr de vouloir annuler cette invitation ?')) {
      return;
    }
    
    try {
      await axios.delete(`${API}/invitations/${inviteId}`, {
        headers: { Authorization: `Bearer ${localStorage.getItem('token')}` }
      });
      await loadInvites();
      alert('Invitation annulée avec succès !');
    } catch (err) {
      console.error('Erreur annulation invitation:', err);
      alert(err?.response?.data?.detail || "Erreur lors de l'annulation de l'invitation");
    }
  };

  const getStatusColor = (status) => {
    const normalizedStatus = (status || '').toLowerCase();
    switch (normalizedStatus) {
      case 'pending': return 'bg-yellow-100 text-yellow-700';
      case 'accepted': return 'bg-green-100 text-green-700';
      case 'expired': return 'bg-red-100 text-red-700';
      case 'cancelled': return 'bg-gray-100 text-gray-700';
      case 'rejected': return 'bg-red-100 text-red-700';
      default: return 'bg-gray-100 text-gray-700';
    }
  };

  const getRoleColor = (role) => {
    switch (role) {
      case 'ADMIN': return 'bg-purple-100 text-purple-700';
      case 'BUREAU': return 'bg-blue-100 text-blue-700';
      case 'TECHNICIEN': return 'bg-green-100 text-green-700';
      default: return 'bg-gray-100 text-gray-700';
    }
  };

  const formatDate = (dateString) => {
    return new Date(dateString).toLocaleDateString('fr-FR', {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  };

  const isExpired = (expiresAt) => {
    return new Date(expiresAt) < new Date();
  };

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="bg-white/80 backdrop-blur-xl rounded-2xl sm:rounded-3xl border-0 shadow-2xl p-4 sm:p-6 lg:p-8">
        <div className="flex flex-col sm:flex-row sm:items-center justify-between gap-3 sm:gap-4">
          <div className="min-w-0">
            <h2 className="text-lg sm:text-2xl font-semibold text-gray-900">Inviter des Techniciens</h2>
            <p className="text-xs sm:text-sm text-gray-600 mt-1">Seuls les techniciens (User) peuvent être invités par un administrateur</p>
          </div>
          <Button
            onClick={() => setShowForm(true)}
            className="bg-gradient-to-r from-pink-600 to-pink-700 hover:from-pink-700 hover:to-pink-800 text-white rounded-xl sm:rounded-2xl px-4 sm:px-6 py-2.5 sm:py-3 shadow-lg transform transition-all duration-200 hover:scale-105 text-sm sm:text-base flex-shrink-0"
          >
            <Plus className="h-4 w-4 mr-1.5 sm:mr-2" />
            Inviter un utilisateur
          </Button>
        </div>
      </div>

      {/* Invite Form */}
      {showForm && (
        <Card className="bg-white/80 backdrop-blur-xl rounded-3xl border-0 shadow-2xl">
          <CardHeader className="pb-6">
            <div className="flex items-center justify-between">
              <CardTitle className="text-xl font-semibold text-gray-900">Inviter un technicien</CardTitle>
              <Button
                onClick={resetForm}
                variant="ghost"
                size="sm"
                className="text-gray-500 hover:text-gray-700"
              >
                <X className="h-4 w-4" />
              </Button>
            </div>
          </CardHeader>
          <CardContent className="px-8 pb-8">
            <form onSubmit={handleSubmit} className="space-y-6">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Adresse email *</label>
                  <Input
                    type="email"
                    value={formData.email}
                    onChange={(e) => setFormData(prev => ({...prev, email: e.target.value}))}
                    required
                    placeholder="utilisateur@email.fr"
                    className="rounded-xl border-gray-200 focus:border-pink-500 focus:ring-pink-500/20"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Rôle *</label>
                  <Select 
                    value={formData.role} 
                    onValueChange={(value) => setFormData(prev => ({...prev, role: value}))}
                  >
                    <SelectTrigger className="rounded-xl border-gray-200 focus:border-pink-500 focus:ring-pink-500/20">
                      <SelectValue placeholder="Sélectionner un rôle" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="TECHNICIEN">Technicien / User</SelectItem>
                      <SelectItem value="BUREAU">Bureau</SelectItem>
                      <SelectItem value="ADMIN">Admin</SelectItem>
                    </SelectContent>
                  </Select>
                </div>
              </div>

              <div className="bg-pink-50 rounded-xl p-4">
                <h4 className="font-medium text-pink-800 mb-2">Permissions du rôle sélectionné :</h4>
                {formData.role === 'TECHNICIEN' ? (
                  <ul className="text-sm text-pink-700 space-y-1">
                    <li>• Créer et consulter ses propres recherches</li>
                    <li>• Générer des rapports PDF</li>
                    <li>• Partager avec le bureau</li>
                  </ul>
                ) : formData.role === 'BUREAU' ? (
                  <ul className="text-sm text-pink-700 space-y-1">
                    <li>• Toutes les permissions du Technicien</li>
                    <li>• Voir toutes les recherches de la société</li>
                    <li>• Gérer les clients, devis, chantiers</li>
                    <li>• Gérer le planning et les équipes</li>
                    <li>• Gérer le matériel et les équipements</li>
                    <li>❌ Ne peut pas inviter de membres</li>
                    <li>❌ Pas d'accès aux statistiques</li>
                  </ul>
                ) : (
                  <ul className="text-sm text-pink-700 space-y-1">
                    <li>• Toutes les permissions du Bureau</li>
                    <li>• Inviter de nouveaux utilisateurs</li>
                    <li>• Accès aux statistiques de l'entreprise</li>
                    <li>• Supprimer des plannings</li>
                    <li>• Gérer tous les aspects de l'entreprise</li>
                  </ul>
                )}
              </div>

              {error && (
                <div className="text-red-600 text-sm">{error}</div>
              )}

              <div className="pt-4 flex space-x-4">
                <Button
                  type="submit"
                  disabled={loading}
                  className="flex-1 bg-gradient-to-r from-pink-600 to-pink-700 hover:from-pink-700 hover:to-pink-800 text-white rounded-2xl py-3 shadow-lg transform transition-all duration-200 hover:scale-105"
                >
                  <Mail className="h-4 w-4 mr-2" />
                  {loading ? 'Envoi en cours...' : "Envoyer l'invitation"}
                </Button>
                <Button
                  type="button"
                  onClick={resetForm}
                  variant="outline"
                  className="rounded-2xl px-6"
                >
                  Annuler
                </Button>
              </div>
            </form>
          </CardContent>
        </Card>
      )}

      {/* Error Display */}
      {error && !showForm && (
        <Card className="bg-red-50 border-red-200 rounded-3xl border shadow-lg">
          <CardContent className="p-6">
            <div className="flex items-center space-x-3 text-red-800">
              <AlertCircle className="h-5 w-5" />
              <p className="font-medium">{error}</p>
            </div>
          </CardContent>
        </Card>
      )}

      {/* Invites List */}
      <div className="grid gap-4">
        {loading && !showForm ? (
          <Card className="bg-white/80 backdrop-blur-xl rounded-3xl border-0 shadow-2xl">
            <CardContent className="p-12 text-center">
              <Loader2 className="h-16 w-16 mx-auto mb-4 text-pink-600 animate-spin" />
              <h3 className="text-xl font-semibold text-gray-900 mb-2">Chargement...</h3>
              <p className="text-gray-500">Récupération des invitations en cours</p>
            </CardContent>
          </Card>
        ) : invites.length === 0 ? (
          <Card className="bg-white/80 backdrop-blur-xl rounded-3xl border-0 shadow-2xl">
            <CardContent className="p-12 text-center">
              <UserPlus className="h-16 w-16 mx-auto mb-4 text-gray-300" />
              <h3 className="text-xl font-semibold text-gray-900 mb-2">Aucune invitation envoyée</h3>
              <p className="text-gray-500">Invitez vos premiers collaborateurs pour commencer.</p>
            </CardContent>
          </Card>
        ) : (
          invites.map((invite) => {
            const isPending = (invite.status || '').toUpperCase() === 'PENDING';
            const isAccepted = (invite.status || '').toUpperCase() === 'ACCEPTED';
            const expired = isPending && isExpired(invite.expires_at);
            
            return (
              <Card key={invite.id} className="bg-white/80 backdrop-blur-xl rounded-2xl sm:rounded-3xl border-0 shadow-lg hover:shadow-xl transition-all duration-300">
                <CardContent className="p-4 sm:p-6">
                  <div className="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3 sm:gap-4">
                    <div className="flex-1 min-w-0">
                      <div className="flex items-center space-x-3 mb-2">
                        <div className="w-9 h-9 sm:w-10 sm:h-10 bg-gradient-to-br from-pink-500 to-pink-600 rounded-xl flex-shrink-0 flex items-center justify-center">
                          <Mail className="h-4 w-4 sm:h-5 sm:w-5 text-white" />
                        </div>
                        <div className="min-w-0 flex-1">
                          <h3 className="text-sm sm:text-lg font-semibold text-gray-900 truncate">{invite.email}</h3>
                          <div className="flex flex-wrap items-center gap-1.5 sm:space-x-2 mt-1">
                            <Badge className={`text-xs ${getRoleColor(invite.role)}`}>
                              {invite.role === 'TECHNICIEN' ? 'Technicien / User' : 
                               invite.role === 'BUREAU' ? 'Bureau' : 
                               invite.role === 'ADMIN' ? 'Admin' : invite.role}
                            </Badge>
                            <Badge className={`text-xs ${getStatusColor(invite.status)}`}>
                              {isPending ? (expired ? 'Expirée' : 'En attente') : 
                               isAccepted ? 'Acceptée' : 
                               invite.status === 'CANCELLED' ? 'Annulée' : invite.status}
                            </Badge>
                            {expired && (
                              <Badge className="bg-red-100 text-red-700 text-xs">
                                <Clock className="h-3 w-3 mr-1" />
                                Expirée
                              </Badge>
                            )}
                          </div>
                        </div>
                      </div>
                      
                      <div className="ml-12 sm:ml-13 space-y-1 sm:grid sm:grid-cols-2 sm:gap-4 sm:space-y-0 mt-3 sm:mt-4 text-xs sm:text-sm text-gray-600">
                        <div>
                          <span className="font-medium">Envoyée le:</span> {formatDate(invite.created_at)}
                        </div>
                        {isPending && (
                          <div className={expired ? 'text-red-600' : ''}>
                            <span className="font-medium">Expire le:</span> {formatDate(invite.expires_at)}
                          </div>
                        )}
                        {isAccepted && invite.accepted_at && (
                          <div className="text-green-600">
                            <span className="font-medium">Acceptée le:</span> {formatDate(invite.accepted_at)}
                          </div>
                        )}
                      </div>
                    </div>
                    
                    <div className="flex space-x-2 ml-12 sm:ml-0 sm:flex-shrink-0">
                      {isPending && !expired && (
                        <>
                          <Button
                            onClick={() => resendInvite(invite.id)}
                            size="sm"
                            variant="outline"
                            className="rounded-xl text-xs sm:text-sm"
                          >
                            <Mail className="h-3 w-3 mr-1" />
                            Renvoyer
                          </Button>
                          <Button
                            onClick={() => cancelInvite(invite.id)}
                            size="sm"
                            variant="outline"
                            className="rounded-xl text-red-600 hover:text-red-700 hover:bg-red-50 text-xs sm:text-sm"
                          >
                            <X className="h-3 w-3 mr-1" />
                            Annuler
                          </Button>
                        </>
                      )}
                      {isPending && expired && (
                        <Button
                          onClick={() => resendInvite(invite.id)}
                          size="sm"
                          className="bg-pink-600 hover:bg-pink-700 text-white rounded-xl text-xs sm:text-sm"
                        >
                          <Mail className="h-3 w-3 mr-1" />
                          Renvoyer
                        </Button>
                      )}
                      {isAccepted && (
                        <Button 
                          size="sm" 
                          variant="outline" 
                          className="rounded-xl text-green-600 text-xs sm:text-sm"
                          disabled
                        >
                          <CheckCircle className="h-3 w-3 mr-1" />
                          Acceptée
                        </Button>
                      )}
                    </div>
                  </div>
                </CardContent>
              </Card>
            );
          })
        )}
      </div>
    </div>
  );
};
// Gestion du Matériel (liste, ajout, édition, suppression, QR codes, maintenance)
import { api, supabase } from './lib/supabase'
const MaterialManagement = () => {
  // ═══════════════════════════════════════════════════
  //  ÉTATS PRINCIPAUX
  // ═══════════════════════════════════════════════════
  const [items, setItems] = useState([])
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState('')
  const [me, setMe] = useState(null)
  const [activeTab, setActiveTab] = useState('inventory')
  // Détail d'un matériel sélectionné
  const [selectedItem, setSelectedItem] = useState(null)
  const [maintenanceLogs, setMaintenanceLogs] = useState([])
  const [logsLoading, setLogsLoading] = useState(false)
  // Formulaire d'ajout/édition
  const [form, setForm] = useState({
    id: null,
    name: '',
    description: '',
    category: 'TOOL',
    location: '',
    serial_number: '',
    brand: '',
    model: '',
    purchase_date: '',
    warranty_end: '',
    condition: 'BON',
    maintenance_interval_days: '',
    notes: '',
    qr_code: ''
  })
  const [saving, setSaving] = useState(false)
  // Formulaire maintenance
  const [maintenanceForm, setMaintenanceForm] = useState({
    maintenance_type: 'ENTRETIEN',
    description: '',
    cost: '',
    performed_at: new Date().toISOString().split('T')[0],
    next_due_date: ''
  })
  const [savingMaintenance, setSavingMaintenance] = useState(false)
  // Scanner QR
  const [scanning, setScanning] = useState(false)
  const videoRef = useRef(null)
  const [scanResult, setScanResult] = useState('')
  // Filtres
  const [searchTerm, setSearchTerm] = useState('')
  const [filterCategory, setFilterCategory] = useState('ALL')
  const [filterCondition, setFilterCondition] = useState('ALL')
  // Confirmation suppression
  const [deleteItem, setDeleteItem] = useState(null)
  // Aperçu QR
  const [qrPreviewUrl, setQrPreviewUrl] = useState('')

  // ═══════════════════════════════════════════════════
  //  CONSTANTES
  // ═══════════════════════════════════════════════════
  const CATEGORIES = [
    { value: 'TOOL', label: 'Outil', icon: '🔧' },
    { value: 'SAFETY', label: 'Sécurité', icon: '🦺' },
    { value: 'MEASUREMENT', label: 'Mesure', icon: '📏' },
    { value: 'VEHICLE', label: 'Véhicule', icon: '🚛' },
    { value: 'EQUIPMENT', label: 'Équipement lourd', icon: '⚙️' },
    { value: 'CONSUMABLE', label: 'Consommable', icon: '📦' }
  ]

  const CONDITIONS = [
    { value: 'NEUF', label: 'Neuf', color: 'bg-emerald-100 text-emerald-800', dot: 'bg-emerald-500' },
    { value: 'BON', label: 'Bon état', color: 'bg-blue-100 text-blue-800', dot: 'bg-blue-500' },
    { value: 'USAGE', label: 'Usé', color: 'bg-amber-100 text-amber-800', dot: 'bg-amber-500' },
    { value: 'A_REVISER', label: 'À réviser', color: 'bg-orange-100 text-orange-800', dot: 'bg-orange-500' },
    { value: 'FIN_DE_VIE', label: 'Fin de vie', color: 'bg-red-100 text-red-800', dot: 'bg-red-500' }
  ]

  const MAINTENANCE_TYPES = [
    { value: 'ENTRETIEN', label: 'Entretien courant', icon: '🔧' },
    { value: 'REPARATION', label: 'Réparation', icon: '🛠️' },
    { value: 'INSPECTION', label: 'Inspection', icon: '🔍' },
    { value: 'CONTROLE', label: 'Contrôle réglementaire', icon: '📋' },
    { value: 'REMPLACEMENT_PIECE', label: 'Remplacement pièce', icon: '🔩' }
  ]

  // ═══════════════════════════════════════════════════
  //  UTILITAIRES
  // ═══════════════════════════════════════════════════
  const getConditionInfo = (cond) => CONDITIONS.find(c => c.value === cond) || CONDITIONS[1]
  const getCategoryInfo = (cat) => CATEGORIES.find(c => c.value === cat) || CATEGORIES[0]
  const getMaintenanceTypeInfo = (type) => MAINTENANCE_TYPES.find(t => t.value === type) || MAINTENANCE_TYPES[0]

  const isMaintenanceDue = (item) => {
    if (!item.next_maintenance_date) return false
    return new Date(item.next_maintenance_date) <= new Date()
  }

  const isMaintenanceSoon = (item) => {
    if (!item.next_maintenance_date) return false
    const diff = new Date(item.next_maintenance_date) - new Date()
    return diff > 0 && diff < 7 * 24 * 60 * 60 * 1000
  }

  const daysUntilMaintenance = (item) => {
    if (!item.next_maintenance_date) return null
    const diff = new Date(item.next_maintenance_date) - new Date()
    return Math.ceil(diff / (24 * 60 * 60 * 1000))
  }

  const cryptoRandom = () => {
    try { return 'SKY_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2, 8).toUpperCase() }
    catch { return 'SKY_' + Date.now() }
  }

  // ═══════════════════════════════════════════════════
  //  FILTRAGE MÉMORISÉ
  // ═══════════════════════════════════════════════════
  const filteredItems = React.useMemo(() => {
    const term = searchTerm.trim().toLowerCase()
    return items.filter(m => {
      const okSearch = !term || [m.name, m.description, m.location, m.serial_number, m.brand, m.model, m.qr_code].some(x => (x || '').toLowerCase().includes(term))
      const okCat = filterCategory === 'ALL' || (m.category || '') === filterCategory
      const okCond = filterCondition === 'ALL' || (m.condition || 'BON') === filterCondition
      return okSearch && okCat && okCond
    })
  }, [items, searchTerm, filterCategory, filterCondition])

  // Stats
  const stats = React.useMemo(() => ({
    total: items.length,
    neuf: items.filter(m => m.condition === 'NEUF').length,
    bon: items.filter(m => m.condition === 'BON' || !m.condition).length,
    usage: items.filter(m => m.condition === 'USAGE').length,
    a_reviser: items.filter(m => m.condition === 'A_REVISER').length,
    fin_de_vie: items.filter(m => m.condition === 'FIN_DE_VIE' || m.end_of_life).length,
    maintenance_due: items.filter(m => isMaintenanceDue(m)).length
  }), [items])

  // ═══════════════════════════════════════════════════
  //  CHARGEMENT DES DONNÉES
  // ═══════════════════════════════════════════════════
  const load = async () => {
    setLoading(true)
    const { data, error } = await api.materials.getAll()
    if (error) setError(String(error.message || error))
    setItems(data || [])
    setLoading(false)
  }

  const loadMaintenanceLogs = async (materialId) => {
    setLogsLoading(true)
    const { data, error } = await api.materials.getMaintenanceLogs(materialId)
    if (error) { setError(String(error.message || error)); setMaintenanceLogs([]) }
    else setMaintenanceLogs(data || [])
    setLogsLoading(false)
  }

  useEffect(() => { 
    load(); 
    (async () => { 
      const { data } = await api.users.getCurrent(); 
      if (data) {
        setMe(data)
      } else {
        // Fallback: utiliser le user stocké en localStorage
        const stored = localStorage.getItem('user')
        if (stored) setMe(JSON.parse(stored))
      }
    })() 
  }, [])
  useEffect(() => { return () => { try { stopScan() } catch {} } }, [])

  // ═══════════════════════════════════════════════════
  //  CRUD MATÉRIEL
  // ═══════════════════════════════════════════════════
  const resetForm = () => setForm({
    id: null, name: '', description: '', category: 'TOOL', location: '',
    serial_number: '', brand: '', model: '', purchase_date: '', warranty_end: '',
    condition: 'BON', maintenance_interval_days: '', notes: '', qr_code: ''
  })

  const onSubmit = async (e) => {
    e.preventDefault()
    setSaving(true)
    setError('')
    try {
      const newQr = form.id ? form.qr_code : cryptoRandom()
      const userStr = localStorage.getItem('user')
      const currentUser = userStr ? JSON.parse(userStr) : null
      const payload = {
        name: form.name,
        description: form.description || null,
        category: form.category,
        location: form.location || null,
        serial_number: form.serial_number || null,
        brand: form.brand || null,
        model: form.model || null,
        purchase_date: form.purchase_date || null,
        warranty_end: form.warranty_end || null,
        condition: form.condition || 'BON',
        maintenance_interval_days: form.maintenance_interval_days ? parseInt(form.maintenance_interval_days) : null,
        notes: form.notes || null,
        qr_code: newQr,
        end_of_life: form.condition === 'FIN_DE_VIE',
        company_id: currentUser?.company_id
      }
      if (form.id) {
        const { error } = await api.materials.update(form.id, payload)
        if (error) throw error
      } else {
        const { data, error } = await api.materials.create(payload)
        if (error) throw error
      }
      const url = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(newQr)}`
      setQrPreviewUrl(url)
      await load()
      resetForm()
      setActiveTab('inventory')
    } catch (err) {
      setError(String(err.message || err))
    } finally { setSaving(false) }
  }

  const onEdit = (m) => {
    setForm({
      id: m.id,
      name: m.name || '',
      description: m.description || '',
      category: m.category || 'TOOL',
      location: m.location || '',
      serial_number: m.serial_number || '',
      brand: m.brand || '',
      model: m.model || '',
      purchase_date: m.purchase_date || '',
      warranty_end: m.warranty_end || '',
      condition: m.condition || 'BON',
      maintenance_interval_days: m.maintenance_interval_days || '',
      notes: m.notes || '',
      qr_code: m.qr_code || ''
    })
    setActiveTab('form')
  }

  const onDeleteConfirmed = async () => {
    if (!deleteItem) return
    const { error } = await api.materials.remove(deleteItem.id)
    if (error) { setError(String(error.message || error)) }
    else { await load(); if (selectedItem?.id === deleteItem.id) { setSelectedItem(null) } }
    setDeleteItem(null)
  }

  // ═══════════════════════════════════════════════════
  //  MAINTENANCE
  // ═══════════════════════════════════════════════════
  const resetMaintenanceForm = () => setMaintenanceForm({
    maintenance_type: 'ENTRETIEN', description: '', cost: '',
    performed_at: new Date().toISOString().split('T')[0], next_due_date: ''
  })

  const onSubmitMaintenance = async (e) => {
    e.preventDefault()
    if (!selectedItem || !me) return
    setSavingMaintenance(true)
    setError('')
    try {
      const log = {
        material_id: selectedItem.id,
        company_id: me.company_id,
        performed_by: me.id,
        maintenance_type: maintenanceForm.maintenance_type,
        description: maintenanceForm.description || null,
        cost: maintenanceForm.cost ? parseFloat(maintenanceForm.cost) : null,
        performed_at: maintenanceForm.performed_at || new Date().toISOString(),
        next_due_date: maintenanceForm.next_due_date || null
      }
      const { error } = await api.materials.addMaintenanceLog(log)
      if (error) throw error
      // Mettre à jour la date de dernière et prochaine maintenance sur le matériel
      const updates = {
        last_maintenance_date: maintenanceForm.performed_at || new Date().toISOString().split('T')[0]
      }
      if (maintenanceForm.next_due_date) {
        updates.next_maintenance_date = maintenanceForm.next_due_date
      } else if (selectedItem.maintenance_interval_days) {
        const next = new Date(maintenanceForm.performed_at || new Date())
        next.setDate(next.getDate() + parseInt(selectedItem.maintenance_interval_days))
        updates.next_maintenance_date = next.toISOString().split('T')[0]
      }
      await api.materials.update(selectedItem.id, updates)
      await loadMaintenanceLogs(selectedItem.id)
      await load()
      // Rafraîchir l'item sélectionné
      const refreshed = (await api.materials.scanQR(selectedItem.qr_code))?.data
      if (refreshed) setSelectedItem(refreshed)
      resetMaintenanceForm()
    } catch (err) {
      setError(String(err.message || err))
    } finally { setSavingMaintenance(false) }
  }

  // ═══════════════════════════════════════════════════
  //  QR SCANNER
  // ═══════════════════════════════════════════════════
  const startScan = async () => {
    setScanResult('')
    setScanning(true)
    try {
      if (!navigator.mediaDevices?.getUserMedia) { setError('Caméra non disponible'); setScanning(false); return }
      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
      if (videoRef.current) { videoRef.current.srcObject = stream; await videoRef.current.play() }
      if ('BarcodeDetector' in window) {
        const detector = new window.BarcodeDetector({ formats: ['qr_code'] })
        const tick = async () => {
          if (!videoRef.current?.srcObject) return
          try {
            const detections = await detector.detect(videoRef.current)
            if (detections?.[0]?.rawValue) {
              const code = detections[0].rawValue
              setScanResult(code)
              await onScanFound(code)
              stopScan()
              return
            }
          } catch {}
          requestAnimationFrame(tick)
        }
        requestAnimationFrame(tick)
      }
    } catch (e) { setError(String(e.message || e)); setScanning(false) }
  }

  const stopScan = () => {
    setScanning(false)
    const v = videoRef.current
    if (v?.srcObject) { v.srcObject.getTracks().forEach(t => t.stop()); v.srcObject = null }
  }

  const onScanFound = async (qr) => {
    try {
      const { data, error } = await api.materials.scanQR(qr)
      if (error) throw error
      if (data) {
        setSelectedItem(data)
        await loadMaintenanceLogs(data.id)
        setActiveTab('inventory')
      } else { setError('QR non reconnu dans votre inventaire') }
    } catch (e) { setError(String(e.message || e)) }
  }

  const openDetail = async (item) => {
    setSelectedItem(item)
    await loadMaintenanceLogs(item.id)
  }

  const closeDetail = () => {
    setSelectedItem(null)
    setMaintenanceLogs([])
    resetMaintenanceForm()
  }

  // ═══════════════════════════════════════════════════
  //  RENDU
  // ═══════════════════════════════════════════════════
  return (
    <div className="space-y-6">
      {/* En-tête avec statistiques */}
      <div className="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-7 gap-3">
        {[
          { label: 'Total', value: stats.total, icon: Package, color: 'text-gray-700', bg: 'bg-gray-50' },
          { label: 'Neuf', value: stats.neuf, icon: Star, color: 'text-emerald-700', bg: 'bg-emerald-50' },
          { label: 'Bon état', value: stats.bon, icon: Check, color: 'text-blue-700', bg: 'bg-blue-50' },
          { label: 'Usé', value: stats.usage, icon: Clock, color: 'text-amber-700', bg: 'bg-amber-50' },
          { label: 'À réviser', value: stats.a_reviser, icon: Wrench, color: 'text-orange-700', bg: 'bg-orange-50' },
          { label: 'Fin de vie', value: stats.fin_de_vie, icon: AlertTriangle, color: 'text-red-700', bg: 'bg-red-50' },
          { label: 'Entretien dû', value: stats.maintenance_due, icon: Calendar, color: 'text-purple-700', bg: 'bg-purple-50' }
        ].map((s, i) => (
          <div key={i} className={`${s.bg} rounded-2xl p-3 flex flex-col items-center justify-center`}>
            <s.icon className={`h-5 w-5 ${s.color} mb-1`} />
            <div className={`text-xl font-bold ${s.color}`}>{s.value}</div>
            <div className="text-xs text-gray-500">{s.label}</div>
          </div>
        ))}
      </div>

      {/* Onglets principaux */}
      <Tabs value={activeTab} onValueChange={setActiveTab}>
        <TabsList className="bg-gray-100 rounded-2xl p-1">
          <TabsTrigger value="inventory" className="rounded-xl data-[state=active]:bg-white data-[state=active]:shadow-sm">
            <Package className="h-4 w-4 mr-2" />Inventaire
          </TabsTrigger>
          <TabsTrigger value="form" className="rounded-xl data-[state=active]:bg-white data-[state=active]:shadow-sm">
            <Plus className="h-4 w-4 mr-2" />{form.id ? 'Modifier' : 'Ajouter'}
          </TabsTrigger>
          <TabsTrigger value="scan" className="rounded-xl data-[state=active]:bg-white data-[state=active]:shadow-sm">
            <Camera className="h-4 w-4 mr-2" />Scanner QR
          </TabsTrigger>
        </TabsList>

        {/* ONGLET INVENTAIRE */}
        <TabsContent value="inventory" className="mt-4 space-y-4">
          {/* Filtres */}
          <div className="grid grid-cols-1 md:grid-cols-4 gap-3">
            <Input placeholder="🔍 Rechercher (nom, série, marque, QR...)" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="rounded-xl" />
            <Select value={filterCategory} onValueChange={setFilterCategory}>
              <SelectTrigger className="rounded-xl"><SelectValue placeholder="Catégorie" /></SelectTrigger>
              <SelectContent>
                <SelectItem value="ALL">Toutes catégories</SelectItem>
                {CATEGORIES.map(c => <SelectItem key={c.value} value={c.value}>{c.icon} {c.label}</SelectItem>)}
              </SelectContent>
            </Select>
            <Select value={filterCondition} onValueChange={setFilterCondition}>
              <SelectTrigger className="rounded-xl"><SelectValue placeholder="État" /></SelectTrigger>
              <SelectContent>
                <SelectItem value="ALL">Tous états</SelectItem>
                {CONDITIONS.map(c => <SelectItem key={c.value} value={c.value}>{c.label}</SelectItem>)}
              </SelectContent>
            </Select>
            <div className="flex items-center text-sm text-gray-500">
              {filteredItems.length} résultat{filteredItems.length !== 1 ? 's' : ''}
            </div>
          </div>

          {/* Grille de cartes */}
          {loading ? (
            <div className="flex items-center justify-center py-12">
              <Loader2 className="h-8 w-8 animate-spin text-blue-500" />
            </div>
          ) : filteredItems.length === 0 ? (
            <div className="text-center py-12 text-gray-400">
              <Package className="h-12 w-12 mx-auto mb-3 opacity-40" />
              <p className="text-lg font-medium">Aucun matériel</p>
              <p className="text-sm">Ajoutez votre premier équipement via l'onglet "Ajouter"</p>
            </div>
          ) : (
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              {filteredItems.map((m) => {
                const condInfo = getConditionInfo(m.condition || 'BON')
                const catInfo = getCategoryInfo(m.category)
                const maintenanceDue = isMaintenanceDue(m)
                const maintenanceSoon = isMaintenanceSoon(m)
                const daysLeft = daysUntilMaintenance(m)

                return (
                  <div
                    key={m.id}
                    onClick={() => openDetail(m)}
                    className={`bg-white rounded-2xl border-2 ${
                      m.end_of_life || m.condition === 'FIN_DE_VIE' ? 'border-red-200 bg-red-50/30' :
                      maintenanceDue ? 'border-purple-200 bg-purple-50/30' :
                      maintenanceSoon ? 'border-amber-200 bg-amber-50/30' :
                      'border-gray-100 hover:border-blue-200'
                    } shadow-sm hover:shadow-lg transition-all cursor-pointer p-4 relative`}
                  >
                    {/* Badge condition */}
                    <div className="flex items-start justify-between mb-3">
                      <div className="flex items-center gap-2">
                        <span className="text-2xl">{catInfo.icon}</span>
                        <div>
                          <h3 className="font-semibold text-gray-900 leading-tight">{m.name}</h3>
                          {(m.brand || m.model) && (
                            <p className="text-xs text-gray-500">{[m.brand, m.model].filter(Boolean).join(' - ')}</p>
                          )}
                        </div>
                      </div>
                      <span className={`px-2 py-0.5 rounded-full text-xs font-medium ${condInfo.color}`}>
                        {condInfo.label}
                      </span>
                    </div>

                    {/* Détails */}
                    <div className="space-y-1 text-sm text-gray-600">
                      {m.serial_number && (
                        <div className="flex items-center gap-1">
                          <span className="text-gray-400">N° série:</span>
                          <span className="font-mono text-xs">{m.serial_number}</span>
                        </div>
                      )}
                      {m.location && (
                        <div className="flex items-center gap-1">
                          <MapPin className="h-3 w-3 text-gray-400" />
                          <span>{m.location}</span>
                        </div>
                      )}
                    </div>

                    {/* Alertes */}
                    <div className="flex flex-wrap gap-1.5 mt-3">
                      {(m.end_of_life || m.condition === 'FIN_DE_VIE') && (
                        <span className="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-700">
                          <AlertTriangle className="h-3 w-3" /> Fin de vie
                        </span>
                      )}
                      {maintenanceDue && (
                        <span className="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-700">
                          <Wrench className="h-3 w-3" /> Entretien en retard
                        </span>
                      )}
                      {maintenanceSoon && !maintenanceDue && (
                        <span className="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-amber-100 text-amber-700">
                          <Clock className="h-3 w-3" /> Entretien dans {daysLeft}j
                        </span>
                      )}
                      {m.assigned_to && (
                        <span className="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-700">
                          <User className="h-3 w-3" /> Assigné
                        </span>
                      )}
                    </div>

                    {/* QR mini */}
                    <div className="absolute bottom-3 right-3">
                      <img
                        src={`https://api.qrserver.com/v1/create-qr-code/?size=50x50&data=${encodeURIComponent(m.qr_code)}`}
                        alt="QR"
                        className="w-10 h-10 rounded opacity-50 hover:opacity-100 transition-opacity"
                      />
                    </div>
                  </div>
                )
              })}
            </div>
          )}
        </TabsContent>

        {/* ONGLET FORMULAIRE */}
        <TabsContent value="form" className="mt-4">
          <Card className="bg-white/80 backdrop-blur-xl rounded-3xl border-0 shadow-2xl">
            <CardHeader>
              <CardTitle>{form.id ? '✏️ Modifier l\'équipement' : '➕ Nouvel équipement'}</CardTitle>
              <CardDescription>Renseignez les informations de l'équipement. Un QR code unique sera généré automatiquement.</CardDescription>
            </CardHeader>
            <CardContent>
              <form onSubmit={onSubmit} className="space-y-4">
                {/* Ligne 1: Nom + Marque + Modèle */}
                <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                  <div>
                    <label className="text-xs font-medium text-gray-500 mb-1 block">Nom de l'équipement *</label>
                    <Input placeholder="ex: Treuil hydraulique" value={form.name} onChange={(e) => setForm({ ...form, name: e.target.value })} required className="rounded-xl" />
                  </div>
                  <div>
                    <label className="text-xs font-medium text-gray-500 mb-1 block">Marque</label>
                    <Input placeholder="ex: Bosch" value={form.brand} onChange={(e) => setForm({ ...form, brand: e.target.value })} className="rounded-xl" />
                  </div>
                  <div>
                    <label className="text-xs font-medium text-gray-500 mb-1 block">Modèle</label>
                    <Input placeholder="ex: GBH 2-26" value={form.model} onChange={(e) => setForm({ ...form, model: e.target.value })} className="rounded-xl" />
                  </div>
                </div>

                {/* Ligne 2: N° série + Catégorie + État */}
                <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                  <div>
                    <label className="text-xs font-medium text-gray-500 mb-1 block">N° de série</label>
                    <Input placeholder="ex: SN-2024-0042" value={form.serial_number} onChange={(e) => setForm({ ...form, serial_number: e.target.value })} className="rounded-xl font-mono" />
                  </div>
                  <div>
                    <label className="text-xs font-medium text-gray-500 mb-1 block">Catégorie</label>
                    <Select value={form.category} onValueChange={(v) => setForm({ ...form, category: v })}>
                      <SelectTrigger className="rounded-xl"><SelectValue /></SelectTrigger>
                      <SelectContent>
                        {CATEGORIES.map(c => <SelectItem key={c.value} value={c.value}>{c.icon} {c.label}</SelectItem>)}
                      </SelectContent>
                    </Select>
                  </div>
                  <div>
                    <label className="text-xs font-medium text-gray-500 mb-1 block">État</label>
                    <Select value={form.condition} onValueChange={(v) => setForm({ ...form, condition: v })}>
                      <SelectTrigger className="rounded-xl"><SelectValue /></SelectTrigger>
                      <SelectContent>
                        {CONDITIONS.map(c => <SelectItem key={c.value} value={c.value}>{c.label}</SelectItem>)}
                      </SelectContent>
                    </Select>
                  </div>
                </div>

                {/* Ligne 3: Localisation + Date achat + Fin garantie */}
                <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                  <div>
                    <label className="text-xs font-medium text-gray-500 mb-1 block">Localisation / Dépôt</label>
                    <Input placeholder="ex: Entrepôt Nord" value={form.location} onChange={(e) => setForm({ ...form, location: e.target.value })} className="rounded-xl" />
                  </div>
                  <div>
                    <label className="text-xs font-medium text-gray-500 mb-1 block">Date d'achat</label>
                    <Input type="date" value={form.purchase_date} onChange={(e) => setForm({ ...form, purchase_date: e.target.value })} className="rounded-xl" />
                  </div>
                  <div>
                    <label className="text-xs font-medium text-gray-500 mb-1 block">Fin de garantie</label>
                    <Input type="date" value={form.warranty_end} onChange={(e) => setForm({ ...form, warranty_end: e.target.value })} className="rounded-xl" />
                  </div>
                </div>

                {/* Ligne 4: Intervalle maintenance + Description */}
                <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                  <div>
                    <label className="text-xs font-medium text-gray-500 mb-1 block">Intervalle entretien (jours)</label>
                    <Input type="number" placeholder="ex: 90" value={form.maintenance_interval_days} onChange={(e) => setForm({ ...form, maintenance_interval_days: e.target.value })} className="rounded-xl" />
                  </div>
                  <div className="md:col-span-2">
                    <label className="text-xs font-medium text-gray-500 mb-1 block">Description</label>
                    <Input placeholder="Description de l'équipement..." value={form.description} onChange={(e) => setForm({ ...form, description: e.target.value })} className="rounded-xl" />
                  </div>
                </div>

                {/* Notes */}
                <div>
                  <label className="text-xs font-medium text-gray-500 mb-1 block">Notes internes</label>
                  <textarea
                    placeholder="Notes supplémentaires..."
                    value={form.notes}
                    onChange={(e) => setForm({ ...form, notes: e.target.value })}
                    className="w-full rounded-xl border border-gray-200 p-3 text-sm resize-none h-20 focus:outline-none focus:ring-2 focus:ring-blue-500"
                  />
                </div>

                {/* Boutons */}
                <div className="flex gap-2 pt-2">
                  <Button type="submit" disabled={saving} className="rounded-xl bg-blue-600 hover:bg-blue-700">
                    {saving ? <Loader2 className="h-4 w-4 animate-spin mr-2" /> : <Save className="h-4 w-4 mr-2" />}
                    {form.id ? 'Mettre à jour' : 'Enregistrer l\'équipement'}
                  </Button>
                  {form.id && (
                    <Button type="button" variant="outline" onClick={() => { resetForm(); setActiveTab('inventory') }} className="rounded-xl">Annuler</Button>
                  )}
                </div>
              </form>

              {/* Aperçu QR après enregistrement */}
              {qrPreviewUrl && (
                <div className="mt-6 p-4 bg-gray-50 rounded-2xl flex items-center gap-4">
                  <img src={qrPreviewUrl} alt="QR Code" className="w-32 h-32 rounded-xl border" />
                  <div>
                    <p className="font-medium text-gray-800">QR Code généré ✅</p>
                    <p className="text-sm text-gray-500 mb-2">Imprimez et collez ce QR sur l'équipement.</p>
                    <a href={qrPreviewUrl} download={`qr_${Date.now()}.png`} className="text-blue-600 underline text-sm">📥 Télécharger l'image QR</a>
                  </div>
                </div>
              )}
            </CardContent>
          </Card>
        </TabsContent>

        {/* ONGLET SCANNER */}
        <TabsContent value="scan" className="mt-4">
          <Card className="bg-white/80 backdrop-blur-xl rounded-3xl border-0 shadow-2xl">
            <CardHeader>
              <CardTitle>📸 Scanner un QR Code</CardTitle>
              <CardDescription>Scannez le QR code collé sur un équipement pour accéder à sa fiche complète.</CardDescription>
            </CardHeader>
            <CardContent className="space-y-4">
              <div className="flex gap-3">
                <Button onClick={scanning ? stopScan : startScan} className="rounded-xl" variant={scanning ? 'destructive' : 'default'}>
                  <Camera className="h-4 w-4 mr-2" />{scanning ? 'Arrêter le scan' : 'Ouvrir la caméra'}
                </Button>
              </div>
              {scanning && (
                <div className="space-y-2">
                  <video ref={videoRef} className="w-full max-w-md rounded-2xl border-2 border-blue-200" muted playsInline />
                  <p className="text-sm text-gray-500 animate-pulse">🔍 Recherche d'un QR code...</p>
                  {!('BarcodeDetector' in window) && (
                    <div className="text-xs text-amber-600 bg-amber-50 p-2 rounded-xl">
                      ⚠️ Votre navigateur ne supporte pas la détection automatique. Utilisez Chrome ou Edge.
                    </div>
                  )}
                </div>
              )}
              {scanResult && (
                <div className="p-3 bg-green-50 rounded-xl border border-green-200 text-sm">
                  ✅ Code détecté: <span className="font-mono font-medium">{scanResult}</span>
                </div>
              )}
            </CardContent>
          </Card>
        </TabsContent>
      </Tabs>

      {/* PANNEAU DÉTAIL D'UN ÉQUIPEMENT */}
      {selectedItem && (
        <div className="fixed inset-0 z-50 flex items-start justify-center overflow-y-auto bg-black/50 p-4 pt-10 pb-10">
          <div className="bg-white rounded-3xl shadow-2xl w-full max-w-3xl relative">
            {/* Bouton fermer */}
            <button onClick={closeDetail} className="absolute top-4 right-4 p-2 rounded-full hover:bg-gray-100 z-10">
              <X className="h-5 w-5 text-gray-400" />
            </button>

            {/* En-tête fiche */}
            <div className={`p-6 rounded-t-3xl ${
              selectedItem.condition === 'FIN_DE_VIE' ? 'bg-gradient-to-r from-red-50 to-red-100' :
              selectedItem.condition === 'A_REVISER' ? 'bg-gradient-to-r from-orange-50 to-orange-100' :
              selectedItem.condition === 'NEUF' ? 'bg-gradient-to-r from-emerald-50 to-emerald-100' :
              'bg-gradient-to-r from-blue-50 to-blue-100'
            }`}>
              <div className="flex items-start justify-between pr-8">
                <div className="flex items-center gap-3">
                  <span className="text-3xl">{getCategoryInfo(selectedItem.category).icon}</span>
                  <div>
                    <h2 className="text-xl font-bold text-gray-900">{selectedItem.name}</h2>
                    <p className="text-sm text-gray-500">
                      {[selectedItem.brand, selectedItem.model].filter(Boolean).join(' — ') || selectedItem.category}
                    </p>
                  </div>
                </div>
                <span className={`px-3 py-1 rounded-full text-sm font-medium ${getConditionInfo(selectedItem.condition || 'BON').color}`}>
                  {getConditionInfo(selectedItem.condition || 'BON').label}
                </span>
              </div>

              {/* Alertes */}
              {(selectedItem.end_of_life || selectedItem.condition === 'FIN_DE_VIE') && (
                <div className="mt-3 p-3 bg-red-100 rounded-xl flex items-center gap-2 text-red-800 text-sm font-medium">
                  <AlertTriangle className="h-5 w-5" />
                  Cet équipement est en fin de vie et doit être remplacé.
                </div>
              )}
              {isMaintenanceDue(selectedItem) && (
                <div className="mt-3 p-3 bg-purple-100 rounded-xl flex items-center gap-2 text-purple-800 text-sm font-medium">
                  <Wrench className="h-5 w-5" />
                  L'entretien de cet équipement est en retard ! Prévu le {new Date(selectedItem.next_maintenance_date).toLocaleDateString('fr-FR')}
                </div>
              )}
            </div>

            {/* Corps */}
            <div className="p-6 space-y-6">
              {/* Infos détaillées + QR Code */}
              <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div className="md:col-span-2">
                  <h3 className="font-semibold text-gray-800 mb-3 flex items-center gap-2"><Info className="h-4 w-4" /> Informations</h3>
                  <div className="grid grid-cols-2 gap-3 text-sm">
                    {selectedItem.serial_number && (
                      <div><span className="text-gray-400">N° série</span><div className="font-mono font-medium">{selectedItem.serial_number}</div></div>
                    )}
                    {selectedItem.location && (
                      <div><span className="text-gray-400">Localisation</span><div>{selectedItem.location}</div></div>
                    )}
                    {selectedItem.purchase_date && (
                      <div><span className="text-gray-400">Date d'achat</span><div>{new Date(selectedItem.purchase_date).toLocaleDateString('fr-FR')}</div></div>
                    )}
                    {selectedItem.warranty_end && (
                      <div>
                        <span className="text-gray-400">Fin de garantie</span>
                        <div className={new Date(selectedItem.warranty_end) < new Date() ? 'text-red-600' : 'text-green-600'}>
                          {new Date(selectedItem.warranty_end).toLocaleDateString('fr-FR')}
                          {new Date(selectedItem.warranty_end) < new Date() ? ' (expirée)' : ' ✓'}
                        </div>
                      </div>
                    )}
                    {selectedItem.maintenance_interval_days && (
                      <div><span className="text-gray-400">Intervalle entretien</span><div>Tous les {selectedItem.maintenance_interval_days} jours</div></div>
                    )}
                    {selectedItem.last_maintenance_date && (
                      <div><span className="text-gray-400">Dernier entretien</span><div>{new Date(selectedItem.last_maintenance_date).toLocaleDateString('fr-FR')}</div></div>
                    )}
                    {selectedItem.next_maintenance_date && (
                      <div>
                        <span className="text-gray-400">Prochain entretien</span>
                        <div className={isMaintenanceDue(selectedItem) ? 'text-red-600 font-medium' : isMaintenanceSoon(selectedItem) ? 'text-amber-600' : ''}>
                          {new Date(selectedItem.next_maintenance_date).toLocaleDateString('fr-FR')}
                          {isMaintenanceDue(selectedItem) && ' ⚠️ en retard'}
                        </div>
                      </div>
                    )}
                  </div>
                  {selectedItem.description && (
                    <div className="mt-3 text-sm text-gray-600">{selectedItem.description}</div>
                  )}
                  {selectedItem.notes && (
                    <div className="mt-2 p-2 bg-yellow-50 rounded-xl text-sm text-yellow-800">📝 {selectedItem.notes}</div>
                  )}
                </div>

                {/* QR Code grand format */}
                <div className="flex flex-col items-center justify-start">
                  <img
                    src={`https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(selectedItem.qr_code)}`}
                    alt="QR Code"
                    className="w-40 h-40 rounded-xl border"
                  />
                  <p className="text-xs font-mono text-gray-400 mt-2 text-center break-all">{selectedItem.qr_code}</p>
                  <a
                    href={`https://api.qrserver.com/v1/create-qr-code/?size=400x400&data=${encodeURIComponent(selectedItem.qr_code)}`}
                    download={`qr_${selectedItem.name}.png`}
                    className="text-blue-600 underline text-xs mt-1"
                  >📥 Télécharger</a>
                </div>
              </div>

              {/* Historique de maintenance */}
              <div>
                <h3 className="font-semibold text-gray-800 mb-3 flex items-center gap-2">
                  <History className="h-4 w-4" /> Historique de maintenance
                  <span className="text-xs font-normal text-gray-400">({maintenanceLogs.length} entrée{maintenanceLogs.length !== 1 ? 's' : ''})</span>
                </h3>

                {/* Formulaire ajout maintenance */}
                <form onSubmit={onSubmitMaintenance} className="p-4 bg-gray-50 rounded-2xl mb-4 space-y-3">
                  <p className="text-sm font-medium text-gray-700">➕ Enregistrer un entretien</p>
                  <div className="grid grid-cols-1 md:grid-cols-4 gap-3">
                    <Select value={maintenanceForm.maintenance_type} onValueChange={(v) => setMaintenanceForm({ ...maintenanceForm, maintenance_type: v })}>
                      <SelectTrigger className="rounded-xl"><SelectValue /></SelectTrigger>
                      <SelectContent>
                        {MAINTENANCE_TYPES.map(t => <SelectItem key={t.value} value={t.value}>{t.icon} {t.label}</SelectItem>)}
                      </SelectContent>
                    </Select>
                    <Input type="date" value={maintenanceForm.performed_at} onChange={(e) => setMaintenanceForm({ ...maintenanceForm, performed_at: e.target.value })} className="rounded-xl" />
                    <Input type="number" step="0.01" placeholder="Coût (€)" value={maintenanceForm.cost} onChange={(e) => setMaintenanceForm({ ...maintenanceForm, cost: e.target.value })} className="rounded-xl" />
                    <Input type="date" placeholder="Prochain entretien" value={maintenanceForm.next_due_date} onChange={(e) => setMaintenanceForm({ ...maintenanceForm, next_due_date: e.target.value })} className="rounded-xl" title="Date du prochain entretien" />
                  </div>
                  <Input placeholder="Description de l'intervention..." value={maintenanceForm.description} onChange={(e) => setMaintenanceForm({ ...maintenanceForm, description: e.target.value })} className="rounded-xl" />
                  <Button type="submit" disabled={savingMaintenance} size="sm" className="rounded-xl">
                    {savingMaintenance ? <Loader2 className="h-4 w-4 animate-spin mr-1" /> : <Wrench className="h-4 w-4 mr-1" />}
                    Enregistrer l'entretien
                  </Button>
                </form>

                {/* Timeline de maintenance */}
                {logsLoading ? (
                  <div className="flex justify-center py-4"><Loader2 className="h-5 w-5 animate-spin text-blue-500" /></div>
                ) : maintenanceLogs.length === 0 ? (
                  <p className="text-sm text-gray-400 text-center py-4">Aucun entretien enregistré pour cet équipement.</p>
                ) : (
                  <div className="space-y-3">
                    {maintenanceLogs.map((log, i) => {
                      const typeInfo = getMaintenanceTypeInfo(log.maintenance_type)
                      return (
                        <div key={log.id || i} className="flex gap-3 items-start group">
                          <div className="flex flex-col items-center">
                            <div className="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-sm">{typeInfo.icon}</div>
                            {i < maintenanceLogs.length - 1 && <div className="w-0.5 h-full bg-gray-200 mt-1" />}
                          </div>
                          <div className="flex-1 pb-4">
                            <div className="flex items-center justify-between">
                              <span className="font-medium text-sm text-gray-800">{typeInfo.label}</span>
                              <span className="text-xs text-gray-400">
                                {log.performed_at ? new Date(log.performed_at).toLocaleDateString('fr-FR') : ''}
                              </span>
                            </div>
                            {log.description && <p className="text-sm text-gray-600 mt-0.5">{log.description}</p>}
                            <div className="flex gap-3 mt-1 text-xs text-gray-400">
                              {log.cost && <span>💰 {parseFloat(log.cost).toFixed(2)} €</span>}
                              {log.users && <span>👤 {log.users.prenom} {log.users.nom}</span>}
                              {log.next_due_date && <span>📅 Prochain: {new Date(log.next_due_date).toLocaleDateString('fr-FR')}</span>}
                            </div>
                          </div>
                        </div>
                      )
                    })}
                  </div>
                )}
              </div>

              {/* Boutons d'action */}
              <div className="flex gap-2 pt-2 border-t border-gray-100">
                <Button onClick={() => onEdit(selectedItem)} className="rounded-xl" variant="outline">
                  <Edit className="h-4 w-4 mr-2" /> Modifier
                </Button>
                {me && !selectedItem.assigned_to && (
                  <Button onClick={async () => {
                    const updates = { assigned_to: me.id, assigned_date: new Date().toISOString(), status: 'IN_USE' }
                    await api.materials.update(selectedItem.id, updates)
                    const refreshed = { ...selectedItem, ...updates }
                    setSelectedItem(refreshed)
                    load()
                  }} className="rounded-xl" variant="outline">
                    <User className="h-4 w-4 mr-2" /> Prendre
                  </Button>
                )}
                {me && selectedItem.assigned_to === me?.id && (
                  <Button onClick={async () => {
                    const updates = { assigned_to: null, assigned_date: null, status: 'DISPONIBLE' }
                    await api.materials.update(selectedItem.id, updates)
                    const refreshed = { ...selectedItem, ...updates }
                    setSelectedItem(refreshed)
                    load()
                  }} className="rounded-xl" variant="outline">
                    <Check className="h-4 w-4 mr-2" /> Rendre
                  </Button>
                )}
                <Button onClick={() => { setDeleteItem(selectedItem); closeDetail() }} className="rounded-xl text-red-600" variant="outline">
                  <Trash2 className="h-4 w-4 mr-2" /> Supprimer
                </Button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Erreur */}
      {error && (
        <div className="fixed bottom-4 right-4 z-50 bg-red-100 text-red-700 px-4 py-2 rounded-xl shadow-lg text-sm flex items-center gap-2">
          <AlertTriangle className="h-4 w-4" /> {error}
          <button onClick={() => setError('')} className="ml-2 hover:text-red-900"><X className="h-3 w-3" /></button>
        </div>
      )}

      {/* Confirmation de suppression */}
      {deleteItem && (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/40">
          <div className="bg-white rounded-2xl shadow-2xl p-6 w-[90%] max-w-sm">
            <div className="text-lg font-semibold mb-2">🗑️ Supprimer ce matériel ?</div>
            <div className="text-sm text-gray-600 mb-4">
              Cette action est irréversible.<br />
              Matériel: <strong>{deleteItem.name}</strong>
              {deleteItem.serial_number && <span className="text-gray-400"> (SN: {deleteItem.serial_number})</span>}
            </div>
            <div className="flex justify-end gap-2">
              <Button variant="outline" onClick={() => setDeleteItem(null)} className="rounded-xl">Annuler</Button>
              <Button variant="destructive" onClick={onDeleteConfirmed} className="rounded-xl">Supprimer définitivement</Button>
            </div>
          </div>
        </div>
      )}
    </div>
  )
}
// Apple-style Bureau Layout Component with Back Button
const BureauLayout = () => {
  const navigate = useNavigate();
  const location = useLocation();
  const [user, setUser] = useState(null);
  const [mobileNavOpen, setMobileNavOpen] = useState(false);

  // Charger les données utilisateur depuis localStorage
  useEffect(() => {
    const userData = localStorage.getItem('user');
    if (userData) {
      setUser(JSON.parse(userData));
    }
  }, []);
  
  // Déterminer l'onglet actif depuis l'URL
  const getActiveTab = () => {
    const path = location.pathname;
    if (path.includes('/projets') || path.includes('/entreprise')) return 'projects';
    if (path.includes('/devis')) return 'quotes';
    if (path.includes('/planning')) return 'planning';
    if (path.includes('/chantiers')) return 'sites';
    if (path.includes('/facturation')) return 'invoices';
    if (path.includes('/clients')) return 'clients';
    if (path.includes('/catalogue')) return 'catalog';
    if (path.includes('/invitations')) return 'invitations';
    if (path.includes('/materiel')) return 'material';
    if (path.includes('/inventaire')) return 'inventory';
    return 'projects'; // Par défaut: Mon Entreprise
  };
  
  const activeTab = getActiveTab();
  
  // Naviguer vers une route spécifique
  const handleTabChange = (newTab) => {
    const routes = {
      'projects': '/bureau/projets',
      'quotes': '/bureau/devis',
      'planning': '/bureau/planning',
      'sites': '/bureau/chantiers',
      'invoices': '/bureau/facturation',
      'clients': '/bureau/clients',
      'catalog': '/bureau/catalogue',
      'invitations': '/bureau/invitations',
      'material': '/bureau/materiel',
      'inventory': '/bureau/inventaire'
    };
    navigate(routes[newTab] || '/bureau/projets');
  };

  const handleLogout = () => {
    localStorage.removeItem('token');
    localStorage.removeItem('user');
    window.location.href = '/';
  };

  const goBack = () => {
    navigate('/role-selection');
  };

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Apple-style Navigation with Back Button */}
      <nav className="bg-white border-b border-gray-200 shadow-sm">
        <div className="max-w-7xl mx-auto px-4 sm:px-6">
          <div className="flex justify-between items-center h-16 sm:h-20 py-2 sm:py-3">
            <div className="flex items-center space-x-2 sm:space-x-4">
              {/* Bouton retour - visible sur mobile */}
              <button
                onClick={goBack}
                className="md:hidden p-1.5 sm:p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg transition-all duration-200"
              >
                <ArrowLeft className="h-4 w-4 sm:h-5 sm:w-5" />
              </button>
              
              {/* Mobile menu burger */}
              <Button
                onClick={() => setMobileNavOpen(!mobileNavOpen)}
                variant="ghost"
                className="md:hidden text-gray-500 hover:text-gray-700 p-2"
              >
                {mobileNavOpen ? <X className="h-5 w-5" /> : <Menu className="h-5 w-5" />}
              </Button>
              
              <img 
                src="/logo.png" 
                alt="SkyApp Logo" 
                className="w-28 h-28 sm:w-28 sm:h-28 md:w-24 md:h-24 lg:w-28 lg:h-28 rounded-lg object-cover logo-neon-stable"
              />
              <div className="h-6 sm:h-8 w-px bg-gray-300 hidden sm:block"></div>
              <div className="hidden sm:block">
                <p className="text-sm font-semibold text-gray-900">{user?.name || user?.email}</p>
                <p className="text-xs text-gray-500">{user?.role === 'ADMIN' ? 'Administrateur' : user?.role === 'BUREAU' ? 'Bureau' : 'Technicien'}</p>
              </div>
            </div>
            
            <div className="flex items-center space-x-1 sm:space-x-2">
              <Button
                onClick={handleLogout}
                variant="ghost"
                className="text-gray-500 hover:text-red-600 hover:bg-red-50 transition-all duration-200 flex items-center space-x-1 sm:space-x-2 text-xs sm:text-sm px-2 sm:px-3"
              >
                <LogOut className="h-3 w-3 sm:h-4 sm:w-4" />
                <span className="font-medium hidden sm:inline">Déconnexion</span>
              </Button>
            </div>
          </div>
        </div>
      </nav>

      {/* Main Content */}
      <main className="max-w-7xl mx-auto py-4 sm:py-6 md:py-8 px-4 sm:px-6">
        <Tabs value={activeTab} onValueChange={handleTabChange}>
          {/* Apple-style Tab Navigation - Desktop only */}
          <div className="hidden md:flex justify-center mb-6 sm:mb-8 overflow-x-auto overflow-y-visible py-2">
            <TabsList className="bg-gradient-to-r from-gray-50 to-gray-100 border-2 border-gray-200 p-1 sm:p-1.5 rounded-2xl shadow-lg inline-flex min-w-max">
              <TabsTrigger 
                value="projects" 
                className="flex items-center space-x-1 sm:space-x-2 px-3 sm:px-4 md:px-5 py-2 sm:py-3 rounded-xl data-[state=active]:bg-white data-[state=active]:shadow-md data-[state=active]:text-blue-600 transition-all duration-200 whitespace-nowrap hover:bg-white/50"
              >
                <Briefcase className="h-4 w-4" />
                <span className="font-semibold text-xs sm:text-sm">Entreprise</span>
              </TabsTrigger>
              <TabsTrigger 
                value="quotes" 
                className="flex items-center space-x-1 sm:space-x-2 px-3 sm:px-4 md:px-5 py-2 sm:py-3 rounded-xl data-[state=active]:bg-white data-[state=active]:shadow-md data-[state=active]:text-blue-600 transition-all duration-200 whitespace-nowrap hover:bg-white/50"
              >
                <Calculator className="h-4 w-4" />
                <span className="font-semibold text-xs sm:text-sm">Devis</span>
              </TabsTrigger>
              <TabsTrigger 
                value="planning" 
                className="flex items-center space-x-1 sm:space-x-2 px-3 sm:px-4 md:px-5 py-2 sm:py-3 rounded-xl data-[state=active]:bg-white data-[state=active]:shadow-md data-[state=active]:text-blue-600 transition-all duration-200 whitespace-nowrap hover:bg-white/50"
              >
                <Calendar className="h-4 w-4" />
                <span className="font-semibold text-xs sm:text-sm">Planning</span>
              </TabsTrigger>
              <TabsTrigger 
                value="sites" 
                className="flex items-center space-x-1 sm:space-x-2 px-3 sm:px-4 md:px-5 py-2 sm:py-3 rounded-xl data-[state=active]:bg-white data-[state=active]:shadow-md data-[state=active]:text-blue-600 transition-all duration-200 whitespace-nowrap hover:bg-white/50"
              >
                <Building className="h-4 w-4" />
                <span className="font-semibold text-xs sm:text-sm">Chantiers</span>
              </TabsTrigger>
              <TabsTrigger 
                value="invoices" 
                className="flex items-center space-x-1 sm:space-x-2 px-3 sm:px-4 md:px-5 py-2 sm:py-3 rounded-xl data-[state=active]:bg-white data-[state=active]:shadow-md data-[state=active]:text-blue-600 transition-all duration-200 whitespace-nowrap hover:bg-white/50"
              >
                <FileText className="h-4 w-4" />
                <span className="font-semibold text-xs sm:text-sm">Facturation</span>
              </TabsTrigger>
              <TabsTrigger 
                value="clients" 
                className="flex items-center space-x-1 sm:space-x-2 px-3 sm:px-4 md:px-5 py-2 sm:py-3 rounded-xl data-[state=active]:bg-white data-[state=active]:shadow-md data-[state=active]:text-blue-600 transition-all duration-200 whitespace-nowrap hover:bg-white/50"
              >
                <Users className="h-4 w-4" />
                <span className="font-semibold text-xs sm:text-sm">Clients</span>
              </TabsTrigger>
              <TabsTrigger 
                value="catalog" 
                className="flex items-center space-x-1 sm:space-x-2 px-3 sm:px-4 md:px-5 py-2 sm:py-3 rounded-xl data-[state=active]:bg-white data-[state=active]:shadow-md data-[state=active]:text-blue-600 transition-all duration-200 whitespace-nowrap hover:bg-white/50"
              >
                <ClipboardList className="h-4 w-4" />
                <span className="font-semibold text-xs sm:text-sm">Catalogue</span>
              </TabsTrigger>
              <TabsTrigger 
                value="invitations" 
                className="flex items-center space-x-1 sm:space-x-2 px-3 sm:px-4 md:px-5 py-2 sm:py-3 rounded-xl data-[state=active]:bg-white data-[state=active]:shadow-md data-[state=active]:text-blue-600 transition-all duration-200 whitespace-nowrap hover:bg-white/50"
              >
                <UserPlus className="h-4 w-4" />
                <span className="font-semibold text-xs sm:text-sm">Invitations</span>
              </TabsTrigger>
              <TabsTrigger 
                value="material" 
                className="flex items-center space-x-1 sm:space-x-2 px-3 sm:px-4 md:px-5 py-2 sm:py-3 rounded-xl data-[state=active]:bg-white data-[state=active]:shadow-md data-[state=active]:text-blue-600 transition-all duration-200 whitespace-nowrap hover:bg-white/50"
              >
                <Settings className="h-4 w-4" />
                <span className="font-semibold text-xs sm:text-sm">Matériel</span>
              </TabsTrigger>
            </TabsList>
          </div>

          {/* Mobile Navigation Menu */}
          <div className={`md:hidden transition-all duration-300 ease-in-out overflow-hidden ${
            mobileNavOpen ? 'max-h-[600px] opacity-100 mb-6' : 'max-h-0 opacity-0'
          }`}>
            <div className="bg-white border-2 border-black rounded-xl shadow-lg p-2 space-y-2">
              <button
                onClick={() => {
                  handleTabChange('projects');
                  setMobileNavOpen(false);
                }}
                className={`w-full flex items-center space-x-3 px-4 py-3 rounded-lg transition-all ${
                  activeTab === 'projects'
                    ? 'bg-gray-900 text-white'
                    : 'bg-white text-gray-700 hover:bg-gray-100'
                }`}
              >
                <Briefcase className="h-5 w-5" />
                <span className="font-medium">Entreprise</span>
              </button>
              <button
                onClick={() => {
                  handleTabChange('quotes');
                  setMobileNavOpen(false);
                }}
                className={`w-full flex items-center space-x-3 px-4 py-3 rounded-lg transition-all ${
                  activeTab === 'quotes'
                    ? 'bg-gray-900 text-white'
                    : 'bg-white text-gray-700 hover:bg-gray-100'
                }`}
              >
                <Calculator className="h-5 w-5" />
                <span className="font-medium">Devis</span>
              </button>
              <button
                onClick={() => {
                  handleTabChange('planning');
                  setMobileNavOpen(false);
                }}
                className={`w-full flex items-center space-x-3 px-4 py-3 rounded-lg transition-all ${
                  activeTab === 'planning'
                    ? 'bg-gray-900 text-white'
                    : 'bg-white text-gray-700 hover:bg-gray-100'
                }`}
              >
                <Calendar className="h-5 w-5" />
                <span className="font-medium">Planning</span>
              </button>
              <button
                onClick={() => {
                  handleTabChange('sites');
                  setMobileNavOpen(false);
                }}
                className={`w-full flex items-center space-x-3 px-4 py-3 rounded-lg transition-all ${
                  activeTab === 'sites'
                    ? 'bg-gray-900 text-white'
                    : 'bg-white text-gray-700 hover:bg-gray-100'
                }`}
              >
                <Building className="h-5 w-5" />
                <span className="font-medium">Chantiers</span>
              </button>
              <button
                onClick={() => {
                  handleTabChange('invoices');
                  setMobileNavOpen(false);
                }}
                className={`w-full flex items-center space-x-3 px-4 py-3 rounded-lg transition-all ${
                  activeTab === 'invoices'
                    ? 'bg-gray-900 text-white'
                    : 'bg-white text-gray-700 hover:bg-gray-100'
                }`}
              >
                <FileText className="h-5 w-5" />
                <span className="font-medium">Facturation</span>
              </button>
              <button
                onClick={() => {
                  handleTabChange('clients');
                  setMobileNavOpen(false);
                }}
                className={`w-full flex items-center space-x-3 px-4 py-3 rounded-lg transition-all ${
                  activeTab === 'clients'
                    ? 'bg-gray-900 text-white'
                    : 'bg-white text-gray-700 hover:bg-gray-100'
                }`}
              >
                <Users className="h-5 w-5" />
                <span className="font-medium">Clients</span>
              </button>
              <button
                onClick={() => {
                  handleTabChange('catalog');
                  setMobileNavOpen(false);
                }}
                className={`w-full flex items-center space-x-3 px-4 py-3 rounded-lg transition-all ${
                  activeTab === 'catalog'
                    ? 'bg-gray-900 text-white'
                    : 'bg-white text-gray-700 hover:bg-gray-100'
                }`}
              >
                <ClipboardList className="h-5 w-5" />
                <span className="font-medium">Catalogue</span>
              </button>
              <button
                onClick={() => {
                  handleTabChange('invitations');
                  setMobileNavOpen(false);
                }}
                className={`w-full flex items-center space-x-3 px-4 py-3 rounded-lg transition-all ${
                  activeTab === 'invitations'
                    ? 'bg-gray-900 text-white'
                    : 'bg-white text-gray-700 hover:bg-gray-100'
                }`}
              >
                <UserPlus className="h-5 w-5" />
                <span className="font-medium">Invitations</span>
              </button>
              <button
                onClick={() => {
                  handleTabChange('material');
                  setMobileNavOpen(false);
                }}
                className={`w-full flex items-center space-x-3 px-4 py-3 rounded-lg transition-all ${
                  activeTab === 'material'
                    ? 'bg-gray-900 text-white'
                    : 'bg-white text-gray-700 hover:bg-gray-100'
                }`}
              >
                <Settings className="h-5 w-5" />
                <span className="font-medium">Matériel</span>
              </button>
              <button
                onClick={() => {
                  handleLogout();
                  setMobileNavOpen(false);
                }}
                className="w-full flex items-center space-x-3 px-4 py-3 rounded-lg bg-white text-red-600 hover:bg-red-50 transition-all"
              >
                <LogOut className="h-5 w-5" />
                <span className="font-medium">Déconnexion</span>
              </button>
            </div>
          </div>

          {/* Onglet connexion supprimé pour les rôles non fondateur */}

          <TabsContent value="projects" className="mt-4 sm:mt-6 md:mt-8">
            <ProjectsHub />
          </TabsContent>

          <TabsContent value="quotes" className="mt-4 sm:mt-6 md:mt-8">
            <QuoteCreate />
          </TabsContent>

          <TabsContent value="planning" className="mt-4 sm:mt-6 md:mt-8">
            <PlanningManagement />
          </TabsContent>

          <TabsContent value="sites" className="mt-4 sm:mt-6 md:mt-8">
            <WorksitesManagement />
          </TabsContent>

          <TabsContent value="invoices" className="mt-4 sm:mt-6 md:mt-8">
            <InvoicingModule />
          </TabsContent>

          <TabsContent value="clients" className="mt-4 sm:mt-6 md:mt-8">
            <ClientsView />
          </TabsContent>

          <TabsContent value="catalog" className="mt-4 sm:mt-6 md:mt-8">
            <CatalogManagement />
          </TabsContent>

          <TabsContent value="invitations" className="mt-4 sm:mt-6 md:mt-8">
            <InviteManagementView />
          </TabsContent>

          <TabsContent value="material" className="mt-4 sm:mt-6 md:mt-8">
            <MaterialManagement />
          </TabsContent>
        </Tabs>
      </main>
    </div>
  );
};

// Dashboard Statistiques Ultra-Complet avec données isolées par société
const StatisticsLayout = () => {
  const navigate = useNavigate();
  const [stats, setStats] = useState({});
  const [loading, setLoading] = useState(true);
  const [timeRange, setTimeRange] = useState('7d');
  const [activeUsers, setActiveUsers] = useState(0);

  useEffect(() => {
    loadStatistics();
    simulateActiveUsers();
    const interval = setInterval(simulateActiveUsers, 5000); // Update every 5 seconds
    return () => clearInterval(interval);
  }, [timeRange]);

  const simulateActiveUsers = () => {
    // Simulate 25-35 active users
    setActiveUsers(Math.floor(Math.random() * 11) + 25);
  };

  const loadStatistics = async () => {
    try {
      const response = await axios.get(`${API}/stats/dashboard`, {
        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
      });
      setStats(response.data);
    } catch (error) {
      console.error('Erreur chargement statistiques:', error);
    } finally {
      setLoading(false);
    }
  };

  const handleLogout = () => {
    localStorage.removeItem('token');
    localStorage.removeItem('user');
    window.location.href = '/';
  };

  const goBack = () => {
    navigate('/role-selection');
  };

  // Calculs avancés des KPI avec vraies données
  const totalRevenue = (stats.total_quotes_amount || 0);
  const previousRevenue = (stats.previous_quotes_amount || totalRevenue * 0.85);
  const monthlyGrowth = previousRevenue > 0 ? Math.round(((totalRevenue - previousRevenue) / previousRevenue) * 100) : 17;
  const customerSatisfaction = stats.average_client_rating || 4.7;
  const avgProjectDuration = stats.average_project_duration || 12.5;
  const productivityIndex = stats.productivity_index || 98;
  const totalProjects = stats.total_projects || stats.total_searches || 0;
  const totalClients = stats.total_clients || 0;
  const conversionRate = stats.quote_conversion_rate || 73;
  const avgResponseTime = stats.average_response_time || '2.4h';
  const retentionRate = stats.client_retention_rate || 87;
  const avgMargin = stats.average_margin || 32;
  const dailyInterventions = stats.daily_interventions || Math.round(totalProjects / 30) || 3.2;
  const activeTeams = stats.active_teams || 12;
  const coveredZones = stats.covered_zones || '8 régions';
  const generatedReports = stats.generated_reports || totalProjects * 2;
  const timeSaved = stats.time_saved || '42h/semaine';

  const StatCard = ({ title, value, change, icon: Icon, color, suffix = '', size = 'normal' }) => (
    <div className={`bg-white rounded-3xl border-0 shadow-lg p-6 hover:shadow-xl transition-all duration-300 ${size === 'large' ? 'md:col-span-2' : ''}`}>
      <div className="flex items-center justify-between">
        <div className="flex-1">
          <p className="text-sm font-medium text-gray-600 mb-2">{title}</p>
          <p className={`${size === 'large' ? 'text-4xl' : 'text-3xl'} font-bold text-gray-900 mb-1`}>{value}{suffix}</p>
          {change !== undefined && (
            <div className="flex items-center space-x-2">
              <span className={`text-sm px-2 py-1 rounded-full ${change >= 0 ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                {change >= 0 ? '+' : ''}{change}%
              </span>
              <span className="text-xs text-gray-500">vs période précédente</span>
            </div>
          )}
        </div>
        <div className={`w-16 h-16 ${color} rounded-2xl flex items-center justify-center shadow-lg`}>
          <Icon className="h-8 w-8 text-white" />
        </div>
      </div>
    </div>
  );

  const MetricCard = ({ title, metrics, icon: Icon, color }) => (
    <div className="bg-white rounded-3xl border-0 shadow-lg p-6 hover:shadow-xl transition-all duration-300">
      <div className="flex items-center justify-between mb-4">
        <h3 className="text-lg font-semibold text-gray-900">{title}</h3>
        <div className={`w-12 h-12 ${color} rounded-xl flex items-center justify-center`}>
          <Icon className="h-6 w-6 text-white" />
        </div>
      </div>
      <div className="space-y-3">
        {metrics.map((metric, index) => (
          <div key={index} className="flex items-center justify-between">
            <span className="text-sm text-gray-600">{metric.label}</span>
            <span className="text-sm font-semibold text-gray-900">{metric.value}</span>
          </div>
        ))}
      </div>
    </div>
  );

  if (loading) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-gray-50 via-white to-gray-100 flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin rounded-full h-16 w-16 border-b-2 border-purple-600 mx-auto mb-4"></div>
          <p className="text-lg text-gray-600">Chargement du dashboard...</p>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-gray-50 via-white to-gray-100">
      {/* Header Premium */}
      <header className="bg-gradient-to-r from-gray-900 via-gray-800 to-gray-900 text-white shadow-2xl">
        <div className="max-w-7xl mx-auto px-6 py-8">
          <div className="flex items-center justify-between">
            <div className="flex items-center space-x-4">
              <button
                onClick={goBack}
                className="p-3 bg-white/20 hover:bg-white/30 rounded-2xl transition-colors backdrop-blur-sm"
              >
                <ArrowLeft className="h-5 w-5" />
              </button>
              <div>
                <h1 className="text-3xl font-bold">Dashboard Exécutif</h1>
                <p className="text-gray-300 mt-1">Analytics & Intelligence d'Entreprise</p>
              </div>
            </div>
            <div className="flex items-center space-x-4">
              <div className="flex items-center space-x-2 bg-white/10 px-4 py-2 rounded-2xl backdrop-blur-sm">
                <div className="w-3 h-3 bg-green-400 rounded-full animate-pulse"></div>
                <span className="text-sm font-medium">{activeUsers} utilisateurs actifs</span>
              </div>
              <div className="flex space-x-2">
                {['7d', '30d', '90d'].map((range) => (
                  <button
                    key={range}
                    onClick={() => setTimeRange(range)}
                    className={`px-4 py-2 rounded-xl font-medium transition-colors ${
                      timeRange === range 
                        ? 'bg-white text-gray-900 shadow-lg' 
                        : 'bg-white/20 hover:bg-white/30 text-white backdrop-blur-sm'
                    }`}
                  >
                    {range === '7d' ? '7 jours' : range === '30d' ? '30 jours' : '90 jours'}
                  </button>
                ))}
              </div>
              <button onClick={handleLogout} className="p-3 bg-red-600 hover:bg-red-700 rounded-2xl transition-colors">
                <LogOut className="h-5 w-5" />
              </button>
            </div>
          </div>
        </div>
      </header>

      <main className="max-w-7xl mx-auto px-6 py-8">
        {/* KPI Principaux */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
          <StatCard
            title="Chiffre d'Affaires"
            value={totalRevenue.toLocaleString('fr-FR')}
            suffix="€"
            change={monthlyGrowth}
            icon={BarChart3}
            color="bg-gradient-to-br from-green-500 to-green-600"
            size="large"
          />
          <StatCard
            title="Projets Actifs"
            value={totalProjects}
            change={stats.projects_growth || 12}
            icon={Briefcase}
            color="bg-gradient-to-br from-blue-500 to-blue-600"
          />
          <StatCard
            title="Clients Satisfaits"
            value={customerSatisfaction}
            suffix="/5"
            change={stats.satisfaction_growth || 2}
            icon={Star}
            color="bg-gradient-to-br from-yellow-500 to-orange-500"
          />
        </div>

        {/* Métriques Avancées */}
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
          <MetricCard
            title="Performance Commerciale"
            icon={Target}
            color="bg-gradient-to-br from-purple-500 to-purple-600"
            metrics={[
              { label: 'Devis Convertis', value: `${conversionRate}%` },
              { label: 'Temps Moyen Réponse', value: avgResponseTime },
              { label: 'Taux Fidélisation', value: `${retentionRate}%` },
              { label: 'Marge Moyenne', value: `${avgMargin}%` }
            ]}
          />
          <MetricCard
            title="Opérations Terrain"
            icon={MapPin}
            color="bg-gradient-to-br from-indigo-500 to-indigo-600"
            metrics={[
              { label: 'Interventions/Jour', value: typeof dailyInterventions === 'number' ? dailyInterventions.toFixed(1) : dailyInterventions },
              { label: 'Durée Moyenne Projet', value: `${avgProjectDuration}j` },
              { label: 'Équipes Déployées', value: activeTeams.toString() },
              { label: 'Zones Couvertes', value: coveredZones }
            ]}
          />
          <MetricCard
            title="Productivité Équipe"
            icon={Users}
            color="bg-gradient-to-br from-teal-500 to-teal-600"
            metrics={[
              { label: 'Index Productivité', value: `${productivityIndex}%` },
              { label: 'Utilisateurs Actifs', value: (stats.active_users || activeUsers).toString() },
              { label: 'Rapports Générés', value: generatedReports.toString() },
              { label: 'Temps Économisé', value: timeSaved }
            ]}
          />
        </div>

        {/* Analytics Avancées */}
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
          {/* Performance par Région */}
          <div className="bg-white rounded-3xl border-0 shadow-lg p-6">
            <h3 className="text-xl font-semibold text-gray-900 mb-6 flex items-center">
              <Globe className="h-6 w-6 mr-2 text-blue-600" />
              Performance par Région
            </h3>
            <div className="space-y-4">
              {[
                { name: 'Île-de-France', value: 45, projects: 12, revenue: '28K€', color: 'bg-blue-500' },
                { name: 'Auvergne-Rhône-Alpes', value: 28, projects: 8, revenue: '18K€', color: 'bg-green-500' },
                { name: 'Provence-Alpes-Côte d\'Azur', value: 15, projects: 4, revenue: '12K€', color: 'bg-purple-500' },
                { name: 'Nouvelle-Aquitaine', value: 12, projects: 3, revenue: '8K€', color: 'bg-orange-500' }
              ].map((region, index) => (
                <div key={index} className="p-4 bg-gray-50 rounded-2xl">
                  <div className="flex items-center justify-between mb-2">
                    <span className="font-medium text-gray-900">{region.name}</span>
                    <span className="text-sm font-semibold text-green-600">{region.revenue}</span>
                  </div>
                  <div className="flex items-center space-x-3">
                    <div className="flex-1 bg-gray-200 rounded-full h-3">
                      <div className={`${region.color} h-3 rounded-full transition-all duration-1000`} style={{ width: `${region.value}%` }}></div>
                    </div>
                    <span className="text-sm text-gray-600">{region.projects} projets</span>
                  </div>
                </div>
              ))}
            </div>
          </div>

          {/* Activité Temps Réel */}
          <div className="bg-white rounded-3xl border-0 shadow-lg p-6">
            <h3 className="text-xl font-semibold text-gray-900 mb-6 flex items-center">
              <Clock className="h-6 w-6 mr-2 text-purple-600" />
              Activité Temps Réel
            </h3>
            <div className="space-y-4">
              {[
                { user: 'Marie L.', action: 'Rapport généré - Chantier Lyon', time: '2 min', color: 'bg-green-500', icon: FileText },
                { user: 'Pierre M.', action: 'Devis créé - 15K€', time: '5 min', color: 'bg-blue-500', icon: Calculator },
                { user: 'Sophie R.', action: 'Mission planifiée - Équipe A', time: '8 min', color: 'bg-purple-500', icon: Calendar },
                { user: 'Thomas B.', action: 'Client ajouté - Construction XYZ', time: '12 min', color: 'bg-orange-500', icon: UserPlus },
                { user: 'Julie K.', action: 'Recherche terrain terminée', time: '15 min', color: 'bg-teal-500', icon: MapPin }
              ].map((activity, index) => (
                <div key={index} className="flex items-center space-x-4 p-3 hover:bg-gray-50 rounded-xl transition-colors">
                  <div className={`w-10 h-10 ${activity.color} rounded-xl flex items-center justify-center`}>
                    <activity.icon className="h-5 w-5 text-white" />
                  </div>
                  <div className="flex-1">
                    <p className="text-sm font-medium text-gray-900">{activity.action}</p>
                    <p className="text-xs text-gray-600">par {activity.user} • il y a {activity.time}</p>
                  </div>
                  <div className="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                </div>
              ))}
            </div>
          </div>
        </div>

        {/* Objectifs et Prévisions */}
        <div className="bg-white rounded-3xl border-0 shadow-lg p-8">
          <h3 className="text-2xl font-semibold text-gray-900 mb-8 flex items-center">
            <Target className="h-7 w-7 mr-3 text-indigo-600" />
            Objectifs Mensuels & Prévisions
          </h3>
          <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
            {[
              { label: 'Projets Réalisés', current: stats.total_searches || 0, target: 100, unit: '' },
              { label: 'Chiffre d\'Affaires', current: Math.floor(totalRevenue/1000), target: 150, unit: 'K€' },
              { label: 'Satisfaction Client', current: 4.7, target: 5.0, unit: '/5' }
            ].map((objective, index) => {
              const progress = (objective.current / objective.target) * 100;
              return (
                <div key={index} className="text-center">
                  <div className="mb-4">
                    <div className="text-3xl font-bold text-gray-900 mb-1">
                      {objective.current}{objective.unit}
                    </div>
                    <div className="text-sm text-gray-600">
                      Objectif: {objective.target}{objective.unit}
                    </div>
                  </div>
                  <div className="w-full bg-gray-200 rounded-full h-4 mb-2">
                    <div 
                      className="bg-gradient-to-r from-indigo-500 to-purple-600 h-4 rounded-full transition-all duration-1000" 
                      style={{ width: `${Math.min(progress, 100)}%` }}
                    ></div>
                  </div>
                  <div className="flex justify-between text-sm text-gray-600">
                    <span>{objective.label}</span>
                    <span>{Math.round(progress)}%</span>
                  </div>
                </div>
              );
            })}
          </div>
        </div>
      </main>
    </div>
  );
};

// Login Modal Component with Apple Design
const LoginModal = ({ open, onClose }) => {
  const navigate = useNavigate();
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');
  const [rememberMe, setRememberMe] = useState(false);

  // Charger l'email sauvegardé au montage du composant
  useEffect(() => {
    const savedEmail = localStorage.getItem('rememberedEmail');
    if (savedEmail) {
      setEmail(savedEmail);
      setRememberMe(true);
    }
  }, []);

  const handleSubmit = async (e) => {
    e.preventDefault();
    setLoading(true);
    setError('');

    try {
      const response = await axios.post(`${API}/auth/login`, { email, password });
      const { token, access_token, refresh_token, user } = response.data;
      
      // Stocker le token (privilégier access_token si disponible)
      const finalToken = access_token || token;
      localStorage.setItem('token', finalToken);
      localStorage.setItem('user', JSON.stringify(user));
      
      // Stocker le refresh_token pour rafraîchir la session plus tard
      if (refresh_token) {
        localStorage.setItem('refresh_token', refresh_token);
      }

      // Injecter la session Supabase Auth dans le client JS
      // pour que les appels directs (materials, maintenance_logs) fonctionnent
      if (access_token && refresh_token) {
        await supabase.auth.setSession({ access_token, refresh_token });
      }
      
      // L'intercepteur ajoutera automatiquement le token aux prochaines requêtes
      // mais on le met aussi dans les defaults pour garantir la compatibilité
      axios.defaults.headers.common['Authorization'] = `Bearer ${finalToken}`;
      
      // Sauvegarder l'email si "Se souvenir de moi" est coché
      if (rememberMe) {
        localStorage.setItem('rememberedEmail', email);
      } else {
        localStorage.removeItem('rememberedEmail');
      }
      
      onClose();
      // Redirection automatique vers la sélection de rôle
      window.location.href = '/role-selection';
    } catch (err) {
      setError(err.response?.data?.detail || 'Erreur de connexion');
    } finally {
      setLoading(false);
    }
  };

  const initSampleData = async () => {
    try {
      await axios.post(`${API}/init-sample-data`);
      alert('Données d\'exemple créées !\nTechnicien: tech@search-app.fr / tech123\nBureau: bureau@search-app.fr / bureau123');
    } catch (err) {
      console.error('Erreur création données exemple:', err);
    }
  };

  return (
    <Dialog open={open} onOpenChange={onClose}>
      <DialogContent className="sm:max-w-md">
        <DialogHeader>
          <DialogTitle>Connexion</DialogTitle>
          <DialogDescription>
            Connectez-vous à votre compte SearchApp
          </DialogDescription>
        </DialogHeader>
        <form onSubmit={handleSubmit} className="space-y-4">
          <div>
            <Input
              type="email"
              placeholder="Adresse email"
              value={email}
              onChange={(e) => setEmail(e.target.value)}
              required
            />
          </div>
          <div>
            <Input
              type="password"
              placeholder="Mot de passe"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              required
            />
          </div>
          <div className="flex items-center space-x-2">
            <input
              type="checkbox"
              id="rememberMe"
              checked={rememberMe}
              onChange={(e) => setRememberMe(e.target.checked)}
              className="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
            />
            <label htmlFor="rememberMe" className="text-sm text-gray-700 cursor-pointer">
              Se souvenir de moi
            </label>
          </div>
          {error && (
            <div className="text-red-500 text-sm">{error}</div>
          )}
          <Button type="submit" disabled={loading} className="w-full">
            {loading ? 'Connexion...' : 'Se connecter'}
          </Button>
        </form>
        
        <div className="mt-4 pt-4 border-t">
          <Button 
            onClick={initSampleData}
            variant="outline" 
            className="w-full"
          >
            Données d'exemple
          </Button>
        </div>
      </DialogContent>
    </Dialog>
  );
};

// Administration Fondateur (anciennement panel suprême) - réservé à skyapp@gmail.com
const SupremeAdminLayout = () => {
  const navigate = useNavigate();
  const [users, setUsers] = useState([]);
  const [companies, setCompanies] = useState([]);
  const [systemStats, setSystemStats] = useState({});
  const [loading, setLoading] = useState(true);
  const [activeTab, setActiveTab] = useState('users');
  const [loadError, setLoadError] = useState(null);
  const [searchTerm, setSearchTerm] = useState('');
  const [roleFilter, setRoleFilter] = useState('ALL');
  const [companyFilter, setCompanyFilter] = useState('ALL');
  const [companySearch, setCompanySearch] = useState('');

  useEffect(() => {
    // Vérifier que l'utilisateur est bien le fondateur
    const userData = localStorage.getItem('user');
    if (userData) {
      const user = JSON.parse(userData);
      if (!user.is_fondateur) {
        navigate('/role-selection');
        return;
      }
    } else {
      navigate('/');
      return;
    }
    loadSystemData();
  }, [navigate]);

  const loadSystemData = async () => {
    try {
      const token = localStorage.getItem('token');
      // 1) Utilisateurs réels via endpoint fondateur
      const usersRes = await axios.get(`${API}/founder/users`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      const list = (usersRes.data?.users || []).map(u => ({
        id: u.id,
        email: u.email,
        nom: u.email?.split('@')[0] || '',
        role: u.role || 'TECHNICIEN',
        company: u.company_id || null,
        status: u.actif === false ? 'SUSPENDED' : 'ACTIVE',
        created_at: u.created_at
      }));
      setUsers(list);
      if ((usersRes.data?.count || 0) === 0 && usersRes.data?.debug_reason) {
        setLoadError(usersRes.data.debug_reason);
      } else {
        setLoadError(null);
      }

      // 2) Aperçu système (utilise l'overview pour quelques compteurs)
      const overviewRes = await axios.get(`${API}/founder/overview`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      const ov = overviewRes.data || {};
      setSystemStats({
        total_users: ov?.totals?.users || list.length,
        total_companies: ov?.totals?.companies || 0,
        total_searches: ov?.totals?.searches || 0,
        total_reports: ov?.totals?.reports || ov?.totals?.searches || 0,
        active_sessions: 0,
        server_uptime: '99.9%'
      });

      // 3) Entreprises basique (optionnel: à brancher si endpoint dédié existe)
      try {
        const companiesRes = await axios.get(`${API}/companies`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        setCompanies((companiesRes.data || []).map(c => ({
          id: c.id,
          nom: c.name,
          users_count: list.filter(u => u.company === c.id).length,
          active_searches: 0,
          total_reports: 0,
          subscription: c.subscription || 'N/A',
          created_at: c.created_at
        })));
      } catch {
        setCompanies([]);
      }
    } catch (error) {
      console.error('Erreur chargement données système:', error);
      setLoadError(error?.response?.data?.detail || error?.message || 'Erreur réseau');
    } finally {
      setLoading(false);
    }
  };

  const companyMap = React.useMemo(() => {
    const map = {};
    companies.forEach(c => {
      map[c.id] = c.nom || c.id;
    });
    return map;
  }, [companies]);

  const filteredUsers = React.useMemo(() => {
    const term = searchTerm.trim().toLowerCase();
    return users.filter(user => {
      if (roleFilter !== 'ALL' && (user.role || '').toUpperCase() !== roleFilter) {
        return false;
      }
      if (companyFilter === 'NONE') {
        if (user.company) return false;
      } else if (companyFilter !== 'ALL' && (user.company || '') !== companyFilter) {
        return false;
      }
      if (!term) return true;
      const companyName = companyMap[user.company] || '';
      return [user.email, user.nom, companyName].some(field => (field || '').toLowerCase().includes(term));
    });
  }, [users, roleFilter, companyFilter, searchTerm, companyMap]);

  const filteredCompanies = React.useMemo(() => {
    const term = companySearch.trim().toLowerCase();
    return companies.filter(company => {
      if (!term) return true;
      return (company.nom || company.id || '').toLowerCase().includes(term);
    });
  }, [companies, companySearch]);

  const handleLogout = () => {
    localStorage.removeItem('token');
    localStorage.removeItem('user');
    navigate('/');
  };

  const goBack = () => {
    navigate('/role-selection');
  };

  const toggleUserStatus = (userId) => {
    setUsers(prev => prev.map(user => 
      user.id === userId 
        ? { ...user, status: user.status === 'ACTIVE' ? 'SUSPENDED' : 'ACTIVE' }
        : user
    ));
    alert('Statut utilisateur modifié');
  };

  const deleteCompany = (companyId) => {
    if (confirm('Êtes-vous sûr de vouloir supprimer cette entreprise ? Cette action est irréversible.')) {
      setCompanies(prev => prev.filter(company => company.id !== companyId));
      alert('Entreprise supprimée');
    }
  };

  if (loading) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-red-600 mx-auto"></div>
          <p className="mt-4 text-gray-600">Chargement du panel administrateur...</p>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-gray-900 to-red-900">
  {/* Navigation Administration Fondateur */}
  <nav className="bg-gradient-to-r from-black via-zinc-800 to-red-800 border-b border-red-900">
        <div className="max-w-7xl mx-auto px-6">
          <div className="flex justify-between items-center h-16">
            <div className="flex items-center">
              <button
                onClick={goBack}
                className="mr-4 p-2 text-red-200 hover:text-white hover:bg-red-700/50 rounded-lg transition-colors duration-200"
              >
                <ArrowLeft className="h-5 w-5" />
              </button>
              <div className="w-8 h-8 bg-white/20 rounded-lg flex items-center justify-center mr-3">
                <Shield className="h-5 w-5 text-white" />
              </div>
              <div>
                <span className="text-xl font-semibold text-white">SkyApp Fondateur</span>
                <span className="text-sm text-red-200 ml-2">Administration Globale</span>
              </div>
            </div>
            
            <div className="flex items-center space-x-4 text-white">
              <span className="text-sm bg-red-900/40 px-3 py-1 rounded-full border border-red-700">Fondateur</span>
              <Button
                onClick={handleLogout}
                variant="ghost"
                className="text-red-200 hover:text-white hover:bg-red-700/50 p-2"
              >
                <LogOut className="h-4 w-4" />
              </Button>
            </div>
          </div>
        </div>
      </nav>

      {/* Main Content */}
  <main className="max-w-7xl mx-auto py-8 px-6">
        {/* Header */}
        <div className="mb-8">
          <h1 className="text-4xl font-bold text-white mb-2">Administration Fondateur</h1>
          <p className="text-lg text-white">Contrôle global et supervision de l'écosystème SkyApp</p>
        </div>

  {/* System Stats Overview */}
  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-4 mb-8">
          <div className="bg-white rounded-2xl p-4 shadow-sm border border-gray-200">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm text-gray-600">Utilisateurs</p>
                <p className="text-2xl font-bold text-gray-900">{systemStats.total_users}</p>
              </div>
              <Users className="h-8 w-8 text-blue-500" />
            </div>
          </div>
          
          <div className="bg-white rounded-2xl p-4 shadow-sm border border-gray-200">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm text-gray-600">Entreprises</p>
                <p className="text-2xl font-bold text-gray-900">{systemStats.total_companies}</p>
              </div>
              <Building className="h-8 w-8 text-green-500" />
            </div>
          </div>
          
          <div className="bg-white rounded-2xl p-4 shadow-sm border border-gray-200">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm text-gray-600">Recherches</p>
                <p className="text-2xl font-bold text-gray-900">{systemStats.total_searches}</p>
              </div>
              <Search className="h-8 w-8 text-red-500" />
            </div>
          </div>
          
          <div className="bg-white rounded-2xl p-4 shadow-sm border border-gray-200">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm text-gray-600">Rapports</p>
                <p className="text-2xl font-bold text-gray-900">{systemStats.total_reports}</p>
              </div>
              <FileText className="h-8 w-8 text-orange-500" />
            </div>
          </div>
          
          <div className="bg-white rounded-2xl p-4 shadow-sm border border-gray-200">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm text-gray-600">Sessions</p>
                <p className="text-2xl font-bold text-gray-900">{systemStats.active_sessions}</p>
              </div>
              <Target className="h-8 w-8 text-red-500" />
            </div>
          </div>
          
          <div className="bg-white rounded-2xl p-4 shadow-sm border border-gray-200">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm text-gray-600">Uptime</p>
                <p className="text-2xl font-bold text-green-600">{systemStats.server_uptime}</p>
              </div>
              <CheckCircle className="h-8 w-8 text-green-500" />
            </div>
          </div>
        </div>

        {loadError && (
          <div className="mb-6 p-4 rounded-xl border border-amber-300 bg-amber-50 text-amber-800 text-sm">
            {String(loadError)}
          </div>
        )}

        {/* Tabs */}
  <div className="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
          <div className="border-b border-gray-200">
            <div className="flex space-x-1 p-1">
              <button
                onClick={() => setActiveTab('users')}
                className={`px-6 py-3 rounded-xl font-medium transition-colors ${
                  activeTab === 'users' 
                    ? 'bg-red-50 text-red-700 border border-red-200' 
                    : 'text-gray-600 hover:text-gray-800'
                }`}
              >
                Utilisateurs ({users.length})
              </button>
              <button
                onClick={() => setActiveTab('companies')}
                className={`px-6 py-3 rounded-xl font-medium transition-colors ${
                  activeTab === 'companies' 
                    ? 'bg-red-50 text-red-700 border border-red-200' 
                    : 'text-gray-600 hover:text-gray-800'
                }`}
              >
                Entreprises ({companies.length})
              </button>
              <button
                onClick={() => setActiveTab('system')}
                className={`px-6 py-3 rounded-xl font-medium transition-colors ${
                  activeTab === 'system' 
                    ? 'bg-red-50 text-red-700 border border-red-200' 
                    : 'text-gray-600 hover:text-gray-800'
                }`}
              >
                Système
              </button>
            </div>
          </div>

          <div className="p-6">
            {/* Users Tab */}
            {activeTab === 'users' && (
              <div className="space-y-4">
                <h3 className="text-lg font-semibold text-gray-900">Gestion des Utilisateurs</h3>
                <div className="flex flex-col md:flex-row md:items-center md:space-x-3 space-y-3 md:space-y-0 mb-4">
                  <Input
                    placeholder="Rechercher (email, nom, entreprise)"
                    value={searchTerm}
                    onChange={(e) => setSearchTerm(e.target.value)}
                    className="md:w-1/3"
                  />
                  <select
                    value={roleFilter}
                    onChange={(e) => setRoleFilter(e.target.value)}
                    className="border border-gray-300 rounded-lg px-3 py-2 text-sm"
                  >
                    <option value="ALL">Tous les rôles</option>
                    <option value="ADMIN">Admin</option>
                    <option value="BUREAU">Bureau</option>
                    <option value="TECHNICIEN">Technicien</option>
                  </select>
                  <select
                    value={companyFilter}
                    onChange={(e) => setCompanyFilter(e.target.value)}
                    className="border border-gray-300 rounded-lg px-3 py-2 text-sm"
                  >
                    <option value="ALL">Toutes les entreprises</option>
                    {companies.map(c => (
                      <option key={c.id} value={c.id}>{c.nom || c.id}</option>
                    ))}
                    <option value="NONE">Sans entreprise</option>
                  </select>
                </div>
                {filteredUsers.length === 0 ? (
                  <div className="p-6 text-center text-sm text-gray-500 bg-gray-50 rounded-xl">
                    Aucun utilisateur ne correspond aux filtres sélectionnés.
                  </div>
                ) : (
                  filteredUsers.map(user => (
                    <div key={user.id} className="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
                      <div className="flex items-center space-x-4">
                        <div className="w-10 h-10 bg-red-100 rounded-xl flex items-center justify-center">
                          <Users className="h-5 w-5 text-red-600" />
                        </div>
                        <div>
                          <h4 className="font-medium text-gray-900">{user.nom}</h4>
                          <p className="text-sm text-gray-600">{user.email}</p>
                          <div className="flex items-center space-x-2 mt-1">
                            <Badge className={`text-xs ${user.role === 'ADMIN' ? 'bg-red-100 text-red-700' : user.role === 'BUREAU' ? 'bg-blue-100 text-blue-700' : 'bg-green-100 text-green-700'}`}>
                              {user.role}
                            </Badge>
                            <Badge className={`text-xs ${user.status === 'ACTIVE' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                              {user.status}
                            </Badge>
                            <Badge className="text-xs bg-gray-100 text-gray-700">
                              {companyMap[user.company] || 'Sans entreprise'}
                            </Badge>
                          </div>
                        </div>
                      </div>
                      <div className="flex space-x-2">
                        <Button
                          size="sm"
                          onClick={() => toggleUserStatus(user.id)}
                          className={user.status === 'ACTIVE' ? 'bg-red-600 hover:bg-red-700 text-white' : 'bg-green-600 hover:bg-green-700 text-white'}
                        >
                          {user.status === 'ACTIVE' ? 'Suspendre' : 'Activer'}
                        </Button>
                        <Button size="sm" variant="outline">
                          Détails
                        </Button>
                      </div>
                    </div>
                  ))
                )}
              </div>
            )}

            {/* Companies Tab */}
            {activeTab === 'companies' && (
              <div className="space-y-4">
                <h3 className="text-lg font-semibold text-gray-900">Gestion des Entreprises</h3>
                <Input
                  placeholder="Filtrer par nom"
                  value={companySearch}
                  onChange={(e) => setCompanySearch(e.target.value)}
                  className="md:w-1/3"
                />
                <div className="grid gap-4">
                  {filteredCompanies.length === 0 ? (
                    <div className="p-6 text-center text-sm text-gray-500 bg-gray-50 rounded-xl">
                      Aucune entreprise ne correspond aux filtres sélectionnés.
                    </div>
                  ) : (
                    filteredCompanies.map(company => (
                      <div key={company.id} className="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
                        <div className="flex items-center space-x-4">
                          <div className="w-10 h-10 bg-blue-100 rounded-xl flex items-center justify-center">
                            <Building className="h-5 w-5 text-blue-600" />
                          </div>
                          <div>
                            <h4 className="font-medium text-gray-900">{company.nom}</h4>
                            <div className="flex items-center space-x-4 text-sm text-gray-600 mt-1">
                              <span>{company.users_count} utilisateurs</span>
                              <span>{company.active_searches} recherches</span>
                              <span>{company.total_reports} rapports</span>
                            </div>
                            <Badge className="mt-1 bg-red-100 text-red-700 text-xs">
                              {company.subscription}
                            </Badge>
                          </div>
                        </div>
                        <div className="flex space-x-2">
                          <Button size="sm" variant="outline" onClick={() => navigate(`/statistiques?company=${company.id}`)}>
                            Statistiques
                          </Button>
                          <Button
                            size="sm"
                            onClick={() => deleteCompany(company.id)}
                            className="bg-red-600 hover:bg-red-700 text-white"
                          >
                            <Trash2 className="h-4 w-4" />
                          </Button>
                        </div>
                      </div>
                    ))
                  )}
                </div>
              </div>
            )}

            {/* System Tab */}
            {activeTab === 'system' && (
              <div className="space-y-6">
                {/* Panneau Connexions - réservé au fondateur (affiché ici car l'accès à ce layout est déjà restreint) */}
                <ConnectionView />

                {/* Outils système additionnels */}
                <div className="space-y-6">
                  <h3 className="text-lg font-semibold text-gray-900">Administration Système</h3>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div className="space-y-4">
                      <h4 className="font-medium text-gray-900">Actions Système</h4>
                      <Button className="w-full bg-black hover:bg-red-800 text-white">
                        <Download className="h-4 w-4 mr-2" />
                        Exporter toutes les données
                      </Button>
                      <Button className="w-full bg-zinc-800 hover:bg-zinc-900 text-white">
                        <Settings className="h-4 w-4 mr-2" />
                        Maintenance système
                      </Button>
                      <Button className="w-full bg-red-600 hover:bg-red-700 text-white">
                        <AlertTriangle className="h-4 w-4 mr-2" />
                        Redémarrer serveur
                      </Button>
                    </div>
                    
                    <div className="space-y-4">
                      <h4 className="font-medium text-gray-900">Logs Système</h4>
                      <div className="bg-black text-green-400 p-4 rounded-xl font-mono text-sm max-h-64 overflow-y-auto">
                        <div>[2024-01-20 10:30:25] INFO: Système démarré</div>
                        <div>[2024-01-20 10:31:10] INFO: Base de données connectée</div>
                        <div>[2024-01-20 10:32:00] INFO: {systemStats.total_users} utilisateurs actifs</div>
                        <div>[2024-01-20 10:32:30] INFO: Sauvegarde automatique effectuée</div>
                        <div>[2024-01-20 10:33:15] INFO: Uptime: {systemStats.server_uptime}</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            )}
          </div>
        </div>
      </main>
    </div>
  );
};

// ============================================================================
// INVOICE CREATE FORM - Formulaire création facture électronique
// ============================================================================

const InvoiceCreateForm = ({ onBack, onCreated }) => {
  const [clients, setClients] = useState([]);
  const [loading, setLoading] = useState(false);
  const [formData, setFormData] = useState({
    customer_id: '',
    customer_name: '',
    siren_client: '',
    address_billing: '',
    address_delivery: '',
    invoice_date: new Date().toISOString().split('T')[0],
    due_date: '',
    payment_terms: '30 jours',
    payment_method: 'virement',
    notes: '',
    lines: [
      { line_number: 1, designation: '', quantity: 1, unit_price_ht: 0, tva_rate: 20 }
    ]
  });

  // Charger les clients
  useEffect(() => {
    loadClients();
    // Auto-remplir échéance (+30 jours)
    const dueDate = new Date();
    dueDate.setDate(dueDate.getDate() + 30);
    setFormData(prev => ({ ...prev, due_date: dueDate.toISOString().split('T')[0] }));
  }, []);

  const loadClients = async () => {
    try {
      const response = await axios.get(`${API}/clients`, {
        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
      });
      setClients(response.data || []);
    } catch (error) {
      console.error('Erreur chargement clients:', error);
    }
  };

  // Sélection client
  const handleClientChange = (clientId) => {
    const client = clients.find(c => c.id === clientId);
    if (client) {
      setFormData(prev => ({
        ...prev,
        customer_id: clientId,
        customer_name: client.name,
        siren_client: client.siren || '',
        address_billing: `${client.address || ''}, ${client.postal_code || ''} ${client.city || ''}`.trim(),
        address_delivery: ''
      }));
    }
  };

  // Ajouter ligne
  const addLine = () => {
    setFormData(prev => ({
      ...prev,
      lines: [...prev.lines, {
        line_number: prev.lines.length + 1,
        designation: '',
        quantity: 1,
        unit_price_ht: 0,
        tva_rate: 20
      }]
    }));
  };

  // Supprimer ligne
  const removeLine = (index) => {
    if (formData.lines.length === 1) return;
    setFormData(prev => ({
      ...prev,
      lines: prev.lines.filter((_, i) => i !== index).map((line, i) => ({
        ...line,
        line_number: i + 1
      }))
    }));
  };

  // Modifier ligne
  const updateLine = (index, field, value) => {
    setFormData(prev => ({
      ...prev,
      lines: prev.lines.map((line, i) => 
        i === index ? { ...line, [field]: value } : line
      )
    }));
  };

  // Calculer totaux
  const calculateTotals = () => {
    let totalHT = 0;
    const tvaByRate = {};

    formData.lines.forEach(line => {
      const lineTotal = (parseFloat(line.quantity) || 0) * (parseFloat(line.unit_price_ht) || 0);
      totalHT += lineTotal;

      const tvaAmount = lineTotal * (parseFloat(line.tva_rate) / 100);
      if (!tvaByRate[line.tva_rate]) {
        tvaByRate[line.tva_rate] = 0;
      }
      tvaByRate[line.tva_rate] += tvaAmount;
    });

    const totalTVA = Object.values(tvaByRate).reduce((sum, tva) => sum + tva, 0);
    const totalTTC = totalHT + totalTVA;

    return {
      totalHT: totalHT.toFixed(2),
      totalTVA: totalTVA.toFixed(2),
      totalTTC: totalTTC.toFixed(2),
      tvaByRate: Object.entries(tvaByRate).map(([rate, amount]) => ({
        rate: parseFloat(rate),
        amount: amount.toFixed(2)
      })).sort((a, b) => b.rate - a.rate)
    };
  };

  // Soumettre facture
  const handleSubmit = async () => {
    // Validations
    if (!formData.customer_id) {
      alert('❌ Veuillez sélectionner un client');
      return;
    }
    if (!formData.siren_client || formData.siren_client.length !== 9) {
      alert('❌ SIREN client obligatoire (9 chiffres)');
      return;
    }
    if (formData.lines.some(l => !l.designation || l.unit_price_ht <= 0)) {
      alert('❌ Toutes les lignes doivent avoir une désignation et un prix');
      return;
    }

    try {
      setLoading(true);
      
      const totals = calculateTotals();
      const invoiceData = {
        ...formData,
        total_ht: parseFloat(totals.totalHT),
        total_tva: parseFloat(totals.totalTVA),
        total_ttc: parseFloat(totals.totalTTC),
        format: 'pdf', // Commencer par PDF simple
        lines: formData.lines.map((line, i) => ({
          ...line,
          line_number: i + 1,
          quantity: parseFloat(line.quantity),
          unit_price_ht: parseFloat(line.unit_price_ht),
          tva_rate: parseFloat(line.tva_rate),
          tva_amount: (parseFloat(line.quantity) * parseFloat(line.unit_price_ht) * parseFloat(line.tva_rate) / 100).toFixed(2),
          total_ht: (parseFloat(line.quantity) * parseFloat(line.unit_price_ht)).toFixed(2),
          total_ttc: ((parseFloat(line.quantity) * parseFloat(line.unit_price_ht)) * (1 + parseFloat(line.tva_rate) / 100)).toFixed(2)
        }))
      };

      await axios.post(`${API}/invoices/electronic`, invoiceData, {
        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
      });

      alert('✅ Facture créée avec succès !');
      onCreated();
      onBack();
    } catch (error) {
      console.error('Erreur création facture:', error);
      alert('❌ Erreur lors de la création de la facture');
    } finally {
      setLoading(false);
    }
  };

  const totals = calculateTotals();

  return (
    <div>
      {/* Header */}
      <div className="flex items-center gap-4 mb-6">
        <button onClick={onBack} className="p-2 hover:bg-gray-100 rounded-lg transition-colors">
          <ArrowLeft className="h-6 w-6 text-gray-700" />
        </button>
        <div>
          <h2 className="text-2xl font-bold text-gray-900">Nouvelle facture électronique</h2>
          <p className="text-gray-600 mt-1">Conforme Factur-X • SIREN obligatoire</p>
        </div>
      </div>

      <div className="space-y-6">
        {/* Informations client */}
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <User className="h-5 w-5 text-indigo-600" />
              Informations client
            </CardTitle>
          </CardHeader>
          <CardContent className="space-y-4">
            {/* Sélection client */}
            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">Client *</label>
              <select
                value={formData.customer_id}
                onChange={(e) => handleClientChange(e.target.value)}
                className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-indigo-400 focus:outline-none"
              >
                <option value="">-- Sélectionner un client --</option>
                {clients.map((client) => (
                  <option key={client.id} value={client.id}>
                    {client.name} {client.siren ? `(SIREN: ${client.siren})` : ''}
                  </option>
                ))}
              </select>
            </div>

            {/* SIREN obligatoire */}
            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">
                SIREN client * <span className="text-red-500">(9 chiffres obligatoires)</span>
              </label>
              <input
                type="text"
                maxLength="9"
                value={formData.siren_client}
                onChange={(e) => setFormData({ ...formData, siren_client: e.target.value.replace(/\D/g, '') })}
                placeholder="123456789"
                className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-indigo-400 focus:outline-none"
              />
            </div>

            {/* Adresse facturation */}
            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">Adresse de facturation *</label>
              <textarea
                value={formData.address_billing}
                onChange={(e) => setFormData({ ...formData, address_billing: e.target.value })}
                rows="2"
                className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-indigo-400 focus:outline-none"
              />
            </div>

            {/* Adresse livraison (optionnelle) */}
            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">Adresse de livraison (si différente)</label>
              <textarea
                value={formData.address_delivery}
                onChange={(e) => setFormData({ ...formData, address_delivery: e.target.value })}
                rows="2"
                placeholder="Laisser vide si identique à l'adresse de facturation"
                className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-indigo-400 focus:outline-none"
              />
            </div>
          </CardContent>
        </Card>

        {/* Dates et paiement */}
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <Calendar className="h-5 w-5 text-indigo-600" />
              Dates et conditions de paiement
            </CardTitle>
          </CardHeader>
          <CardContent className="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">Date facture *</label>
              <input
                type="date"
                value={formData.invoice_date}
                onChange={(e) => setFormData({ ...formData, invoice_date: e.target.value })}
                className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-indigo-400 focus:outline-none"
              />
            </div>
            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">Date échéance *</label>
              <input
                type="date"
                value={formData.due_date}
                onChange={(e) => setFormData({ ...formData, due_date: e.target.value })}
                className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-indigo-400 focus:outline-none"
              />
            </div>
            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">Conditions paiement</label>
              <select
                value={formData.payment_terms}
                onChange={(e) => setFormData({ ...formData, payment_terms: e.target.value })}
                className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-indigo-400 focus:outline-none"
              >
                <option value="Comptant">Comptant</option>
                <option value="15 jours">15 jours</option>
                <option value="30 jours">30 jours</option>
                <option value="45 jours">45 jours</option>
                <option value="60 jours">60 jours</option>
              </select>
            </div>
          </CardContent>
        </Card>

        {/* Lignes de facturation */}
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center justify-between">
              <div className="flex items-center gap-2">
                <List className="h-5 w-5 text-indigo-600" />
                Lignes de facturation
              </div>
              <Button onClick={addLine} variant="outline" size="sm">
                <Plus className="h-4 w-4 mr-2" />
                Ajouter ligne
              </Button>
            </CardTitle>
          </CardHeader>
          <CardContent>
            {/* En-têtes colonnes */}
            <div className="grid grid-cols-12 gap-3 mb-3 text-sm font-semibold text-gray-700 px-2">
              <div className="col-span-4">Désignation</div>
              <div className="col-span-2">Quantité</div>
              <div className="col-span-2">Prix HT</div>
              <div className="col-span-2">TVA</div>
              <div className="col-span-2 text-right">Total HT</div>
            </div>

            {/* Lignes */}
            <div className="space-y-3">
              {formData.lines.map((line, index) => {
                const lineTotal = (parseFloat(line.quantity) || 0) * (parseFloat(line.unit_price_ht) || 0);
                return (
                  <div key={index} className="grid grid-cols-12 gap-3 items-center bg-gray-50 p-3 rounded-xl">
                    <div className="col-span-4">
                      <input
                        type="text"
                        value={line.designation}
                        onChange={(e) => updateLine(index, 'designation', e.target.value)}
                        placeholder="Description de la ligne"
                        className="w-full px-3 py-2 border-2 border-gray-200 rounded-xl focus:border-indigo-400 focus:outline-none"
                      />
                    </div>
                    <div className="col-span-2">
                      <input
                        type="number"
                        step="0.01"
                        value={line.quantity}
                        onChange={(e) => updateLine(index, 'quantity', e.target.value)}
                        className="w-full px-3 py-2 border-2 border-gray-200 rounded-xl focus:border-indigo-400 focus:outline-none"
                      />
                    </div>
                    <div className="col-span-2">
                      <input
                        type="number"
                        step="0.01"
                        value={line.unit_price_ht}
                        onChange={(e) => updateLine(index, 'unit_price_ht', e.target.value)}
                        placeholder="0.00"
                        className="w-full px-3 py-2 border-2 border-gray-200 rounded-xl focus:border-indigo-400 focus:outline-none"
                      />
                    </div>
                    <div className="col-span-2">
                      <select
                        value={line.tva_rate}
                        onChange={(e) => updateLine(index, 'tva_rate', parseFloat(e.target.value))}
                        className="w-full px-3 py-2 border-2 border-gray-200 rounded-xl focus:border-indigo-400 focus:outline-none"
                      >
                        <option value={20}>20%</option>
                        <option value={10}>10%</option>
                        <option value={5.5}>5,5%</option>
                        <option value={0}>0%</option>
                      </select>
                    </div>
                    <div className="col-span-1 text-right font-semibold text-gray-900">
                      {lineTotal.toFixed(2)}€
                    </div>
                    <div className="col-span-1 text-center">
                      {formData.lines.length > 1 && (
                        <button
                          onClick={() => removeLine(index)}
                          className="p-2 hover:bg-red-100 rounded-lg transition-colors text-red-600"
                        >
                          <Trash2 className="h-4 w-4" />
                        </button>
                      )}
                    </div>
                  </div>
                );
              })}
            </div>

            {/* Totaux */}
            <div className="mt-6 pt-6 border-t-2 border-gray-200">
              <div className="max-w-md ml-auto space-y-3">
                <div className="flex justify-between items-center text-lg">
                  <span className="font-semibold text-gray-700">Total HT</span>
                  <span className="font-bold text-gray-900">{totals.totalHT}€</span>
                </div>
                
                {/* Détail TVA par taux */}
                {totals.tvaByRate.map((tva) => (
                  <div key={tva.rate} className="flex justify-between items-center text-sm">
                    <span className="text-gray-600">TVA {tva.rate}%</span>
                    <span className="font-semibold text-gray-900">{tva.amount}€</span>
                  </div>
                ))}
                
                <div className="flex justify-between items-center text-lg pt-3 border-t border-gray-200">
                  <span className="font-semibold text-gray-700">Total TVA</span>
                  <span className="font-bold text-gray-900">{totals.totalTVA}€</span>
                </div>
                
                <div className="flex justify-between items-center text-2xl pt-3 border-t-2 border-gray-300">
                  <span className="font-bold text-gray-900">Total TTC</span>
                  <span className="font-bold text-indigo-600">{totals.totalTTC}€</span>
                </div>
              </div>
            </div>
          </CardContent>
        </Card>

        {/* Notes */}
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <FileText className="h-5 w-5 text-indigo-600" />
              Notes et mentions
            </CardTitle>
          </CardHeader>
          <CardContent>
            <textarea
              value={formData.notes}
              onChange={(e) => setFormData({ ...formData, notes: e.target.value })}
              rows="3"
              placeholder="Notes complémentaires, conditions particulières..."
              className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-indigo-400 focus:outline-none"
            />
          </CardContent>
        </Card>

        {/* Actions */}
        <div className="flex gap-4 justify-end">
          <Button onClick={onBack} variant="outline" disabled={loading}>
            Annuler
          </Button>
          <Button
            onClick={handleSubmit}
            disabled={loading}
            className="bg-gradient-to-r from-indigo-600 to-purple-600 text-white hover:from-indigo-700 hover:to-purple-700"
          >
            {loading ? (
              <>
                <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                Création...
              </>
            ) : (
              <>
                <Save className="h-4 w-4 mr-2" />
                Créer la facture
              </>
            )}
          </Button>
        </div>
      </div>
    </div>
  );
};

// ============================================================================
// MODULES COMPLÉMENTAIRES - Réception, E-Reporting, Archivage
// ============================================================================

// Module 1: Réception de factures
const ReceivedInvoicesModule = () => {
  const [receivedInvoices, setReceivedInvoices] = useState([]);
  const [loading, setLoading] = useState(false);
  const [showUploadForm, setShowUploadForm] = useState(false);
  const [uploadData, setUploadData] = useState({
    file: null,
    supplier_name: '',
    supplier_siren: '',
    invoice_number: '',
    invoice_date: new Date().toISOString().split('T')[0],
    due_date: '',
    total_ht: '',
    total_tva: '',
    total_ttc: '',
    format_type: 'pdf-simple',
    notes: ''
  });

  useEffect(() => {
    if (!showUploadForm) {
      loadReceivedInvoices();
    }
  }, [showUploadForm]);

  const loadReceivedInvoices = async () => {
    setLoading(true);
    try {
      const response = await axios.get(`${API}/invoices/received`, {
        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
      });
      setReceivedInvoices(response.data || []);
    } catch (error) {
      console.error('Erreur chargement factures reçues:', error);
    } finally {
      setLoading(false);
    }
  };

  const handleFileChange = (e) => {
    const file = e.target.files[0];
    if (file) {
      setUploadData({ ...uploadData, file });
    }
  };

  const handleUpload = async (e) => {
    e.preventDefault();
    if (!uploadData.file) {
      alert('Veuillez sélectionner un fichier');
      return;
    }
    setLoading(true);
    try {
      const formData = new FormData();
      formData.append('file', uploadData.file);
      Object.keys(uploadData).forEach(key => {
        if (key !== 'file' && uploadData[key]) {
          formData.append(key, uploadData[key]);
        }
      });

      await axios.post(`${API}/invoices/received`, formData, {
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`,
          'Content-Type': 'multipart/form-data'
        }
      });

      alert('✅ Facture importée !');
      setShowUploadForm(false);
      setUploadData({
        file: null,
        supplier_name: '',
        supplier_siren: '',
        invoice_number: '',
        invoice_date: new Date().toISOString().split('T')[0],
        due_date: '',
        total_ht: '',
        total_tva: '',
        total_ttc: '',
        format_type: 'pdf-simple',
        notes: ''
      });
    } catch (error) {
      console.error('Erreur upload:', error);
      alert('❌ Erreur upload');
    } finally {
      setLoading(false);
    }
  };

  const updateInvoiceStatus = async (invoiceId, newStatus) => {
    try {
      await axios.patch(
        `${API}/invoices/received/${invoiceId}/status`,
        { status: newStatus },
        { headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` } }
      );
      loadReceivedInvoices();
    } catch (error) {
      console.error('Erreur mise à jour statut:', error);
    }
  };

  if (showUploadForm) {
    return (
      <div>
        <button onClick={() => setShowUploadForm(false)} className="mb-6 flex items-center gap-2 text-gray-600 hover:text-gray-900">
          <ArrowLeft className="h-5 w-5" />Retour
        </button>
        <h2 className="text-2xl font-bold text-gray-900 mb-6">📤 Importer une facture reçue</h2>
        <form onSubmit={handleUpload} className="space-y-6">
          <Card>
            <CardContent className="space-y-4 pt-6">
              <input type="file" accept=".pdf,.xml" onChange={handleFileChange} className="w-full" required />
              <input type="text" placeholder="Nom fournisseur *" value={uploadData.supplier_name} onChange={(e) => setUploadData({ ...uploadData, supplier_name: e.target.value })} className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl" required />
              <input type="text" placeholder="SIREN (9 chiffres)" maxLength="9" value={uploadData.supplier_siren} onChange={(e) => setUploadData({ ...uploadData, supplier_siren: e.target.value.replace(/\D/g, '') })} className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl" />
              <input type="text" placeholder="N° Facture *" value={uploadData.invoice_number} onChange={(e) => setUploadData({ ...uploadData, invoice_number: e.target.value })} className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl" required />
              <div className="grid grid-cols-3 gap-4">
                <input type="number" step="0.01" placeholder="Total HT *" value={uploadData.total_ht} onChange={(e) => setUploadData({ ...uploadData, total_ht: e.target.value })} className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl" required />
                <input type="number" step="0.01" placeholder="Total TVA *" value={uploadData.total_tva} onChange={(e) => setUploadData({ ...uploadData, total_tva: e.target.value })} className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl" required />
                <input type="number" step="0.01" placeholder="Total TTC *" value={uploadData.total_ttc} onChange={(e) => setUploadData({ ...uploadData, total_ttc: e.target.value })} className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl" required />
              </div>
            </CardContent>
          </Card>
          <Button type="submit" disabled={loading} className="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white">
            {loading ? <Loader2 className="h-5 w-5 animate-spin" /> : '✅ Importer'}
          </Button>
        </form>
      </div>
    );
  }

  return (
    <div>
      <div className="flex justify-between mb-6">
        <div>
          <h2 className="text-2xl font-bold">📥 Factures reçues</h2>
          <p className="text-gray-600">Import et gestion des factures fournisseurs</p>
        </div>
        <Button onClick={() => setShowUploadForm(true)} className="bg-gradient-to-r from-indigo-600 to-purple-600 text-white">
          <Upload className="h-4 w-4 mr-2" />Importer
        </Button>
      </div>
      {loading ? <div className="text-center py-12"><Loader2 className="h-12 w-12 animate-spin mx-auto text-indigo-600" /></div> : 
      receivedInvoices.length === 0 ? <div className="text-center py-12 bg-gray-50 rounded-2xl"><Download className="h-16 w-16 mx-auto text-gray-300 mb-4" /><p className="text-gray-500">Aucune facture</p></div> :
      <div className="space-y-3">{receivedInvoices.map((inv) => (
        <div key={inv.id} className="p-4 border-2 rounded-xl">
          <div className="flex justify-between">
            <div><div className="font-bold">{inv.invoice_number}</div><div className="text-sm text-gray-500">{inv.supplier_name}</div></div>
            <div><div className="font-bold">{inv.total_ttc}€</div>
            <select value={inv.status} onChange={(e) => updateInvoiceStatus(inv.id, e.target.value)} className="mt-2 px-3 py-1 rounded-lg text-sm">
              <option value="received">📥 Reçue</option>
              <option value="processing">⏳ Traitement</option>
              <option value="validated">✅ Validée</option>
              <option value="rejected">❌ Rejetée</option>
              <option value="paid">💳 Payée</option>
            </select></div>
          </div>
        </div>
      ))}</div>}
    </div>
  );
};

// Module 2: E-Reporting
const EReportingModule = () => {
  const [declarations, setDeclarations] = useState([]);
  const [loading, setLoading] = useState(false);
  const [showCreateForm, setShowCreateForm] = useState(false);
  const [formData, setFormData] = useState({
    declaration_type: 'b2c',
    period_start: new Date().toISOString().split('T')[0],
    period_end: new Date().toISOString().split('T')[0],
    total_ht: '',
    total_tva: '',
    total_ttc: '',
    operations_count: '',
    notes: ''
  });

  useEffect(() => {
    if (!showCreateForm) {
      loadDeclarations();
    }
  }, [showCreateForm]);

  const loadDeclarations = async () => {
    setLoading(true);
    try {
      const response = await axios.get(`${API}/e-reporting`, {
        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
      });
      setDeclarations(response.data || []);
    } catch (error) {
      console.error('Erreur:', error);
    } finally {
      setLoading(false);
    }
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    setLoading(true);
    try {
      await axios.post(`${API}/e-reporting`, formData, {
        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
      });
      alert('✅ Déclaration créée !');
      setShowCreateForm(false);
    } catch (error) {
      alert('❌ Erreur');
    } finally {
      setLoading(false);
    }
  };

  const transmitDeclaration = async (id) => {
    if (!confirm('Transmettre au PDP ?')) return;
    try {
      await axios.patch(`${API}/e-reporting/${id}/transmit`, {}, {
        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
      });
      alert('✅ Transmise !');
      loadDeclarations();
    } catch (error) {
      alert('❌ Erreur');
    }
  };

  if (showCreateForm) {
    return (
      <div>
        <button onClick={() => setShowCreateForm(false)} className="mb-6 flex items-center gap-2 text-gray-600"><ArrowLeft className="h-5 w-5" />Retour</button>
        <h2 className="text-2xl font-bold mb-6">📊 Nouvelle déclaration</h2>
        <form onSubmit={handleSubmit} className="space-y-6">
          <Card>
            <CardContent className="space-y-4 pt-6">
              <select value={formData.declaration_type} onChange={(e) => setFormData({...formData, declaration_type: e.target.value})} className="w-full px-4 py-3 border-2 rounded-xl" required>
                <option value="b2c">B2C (Particuliers)</option>
                <option value="export">Export hors UE</option>
                <option value="intra-ue">Intra-UE</option>
              </select>
              <div className="grid grid-cols-3 gap-4">
                <input type="number" step="0.01" placeholder="Total HT *" value={formData.total_ht} onChange={(e) => setFormData({...formData, total_ht: e.target.value})} className="px-4 py-3 border-2 rounded-xl" required />
                <input type="number" step="0.01" placeholder="Total TVA *" value={formData.total_tva} onChange={(e) => setFormData({...formData, total_tva: e.target.value})} className="px-4 py-3 border-2 rounded-xl" required />
                <input type="number" step="0.01" placeholder="Total TTC *" value={formData.total_ttc} onChange={(e) => setFormData({...formData, total_ttc: e.target.value})} className="px-4 py-3 border-2 rounded-xl" required />
              </div>
              <input type="number" placeholder="Nb opérations *" value={formData.operations_count} onChange={(e) => setFormData({...formData, operations_count: e.target.value})} className="w-full px-4 py-3 border-2 rounded-xl" required />
            </CardContent>
          </Card>
          <Button type="submit" disabled={loading} className="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white">
            {loading ? <Loader2 className="h-5 w-5 animate-spin" /> : '✅ Créer'}
          </Button>
        </form>
      </div>
    );
  }

  return (
    <div>
      <div className="flex justify-between mb-6">
        <div><h2 className="text-2xl font-bold">📊 E-Reporting</h2><p className="text-gray-600">B2C, Export, Intra-UE</p></div>
        <Button onClick={() => setShowCreateForm(true)} className="bg-gradient-to-r from-indigo-600 to-purple-600 text-white"><Plus className="h-4 w-4 mr-2" />Nouvelle</Button>
      </div>
      {loading ? <div className="text-center py-12"><Loader2 className="h-12 w-12 animate-spin mx-auto" /></div> : 
      declarations.length === 0 ? <div className="text-center py-12 bg-gray-50 rounded-2xl"><BarChart3 className="h-16 w-16 mx-auto text-gray-300 mb-4" /><p className="text-gray-500">Aucune déclaration</p></div> :
      <div className="space-y-3">{declarations.map((d) => (
        <div key={d.id} className="p-4 border-2 rounded-xl">
          <div className="flex justify-between">
            <div><div className="font-bold">{d.declaration_type === 'b2c' ? '🛒 B2C' : d.declaration_type === 'export' ? '🌍 Export' : '🇪🇺 Intra-UE'}</div><div className="text-sm">{d.operations_count} ops</div></div>
            <div><div className="font-bold">{d.total_ttc}€</div>
            {d.status === 'draft' ? <Button onClick={() => transmitDeclaration(d.id)} size="sm" className="mt-2">📤 Transmettre</Button> : 
            <Badge className="mt-2">{d.status === 'transmitted' ? '📤 Transmise' : d.status === 'accepted' ? '✅ Acceptée' : '❌ Rejetée'}</Badge>}</div>
          </div>
        </div>
      ))}</div>}
    </div>
  );
};

// Module 3: Archivage
const ArchivesModule = () => {
  const [archives, setArchives] = useState([]);
  const [loading, setLoading] = useState(false);
  const [filterType, setFilterType] = useState('all');

  useEffect(() => {
    loadArchives();
  }, [filterType]);

  const loadArchives = async () => {
    setLoading(true);
    try {
      const params = filterType !== 'all' ? { document_type: filterType } : {};
      const response = await axios.get(`${API}/archives`, {
        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` },
        params
      });
      setArchives(response.data || []);
    } catch (error) {
      console.error('Erreur:', error);
    } finally {
      setLoading(false);
    }
  };

  const verifyIntegrity = async (id) => {
    try {
      const response = await axios.post(`${API}/archives/${id}/verify`, {}, {
        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
      });
      alert(response.data.integrity_status === 'valid' ? '✅ Archive valide' : '❌ Archive corrompue');
      loadArchives();
    } catch (error) {
      alert('❌ Erreur');
    }
  };

  return (
    <div>
      <div className="flex justify-between mb-6">
        <div><h2 className="text-2xl font-bold">🗄️ Archivage légal</h2><p className="text-gray-600">Conservation 10 ans</p></div>
        <div className="flex gap-2">
          <Button onClick={() => setFilterType('all')} variant={filterType === 'all' ? 'default' : 'outline'} size="sm">Tous</Button>
          <Button onClick={() => setFilterType('invoice-emitted')} variant={filterType === 'invoice-emitted' ? 'default' : 'outline'} size="sm">Émises</Button>
          <Button onClick={() => setFilterType('invoice-received')} variant={filterType === 'invoice-received' ? 'default' : 'outline'} size="sm">Reçues</Button>
        </div>
      </div>
      {loading ? <div className="text-center py-12"><Loader2 className="h-12 w-12 animate-spin mx-auto" /></div> : 
      archives.length === 0 ? <div className="text-center py-12 bg-gray-50 rounded-2xl"><Shield className="h-16 w-16 mx-auto text-gray-300 mb-4" /><p className="text-gray-500">Aucune archive</p></div> :
      <div className="space-y-3">{archives.map((a) => (
        <div key={a.id} className="p-4 border-2 rounded-xl">
          <div className="flex justify-between">
            <div><div className="font-bold">{a.document_number}</div><div className="text-sm text-gray-500">{a.party_name}</div></div>
            <div><div className="font-bold">{a.total_ttc}€</div>
            <Badge className={`mt-2 ${a.integrity_status === 'valid' ? 'bg-green-100 text-green-700' : a.integrity_status === 'corrupted' ? 'bg-red-100 text-red-700' : 'bg-gray-100'}`}>
              {a.integrity_status === 'valid' ? '✅ Valide' : a.integrity_status === 'corrupted' ? '❌ Corrompu' : '⏳ Non vérifié'}
            </Badge>
            <Button onClick={() => verifyIntegrity(a.id)} size="sm" variant="outline" className="mt-2 w-full">🔍 Vérifier</Button></div>
          </div>
        </div>
      ))}</div>}
    </div>
  );
};

// ============================================================================
// INVOICING MODULE - Facturation Électronique (Réforme 2026-2027)
// ============================================================================

const InvoicingModule = () => {
  const [activeSubTab, setActiveSubTab] = useState('emit'); // emit, receive, reporting, archive
  const [invoices, setInvoices] = useState([]);
  const [loading, setLoading] = useState(false);
  const [showCreateForm, setShowCreateForm] = useState(false);

  // Charger les factures
  useEffect(() => {
    if (activeSubTab === 'emit') {
      loadInvoices();
    }
  }, [activeSubTab]);

  const loadInvoices = async () => {
    try {
      setLoading(true);
      const response = await axios.get(`${API}/invoices/electronic`, {
        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
      });
      setInvoices(response.data || []);
    } catch (error) {
      console.error('Erreur chargement factures:', error);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 p-6">
      {/* Header */}
      <div className="mb-8">
        <div className="flex items-center gap-3 mb-3">
          <FileText className="h-10 w-10 text-indigo-600" />
          <div>
            <h1 className="text-4xl font-bold text-gray-900">Facturation Électronique</h1>
            <p className="text-gray-600 mt-1">Conforme réforme DGFiP 2026-2027 • Format Factur-X</p>
          </div>
        </div>
        
        {/* Bannière conformité */}
        <div className="bg-gradient-to-r from-green-500 to-emerald-600 text-white p-4 rounded-2xl shadow-lg">
          <div className="flex items-center gap-3">
            <CheckCircle className="h-6 w-6" />
            <div>
              <p className="font-semibold">✅ Module conforme loi française</p>
              <p className="text-sm text-white/90">Réception obligatoire : 1er sept. 2026 • Émission : 1er sept. 2026 (ETI) / 2027 (PME/TPE)</p>
            </div>
          </div>
        </div>
      </div>

      {/* Sous-onglets */}
      <div className="mb-6">
        <div className="flex gap-2 bg-white p-2 rounded-2xl shadow-md border border-gray-200 overflow-x-auto">
          <button
            onClick={() => setActiveSubTab('emit')}
            className={`px-6 py-3 rounded-xl font-medium transition-all ${
              activeSubTab === 'emit'
                ? 'bg-gradient-to-r from-indigo-600 to-purple-600 text-white shadow-lg'
                : 'text-gray-600 hover:bg-gray-100'
            }`}
          >
            📤 Émettre
          </button>
          <button
            onClick={() => setActiveSubTab('receive')}
            className={`px-6 py-3 rounded-xl font-medium transition-all ${
              activeSubTab === 'receive'
                ? 'bg-gradient-to-r from-indigo-600 to-purple-600 text-white shadow-lg'
                : 'text-gray-600 hover:bg-gray-100'
            }`}
          >
            📥 Recevoir
          </button>
          <button
            onClick={() => setActiveSubTab('reporting')}
            className={`px-6 py-3 rounded-xl font-medium transition-all ${
              activeSubTab === 'reporting'
                ? 'bg-gradient-to-r from-indigo-600 to-purple-600 text-white shadow-lg'
                : 'text-gray-600 hover:bg-gray-100'
            }`}
          >
            📊 E-Reporting
          </button>
          <button
            onClick={() => setActiveSubTab('archive')}
            className={`px-6 py-3 rounded-xl font-medium transition-all ${
              activeSubTab === 'archive'
                ? 'bg-gradient-to-r from-indigo-600 to-purple-600 text-white shadow-lg'
                : 'text-gray-600 hover:bg-gray-100'
            }`}
          >
            🗄️ Archivage
          </button>
        </div>
      </div>

      {/* Contenu selon sous-onglet */}
      <div className="bg-white rounded-3xl shadow-2xl p-8 border border-gray-100">
        {activeSubTab === 'emit' && !showCreateForm && (
          <div>
            <div className="flex items-center justify-between mb-6">
              <div>
                <h2 className="text-2xl font-bold text-gray-900">📤 Factures émises</h2>
                <p className="text-gray-600 mt-1">Gérez vos factures électroniques conformes Factur-X</p>
              </div>
              <Button
                onClick={() => setShowCreateForm(true)}
                className="bg-gradient-to-r from-indigo-600 to-purple-600 text-white hover:from-indigo-700 hover:to-purple-700"
              >
                <Plus className="h-4 w-4 mr-2" />
                Nouvelle Facture
              </Button>
            </div>

            {loading ? (
              <div className="text-center py-12">
                <Loader2 className="h-12 w-12 animate-spin mx-auto text-indigo-600" />
                <p className="text-gray-500 mt-4">Chargement des factures...</p>
              </div>
            ) : invoices.length === 0 ? (
              <div className="text-center py-12 bg-gray-50 rounded-2xl">
                <FileText className="h-16 w-16 mx-auto text-gray-300 mb-4" />
                <p className="text-gray-500 font-medium">Aucune facture émise</p>
                <p className="text-sm text-gray-400 mt-1">Cliquez sur "Nouvelle Facture" pour commencer</p>
              </div>
            ) : (
              <div className="space-y-3">
                {invoices.map((invoice) => (
                  <div key={invoice.id} className="p-4 border-2 border-gray-200 rounded-xl hover:border-indigo-300 transition-all cursor-pointer">
                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-4">
                        <div className="p-3 bg-indigo-100 rounded-lg">
                          <FileText className="h-6 w-6 text-indigo-600" />
                        </div>
                        <div>
                          <div className="font-semibold text-gray-900">{invoice.invoice_number}</div>
                          <div className="text-sm text-gray-500">{invoice.customer_name}</div>
                        </div>
                      </div>
                      <div className="flex items-center gap-6">
                        <div className="text-right">
                          <div className="font-bold text-gray-900">{invoice.total_ttc}€</div>
                          <div className="text-xs text-gray-500">{new Date(invoice.invoice_date).toLocaleDateString('fr-FR')}</div>
                        </div>
                        <Badge className={`
                          ${invoice.status_pdp === 'accepted' ? 'bg-green-100 text-green-700' : ''}
                          ${invoice.status_pdp === 'rejected' ? 'bg-red-100 text-red-700' : ''}
                          ${invoice.status_pdp === 'draft' ? 'bg-gray-100 text-gray-700' : ''}
                          ${invoice.status_pdp === 'transmitted' ? 'bg-blue-100 text-blue-700' : ''}
                        `}>
                          {invoice.status_pdp === 'accepted' && '✅ Acceptée'}
                          {invoice.status_pdp === 'rejected' && '❌ Rejetée'}
                          {invoice.status_pdp === 'draft' && '📝 Brouillon'}
                          {invoice.status_pdp === 'transmitted' && '📤 Envoyée'}
                        </Badge>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        )}

        {activeSubTab === 'emit' && showCreateForm && (
          <InvoiceCreateForm onBack={() => setShowCreateForm(false)} onCreated={loadInvoices} />
        )}

        {activeSubTab === 'receive' && (
          <ReceivedInvoicesModule />
        )}

        {activeSubTab === 'reporting' && (
          <EReportingModule />
        )}

        {activeSubTab === 'archive' && (
          <ArchivesModule />
        )}
      </div>

      {/* Informations complémentaires */}
      <div className="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
        <div className="bg-white p-6 rounded-2xl shadow-md border border-gray-200">
          <div className="flex items-center gap-3 mb-3">
            <CheckCircle className="h-8 w-8 text-green-500" />
            <h3 className="font-bold text-gray-900">Formats supportés</h3>
          </div>
          <ul className="text-sm text-gray-600 space-y-1">
            <li>• Factur-X (PDF + XML)</li>
            <li>• UBL XML (standard UE)</li>
            <li>• CII (Cross Industry Invoice)</li>
          </ul>
        </div>

        <div className="bg-white p-6 rounded-2xl shadow-md border border-gray-200">
          <div className="flex items-center gap-3 mb-3">
            <Globe className="h-8 w-8 text-blue-500" />
            <h3 className="font-bold text-gray-900">PDP Compatible</h3>
          </div>
          <ul className="text-sm text-gray-600 space-y-1">
            <li>• <span className="font-semibold text-blue-600">IOPOLE</span></li>
            <li>• Yooz</li>
            <li>• Jefacture</li>
            <li>• Pennylane</li>
            <li>• Sellsy / MyUnisoft</li>
          </ul>
        </div>

        <div className="bg-white p-6 rounded-2xl shadow-md border border-gray-200">
          <div className="flex items-center gap-3 mb-3">
            <Calendar className="h-8 w-8 text-orange-500" />
            <h3 className="font-bold text-gray-900">Deadlines légales</h3>
          </div>
          <ul className="text-sm text-gray-600 space-y-1">
            <li>• 📥 Réception : 01/09/2026</li>
            <li>• 📤 ETI : 01/09/2026</li>
            <li>• 📤 PME/TPE : 01/09/2027</li>
          </ul>
        </div>
      </div>
    </div>
  );
};

// ============================================================================
// COMPANY SETTINGS - Paramètres Entreprise
// ============================================================================

const CompanySettings = ({ onBack }) => {
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [companyInfo, setCompanyInfo] = useState({
    company_name: '',
    legal_form: '',
    address: '',
    postal_code: '',
    city: '',
    siret: '',
    siren: '',
    rcs_rm: '',
    logo_url: ''
  });
  const [logoFile, setLogoFile] = useState(null);
  const [logoPreview, setLogoPreview] = useState(null);

  const legalForms = [
    'Auto-entrepreneur / Micro-entreprise',
    'SASU',
    'SARL',
    'SAS',
    'EURL',
    'SNC',
    'Artisan',
    'Association',
    'Autre'
  ];

  useEffect(() => {
    loadCompanyInfo();
  }, []);

  const loadCompanyInfo = async () => {
    try {
      const response = await axios.get(`${API}/company-settings`, {
        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
      });
      if (response.data) {
        // S'assurer que tous les champs ont des valeurs (pas undefined)
        const data = {
          company_name: response.data.company_name || '',
          legal_form: response.data.legal_form || '',
          address: response.data.address || '',
          postal_code: response.data.postal_code || '',
          city: response.data.city || '',
          siret: response.data.siret || '',
          siren: response.data.siren || '',
          rcs_rm: response.data.rcs_rm || '',
          logo_url: response.data.logo_url || ''
        };
        setCompanyInfo(data);
        
        if (response.data.logo_url) {
          // Si l'URL du logo est relative, ajouter l'URL du backend
          const logoUrl = response.data.logo_url.startsWith('http') 
            ? response.data.logo_url 
            : `${API.replace('/api', '')}${response.data.logo_url}`;
          setLogoPreview(logoUrl);
        }
      }
    } catch (error) {
      console.log('Aucune info entreprise enregistrée');
    } finally {
      setLoading(false);
    }
  };

  const handleLogoChange = (e) => {
    const file = e.target.files[0];
    if (file) {
      setLogoFile(file);
      const reader = new FileReader();
      reader.onloadend = () => {
        setLogoPreview(reader.result);
      };
      reader.readAsDataURL(file);
    }
  };

  const handleSave = async () => {
    setSaving(true);
    try {
      // Si un logo est uploadé, l'envoyer d'abord
      let logoUrl = companyInfo.logo_url;
      if (logoFile) {
        const formData = new FormData();
        formData.append('logo', logoFile);
        
        const uploadResponse = await axios.post(`${API}/company-settings/logo`, formData, {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`,
            'Content-Type': 'multipart/form-data'
          }
        });
        logoUrl = uploadResponse.data.logo_url;
      }

      // Enregistrer les informations
      await axios.post(`${API}/company-settings`, {
        ...companyInfo,
        logo_url: logoUrl
      }, {
        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
      });

      alert('✅ Informations enregistrées avec succès !');
      
      // Réinitialiser le fichier logo et recharger
      setLogoFile(null);
      await loadCompanyInfo();
    } catch (error) {
      console.error('Erreur sauvegarde:', error);
      alert('❌ Erreur lors de la sauvegarde');
    } finally {
      setSaving(false);
    }
  };

  if (loading) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-indigo-50 to-purple-50 p-6 flex items-center justify-center">
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-indigo-50 to-purple-50 p-6">
      {/* Header */}
      <div className="mb-8 flex items-center gap-4">
        <button
          onClick={onBack}
          className="p-2 hover:bg-white/50 rounded-lg transition-colors"
        >
          <ArrowLeft className="h-6 w-6 text-gray-700" />
        </button>
        <div>
          <h1 className="text-3xl font-bold text-gray-900 flex items-center gap-3">
            <Settings className="h-8 w-8 text-indigo-600" />
            Paramètres Entreprise
          </h1>
          <p className="text-gray-600 mt-1">Informations légales pour vos documents</p>
        </div>
      </div>

      {/* Formulaire */}
      <div className="max-w-4xl mx-auto">
        <Card className="bg-white/90 backdrop-blur-xl rounded-3xl border-0 shadow-2xl">
          <CardHeader className="border-b border-gray-100 pb-6">
            <CardTitle className="text-xl font-semibold text-gray-900 flex items-center gap-2">
              <Building className="h-6 w-6 text-indigo-600" />
              Identité de l'entreprise
            </CardTitle>
            <p className="text-sm text-gray-500 mt-2">
              Ces informations apparaîtront sur vos devis et factures
            </p>
          </CardHeader>
          
          <CardContent className="pt-6 space-y-6">
            {/* Logo */}
            <div className="flex items-start gap-6 p-5 bg-gray-50 rounded-xl">
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-3">
                  Logo de l'entreprise
                </label>
                <div className="flex items-center gap-4">
                  {logoPreview ? (
                    <div className="relative">
                      <img
                        src={logoPreview}
                        alt="Logo"
                        className="w-32 h-32 object-contain border-2 border-gray-200 rounded-lg bg-white"
                      />
                      <button
                        onClick={() => {
                          setLogoFile(null);
                          setLogoPreview(null);
                          setCompanyInfo(prev => ({ ...prev, logo_url: '' }));
                        }}
                        className="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 hover:bg-red-600"
                      >
                        <X className="h-4 w-4" />
                      </button>
                    </div>
                  ) : (
                    <div className="w-32 h-32 border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center bg-white">
                      <ImageIcon className="h-12 w-12 text-gray-300" />
                    </div>
                  )}
                  
                  <label className="cursor-pointer">
                    <input
                      type="file"
                      accept="image/*"
                      onChange={handleLogoChange}
                      className="hidden"
                    />
                    <div className="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors flex items-center gap-2">
                      <Upload className="h-4 w-4" />
                      Choisir un logo
                    </div>
                  </label>
                </div>
                <p className="text-xs text-gray-500 mt-2">Format: PNG, JPG (max 2 MB)</p>
              </div>
            </div>

            {/* Nom et forme juridique */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-2">
                  Nom de l'entreprise <span className="text-red-500">*</span>
                </label>
                <input
                  type="text"
                  value={companyInfo.company_name}
                  onChange={(e) => setCompanyInfo(prev => ({ ...prev, company_name: e.target.value }))}
                  className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-indigo-400 focus:outline-none"
                  placeholder="Ex: SkyApp Solutions"
                />
              </div>

              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-2">
                  Forme juridique <span className="text-red-500">*</span>
                </label>
                <select
                  value={companyInfo.legal_form}
                  onChange={(e) => setCompanyInfo(prev => ({ ...prev, legal_form: e.target.value }))}
                  className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-indigo-400 focus:outline-none bg-white"
                >
                  <option value="">Sélectionner...</option>
                  {legalForms.map((form) => (
                    <option key={form} value={form}>{form}</option>
                  ))}
                </select>
              </div>
            </div>

            {/* Adresse */}
            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">
                Adresse complète <span className="text-red-500">*</span>
              </label>
              <input
                type="text"
                value={companyInfo.address}
                onChange={(e) => setCompanyInfo(prev => ({ ...prev, address: e.target.value }))}
                className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-indigo-400 focus:outline-none"
                placeholder="Ex: 123 Rue de la République"
              />
            </div>

            {/* Code postal et ville */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-2">
                  Code postal <span className="text-red-500">*</span>
                </label>
                <input
                  type="text"
                  value={companyInfo.postal_code}
                  onChange={(e) => setCompanyInfo(prev => ({ ...prev, postal_code: e.target.value }))}
                  className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-indigo-400 focus:outline-none"
                  placeholder="Ex: 75001"
                />
              </div>

              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-2">
                  Ville <span className="text-red-500">*</span>
                </label>
                <input
                  type="text"
                  value={companyInfo.city}
                  onChange={(e) => setCompanyInfo(prev => ({ ...prev, city: e.target.value }))}
                  className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-indigo-400 focus:outline-none"
                  placeholder="Ex: Paris"
                />
              </div>
            </div>

            {/* SIRET et SIREN */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-2">
                  SIRET <span className="text-red-500">*</span>
                </label>
                <input
                  type="text"
                  value={companyInfo.siret}
                  onChange={(e) => setCompanyInfo(prev => ({ ...prev, siret: e.target.value }))}
                  className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-indigo-400 focus:outline-none"
                  placeholder="Ex: 123 456 789 00012"
                  maxLength={14}
                />
                <p className="text-xs text-gray-500 mt-1">14 chiffres</p>
              </div>

              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-2">
                  SIREN <span className="text-red-500">*</span>
                </label>
                <input
                  type="text"
                  value={companyInfo.siren}
                  onChange={(e) => setCompanyInfo(prev => ({ ...prev, siren: e.target.value }))}
                  className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-indigo-400 focus:outline-none"
                  placeholder="Ex: 123 456 789"
                  maxLength={9}
                />
                <p className="text-xs text-gray-500 mt-1">9 chiffres</p>
              </div>
            </div>

            {/* RCS/RM */}
            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">
                RCS ou RM (si artisan)
              </label>
              <input
                type="text"
                value={companyInfo.rcs_rm}
                onChange={(e) => setCompanyInfo(prev => ({ ...prev, rcs_rm: e.target.value }))}
                className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-indigo-400 focus:outline-none"
                placeholder="Ex: RCS Paris 123 456 789 ou RM 12345"
              />
              <p className="text-xs text-gray-500 mt-1">
                Registre du Commerce et des Sociétés ou Répertoire des Métiers
              </p>
            </div>

            {/* Boutons */}
            <div className="flex gap-4 pt-4">
              <Button
                onClick={handleSave}
                disabled={saving || !companyInfo.company_name || !companyInfo.legal_form}
                className="flex-1 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white rounded-xl py-3 text-lg font-semibold disabled:opacity-50"
              >
                {saving ? (
                  <>
                    <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-white mr-2"></div>
                    Enregistrement...
                  </>
                ) : (
                  <>
                    <Save className="h-5 w-5 mr-2" />
                    Enregistrer
                  </>
                )}
              </Button>
              
              <Button
                onClick={onBack}
                variant="outline"
                className="px-8 rounded-xl"
              >
                Retour
              </Button>
            </div>

            {/* Note admin */}
            <div className="mt-6 p-4 bg-amber-50 border-2 border-amber-200 rounded-xl">
              <p className="text-sm text-amber-800 flex items-center gap-2">
                <Shield className="h-4 w-4" />
                <span className="font-semibold">Note :</span> Ces paramètres ne peuvent être modifiés que par les administrateurs.
              </p>
            </div>
          </CardContent>
        </Card>
      </div>
    </div>
  );
};

// ============================================================================
// SEARCH DETAILS MODAL - Affichage détaillé d'une recherche
// ============================================================================

const SearchDetailsModal = ({ search, onClose }) => {
  const [photos, setPhotos] = useState([]);
  const [photosBySection, setPhotosBySection] = useState({});
  const [lightboxOpen, setLightboxOpen] = useState(false);
  const [currentPhotoIndex, setCurrentPhotoIndex] = useState(0);
  const [currentLightboxPhotos, setCurrentLightboxPhotos] = useState([]);

  useEffect(() => {
    loadPhotos();
  }, [search.id]);

  const loadPhotos = async () => {
    try {
      const response = await axios.get(`${API}/searches/${search.id}/photos`, {
        headers: { Authorization: `Bearer ${localStorage.getItem('token')}` }
      });
      const allPhotos = response.data || [];
      setPhotos(allPhotos);
      
      // Grouper les photos par section
      const grouped = {};
      allPhotos.forEach(photo => {
        if (!photo.is_profile && photo.section_id) {
          if (!grouped[photo.section_id]) {
            grouped[photo.section_id] = [];
          }
          grouped[photo.section_id].push(photo);
        }
      });
      setPhotosBySection(grouped);
      console.log('📸 Photos groupées par section:', grouped);
    } catch (error) {
      console.error('Erreur chargement photos:', error);
    }
  };

  const openLightbox = (index, photosArray) => {
    setCurrentPhotoIndex(index);
    setCurrentLightboxPhotos(photosArray);
    setLightboxOpen(true);
  };

  const closeLightbox = () => {
    setLightboxOpen(false);
  };

  const nextPhoto = () => {
    setCurrentPhotoIndex((prev) => (prev + 1) % currentLightboxPhotos.length);
  };

  const prevPhoto = () => {
    setCurrentPhotoIndex((prev) => (prev - 1 + currentLightboxPhotos.length) % currentLightboxPhotos.length);
  };

  // Parser les sections personnalisées depuis observations
  let parsedSections = [];
  console.log('🔍 [SearchDetailsModal] search.observations:', search.observations);
  if (search.observations) {
    try {
      const observationsData = typeof search.observations === 'string' 
        ? JSON.parse(search.observations) 
        : search.observations;
      
      console.log('📦 [SearchDetailsModal] observationsData:', observationsData);
      
      if (observationsData.customSections && Array.isArray(observationsData.customSections)) {
        parsedSections = observationsData.customSections;
        console.log('✅ [SearchDetailsModal] Sections personnalisées trouvées:', parsedSections.length, parsedSections);
      } else {
        console.log('⚠️ [SearchDetailsModal] Pas de customSections dans observationsData');
      }
    } catch (e) {
      console.error('❌ [SearchDetailsModal] Erreur parsing observations:', e);
    }
  }

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div className="bg-gradient-to-br from-gray-50 to-white rounded-2xl shadow-2xl w-full max-w-6xl h-[90vh] overflow-hidden flex flex-col">
        {/* Header avec thème SkyApp */}
        <div className="sticky top-0 bg-gradient-to-r from-gray-900 to-black text-white px-6 py-4 flex items-center justify-between z-10 shadow-lg border-b border-gray-800">
          <div className="flex items-center gap-3">
            <div className="w-10 h-10 bg-white bg-opacity-10 rounded-xl flex items-center justify-center border border-white border-opacity-20">
              <Search size={20} />
            </div>
            <div>
              <h2 className="text-lg font-bold">Détails de la recherche</h2>
              <p className="text-gray-400 text-xs mt-0.5">
                📅 {new Date(search.shared_at || search.created_at).toLocaleString('fr-FR')}
              </p>
            </div>
          </div>
          <button
            onClick={onClose}
            className="text-white hover:bg-white hover:bg-opacity-10 rounded-lg p-2 transition-colors"
            aria-label="Fermer"
          >
            <X size={20} />
          </button>
        </div>

        {/* Contenu avec sections organisées comme le formulaire */}
        <div className="flex-1 overflow-y-auto p-6 space-y-4">
          {/* Badges de statut */}
          <div className="flex items-center gap-2 flex-wrap">
            <span className={`text-xs font-medium px-3 py-1.5 rounded-lg ${
              search.search_type === 'TERRAIN' 
                ? 'bg-blue-100 text-blue-800' 
                : 'bg-orange-100 text-orange-800'
            }`}>
              {search.search_type === 'TERRAIN' ? '📍 Terrain' : '💧 Infiltration'}
            </span>
            <span className={`text-xs font-medium px-3 py-1.5 rounded-lg ${
              search.status === 'SHARED' ? 'bg-green-100 text-green-800' :
              search.status === 'ACTIVE' ? 'bg-blue-100 text-blue-800' :
              search.status === 'DRAFT' ? 'bg-purple-100 text-purple-800' :
              'bg-gray-100 text-gray-800'
            }`}>
              {search.status === 'SHARED' ? '✉️ Partagée' :
               search.status === 'ACTIVE' ? '🔵 Active' :
               search.status === 'DRAFT' ? '📝 Brouillon' :
               search.status}
            </span>
            {search.project_id && (
              <span className="text-xs font-medium px-3 py-1.5 rounded-lg bg-teal-100 text-teal-800">
                🎯 Convertie en projet
              </span>
            )}
          </div>

          {/* Section Informations Générales */}
          <div className="bg-white border border-gray-200 rounded-xl hover:border-gray-300 transition-all duration-200 hover:shadow-sm">
            <div className="flex items-center gap-3 p-4 border-b border-gray-100">
              <div className="w-10 h-10 bg-gray-900 rounded-lg flex items-center justify-center flex-shrink-0">
                <User className="h-5 w-5 text-white" />
              </div>
              <h3 className="text-lg font-medium text-gray-900">Informations Générales</h3>
            </div>
            
            <div className="p-4">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                {(search.nom || search.prenom) && (
                  <div>
                    <label className="text-xs font-medium text-gray-500 uppercase mb-1.5 block">Client</label>
                    <div className="bg-gray-50 rounded-lg p-3 border border-gray-200">
                      <p className="text-sm font-medium text-gray-900">
                        👤 {search.prenom} {search.nom}
                      </p>
                    </div>
                  </div>
                )}
                
                <div>
                  <label className="text-xs font-medium text-gray-500 uppercase mb-1.5 block flex items-center gap-1">
                    <MapPin size={12} /> Localisation
                  </label>
                  <div className="bg-gray-50 rounded-lg p-3 border border-gray-200">
                    <p className="text-sm font-medium text-gray-900">{search.location || 'Non spécifiée'}</p>
                    {(search.latitude && search.longitude) && (
                      <p className="text-xs text-gray-500 mt-1">
                        📍 {search.latitude.toFixed(6)}, {search.longitude.toFixed(6)}
                      </p>
                    )}
                  </div>
                </div>
              </div>
            </div>
          </div>

          {/* Section Description */}
          {search.description && cleanObservations(search.description) && (
            <div className="bg-white border border-gray-200 rounded-xl hover:border-gray-300 transition-all duration-200 hover:shadow-sm">
              <div className="flex items-center gap-3 p-4 border-b border-gray-100">
                <div className="w-10 h-10 bg-gray-900 rounded-lg flex items-center justify-center flex-shrink-0">
                  <FileText className="h-5 w-5 text-white" />
                </div>
                <h3 className="text-lg font-medium text-gray-900">Description de la recherche</h3>
              </div>
              
              <div className="p-4">
                <p className="text-sm text-gray-700 whitespace-pre-wrap leading-relaxed">{cleanObservations(search.description)}</p>
                
                {/* Photos de la section Description */}
                {photosBySection['description'] && photosBySection['description'].length > 0 && (
                  <div className="mt-4 pt-4 border-t border-gray-100">
                    <p className="text-xs font-medium text-gray-500 uppercase mb-2 flex items-center gap-1">
                      <Camera size={12} /> Photos ({photosBySection['description'].length})
                    </p>
                    <div className="grid grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-2">
                      {photosBySection['description'].map((photo, index) => (
                        <div
                          key={photo.filename || index}
                          className="group relative rounded-lg overflow-hidden cursor-pointer hover:shadow-lg transition-all duration-300 border border-gray-200 hover:border-gray-900"
                          onClick={() => openLightbox(index, photosBySection['description'])}
                          style={{ aspectRatio: '1/1' }}
                        >
                          <img
                            src={photo.url || `${SUPABASE_URL}/storage/v1/object/public/${photo.storage_path}`}
                            alt={`Photo ${index + 1}`}
                            className="w-full h-full object-cover group-hover:scale-110 transition-transform duration-300"
                          />
                          <div className="absolute inset-0 bg-gradient-to-t from-black/40 via-transparent to-transparent" />
                          <div className="absolute bottom-1 left-1">
                            <span className="text-white text-xs font-medium bg-black/60 px-1.5 py-0.5 rounded">#{index + 1}</span>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                )}
              </div>
            </div>
          )}

          {/* Section Observations */}
          {search.observations && cleanObservations(search.observations) && (
            <div className="bg-white border border-gray-200 rounded-xl hover:border-gray-300 transition-all duration-200 hover:shadow-sm">
              <div className="flex items-center gap-3 p-4 border-b border-gray-100">
                <div className="w-10 h-10 bg-gray-900 rounded-lg flex items-center justify-center flex-shrink-0">
                  <Eye className="h-5 w-5 text-white" />
                </div>
                <h3 className="text-lg font-medium text-gray-900">Observations et remarques</h3>
              </div>
              <p className="text-gray-700 whitespace-pre-wrap leading-relaxed">{cleanObservations(search.observations)}</p>
              
              {/* Photos de la section Observations */}
              {photosBySection['observations'] && photosBySection['observations'].length > 0 && (
                <div className="mt-4 pt-4 border-t border-amber-200">
                  <p className="text-sm font-semibold text-gray-600 mb-3 flex items-center gap-2">
                    <Camera size={14} /> Photos ({photosBySection['observations'].length})
                  </p>
                  <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                    {photosBySection['observations'].map((photo, index) => (
                      <div
                        key={photo.filename || index}
                        className="group relative rounded-lg overflow-hidden cursor-pointer hover:shadow-lg transition-all duration-300 border-2 border-amber-200 hover:border-amber-400"
                        onClick={() => openLightbox(index, photosBySection['observations'])}
                        style={{ aspectRatio: '1/1' }}
                      >
                        <img
                          src={photo.url || `${SUPABASE_URL}/storage/v1/object/public/${photo.storage_path}`}
                          alt={`Photo ${index + 1}`}
                          className="w-full h-full object-cover group-hover:scale-110 transition-transform duration-300"
                        />
                        <div className="absolute inset-0 bg-gradient-to-t from-black via-transparent to-transparent opacity-60" />
                        <div className="absolute bottom-2 left-2">
                          <span className="text-white text-xs font-bold bg-black bg-opacity-50 px-2 py-1 rounded-lg">#{index + 1}</span>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}
            </div>
          )}

          {/* Sections personnalisées avec style moderne */}
          {parsedSections.length > 0 && parsedSections.map((section, idx) => (
            <div key={idx} className="bg-white rounded-xl shadow-md p-6 border-2 border-purple-200">
              <div className="flex items-center gap-3 mb-4">
                <div className="w-10 h-10 bg-purple-600 rounded-lg flex items-center justify-center">
                  <Plus className="h-5 w-5 text-white" />
                </div>
                <h3 className="text-lg font-bold text-gray-900">{section.title}</h3>
              </div>
              <p className="text-gray-700 whitespace-pre-wrap leading-relaxed">{cleanObservations(section.value)}</p>
              
              {/* Photos de cette section personnalisée */}
              {photosBySection[section.id] && photosBySection[section.id].length > 0 && (
                <div className="mt-4 pt-4 border-t border-purple-200">
                  <p className="text-sm font-semibold text-gray-600 mb-3 flex items-center gap-2">
                    <Camera size={14} /> Photos ({photosBySection[section.id].length})
                  </p>
                  <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                    {photosBySection[section.id].map((photo, photoIndex) => (
                      <div
                        key={photo.filename || photoIndex}
                        className="group relative rounded-lg overflow-hidden cursor-pointer hover:shadow-lg transition-all duration-300 border-2 border-purple-200 hover:border-purple-400"
                        onClick={() => openLightbox(photoIndex, photosBySection[section.id])}
                        style={{ aspectRatio: '1/1' }}
                      >
                        <img
                          src={photo.url || `${SUPABASE_URL}/storage/v1/object/public/${photo.storage_path}`}
                          alt={`Photo ${photoIndex + 1}`}
                          className="w-full h-full object-cover group-hover:scale-110 transition-transform duration-300"
                        />
                        <div className="absolute inset-0 bg-gradient-to-t from-black via-transparent to-transparent opacity-60" />
                        <div className="absolute bottom-2 left-2">
                          <span className="text-white text-xs font-bold bg-black bg-opacity-50 px-2 py-1 rounded-lg">#{photoIndex + 1}</span>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}
            </div>
          ))}

          {/* Section Envoyé par avec style moderne */}
          <div className="bg-white rounded-xl shadow-md p-6 border-2 border-blue-200">
            <div className="flex items-center gap-3 mb-4">
              <div className="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center">
                <User className="h-5 w-5 text-white" />
              </div>
              <h3 className="text-lg font-bold text-gray-900">Envoyé par</h3>
            </div>
            {search.users ? (
              <div className="bg-blue-50 rounded-lg p-4 border border-blue-200">
                <p className="text-lg font-bold text-gray-900 flex items-center gap-2">
                  👷 {search.users.first_name} {search.users.last_name}
                </p>
                {search.users.email && !search.users.email.includes('@temp-skyapp.local') && (
                  <p className="text-sm text-gray-600 mt-2 flex items-center gap-2">
                    📧 {search.users.email}
                  </p>
                )}
              </div>
            ) : (
              <p className="text-gray-500 italic bg-gray-50 rounded-lg p-4">Technicien non identifié</p>
            )}
          </div>
        </div>

        {/* Footer avec bouton moderne */}
        <div className="sticky bottom-0 bg-white p-6 border-t-2 border-gray-200 shadow-lg">
          <button
            onClick={onClose}
            className="w-full bg-gradient-to-r from-gray-700 to-gray-900 text-white px-6 py-4 rounded-xl hover:from-gray-800 hover:to-black transition-all duration-300 font-bold text-lg shadow-lg hover:shadow-xl transform hover:scale-[1.02]"
          >
            Fermer
          </button>
        </div>
      </div>

      {/* Lightbox pour les photos */}
      {lightboxOpen && photos.length > 0 && (
        <div 
          className="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-[60]"
          onClick={(e) => {
            if (e.target === e.currentTarget) {
              closeLightbox();
            }
          }}
        >
          <button
            onClick={(e) => {
              e.stopPropagation();
              closeLightbox();
            }}
            className="absolute top-4 right-4 text-white hover:bg-white hover:bg-opacity-20 rounded-full p-2 transition-colors"
          >
            <X size={32} />
          </button>
          
          <button
            onClick={(e) => {
              e.stopPropagation();
              prevPhoto();
            }}
            className="absolute left-4 text-white hover:bg-white hover:bg-opacity-20 rounded-full p-3 transition-colors"
          >
            <ChevronLeft size={40} />
          </button>

          <div className="max-w-5xl max-h-[90vh] flex flex-col items-center" onClick={(e) => e.stopPropagation()}>
            <img
              src={currentLightboxPhotos[currentPhotoIndex]?.url || `${SUPABASE_URL}/storage/v1/object/public/${currentLightboxPhotos[currentPhotoIndex]?.storage_path}`}
              alt={`Photo ${currentPhotoIndex + 1}`}
              className="max-w-full max-h-[85vh] object-contain rounded-lg"
            />
            <p className="text-white mt-4 text-lg">
              {currentPhotoIndex + 1} / {currentLightboxPhotos.length}
            </p>
          </div>

          <button
            onClick={(e) => {
              e.stopPropagation();
              nextPhoto();
            }}
            className="absolute right-4 text-white hover:bg-white hover:bg-opacity-20 rounded-full p-3 transition-colors"
          >
            <ChevronRight size={40} />
          </button>
        </div>
      )}
    </div>
  );
};

// ============================================================================
// EDIT SEARCH MODAL - Modal d'édition complet avec photos
// ============================================================================

const EditSearchModal = ({ search, onSave, onClose }) => {
  const [formData, setFormData] = useState({
    location: search.location || '',
    description: search.description || '',
    observations: search.observations || '',
    client_id: search.client_id || null,
    nom: search.nom || '',
    prenom: search.prenom || '',
    search_type: search.search_type || 'TERRAIN'
  });
  
  // Sections avec leurs photos (style formulaire)
  const [sections, setSections] = useState([
    { 
      id: 'general_info', 
      title: 'Informations générales',
      icon: User,
      collapsed: false,
      hasPhotos: false,
      fields: [
        { id: 'nom', label: 'Nom', type: 'text', value: search.nom || '' },
        { id: 'prenom', label: 'Prénom', type: 'text', value: search.prenom || '' },
        { id: 'client_id', label: 'Client récurrent', type: 'select', value: search.client_id || '' },
        { id: 'adresse', label: 'Adresse', type: 'text', value: search.location || '', required: true }
      ]
    },
    { 
      id: 'description', 
      title: 'Description de la recherche',
      icon: FileText,
      collapsed: false,
      hasPhotos: true,
      photos: [],
      newPhotos: [],
      fields: [
        { id: 'description', label: 'Description', type: 'textarea', value: search.description || '', rows: 4 }
      ]
    },
    { 
      id: 'observations', 
      title: 'Observations et remarques',
      icon: Eye,
      collapsed: false,
      hasPhotos: true,
      photos: [],
      newPhotos: [],
      fields: [
        { id: 'observations', label: 'Observations', type: 'textarea', value: (() => {
          try {
            const data = JSON.parse(search.observations || '{}');
            return data.text || '';
          } catch (e) {
            return search.observations || '';
          }
        })(), rows: 3 }
      ]
    }
  ]);
  
  const [clients, setClients] = useState([]);
  const [profilePhoto, setProfilePhoto] = useState(null);
  const [profilePhotoPreview, setProfilePhotoPreview] = useState(null);
  const [photosToDelete, setPhotosToDelete] = useState([]);
  const [loading, setLoading] = useState(false);
  const [lightboxOpen, setLightboxOpen] = useState(false);
  const [lightboxImage, setLightboxImage] = useState(null);
  const [currentPhotoIndex, setCurrentPhotoIndex] = useState(0);
  const [currentSection, setCurrentSection] = useState(null);

  useEffect(() => {
    loadClients();
    loadPhotos();
  }, []);

  const loadClients = async () => {
    try {
      const response = await axios.get(`${API}/clients`, {
        headers: { Authorization: `Bearer ${localStorage.getItem('token')}` }
      });
      setClients(response.data || []);
    } catch (error) {
      console.error('Erreur chargement clients:', error);
    }
  };

  const loadPhotos = async () => {
    try {
      console.log('🔍 Chargement photos pour recherche:', search.id);
      const response = await axios.get(`${API}/searches/${search.id}/photos`, {
        headers: { Authorization: `Bearer ${localStorage.getItem('token')}` }
      });
      console.log('✅ Photos API response:', response.data);
      
      const allPhotos = response.data || [];
      
      // Photo de profil
      const profilePic = allPhotos.find(photo => photo.is_profile);
      if (profilePic) {
        setProfilePhotoPreview(profilePic.url || `${SUPABASE_URL}/storage/v1/object/public/${profilePic.storage_path}`);
      }
      
      // Organiser les photos par section
      setSections(prevSections => prevSections.map(section => {
        if (!section.hasPhotos) return section;
        
        const sectionPhotos = allPhotos.filter(photo => 
          !photo.is_profile && photo.section_id === section.id
        );
        
        return { ...section, photos: sectionPhotos, newPhotos: [] };
      }));
    } catch (error) {
      console.error('❌ Erreur chargement photos:', error);
    }
  };

  const handleFieldChange = (sectionId, fieldId, value) => {
    setSections(sections.map(s => {
      if (s.id === sectionId) {
        return {
          ...s,
          fields: s.fields.map(f => f.id === fieldId ? { ...f, value } : f)
        };
      }
      return s;
    }));
  };

  const toggleSection = (sectionId) => {
    setSections(sections.map(s => 
      s.id === sectionId ? { ...s, collapsed: !s.collapsed } : s
    ));
  };

  const handleProfilePhotoChange = (e) => {
    const file = e.target.files[0];
    if (file) {
      setProfilePhoto(file);
      setProfilePhotoPreview(URL.createObjectURL(file));
    }
  };

  const handlePhotoAdd = (sectionId, e) => {
    const files = Array.from(e.target.files);
    
    const photoUrls = files.map(file => ({
      file,
      url: URL.createObjectURL(file),
      isNew: true,
      section_id: sectionId
    }));
    
    setSections(sections.map(s => 
      s.id === sectionId 
        ? { ...s, newPhotos: [...(s.newPhotos || []), ...photoUrls] }
        : s
    ));
  };

  const handlePhotoDelete = (sectionId, photo, isNew) => {
    if (isNew) {
      // Supprimer une nouvelle photo pas encore uploadée
      URL.revokeObjectURL(photo.url);
      setSections(sections.map(s => 
        s.id === sectionId 
          ? { ...s, newPhotos: s.newPhotos.filter(p => p.url !== photo.url) }
          : s
      ));
    } else {
      // Marquer une photo existante pour suppression
      setPhotosToDelete([...photosToDelete, photo.filename || photo.storage_path]);
      setSections(sections.map(s => 
        s.id === sectionId 
          ? { ...s, photos: s.photos.filter(p => p !== photo) }
          : s
      ));
    }
  };

  const openLightbox = (sectionId, index) => {
    setCurrentSection(sectionId);
    setCurrentPhotoIndex(index);
    setLightboxOpen(true);
  };

  const closeLightbox = () => {
    setLightboxOpen(false);
    setCurrentSection(null);
  };

  const nextPhoto = () => {
    const section = sections.find(s => s.id === currentSection);
    if (!section) return;
    const totalPhotos = section.photos.length + section.newPhotos.length;
    setCurrentPhotoIndex((prev) => (prev + 1) % totalPhotos);
  };

  const prevPhoto = () => {
    const section = sections.find(s => s.id === currentSection);
    if (!section) return;
    const totalPhotos = section.photos.length + section.newPhotos.length;
    setCurrentPhotoIndex((prev) => (prev - 1 + totalPhotos) % totalPhotos);
  };

  const getCurrentPhoto = () => {
    const section = sections.find(s => s.id === currentSection);
    if (!section) return null;
    const allPhotos = [...section.photos, ...section.newPhotos];
    return allPhotos[currentPhotoIndex];
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    setLoading(true);
    
    try {
      // Construire les données depuis les sections
      const generalSection = sections.find(s => s.id === 'general_info');
      const descSection = sections.find(s => s.id === 'description');
      const obsSection = sections.find(s => s.id === 'observations');
      
      const updatedData = {
        nom: generalSection?.fields.find(f => f.id === 'nom')?.value || '',
        prenom: generalSection?.fields.find(f => f.id === 'prenom')?.value || '',
        client_id: generalSection?.fields.find(f => f.id === 'client_id')?.value || null,
        location: generalSection?.fields.find(f => f.id === 'adresse')?.value || '',
        description: descSection?.fields.find(f => f.id === 'description')?.value || '',
        observations: obsSection?.fields.find(f => f.id === 'observations')?.value || '',
        search_type: formData.search_type
      };

      // 1. Supprimer les photos marquées
      for (const photoPath of photosToDelete) {
        try {
          await axios.delete(`${API}/searches/${search.id}/photos/${photoPath}`, {
            headers: { Authorization: `Bearer ${localStorage.getItem('token')}` }
          });
        } catch (err) {
          console.error('Erreur suppression photo:', err);
        }
      }

      // 2. Upload photo de profil si nouvelle
      if (profilePhoto) {
        const formDataProfile = new FormData();
        formDataProfile.append('files', profilePhoto);
        formDataProfile.append('is_profile', 'true');
        formDataProfile.append('section_id', 'profile');

        await axios.post(`${API}/searches/${search.id}/photos`, formDataProfile, {
          headers: {
            Authorization: `Bearer ${localStorage.getItem('token')}`,
            'Content-Type': 'multipart/form-data'
          }
        });
      }

      // 3. Uploader les nouvelles photos par section
      for (const section of sections) {
        if (section.hasPhotos && section.newPhotos && section.newPhotos.length > 0) {
          const formDataPhotos = new FormData();
          section.newPhotos.forEach(photo => {
            formDataPhotos.append('files', photo.file);
          });
          formDataPhotos.append('section_id', section.id);

          await axios.post(`${API}/searches/${search.id}/photos`, formDataPhotos, {
            headers: {
              Authorization: `Bearer ${localStorage.getItem('token')}`,
              'Content-Type': 'multipart/form-data'
            }
          });
        }
      }

      // 4. Mettre à jour les données textuelles
      await onSave(search.id, updatedData);
      
      alert('✅ Recherche modifiée avec succès !');
      onClose();
    } catch (error) {
      console.error('Erreur sauvegarde:', error);
      alert('❌ Erreur lors de la sauvegarde: ' + (error.response?.data?.detail || error.message));
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
        {/* Header */}
        <div className="sticky top-0 bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-6 rounded-t-xl flex items-center justify-between z-10">
          <div>
            <h2 className="text-2xl font-bold flex items-center gap-2">
              <Edit2 size={28} />
              Modifier la recherche
            </h2>
            <p className="text-indigo-100 text-sm mt-1">Correction par le bureau</p>
          </div>
          <button
            onClick={onClose}
            className="text-white hover:bg-white hover:bg-opacity-20 rounded-full p-2 transition-colors"
          >
            <X size={24} />
          </button>
        </div>

        {/* Form */}
        <form onSubmit={handleSubmit} className="p-6 space-y-4">
          {/* Photo de profil */}
          <div className="bg-gradient-to-r from-purple-50 to-pink-50 border-2 border-purple-200 rounded-xl p-4">
            <h3 className="text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2">
              <User size={18} />
              Photo de profil (optionnelle)
            </h3>
            
            {profilePhotoPreview ? (
              <div className="relative w-24 h-24 rounded-lg overflow-hidden border-2 border-dashed border-gray-300 group">
                <img src={profilePhotoPreview} alt="Profil" className="w-full h-full object-cover" />
                <button
                  type="button"
                  onClick={() => { setProfilePhoto(null); setProfilePhotoPreview(null); }}
                  className="absolute inset-0 bg-black bg-opacity-50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center"
                >
                  <X size={24} className="text-white" />
                </button>
              </div>
            ) : (
              <div className="flex items-center gap-4">
                <div className="w-24 h-24 rounded-lg border-2 border-dashed border-gray-300 flex items-center justify-center bg-gray-50">
                  <User size={32} className="text-gray-400" />
                </div>
                <div>
                  <input
                    type="file"
                    accept="image/*"
                    onChange={handleProfilePhotoChange}
                    id="profile-photo-edit"
                    className="hidden"
                  />
                  <label
                    htmlFor="profile-photo-edit"
                    className="inline-flex items-center gap-2 bg-gray-800 text-white px-4 py-2 rounded-lg hover:bg-gray-900 cursor-pointer transition-colors text-sm"
                  >
                    <Camera size={16} />
                    Choisir une photo
                  </label>
                  <p className="text-xs text-gray-500 mt-1">Formats acceptés: JPG, PNG, WebP (max 5MB)</p>
                </div>
              </div>
            )}
          </div>

          {/* Sections dynamiques collapsibles */}
          {sections.map((section) => {
            const SectionIcon = section.icon;
            const sectionPhotos = section.photos || [];
            const sectionNewPhotos = section.newPhotos || [];
            const totalPhotos = sectionPhotos.length + sectionNewPhotos.length;
            
            return (
              <div key={section.id} className="bg-white border-2 border-gray-200 rounded-xl shadow-sm overflow-hidden">
                {/* Section Header Collapsible */}
                <button
                  type="button"
                  onClick={() => toggleSection(section.id)}
                  className="w-full px-5 py-4 flex items-center justify-between bg-gradient-to-r from-gray-50 to-gray-100 hover:from-gray-100 hover:to-gray-150 transition-colors"
                >
                  <div className="flex items-center gap-3">
                    <div className="bg-gray-800 p-2 rounded-lg">
                      <SectionIcon size={20} className="text-white" />
                    </div>
                    <span className="font-semibold text-gray-900">{section.title}</span>
                    {section.hasPhotos && totalPhotos > 0 && (
                      <span className="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded-full font-medium">
                        {totalPhotos} photo{totalPhotos > 1 ? 's' : ''}
                      </span>
                    )}
                  </div>
                  {section.collapsed ? <ChevronDown size={20} className="text-gray-600" /> : <ChevronUp size={20} className="text-gray-600" />}
                </button>

                {/* Section Content */}
                {!section.collapsed && (
                  <div className="p-5 space-y-4 bg-white">
                    {/* Fields */}
                    {section.fields && section.fields.map(field => (
                      <div key={field.id}>
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          {field.label} {field.required && <span className="text-red-500">*</span>}
                        </label>
                        {field.type === 'select' ? (
                          <select
                            value={field.value}
                            onChange={(e) => handleFieldChange(section.id, field.id, e.target.value)}
                            className="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                            required={field.required}
                          >
                            <option value="">Client occasionnel (pas de suivi)</option>
                            {clients.map(client => (
                              <option key={client.id} value={client.id}>
                                {client.first_name} {client.last_name}
                              </option>
                            ))}
                          </select>
                        ) : field.type === 'textarea' ? (
                          <textarea
                            value={field.value}
                            onChange={(e) => handleFieldChange(section.id, field.id, e.target.value)}
                            rows={field.rows || 3}
                            className="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent resize-none"
                            required={field.required}
                            placeholder={field.placeholder || `Décrivez le contenu de cette section...`}
                          />
                        ) : (
                          <input
                            type={field.type}
                            value={field.value}
                            onChange={(e) => handleFieldChange(section.id, field.id, e.target.value)}
                            className="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                            required={field.required}
                            placeholder={field.placeholder || `Saisissez ${field.label.toLowerCase()}...`}
                          />
                        )}
                      </div>
                    ))}

                    {/* Photos de cette section */}
                    {section.hasPhotos && (
                      <div className="mt-6 pt-4 border-t border-gray-200">
                        <div className="flex items-center justify-between mb-3">
                          <label className="text-sm font-medium text-gray-700">Photos de cette section</label>
                          <input
                            type="file"
                            multiple
                            accept="image/*"
                            onChange={(e) => handlePhotoAdd(section.id, e)}
                            id={`photos-${section.id}`}
                            className="hidden"
                          />
                          <label
                            htmlFor={`photos-${section.id}`}
                            className="inline-flex items-center gap-2 bg-indigo-600 text-white px-3 py-1.5 rounded-lg hover:bg-indigo-700 cursor-pointer transition-colors text-sm"
                          >
                            <Camera size={16} />
                            Ajouter des photos
                          </label>
                        </div>

                        {totalPhotos > 0 ? (
                          <div className="grid grid-cols-3 gap-3">
                            {sectionPhotos.map((photo, idx) => (
                              <div key={`existing-${idx}`} className="relative aspect-square rounded-lg overflow-hidden group border border-gray-200">
                                <img
                                  src={photo.url || `${SUPABASE_URL}/storage/v1/object/public/${photo.storage_path}`}
                                  alt={`Photo ${idx + 1}`}
                                  className="w-full h-full object-cover cursor-pointer hover:opacity-90 transition-opacity"
                                  onClick={() => openLightbox(section.id, idx)}
                                />
                                <button
                                  type="button"
                                  onClick={() => handlePhotoDelete(section.id, photo, false)}
                                  className="absolute top-2 right-2 bg-red-600 text-white rounded-full p-1.5 opacity-0 group-hover:opacity-100 transition-opacity shadow-lg"
                                >
                                  <X size={14} />
                                </button>
                              </div>
                            ))}
                            {sectionNewPhotos.map((photo, idx) => (
                              <div key={`new-${idx}`} className="relative aspect-square rounded-lg overflow-hidden group border-2 border-green-500">
                                <img
                                  src={photo.url}
                                  alt={`Nouvelle ${idx + 1}`}
                                  className="w-full h-full object-cover cursor-pointer hover:opacity-90 transition-opacity"
                                  onClick={() => openLightbox(section.id, sectionPhotos.length + idx)}
                                />
                                <button
                                  type="button"
                                  onClick={() => handlePhotoDelete(section.id, photo, true)}
                                  className="absolute top-2 right-2 bg-red-600 text-white rounded-full p-1.5 opacity-0 group-hover:opacity-100 transition-opacity shadow-lg"
                                >
                                  <X size={14} />
                                </button>
                                <div className="absolute bottom-2 left-2 bg-green-600 text-white text-xs px-2 py-1 rounded-md font-medium shadow">
                                  Nouveau
                                </div>
                              </div>
                            ))}
                          </div>
                        ) : (
                          <div className="text-center py-8 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300">
                            <Camera size={32} className="mx-auto text-gray-400 mb-2" />
                            <p className="text-sm text-gray-500">Aucune photo ajoutée pour cette section</p>
                          </div>
                        )}
                      </div>
                    )}
                  </div>
                )}
              </div>
            );
          })}

          {/* Info */}
          <div className="bg-amber-50 border-2 border-amber-200 rounded-xl p-4">
            <p className="text-sm text-amber-800 flex items-center gap-2">
              <AlertCircle size={16} />
              <span>Les modifications seront visibles immédiatement pour le technicien.</span>
            </p>
          </div>

          {/* Buttons */}
          <div className="flex gap-3 pt-4">
            <button
              type="button"
              onClick={onClose}
              className="flex-1 bg-gray-200 text-gray-700 px-6 py-3 rounded-lg hover:bg-gray-300 transition-colors font-medium"
            >
              Annuler
            </button>
            <button
              type="submit"
              disabled={loading}
              className="flex-1 bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-6 py-3 rounded-lg hover:from-indigo-700 hover:to-purple-700 transition-colors font-medium disabled:opacity-50 flex items-center justify-center gap-2"
            >
              {loading ? (
                <>
                  <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>
                  Enregistrement...
                </>
              ) : (
                <>
                  <Save size={20} />
                  Enregistrer
                </>
              )}
            </button>
          </div>
        </form>
      </div>

      {/* Lightbox */}
      {lightboxOpen && currentSection && (() => {
        const section = sections.find(s => s.id === currentSection);
        const allPhotos = section ? [...section.photos, ...section.newPhotos] : [];
        const currentPhoto = allPhotos[currentPhotoIndex];
        
        return allPhotos.length > 0 && currentPhoto ? (
          <div 
            className="fixed inset-0 bg-black bg-opacity-95 flex items-center justify-center z-[60]"
            onClick={(e) => {
              if (e.target === e.currentTarget) {
                closeLightbox();
              }
            }}
          >
            <button
              onClick={(e) => {
                e.stopPropagation();
                closeLightbox();
              }}
              className="absolute top-4 right-4 text-white hover:bg-white hover:bg-opacity-20 rounded-full p-2 transition-colors"
            >
              <X size={32} />
            </button>
            
            {allPhotos.length > 1 && (
              <>
                <button
                  onClick={(e) => {
                    e.stopPropagation();
                    prevPhoto();
                  }}
                  className="absolute left-4 text-white hover:bg-white hover:bg-opacity-20 rounded-full p-3 transition-colors"
                >
                  <ChevronLeft size={40} />
                </button>

                <button
                  onClick={(e) => {
                    e.stopPropagation();
                    nextPhoto();
                  }}
                  className="absolute right-4 text-white hover:bg-white hover:bg-opacity-20 rounded-full p-3 transition-colors"
                >
                  <ChevronRight size={40} />
                </button>
              </>
            )}

            <div className="max-w-5xl max-h-[90vh] flex flex-col items-center" onClick={(e) => e.stopPropagation()}>
              <img
                src={
                  currentPhoto.file
                    ? currentPhoto.url
                    : (currentPhoto.url || `${SUPABASE_URL}/storage/v1/object/public/${currentPhoto.storage_path}`)
                }
                alt={`${section.title} ${currentPhotoIndex + 1}`}
                className="max-w-full max-h-[85vh] object-contain rounded-lg"
              />
              <p className="text-white mt-4 text-lg">
                {section.title} - Photo {currentPhotoIndex + 1} / {allPhotos.length}
              </p>
            </div>
          </div>
        ) : null;
      })()}
    </div>
  );
};

// ============================================================================
// BUREAU SEARCHES VIEW - Recherches partagées par les techniciens
// ============================================================================

const BureauSearchesView = () => {
  const [searches, setSearches] = useState([]);
  const [loading, setLoading] = useState(true);
  const [filterType, setFilterType] = useState('ALL'); // 'ALL', 'TERRAIN', 'INFILTRATION'
  const [statusFilter, setStatusFilter] = useState('ALL'); // 'ALL', 'SHARED', 'ACTIVE', 'DRAFT', 'CONVERTED'
  const [convertedSearches, setConvertedSearches] = useState(new Set()); // Track converted searches
  const [selectedSearch, setSelectedSearch] = useState(null);
  const [isDetailsModalOpen, setIsDetailsModalOpen] = useState(false);
  const [isEditModalOpen, setIsEditModalOpen] = useState(false);

  useEffect(() => {
    loadSearches();
  }, [statusFilter]);

  const loadSearches = async () => {
    try {
      let url = `${API}/searches`;
      
      // Charger selon le filtre de statut
      if (statusFilter === 'SHARED') {
        url = `${API}/reports/bureau-searches`;
      } else if (statusFilter === 'ACTIVE') {
        url = `${API}/searches?status=ACTIVE`;
      } else if (statusFilter === 'DRAFT') {
        url = `${API}/searches?status=DRAFT`;
      } else if (statusFilter === 'CONVERTED') {
        // Récupérer les recherches qui ont été converties en projet
        url = `${API}/searches?converted=true`;
      } else {
        // ALL : charger toutes les recherches
        url = `${API}/searches`;
      }
      
      const response = await axios.get(url, {
        headers: { Authorization: `Bearer ${localStorage.getItem('token')}` }
      });
      
      const searchList = statusFilter === 'SHARED' ? response.data.searches : response.data;
      setSearches(searchList || []);
    } catch (error) {
      console.error('Erreur chargement recherches bureau:', error);
    } finally {
      setLoading(false);
    }
  };

  const handleViewDetails = (search) => {
    setSelectedSearch(search);
    setIsDetailsModalOpen(true);
  };

  const handleEdit = (search) => {
    setSelectedSearch(search);
    setIsEditModalOpen(true);
  };

  const handleCloseDetailsModal = () => {
    setIsDetailsModalOpen(false);
    setSelectedSearch(null);
  };

  const handleCloseEditModal = () => {
    setIsEditModalOpen(false);
    setSelectedSearch(null);
    loadSearches(); // Recharger les recherches après édition
  };

  const handleSaveEdit = async (searchId, payload) => {
    try {
      await axios.put(`${API}/searches/${searchId}`, payload, {
        headers: { Authorization: `Bearer ${localStorage.getItem('token')}` }
      });
    } catch (error) {
      console.error('Erreur sauvegarde recherche:', error);
      throw error;
    }
  };

  // Déterminer le type de recherche depuis la base de données
  const getSearchType = (search) => {
    // Utiliser directement le champ search_type de la DB
    if (search.search_type) return search.search_type.toUpperCase();
    
    // Fallback : Heuristique basée sur les données (pour anciennes recherches)
    const desc = (search.description || '').toLowerCase();
    if (desc.includes('infiltration') || desc.includes('perméabilité') || desc.includes('test')) {
      return 'INFILTRATION';
    }
    return 'TERRAIN';
  };

  const filteredSearches = searches.filter(search => {
    if (filterType === 'ALL') return true;
    return getSearchType(search) === filterType;
  });

  const terrainCount = searches.filter(s => getSearchType(s) === 'TERRAIN').length;
  const infiltrationCount = searches.filter(s => getSearchType(s) === 'INFILTRATION').length;
  
  // Compter par statut
  const sharedCount = searches.filter(s => s.status === 'SHARED').length;
  const activeCount = searches.filter(s => s.status === 'ACTIVE').length;
  const draftCount = searches.filter(s => s.status === 'DRAFT').length;
  const convertedCount = searches.filter(s => s.project_id).length;

  if (loading) {
    return (
      <div className="flex items-center justify-center py-12">
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-gray-900"></div>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      {/* Header */}
      <div>
        <h1 className="text-3xl font-bold text-gray-900 mb-2">🔍 Gestion des Recherches</h1>
        <p className="text-gray-600">Toutes les recherches : brouillons, actives, partagées et converties</p>
      </div>

      {/* Filtres de Statut */}
      <div className="bg-white rounded-xl shadow-sm p-4 border border-gray-200">
        <h3 className="text-sm font-semibold text-gray-500 uppercase mb-3">Filtrer par statut</h3>
        <div className="flex flex-wrap gap-2">
          <button
            onClick={() => setStatusFilter('ALL')}
            className={`px-4 py-2 rounded-lg font-medium transition-all text-sm ${
              statusFilter === 'ALL'
                ? 'bg-gray-900 text-white shadow-md'
                : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
            }`}
          >
            📋 Toutes ({searches.length})
          </button>
          <button
            onClick={() => setStatusFilter('SHARED')}
            className={`px-4 py-2 rounded-lg font-medium transition-all text-sm ${
              statusFilter === 'SHARED'
                ? 'bg-green-600 text-white shadow-md'
                : 'bg-green-50 text-green-700 hover:bg-green-100'
            }`}
          >
            ✉️ Partagées ({sharedCount})
          </button>
          <button
            onClick={() => setStatusFilter('ACTIVE')}
            className={`px-4 py-2 rounded-lg font-medium transition-all text-sm ${
              statusFilter === 'ACTIVE'
                ? 'bg-blue-600 text-white shadow-md'
                : 'bg-blue-50 text-blue-700 hover:bg-blue-100'
            }`}
          >
            🔵 Actives ({activeCount})
          </button>
          <button
            onClick={() => setStatusFilter('DRAFT')}
            className={`px-4 py-2 rounded-lg font-medium transition-all text-sm ${
              statusFilter === 'DRAFT'
                ? 'bg-purple-600 text-white shadow-md'
                : 'bg-purple-50 text-purple-700 hover:bg-purple-100'
            }`}
          >
            📝 Brouillons ({draftCount})
          </button>
          <button
            onClick={() => setStatusFilter('CONVERTED')}
            className={`px-4 py-2 rounded-lg font-medium transition-all text-sm ${
              statusFilter === 'CONVERTED'
                ? 'bg-teal-600 text-white shadow-md'
                : 'bg-teal-50 text-teal-700 hover:bg-teal-100'
            }`}
          >
            🎯 Converties en projet ({convertedCount})
          </button>
        </div>
      </div>

      {/* Filtres de Type */}
      <div className="bg-white rounded-xl shadow-sm p-4 border border-gray-200">
        <h3 className="text-sm font-semibold text-gray-500 uppercase mb-3">Filtrer par type</h3>
        <div className="flex gap-3">
          <button
            onClick={() => setFilterType('ALL')}
            className={`px-6 py-3 rounded-lg font-medium transition-all ${
              filterType === 'ALL'
                ? 'bg-gray-900 text-white shadow-md'
                : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
            }`}
          >
            📋 Tous types ({searches.length})
          </button>
          <button
            onClick={() => setFilterType('TERRAIN')}
            className={`px-6 py-3 rounded-lg font-medium transition-all flex items-center gap-2 ${
              filterType === 'TERRAIN'
                ? 'bg-blue-600 text-white shadow-md'
                : 'bg-blue-50 text-blue-700 hover:bg-blue-100'
            }`}
          >
            <MapPin size={18} />
            Terrain ({terrainCount})
          </button>
          <button
            onClick={() => setFilterType('INFILTRATION')}
            className={`px-6 py-3 rounded-lg font-medium transition-all flex items-center gap-2 ${
              filterType === 'INFILTRATION'
                ? 'bg-orange-600 text-white shadow-md'
                : 'bg-orange-50 text-orange-700 hover:bg-orange-100'
            }`}
          >
            <Layers size={18} />
            Infiltration ({infiltrationCount})
          </button>
        </div>
      </div>

      {/* Grid en 2 colonnes : Terrain à gauche, Infiltration à droite */}
      <div className="grid grid-cols-2 gap-6">
        {/* Colonne Terrain */}
        <div>
          <h2 className="text-xl font-bold text-blue-900 mb-4 flex items-center gap-2">
            <MapPin className="text-blue-600" size={24} />
            Recherches Terrain ({terrainCount})
          </h2>
          <div className="space-y-4">
            {searches.filter(s => getSearchType(s) === 'TERRAIN').length === 0 ? (
              <div className="bg-blue-50 border-2 border-dashed border-blue-200 rounded-xl p-8 text-center">
                <MapPin className="h-12 w-12 mx-auto mb-3 text-blue-300" />
                <p className="text-blue-600 font-medium">Aucune recherche terrain</p>
              </div>
            ) : (
              searches.filter(s => getSearchType(s) === 'TERRAIN').map(search => (
                <div key={search.id} className="bg-white border-2 border-blue-200 rounded-xl p-5 hover:shadow-lg transition-all relative">
                  {/* Badge converti en projet */}
                  {search.project_id && (
                    <div className="absolute -top-2 -right-2 z-10">
                      <span className="bg-teal-600 text-white text-xs font-bold px-3 py-1 rounded-full shadow-lg flex items-center gap-1">
                        🎯 Projet créé
                      </span>
                    </div>
                  )}
                  
                  <div className="flex items-start justify-between mb-3">
                    <div className="flex items-center gap-2 flex-wrap">
                      <MapPin className="text-blue-600" size={20} />
                      <span className="text-xs font-medium bg-blue-100 text-blue-700 px-2 py-1 rounded-full">
                        Terrain
                      </span>
                      <span className="text-xs font-medium px-2 py-1 rounded-full bg-indigo-100 text-indigo-700 flex items-center gap-1">
                        <User size={12} />
                        {search.users ? `${search.users.first_name} ${search.users.last_name}` : 'Technicien'}
                      </span>
                      {search.status && (
                        <span className={`text-xs font-medium px-2 py-1 rounded-full ${
                          search.status === 'SHARED' ? 'bg-green-100 text-green-700' :
                          search.status === 'ACTIVE' ? 'bg-blue-100 text-blue-700' :
                          search.status === 'DRAFT' ? 'bg-purple-100 text-purple-700' :
                          'bg-gray-100 text-gray-700'
                        }`}>
                          {search.status === 'SHARED' ? '✉️ Partagée' :
                           search.status === 'ACTIVE' ? '🔵 Active' :
                           search.status === 'DRAFT' ? '📝 Brouillon' :
                           search.status}
                        </span>
                      )}
                    </div>
                    <span className="text-xs text-gray-500">
                      {new Date(search.shared_at || search.created_at).toLocaleString('fr-FR', { 
                        day: '2-digit', 
                        month: '2-digit', 
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                      })}
                    </span>
                  </div>
                  
                  {/* Client info */}
                  {(search.nom || search.prenom) && (
                    <div className="mb-3 p-2 bg-blue-50 rounded-lg">
                      <p className="text-sm font-semibold text-blue-900">
                        👤 {search.prenom} {search.nom}
                      </p>
                    </div>
                  )}
                  
                  {/* Location */}
                  <h3 className="font-bold text-gray-900 mb-2 flex items-start gap-2">
                    <MapPin size={16} className="text-blue-600 mt-1 flex-shrink-0" />
                    <span>{search.location || 'Sans adresse'}</span>
                  </h3>
                  
                  {/* Description */}
                  {search.description && (
                    <div className="mb-3">
                      <p className="text-xs font-semibold text-gray-500 mb-1">Description :</p>
                      <p className="text-sm text-gray-700 line-clamp-3">{search.description}</p>
                    </div>
                  )}
                  
                  {/* Observations */}
                  {search.observations && cleanObservations(search.observations) && (
                    <div className="mb-3 p-2 bg-amber-50 border border-amber-200 rounded-lg">
                      <p className="text-xs font-semibold text-amber-700 mb-1">📝 Observations :</p>
                      <p className="text-sm text-gray-700 line-clamp-2">{cleanObservations(search.observations)}</p>
                    </div>
                  )}
                  
                  {/* Boutons d'action */}
                  <div className="flex gap-2">
                    <button
                      onClick={() => handleViewDetails(search)}
                      className="flex-1 flex items-center justify-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors text-sm font-medium"
                    >
                      <Eye size={16} />
                      Détails
                    </button>
                    <button
                      onClick={() => !search.project_id && handleEdit(search)}
                      disabled={!!search.project_id}
                      className={`flex-1 flex items-center justify-center gap-2 px-4 py-2 rounded-lg transition-colors text-sm font-medium ${
                        search.project_id
                          ? 'bg-gray-400 text-gray-200 cursor-not-allowed'
                          : 'bg-gray-700 text-white hover:bg-gray-800'
                      }`}
                      title={search.project_id ? 'Projet déjà créé - modification désactivée' : 'Modifier la recherche'}
                    >
                      <Edit2 size={16} />
                      Modifier
                    </button>
                    <button
                      onClick={async () => {
                        try {
                          const response = await fetch(`${API}/searches/${search.id}/pdf`, {
                            headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                          });
                          if (!response.ok) throw new Error('Erreur génération PDF');
                          const blob = await response.blob();
                          const url = window.URL.createObjectURL(blob);
                          const a = document.createElement('a');
                          a.href = url;
                          a.download = `recherche_${search.location || search.id}.pdf`;
                          document.body.appendChild(a);
                          a.click();
                          window.URL.revokeObjectURL(url);
                          document.body.removeChild(a);
                        } catch (error) {
                          alert('❌ Erreur lors de la génération du PDF');
                          console.error(error);
                        }
                      }}
                      className="flex items-center justify-center gap-2 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors text-sm font-medium"
                      title="Télécharger en PDF"
                    >
                      <Download size={16} />
                      PDF
                    </button>
                  </div>
                </div>
              ))
            )}
          </div>
        </div>

        {/* Colonne Infiltration */}
        <div>
          <h2 className="text-xl font-bold text-orange-900 mb-4 flex items-center gap-2">
            <Layers className="text-orange-600" size={24} />
            Recherches Infiltration ({infiltrationCount})
          </h2>
          <div className="space-y-4">
            {searches.filter(s => getSearchType(s) === 'INFILTRATION').length === 0 ? (
              <div className="bg-orange-50 border-2 border-dashed border-orange-200 rounded-xl p-8 text-center">
                <Layers className="h-12 w-12 mx-auto mb-3 text-orange-300" />
                <p className="text-orange-600 font-medium">Aucune recherche d'infiltration</p>
              </div>
            ) : (
              searches.filter(s => getSearchType(s) === 'INFILTRATION').map(search => (
                <div key={search.id} className="bg-white border-2 border-orange-200 rounded-xl p-5 hover:shadow-lg transition-all relative">
                  {/* Badge converti en projet */}
                  {search.project_id && (
                    <div className="absolute -top-2 -right-2 z-10">
                      <span className="bg-teal-600 text-white text-xs font-bold px-3 py-1 rounded-full shadow-lg flex items-center gap-1">
                        🎯 Projet créé
                      </span>
                    </div>
                  )}
                  
                  <div className="flex items-start justify-between mb-3">
                    <div className="flex items-center gap-2 flex-wrap">
                      <Layers className="text-orange-600" size={20} />
                      <span className="text-xs font-medium bg-orange-100 text-orange-700 px-2 py-1 rounded-full">
                        Infiltration
                      </span>
                      <span className="text-xs font-medium px-2 py-1 rounded-full bg-indigo-100 text-indigo-700 flex items-center gap-1">
                        <User size={12} />
                        {search.users ? `${search.users.first_name} ${search.users.last_name}` : 'Technicien'}
                      </span>
                      {search.status && (
                        <span className={`text-xs font-medium px-2 py-1 rounded-full ${
                          search.status === 'SHARED' ? 'bg-green-100 text-green-700' :
                          search.status === 'ACTIVE' ? 'bg-blue-100 text-blue-700' :
                          search.status === 'DRAFT' ? 'bg-purple-100 text-purple-700' :
                          'bg-gray-100 text-gray-700'
                        }`}>
                          {search.status === 'SHARED' ? '✉️ Partagée' :
                           search.status === 'ACTIVE' ? '🔵 Active' :
                           search.status === 'DRAFT' ? '📝 Brouillon' :
                           search.status}
                        </span>
                      )}
                    </div>
                    <span className="text-xs text-gray-500">
                      {new Date(search.shared_at || search.created_at).toLocaleString('fr-FR', { 
                        day: '2-digit', 
                        month: '2-digit', 
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                      })}
                    </span>
                  </div>
                  
                  {/* Client info */}
                  {(search.nom || search.prenom) && (
                    <div className="mb-3 p-2 bg-orange-50 rounded-lg">
                      <p className="text-sm font-semibold text-orange-900">
                        👤 {search.prenom} {search.nom}
                      </p>
                    </div>
                  )}
                  
                  {/* Location */}
                  <h3 className="font-bold text-gray-900 mb-2 flex items-start gap-2">
                    <MapPin size={16} className="text-orange-600 mt-1 flex-shrink-0" />
                    <span>{search.location || 'Sans adresse'}</span>
                  </h3>
                  
                  {/* Description */}
                  {search.description && (
                    <div className="mb-3">
                      <p className="text-xs font-semibold text-gray-500 mb-1">Description :</p>
                      <p className="text-sm text-gray-700 line-clamp-3">{search.description}</p>
                    </div>
                  )}
                  
                  {/* Observations */}
                  {search.observations && cleanObservations(search.observations) && (
                    <div className="mb-3 p-2 bg-amber-50 border border-amber-200 rounded-lg">
                      <p className="text-xs font-semibold text-amber-700 mb-1">📝 Observations :</p>
                      <p className="text-sm text-gray-700 line-clamp-2">{cleanObservations(search.observations)}</p>
                    </div>
                  )}
                  
                  {/* Boutons d'action */}
                  <div className="flex gap-2">
                    <button
                      onClick={() => handleViewDetails(search)}
                      className="flex-1 flex items-center justify-center gap-2 bg-orange-600 text-white px-4 py-2 rounded-lg hover:bg-orange-700 transition-colors text-sm font-medium"
                    >
                      <Eye size={16} />
                      Détails
                    </button>
                    <button
                      onClick={() => !search.project_id && handleEdit(search)}
                      disabled={!!search.project_id}
                      className={`flex-1 flex items-center justify-center gap-2 px-4 py-2 rounded-lg transition-colors text-sm font-medium ${
                        search.project_id
                          ? 'bg-gray-400 text-gray-200 cursor-not-allowed'
                          : 'bg-gray-700 text-white hover:bg-gray-800'
                      }`}
                      title={search.project_id ? 'Projet déjà créé - modification désactivée' : 'Modifier la recherche'}
                    >
                      <Edit2 size={16} />
                      Modifier
                    </button>
                    <button
                      onClick={async () => {
                        try {
                          const response = await fetch(`${API}/searches/${search.id}/pdf`, {
                            headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                          });
                          if (!response.ok) throw new Error('Erreur génération PDF');
                          const blob = await response.blob();
                          const url = window.URL.createObjectURL(blob);
                          const a = document.createElement('a');
                          a.href = url;
                          a.download = `recherche_${search.location || search.id}.pdf`;
                          document.body.appendChild(a);
                          a.click();
                          window.URL.revokeObjectURL(url);
                          document.body.removeChild(a);
                        } catch (error) {
                          alert('❌ Erreur lors de la génération du PDF');
                          console.error(error);
                        }
                      }}
                      className="flex items-center justify-center gap-2 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors text-sm font-medium"
                      title="Télécharger en PDF"
                    >
                      <Download size={16} />
                      PDF
                    </button>
                  </div>
                </div>
              ))
            )}
          </div>
        </div>
      </div>

      {/* Message si aucune recherche */}
      {searches.length === 0 && (
        <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-12 text-center">
          <Search className="h-16 w-16 mx-auto mb-4 text-gray-300" />
          <h3 className="text-xl font-semibold text-gray-900 mb-2">Aucune recherche partagée</h3>
          <p className="text-gray-500">
            Les recherches envoyées par les techniciens apparaîtront ici
          </p>
        </div>
      )}
      
      {/* Modal Détails */}
      {isDetailsModalOpen && selectedSearch && (
        <SearchDetailsModal 
          search={selectedSearch} 
          onClose={handleCloseDetailsModal}
        />
      )}
      
      {/* Modal Édition */}
      {isEditModalOpen && selectedSearch && (
        <EditSearchModal 
          search={selectedSearch} 
          onSave={handleSaveEdit}
          onClose={handleCloseEditModal}
        />
      )}
    </div>
  );
};

// ============================================================================
// PROJECTS HUB - Mon Entreprise
// ============================================================================

const ProjectsHub = () => {
  const navigate = useNavigate();
  const [projects, setProjects] = useState([]);
  const [searches, setSearches] = useState([]);
  const [loading, setLoading] = useState(true);
  const [openFolder, setOpenFolder] = useState(null); // null, 'projects', 'searches'
  const [stats, setStats] = useState(null);
  const [showCreateModal, setShowCreateModal] = useState(false);
  const [showProjectDetails, setShowProjectDetails] = useState(false);
  const [selectedProject, setSelectedProject] = useState(null);
  const [showQuoteModal, setShowQuoteModal] = useState(false);
  const [selectedProjectForQuote, setSelectedProjectForQuote] = useState(null);
  const [clients, setClients] = useState([]);
  const [searchTerm, setSearchTerm] = useState('');
  const [convertedSearches, setConvertedSearches] = useState(new Set());
  const [selectedSearch, setSelectedSearch] = useState(null);
  const [isDetailsModalOpen, setIsDetailsModalOpen] = useState(false);
  const [isEditModalOpen, setIsEditModalOpen] = useState(false);
  const [searchToConvert, setSearchToConvert] = useState(null); // Recherche en cours de conversion
  const [newQuote, setNewQuote] = useState({
    title: '',
    amount_ht: '',
    tva: '20',
    valid_until: '',
    deadline: '',
    description: '',
    conditions: ''
  });
  const [newProject, setNewProject] = useState({
    name: '',
    client_id: '',
    status: 'RECHERCHE',
    priority: 'NORMAL',
    category: '',
    estimated_value: '',
    start_date: '',
    notes: ''
  });

  useEffect(() => {
    loadClients();
    loadProjects();
    loadSearches();
    loadStats();
  }, []);

  // Ouvrir le modal de création quand on arrive sur les projets avec une recherche à convertir
  useEffect(() => {
    if (openFolder === 'projects' && searchToConvert) {
      console.log('Ouverture du modal pour recherche:', searchToConvert.id);
      const timer = setTimeout(() => {
        setShowCreateModal(true);
      }, 200);
      return () => clearTimeout(timer);
    }
  }, [openFolder, searchToConvert]);

  const loadProjects = async () => {
    try {
      setLoading(true);
      const response = await axios.get(`${API}/projects`);
      setProjects(response.data.data || []);
    } catch (error) {
      console.error('Erreur chargement projets:', error);
    } finally {
      setLoading(false);
    }
  };

  const loadSearches = async () => {
    try {
      const response = await axios.get(`${API}/searches?status=SHARED`);
      const searches = response.data.data || [];
      
      // Récupérer les infos des utilisateurs pour chaque recherche
      const searchesWithUsers = await Promise.all(
        searches.map(async (search) => {
          if (search.user_id) {
            try {
              const userResponse = await axios.get(
                `${API}/users/${search.user_id}`,
                { headers: { Authorization: `Bearer ${localStorage.getItem('token')}` } }
              );
              return { ...search, users: userResponse.data };
            } catch (error) {
              console.error(`❌ Impossible de charger l'utilisateur ${search.user_id}:`, error.response?.status, error.response?.data);
              return search;
            }
          }
          console.warn('⚠️ Recherche sans user_id:', search.id);
          return search;
        })
      );
      
      // Initialiser convertedSearches avec les recherches qui ont déjà un project_id
      const converted = new Set(
        searchesWithUsers
          .filter(search => search.project_id)
          .map(search => search.id)
      );
      setConvertedSearches(converted);
      
      setSearches(searchesWithUsers);
    } catch (error) {
      console.error('Erreur chargement recherches:', error);
    }
  };

  const loadStats = async () => {
    try {
      const response = await axios.get(`${API}/projects/stats/dashboard`);
      setStats(response.data);
    } catch (error) {
      console.error('Erreur chargement stats:', error);
    }
  };

  const loadClients = async () => {
    try {
      const response = await axios.get(`${API}/clients`);
      setClients(response.data || []);
    } catch (error) {
      console.error('Erreur chargement clients:', error);
    }
  };

  const handleViewDetails = (search) => {
    setSelectedSearch(search);
    setIsDetailsModalOpen(true);
  };

  const handleEdit = (search) => {
    setSelectedSearch(search);
    setIsEditModalOpen(true);
  };

  const handleCloseDetailsModal = () => {
    setIsDetailsModalOpen(false);
    setSelectedSearch(null);
  };

  const handleCloseEditModal = () => {
    setIsEditModalOpen(false);
    setSelectedSearch(null);
    loadSearches();
  };

  const handleSaveEdit = async (searchId, updatedData) => {
    try {
      await axios.put(`${API}/searches/${searchId}`, updatedData, {
        headers: { Authorization: `Bearer ${localStorage.getItem('token')}` }
      });
      loadSearches();
    } catch (error) {
      console.error('Erreur sauvegarde:', error);
      throw error;
    }
  };

  const handleDeleteProject = async (projectId) => {
    if (!window.confirm('⚠️ Êtes-vous sûr de vouloir supprimer ce projet ?')) return;
    
    try {
      await axios.delete(`${API}/projects/${projectId}`);
      loadProjects();
      loadStats();
      alert('✅ Projet supprimé');
    } catch (error) {
      console.error('Erreur suppression:', error);
      alert('❌ Erreur lors de la suppression');
    }
  };

  const handleCreateQuote = (project) => {
    console.log('🔵 Création devis pour projet:', project);
    // Naviguer vers la page de création de devis avec les données du projet
    navigate('/bureau/devis', { 
      state: { 
        fromProject: true,
        project: project,
        client_id: project.client_id 
      } 
    });
  };

  const handleCreateQuoteSubmit = async () => {
    try {
      if (!newQuote.title || !newQuote.amount_ht) {
        alert('⚠️ Veuillez remplir au moins le titre et le montant HT');
        return;
      }

      const amountHT = parseFloat(newQuote.amount_ht);
      const tvaRate = parseFloat(newQuote.tva);
      const amountTTC = amountHT * (1 + tvaRate / 100);

      const quoteData = {
        client_id: selectedProjectForQuote.client_id,
        title: newQuote.title,
        description: `${newQuote.description || ''}\n\n--- Détails ---\nMontant HT: ${amountHT.toFixed(2)}€\nTVA: ${tvaRate}%\nMontant TTC: ${amountTTC.toFixed(2)}€\nValable jusqu'au: ${newQuote.valid_until || 'Non spécifié'}\nDélai: ${newQuote.deadline || 'Non spécifié'}\nConditions: ${newQuote.conditions || 'Aucune'}`,
        amount: amountTTC,
        status: 'DRAFT',
        items: []
      };

      const response = await axios.post(`${API}/quotes`, quoteData);
      
      if (response.data) {
        // Mettre à jour le projet avec le quote_id
        await axios.put(`${API}/projects/${selectedProjectForQuote.id}`, {
          quote_id: response.data.id,
          status: 'DEVIS_EN_COURS'
        });

        alert('✅ Devis créé avec succès !');
        setShowQuoteModal(false);
        loadProjects(); // Recharger les projets pour voir le devis lié
      }
    } catch (error) {
      console.error('Erreur création devis:', error);
      alert('❌ Erreur lors de la création du devis: ' + (error.response?.data?.detail || error.message));
    }
  };

  const handleCreateProject = async () => {
    try {
      // Validation : nom requis, client requis SAUF si conversion avec nom/prénom
      const hasClientInfo = searchToConvert && (searchToConvert.nom || searchToConvert.prenom);
      if (!newProject.name || (!newProject.client_id && !hasClientInfo)) {
        alert('Veuillez remplir au moins le nom' + (hasClientInfo ? '' : ' et le client'));
        return;
      }

      // Si c'est une conversion de recherche, utiliser l'endpoint de conversion
      if (searchToConvert) {
        console.log('Conversion de recherche en projet...', searchToConvert.id);
        const response = await axios.post(
          `${API}/searches/${searchToConvert.id}/convert-to-project`,
          {
            project_data: {
              ...newProject,
              estimated_value: newProject.estimated_value ? parseFloat(newProject.estimated_value) : null
            }
          },
          { headers: { Authorization: `Bearer ${localStorage.getItem('token')}` } }
        );
        
        console.log('Reponse conversion:', response.data);
        
        // Marquer comme converti seulement si le projet a été créé
        if (response.data.project || response.data.project_id) {
          setConvertedSearches(prev => new Set([...prev, searchToConvert.id]));
        }
        
        alert(`✅ ${response.data.message || 'Projet créé avec succès !'}`);
        setSearchToConvert(null); // Réinitialiser
      } else {
        // Création normale de projet
        console.log('Creation nouveau projet...');
        const response = await axios.post(`${API}/projects`, {
          ...newProject,
          estimated_value: newProject.estimated_value ? parseFloat(newProject.estimated_value) : null
        });
        console.log('Projet cree:', response.data);
        alert('✅ Projet créé avec succès !');
      }

      setShowCreateModal(false);
      setNewProject({
        name: '',
        client_id: '',
        status: 'RECHERCHE',
        priority: 'NORMAL',
        category: '',
        estimated_value: '',
        start_date: '',
        notes: ''
      });
      
      // Recharger toutes les données
      await loadProjects();
      await loadStats();
      await loadSearches(); // Important: Recharger les recherches pour mettre à jour l'état
    } catch (error) {
      console.error('Erreur creation projet:', error);
      console.error('Details erreur:', error.response?.data);
      alert(`❌ ${error.response?.data?.detail || error.response?.data?.message || 'Erreur lors de la création du projet'}`);
    }
  };

  const getStatusBadge = (status) => {
    const badges = {
      'RECHERCHE': { bg: 'bg-blue-100', text: 'text-blue-800', label: '🔍 Recherche' },
      'DEVIS_EN_COURS': { bg: 'bg-yellow-100', text: 'text-yellow-800', label: '📝 Devis en cours' },
      'DEVIS_VALIDE': { bg: 'bg-green-100', text: 'text-green-800', label: '✅ Devis validé' },
      'CHANTIER_EN_COURS': { bg: 'bg-orange-100', text: 'text-orange-800', label: '🏗️ Chantier en cours' },
      'FACTURE': { bg: 'bg-emerald-100', text: 'text-emerald-800', label: '💰 Facturé' },
      'CHANTIER_TERMINE': { bg: 'bg-purple-100', text: 'text-purple-800', label: '🎉 Terminé' },
      'ARCHIVE': { bg: 'bg-gray-100', text: 'text-gray-600', label: '📦 Archivé' }
    };
    const badge = badges[status] || badges['RECHERCHE'];
    return (
      <span className={`px-3 py-1 rounded-full text-xs font-medium ${badge.bg} ${badge.text}`}>
        {badge.label}
      </span>
    );
  };

  const getPriorityIcon = (priority) => {
    if (priority === 'URGENT') return <AlertCircle className="h-4 w-4 text-red-500" />;
    if (priority === 'HIGH') return <TrendingUp className="h-4 w-4 text-orange-500" />;
    return null;
  };

  // Vue Bureau ou Dossier
  if (openFolder === 'projects') {
    return (
      <div className="min-h-screen bg-gray-50 p-6">
        {/* Header Dossier Projets */}
        <div className="mb-6">
          <button
            onClick={() => setOpenFolder(null)}
            className="flex items-center gap-2 text-gray-600 hover:text-gray-900 mb-4"
          >
            <ArrowLeft className="h-5 w-5" />
            Retour au bureau
          </button>
          
          <div className="flex items-center justify-between">
            <h1 className="text-3xl font-bold text-gray-900 flex items-center gap-3">
              <FolderOpen className="h-8 w-8 text-blue-500" />
              Projets ({projects.length})
            </h1>
            <button
              onClick={(e) => {
                e.stopPropagation();
                setShowCreateModal(true);
              }}
              className="flex items-center gap-2 px-4 py-2 bg-black text-white rounded-lg hover:bg-gray-800 transition"
            >
              <Plus className="h-5 w-5" />
              Nouveau Projet
            </button>
          </div>
        </div>

        {/* Barre de recherche dans Projets */}
        <div className="mb-4 max-w-xl">
          <div className="relative">
            <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-gray-400" />
            <input
              type="text"
              placeholder="Rechercher dans les projets..."
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
              className="w-full pl-10 pr-10 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            />
            {searchTerm && (
              <button
                onClick={() => setSearchTerm('')}
                className="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600"
              >
                <X className="h-4 w-4" />
              </button>
            )}
          </div>
        </div>

        {/* Liste des Projets */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          {projects.filter(project => {
            if (!searchTerm) return true;
            const search = searchTerm.toLowerCase();
            const client = clients.find(c => c.id === project.client_id);
            const clientName = client ? `${client.nom} ${client.prenom}`.toLowerCase() : '';
            return (
              project.name?.toLowerCase().includes(search) ||
              project.project_number?.toLowerCase().includes(search) ||
              clientName.includes(search) ||
              project.description?.toLowerCase().includes(search)
            );
          }).map(project => {
            const client = clients.find(c => c.id === project.client_id);
            return (
              <div key={project.id} className="bg-white rounded-lg border-2 border-gray-200 hover:border-blue-500 transition p-4 shadow-sm">
                {/* En-tête projet */}
                <div className="flex items-start justify-between mb-3">
                  <div className="flex-1">
                    <div className="flex items-center gap-2 mb-1">
                      <FileText className="h-5 w-5 text-blue-500" />
                      <span className="text-xs font-mono text-gray-500">{project.project_number}</span>
                    </div>
                    <h3 className="font-bold text-gray-900 text-sm line-clamp-2">{project.name}</h3>
                    {client && (
                      <p className="text-xs text-gray-600 mt-1">
                        👤 {client.nom} {client.prenom}
                      </p>
                    )}
                  </div>
                  <button
                    onClick={() => handleDeleteProject(project.id)}
                    className="text-gray-400 hover:text-red-500 transition"
                  >
                    <Trash2 className="h-4 w-4" />
                  </button>
                </div>

                {/* Statut */}
                <div className="mb-3">
                  {getStatusBadge(project.status)}
                </div>

                {/* Montant */}
                {project.estimated_value && (
                  <div className="text-sm text-gray-600 mb-3">
                    💰 {parseFloat(project.estimated_value).toLocaleString('fr-FR')}€
                  </div>
                )}

                {/* Timeline */}
                <div className="flex items-center gap-1 mb-3 text-xs">
                  <div className={`w-3 h-3 rounded-full ${project.search_id ? 'bg-green-500' : 'bg-gray-300'}`} title="Recherche"></div>
                  <div className="h-0.5 flex-1 bg-gray-200"></div>
                  <div className="w-3 h-3 rounded-full bg-blue-500" title="Projet (actuel)"></div>
                  <div className="h-0.5 flex-1 bg-gray-200"></div>
                  <div className={`w-3 h-3 rounded-full ${project.quote_id ? 'bg-green-500' : 'bg-gray-300'}`} title="Devis"></div>
                  <div className="h-0.5 flex-1 bg-gray-200"></div>
                  <div className={`w-3 h-3 rounded-full ${project.worksite_id ? 'bg-green-500' : 'bg-gray-300'}`} title="Chantier"></div>
                  <div className="h-0.5 flex-1 bg-gray-200"></div>
                  <div className={`w-3 h-3 rounded-full ${project.report_id ? 'bg-green-500' : 'bg-gray-300'}`} title="Rapport"></div>
                </div>

                {/* Actions */}
                <div className="flex gap-2">
                  <button
                    onClick={() => {
                      setSelectedProject(project);
                      setShowProjectDetails(true);
                    }}
                    className="flex items-center justify-center gap-1 px-3 py-2 bg-gray-100 text-gray-700 text-xs rounded hover:bg-gray-200 transition"
                    title="Voir détails et modifier"
                  >
                    <Eye className="h-3 w-3" />
                    Détails
                  </button>
                  {!project.quote_id && (
                    <button
                      onClick={(e) => {
                        e.stopPropagation();
                        if (!project.client_id) {
                          alert('⚠️ Ce projet n\'a pas de client assigné. Veuillez d\'abord ajouter un client.');
                          return;
                        }
                        handleCreateQuote(project);
                      }}
                      className="flex-1 flex items-center justify-center gap-1 px-3 py-2 bg-blue-500 text-white text-xs rounded hover:bg-blue-600 transition"
                    >
                      <FileText className="h-3 w-3" />
                      Créer Devis
                    </button>
                  )}
                  {project.quote_id && !project.worksite_id && (
                    <button
                      className="flex-1 px-3 py-2 bg-orange-500 text-white text-xs rounded hover:bg-orange-600 transition"
                    >
                      🏗️ Créer Chantier
                    </button>
                  )}
                  {project.worksite_id && !project.report_id && (
                    <button
                      className="flex-1 px-3 py-2 bg-purple-500 text-white text-xs rounded hover:bg-purple-600 transition"
                    >
                      📄 Générer Rapport
                    </button>
                  )}
                </div>
              </div>
            );
          })}
        </div>

        {projects.length === 0 && (
          <div className="text-center py-12 bg-white rounded-lg border-2 border-dashed border-gray-300">
            <FolderOpen className="h-16 w-16 text-gray-300 mx-auto mb-4" />
            <p className="text-gray-500">Aucun projet dans ce dossier</p>
          </div>
        )}

        {/* Modal Création Projet */}
        {showCreateModal && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div className="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
              <div className="p-6 border-b border-gray-200 flex items-center justify-between sticky top-0 bg-white">
                <h2 className="text-2xl font-bold text-gray-900 flex items-center gap-2">
                  <Plus className="h-6 w-6" />
                  Nouveau Projet
                </h2>
                <button
                  onClick={() => {
                    setShowCreateModal(false);
                    setSearchToConvert(null);
                  }}
                  className="text-gray-400 hover:text-gray-600"
                >
                  <X className="h-6 w-6" />
                </button>
              </div>

              <div className="p-6 space-y-4">
                {/* Nom du projet */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Nom du projet <span className="text-red-500">*</span>
                  </label>
                  <input
                    type="text"
                    value={newProject.name}
                    onChange={(e) => setNewProject({...newProject, name: e.target.value})}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    placeholder="Ex: Rénovation cuisine M. Dupont"
                  />
                </div>

                {/* Client */}
                {searchToConvert && (searchToConvert.nom || searchToConvert.prenom) ? (
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Client (non récurrent)
                    </label>
                    <div className="w-full px-4 py-2 border border-gray-200 rounded-lg bg-blue-50 text-gray-700">
                      👤 {searchToConvert.prenom || ''} {searchToConvert.nom || ''}
                      {searchToConvert.location && (
                        <span className="text-sm text-gray-500 ml-2">• {searchToConvert.location}</span>
                      )}
                    </div>
                    <p className="text-xs text-blue-600 mt-1">
                      ℹ️ Ce client ne sera pas ajouté à votre liste de clients récurrents
                    </p>
                  </div>
                ) : (
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Client <span className="text-red-500">*</span>
                    </label>
                    <select
                      value={newProject.client_id}
                      onChange={(e) => setNewProject({...newProject, client_id: e.target.value})}
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    >
                      <option value="">Sélectionner un client</option>
                      {clients.map(client => (
                        <option key={client.id} value={client.id}>
                          {client.nom} {client.prenom} {client.entreprise ? `- ${client.entreprise}` : ''}
                        </option>
                      ))}
                    </select>
                  </div>
                )}

                {/* Status et Priorité */}
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Statut
                    </label>
                    <select
                      value={newProject.status}
                      onChange={(e) => setNewProject({...newProject, status: e.target.value})}
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    >
                      <option value="RECHERCHE">🔍 Recherche</option>
                      <option value="DEVIS_EN_COURS">📝 Devis en cours</option>
                      <option value="DEVIS_VALIDE">✅ Devis validé</option>
                      <option value="CHANTIER_EN_COURS">🏗️ Chantier en cours</option>
                      <option value="FACTURE">💰 Facturé</option>
                    </select>
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Priorité
                    </label>
                    <select
                      value={newProject.priority}
                      onChange={(e) => setNewProject({...newProject, priority: e.target.value})}
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    >
                      <option value="LOW">🟢 Basse</option>
                      <option value="NORMAL">🔵 Normale</option>
                      <option value="HIGH">🟠 Haute</option>
                      <option value="URGENT">🔴 Urgente</option>
                    </select>
                  </div>
                </div>

                {/* Catégorie */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Catégorie
                  </label>
                  <input
                    type="text"
                    value={newProject.category}
                    onChange={(e) => setNewProject({...newProject, category: e.target.value})}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    placeholder="Ex: Électricité, Plomberie, Général..."
                  />
                </div>

                {/* Valeur estimée et Date de début */}
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Montant estimé (€)
                    </label>
                    <input
                      type="number"
                      value={newProject.estimated_value}
                      onChange={(e) => setNewProject({...newProject, estimated_value: e.target.value})}
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      placeholder="0"
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Date de début estimée
                    </label>
                    <input
                      type="date"
                      value={newProject.start_date}
                      onChange={(e) => setNewProject({...newProject, start_date: e.target.value})}
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    />
                  </div>
                </div>

                {/* Notes */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Notes
                  </label>
                  <textarea
                    value={newProject.notes}
                    onChange={(e) => setNewProject({...newProject, notes: e.target.value})}
                    rows="3"
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    placeholder="Notes supplémentaires..."
                  />
                </div>
              </div>

              {/* Boutons d'action */}
              <div className="p-6 border-t border-gray-200 flex gap-3 justify-end sticky bottom-0 bg-white">
                <button
                  onClick={() => {
                    setShowCreateModal(false);
                    setSearchToConvert(null);
                  }}
                  className="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition"
                >
                  Annuler
                </button>
                <button
                  onClick={handleCreateProject}
                  className="flex items-center gap-2 px-6 py-2 bg-black text-white rounded-lg hover:bg-gray-800 transition"
                >
                  <Check className="h-5 w-5" />
                  Créer le projet
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Modal Détails Projet */}
        {showProjectDetails && selectedProject && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div className="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto">
              <div className="p-6 border-b border-gray-200 flex items-center justify-between sticky top-0 bg-white">
                <h2 className="text-2xl font-bold text-gray-900 flex items-center gap-2">
                  <Eye className="h-6 w-6" />
                  Détails du Projet
                </h2>
                <button
                  onClick={() => {
                    setShowProjectDetails(false);
                    setSelectedProject(null);
                  }}
                  className="text-gray-400 hover:text-gray-600"
                >
                  <X className="h-6 w-6" />
                </button>
              </div>

              <div className="p-6 space-y-6">
                {/* Informations principales */}
                <div className="bg-gray-50 p-4 rounded-lg">
                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <label className="text-xs font-medium text-gray-500">Numéro de projet</label>
                      <p className="text-sm font-mono text-gray-900">{selectedProject.project_number}</p>
                    </div>
                    <div>
                      <label className="text-xs font-medium text-gray-500">Statut</label>
                      <div className="mt-1">{getStatusBadge(selectedProject.status)}</div>
                    </div>
                    <div>
                      <label className="text-xs font-medium text-gray-500">Priorité</label>
                      <p className="text-sm text-gray-900 flex items-center gap-1">
                        {getPriorityIcon(selectedProject.priority)}
                        {selectedProject.priority}
                      </p>
                    </div>
                    <div>
                      <label className="text-xs font-medium text-gray-500">Catégorie</label>
                      <p className="text-sm text-gray-900">{selectedProject.category || 'Non définie'}</p>
                    </div>
                  </div>
                </div>

                {/* Nom du projet - Éditable */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Nom du projet</label>
                  <input
                    type="text"
                    value={selectedProject.name}
                    onChange={(e) => setSelectedProject({...selectedProject, name: e.target.value})}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  />
                </div>

                {/* Client */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Client</label>
                  <select
                    value={selectedProject.client_id || ''}
                    onChange={(e) => setSelectedProject({...selectedProject, client_id: e.target.value})}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  >
                    <option value="">Sélectionner un client</option>
                    {clients.map(client => (
                      <option key={client.id} value={client.id}>
                        {client.nom} {client.prenom} {client.is_recurring === false ? '(Non récurrent)' : ''}
                      </option>
                    ))}
                  </select>
                </div>

                {/* Statut - Éditable */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Statut</label>
                  <select
                    value={selectedProject.status}
                    onChange={(e) => setSelectedProject({...selectedProject, status: e.target.value})}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  >
                    <option value="RECHERCHE">🔍 Recherche</option>
                    <option value="DEVIS_EN_COURS">📝 Devis en cours</option>
                    <option value="DEVIS_VALIDE">✅ Devis validé</option>
                    <option value="CHANTIER_EN_COURS">🏗️ Chantier en cours</option>
                    <option value="CHANTIER_TERMINE">🎉 Chantier terminé</option>
                    <option value="FACTURE">💰 Facturé</option>
                    <option value="ARCHIVE">📦 Archivé</option>
                  </select>
                </div>

                {/* Priorité - Éditable */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Priorité</label>
                  <select
                    value={selectedProject.priority}
                    onChange={(e) => setSelectedProject({...selectedProject, priority: e.target.value})}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  >
                    <option value="LOW">Faible</option>
                    <option value="NORMAL">Normale</option>
                    <option value="HIGH">Haute</option>
                    <option value="URGENT">Urgente</option>
                  </select>
                </div>

                {/* Catégorie - Éditable */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Catégorie</label>
                  <input
                    type="text"
                    value={selectedProject.category || ''}
                    onChange={(e) => setSelectedProject({...selectedProject, category: e.target.value})}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    placeholder="Ex: Infiltration, Terrain, etc."
                  />
                </div>

                {/* Montant estimé - Éditable */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Montant estimé (€)</label>
                  <input
                    type="number"
                    value={selectedProject.estimated_value || ''}
                    onChange={(e) => setSelectedProject({...selectedProject, estimated_value: e.target.value})}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    placeholder="2000"
                  />
                </div>

                {/* Date de début - Éditable */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Date de début estimée</label>
                  <input
                    type="date"
                    value={selectedProject.start_date || ''}
                    onChange={(e) => setSelectedProject({...selectedProject, start_date: e.target.value})}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  />
                </div>

                {/* Timeline du cycle de vie */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-3">Cycle de vie du projet</label>
                  <div className="flex items-center gap-1">
                    {/* Recherche/Infiltration */}
                    <button
                      onClick={async () => {
                        if (selectedProject.search_id) {
                          try {
                            const response = await axios.get(
                              `${API}/searches/${selectedProject.search_id}`,
                              { headers: { Authorization: `Bearer ${localStorage.getItem('token')}` } }
                            );
                            setShowProjectDetails(false);
                            setSelectedProject(null);
                            setOpenFolder('searches');
                            setSelectedSearch(response.data);
                            setIsDetailsModalOpen(true);
                          } catch (error) {
                            console.error('Erreur chargement recherche:', error);
                            alert('❌ Impossible de charger la recherche');
                          }
                        }
                      }}
                      disabled={!selectedProject.search_id}
                      className={`flex-1 flex flex-col items-center gap-2 p-3 rounded-lg transition ${
                        selectedProject.search_id 
                          ? 'bg-green-50 border-2 border-green-500 hover:bg-green-100 cursor-pointer' 
                          : 'bg-gray-50 border-2 border-gray-200 cursor-not-allowed'
                      }`}
                    >
                      <Search className={`h-5 w-5 ${selectedProject.search_id ? 'text-green-600' : 'text-gray-400'}`} />
                      <span className="text-xs font-medium text-center">Recherche</span>
                    </button>
                    <div className="text-gray-400">→</div>
                    
                    {/* Projet (Toujours actif) */}
                    <div className="flex-1 flex flex-col items-center gap-2 p-3 rounded-lg bg-blue-50 border-2 border-blue-500">
                      <Briefcase className="h-5 w-5 text-blue-600" />
                      <span className="text-xs font-medium text-center">Projet</span>
                    </div>
                    <div className="text-gray-400">→</div>
                    
                    {/* Devis */}
                    <button
                      onClick={() => {
                        if (selectedProject.quote_id) {
                          setShowProjectDetails(false);
                          setSelectedProject(null);
                          setMenuSection('devis');
                          alert('📄 Redirection vers la section Devis');
                        }
                      }}
                      disabled={!selectedProject.quote_id}
                      className={`flex-1 flex flex-col items-center gap-2 p-3 rounded-lg transition ${
                        selectedProject.quote_id 
                          ? 'bg-green-50 border-2 border-green-500 hover:bg-green-100 cursor-pointer' 
                          : 'bg-gray-50 border-2 border-gray-200 cursor-not-allowed'
                      }`}
                    >
                      <FileText className={`h-5 w-5 ${selectedProject.quote_id ? 'text-green-600' : 'text-gray-400'}`} />
                      <span className="text-xs font-medium text-center">Devis</span>
                    </button>
                    <div className="text-gray-400">→</div>
                    
                    {/* Chantier */}
                    <button
                      onClick={() => {
                        if (selectedProject.worksite_id) {
                          setShowProjectDetails(false);
                          setSelectedProject(null);
                          setMenuSection('chantiers');
                          alert('🏗️ Redirection vers la section Chantiers');
                        }
                      }}
                      disabled={!selectedProject.worksite_id}
                      className={`flex-1 flex flex-col items-center gap-2 p-3 rounded-lg transition ${
                        selectedProject.worksite_id 
                          ? 'bg-green-50 border-2 border-green-500 hover:bg-green-100 cursor-pointer' 
                          : 'bg-gray-50 border-2 border-gray-200 cursor-not-allowed'
                      }`}
                    >
                      <Briefcase className={`h-5 w-5 ${selectedProject.worksite_id ? 'text-green-600' : 'text-gray-400'}`} />
                      <span className="text-xs font-medium text-center">Chantier</span>
                    </button>
                    <div className="text-gray-400">→</div>
                    
                    {/* Rapport */}
                    <button
                      onClick={() => {
                        if (selectedProject.report_id) {
                          alert('📄 Navigation vers les rapports à venir');
                          // TODO: Implémenter la navigation vers les rapports
                        }
                      }}
                      disabled={!selectedProject.report_id}
                      className={`flex-1 flex flex-col items-center gap-2 p-3 rounded-lg transition ${
                        selectedProject.report_id 
                          ? 'bg-green-50 border-2 border-green-500 hover:bg-green-100 cursor-pointer' 
                          : 'bg-gray-50 border-2 border-gray-200 cursor-not-allowed'
                      }`}
                    >
                      <FileText className={`h-5 w-5 ${selectedProject.report_id ? 'text-green-600' : 'text-gray-400'}`} />
                      <span className="text-xs font-medium text-center">Rapport</span>
                    </button>
                  </div>
                </div>

                {/* Dates de création/modification */}
                <div className="bg-gray-50 p-4 rounded-lg">
                  <div className="grid grid-cols-2 gap-4 text-xs text-gray-600">
                    <div>
                      <span className="font-medium">Créé le:</span> {new Date(selectedProject.created_at).toLocaleString('fr-FR')}
                    </div>
                    {selectedProject.updated_at && (
                      <div>
                        <span className="font-medium">Modifié le:</span> {new Date(selectedProject.updated_at).toLocaleString('fr-FR')}
                      </div>
                    )}
                  </div>
                </div>

                {/* Actions */}
                <div className="flex gap-3 pt-4 border-t border-gray-200">
                  <button
                    onClick={() => {
                      setShowProjectDetails(false);
                      setSelectedProject(null);
                    }}
                    className="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition"
                  >
                    Annuler
                  </button>
                  <button
                    onClick={async () => {
                      try {
                        await axios.put(
                          `${API}/projects/${selectedProject.id}`,
                          selectedProject,
                          { headers: { Authorization: `Bearer ${localStorage.getItem('token')}` } }
                        );
                        alert('✅ Projet modifié avec succès');
                        await loadProjects();
                        setShowProjectDetails(false);
                        setSelectedProject(null);
                      } catch (error) {
                        console.error('Erreur modification:', error);
                        alert('❌ Erreur lors de la modification');
                      }
                    }}
                    className="flex items-center gap-2 px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition"
                  >
                    <Check className="h-5 w-5" />
                    Enregistrer
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}
      </div>
    );
  }

  if (openFolder === 'searches') {
    return (
      <div className="min-h-screen bg-gray-50 p-6">
        {/* Header Dossier Recherches */}
        <div className="mb-6">
          <button
            onClick={() => setOpenFolder(null)}
            className="flex items-center gap-2 text-gray-600 hover:text-gray-900 mb-4"
          >
            <ArrowLeft className="h-5 w-5" />
            Retour au bureau
          </button>
          
          <h1 className="text-3xl font-bold text-gray-900 flex items-center gap-3">
            <Search className="h-8 w-8 text-orange-500" />
            Recherches Techniciens ({searches.length})
          </h1>
          <p className="text-gray-600 mt-1">Recherches partagées par les techniciens</p>
        </div>

        {/* Barre de recherche dans Recherches */}
        <div className="mb-4 max-w-xl">
          <div className="relative">
            <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-gray-400" />
            <input
              type="text"
              placeholder="Rechercher dans les recherches..."
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
              className="w-full pl-10 pr-10 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
            />
            {searchTerm && (
              <button
                onClick={() => setSearchTerm('')}
                className="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600"
              >
                <X className="h-4 w-4" />
              </button>
            )}
          </div>
        </div>

        {/* Liste des Recherches */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          {searches.filter(search => {
            if (!searchTerm) return true;
            const searchLower = searchTerm.toLowerCase();
            return (
              search.location?.toLowerCase().includes(searchLower) ||
              search.search_type?.toLowerCase().includes(searchLower) ||
              search.description?.toLowerCase().includes(searchLower) ||
              search.nom?.toLowerCase().includes(searchLower) ||
              search.prenom?.toLowerCase().includes(searchLower)
            );
          }).map(search => {
            const searchType = search.search_type?.toUpperCase() || 'TERRAIN';
            const isInfiltration = searchType === 'INFILTRATION';
            const isConverted = !!search.project_id || convertedSearches.has(search.id);
            
            return (
              <div 
                key={search.id} 
                className={`bg-white rounded-lg border-2 hover:shadow-lg transition-all p-5 ${
                  isInfiltration ? 'border-orange-200 hover:border-orange-500' : 'border-blue-200 hover:border-blue-500'
                }`}
              >
                {/* Header avec type et date */}
                <div className="flex items-start justify-between mb-3">
                  <div className="flex items-center gap-2 flex-wrap">
                    {isInfiltration ? (
                      <Layers className="text-orange-600" size={20} />
                    ) : (
                      <MapPin className="text-blue-600" size={20} />
                    )}
                    <span className={`text-xs font-bold px-3 py-1.5 rounded-full shadow-sm ${
                      isInfiltration ? 'bg-orange-100 text-orange-700' : 'bg-blue-100 text-blue-700'
                    }`}>
                      {isInfiltration ? 'Infiltration' : 'Terrain'}
                    </span>
                    <span className="text-xs font-semibold px-3 py-1.5 rounded-full bg-indigo-100 text-indigo-700 flex items-center gap-1.5 shadow-sm">
                      <User size={13} />
                      {search.users ? `${search.users.first_name} ${search.users.last_name}` : 'Technicien'}
                    </span>
                  </div>
                  <span className="text-xs font-medium text-gray-500 bg-gray-50 px-3 py-1.5 rounded-full">
                    {new Date(search.shared_at || search.created_at).toLocaleDateString('fr-FR')}
                  </span>
                </div>

                {/* Client info */}
                {(search.nom || search.prenom) && (
                  <div className={`mb-3 p-3 rounded-xl border shadow-sm ${
                    isInfiltration ? 'bg-orange-50 border-orange-200' : 'bg-blue-50 border-blue-200'
                  }`}>
                    <p className={`text-sm font-bold flex items-center gap-2 ${
                      isInfiltration ? 'text-orange-900' : 'text-blue-900'
                    }`}>
                      <User size={16} className={isInfiltration ? 'text-orange-600' : 'text-blue-600'} />
                      {search.prenom} {search.nom}
                    </p>
                  </div>
                )}

                {/* Adresse */}
                <div className="mb-3 bg-gray-50 p-3 rounded-xl border border-gray-200">
                  <h3 className="font-bold text-gray-900 text-sm flex items-start gap-2">
                    <MapPin size={16} className={`mt-0.5 flex-shrink-0 ${
                      isInfiltration ? 'text-orange-600' : 'text-blue-600'
                    }`} strokeWidth={2.5} />
                    <span>{search.location || 'Sans adresse'}</span>
                  </h3>
                </div>

                {/* Description */}
                {search.description && (
                  <div className="mb-3 italic">
                    <p className="text-sm text-gray-700 line-clamp-2">{search.description}</p>
                  </div>
                )}

                {/* Observations */}
                {search.observations && cleanObservations(search.observations) && (
                  <div className="mb-4 p-3 bg-amber-50 border-2 border-amber-200 rounded-xl shadow-sm">
                    <p className="text-xs font-bold text-amber-800 mb-1.5 flex items-center gap-1.5">
                      <span className="text-base">📝</span>
                      Observations
                    </p>
                    <p className="text-sm text-gray-700 line-clamp-2 leading-relaxed">{cleanObservations(search.observations)}</p>
                  </div>
                )}

                {/* Boutons d'action */}
                <div className="flex gap-2 mb-4">
                  <button
                    onClick={() => handleViewDetails(search)}
                    className={`flex-1 flex items-center justify-center gap-2 px-3 py-2.5 rounded-xl transition-all text-sm font-bold shadow-md hover:shadow-lg transform hover:scale-105 ${
                      isInfiltration 
                        ? 'bg-orange-600 hover:bg-orange-700 text-white' 
                        : 'bg-blue-600 hover:bg-blue-700 text-white'
                    }`}
                  >
                    <Eye size={16} strokeWidth={2.5} />
                    Détails
                  </button>
                  <button
                    onClick={() => !isConverted && handleEdit(search)}
                    disabled={isConverted}
                    className={`flex-1 flex items-center justify-center gap-2 px-3 py-2.5 rounded-xl transition-all text-sm font-bold shadow-md hover:shadow-lg ${
                      isConverted
                        ? 'bg-gray-400 text-gray-200 cursor-not-allowed'
                        : 'bg-gray-700 hover:bg-gray-800 text-white transform hover:scale-105'
                    }`}
                    title={isConverted ? 'Projet déjà créé - modification désactivée' : 'Modifier la recherche'}
                  >
                    <Edit2 size={16} strokeWidth={2.5} />
                    Modifier
                  </button>
                  <button
                    onClick={async () => {
                      console.log('🔵 Bouton PDF cliqué pour search:', search.id);
                      try {
                        console.log('📄 Génération PDF en cours...');
                        const response = await fetch(`${API}/searches/${search.id}/pdf`, {
                          headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                        });
                        console.log('📊 Réponse PDF:', response.status, response.ok);
                        if (!response.ok) {
                          const errorText = await response.text();
                          console.error('❌ Erreur serveur:', errorText);
                          throw new Error(`Erreur génération PDF: ${response.status} - ${errorText}`);
                        }
                        const blob = await response.blob();
                        console.log('✅ Blob reçu:', blob.size, 'bytes');
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `recherche_${search.location || search.id}.pdf`;
                        document.body.appendChild(a);
                        a.click();
                        console.log('📥 Téléchargement déclenché');
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);
                      } catch (error) {
                        console.error('❌ ERREUR PDF:', error);
                        alert(`❌ Erreur lors de la génération du PDF: ${error.message}`);
                      }
                    }}
                    className="flex items-center justify-center gap-2 bg-green-600 text-white px-3 py-2.5 rounded-xl hover:bg-green-700 transition-all text-sm font-bold shadow-md hover:shadow-lg transform hover:scale-105"
                    title="Télécharger en PDF"
                  >
                    <Download size={16} strokeWidth={2.5} />
                    PDF
                  </button>
                </div>

                {/* Bouton Transformer en Projet / Projet Créé */}
                <button
                  onClick={() => {
                    if (isConverted) return; // Désactiver si déjà converti
                    
                    console.log('Bouton Transformer en Projet clique pour recherche:', search.id);
                    
                    // Stocker la recherche à convertir et pré-remplir le formulaire
                    setSearchToConvert(search);
                    
                    // Nettoyer les observations du formatage Markdown
                    const cleanedDescription = search.description || '';
                    const cleanedObservations = cleanObservations(search.observations || '');
                    
                    setNewProject({
                      name: search.location || 'Projet sans nom',
                      client_id: '',
                      status: 'RECHERCHE',
                      priority: 'NORMAL',
                      category: search.search_type === 'TERRAIN' ? 'Recherche terrain' : 'Infiltration',
                      estimated_value: '',
                      start_date: '',
                      notes: cleanedObservations || cleanedDescription || ''
                    });
                    
                    console.log('Redirection vers projets...');
                    // Redirection vers les projets (le useEffect ouvrira le modal automatiquement)
                    setOpenFolder('projects');
                  }}
                  disabled={isConverted}
                  className={`w-full py-3 px-4 rounded-xl font-bold text-sm transition-all flex items-center justify-center gap-2.5 shadow-lg hover:shadow-xl ${
                    isConverted
                      ? 'bg-green-600 text-white cursor-not-allowed'
                      : isInfiltration 
                        ? 'bg-blue-600 hover:bg-blue-700 text-white cursor-pointer transform hover:scale-105' 
                        : 'bg-blue-600 hover:bg-blue-700 text-white cursor-pointer transform hover:scale-105'
                  }`}
                >
                  {isConverted ? (
                    <>
                      <CheckCircle size={18} strokeWidth={2.5} />
                      Projet Créé
                    </>
                  ) : (
                    <>
                      <FolderOpen size={18} strokeWidth={2.5} />
                      Transformer en Projet
                    </>
                  )}
                </button>
              </div>
            );
          })}
        </div>

        {searches.length === 0 && (
          <div className="text-center py-12 bg-white rounded-lg border-2 border-dashed border-gray-300">
            <Search className="h-16 w-16 text-gray-300 mx-auto mb-4" />
            <p className="text-gray-500">Aucune recherche partagée</p>
          </div>
        )}

        {/* Modal Détails */}
        {isDetailsModalOpen && selectedSearch && (
          <SearchDetailsModal 
            search={selectedSearch} 
            onClose={handleCloseDetailsModal}
          />
        )}
        
        {/* Modal Édition - Utilise le même formulaire que la création */}
        {isEditModalOpen && selectedSearch && (
          <div className="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50">
            <div className="bg-white rounded-xl shadow-2xl w-[98vw] h-[98vh] overflow-y-auto p-6">
              {/* Header */}
              <div className="flex items-center justify-between mb-6 pb-4 border-b-2 border-gray-200">
                <div>
                  <h2 className="text-2xl font-semibold text-gray-900">Modifier la Recherche</h2>
                  <p className="text-sm text-gray-600 mt-1">Éditez les informations de la recherche</p>
                </div>
                <button
                  onClick={handleCloseEditModal}
                  className="p-2 hover:bg-gray-100 rounded-full transition-colors"
                >
                  <X className="h-6 w-6 text-gray-600" />
                </button>
              </div>
              
              {/* Formulaire de recherche réutilisé */}
              <SearchForm 
                searchType={selectedSearch.search_type || 'TERRAIN'}
                initialSearch={selectedSearch}
                onSearchLoaded={() => console.log('✅ Recherche chargée pour édition')}
              />
            </div>
          </div>
        )}
      </div>
    );
  }

  // Vue Paramètres Entreprise
  if (openFolder === 'settings') {
    return <CompanySettings onBack={() => setOpenFolder(null)} />;
  }

  // Vue Bureau (par défaut)
  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-gray-100 p-6">
      {/* Header */}
      <div className="mb-8">
        <h1 className="text-3xl font-bold text-gray-900 flex items-center gap-3">
          <Briefcase className="h-8 w-8" />
          Mon Entreprise
        </h1>
        <p className="text-gray-600 mt-1">Bureau de gestion</p>
      </div>

      {/* Barre de recherche */}
      <div className="mb-6 max-w-2xl mx-auto">
        <div className="relative">
          <Search className="absolute left-4 top-1/2 transform -translate-y-1/2 h-5 w-5 text-gray-400" />
          <input
            type="text"
            placeholder="Rechercher un projet ou une recherche..."
            value={searchTerm}
            onChange={(e) => setSearchTerm(e.target.value)}
            className="w-full pl-12 pr-4 py-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent shadow-sm"
          />
          {searchTerm && (
            <button
              onClick={() => setSearchTerm('')}
              className="absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600"
            >
              <X className="h-5 w-5" />
            </button>
          )}
        </div>
      </div>

      {/* Bureau - Dossiers */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {/* Dossier Projets */}
        <button
          onClick={() => setOpenFolder('projects')}
          className="bg-white rounded-xl border-2 border-gray-200 hover:border-blue-500 p-8 transition-all hover:shadow-xl group text-left"
        >
          <div className="flex flex-col items-center text-center">
            <div className="relative mb-4">
              <FolderOpen className="h-24 w-24 text-blue-500 group-hover:scale-110 transition-transform" />
              <div className="absolute -top-1 -right-1 bg-blue-500 text-white text-xs font-bold rounded-full w-8 h-8 flex items-center justify-center">
                {projects.length}
              </div>
            </div>
            <h3 className="text-xl font-bold text-gray-900 mb-2">📁 Projets</h3>
            <p className="text-sm text-gray-600">Tous vos projets en cours</p>
          </div>
        </button>

        {/* Dossier Recherches Techniciens */}
        <button
          onClick={() => setOpenFolder('searches')}
          className="bg-white rounded-xl border-2 border-gray-200 hover:border-orange-500 p-8 transition-all hover:shadow-xl group text-left"
        >
          <div className="flex flex-col items-center text-center">
            <div className="relative mb-4">
              <Search className="h-24 w-24 text-orange-500 group-hover:scale-110 transition-transform" />
              <div className="absolute -top-1 -right-1 bg-orange-500 text-white text-xs font-bold rounded-full w-8 h-8 flex items-center justify-center">
                {searches.length}
              </div>
            </div>
            <h3 className="text-xl font-bold text-gray-900 mb-2">🔍 Recherches</h3>
            <p className="text-sm text-gray-600">Recherches partagées</p>
          </div>
        </button>

        {/* Bouton Nouveau Projet */}
        <button
          onClick={(e) => {
            e.stopPropagation();
            setShowCreateModal(true);
          }}
          className="bg-gradient-to-br from-black to-gray-800 rounded-xl border-2 border-gray-800 p-8 transition-all hover:shadow-xl group text-left"
        >
          <div className="flex flex-col items-center text-center">
            <Plus className="h-24 w-24 text-white mb-4 group-hover:scale-110 transition-transform" />
            <h3 className="text-xl font-bold text-white mb-2">Nouveau Projet</h3>
            <p className="text-sm text-gray-300">Créer manuellement</p>
          </div>
        </button>

        {/* Bouton Paramètres Entreprise */}
        <button
          onClick={() => setOpenFolder('settings')}
          className="bg-gradient-to-br from-indigo-600 to-purple-600 rounded-xl border-2 border-indigo-500 p-8 transition-all hover:shadow-xl group text-left"
        >
          <div className="flex flex-col items-center text-center">
            <Settings className="h-24 w-24 text-white mb-4 group-hover:scale-110 group-hover:rotate-90 transition-all" />
            <h3 className="text-xl font-bold text-white mb-2">⚙️ Paramètres</h3>
            <p className="text-sm text-indigo-100">Informations légales</p>
          </div>
        </button>
      </div>

      {/* Modal Création Devis */}
      {showQuoteModal && selectedProjectForQuote && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div className="p-6 border-b border-gray-200 flex items-center justify-between sticky top-0 bg-white">
              <h2 className="text-2xl font-bold text-gray-900 flex items-center gap-2">
                <FileText className="h-6 w-6" />
                Créer un Devis - {selectedProjectForQuote.name}
              </h2>
              <button
                onClick={() => setShowQuoteModal(false)}
                className="text-gray-400 hover:text-gray-600"
              >
                <X className="h-6 w-6" />
              </button>
            </div>

            <div className="p-6 space-y-6">
              {/* Informations du projet */}
              <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <h3 className="font-semibold text-blue-900 mb-2 flex items-center gap-2">
                  <Briefcase className="h-5 w-5" />
                  Projet
                </h3>
                <div className="grid grid-cols-2 gap-3 text-sm">
                  <div>
                    <span className="text-blue-700">N°:</span>
                    <span className="ml-2 font-medium">{selectedProjectForQuote.project_number}</span>
                  </div>
                  <div>
                    <span className="text-blue-700">Client:</span>
                    <span className="ml-2 font-medium">
                      {clients.find(c => c.id === selectedProjectForQuote.client_id)?.nom || '-'}
                    </span>
                  </div>
                  <div className="col-span-2">
                    <span className="text-blue-700">Montant estimé:</span>
                    <span className="ml-2 font-medium">
                      {selectedProjectForQuote.estimated_value ? `${parseFloat(selectedProjectForQuote.estimated_value).toLocaleString('fr-FR')}€` : 'Non défini'}
                    </span>
                  </div>
                </div>
              </div>

              {/* Formulaire devis */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                {/* Titre du devis */}
                <div className="col-span-2">
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Titre du devis <span className="text-red-500">*</span>
                  </label>
                  <input
                    type="text"
                    placeholder="Ex: Devis plomberie cuisine"
                    value={newQuote.title}
                    onChange={(e) => setNewQuote({...newQuote, title: e.target.value})}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  />
                </div>

                {/* Montant HT */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Montant HT <span className="text-red-500">*</span>
                  </label>
                  <div className="relative">
                    <input
                      type="number"
                      placeholder="0.00"
                      value={newQuote.amount_ht}
                      onChange={(e) => setNewQuote({...newQuote, amount_ht: e.target.value})}
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    />
                    <span className="absolute right-3 top-2.5 text-gray-500">€</span>
                  </div>
                </div>

                {/* TVA */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    TVA (%)
                  </label>
                  <select 
                    value={newQuote.tva}
                    onChange={(e) => setNewQuote({...newQuote, tva: e.target.value})}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  >
                    <option value="20">20%</option>
                    <option value="10">10%</option>
                    <option value="5.5">5.5%</option>
                    <option value="0">0%</option>
                  </select>
                </div>

                {/* Date de validité */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Valable jusqu'au
                  </label>
                  <input
                    type="date"
                    value={newQuote.valid_until}
                    onChange={(e) => setNewQuote({...newQuote, valid_until: e.target.value})}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  />
                </div>

                {/* Délai de réalisation */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Délai de réalisation
                  </label>
                  <input
                    type="text"
                    placeholder="Ex: 2 semaines"
                    value={newQuote.deadline}
                    onChange={(e) => setNewQuote({...newQuote, deadline: e.target.value})}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  />
                </div>

                {/* Description */}
                <div className="col-span-2">
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Description des travaux
                  </label>
                  <textarea
                    rows="4"
                    placeholder="Décrivez les travaux à réaliser..."
                    value={newQuote.description}
                    onChange={(e) => setNewQuote({...newQuote, description: e.target.value})}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  />
                </div>

                {/* Conditions */}
                <div className="col-span-2">
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Conditions particulières
                  </label>
                  <textarea
                    rows="3"
                    placeholder="Conditions de paiement, garanties, etc."
                    value={newQuote.conditions}
                    onChange={(e) => setNewQuote({...newQuote, conditions: e.target.value})}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  />
                </div>
              </div>
            </div>

            {/* Boutons d'action */}
            <div className="p-6 border-t border-gray-200 flex gap-3 justify-end sticky bottom-0 bg-white">
              <button
                onClick={() => setShowQuoteModal(false)}
                className="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition"
              >
                Annuler
              </button>
              <button
                onClick={handleCreateQuoteSubmit}
                className="flex items-center gap-2 px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition"
              >
                <Check className="h-5 w-5" />
                Créer le devis
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

// Page d'acceptation d'invitation
const AcceptInvitationPage = () => {
  const navigate = useNavigate();
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [invitation, setInvitation] = useState(null);
  const [formData, setFormData] = useState({
    email: '',
    confirmEmail: '',
    password: '',
    confirmPassword: '',
    firstName: '',
    lastName: ''
  });

  useEffect(() => {
    const params = new URLSearchParams(window.location.search);
    const token = params.get('token');
    
    if (!token) {
      setError('Token d\'invitation manquant');
      setLoading(false);
      return;
    }

    // Vérifier le token et récupérer les infos d'invitation
    axios.get(`${API}/invitations/${token}/validate`)
      .then(response => {
        setInvitation(response.data);
        setFormData(prev => ({ ...prev, email: response.data.email }));
        setLoading(false);
      })
      .catch(err => {
        setError(err.response?.data?.detail || 'Invitation invalide ou expirée');
        setLoading(false);
      });
  }, []);

  const handleSubmit = async (e) => {
    e.preventDefault();
    
    if (formData.email.toLowerCase() !== formData.confirmEmail.toLowerCase()) {
      setError('Les adresses email ne correspondent pas');
      return;
    }

    if (formData.password !== formData.confirmPassword) {
      setError('Les mots de passe ne correspondent pas');
      return;
    }

    if (formData.password.length < 6) {
      setError('Le mot de passe doit contenir au moins 6 caractères');
      return;
    }

    setLoading(true);
    setError(null);

    try {
      const params = new URLSearchParams(window.location.search);
      const token = params.get('token');

      // Créer le compte et accepter l'invitation avec le nouvel endpoint
      const response = await axios.post(`${API}/invitations/${invitation.id}/accept-and-register`, {
        email: formData.email,
        password: formData.password,
        first_name: formData.firstName,
        last_name: formData.lastName
      });

      // Connexion automatique
      if (response.data.token) {
        localStorage.setItem('token', response.data.token);
        localStorage.setItem('user', JSON.stringify(response.data.user));
        window.location.href = '/bureau';
      } else {
        setError('Compte créé mais impossible de se connecter automatiquement');
      }
    } catch (err) {
      setError(err.response?.data?.detail || 'Erreur lors de l\'acceptation de l\'invitation');
      setLoading(false);
    }
  };

  if (loading) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100 flex items-center justify-center">
        <div className="text-center">
          <Loader2 className="h-12 w-12 animate-spin text-blue-600 mx-auto mb-4" />
          <p className="text-gray-600">Vérification de l'invitation...</p>
        </div>
      </div>
    );
  }

  if (error && !invitation) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100 flex items-center justify-center p-6">
        <Card className="max-w-md w-full">
          <CardContent className="p-8 text-center">
            <XCircle className="h-16 w-16 text-red-500 mx-auto mb-4" />
            <h2 className="text-2xl font-bold text-gray-900 mb-2">Invitation invalide</h2>
            <p className="text-gray-600 mb-6">{error}</p>
            <Button onClick={() => window.location.href = '/'} className="w-full">
              Retour à l'accueil
            </Button>
          </CardContent>
        </Card>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100 flex items-center justify-center p-6">
      <Card className="max-w-md w-full">
        <CardHeader className="text-center pb-6">
          <div className="w-16 h-16 bg-gradient-to-br from-blue-600 to-blue-700 rounded-xl flex items-center justify-center mx-auto mb-4">
            <Mail className="h-8 w-8 text-white" />
          </div>
          <CardTitle className="text-2xl font-bold">Accepter l'invitation</CardTitle>
          <CardDescription className="mt-2">
            Vous êtes invité à rejoindre <strong>{invitation?.company_name}</strong> en tant que <strong>{invitation?.role}</strong>
          </CardDescription>
          {invitation?.invited_by && (
            <div className="mt-3 p-3 bg-blue-50 border border-blue-200 rounded-lg">
              <p className="text-sm text-gray-700">
                <span className="font-medium">Invité par :</span> {invitation.invited_by}
              </p>
            </div>
          )}
        </CardHeader>

        <CardContent>
          {error && (
            <div className="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm">
              {error}
            </div>
          )}

          <form onSubmit={handleSubmit} className="space-y-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                Email
              </label>
              <Input
                type="email"
                value={formData.email}
                disabled
                className="bg-gray-50"
              />
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                Confirmer votre email
              </label>
              <Input
                type="email"
                value={formData.confirmEmail}
                onChange={(e) => setFormData({ ...formData, confirmEmail: e.target.value })}
                placeholder="Confirmez votre adresse email"
                required
              />
            </div>

            <div className="grid grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Prénom
                </label>
                <Input
                  type="text"
                  value={formData.firstName}
                  onChange={(e) => setFormData({ ...formData, firstName: e.target.value })}
                  placeholder="Votre prénom"
                  required
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Nom
                </label>
                <Input
                  type="text"
                  value={formData.lastName}
                  onChange={(e) => setFormData({ ...formData, lastName: e.target.value })}
                  placeholder="Votre nom"
                  required
                />
              </div>
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                Mot de passe
              </label>
              <Input
                type="password"
                value={formData.password}
                onChange={(e) => setFormData({ ...formData, password: e.target.value })}
                placeholder="Minimum 6 caractères"
                required
                minLength={6}
              />
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                Confirmer le mot de passe
              </label>
              <Input
                type="password"
                value={formData.confirmPassword}
                onChange={(e) => setFormData({ ...formData, confirmPassword: e.target.value })}
                placeholder="Confirmez votre mot de passe"
                required
                minLength={6}
              />
            </div>

            <Button
              type="submit"
              disabled={loading}
              className="w-full bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800"
            >
              {loading ? (
                <span className="flex items-center justify-center">
                  <Loader2 className="h-4 w-4 animate-spin mr-2" />
                  Création du compte...
                </span>
              ) : (
                <span className="flex items-center justify-center">
                  <CheckCircle className="h-4 w-4 mr-2" />
                  Accepter et créer mon compte
                </span>
              )}
            </Button>
          </form>
        </CardContent>
      </Card>
    </div>
  );
};

// Main App Component
function App() {
  const [user, setUser] = useState(null);
  const [token, setToken] = useState(null);
  const [loading, setLoading] = useState(true);
  const founderEmail = FOUNDER_EMAIL;
  const isFounder = (user?.is_fondateur === true) || ((user?.email || '').toLowerCase() === founderEmail);
  const isAdmin = isFounder || (user?.role === 'ADMIN');

  useEffect(() => {
    const savedToken = localStorage.getItem('token');
    const savedUser = localStorage.getItem('user');
    
    if (savedToken && savedUser) {
      try {
        const userData = JSON.parse(savedUser);
        setToken(savedToken);
        setUser(userData);
        axios.defaults.headers.common['Authorization'] = `Bearer ${savedToken}`;
      } catch (error) {
        localStorage.clear();
      }
    }
    setLoading(false);
  }, []);

  if (loading) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <div className="animate-spin rounded-full h-32 w-32 border-b-2 border-blue-600"></div>
      </div>
    );
  }

  return (
    <AuthContext.Provider value={{ user, token }}>
      <BrowserRouter>
        <div className="App">
          {/* Cosmic Animated Background */}
          <CosmicBackground />
          
          <Routes>
            <Route path="/" element={<LandingPage />} />
            <Route path="/accept-invitation" element={<AcceptInvitationPage />} />
            <Route 
              path="/role-selection" 
              element={user ? <RoleSelection /> : <Navigate to="/" />} 
            />
            <Route 
              path="/technicien" 
              element={user ? <TechnicienLayout /> : <Navigate to="/" />} 
            />
            <Route 
              path="/bureau/*" 
              element={user ? ((isAdmin || user?.role === 'BUREAU') ? <BureauLayout /> : <Navigate to="/role-selection" />) : <Navigate to="/" />} 
            />
            {/* Redirection par défaut vers /bureau/projets */}
            <Route 
              path="/bureau" 
              element={<Navigate to="/bureau/projets" replace />} 
            />
            <Route 
              path="/statistiques" 
              element={user ? (isAdmin ? <StatisticsLayout /> : <Navigate to="/role-selection" />) : <Navigate to="/" />} 
            />
            {/* Route fondateur retirée à la demande */}
            <Route 
              path="/admin" 
              element={user ? (isFounder ? <SupremeAdminLayout /> : <Navigate to="/role-selection" />) : <Navigate to="/" />} 
            />
          </Routes>

          {/* AI Orb - Orbe Blanche et Noire toujours active */}
          {user && <AIOrb />}
        </div>
      </BrowserRouter>
    </AuthContext.Provider>
  );
}

export default App;
